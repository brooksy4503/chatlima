You are a senior developer. You produce optimized, maintainable code that follows best practices. 

Your task is to review the current codebase and make 3 feature suggestions.


Rules:
- Keep your suggestions concise and focused. Avoid unnecessary explanations or fluff. 
- Your output should be a series of specific, actionable changes.

When approaching this task:
1. Carefully review the provided code.
2. Identify the area thats raising this issue or error and provide a fix.
3. Consider best practices for the specific programming language used.

For each suggested change, provide:
1. A short description of the change (one line maximum).
2. The modified code block.

Use the following format for your output:

[Short Description]
```[language]:[path/to/file]
[code block]
```

Begin fixing the codebase provide your solutions.

My current codebase:
<current_codebase>
Project Structure:
├── CLAUDE.md
├── LICENSE
├── README.md
├── __tests__
│   ├── components
│   │   ├── api-key-manager.test.tsx
│   │   ├── chat-list.test.tsx
│   │   ├── chat-sidebar.test.tsx
│   │   ├── chat.test.tsx
│   │   ├── checkout-button.test.tsx
│   │   ├── citation.test.tsx
│   │   ├── copy-button.test.tsx
│   │   ├── error-boundary.test.tsx
│   │   ├── favorite-toggle.test.tsx
│   │   ├── icons.test.tsx
│   │   ├── image-modal.test.tsx
│   │   ├── image-preview.test.tsx
│   │   ├── image-upload.test.tsx
│   │   ├── input.test.tsx
│   │   ├── ios-install-prompt.test.tsx
│   │   ├── markdown.components.test.tsx
│   │   ├── markdown.test.tsx
│   │   ├── mcp-server-manager.test.tsx
│   │   ├── message.test.tsx
│   │   ├── messages.test.tsx
│   │   ├── model-picker.test.tsx
│   │   ├── preset-manager.test.tsx
│   │   ├── preset-selector.test.tsx
│   │   ├── project-overview.test.tsx
│   │   ├── provider-health-dashboard.test.tsx
│   │   ├── suggested-prompts.test.tsx
│   │   ├── textarea.test.tsx
│   │   ├── theme-provider.test.tsx
│   │   ├── theme-toggle.test.tsx
│   │   ├── tool-invocation.test.tsx
│   │   ├── top-nav.test.tsx
│   │   └── web-search-suggestion.test.tsx
│   ├── tsconfig.json
│   └── tsconfig.tsbuildinfo
├── agentsmith
│   ├── globals.json
│   └── prompts
│       └── default
│           ├── 0.0.1
│           │   ├── content.j2
│           │   └── version.json
│           └── prompt.json
├── ai
│   └── providers.ts
├── app
│   ├── actions.ts
│   ├── api
│   │   ├── auth
│   │   │   ├── [...betterauth]
│   │   │   │   └── route.ts
│   │   │   ├── polar
│   │   │   │   ├── route.ts
│   │   │   └── sign-in
│   │   ├── chat
│   │   │   └── route.ts
│   │   ├── chats
│   │   │   ├── [id]
│   │   │   │   ├── route.ts
│   │   │   ├── migrate
│   │   │   │   └── route.ts
│   │   │   ├── route.ts
│   │   │   └── shared
│   │   ├── create-polar-customer
│   │   │   └── route.ts
│   │   ├── credits
│   │   │   └── route.ts
│   │   ├── debug-credits
│   │   │   └── route.ts
│   │   ├── favorites
│   │   │   └── models
│   │   │       └── route.ts
│   │   ├── models
│   │   │   └── route.ts
│   │   ├── portal
│   │   │   └── route.ts
│   │   ├── presets
│   │   │   ├── [id]
│   │   │   │   ├── route.ts
│   │   │   ├── route.ts
│   │   │   ├── shared
│   │   │   └── validate
│   │   │       └── route.ts
│   │   ├── usage
│   │   │   └── messages
│   │   │       └── route.ts
│   │   └── version
│   │       └── route.ts
│   ├── chat
│   │   └── [id]
│   │       └── page.tsx
│   ├── chats
│   │   └── shared
│   │       └── [shareId]
│   │           └── page.tsx
│   ├── checkout
│   │   ├── error
│   │   │   └── page.tsx
│   │   └── success
│   │       └── page.tsx
│   ├── globals.css
│   ├── layout.tsx
│   ├── opengraph-image.png
│   ├── page.tsx
│   ├── presets
│   │   └── shared
│   │       └── [shareId]
│   │           └── page.tsx
│   ├── privacy
│   │   └── page.tsx
│   ├── providers.tsx
│   ├── robots.txt
│   │   └── route.ts
│   ├── sitemap.xml
│   │   └── route.ts
│   ├── terms
│   │   └── page.tsx
│   └── twitter-image.png
├── auth-schema.ts
├── chatlima.code-workspace
├── codefetch
│   ├── codebase.md
│   └── prompts
│       └── default.md
├── codefetch.config.mjs
├── components
│   ├── api-key-manager.tsx
│   ├── auth
│   │   ├── AnonymousAuth.tsx
│   │   ├── SignInButton.tsx
│   │   └── UserAccountMenu.tsx
│   ├── chat-list.tsx
│   ├── chat-share-dialog.tsx
│   ├── chat-sidebar.tsx
│   ├── chat.tsx
│   ├── checkout-button.tsx
│   ├── citation.tsx
│   ├── copy-button.tsx
│   ├── deploy-button.tsx
│   ├── error-boundary.tsx
│   ├── favorite-toggle.tsx
│   ├── icons.tsx
│   ├── image-modal.tsx
│   ├── image-preview.tsx
│   ├── image-upload.tsx
│   ├── input.tsx
│   ├── ios-install-prompt.tsx
│   ├── markdown.tsx
│   ├── mcp-server-manager.tsx
│   ├── message.tsx
│   ├── messages.tsx
│   ├── model-picker.tsx
│   ├── preset-manager.tsx
│   ├── preset-selector.tsx
│   ├── project-overview.tsx
│   ├── provider-health-dashboard.tsx
│   ├── shared-chat-messages.tsx
│   ├── shared-message.tsx
│   ├── suggested-prompts.tsx
│   ├── textarea.tsx
│   ├── theme-provider.tsx
│   ├── theme-toggle.tsx
│   ├── tool-invocation.tsx
│   ├── top-nav.tsx
│   ├── ui
│   │   ├── BuildInfo.tsx
│   │   ├── accordion.tsx
│   │   ├── alert.tsx
│   │   ├── avatar.tsx
│   │   ├── badge.tsx
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── checkbox.tsx
│   │   ├── custom-sidebar-trigger.tsx
│   │   ├── dialog.tsx
│   │   ├── dropdown-menu.tsx
│   │   ├── input.tsx
│   │   ├── label.tsx
│   │   ├── popover.tsx
│   │   ├── scroll-area.tsx
│   │   ├── select.tsx
│   │   ├── separator.tsx
│   │   ├── sheet.tsx
│   │   ├── sidebar.tsx
│   │   ├── skeleton.tsx
│   │   ├── sonner.tsx
│   │   ├── switch.tsx
│   │   ├── tabs.tsx
│   │   ├── text-morph.tsx
│   │   ├── textarea.tsx
│   │   └── tooltip.tsx
│   └── web-search-suggestion.tsx
├── components.json
├── coverage
│   ├── clover.xml
│   ├── coverage-final.json
│   ├── lcov-report
│   │   ├── base.css
│   │   ├── block-navigation.js
│   │   ├── components
│   │   │   ├── api-key-manager.tsx.html
│   │   │   ├── auth
│   │   │   │   ├── AnonymousAuth.tsx.html
│   │   │   │   ├── SignInButton.tsx.html
│   │   │   │   ├── UserAccountMenu.tsx.html
│   │   │   │   └── index.html
│   │   │   ├── chat-list.tsx.html
│   │   │   ├── chat-sidebar.tsx.html
│   │   │   ├── chat.tsx.html
│   │   │   ├── checkout-button.tsx.html
│   │   │   ├── citation.tsx.html
│   │   │   ├── copy-button.tsx.html
│   │   │   ├── deploy-button.tsx.html
│   │   │   ├── error-boundary.tsx.html
│   │   │   ├── favorite-toggle.tsx.html
│   │   │   ├── icons.tsx.html
│   │   │   ├── image-modal.tsx.html
│   │   │   ├── image-preview.tsx.html
│   │   │   ├── image-upload.tsx.html
│   │   │   ├── index.html
│   │   │   ├── input.tsx.html
│   │   │   ├── ios-install-prompt.tsx.html
│   │   │   ├── markdown.tsx.html
│   │   │   ├── mcp-server-manager.tsx.html
│   │   │   ├── message.tsx.html
│   │   │   ├── messages.tsx.html
│   │   │   ├── model-picker.tsx.html
│   │   │   ├── preset-manager.tsx.html
│   │   │   ├── preset-selector.tsx.html
│   │   │   ├── project-overview.tsx.html
│   │   │   ├── provider-health-dashboard.tsx.html
│   │   │   ├── suggested-prompts.tsx.html
│   │   │   ├── textarea.tsx.html
│   │   │   ├── theme-provider.tsx.html
│   │   │   ├── theme-toggle.tsx.html
│   │   │   ├── tool-invocation.tsx.html
│   │   │   ├── top-nav.tsx.html
│   │   │   ├── ui
│   │   │   │   ├── BuildInfo.tsx.html
│   │   │   │   ├── accordion.tsx.html
│   │   │   │   ├── alert.tsx.html
│   │   │   │   ├── avatar.tsx.html
│   │   │   │   ├── badge.tsx.html
│   │   │   │   ├── button.tsx.html
│   │   │   │   ├── card.tsx.html
│   │   │   │   ├── custom-sidebar-trigger.tsx.html
│   │   │   │   ├── dialog.tsx.html
│   │   │   │   ├── dropdown-menu.tsx.html
│   │   │   │   ├── index.html
│   │   │   │   ├── input.tsx.html
│   │   │   │   ├── label.tsx.html
│   │   │   │   ├── popover.tsx.html
│   │   │   │   ├── scroll-area.tsx.html
│   │   │   │   ├── select.tsx.html
│   │   │   │   ├── separator.tsx.html
│   │   │   │   ├── sheet.tsx.html
│   │   │   │   ├── sidebar.tsx.html
│   │   │   │   ├── skeleton.tsx.html
│   │   │   │   ├── sonner.tsx.html
│   │   │   │   ├── switch.tsx.html
│   │   │   │   ├── tabs.tsx.html
│   │   │   │   ├── text-morph.tsx.html
│   │   │   │   ├── textarea.tsx.html
│   │   │   │   └── tooltip.tsx.html
│   │   │   └── web-search-suggestion.tsx.html
│   │   ├── favicon.png
│   │   ├── index.html
│   │   ├── prettify.css
│   │   ├── prettify.js
│   │   ├── sort-arrow-sprite.png
│   │   └── sorter.js
│   └── lcov.info
├── docs
│   ├── FEATURE_PLAN_dynamic-ai-models.md
│   ├── auth-migration-guide.md
│   ├── auth-performance-fixes-implemented.md
│   ├── auth-session-performance-analysis.md
│   ├── chat-sharing-plan.md
│   ├── compilation-speed-optimization.md
│   ├── dynamic-model-loading-plan.md
│   ├── favorite-models-implementation-plan.md
│   └── new-features-ideas.md
├── drizzle
│   ├── 0000_supreme_rocket_raccoon.sql
│   ├── 0001_curious_paper_doll.sql
│   ├── 0002_free_cobalt_man.sql
│   ├── 0003_oval_energizer.sql
│   ├── 0004_tense_ricochet.sql
│   ├── 0005_early_payback.sql
│   ├── 0007_update_verification_table.sql
│   ├── 0008_alter_accounts_expiresat_type.sql
│   ├── 0009_alter_users_emailverified_type.sql
│   ├── 0010_optimal_jane_foster.sql
│   ├── 0011_fixed_cerebro.sql
│   ├── 0012_tearful_misty_knight.sql
│   ├── 0013_special_whirlwind.sql
│   ├── 0014_fair_praxagora.sql
│   ├── 0015_remarkable_owl.sql
│   ├── 0016_cooing_lester.sql
│   ├── 0017_past_bromley.sql
│   ├── 0018_conscious_dragon_man.sql
│   ├── 0018_manual_polar_events.sql
│   ├── 0019_fix_session_token.sql
│   ├── 0020_rainy_rockslide.sql
│   ├── 0021_aberrant_baron_zemo.sql
│   ├── 0022_add_presets_tables.sql
│   ├── 0023_remove_one_default_per_user_constraint.sql
│   ├── 0024_light_terror.sql
│   ├── 0025_flaky_thing.sql
│   ├── 0026_previous_patch.sql
│   ├── meta
│   │   ├── 0001_snapshot.json
│   │   ├── 0002_snapshot.json
│   │   ├── 0003_snapshot.json
│   │   ├── 0004_snapshot.json
│   │   ├── 0005_snapshot.json
│   │   ├── 0007_snapshot.json
│   │   ├── 0008_snapshot.json
│   │   ├── 0009_snapshot.json
│   │   ├── 0010_snapshot.json
│   │   ├── 0011_snapshot.json
│   │   ├── 0012_snapshot.json
│   │   ├── 0013_snapshot.json
│   │   ├── 0014_snapshot.json
│   │   ├── 0015_snapshot.json
│   │   ├── 0016_snapshot.json
│   │   ├── 0017_snapshot.json
│   │   ├── 0018_snapshot.json
│   │   ├── 0020_snapshot.json
│   │   ├── 0021_snapshot.json
│   │   ├── 0022_snapshot.json
│   │   ├── 0024_snapshot.json
│   │   ├── 0025_snapshot.json
│   │   ├── 0026_snapshot.json
│   │   └── _journal.json
│   └── migrations
│       └── 0003_add_web_search.sql
├── drizzle.config.ts
├── eslint.config.mjs
├── hooks
│   ├── use-mobile.ts
│   ├── use-models.ts
│   ├── useAuth.ts
│   ├── useCredits.ts
│   └── useFavorites.ts
├── jest.config.js
├── jest.setup.js
├── lib
│   ├── auth-client.ts
│   ├── auth.ts
│   ├── chat-store.ts
│   ├── constants.ts
│   ├── context
│   │   ├── auth-context.tsx
│   │   ├── mcp-context.tsx
│   │   ├── model-context.tsx
│   │   ├── preset-context.tsx
│   │   └── web-search-context.tsx
│   ├── db
│   │   ├── index.ts
│   │   └── schema.ts
│   ├── hooks
│   │   ├── use-chats.ts
│   │   ├── use-client-mount.ts
│   │   ├── use-copy.ts
│   │   ├── use-local-storage.ts
│   │   └── use-scroll-to-bottom.tsx
│   ├── image-utils.ts
│   ├── models
│   │   ├── blocked-models.json
│   │   ├── client-constants.ts
│   │   ├── fetch-models.ts
│   │   ├── migration-utils.ts
│   │   └── provider-configs.ts
│   ├── openrouter-utils.ts
│   ├── parameter-validation.ts
│   ├── polar.ts
│   ├── preset-templates.ts
│   ├── services
│   │   ├── chat-sharing.ts
│   │   └── favorites.ts
│   ├── suggested-prompts-utils.tsx
│   ├── text-utils.ts
│   ├── tokenCounter.ts
│   ├── types
│   │   └── models.ts
│   ├── types.ts
│   ├── utils
│   │   └── auth-performance-monitor.ts
│   └── utils.ts
├── next-env.d.ts
├── next.config.ts
├── package.json
├── playwright
├── playwright-report
│   └── index.html
├── playwright.basic.config.ts
├── playwright.config.ts
├── playwright.local.config.ts
├── pnpm-lock.yaml
├── postcss.config.mjs
├── public
│   ├── apple-touch-icon-120x120.png
│   ├── apple-touch-icon-152x152.png
│   ├── apple-touch-icon-167x167.png
│   ├── apple-touch-icon-180x180.png
│   ├── apple-touch-icon.png
│   ├── file.svg
│   ├── globe.svg
│   ├── logo.png
│   ├── manifest.json
│   ├── next.svg
│   ├── scira.png
│   ├── vercel.svg
│   └── window.svg
├── railpack.json
├── releases
│   ├── RELEASE_NOTES_v0.10.0.md
│   ├── RELEASE_NOTES_v0.11.0.md
│   ├── RELEASE_NOTES_v0.12.0.md
│   ├── RELEASE_NOTES_v0.12.1.md
│   ├── RELEASE_NOTES_v0.13.0.md
│   ├── RELEASE_NOTES_v0.14.0.md
│   ├── RELEASE_NOTES_v0.16.0.md
│   ├── RELEASE_NOTES_v0.16.1.md
│   ├── RELEASE_NOTES_v0.17.0.md
│   ├── RELEASE_NOTES_v0.17.1.md
│   ├── RELEASE_NOTES_v0.17.2.md
│   ├── RELEASE_NOTES_v0.18.0.md
│   ├── RELEASE_NOTES_v0.19.0.md
│   ├── RELEASE_NOTES_v0.20.0.md
│   ├── RELEASE_NOTES_v0.20.1.md
│   ├── RELEASE_NOTES_v0.20.2.md
│   ├── RELEASE_NOTES_v0.21.0.md
│   ├── RELEASE_NOTES_v0.22.0.md
│   ├── RELEASE_NOTES_v0.22.1.md
│   ├── RELEASE_NOTES_v0.22.2.md
│   ├── RELEASE_NOTES_v0.22.3.md
│   ├── RELEASE_NOTES_v0.23.0.md
│   ├── RELEASE_NOTES_v0.24.0.md
│   ├── RELEASE_NOTES_v0.25.0.md
│   ├── RELEASE_NOTES_v0.26.0.md
│   ├── RELEASE_NOTES_v0.27.0.md
│   ├── RELEASE_NOTES_v0.28.0.md
│   ├── RELEASE_NOTES_v0.29.0.md
│   ├── RELEASE_NOTES_v0.3.0.md
│   ├── RELEASE_NOTES_v0.3.1.md
│   ├── RELEASE_NOTES_v0.4.0.md
│   ├── RELEASE_NOTES_v0.4.1.md
│   ├── RELEASE_NOTES_v0.5.0.md
│   ├── RELEASE_NOTES_v0.5.1.md
│   ├── RELEASE_NOTES_v0.5.2.md
│   ├── RELEASE_NOTES_v0.6.0.md
│   ├── RELEASE_NOTES_v0.8.0.md
│   ├── RELEASE_NOTES_v0.9.0.md
│   └── RELEASE_NOTES_v0.9.1.md
├── reset_db.sql
├── scripts
│   ├── README-endpoint-testing.md
│   ├── README.md
│   ├── analyze-openrouter-data.py
│   ├── clear-cache.sh
│   ├── debug-polar-api.ts
│   ├── dynamic-api-pricing-analysis.ts
│   └── test-model-endpoints.ts
├── test-results
├── tests
│   ├── BASIC-TESTS.md
│   ├── README-TESTING.md
│   ├── auth.local.setup.ts
│   ├── auth.setup.ts
│   ├── basic-ui.spec.ts
│   ├── chatlima-anonymous-test.spec.ts
│   ├── chatlima-deepseek-test.spec.ts
│   └── premium-model-security.spec.ts
└── tsconfig.json


CLAUDE.md
```
1 | # CLAUDE.md
2 | 
3 | This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.
4 | 
5 | ## Development Commands
6 | 
7 | ### Build and Development
8 | ```bash
9 | npm run dev          # Start development server with turbopack
10 | npm run build        # Build production bundle with turbopack
11 | npm run start        # Start production server
12 | npm run lint         # Run ESLint
13 | ```
14 | 
15 | ### Testing
16 | ```bash
17 | npm run test         # Run Playwright tests (local config)
18 | npm run test:ui      # Run tests with UI
19 | npm run test:debug   # Run tests in debug mode
20 | npm run test:headed  # Run tests in headed mode
21 | npm run test:anonymous  # Run anonymous user tests
22 | ```
23 | 
24 | ### Database Operations
25 | ```bash
26 | npm run db:generate  # Generate Drizzle schema
27 | npm run db:migrate   # Run database migrations
28 | npm run db:push      # Push schema to database
29 | npm run db:studio    # Open Drizzle Studio
30 | ```
31 | 
32 | ### Utilities
33 | ```bash
34 | npm run pricing:analysis  # Analyze OpenRouter pricing with tsx
35 | ```
36 | 
37 | ## Architecture Overview
38 | 
39 | ### Core Technologies
40 | - **Framework**: Next.js 15 with App Router and Turbopack
41 | - **Database**: PostgreSQL with Drizzle ORM
42 | - **Authentication**: Better Auth with Google OAuth and anonymous users
43 | - **Payments**: Polar integration for credit system
44 | - **AI**: Multiple providers (OpenRouter, Anthropic, OpenAI, Groq, X AI, Requesty)
45 | - **UI**: Tailwind CSS with shadcn/ui components
46 | - **Testing**: Playwright for E2E testing
47 | 
48 | ### Key Architecture Patterns
49 | 
50 | #### Authentication Flow
51 | - Better Auth handles both Google OAuth and anonymous users
52 | - Anonymous users get 10 messages/day, Google users get 20
53 | - Credit system overrides daily limits for paid users
54 | - User linking from anonymous to authenticated accounts
55 | 
56 | #### AI Integration
57 | - Multiple AI providers with unified interface in `ai/providers.ts`
58 | - Model Context Protocol (MCP) support for external tools
59 | - Dynamic API key management with runtime overrides
60 | - Credit validation prevents negative balance
61 | 
62 | #### Database Schema
63 | - Main schema in `lib/db/schema.ts` with Drizzle ORM
64 | - Better Auth schema integrated with custom user tables
65 | - Chat/message storage with JSON parts for flexibility
66 | - Polar usage events tracking
67 | 
68 | #### Credit System
69 | - Polar integration for billing and subscription management
70 | - Credit-based usage with real-time validation
71 | - Automatic customer creation and management
72 | - Usage tracking for billing accuracy
73 | 
74 | ### Directory Structure
75 | 
76 | #### Core Application
77 | - `app/` - Next.js App Router pages and API routes
78 | - `components/` - React components (shadcn/ui based)
79 | - `lib/` - Shared utilities, database, and authentication
80 | - `hooks/` - Custom React hooks
81 | - `ai/` - AI provider configurations and utilities
82 | 
83 | #### API Routes
84 | - `app/api/auth/` - Authentication endpoints
85 | - `app/api/chat/` - Chat functionality
86 | - `app/api/credits/` - Credit management
87 | - `app/api/polar/` - Polar webhooks and integration
88 | 
89 | #### Database
90 | - `drizzle/` - Database migrations and schema snapshots
91 | - `lib/db/` - Database configuration and schema definitions
92 | 
93 | #### Development
94 | - `tests/` - Playwright E2E tests
95 | - `scripts/` - Development and analysis scripts
96 | - `.cursor/rules/` - Cursor IDE workflow rules
97 | 
98 | ### Key Files
99 | 
100 | #### Authentication
101 | - `lib/auth.ts` - Better Auth configuration with Google OAuth
102 | - `auth-schema.ts` - Auth schema definitions
103 | - `lib/auth-client.ts` - Client-side auth utilities
104 | 
105 | #### Database
106 | - `lib/db/schema.ts` - Main database schema with Drizzle
107 | - `drizzle.config.ts` - Drizzle configuration
108 | 
109 | #### AI & Chat
110 | - `ai/providers.ts` - AI provider configurations
111 | - `lib/chat-store.ts` - Chat state management
112 | - `lib/openrouter-utils.ts` - OpenRouter utilities
113 | 
114 | #### UI Components
115 | - `components/chat.tsx` - Main chat interface
116 | - `components/message.tsx` - Message display
117 | - `components/model-picker.tsx` - AI model selection
118 | - `components/mcp-server-manager.tsx` - MCP server management
119 | 
120 | ### Environment Configuration
121 | 
122 | #### Required Environment Variables
123 | - `AUTH_SECRET` - Better Auth secret
124 | - `POLAR_ACCESS_TOKEN` - Polar API token
125 | - `POLAR_PRODUCT_ID` - Polar product ID
126 | - `SUCCESS_URL` - Checkout success URL
127 | - `POLAR_SERVER_ENV` - "production" or "sandbox"
128 | 
129 | #### OAuth Configuration
130 | - Production: `NEXT_PUBLIC_GOOGLE_CLIENT_ID_PROD`, `GOOGLE_CLIENT_SECRET_PROD`
131 | - Development: `NEXT_PUBLIC_GOOGLE_CLIENT_ID_DEV`, `GOOGLE_CLIENT_SECRET_DEV`
132 | 
133 | ### Development Workflow
134 | 
135 | #### Feature Development
136 | Follow `.cursor/rules/` workflow:
137 | 1. Create feature branch using standardized naming
138 | 2. Use `vercel deploy` for preview testing (never `--prod` on features)
139 | 3. Follow conventional commit messages
140 | 4. Test thoroughly before merging
141 | 
142 | #### Database Changes
143 | 1. Modify schema in `lib/db/schema.ts`
144 | 2. Run `npm run db:generate` to create migration
145 | 3. Run `npm run db:migrate` to apply changes
146 | 4. Test with `npm run db:studio`
147 | 
148 | #### Testing
149 | - Use Playwright for E2E testing
150 | - Test both anonymous and authenticated user flows
151 | - Test credit system and payment flows
152 | - Run `npm run test:anonymous` for anonymous user tests
153 | 
154 | ### Common Development Tasks
155 | 
156 | #### Adding New AI Provider
157 | 1. Add provider config to `ai/providers.ts`
158 | 2. Update model picker in `components/model-picker.tsx`
159 | 3. Test with credit system integration
160 | 
161 | #### Database Schema Updates
162 | 1. Update `lib/db/schema.ts`
163 | 2. Generate migration with `npm run db:generate`
164 | 3. Review migration in `drizzle/` directory
165 | 4. Apply with `npm run db:migrate`
166 | 
167 | #### New API Endpoints
168 | 1. Create in `app/api/` following existing patterns
169 | 2. Add authentication checks for protected routes
170 | 3. Include credit validation for paid features
171 | 4. Test with both anonymous and authenticated users
172 | 
173 | ### Security Considerations
174 | - All API keys stored in environment variables
175 | - Credit validation prevents negative balances
176 | - User data protection with anonymous usage support
177 | - Secure authentication with Better Auth
178 | - CORS configuration for trusted origins
179 | 
180 | ### Performance Optimization
181 | - Turbopack for fast development builds
182 | - Database query optimization with Drizzle
183 | - Token usage tracking for cost optimization
184 | - Real-time pricing analysis tools available
```

auth-schema.ts
```
1 | import { pgTable, text, timestamp, boolean, integer } from "drizzle-orm/pg-core";
2 | 
3 | export const user = pgTable("user", {
4 | 					id: text('id').primaryKey(),
5 | 					name: text('name').notNull(),
6 |  email: text('email').notNull().unique(),
7 |  emailVerified: boolean('email_verified').notNull(),
8 |  image: text('image'),
9 |  createdAt: timestamp('created_at').notNull(),
10 |  updatedAt: timestamp('updated_at').notNull(),
11 |  isAnonymous: boolean('is_anonymous')
12 | 				});
13 | 
14 | export const session = pgTable("session", {
15 | 					id: text('id').primaryKey(),
16 | 					expiresAt: timestamp('expires_at').notNull(),
17 |  token: text('token').notNull().unique(),
18 |  createdAt: timestamp('created_at').notNull(),
19 |  updatedAt: timestamp('updated_at').notNull(),
20 |  ipAddress: text('ip_address'),
21 |  userAgent: text('user_agent'),
22 |  userId: text('user_id').notNull().references(()=> user.id, { onDelete: 'cascade' })
23 | 				});
24 | 
25 | export const account = pgTable("account", {
26 | 					id: text('id').primaryKey(),
27 | 					accountId: text('account_id').notNull(),
28 |  providerId: text('provider_id').notNull(),
29 |  userId: text('user_id').notNull().references(()=> user.id, { onDelete: 'cascade' }),
30 |  accessToken: text('access_token'),
31 |  refreshToken: text('refresh_token'),
32 |  idToken: text('id_token'),
33 |  accessTokenExpiresAt: timestamp('access_token_expires_at'),
34 |  refreshTokenExpiresAt: timestamp('refresh_token_expires_at'),
35 |  scope: text('scope'),
36 |  password: text('password'),
37 |  createdAt: timestamp('created_at').notNull(),
38 |  updatedAt: timestamp('updated_at').notNull()
39 | 				});
40 | 
41 | export const verification = pgTable("verification", {
42 | 					id: text('id').primaryKey(),
43 | 					identifier: text('identifier').notNull(),
44 |  value: text('value').notNull(),
45 |  expiresAt: timestamp('expires_at').notNull(),
46 |  createdAt: timestamp('created_at'),
47 |  updatedAt: timestamp('updated_at')
48 | 				});
```

chatlima.code-workspace
```
1 | {
2 |     "folders": [
3 |         {
4 |             "name": "chatlima",
5 |             "path": "."
6 |         },
7 |         {
8 |             "name": "chatlima-docs",
9 |             "path": "../chatlima-docs"
10 |         }
11 |     ],
12 |     "settings": {
13 |         "typescript.preferences.includePackageJsonAutoImports": "auto",
14 |         "editor.formatOnSave": true,
15 |         "editor.codeActionsOnSave": {
16 |             "source.fixAll.eslint": "explicit"
17 |         }
18 |     },
19 |     "extensions": {
20 |         "recommendations": [
21 |             "bradlc.vscode-tailwindcss",
22 |             "esbenp.prettier-vscode",
23 |             "dbaeumer.vscode-eslint"
24 |         ]
25 |     }
26 | }
```

codefetch.config.mjs
```
1 | /** @type {import('codefetch').CodefetchConfig} */
2 | export default {
3 |   "projectTree": 5,
4 |   "tokenLimiter": "truncated",
5 |   "defaultPromptFile": "default.md"
6 | };
```

components.json
```
1 | {
2 |   "$schema": "https://ui.shadcn.com/schema.json",
3 |   "style": "new-york",
4 |   "rsc": true,
5 |   "tsx": true,
6 |   "tailwind": {
7 |     "config": "",
8 |     "css": "app/globals.css",
9 |     "baseColor": "zinc",
10 |     "cssVariables": true,
11 |     "prefix": ""
12 |   },
13 |   "aliases": {
14 |     "components": "@/components",
15 |     "utils": "@/lib/utils",
16 |     "ui": "@/components/ui",
17 |     "lib": "@/lib",
18 |     "hooks": "@/hooks"
19 |   },
20 |   "iconLibrary": "lucide"
21 | }
```

drizzle.config.ts
```
1 | import type { Config } from "drizzle-kit";
2 | import dotenv from "dotenv";
3 | 
4 | // Load environment variables
5 | dotenv.config({ path: ".env.local" });
6 | 
7 | export default {
8 |   schema: "./lib/db/schema.ts",
9 |   out: "./drizzle",
10 |   dialect: "postgresql",
11 |   dbCredentials: {
12 |     url: process.env.DATABASE_URL!,
13 |   },
14 | } satisfies Config; 
```

eslint.config.mjs
```
1 | import { dirname } from "path";
2 | import { fileURLToPath } from "url";
3 | import { FlatCompat } from "@eslint/eslintrc";
4 | 
5 | const __filename = fileURLToPath(import.meta.url);
6 | const __dirname = dirname(__filename);
7 | 
8 | const compat = new FlatCompat({
9 |   baseDirectory: __dirname,
10 | });
11 | 
12 | const eslintConfig = [
13 |   ...compat.extends("next/core-web-vitals", "next/typescript"),
14 |   {
15 |     rules: {
16 |       "@typescript-eslint/no-unused-vars": "off",
17 |       "@typescript-eslint/no-explicit-any": "off"
18 |     }
19 |   }
20 | ];
21 | 
22 | export default eslintConfig;
```

jest.config.js
```
1 | module.exports = {
2 |   testEnvironment: 'jsdom',
3 |   setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
4 |   moduleNameMapper: {
5 |     '^@/(.*)
</current_codebase>
: '<rootDir>/$1',
6 |     '\\.(css|less|scss|sass)
</current_codebase>
: 'identity-obj-proxy',
7 |     '\\.module\\.(css|less|scss|sass)
</current_codebase>
: 'identity-obj-proxy',
8 |   },
9 |   transform: {
10 |     '^.+\\.(js|jsx|ts|tsx)
</current_codebase>
: ['babel-jest', { 
11 |       presets: [
12 |         ['next/babel', { 
13 |           'preset-react': { 
14 |             runtime: 'automatic' 
15 |           } 
16 |         }]
17 |       ] 
18 |     }],
19 |   },
20 |   moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],
21 |   testPathIgnorePatterns: [
22 |     '<rootDir>/.next/',
23 |     '<rootDir>/node_modules/',
24 |     '<rootDir>/tests/', // Exclude Playwright tests
25 |   ],
26 |   collectCoverageFrom: [
27 |     'components/**/*.{js,jsx,ts,tsx}',
28 |     '!**/*.d.ts',
29 |   ],
30 |   // React 19 compatible configuration
31 |   testEnvironmentOptions: {
32 |     customExportConditions: [''],
33 |   },
34 |   extensionsToTreatAsEsm: ['.jsx', '.tsx'],
35 |   // Enable fake timers globally to fix waitFor issues
36 |   fakeTimers: {
37 |     enableGlobally: true,
38 |   },
39 |   // Remove deprecated globals
40 |   // globals: {
41 |   //   'ts-jest': {
42 |   //     jsx: 'react',
43 |   //   },
44 |   // },
45 | };
```

jest.setup.js
```
1 | import '@testing-library/jest-dom';
2 | 
3 | // React 19 and modern DOM feature support
4 | // Ensure DOM is available in tests
5 | Object.defineProperty(window, 'matchMedia', {
6 |   writable: true,
7 |   value: jest.fn().mockImplementation(query => ({
8 |     matches: false,
9 |     media: query,
10 |     onchange: null,
11 |     addListener: jest.fn(), // deprecated
12 |     removeListener: jest.fn(), // deprecated
13 |     addEventListener: jest.fn(),
14 |     removeEventListener: jest.fn(),
15 |     dispatchEvent: jest.fn(),
16 |   })),
17 | });
18 | 
19 | // Mock ResizeObserver
20 | global.ResizeObserver = jest.fn().mockImplementation(() => ({
21 |   observe: jest.fn(),
22 |   unobserve: jest.fn(),
23 |   disconnect: jest.fn(),
24 | }));
25 | 
26 | // Mock IntersectionObserver
27 | global.IntersectionObserver = jest.fn().mockImplementation(() => ({
28 |   observe: jest.fn(),
29 |   unobserve: jest.fn(),
30 |   disconnect: jest.fn(),
31 | }));
32 | 
33 | // React 19 specific mocks and polyfills
34 | // Mock structuredClone for React 19 compatibility
35 | if (typeof global.structuredClone !== 'function') {
36 |   global.structuredClone = function structuredClone(value) {
37 |     if (value === null || value === undefined) {
38 |       return value;
39 |     }
40 | 
41 |     try {
42 |       // For objects and arrays, use JSON methods
43 |       if (typeof value === 'object') {
44 |         return JSON.parse(JSON.stringify(value));
45 |       }
46 | 
47 |       // For primitive values, return directly
48 |       return value;
49 |     } catch (error) {
50 |       console.warn('structuredClone polyfill failed:', error);
51 | 
52 |       // Returns a shallow copy as fallback
53 |       return Array.isArray(value) ? [...value] : { ...value };
54 |     }
55 |   };
56 | }
57 | 
58 | // Mock modern browser APIs that React 19 might use
59 | global.Request = global.Request || class Request {};
60 | global.Response = global.Response || class Response {};
61 | global.Headers = global.Headers || class Headers {};
62 | 
63 | // Silence specific React 19 warnings in tests
64 | const originalError = console.error;
65 | console.error = (...args) => {
66 |   // Suppress specific React 19 warnings during testing
67 |   if (typeof args[0] === 'string' && 
68 |       (args[0].includes('outdated JSX transform') ||
69 |        args[0].includes('Warning:') && args[0].includes('act'))) {
70 |     return;
71 |   }
72 |   originalError.call(console, ...args);
73 | };
74 | 
75 | // Mock Next.js router
76 | jest.mock('next/router', () => ({
77 |   useRouter() {
78 |     return {
79 |       route: '/',
80 |       pathname: '/',
81 |       query: {},
82 |       asPath: '/',
83 |       push: jest.fn(),
84 |       pop: jest.fn(),
85 |       reload: jest.fn(),
86 |       back: jest.fn(),
87 |       prefetch: jest.fn().mockResolvedValue(undefined),
88 |       beforePopState: jest.fn(),
89 |       events: {
90 |         on: jest.fn(),
91 |         off: jest.fn(),
92 |         emit: jest.fn(),
93 |       },
94 |       isFallback: false,
95 |     };
96 |   },
97 | }));
98 | 
99 | // Mock framer-motion
100 | jest.mock('framer-motion', () => ({
101 |   motion: {
102 |     div: ({ children, ...props }) => <div {...props}>{children}</div>,
103 |     button: ({ children, ...props }) => <button {...props}>{children}</button>,
104 |   },
105 |   AnimatePresence: ({ children }) => <>{children}</>,
106 | }));
107 | 
108 | // Mock motion/react
109 | jest.mock('motion/react', () => ({
110 |   motion: {
111 |     div: ({ children, ...props }) => <div {...props}>{children}</div>,
112 |     button: ({ children, ...props }) => <button {...props}>{children}</button>,
113 |   },
114 |   AnimatePresence: ({ children }) => <>{children}</>,
115 | }));
116 | 
117 | // Mock CSS modules - handled in moduleNameMapper in jest.config.js
118 | 
119 | // Mock next/image
120 | jest.mock('next/image', () => ({
121 |   __esModule: true,
122 |   default: (props) => <img {...props} />,
123 | }));
124 | 
125 | // Mock TextDecoder/TextEncoder and streaming APIs for Node.js environment
126 | const { TextDecoder, TextEncoder } = require('util');
127 | global.TextDecoder = TextDecoder;
128 | global.TextEncoder = TextEncoder;
129 | 
130 | // Mock streaming APIs
131 | global.TransformStream = class TransformStream {
132 |   constructor() {
133 |     this.readable = {};
134 |     this.writable = {};
135 |   }
136 | };
137 | 
138 | global.ReadableStream = class ReadableStream {
139 |   constructor() {}
140 | };
141 | 
142 | global.WritableStream = class WritableStream {
143 |   constructor() {}
144 | };
145 | 
146 | // Mock database dependencies
147 | jest.mock('drizzle-orm/neon-serverless', () => ({
148 |   drizzle: jest.fn(() => ({
149 |     select: jest.fn().mockReturnValue({
150 |       from: jest.fn().mockReturnValue({
151 |         where: jest.fn().mockReturnValue([]),
152 |       }),
153 |     }),
154 |     insert: jest.fn().mockReturnValue({
155 |       values: jest.fn().mockReturnValue({
156 |         returning: jest.fn().mockResolvedValue([]),
157 |       }),
158 |     }),
159 |   })),
160 | }));
161 | 
162 | jest.mock('@neondatabase/serverless', () => ({
163 |   Pool: jest.fn(),
164 | }));
165 | 
166 | // Mock nanoid
167 | jest.mock('nanoid', () => ({
168 |   nanoid: jest.fn(() => 'test-id-123'),
169 | }));
170 | 
171 | // Mock AI SDK providers
172 | jest.mock('@ai-sdk/openai', () => ({
173 |   createOpenAI: jest.fn(() => ({})),
174 | }));
175 | 
176 | jest.mock('@ai-sdk/anthropic', () => ({
177 |   createAnthropic: jest.fn(() => ({})),
178 | }));
179 | 
180 | jest.mock('@ai-sdk/groq', () => ({
181 |   createGroq: jest.fn(() => ({})),
182 | }));
183 | 
184 | jest.mock('@ai-sdk/xai', () => ({
185 |   createXai: jest.fn(() => ({})),
186 | }));
187 | 
188 | jest.mock('@openrouter/ai-sdk-provider', () => ({
189 |   createOpenRouter: jest.fn(() => ({})),
190 | }));
191 | 
192 | jest.mock('@requesty/ai-sdk', () => ({
193 |   createRequesty: jest.fn(() => ({})),
194 | }));
195 | 
196 | 
197 | 
```

next.config.ts
```
1 | import type { NextConfig } from "next";
2 | 
3 | const nextConfig: NextConfig = {
4 |   images: {
5 |     remotePatterns: [
6 |       {
7 |         protocol: 'https',
8 |         hostname: 'lh3.googleusercontent.com',
9 |       },
10 |     ],
11 |   },
12 | 
13 |   // Optimize for development
14 |   reactStrictMode: true,
15 | 
16 |   // Reduce source map size in development
17 |   productionBrowserSourceMaps: false,
18 | 
19 |   // TypeScript and ESLint optimizations
20 |   typescript: {
21 |     // During development, you might want to temporarily set this to true
22 |     // to skip type checking for faster builds
23 |     ignoreBuildErrors: false,
24 |   },
25 |   eslint: {
26 |     // During development builds, you might want to temporarily set this to true
27 |     ignoreDuringBuilds: false,
28 |   },
29 | };
30 | 
31 | export default nextConfig;
```

package.json
```
1 | {
2 |   "name": "chatlima",
3 |   "version": "0.29.0",
4 |   "private": true,
5 |   "scripts": {
6 |     "dev": "next dev --turbopack",
7 |     "build": "next build --turbopack",
8 |     "start": "next start",
9 |     "lint": "next lint",
10 |     "test": "playwright test --config=playwright.local.config.ts",
11 |     "test:unit": "jest",
12 |     "test:unit:watch": "jest --watch",
13 |     "test:unit:coverage": "jest --coverage",
14 |     "test:ui": "playwright test --ui",
15 |     "test:debug": "playwright test --debug",
16 |     "test:headed": "playwright test --headed",
17 |     "test:local": "playwright test --config=playwright.local.config.ts",
18 |     "test:local:ui": "playwright test --config=playwright.local.config.ts --ui",
19 |     "test:local:debug": "playwright test --config=playwright.local.config.ts --debug",
20 |     "test:local:headed": "playwright test --config=playwright.local.config.ts --headed",
21 |     "test:anonymous": "playwright test --project=local-anonymous-chromium --config=playwright.local.config.ts",
22 |     "test:basic": "playwright test --config=playwright.basic.config.ts",
23 |     "test:basic:ui": "playwright test --config=playwright.basic.config.ts --ui",
24 |     "test:basic:debug": "playwright test --config=playwright.basic.config.ts --debug",
25 |     "db:generate": "drizzle-kit generate",
26 |     "db:migrate": "drizzle-kit migrate",
27 |     "db:push": "drizzle-kit push",
28 |     "db:studio": "drizzle-kit studio",
29 |     "pricing:analysis": "npx tsx scripts/dynamic-api-pricing-analysis.ts",
30 |     "test:endpoints": "npx tsx scripts/test-model-endpoints.ts",
31 |     "test:endpoints:openrouter": "npx tsx scripts/test-model-endpoints.ts --provider openrouter",
32 |     "test:endpoints:requesty": "npx tsx scripts/test-model-endpoints.ts --provider requesty",
33 |     "test:endpoints:quick": "npx tsx scripts/test-model-endpoints.ts --max-models 5",
34 |     "test:endpoints:summary": "npx tsx scripts/test-model-endpoints.ts --summary --verbose",
35 |     "test:endpoints:retest": "npx tsx scripts/test-model-endpoints.ts --retest-blocked",
36 |     "cache:clear": "./scripts/clear-cache.sh",
37 |     "dev:fresh": "pnpm cache:clear && pnpm dev"
38 |   },
39 |   "dependencies": {
40 |     "@ai-sdk/anthropic": "^1.2.10",
41 |     "@ai-sdk/cohere": "^1.2.9",
42 |     "@ai-sdk/google": "^1.2.12",
43 |     "@ai-sdk/groq": "^1.2.8",
44 |     "@ai-sdk/openai": "^1.3.16",
45 |     "@ai-sdk/react": "^1.2.9",
46 |     "@ai-sdk/ui-utils": "^1.2.10",
47 |     "@ai-sdk/xai": "^1.2.14",
48 |     "@modelcontextprotocol/sdk": "^1.13.0",
49 |     "@neondatabase/serverless": "^1.0.0",
50 |     "@openrouter/ai-sdk-provider": "^0.4.5",
51 |     "@polar-sh/better-auth": "^0.1.1",
52 |     "@polar-sh/nextjs": "^0.4.0",
53 |     "@polar-sh/sdk": "^0.32.13",
54 |     "@radix-ui/react-accordion": "^1.2.7",
55 |     "@radix-ui/react-avatar": "^1.1.6",
56 |     "@radix-ui/react-dialog": "^1.1.10",
57 |     "@radix-ui/react-dropdown-menu": "^2.1.11",
58 |     "@radix-ui/react-label": "^2.1.3",
59 |     "@radix-ui/react-popover": "^1.1.10",
60 |     "@radix-ui/react-scroll-area": "^1.2.5",
61 |     "@radix-ui/react-select": "^2.1.7",
62 |     "@radix-ui/react-separator": "^1.1.4",
63 |     "@radix-ui/react-slot": "^1.2.0",
64 |     "@radix-ui/react-switch": "^1.2.2",
65 |     "@radix-ui/react-tabs": "^1.1.12",
66 |     "@radix-ui/react-tooltip": "^1.2.3",
67 |     "@requesty/ai-sdk": "^0.0.7",
68 |     "@tanstack/react-query": "^5.74.4",
69 |     "@vercel/otel": "^1.11.0",
70 |     "ai": "^4.3.9",
71 |     "better-auth": "^1.2.7",
72 |     "class-variance-authority": "^0.7.1",
73 |     "clsx": "^2.1.1",
74 |     "drizzle-orm": "^0.42.0",
75 |     "fast-deep-equal": "^3.1.3",
76 |     "framer-motion": "^12.7.4",
77 |     "groq-sdk": "^0.19.0",
78 |     "katex": "^0.16.22",
79 |     "lucide-react": "^0.488.0",
80 |     "motion": "^12.7.3",
81 |     "nanoid": "^5.1.5",
82 |     "next": "^15.3.1",
83 |     "next-themes": "^0.4.6",
84 |     "or": "^0.2.0",
85 |     "pg": "^8.14.1",
86 |     "react": "^19.1.0",
87 |     "react-dom": "^19.1.0",
88 |     "react-markdown": "^10.1.0",
89 |     "rehype-katex": "^7.0.1",
90 |     "remark-gfm": "^4.0.1",
91 |     "remark-math": "^6.0.0",
92 |     "sonner": "^2.0.3",
93 |     "swr": "^2.3.4",
94 |     "tailwind-merge": "^3.2.0",
95 |     "tailwindcss-animate": "^1.0.7",
96 |     "zod": "^3.24.2"
97 |   },
98 |   "devDependencies": {
99 |     "@better-auth/cli": "^1.2.7",
100 |     "@eslint/eslintrc": "^3.3.1",
101 |     "@playwright/test": "^1.48.0",
102 |     "@tailwindcss/postcss": "^4.1.4",
103 |     "@testing-library/dom": "^10.4.1",
104 |     "@testing-library/jest-dom": "^6.6.4",
105 |     "@testing-library/react": "^16.3.0",
106 |     "@testing-library/user-event": "^14.6.1",
107 |     "@types/jest": "^30.0.0",
108 |     "@types/node": "^22.14.1",
109 |     "@types/pg": "^8.11.13",
110 |     "@types/react": "^19.1.2",
111 |     "@types/react-dom": "^19.1.2",
112 |     "dotenv": "^16.5.0",
113 |     "dotenv-cli": "^8.0.0",
114 |     "drizzle-kit": "^0.31.0",
115 |     "esbuild": ">=0.25.0",
116 |     "eslint": "^9.24.0",
117 |     "eslint-config-next": "15.3.0",
118 |     "identity-obj-proxy": "^3.0.0",
119 |     "jest": "^30.0.5",
120 |     "jest-environment-jsdom": "^30.0.5",
121 |     "pg-pool": "^3.8.0",
122 |     "tailwindcss": "^4.1.4",
123 |     "tsx": "^4.19.4",
124 |     "typescript": "^5.8.3"
125 |   }
126 | }
```

playwright.basic.config.ts
```
1 | import { defineConfig, devices } from '@playwright/test';
2 | 
3 | export default defineConfig({
4 |     testDir: './tests',
5 |     fullyParallel: true,
6 |     forbidOnly: !!process.env.CI,
7 |     retries: 1, // Simple retry strategy
8 |     workers: process.env.CI ? 1 : 2, // Reduced parallelism for reliability
9 |     reporter: 'html',
10 | 
11 |     use: {
12 |         baseURL: 'http://localhost:3000', // Local development server
13 |         trace: 'on-first-retry',
14 |         screenshot: 'only-on-failure',
15 |         video: 'retain-on-failure',
16 |         actionTimeout: 10000, // 10 second timeout for actions
17 |     },
18 | 
19 |     // Simple projects - just basic UI tests on local dev server
20 |     projects: [
21 |         {
22 |             name: 'basic-ui-chrome',
23 |             use: {
24 |                 ...devices['Desktop Chrome'],
25 |             },
26 |             testMatch: /.*basic-ui.*\.spec\.ts/,
27 |         },
28 |         {
29 |             name: 'basic-ui-firefox',
30 |             use: {
31 |                 ...devices['Desktop Firefox'],
32 |             },
33 |             testMatch: /.*basic-ui.*\.spec\.ts/,
34 |         },
35 |     ],
36 | 
37 |     // Run dev server before tests
38 |     webServer: {
39 |         command: 'npm run dev',
40 |         port: 3000,
41 |         reuseExistingServer: !process.env.CI,
42 |         timeout: 120000, // 2 minutes to start dev server
43 |     },
44 | }); 
```

playwright.config.ts
```
1 | import { defineConfig, devices } from '@playwright/test';
2 | 
3 | export default defineConfig({
4 |     testDir: './tests',
5 |     fullyParallel: true,
6 |     forbidOnly: !!process.env.CI,
7 |     retries: process.env.CI ? 2 : 0,
8 |     workers: process.env.CI ? 1 : undefined,
9 |     reporter: 'html',
10 | 
11 |     use: {
12 |         baseURL: 'https://preview.chatlima.com',
13 |         trace: 'on-first-retry',
14 |         screenshot: 'only-on-failure',
15 |         video: 'retain-on-failure',
16 |     },
17 | 
18 |     projects: [
19 |         // Setup project to authenticate once (only for authenticated tests)
20 |         {
21 |             name: 'setup',
22 |             testMatch: /.*\.setup\.ts/,
23 |         },
24 | 
25 |         // Anonymous user tests (no auth required)
26 |         {
27 |             name: 'anonymous-chromium',
28 |             use: {
29 |                 ...devices['Desktop Chrome'],
30 |             },
31 |             testMatch: /.*anonymous.*\.spec\.ts/,
32 |         },
33 | 
34 |         // Authenticated user tests (require auth setup)
35 |         {
36 |             name: 'authenticated-chromium',
37 |             use: {
38 |                 ...devices['Desktop Chrome'],
39 |                 // Use the authenticated state
40 |                 storageState: 'playwright/.auth/user.json',
41 |             },
42 |             dependencies: ['setup'],
43 |             testMatch: /.*deepseek.*\.spec\.ts/,
44 |         },
45 |         {
46 |             name: 'authenticated-firefox',
47 |             use: {
48 |                 ...devices['Desktop Firefox'],
49 |                 // Use the authenticated state
50 |                 storageState: 'playwright/.auth/user.json',
51 |             },
52 |             dependencies: ['setup'],
53 |             testMatch: /.*deepseek.*\.spec\.ts/,
54 |         },
55 |         {
56 |             name: 'authenticated-webkit',
57 |             use: {
58 |                 ...devices['Desktop Safari'],
59 |                 // Use the authenticated state
60 |                 storageState: 'playwright/.auth/user.json',
61 |             },
62 |             dependencies: ['setup'],
63 |             testMatch: /.*deepseek.*\.spec\.ts/,
64 |         },
65 |     ],
66 | 
67 |     webServer: {
68 |         command: 'echo "Using external ChatLima server"',
69 |         url: 'https://preview.chatlima.com',
70 |         reuseExistingServer: true,
71 |         timeout: 120 * 1000,
72 |     },
73 | }); 
```

playwright.local.config.ts
```
1 | import { defineConfig, devices } from '@playwright/test';
2 | 
3 | export default defineConfig({
4 |     testDir: './tests',
5 |     fullyParallel: true,
6 |     forbidOnly: !!process.env.CI,
7 |     retries: process.env.CI ? 2 : 0,
8 |     workers: process.env.CI ? 1 : undefined,
9 |     reporter: 'html',
10 | 
11 |     use: {
12 |         baseURL: 'http://localhost:3000',
13 |         trace: 'on-first-retry',
14 |         screenshot: 'only-on-failure',
15 |         video: 'retain-on-failure',
16 |     },
17 | 
18 |     projects: [
19 |         // Setup project to authenticate once (only for authenticated tests)
20 |         {
21 |             name: 'local-setup',
22 |             testMatch: /.*local\.setup\.ts/,
23 |         },
24 | 
25 |         // Anonymous user tests (no auth required)
26 |         {
27 |             name: 'local-anonymous-chromium',
28 |             use: {
29 |                 ...devices['Desktop Chrome'],
30 |             },
31 |             testMatch: /.*anonymous.*\.spec\.ts/,
32 |         },
33 | 
34 |         // Authenticated user tests (require auth setup)
35 |         {
36 |             name: 'local-authenticated-chromium',
37 |             use: {
38 |                 ...devices['Desktop Chrome'],
39 |                 // Use the authenticated state
40 |                 storageState: 'playwright/.auth/local-user.json',
41 |             },
42 |             dependencies: ['local-setup'],
43 |             testMatch: /.*deepseek.*\.spec\.ts/,
44 |         },
45 |     ],
46 | 
47 |     webServer: {
48 |         command: 'pnpm dev',
49 |         url: 'http://localhost:3000',
50 |         reuseExistingServer: !process.env.CI,
51 |         stdout: 'ignore',
52 |         stderr: 'pipe',
53 |         timeout: 120 * 1000,
54 |     },
55 | }); 
```

postcss.config.mjs
```
1 | const config = {
2 |   plugins: ["@tailwindcss/postcss"],
3 | };
4 | 
5 | export default config;
```

railpack.json
```
1 | {
2 |     "$schema": "https://schema.railpack.com",
3 |     "provider": "node",
4 |     "buildAptPackages": [
5 |         "git",
6 |         "curl"
7 |     ],
8 |     "packages": {
9 |         "node": "22",
10 |         "python": "3.12.7"
11 |     },
12 |     "deploy": {
13 |         "aptPackages": [
14 |             "git",
15 |             "curl"
16 |         ]
17 |     }
18 | }
```

reset_db.sql
```
1 | -- Drop all tables in the database
2 | DROP TABLE IF EXISTS polar_usage_events CASCADE;
3 | DROP TABLE IF EXISTS messages CASCADE;
4 | DROP TABLE IF EXISTS chats CASCADE;
5 | DROP TABLE IF EXISTS verification CASCADE;
6 | DROP TABLE IF EXISTS sessions CASCADE;
7 | DROP TABLE IF EXISTS accounts CASCADE;
8 | DROP TABLE IF EXISTS users CASCADE;
9 | DROP TABLE IF EXISTS _drizzle_migrations CASCADE;
10 | 
11 | -- The tables will be recreated using Drizzle migrations 
```

tsconfig.json
```
1 | {
2 |   "compilerOptions": {
3 |     "target": "ES2017",
4 |     "lib": [
5 |       "dom",
6 |       "dom.iterable",
7 |       "esnext"
8 |     ],
9 |     "allowJs": true,
10 |     "skipLibCheck": true,
11 |     "strict": true,
12 |     "noEmit": true,
13 |     "esModuleInterop": true,
14 |     "module": "esnext",
15 |     "moduleResolution": "bundler",
16 |     "resolveJsonModule": true,
17 |     "isolatedModules": true,
18 |     "jsx": "preserve",
19 |     "incremental": true,
20 |     "tsBuildInfoFile": ".next/cache/.tsbuildinfo",
21 |     "plugins": [
22 |       {
23 |         "name": "next"
24 |       }
25 |     ],
26 |     "paths": {
27 |       "@/*": [
28 |         "./*"
29 |       ]
30 |     }
31 |   },
32 |   "include": [
33 |     "next-env.d.ts",
34 |     "**/*.ts",
35 |     "**/*.tsx",
36 |     ".next/types/**/*.ts"
37 |   ],
38 |   "exclude": [
39 |     "node_modules"
40 |   ]
41 | }
```

.cursor/environment.json
```
1 | {
2 |   "snapshot": "snapshot-20250620-e9439ea3-9378-42a1-ab4f-e3b0ef16a2f9",
3 |   "install": "pnpm install",
4 |   "start": "pnpm run dev",
5 |   "terminals": []
6 | }
```

__tests__/tsconfig.json
```
1 | {
2 |   "extends": "../tsconfig.json",
3 |   "compilerOptions": {
4 |     "jsx": "react-jsx",
5 |     "types": ["jest", "@testing-library/jest-dom"]
6 |   },
7 |   "include": ["../**/*.ts", "../**/*.tsx"],
8 |   "files": ["./components/suggested-prompts.test.tsx", "./components/test-utils.d.ts"]
9 | }
```

agentsmith/globals.json
```
1 | {}
```

ai/providers.ts
```
1 | import { createOpenAI } from "@ai-sdk/openai";
2 | import { createGroq } from "@ai-sdk/groq";
3 | import { createAnthropic } from "@ai-sdk/anthropic";
4 | import { createXai } from "@ai-sdk/xai";
5 | import { createOpenRouter } from "@openrouter/ai-sdk-provider";
6 | import { createRequesty } from "@requesty/ai-sdk";
7 | 
8 | import {
9 |   customProvider,
10 |   wrapLanguageModel,
11 |   extractReasoningMiddleware
12 | } from "ai";
13 | 
14 | 
15 | 
16 | const middleware = extractReasoningMiddleware({
17 |   tagName: 'think',
18 | });
19 | 
20 | const deepseekR1Middleware = extractReasoningMiddleware({
21 |   tagName: 'think',
22 | });
23 | 
24 | // Helper to get API keys from environment variables first, then localStorage
25 | export const getApiKey = (key: string): string | undefined => {
26 |   // Check for environment variables first
27 |   if (process.env[key]) {
28 |     return process.env[key] || undefined;
29 |   }
30 | 
31 |   // Fall back to localStorage if available
32 |   if (typeof window !== 'undefined') {
33 |     return window.localStorage.getItem(key) || undefined;
34 |   }
35 | 
36 |   return undefined;
37 | };
38 | 
39 | // Helper to get API keys with runtime override option
40 | export const getApiKeyWithOverride = (key: string, override?: string): string | undefined => {
41 |   // Use override if provided
42 |   if (override) {
43 |     return override;
44 |   }
45 | 
46 |   // Fall back to the standard method
47 |   return getApiKey(key);
48 | };
49 | 
50 | // Create provider instances with API keys from localStorage
51 | const openaiClient = createOpenAI({
52 |   apiKey: getApiKey('OPENAI_API_KEY'),
53 | });
54 | 
55 | const anthropicClient = createAnthropic({
56 |   apiKey: getApiKey('ANTHROPIC_API_KEY'),
57 | });
58 | 
59 | const groqClient = createGroq({
60 |   apiKey: getApiKey('GROQ_API_KEY'),
61 | });
62 | 
63 | const xaiClient = createXai({
64 |   apiKey: getApiKey('XAI_API_KEY'),
65 | });
66 | 
67 | const openrouterClient = createOpenRouter({
68 |   apiKey: getApiKey('OPENROUTER_API_KEY'),
69 |   headers: {
70 |     'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com/',
71 |     'X-Title': process.env.NEXT_PUBLIC_APP_TITLE || 'ChatLima',
72 |   }
73 | });
74 | 
75 | const requestyClient = createRequesty({
76 |   apiKey: getApiKey('REQUESTY_API_KEY'),
77 |   baseURL: 'https://router.requesty.ai/v1', // Correct API endpoint for requests
78 |   headers: {
79 |     'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com/',
80 |     'X-Title': process.env.NEXT_PUBLIC_APP_TITLE || 'ChatLima',
81 |   }
82 | });
83 | 
84 | // Helper functions to create provider clients with dynamic API keys
85 | export const createOpenAIClientWithKey = (apiKey?: string) => {
86 |   const finalApiKey = getApiKeyWithOverride('OPENAI_API_KEY', apiKey);
87 |   if (!finalApiKey) {
88 |     throw new Error('OpenAI API key is missing. Pass it using the \'apiKey\' parameter or the OPENAI_API_KEY environment variable.');
89 |   }
90 |   return createOpenAI({
91 |     apiKey: finalApiKey,
92 |   });
93 | };
94 | 
95 | export const createAnthropicClientWithKey = (apiKey?: string) => {
96 |   const finalApiKey = getApiKeyWithOverride('ANTHROPIC_API_KEY', apiKey);
97 |   if (!finalApiKey) {
98 |     throw new Error('Anthropic API key is missing. Pass it using the \'apiKey\' parameter or the ANTHROPIC_API_KEY environment variable.');
99 |   }
100 |   return createAnthropic({
101 |     apiKey: finalApiKey,
102 |   });
103 | };
104 | 
105 | export const createGroqClientWithKey = (apiKey?: string) => {
106 |   const finalApiKey = getApiKeyWithOverride('GROQ_API_KEY', apiKey);
107 |   if (!finalApiKey) {
108 |     throw new Error('Groq API key is missing. Pass it using the \'apiKey\' parameter or the GROQ_API_KEY environment variable.');
109 |   }
110 |   return createGroq({
111 |     apiKey: finalApiKey,
112 |   });
113 | };
114 | 
115 | export const createXaiClientWithKey = (apiKey?: string) => {
116 |   const finalApiKey = getApiKeyWithOverride('XAI_API_KEY', apiKey);
117 |   if (!finalApiKey) {
118 |     throw new Error('XAI API key is missing. Pass it using the \'apiKey\' parameter or the XAI_API_KEY environment variable.');
119 |   }
120 |   return createXai({
121 |     apiKey: finalApiKey,
122 |   });
123 | };
124 | 
125 | export const createOpenRouterClientWithKey = (apiKey?: string) => {
126 |   const finalApiKey = getApiKeyWithOverride('OPENROUTER_API_KEY', apiKey);
127 |   if (!finalApiKey) {
128 |     throw new Error('OpenRouter API key is missing. Pass it using the \'apiKey\' parameter or the OPENROUTER_API_KEY environment variable.');
129 |   }
130 |   return createOpenRouter({
131 |     apiKey: finalApiKey,
132 |     headers: {
133 |       'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com/',
134 |       'X-Title': process.env.NEXT_PUBLIC_APP_TITLE || 'ChatLima',
135 |     }
136 |   });
137 | };
138 | 
139 | export const createRequestyClientWithKey = (apiKey?: string) => {
140 |   const finalApiKey = getApiKeyWithOverride('REQUESTY_API_KEY', apiKey);
141 |   if (!finalApiKey) {
142 |     throw new Error('Requesty API key is missing. Pass it using the \'apiKey\' parameter or the REQUESTY_API_KEY environment variable.');
143 |   }
144 |   return createRequesty({
145 |     apiKey: finalApiKey,
146 |     baseURL: 'https://router.requesty.ai/v1', // Correct API endpoint for requests
147 |     headers: {
148 |       'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com/',
149 |       'X-Title': process.env.NEXT_PUBLIC_APP_TITLE || 'ChatLima',
150 |     }
151 |   });
152 | };
153 | 
154 | const languageModels = {
155 |   "claude-3-7-sonnet": anthropicClient('claude-3-7-sonnet-20250219'),
156 |   "gpt-4.1-mini": openaiClient("gpt-4.1-mini"),
157 |   "grok-3-mini": xaiClient("grok-3-mini-latest"),
158 |   "qwen-qwq": wrapLanguageModel(
159 |     {
160 |       model: groqClient("qwen-qwq-32b"),
161 |       middleware
162 |     }
163 |   ),
164 |   // Note: Requesty models are now handled dynamically via getLanguageModelWithKeys()
165 |   // Only keeping essential non-Requesty models for fallback purposes
166 | };
167 | 
168 | // Helper to get language model with dynamic API keys
169 | export const getLanguageModelWithKeys = (modelId: string, apiKeys?: Record<string, string>) => {
170 |   // Helper function to create clients on demand
171 |   const getOpenAIClient = () => createOpenAIClientWithKey(apiKeys?.['OPENAI_API_KEY']);
172 |   const getAnthropicClient = () => createAnthropicClientWithKey(apiKeys?.['ANTHROPIC_API_KEY']);
173 |   const getGroqClient = () => createGroqClientWithKey(apiKeys?.['GROQ_API_KEY']);
174 |   const getXaiClient = () => createXaiClientWithKey(apiKeys?.['XAI_API_KEY']);
175 |   const getOpenRouterClient = () => createOpenRouterClientWithKey(apiKeys?.['OPENROUTER_API_KEY']);
176 |   const getRequestyClient = () => createRequestyClientWithKey(apiKeys?.['REQUESTY_API_KEY']);
177 | 
178 |   // Check if the specific model exists and create only the needed client
179 | 
180 |   // Handle dynamic Requesty models first (before static cases)
181 |   if (modelId.startsWith('requesty/')) {
182 |     const requestyModelId = modelId.replace('requesty/', '');
183 |     console.log(`[getLanguageModelWithKeys] Creating dynamic Requesty client for: ${requestyModelId}`);
184 | 
185 |     // Check if this is a reasoning model that needs special middleware
186 |     const isReasoningModel = (
187 |       requestyModelId.includes('deepseek-r1') ||
188 |       requestyModelId.includes('DeepSeek-R1') ||
189 |       requestyModelId.includes('deepseek-reasoner') ||
190 |       requestyModelId.includes('thinking') ||
191 |       requestyModelId.includes('parasail-deepseek-r1')
192 |     );
193 | 
194 |     if (isReasoningModel) {
195 |       return wrapLanguageModel({
196 |         model: getRequestyClient()(requestyModelId, { logprobs: false }),
197 |         middleware: deepseekR1Middleware,
198 |       });
199 |     }
200 | 
201 |     // Regular model without special middleware
202 |     return getRequestyClient()(requestyModelId);
203 |   }
204 | 
205 |   // Handle dynamic OpenRouter models
206 |   if (modelId.startsWith('openrouter/')) {
207 |     const openrouterModelId = modelId.replace('openrouter/', '');
208 |     console.log(`[getLanguageModelWithKeys] Creating dynamic OpenRouter client for: ${openrouterModelId}`);
209 | 
210 |     // Check if this is a reasoning model that needs special middleware
211 |     const isReasoningModel = (
212 |       openrouterModelId.includes('deepseek-r1') ||
213 |       openrouterModelId.includes('deepseek-reasoner') ||
214 |       openrouterModelId.includes('thinking') ||
215 |       openrouterModelId.includes('qwq') ||
216 |       openrouterModelId.includes('grok-3-beta') ||
217 |       openrouterModelId.includes('grok-3-mini-beta')
218 |     );
219 | 
220 |     if (isReasoningModel) {
221 |       // Handle special reasoning parameters for specific models
222 |       if (openrouterModelId === 'x-ai/grok-3-mini-beta' && modelId.includes('reasoning-high')) {
223 |         return wrapLanguageModel({
224 |           model: getOpenRouterClient()('x-ai/grok-3-mini-beta', { reasoning: { effort: "high" }, logprobs: false }),
225 |           middleware: deepseekR1Middleware,
226 |         });
227 |       }
228 | 
229 |       return wrapLanguageModel({
230 |         model: getOpenRouterClient()(openrouterModelId, { logprobs: false }),
231 |         middleware: deepseekR1Middleware,
232 |       });
233 |     }
234 | 
235 |     // Regular model without special middleware
236 |     return getOpenRouterClient()(openrouterModelId);
237 |   }
238 | 
239 |   switch (modelId) {
240 |     // Anthropic models
241 |     case "claude-3-7-sonnet":
242 |       return getAnthropicClient()('claude-3-7-sonnet-20250219');
243 | 
244 |     // OpenAI models
245 |     case "gpt-4.1-mini":
246 |       return getOpenAIClient()("gpt-4.1-mini");
247 | 
248 |     // Groq models
249 |     case "qwen-qwq":
250 |       return wrapLanguageModel({
251 |         model: getGroqClient()("qwen-qwq-32b"),
252 |         middleware
253 |       });
254 | 
255 |     // XAI models
256 |     case "grok-3-mini":
257 |       return getXaiClient()("grok-3-mini-latest");
258 | 
259 |     // Note: OpenRouter and Requesty models are now handled dynamically above this switch statement
260 | 
261 | 
262 | 
263 | 
264 | 
265 |     default:
266 |       // Fallback to static models if not found (shouldn't happen in normal cases)
267 |       console.warn(`Model ${modelId} not found in dynamic models, falling back to static model`);
268 |       return languageModels[modelId as keyof typeof languageModels];
269 |   }
270 | 
271 | };
272 | 
273 | // Update API keys when localStorage changes (for runtime updates)
274 | if (typeof window !== 'undefined') {
275 |   window.addEventListener('storage', (event) => {
276 |     // Reload the page if any API key changed to refresh the providers
277 |     if (event.key?.includes('API_KEY')) {
278 |       window.location.reload();
279 |     }
280 |   });
281 | }
282 | 
283 | export const model = customProvider({
284 |   languageModels,
285 | });
286 | 
287 | // Define a specific model ID for title generation - use a model that exists in static languageModels
288 | export const titleGenerationModelId: modelID = "gpt-4.1-mini";
289 | 
290 | // Get the actual model instance for title generation
291 | export const titleGenerationModel = languageModels[titleGenerationModelId as keyof typeof languageModels];
292 | 
293 | // Function to get the appropriate title generation model based on the provider of the selected model
294 | export const getTitleGenerationModelId = (selectedModelId: modelID): modelID => {
295 |   // Define preferred title generation models for each provider
296 |   const titleGenerationModels: Record<string, modelID> = {
297 |     'openrouter': 'openrouter/openai/gpt-4.1-mini',
298 |     'requesty': 'requesty/openai/gpt-4o-mini',
299 |     'openai': 'gpt-4.1-mini',
300 |     'anthropic': 'claude-3-7-sonnet',
301 |     'groq': 'qwen-qwq',
302 |     'xai': 'grok-3-mini',
303 |   };
304 | 
305 |   // Determine the provider from the selected model ID
306 |   if (selectedModelId.startsWith('openrouter/')) {
307 |     return titleGenerationModels['openrouter'];
308 |   } else if (selectedModelId.startsWith('requesty/')) {
309 |     return titleGenerationModels['requesty'];
310 |   } else if (selectedModelId.startsWith('gpt-') || selectedModelId === 'gpt-4.1-mini') {
311 |     return titleGenerationModels['openai'];
312 |   } else if (selectedModelId.startsWith('claude-') || selectedModelId === 'claude-3-7-sonnet') {
313 |     return titleGenerationModels['anthropic'];
314 |   } else if (selectedModelId.startsWith('qwen-') || selectedModelId === 'qwen-qwq') {
315 |     return titleGenerationModels['groq'];
316 |   } else if (selectedModelId.startsWith('grok-') || selectedModelId === 'grok-3-mini') {
317 |     return titleGenerationModels['xai'];
318 |   }
319 | 
320 |   // Default fallback to OpenRouter if provider can't be determined
321 |   return titleGenerationModels['openrouter'];
322 | };
323 | 
324 | // Get the title generation model instance based on the selected model
325 | export const getTitleGenerationModel = (selectedModelId: modelID, apiKeys?: Record<string, string>) => {
326 |   const titleModelId = getTitleGenerationModelId(selectedModelId);
327 | 
328 |   // If API keys are provided, use the dynamic model with keys
329 |   if (apiKeys) {
330 |     return getLanguageModelWithKeys(titleModelId, apiKeys);
331 |   }
332 | 
333 |   // If no API keys provided, check if the title model exists in static models
334 |   if (titleModelId in languageModels) {
335 |     return languageModels[titleModelId as keyof typeof languageModels];
336 |   }
337 | 
338 |   // Fallback to a static model that definitely exists
339 |   // Priority: gpt-4.1-mini -> claude-3-7-sonnet -> qwen-qwq -> grok-3-mini
340 |   if ('gpt-4.1-mini' in languageModels) {
341 |     return languageModels['gpt-4.1-mini'];
342 |   } else if ('claude-3-7-sonnet' in languageModels) {
343 |     return languageModels['claude-3-7-sonnet'];
344 |   } else if ('qwen-qwq' in languageModels) {
345 |     return languageModels['qwen-qwq'];
346 |   } else if ('grok-3-mini' in languageModels) {
347 |     return languageModels['grok-3-mini'];
348 |   }
349 | 
350 |   // This should never happen, but if it does, throw a clear error
351 |   throw new Error('No available title generation model found in static models');
352 | };
353 | 
354 | export type modelID = keyof typeof languageModels | string;
355 | 
356 | // Legacy fallback models - Real models now come from dynamic API (/api/models)
357 | // Contains only essential non-Requesty models for fallback; Dynamic models handle enabled/disabled state
358 | export const MODELS = Object.keys(languageModels) as modelID[];
359 | 
360 | export const defaultModel: modelID = "openrouter/google/gemini-2.5-flash";
```

app/actions.ts
```
1 | "use server";
2 | 
3 | import { openai } from "@ai-sdk/openai";
4 | import { generateObject } from "ai";
5 | import { z } from "zod";
6 | import { getApiKey, model, titleGenerationModel, getTitleGenerationModel, type modelID } from "@/ai/providers";
7 | import { type MessagePart } from "@/lib/db/schema";
8 | 
9 | // Helper to extract text content from a message regardless of format
10 | function getMessageText(message: any): string {
11 |   // Check if the message has parts (new format)
12 |   if (message.parts && Array.isArray(message.parts)) {
13 |     const textParts = message.parts.filter((p: any) => p.type === 'text' && p.text);
14 |     if (textParts.length > 0) {
15 |       return textParts.map((p: any) => p.text).join('\n');
16 |     }
17 |   }
18 | 
19 |   // Fallback to content (old format)
20 |   if (typeof message.content === 'string') {
21 |     return message.content;
22 |   }
23 | 
24 |   // If content is an array (potentially of parts), try to extract text
25 |   if (Array.isArray(message.content)) {
26 |     const textItems = message.content.filter((item: any) =>
27 |       typeof item === 'string' || (item.type === 'text' && item.text)
28 |     );
29 | 
30 |     if (textItems.length > 0) {
31 |       return textItems.map((item: any) =>
32 |         typeof item === 'string' ? item : item.text
33 |       ).join('\n');
34 |     }
35 |   }
36 | 
37 |   return '';
38 | }
39 | 
40 | export async function generateTitle(messages: any[], selectedModel?: string, apiKeys?: Record<string, string>) {
41 |   // Find the first user message
42 |   const firstUserMessage = messages.find(msg => msg.role === 'user');
43 | 
44 |   // If no user message, fallback to a default title (or handle as error)
45 |   if (!firstUserMessage) {
46 |     console.warn("No user message found for title generation.");
47 |     return 'New Chat';
48 |   }
49 | 
50 |   const userContent = getMessageText(firstUserMessage);
51 | 
52 |   // Prepare messages for the API - just the user content
53 |   const titleGenMessages = [
54 |     {
55 |       role: 'user' as const,
56 |       content: userContent
57 |     }
58 |   ];
59 | 
60 |   console.log('Generating title with simplified messages:', JSON.stringify(titleGenMessages, null, 2)); // Log the messages
61 | 
62 |   // Determine the title generation model to use
63 |   let titleModel;
64 |   if (selectedModel && apiKeys) {
65 |     // Use dynamic model selection with API keys
66 |     titleModel = getTitleGenerationModel(selectedModel as modelID, apiKeys);
67 |   } else if (selectedModel) {
68 |     // Use dynamic model selection without API keys
69 |     titleModel = getTitleGenerationModel(selectedModel as modelID);
70 |   } else {
71 |     // Fallback to static model
72 |     titleModel = titleGenerationModel;
73 |   }
74 | 
75 |   try {
76 |     const { object } = await generateObject({
77 |       model: titleModel,
78 |       schema: z.object({
79 |         title: z.string().min(1).max(100),
80 |       }),
81 |       system: `
82 |       You are a helpful assistant that generates short, concise titles for chat conversations based *only* on the user's first message.
83 |       The title should summarize the main topic or request of the user's message.
84 |       The title should be no more than 30 characters.
85 |       The title should be unique and not generic like "Chat Title".
86 |       Focus on keywords from the user's message.
87 |       `,
88 |       messages: [
89 |         ...titleGenMessages,
90 |         {
91 |           role: "user",
92 |           content: "Generate a concise title based on my first message.",
93 |         },
94 |       ],
95 |     });
96 |     return object.title;
97 |   } catch (error) {
98 |     console.error('Error generating title with generateObject:', error);
99 |     // Fallback to a simple title derived from the first few words if AI fails
100 |     return userContent.split(' ').slice(0, 5).join(' ') + (userContent.split(' ').length > 5 ? '...' : '');
101 |   }
102 | }
```

app/globals.css
```
1 | @import "tailwindcss";
2 | 
3 | @plugin "tailwindcss-animate";
4 | 
5 | @custom-variant dark (&:is(.dark *));
6 | @custom-variant sunset (&:is(.sunset *));
7 | @custom-variant black (&:is(.black *));
8 | @custom-variant cyberpunk (&:is(.cyberpunk *));
9 | 
10 | :root {
11 |   --background: oklch(0.99 0.01 56.32);
12 |   --foreground: oklch(0.34 0.01 2.77);
13 |   --card: oklch(1.00 0 0);
14 |   --card-foreground: oklch(0.34 0.01 2.77);
15 |   --popover: oklch(1.00 0 0);
16 |   --popover-foreground: oklch(0.34 0.01 2.77);
17 |   --primary: oklch(0.74 0.16 34.71);
18 |   --primary-foreground: oklch(1.00 0 0);
19 |   --secondary: oklch(0.96 0.02 28.90);
20 |   --secondary-foreground: oklch(0.56 0.13 32.74);
21 |   --muted: oklch(0.97 0.02 39.40);
22 |   --muted-foreground: oklch(0.49 0.05 26.45);
23 |   --accent: oklch(0.83 0.11 58.00);
24 |   --accent-foreground: oklch(0.34 0.01 2.77);
25 |   --destructive: oklch(0.61 0.21 22.24);
26 |   --destructive-foreground: oklch(1.00 0 0);
27 |   --border: oklch(0.93 0.04 38.69);
28 |   --input: oklch(0.93 0.04 38.69);
29 |   --ring: oklch(0.74 0.16 34.71);
30 |   --chart-1: oklch(0.74 0.16 34.71);
31 |   --chart-2: oklch(0.83 0.11 58.00);
32 |   --chart-3: oklch(0.88 0.08 54.93);
33 |   --chart-4: oklch(0.82 0.11 40.89);
34 |   --chart-5: oklch(0.64 0.13 32.07);
35 |   --sidebar: oklch(0.97 0.02 39.40);
36 |   --sidebar-foreground: oklch(0.34 0.01 2.77);
37 |   --sidebar-primary: oklch(0.74 0.16 34.71);
38 |   --sidebar-primary-foreground: oklch(1.00 0 0);
39 |   --sidebar-accent: oklch(0.83 0.11 58.00);
40 |   --sidebar-accent-foreground: oklch(0.34 0.01 2.77);
41 |   --sidebar-border: oklch(0.93 0.04 38.69);
42 |   --sidebar-ring: oklch(0.74 0.16 34.71);
43 |   --font-sans: Montserrat, sans-serif;
44 |   --font-serif: Merriweather, serif;
45 |   --font-mono: Ubuntu Mono, monospace;
46 |   --radius: 0.625rem;
47 |   --shadow-2xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
48 |   --shadow-xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
49 |   --shadow-sm: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
50 |   --shadow: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
51 |   --shadow-md: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 2px 4px -4px hsl(0 0% 0% / 0.09);
52 |   --shadow-lg: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 4px 6px -4px hsl(0 0% 0% / 0.09);
53 |   --shadow-xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 8px 10px -4px hsl(0 0% 0% / 0.09);
54 |   --shadow-2xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.22);
55 | }
56 | 
57 | .dark {
58 |   --background: oklch(0.26 0.02 352.40);
59 |   --foreground: oklch(0.94 0.01 51.32);
60 |   --card: oklch(0.32 0.02 341.45);
61 |   --card-foreground: oklch(0.94 0.01 51.32);
62 |   --popover: oklch(0.32 0.02 341.45);
63 |   --popover-foreground: oklch(0.94 0.01 51.32);
64 |   --primary: oklch(0.57 0.15 35.26);
65 |   --primary-foreground: oklch(1.00 0 0);
66 |   --secondary: oklch(0.36 0.02 342.27);
67 |   --secondary-foreground: oklch(0.94 0.01 51.32);
68 |   --muted: oklch(0.32 0.02 341.45);
69 |   --muted-foreground: oklch(0.84 0.02 52.63);
70 |   --accent: oklch(0.42 0.05 342.27);
71 |   --accent-foreground: oklch(0.94 0.01 51.32);
72 |   --destructive: oklch(0.51 0.16 20.19);
73 |   --destructive-foreground: oklch(1.00 0 0);
74 |   --border: oklch(0.36 0.02 342.27);
75 |   --input: oklch(0.36 0.02 342.27);
76 |   --ring: oklch(0.74 0.16 34.71);
77 |   --chart-1: oklch(0.74 0.16 34.71);
78 |   --chart-2: oklch(0.83 0.11 58.00);
79 |   --chart-3: oklch(0.88 0.08 54.93);
80 |   --chart-4: oklch(0.82 0.11 40.89);
81 |   --chart-5: oklch(0.64 0.13 32.07);
82 |   --sidebar: oklch(0.26 0.02 352.40);
83 |   --sidebar-foreground: oklch(0.94 0.01 51.32);
84 |   --sidebar-primary: oklch(0.47 0.08 34.31);
85 |   --sidebar-primary-foreground: oklch(1.00 0 0);
86 |   --sidebar-accent: oklch(0.67 0.09 56.00);
87 |   --sidebar-accent-foreground: oklch(0.94 0.01 51.32);
88 |   --sidebar-border: oklch(0.36 0.02 342.27);
89 |   --sidebar-ring: oklch(0.74 0.16 34.71);
90 |   --font-sans: Montserrat, sans-serif;
91 |   --font-serif: Merriweather, serif;
92 |   --font-mono: Ubuntu Mono, monospace;
93 |   --radius: 0.625rem;
94 |   --shadow-2xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
95 |   --shadow-xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
96 |   --shadow-sm: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
97 |   --shadow: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
98 |   --shadow-md: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 2px 4px -4px hsl(0 0% 0% / 0.09);
99 |   --shadow-lg: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 4px 6px -4px hsl(0 0% 0% / 0.09);
100 |   --shadow-xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 8px 10px -4px hsl(0 0% 0% / 0.09);
101 |   --shadow-2xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.22);
102 | }
103 | 
104 | .sunset {
105 |   --background: oklch(0.98 0.03 80.00);
106 |   --foreground: oklch(0.34 0.01 2.77);
107 |   --card: oklch(1.00 0 0);
108 |   --card-foreground: oklch(0.34 0.01 2.77);
109 |   --popover: oklch(1.00 0 0);
110 |   --popover-foreground: oklch(0.34 0.01 2.77);
111 |   --primary: oklch(0.65 0.26 34.00);
112 |   --primary-foreground: oklch(1.00 0 0);
113 |   --secondary: oklch(0.96 0.05 60.00);
114 |   --secondary-foreground: oklch(0.56 0.13 32.74);
115 |   --muted: oklch(0.97 0.02 39.40);
116 |   --muted-foreground: oklch(0.49 0.05 26.45);
117 |   --accent: oklch(0.83 0.22 50.00);
118 |   --accent-foreground: oklch(0.34 0.01 2.77);
119 |   --destructive: oklch(0.61 0.21 22.24);
120 |   --destructive-foreground: oklch(1.00 0 0);
121 |   --border: oklch(0.93 0.06 60.00);
122 |   --input: oklch(0.93 0.06 60.00);
123 |   --ring: oklch(0.65 0.26 34.00);
124 |   --chart-1: oklch(0.65 0.26 34.00);
125 |   --chart-2: oklch(0.83 0.22 50.00);
126 |   --chart-3: oklch(0.88 0.15 54.93);
127 |   --chart-4: oklch(0.82 0.20 40.89);
128 |   --chart-5: oklch(0.64 0.18 32.07);
129 |   --sidebar: oklch(0.97 0.04 70.00);
130 |   --sidebar-foreground: oklch(0.34 0.01 2.77);
131 |   --sidebar-primary: oklch(0.65 0.26 34.00);
132 |   --sidebar-primary-foreground: oklch(1.00 0 0);
133 |   --sidebar-accent: oklch(0.83 0.22 50.00);
134 |   --sidebar-accent-foreground: oklch(0.34 0.01 2.77);
135 |   --sidebar-border: oklch(0.93 0.06 60.00);
136 |   --sidebar-ring: oklch(0.65 0.26 34.00);
137 |   --font-sans: Montserrat, sans-serif;
138 |   --font-serif: Merriweather, serif;
139 |   --font-mono: Ubuntu Mono, monospace;
140 |   --radius: 0.625rem;
141 |   --shadow-2xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
142 |   --shadow-xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
143 |   --shadow-sm: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
144 |   --shadow: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
145 |   --shadow-md: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 2px 4px -4px hsl(0 0% 0% / 0.09);
146 |   --shadow-lg: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 4px 6px -4px hsl(0 0% 0% / 0.09);
147 |   --shadow-xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 8px 10px -4px hsl(0 0% 0% / 0.09);
148 |   --shadow-2xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.22);
149 | }
150 | 
151 | .black {
152 |   --background: oklch(0.15 0.01 350.00);
153 |   --foreground: oklch(0.95 0.01 60.00);
154 |   --card: oklch(0.20 0.01 340.00);
155 |   --card-foreground: oklch(0.95 0.01 60.00);
156 |   --popover: oklch(0.20 0.01 340.00);
157 |   --popover-foreground: oklch(0.95 0.01 60.00);
158 |   --primary: oklch(0.45 0.10 35.00);
159 |   --primary-foreground: oklch(1.00 0 0);
160 |   --secondary: oklch(0.25 0.01 340.00);
161 |   --secondary-foreground: oklch(0.95 0.01 60.00);
162 |   --muted: oklch(0.22 0.01 340.00);
163 |   --muted-foreground: oklch(0.86 0.01 60.00);
164 |   --accent: oklch(0.70 0.09 58.00);
165 |   --accent-foreground: oklch(0.15 0.01 350.00);
166 |   --destructive: oklch(0.45 0.16 20.00);
167 |   --destructive-foreground: oklch(1.00 0 0);
168 |   --border: oklch(0.25 0.01 340.00);
169 |   --input: oklch(0.25 0.01 340.00);
170 |   --ring: oklch(0.45 0.10 35.00);
171 |   --chart-1: oklch(0.45 0.10 35.00);
172 |   --chart-2: oklch(0.70 0.09 58.00);
173 |   --chart-3: oklch(0.80 0.06 54.00);
174 |   --chart-4: oklch(0.75 0.08 40.00);
175 |   --chart-5: oklch(0.55 0.10 32.00);
176 |   --sidebar: oklch(0.15 0.01 350.00);
177 |   --sidebar-foreground: oklch(0.95 0.01 60.00);
178 |   --sidebar-primary: oklch(0.40 0.06 34.00);
179 |   --sidebar-primary-foreground: oklch(1.00 0 0);
180 |   --sidebar-accent: oklch(0.60 0.07 56.00);
181 |   --sidebar-accent-foreground: oklch(0.15 0.01 350.00);
182 |   --sidebar-border: oklch(0.25 0.01 340.00);
183 |   --sidebar-ring: oklch(0.45 0.10 35.00);
184 |   --font-sans: Montserrat, sans-serif;
185 |   --font-serif: Merriweather, serif;
186 |   --font-mono: Ubuntu Mono, monospace;
187 |   --radius: 0.625rem;
188 |   --shadow-2xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
189 |   --shadow-xs: 0px 6px 12px -3px hsl(0 0% 0% / 0.04);
190 |   --shadow-sm: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
191 |   --shadow: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 1px 2px -4px hsl(0 0% 0% / 0.09);
192 |   --shadow-md: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 2px 4px -4px hsl(0 0% 0% / 0.09);
193 |   --shadow-lg: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 4px 6px -4px hsl(0 0% 0% / 0.09);
194 |   --shadow-xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.09), 0px 8px 10px -4px hsl(0 0% 0% / 0.09);
195 |   --shadow-2xl: 0px 6px 12px -3px hsl(0 0% 0% / 0.22);
196 | }
197 | 
198 | /* Cyberpunk Theme */
199 | .cyberpunk {
200 |   --background: oklch(0.18 0.05 280);
201 |   /* Dark Purple */
202 |   --foreground: oklch(0.95 0.15 180);
203 |   /* Brighter Cyan */
204 |   --card: oklch(0.22 0.06 275);
205 |   /* Darker Purple */
206 |   --card-foreground: oklch(0.95 0.15 180);
207 |   /* Brighter Cyan */
208 |   --popover: oklch(0.22 0.06 275);
209 |   /* Darker Purple */
210 |   --popover-foreground: oklch(0.95 0.15 180);
211 |   /* Brighter Cyan */
212 |   --primary: oklch(0.70 0.25 300);
213 |   /* Electric Pink */
214 |   --primary-foreground: oklch(0.10 0.02 280);
215 |   /* Very Dark Purple */
216 |   --secondary: oklch(0.30 0.08 270);
217 |   /* Medium Purple */
218 |   --secondary-foreground: oklch(0.95 0.15 180);
219 |   /* Brighter Cyan */
220 |   --muted: oklch(0.25 0.07 272);
221 |   /* Muted Purple */
222 |   --muted-foreground: oklch(0.80 0.10 180);
223 |   /* Brighter Lighter Cyan */
224 |   --accent: oklch(0.85 0.20 140);
225 |   /* Neon Green */
226 |   --accent-foreground: oklch(0.10 0.02 280);
227 |   /* Very Dark Purple */
228 |   --destructive: oklch(0.60 0.25 15);
229 |   /* Bright Red */
230 |   --destructive-foreground: oklch(0.10 0.02 280);
231 |   /* Very Dark Purple */
232 |   --border: oklch(0.40 0.10 290);
233 |   /* Neon Border */
234 |   --input: oklch(0.30 0.08 270);
235 |   /* Medium Purple */
236 |   --ring: oklch(0.70 0.25 300);
237 |   /* Electric Pink */
238 |   --chart-1: oklch(0.70 0.25 300);
239 |   /* Electric Pink */
240 |   --chart-2: oklch(0.85 0.20 140);
241 |   /* Neon Green */
242 |   --chart-3: oklch(0.75 0.22 240);
243 |   /* Electric Blue */
244 |   --chart-4: oklch(0.80 0.18 90);
245 |   /* Neon Yellow */
246 |   --chart-5: oklch(0.65 0.20 0);
247 |   /* Bright Orange */
248 |   --sidebar: oklch(0.15 0.04 285);
249 |   /* Very Dark Purple */
250 |   --sidebar-foreground: oklch(0.95 0.15 180);
251 |   /* Brighter Cyan */
252 |   --sidebar-primary: oklch(0.70 0.25 300);
253 |   /* Electric Pink */
254 |   --sidebar-primary-foreground: oklch(0.10 0.02 280);
255 |   /* Very Dark Purple */
256 |   --sidebar-accent: oklch(0.85 0.20 140);
257 |   /* Neon Green */
258 |   --sidebar-accent-foreground: oklch(0.10 0.02 280);
259 |   /* Very Dark Purple */
260 |   --sidebar-border: oklch(0.40 0.10 290);
261 |   /* Neon Border */
262 |   --sidebar-ring: oklch(0.70 0.25 300);
263 |   /* Electric Pink */
264 |   --font-sans: 'Orbitron', sans-serif;
265 |   /* Futuristic font */
266 |   --font-serif: 'Share Tech Mono', monospace;
267 |   /* Monospaced for code feel */
268 |   --font-mono: 'Share Tech Mono', monospace;
269 |   --radius: 0.25rem;
270 |   /* Sharper edges */
271 |   --shadow-2xs: 0px 2px 4px -1px oklch(0.70 0.25 300 / 0.2);
272 |   --shadow-xs: 0px 3px 6px -1px oklch(0.70 0.25 300 / 0.25);
273 |   --shadow-sm: 0px 4px 8px -2px oklch(0.70 0.25 300 / 0.3), 0px 2px 4px -2px oklch(0.70 0.25 300 / 0.2);
274 |   --shadow: 0px 6px 12px -3px oklch(0.70 0.25 300 / 0.35), 0px 4px 6px -4px oklch(0.70 0.25 300 / 0.25);
275 |   --shadow-md: 0px 8px 16px -4px oklch(0.70 0.25 300 / 0.4), 0px 4px 8px -4px oklch(0.70 0.25 300 / 0.3);
276 |   --shadow-lg: 0px 12px 24px -6px oklch(0.70 0.25 300 / 0.45), 0px 6px 12px -6px oklch(0.70 0.25 300 / 0.35);
277 |   --shadow-xl: 0px 16px 32px -8px oklch(0.70 0.25 300 / 0.5), 0px 8px 16px -8px oklch(0.70 0.25 300 / 0.4);
278 |   --shadow-2xl: 0px 24px 48px -12px oklch(0.70 0.25 300 / 0.6);
279 | }
280 | 
281 | /* Retro Theme */
282 | .retro {
283 |   --background: oklch(0.95 0.02 90);
284 |   /* Cream */
285 |   --foreground: oklch(0.35 0.08 40);
286 |   /* Dark Brown */
287 |   --card: oklch(0.98 0.01 85);
288 |   /* Lighter Cream */
289 |   --card-foreground: oklch(0.35 0.08 40);
290 |   /* Dark Brown */
291 |   --popover: oklch(0.98 0.01 85);
292 |   /* Lighter Cream */
293 |   --popover-foreground: oklch(0.35 0.08 40);
294 |   /* Dark Brown */
295 |   --primary: oklch(0.60 0.15 140);
296 |   /* Avocado Green */
297 |   --primary-foreground: oklch(0.95 0.02 90);
298 |   /* Cream */
299 |   --secondary: oklch(0.85 0.10 80);
300 |   /* Mustard Yellow */
301 |   --secondary-foreground: oklch(0.35 0.08 40);
302 |   /* Dark Brown */
303 |   --muted: oklch(0.92 0.03 88);
304 |   /* Muted Cream */
305 |   --muted-foreground: oklch(0.50 0.06 50);
306 |   /* Medium Brown */
307 |   --accent: oklch(0.65 0.18 30);
308 |   /* Burnt Orange */
309 |   --accent-foreground: oklch(0.95 0.02 90);
310 |   /* Cream */
311 |   --destructive: oklch(0.55 0.20 25);
312 |   /* Muted Red */
313 |   --destructive-foreground: oklch(0.95 0.02 90);
314 |   /* Cream */
315 |   --border: oklch(0.88 0.04 70);
316 |   /* Light Brown Border */
317 |   --input: oklch(0.88 0.04 70);
318 |   /* Light Brown Border */
319 |   --ring: oklch(0.60 0.15 140);
320 |   /* Avocado Green */
321 |   --chart-1: oklch(0.60 0.15 140);
322 |   /* Avocado Green */
323 |   --chart-2: oklch(0.65 0.18 30);
324 |   /* Burnt Orange */
[TRUNCATED]
```

app/layout.tsx
```
1 | import type { Metadata } from "next";
2 | import { Inter } from "next/font/google";
3 | import { TopNav } from "@/components/top-nav";
4 | import { Providers } from "./providers";
5 | import "./globals.css";
6 | import Script from "next/script";
7 | import { WebSearchProvider } from "@/lib/context/web-search-context";
8 | import { cn } from "@/lib/utils";
9 | import BuildInfo from "@/components/ui/BuildInfo";
10 | import { IOSInstallPrompt } from "@/components/ios-install-prompt";
11 | import { SidebarInset } from "@/components/ui/sidebar";
12 | import { Suspense, lazy } from "react";
13 | 
14 | // Lazy load the ChatSidebar to improve initial page load performance
15 | const ChatSidebar = lazy(() => import("@/components/chat-sidebar").then(module => ({ default: module.ChatSidebar })));
16 | 
17 | // Import auth performance monitor in development
18 | if (process.env.NODE_ENV === 'development') {
19 |   import('@/lib/utils/auth-performance-monitor');
20 | }
21 | 
22 | const inter = Inter({ subsets: ["latin"] });
23 | 
24 | export const metadata: Metadata = {
25 |   metadataBase: new URL("https://www.chatlima.com/"),
26 |   title: "ChatLima",
27 |   description: "Feature-rich MCP-powered AI chatbot with multi-model support and advanced tools.",
28 |   icons: {
29 |     icon: "/logo.png",
30 |     apple: [
31 |       { url: "/apple-touch-icon.png", sizes: "180x180", type: "image/png" },
32 |       { url: "/apple-touch-icon-120x120.png", sizes: "120x120", type: "image/png" },
33 |       { url: "/apple-touch-icon-152x152.png", sizes: "152x152", type: "image/png" },
34 |       { url: "/apple-touch-icon-167x167.png", sizes: "167x167", type: "image/png" },
35 |       { url: "/apple-touch-icon-180x180.png", sizes: "180x180", type: "image/png" },
36 |     ],
37 |   },
38 |   manifest: "/manifest.json",
39 |   appleWebApp: {
40 |     capable: true,
41 |     statusBarStyle: "default",
42 |     title: "ChatLima",
43 |   },
44 |   formatDetection: {
45 |     telephone: false,
46 |   },
47 |   openGraph: {
48 |     siteName: "ChatLima",
49 |     url: "https://www.chatlima.com/",
50 |     images: [
51 |       {
52 |         url: "https://www.chatlima.com/opengraph-image.png",
53 |         width: 1200,
54 |         height: 630,
55 |       },
56 |     ],
57 |     description: "Feature-rich MCP-powered AI chatbot with multi-model support and advanced tools.",
58 |   },
59 |   twitter: {
60 |     card: "summary_large_image",
61 |     title: "ChatLima",
62 |     description: "Feature-rich MCP-powered AI chatbot with multi-model support and advanced tools.",
63 |     images: ["https://www.chatlima.com/twitter-image.png"],
64 |   },
65 |   other: {
66 |     "mobile-web-app-capable": "yes",
67 |     "apple-mobile-web-app-capable": "yes",
68 |     "apple-mobile-web-app-status-bar-style": "default",
69 |     "apple-mobile-web-app-title": "ChatLima",
70 |   },
71 | };
72 | 
73 | export default function RootLayout({
74 |   children,
75 | }: Readonly<{
76 |   children: React.ReactNode;
77 | }>) {
78 |   return (
79 |     <html lang="en" suppressHydrationWarning>
80 |       <head>
81 |         <meta 
82 |           name="viewport" 
83 |           content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" 
84 |         />
85 |       </head>
86 |       <body className={`${inter.className}`}>
87 |         <Providers>
88 |           <WebSearchProvider>
89 |             <div className="flex h-dvh w-full">
90 |               {/* Sidebar - lazy loaded to improve initial page performance */}
91 |               <Suspense fallback={
92 |                 <div className="w-[280px] bg-background/80 dark:bg-background/40 backdrop-blur-md border-r border-border/40 animate-pulse">
93 |                   <div className="h-16 border-b border-border/40 flex items-center px-4">
94 |                     <div className="h-8 w-8 bg-muted rounded-full"></div>
95 |                     <div className="ml-2 h-4 w-20 bg-muted rounded"></div>
96 |                   </div>
97 |                   <div className="p-4 space-y-2">
98 |                     {[...Array(5)].map((_, i) => (
99 |                       <div key={i} className="h-8 bg-muted rounded"></div>
100 |                     ))}
101 |                   </div>
102 |                 </div>
103 |               }>
104 |                 <ChatSidebar />
105 |               </Suspense>
106 |               {/* Main content area - SidebarInset handles responsive peer classes */}
107 |               <SidebarInset className="flex flex-col min-w-0">
108 |                 <TopNav />
109 |                 <div className="flex-1 flex justify-center overflow-hidden">
110 |                   {children}
111 |                 </div>
112 |               </SidebarInset>
113 |             </div>
114 |             <IOSInstallPrompt />
115 |           </WebSearchProvider>
116 |         </Providers>
117 |         <Script defer src="https://cloud.umami.is/script.js" data-website-id="bd3f8736-1562-47e0-917c-c10fde7ef0d2" />
118 |       </body>
119 |     </html>
120 |   );
121 | }
```

app/page.tsx
```
1 | "use client";
2 | 
3 | import Chat from "@/components/chat";
4 | import { ErrorBoundary } from "@/components/error-boundary";
5 | 
6 | export default function Page() {
7 |   return (
8 |     <ErrorBoundary
9 |       onError={(error, errorInfo) => {
10 |         console.error('Home page error:', error, errorInfo);
11 |       }}
12 |     >
13 |       <Chat />
14 |     </ErrorBoundary>
15 |   );
16 | }
```

app/providers.tsx
```
1 | "use client";
2 | 
3 | import { ReactNode, useEffect, useState } from "react";
4 | import { ThemeProvider } from "@/components/theme-provider";
5 | import { SidebarProvider } from "@/components/ui/sidebar";
6 | import { Toaster } from "sonner";
7 | import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
8 | import { useLocalStorage } from "@/lib/hooks/use-local-storage";
9 | import { STORAGE_KEYS } from "@/lib/constants";
10 | import { MCPProvider } from "@/lib/context/mcp-context";
11 | import { ModelProvider } from "@/lib/context/model-context";
12 | import { PresetProvider } from "@/lib/context/preset-context";
13 | import { AuthProvider } from "@/lib/context/auth-context";
14 | import { AnonymousAuth } from "@/components/auth/AnonymousAuth";
15 | 
16 | // Create a client
17 | const queryClient = new QueryClient({
18 |   defaultOptions: {
19 |     queries: {
20 |       staleTime: 1000 * 60 * 5, // 5 minutes
21 |       refetchOnWindowFocus: false, // Disabled to prevent excessive auth calls
22 |       refetchOnMount: false, // Don't refetch on mount if data is available
23 |       refetchOnReconnect: false, // Don't refetch on reconnect
24 |     },
25 |   },
26 | });
27 | 
28 | export function Providers({ children }: { children: ReactNode }) {
29 |   const [sidebarOpen, setSidebarOpen] = useLocalStorage<boolean>(
30 |     STORAGE_KEYS.SIDEBAR_STATE,
31 |     true
32 |   );
33 | 
34 |   return (
35 |     <QueryClientProvider client={queryClient}>
36 |       <AuthProvider>
37 |         <ThemeProvider
38 |           attribute="class"
39 |           defaultTheme="system"
40 |           enableSystem={true}
41 |           disableTransitionOnChange
42 |           themes={["light", "dark", "black", "sunset", "cyberpunk", "retro", "nature"]}
43 |           storageKey="mcp-theme"
44 |         >
45 |           <MCPProvider>
46 |             <ModelProvider>
47 |               <PresetProvider>
48 |                 <SidebarProvider defaultOpen={sidebarOpen} open={sidebarOpen} onOpenChange={setSidebarOpen}>
49 |                   <AnonymousAuth />
50 |                   {children}
51 |                   <Toaster position="top-center" richColors />
52 |                 </SidebarProvider>
53 |               </PresetProvider>
54 |             </ModelProvider>
55 |           </MCPProvider>
56 |         </ThemeProvider>
57 |       </AuthProvider>
58 |     </QueryClientProvider>
59 |   );
60 | } 
```

components/api-key-manager.tsx
```
1 | import { useState, useEffect } from "react";
2 | import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
3 | import { Button } from "@/components/ui/button";
4 | import { Input } from "@/components/ui/input";
5 | import { Label } from "@/components/ui/label";
6 | import { toast } from "sonner";
7 | import { Key, Eye, EyeOff } from "lucide-react";
8 | 
9 | // API key configuration
10 | interface ApiKeyConfig {
11 |   name: string;
12 |   key: string;
13 |   storageKey: string;
14 |   label: string;
15 |   placeholder: string;
16 | }
17 | 
18 | // Available API keys configuration
19 | const API_KEYS_CONFIG: ApiKeyConfig[] = [
20 |   {
21 |     name: "OpenAI",
22 |     key: "openai",
23 |     storageKey: "OPENAI_API_KEY",
24 |     label: "OpenAI API Key",
25 |     placeholder: "sk-..."
26 |   },
27 |   {
28 |     name: "Anthropic",
29 |     key: "anthropic",
30 |     storageKey: "ANTHROPIC_API_KEY",
31 |     label: "Anthropic API Key",
32 |     placeholder: "sk-ant-..."
33 |   },
34 |   {
35 |     name: "Groq",
36 |     key: "groq",
37 |     storageKey: "GROQ_API_KEY",
38 |     label: "Groq API Key",
39 |     placeholder: "gsk_..."
40 |   },
41 |   {
42 |     name: "XAI",
43 |     key: "xai",
44 |     storageKey: "XAI_API_KEY",
45 |     label: "XAI API Key",
46 |     placeholder: "xai-..."
47 |   },
48 |   {
49 |     name: "Openrouter",
50 |     key: "openrouter",
51 |     storageKey: "OPENROUTER_API_KEY",
52 |     label: "Openrouter API Key",
53 |     placeholder: "sk-or-..."
54 |   },
55 |   {
56 |     name: "Requesty",
57 |     key: "requesty", 
58 |     storageKey: "REQUESTY_API_KEY",
59 |     label: "Requesty API Key",
60 |     placeholder: "req-..."
61 |   }
62 | ];
63 | 
64 | interface ApiKeyManagerProps {
65 |   open: boolean;
66 |   onOpenChange: (open: boolean) => void;
67 | }
68 | 
69 | export function ApiKeyManager({ open, onOpenChange }: ApiKeyManagerProps) {
70 |   // State to store API keys
71 |   const [apiKeys, setApiKeys] = useState<Record<string, string>>({});
72 |   const [showKeys, setShowKeys] = useState<Record<string, boolean>>({});
73 | 
74 |   // Load API keys from localStorage on initial mount
75 |   useEffect(() => {
76 |     const storedKeys: Record<string, string> = {};
77 |     
78 |     API_KEYS_CONFIG.forEach(config => {
79 |       const value = localStorage.getItem(config.storageKey);
80 |       if (value) {
81 |         storedKeys[config.key] = value;
82 |       }
83 |     });
84 |     
85 |     setApiKeys(storedKeys);
86 |   }, []);
87 | 
88 |   // Update API key in state
89 |   const handleApiKeyChange = (key: string, value: string) => {
90 |     setApiKeys(prev => ({
91 |       ...prev,
92 |       [key]: value
93 |     }));
94 |   };
95 | 
96 |   // Toggle visibility of API key
97 |   const toggleKeyVisibility = (key: string) => {
98 |     setShowKeys(prev => ({
99 |       ...prev,
100 |       [key]: !prev[key]
101 |     }));
102 |   };
103 | 
104 |   // Save API keys to localStorage
105 |   const handleSaveApiKeys = () => {
106 |     try {
107 |       API_KEYS_CONFIG.forEach(config => {
108 |         const value = apiKeys[config.key];
109 |         
110 |         if (value && value.trim()) {
111 |           localStorage.setItem(config.storageKey, value.trim());
112 |         } else {
113 |           localStorage.removeItem(config.storageKey);
114 |         }
115 |       });
116 |       
117 |       toast.success("API keys saved successfully");
118 |       onOpenChange(false);
119 |     } catch (error) {
120 |       console.error("Error saving API keys:", error);
121 |       toast.error("Failed to save API keys");
122 |     }
123 |   };
124 | 
125 |   // Clear all API keys
126 |   const handleClearApiKeys = () => {
127 |     try {
128 |       API_KEYS_CONFIG.forEach(config => {
129 |         localStorage.removeItem(config.storageKey);
130 |       });
131 |       
132 |       setApiKeys({});
133 |       toast.success("All API keys cleared");
134 |     } catch (error) {
135 |       console.error("Error clearing API keys:", error);
136 |       toast.error("Failed to clear API keys");
137 |     }
138 |   };
139 | 
140 |   return (
141 |     <Dialog open={open} onOpenChange={onOpenChange}>
142 |       <DialogContent className="max-w-[95vw] sm:max-w-md lg:max-w-[500px] p-4 sm:p-6">
143 |         <DialogHeader className="space-y-2 sm:space-y-3">
144 |           <div className="flex items-center gap-2 sm:gap-3">
145 |             <div className="flex h-8 w-8 sm:h-10 sm:w-10 items-center justify-center rounded-lg bg-primary/10">
146 |               <Key className="h-4 w-4 sm:h-5 sm:w-5 text-primary" />
147 |             </div>
148 |             <div className="flex-1 min-w-0">
149 |               <DialogTitle className="text-base sm:text-lg font-semibold">
150 |                 API Key Settings
151 |               </DialogTitle>
152 |             </div>
153 |           </div>
154 |           <DialogDescription className="text-xs sm:text-sm text-muted-foreground">
155 |             Enter your own API keys for different AI providers. Keys are stored securely in your browser&apos;s local storage.
156 |           </DialogDescription>
157 |         </DialogHeader>
158 |         
159 |         <div className="max-h-[40vh] sm:max-h-[50vh] overflow-y-auto space-y-3 sm:space-y-4 py-2 sm:py-4 pr-2">
160 |           {API_KEYS_CONFIG.map(config => (
161 |             <div key={config.key} className="space-y-1.5 sm:space-y-2">
162 |               <Label 
163 |                 htmlFor={config.key}
164 |                 className="text-xs sm:text-sm font-medium"
165 |               >
166 |                 {config.label}
167 |               </Label>
168 |               <div className="relative">
169 |                 <Input
170 |                   id={config.key}
171 |                   type={showKeys[config.key] ? "text" : "password"}
172 |                   value={apiKeys[config.key] || ""}
173 |                   onChange={(e) => handleApiKeyChange(config.key, e.target.value)}
174 |                   placeholder={config.placeholder}
175 |                   className="text-sm pr-10"
176 |                 />
177 |                 <Button
178 |                   type="button"
179 |                   variant="ghost"
180 |                   size="sm"
181 |                   className="absolute right-0 top-0 h-full px-3 py-2 hover:bg-transparent"
182 |                   onClick={() => toggleKeyVisibility(config.key)}
183 |                 >
184 |                   {showKeys[config.key] ? (
185 |                     <EyeOff className="h-3 w-3 sm:h-4 sm:w-4 text-muted-foreground" />
186 |                   ) : (
187 |                     <Eye className="h-3 w-3 sm:h-4 sm:w-4 text-muted-foreground" />
188 |                   )}
189 |                 </Button>
190 |               </div>
191 |             </div>
192 |           ))}
193 |         </div>
194 |         
195 |         <DialogFooter className="flex-col-reverse sm:flex-row gap-2 sm:gap-3 pt-2 sm:pt-4">
196 |           <Button
197 |             variant="destructive"
198 |             onClick={handleClearApiKeys}
199 |             className="w-full sm:w-auto text-xs sm:text-sm"
200 |           >
201 |             Clear All Keys
202 |           </Button>
203 |           <div className="flex gap-2 sm:gap-3 w-full sm:w-auto">
204 |             <Button
205 |               variant="outline"
206 |               onClick={() => onOpenChange(false)}
207 |               className="flex-1 sm:flex-none text-xs sm:text-sm"
208 |             >
209 |               Cancel
210 |             </Button>
211 |             <Button 
212 |               onClick={handleSaveApiKeys}
213 |               className="flex-1 sm:flex-none text-xs sm:text-sm"
214 |             >
215 |               Save Keys
216 |             </Button>
217 |           </div>
218 |         </DialogFooter>
219 |       </DialogContent>
220 |     </Dialog>
221 |   );
222 | } 
```

components/chat-list.tsx
```
1 | "use client";
2 | 
3 | import { useState, useRef, ChangeEvent, KeyboardEvent, FocusEvent } from "react";
4 | import { useRouter, usePathname } from "next/navigation";
5 | import { MessageSquare, PlusCircle, Trash2, CheckIcon, XIcon, Loader2, Pencil, Share2 } from "lucide-react";
6 | import {
7 |     SidebarGroupContent,
8 |     SidebarMenuItem,
9 |     SidebarMenuButton,
10 | } from "@/components/ui/sidebar";
11 | import { Button } from "@/components/ui/button";
12 | import { Input } from "@/components/ui/input";
13 | import { cn } from "@/lib/utils";
14 | import Link from "next/link";
15 | import { AnimatePresence, motion } from "framer-motion";
16 | import { toast } from "sonner";
17 | import { Skeleton } from "@/components/ui/skeleton";
18 | import {
19 |     Tooltip,
20 |     TooltipContent,
21 |     TooltipProvider,
22 |     TooltipTrigger,
23 | } from "@/components/ui/tooltip";
24 | import { SidebarMenu } from "@/components/ui/sidebar";
25 | import { ChatShareDialog } from "@/components/chat-share-dialog";
26 | 
27 | interface Chat {
28 |     id: string;
29 |     title: string;
30 |     userId: string;
31 |     createdAt: Date;
32 |     updatedAt: Date;
33 |     shareId?: string | null;
34 |     sharePath?: string | null;
35 | }
36 | 
37 | interface ChatListProps {
38 |     chats: Chat[];
39 |     isLoading: boolean;
40 |     isCollapsed: boolean;
41 |     isUpdatingChatTitle: boolean;
42 |     onNewChat: () => void;
43 |     onDeleteChat: (chatId: string, e: React.MouseEvent) => void;
44 |     onUpdateChatTitle: (params: { chatId: string, title: string }, options: { onSuccess: () => void, onError: () => void }) => void;
45 |     onNavigateToChat?: (chatId: string) => void;
46 |     onLoadMoreChats?: () => void;
47 |     hasMoreChats?: boolean;
48 |     isLoadingMore?: boolean;
49 | }
50 | 
51 | export function ChatList({
52 |     chats,
53 |     isLoading,
54 |     isCollapsed,
55 |     isUpdatingChatTitle,
56 |     onNewChat,
57 |     onDeleteChat,
58 |     onUpdateChatTitle,
59 |     onNavigateToChat,
60 |     onLoadMoreChats,
61 |     hasMoreChats = false,
62 |     isLoadingMore = false,
63 | }: ChatListProps) {
64 |     const router = useRouter();
65 |     const pathname = usePathname();
66 |     const [searchTerm, setSearchTerm] = useState("");
67 |     const [editingChatId, setEditingChatId] = useState<string | null>(null);
68 |     const [editingChatTitle, setEditingChatTitle] = useState<string>("");
69 |     const [sharingChatId, setSharingChatId] = useState<string | null>(null);
70 |     const [sharingChatTitle, setSharingChatTitle] = useState<string>("");
71 |     const inputRef = useRef<HTMLInputElement>(null);
72 | 
73 |     const filteredChats = chats?.filter(chat =>
74 |         chat.title.toLowerCase().includes(searchTerm.toLowerCase())
75 |     ) || [];
76 | 
77 |     const handleStartEdit = (chatId: string, currentTitle: string, e: React.MouseEvent) => {
78 |         e.stopPropagation();
79 |         e.preventDefault();
80 |         setEditingChatId(chatId);
81 |         setEditingChatTitle(currentTitle);
82 |         setTimeout(() => {
83 |             inputRef.current?.focus();
84 |             inputRef.current?.select();
85 |         }, 0);
86 |     };
87 | 
88 |     const handleCancelEdit = () => {
89 |         setEditingChatId(null);
90 |         setEditingChatTitle("");
91 |     };
92 | 
93 |     const handleStartShare = (chatId: string, chatTitle: string, e: React.MouseEvent) => {
94 |         e.stopPropagation();
95 |         e.preventDefault();
96 |         setSharingChatId(chatId);
97 |         setSharingChatTitle(chatTitle);
98 |     };
99 | 
100 |     const handleCloseShare = () => {
101 |         setSharingChatId(null);
102 |         setSharingChatTitle("");
103 |     };
104 | 
105 |     const handleSaveEdit = () => {
106 |         if (!editingChatId || editingChatTitle.trim() === "") {
107 |             toast.error("Chat title cannot be empty.");
108 |             inputRef.current?.focus();
109 |             return;
110 |         }
111 | 
112 |         onUpdateChatTitle(
113 |             { chatId: editingChatId, title: editingChatTitle.trim() },
114 |             {
115 |                 onSuccess: () => {
116 |                     setEditingChatId(null);
117 |                     setEditingChatTitle("");
118 |                 },
119 |                 onError: () => {
120 |                     inputRef.current?.focus();
121 |                     inputRef.current?.select();
122 |                 }
123 |             }
124 |         );
125 |     };
126 | 
127 |     const handleInputChange = (e: ChangeEvent<HTMLInputElement>) => {
128 |         setEditingChatTitle(e.target.value);
129 |     };
130 | 
131 |     const handleInputKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {
132 |         if (e.key === 'Enter') {
133 |             e.preventDefault();
134 |             handleSaveEdit();
135 |         } else if (e.key === 'Escape') {
136 |             e.preventDefault();
137 |             handleCancelEdit();
138 |         }
139 |     };
140 | 
141 |     const handleInputBlur = (e: FocusEvent<HTMLInputElement>) => {
142 |         if (e.relatedTarget && (e.relatedTarget.id === `save-chat-${editingChatId}` || e.relatedTarget.id === `cancel-chat-${editingChatId}`)) {
143 |             return;
144 |         }
145 |         setTimeout(() => {
146 |             if (editingChatId && document.activeElement !== inputRef.current) {
147 |                 const activeElementId = document.activeElement?.id;
148 |                 if (activeElementId !== `save-chat-${editingChatId}` && activeElementId !== `cancel-chat-${editingChatId}`) {
149 |                     handleCancelEdit();
150 |                 }
151 |             }
152 |         }, 100);
153 |     };
154 | 
155 |     const renderChatSkeletons = () => {
156 |         return Array(3).fill(0).map((_, index) => (
157 |             <SidebarMenuItem key={`skeleton-${index}`}>
158 |                 <div className={`flex items-center gap-2 px-3 py-2 ${isCollapsed ? "justify-center" : ""}`}>
159 |                     <Skeleton className="h-4 w-4 rounded-full" />
160 |                     {!isCollapsed && (
161 |                         <>
162 |                             <Skeleton className="h-4 w-full max-w-[180px]" />
163 |                             <Skeleton className="h-5 w-5 ml-auto rounded-md flex-shrink-0" />
164 |                         </>
165 |                     )}
166 |                 </div>
167 |             </SidebarMenuItem>
168 |         ));
169 |     };
170 | 
171 |     return (
172 |         <>
173 |             {!isCollapsed && (
174 |                 <div className="px-3 pt-1 pb-2 border-b border-border/40">
175 |                     <Button
176 |                         variant="outline"
177 |                         className="w-full mb-2"
178 |                         onClick={onNewChat}
179 |                     >
180 |                         <PlusCircle className="mr-2 h-4 w-4" />
181 |                         New Chat
182 |                     </Button>
183 |                     <Input
184 |                         type="search"
185 |                         placeholder="Search chats..."
186 |                         aria-label="Search chats by title"
187 |                         value={searchTerm}
188 |                         onChange={e => setSearchTerm(e.target.value)}
189 |                         className="w-full"
190 |                     />
191 |                 </div>
192 |             )}
193 |             <SidebarGroupContent className={cn(
194 |                 "overflow-y-auto",
195 |                 isCollapsed ? "overflow-x-hidden overflow-y-hidden" : ""
196 |             )}>
197 |                 {isLoading ? (
198 |                     renderChatSkeletons()
199 |                 ) : filteredChats && filteredChats.length > 0 ? (
200 |                     <AnimatePresence initial={false}>
201 |                         {filteredChats.map((chat) => {
202 |                             const isActive = pathname === `/chat/${chat.id}`;
203 |                             const isEditingThisChat = editingChatId === chat.id;
204 |                             return (
205 |                                 <motion.div
206 |                                     key={chat.id}
207 |                                     initial={{ opacity: 0, height: 0 }}
208 |                                     animate={{ opacity: 1, height: "auto" }}
209 |                                     exit={{ opacity: 0, height: 0 }}
210 |                                     transition={{ duration: 0.2 }}
211 |                                     className="overflow-hidden list-none"
212 |                                 >
213 |                                     <SidebarMenuItem>
214 |                                         {isEditingThisChat ? (
215 |                                             <div className="flex items-center gap-2 px-3 py-2 w-full">
216 |                                                 <Input
217 |                                                     ref={inputRef}
218 |                                                     value={editingChatTitle}
219 |                                                     onChange={handleInputChange}
220 |                                                     onKeyDown={handleInputKeyDown}
221 |                                                     onBlur={handleInputBlur}
222 |                                                     className="h-7 flex-grow px-1 text-sm"
223 |                                                     maxLength={100}
224 |                                                 />
225 |                                                 <Button
226 |                                                     id={`save-chat-${chat.id}`}
227 |                                                     variant="ghost"
228 |                                                     size="icon"
229 |                                                     className="h-6 w-6 text-green-500 hover:text-green-600"
230 |                                                     onClick={handleSaveEdit}
231 |                                                     disabled={isUpdatingChatTitle}
232 |                                                 >
233 |                                                     {isUpdatingChatTitle && editingChatId === chat.id ? (
234 |                                                         <Loader2 className="h-4 w-4 animate-spin" />
235 |                                                     ) : (
236 |                                                         <CheckIcon className="h-4 w-4" />
237 |                                                     )}
238 |                                                 </Button>
239 |                                                 <Button
240 |                                                     id={`cancel-chat-${chat.id}`}
241 |                                                     variant="ghost"
242 |                                                     size="icon"
243 |                                                     className="h-6 w-6 text-red-500 hover:text-red-600"
244 |                                                     onClick={handleCancelEdit}
245 |                                                     disabled={isUpdatingChatTitle}
246 |                                                 >
247 |                                                     <XIcon className="h-4 w-4" />
248 |                                                 </Button>
249 |                                             </div>
250 |                                         ) : (
251 |                                             <>
252 |                                                 {isCollapsed ? (
253 |                                                     <TooltipProvider delayDuration={0}>
254 |                                                         <Tooltip>
255 |                                                             <TooltipTrigger asChild>
256 |                                                                 <SidebarMenuButton
257 |                                                                     onClick={() => {
258 |                                                                         router.push(`/chat/${chat.id}`);
259 |                                                                         onNavigateToChat?.(chat.id);
260 |                                                                     }}
261 |                                                                     isActive={isActive}
262 |                                                                     className={cn(
263 |                                                                         "w-full flex justify-center",
264 |                                                                         isActive && "bg-primary/10 dark:bg-primary/20 text-primary hover:text-primary"
265 |                                                                     )}
266 |                                                                 >
267 |                                                                     <MessageSquare className="h-4 w-4" />
268 |                                                                 </SidebarMenuButton>
269 |                                                             </TooltipTrigger>
270 |                                                             <TooltipContent side="right" sideOffset={5}>
271 |                                                                 <p>
272 |                                                                     {chat.title}
273 |                                                                     {chat.sharePath && (
274 |                                                                         <span className="ml-2 text-muted-foreground">• Shared</span>
275 |                                                                     )}
276 |                                                                 </p>
277 |                                                             </TooltipContent>
278 |                                                         </Tooltip>
279 |                                                     </TooltipProvider>
280 |                                                 ) : (
281 |                                                     <TooltipProvider delayDuration={0}>
282 |                                                         <Tooltip>
283 |                                                             <TooltipTrigger asChild>
284 |                                                                 <SidebarMenuButton
285 |                                                                     asChild
286 |                                                                     isActive={isActive}
287 |                                                                     className={cn(
288 |                                                                         "w-full flex items-center gap-2",
289 |                                                                         isActive && "bg-primary/10 dark:bg-primary/20 text-primary hover:text-primary"
290 |                                                                     )}
291 |                                                                 >
292 |                                                                     <div className="flex items-center w-full min-w-0">
293 |                                                                         <Link
294 |                                                                             href={`/chat/${chat.id}`}
295 |                                                                             className="flex items-center min-w-0 flex-1 gap-2"
296 |                                                                             onClick={() => onNavigateToChat?.(chat.id)}
297 |                                                                         >
298 |                                                                             <span className="min-w-0 flex-1 truncate">
299 |                                                                                 {chat.title || `Chat ${chat.id.substring(0, 8)}...`}
300 |                                                                             </span>
301 |                                                                             {chat.sharePath && (
302 |                                                                                 <Share2 className="h-3 w-3 text-muted-foreground/60 flex-shrink-0" />
303 |                                                                             )}
304 |                                                                         </Link>
305 |                                                                         <div className="ml-2 flex items-center gap-1 opacity-0 group-hover/menu-item:opacity-100 group-focus-within/menu-item:opacity-100 transition-opacity duration-150">
306 |                                                                             <Button
307 |                                                                                 variant="ghost"
308 |                                                                                 size="icon"
309 |                                                                                 className="h-6 w-6 hover:text-green-500"
310 |                                                                                 onClick={(e) => handleStartShare(chat.id, chat.title, e)}
311 |                                                                                 title="Share chat"
312 |                                                                             >
313 |                                                                                 <Share2 className="h-3 w-3" />
314 |                                                                             </Button>
315 |                                                                             <Button
316 |                                                                                 variant="ghost"
317 |                                                                                 size="icon"
318 |                                                                                 className="h-6 w-6 hover:text-blue-500"
319 |                                                                                 onClick={(e) => handleStartEdit(chat.id, chat.title, e)}
320 |                                                                                 title="Edit title"
321 |                                                                             >
322 |                                                                                 <Pencil className="h-3 w-3" />
323 |                                                                             </Button>
324 |                                                                             <Button
325 |                                                                                 variant="ghost"
326 |                                                                                 size="icon"
327 |                                                                                 className="h-6 w-6 hover:text-red-500"
328 |                                                                                 onClick={(e) => onDeleteChat(chat.id, e)}
329 |                                                                                 title="Delete chat"
330 |                                                                             >
331 |                                                                                 <Trash2 className="h-3 w-3" />
332 |                                                                             </Button>
333 |                                                                         </div>
334 |                                                                     </div>
335 |                                                                 </SidebarMenuButton>
336 |                                                             </TooltipTrigger>
337 |                                                             <TooltipContent side="right" sideOffset={5}>
338 |                                                                 <p>
339 |                                                                     {chat.title}
340 |                                                                     {chat.sharePath && (
341 |                                                                         <span className="ml-2 text-muted-foreground">• Shared</span>
342 |                                                                     )}
343 |                                                                 </p>
344 |                                                             </TooltipContent>
345 |                                                         </Tooltip>
346 |                                                     </TooltipProvider>
347 |                                                 )}
348 |                                                 {!isCollapsed && null}
349 |                                             </>
350 |                                         )}
351 |                                     </SidebarMenuItem>
352 |                                 </motion.div>
353 |                             );
354 |                         })}
355 |                         
356 |                         {/* Load More Button */}
357 |                         {!searchTerm && hasMoreChats && onLoadMoreChats && !isCollapsed && (
358 |                             <SidebarMenuItem className="mt-2 list-none">
359 |                                 <Button
360 |                                     variant="ghost"
361 |                                     className="w-full justify-start text-muted-foreground hover:text-foreground"
362 |                                     onClick={onLoadMoreChats}
363 |                                     disabled={isLoadingMore}
364 |                                 >
365 |                                     {isLoadingMore ? (
366 |                                         <>
367 |                                             <Loader2 className="mr-2 h-4 w-4 animate-spin" />
368 |                                             Loading more chats...
369 |                                         </>
370 |                                     ) : (
371 |                                         <>
372 |                                             <PlusCircle className="mr-2 h-4 w-4" />
373 |                                             Load more chats
374 |                                         </>
375 |                                     )}
376 |                                 </Button>
377 |                             </SidebarMenuItem>
378 |                         )}
379 |                     </AnimatePresence>
380 |                 ) : (
381 |                     <SidebarMenu>
382 |                         {searchTerm ? (
383 |                             <SidebarMenuItem className="text-sm text-muted-foreground px-3 py-2 list-none">
384 |                                 {!isCollapsed && "No results found."}
385 |                             </SidebarMenuItem>
386 |                         ) : (
387 |                             <SidebarMenuItem className="text-sm text-muted-foreground px-3 py-2 list-none">
388 |                                 {!isCollapsed && "No chats yet. Start a new one!"}
389 |                             </SidebarMenuItem>
390 |                         )}
391 |                     </SidebarMenu>
392 |                 )}
393 |             </SidebarGroupContent>
394 |             
395 |             {/* Share Dialog */}
396 |             {sharingChatId && (
397 |                 <ChatShareDialog
398 |                     isOpen={!!sharingChatId}
399 |                     onOpenChange={(open) => {
400 |                         if (!open) {
401 |                             handleCloseShare();
402 |                         }
403 |                     }}
404 |                     chatId={sharingChatId}
405 |                     chatTitle={sharingChatTitle}
406 |                 />
407 |             )}
408 |         </>
409 |     );
410 | } 
```

components/chat-share-dialog.tsx
```
1 | "use client";
2 | 
3 | import { useState, useEffect } from "react";
4 | import { useMutation, useQueryClient } from '@tanstack/react-query';
5 | import { Button } from "@/components/ui/button";
6 | import { 
7 |   Dialog, 
8 |   DialogContent, 
9 |   DialogDescription, 
10 |   DialogFooter, 
11 |   DialogHeader, 
12 |   DialogTitle 
13 | } from "@/components/ui/dialog";
14 | import { Input } from "@/components/ui/input";
15 | import { Label } from "@/components/ui/label";
16 | import { Checkbox } from "@/components/ui/checkbox";
17 | import { toast } from "sonner";
18 | import { Loader2, Share, Link as LinkIcon, Eye, EyeOff, Copy, Check } from "lucide-react";
19 | import { type ChatWithShareInfo } from '@/lib/db/schema';
20 | 
21 | interface ChatShareDialogProps {
22 |   isOpen: boolean;
23 |   onOpenChange: (open: boolean) => void;
24 |   chatId: string;
25 |   chatTitle: string;
26 | }
27 | 
28 | interface ShareData {
29 |   shareId: string;
30 |   shareUrl: string;
31 | }
32 | 
33 | export function ChatShareDialog({ 
34 |   isOpen, 
35 |   onOpenChange, 
36 |   chatId, 
37 |   chatTitle
38 | }: ChatShareDialogProps) {
39 |   const [shareData, setShareData] = useState<ShareData | null>(null);
40 |   const [hasConsented, setHasConsented] = useState(false);
41 |   const [isShared, setIsShared] = useState(false);
42 |   const [isCopied, setIsCopied] = useState(false);
43 |   const [isCheckingExisting, setIsCheckingExisting] = useState(false);
44 | 
45 |   const queryClient = useQueryClient();
46 | 
47 |   // Mutation to create a chat share
48 |   const createShareMutation = useMutation({
49 |     mutationFn: async (chatId: string) => {
50 |       const response = await fetch(`/api/chats/${chatId}/share`, {
51 |         method: 'POST',
52 |         headers: {
53 |           'Content-Type': 'application/json',
54 |         },
55 |       });
56 | 
57 |       if (!response.ok) {
58 |         const error = await response.text();
59 |         throw new Error(error || 'Failed to create share link');
60 |       }
61 | 
62 |       const data = await response.json();
63 |       return { chatId, shareData: data };
64 |     },
65 |     onSuccess: ({ chatId, shareData }) => {
66 |       // Update local state
67 |       setShareData(shareData);
68 |       setIsShared(true);
69 | 
70 |       // Update all chat queries by invalidating them - this ensures all variants get updated
71 |       queryClient.invalidateQueries({ queryKey: ['chats'] });
72 | 
73 |       toast.success("Share link ready!");
74 |     },
75 |     onError: (error) => {
76 |       console.error('Error creating share:', error);
77 |       toast.error("Failed to create share link. Please try again.");
78 |     }
79 |   });
80 | 
81 |   // Mutation to revoke a chat share
82 |   const revokeShareMutation = useMutation({
83 |     mutationFn: async (chatId: string) => {
84 |       const response = await fetch(`/api/chats/${chatId}/share`, {
85 |         method: 'DELETE',
86 |       });
87 | 
88 |       if (!response.ok) {
89 |         throw new Error('Failed to revoke share link');
90 |       }
91 | 
92 |       return chatId;
93 |     },
94 |     onSuccess: (chatId) => {
95 |       // Update local state
96 |       setShareData(null);
97 |       setIsShared(false);
98 | 
99 |       // Update all chat queries by invalidating them - this ensures all variants get updated
100 |       queryClient.invalidateQueries({ queryKey: ['chats'] });
101 |       
102 |       toast.success("Share link revoked successfully!");
103 |     },
104 |     onError: (error) => {
105 |       console.error('Error revoking share:', error);
106 |       toast.error("Failed to revoke share link. Please try again.");
107 |     }
108 |   });
109 | 
110 |   // Check for existing share when dialog opens
111 |   useEffect(() => {
112 |     if (isOpen && !shareData) {
113 |       checkExistingShare();
114 |     }
115 |   }, [isOpen, chatId]);
116 | 
117 |   const checkExistingShare = async () => {
118 |     setIsCheckingExisting(true);
119 |     try {
120 |       const response = await fetch(`/api/chats/${chatId}/share`, {
121 |         method: 'GET',
122 |         headers: {
123 |           'Content-Type': 'application/json',
124 |         },
125 |       });
126 | 
127 |       if (response.ok) {
128 |         const data = await response.json();
129 |         if (data.exists !== false) {
130 |           // Share exists, show it
131 |           setShareData(data);
132 |           setIsShared(true);
133 |         }
134 |         // If data.exists === false, we'll show the consent form
135 |       }
136 |     } catch (error) {
137 |       console.error('Error checking existing share:', error);
138 |       // If there's an error, we'll just show the create form
139 |     } finally {
140 |       setIsCheckingExisting(false);
141 |     }
142 |   };
143 | 
144 | 
145 | 
146 |   const handleCreateShare = () => {
147 |     if (!hasConsented) {
148 |       toast.error("Please agree to the terms before creating a share link.");
149 |       return;
150 |     }
151 | 
152 |     createShareMutation.mutate(chatId);
153 |   };
154 | 
155 |   const handleRevokeShare = () => {
156 |     revokeShareMutation.mutate(chatId);
157 |   };
158 | 
159 |   const handleCopyUrl = async () => {
160 |     if (shareData?.shareUrl) {
161 |       try {
162 |         await navigator.clipboard.writeText(shareData.shareUrl);
163 |         setIsCopied(true);
164 |         toast.success("Share URL copied to clipboard!");
165 |         // Reset the copied state after 2 seconds
166 |         setTimeout(() => setIsCopied(false), 2000);
167 |       } catch (error) {
168 |         toast.error("Failed to copy URL to clipboard");
169 |       }
170 |     }
171 |   };
172 | 
173 |   const handleDialogClose = (open: boolean) => {
174 |     if (!open) {
175 |       // Reset state when dialog closes
176 |       setHasConsented(false);
177 |       setIsCopied(false);
178 |       setShareData(null);
179 |       setIsShared(false);
180 |     }
181 |     onOpenChange(open);
182 |   };
183 | 
184 |   return (
185 |     <Dialog open={isOpen} onOpenChange={handleDialogClose}>
186 |       <DialogContent className="sm:max-w-md">
187 |         <DialogHeader>
188 |           <DialogTitle className="flex items-center gap-2">
189 |             <Share className="h-5 w-5" />
190 |             Share Chat
191 |           </DialogTitle>
192 |           <DialogDescription>
193 |             Create a public link to share &quot;{chatTitle}&quot; with others.
194 |           </DialogDescription>
195 |         </DialogHeader>
196 | 
197 |         <div className="space-y-4">
198 |           {(isCheckingExisting || createShareMutation.isPending || revokeShareMutation.isPending) && !shareData && (
199 |             <div className="flex items-center justify-center py-8">
200 |               <Loader2 className="h-6 w-6 animate-spin" />
201 |               <span className="ml-2 text-sm text-muted-foreground">
202 |                 {isCheckingExisting ? "Checking for existing share..." : 
203 |                  createShareMutation.isPending ? "Creating share..." : "Revoking share..."}
204 |               </span>
205 |             </div>
206 |           )}
207 | 
208 |           {!isCheckingExisting && !createShareMutation.isPending && !revokeShareMutation.isPending && !isShared && !shareData && (
209 |             <>
210 |               {/* Privacy Notice */}
211 |               <div className="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-3">
212 |                 <h4 className="text-sm font-medium text-orange-800 dark:text-orange-200 mb-1">
213 |                   Privacy Notice
214 |                 </h4>
215 |                 <p className="text-xs text-orange-700 dark:text-orange-300">
216 |                   This creates an unlisted public link. Personal information, API keys, 
217 |                   system prompts, and media will be removed for privacy.
218 |                 </p>
219 |               </div>
220 | 
221 |               {/* Consent Checkbox */}
222 |               <div className="flex items-start space-x-3">
223 |                 <Checkbox
224 |                   id="consent"
225 |                   checked={hasConsented}
226 |                   onCheckedChange={(checked) => setHasConsented(checked === true)}
227 |                 />
228 |                 <Label htmlFor="consent" className="text-sm leading-5">
229 |                   I understand this creates an unlisted public link and agree to the{" "}
230 |                   <a
231 |                     href="/terms"
232 |                     target="_blank"
233 |                     rel="noopener noreferrer"
234 |                     className="text-primary hover:underline"
235 |                   >
236 |                     Terms of Service
237 |                   </a>
238 |                   {" "}and{" "}
239 |                   <a
240 |                     href="/privacy"
241 |                     target="_blank"
242 |                     rel="noopener noreferrer"
243 |                     className="text-primary hover:underline"
244 |                   >
245 |                     Privacy Policy
246 |                   </a>
247 |                   .
248 |                 </Label>
249 |               </div>
250 |             </>
251 |           )}
252 | 
253 |           {/* Share Link Display */}
254 |           {shareData && (
255 |             <div className="space-y-3">
256 |               <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-3">
257 |                 <div className="flex items-center gap-2 mb-2">
258 |                   <Eye className="h-4 w-4 text-green-600 dark:text-green-400" />
259 |                   <span className="text-sm font-medium text-green-800 dark:text-green-200">
260 |                     Share link created
261 |                   </span>
262 |                 </div>
263 |                 <p className="text-xs text-green-700 dark:text-green-300">
264 |                   Anyone with this link can view a read-only version of your chat.
265 |                 </p>
266 |               </div>
267 | 
268 |               <div className="space-y-2">
269 |                 <Label htmlFor="share-url" className="text-sm font-medium">
270 |                   Share URL
271 |                 </Label>
272 |                 <div className="flex gap-2">
273 |                   <Input
274 |                     id="share-url"
275 |                     value={shareData.shareUrl}
276 |                     readOnly
277 |                     className="font-mono text-xs"
278 |                   />
279 |                   <Button
280 |                     variant="outline"
281 |                     size="sm"
282 |                     onClick={handleCopyUrl}
283 |                     className="h-10 px-3 shrink-0"
284 |                     title="Copy share URL to clipboard"
285 |                   >
286 |                     {isCopied ? (
287 |                       <>
288 |                         <Check className="h-4 w-4 mr-1" />
289 |                         Copied!
290 |                       </>
291 |                     ) : (
292 |                       <>
293 |                         <Copy className="h-4 w-4 mr-1" />
294 |                         Copy
295 |                       </>
296 |                     )}
297 |                   </Button>
298 |                 </div>
299 |               </div>
300 |             </div>
301 |           )}
302 |         </div>
303 | 
304 |         <DialogFooter className="flex-col sm:flex-row gap-2">
305 |           {(isCheckingExisting || createShareMutation.isPending || revokeShareMutation.isPending) && !shareData ? (
306 |             // Don't show buttons while processing
307 |             <></>
308 |           ) : !isShared && !shareData ? (
309 |             <>
310 |               <Button
311 |                 variant="outline"
312 |                 onClick={() => onOpenChange(false)}
313 |                 className="w-full sm:w-auto"
314 |               >
315 |                 Cancel
316 |               </Button>
317 |               <Button
318 |                 onClick={handleCreateShare}
319 |                 disabled={!hasConsented || createShareMutation.isPending}
320 |                 className="w-full sm:w-auto"
321 |               >
322 |                 {createShareMutation.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
323 |                 <LinkIcon className="mr-2 h-4 w-4" />
324 |                 Create Share Link
325 |               </Button>
326 |             </>
327 |           ) : (
328 |             <>
329 |               <Button
330 |                 variant="outline"
331 |                 onClick={handleRevokeShare}
332 |                 disabled={revokeShareMutation.isPending}
333 |                 className="w-full sm:w-auto"
334 |               >
335 |                 {revokeShareMutation.isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
336 |                 <EyeOff className="mr-2 h-4 w-4" />
337 |                 Disable Link
338 |               </Button>
339 |               <Button
340 |                 onClick={() => onOpenChange(false)}
341 |                 className="w-full sm:w-auto"
342 |               >
343 |                 Done
344 |               </Button>
345 |             </>
346 |           )}
347 |         </DialogFooter>
348 |       </DialogContent>
349 |     </Dialog>
350 |   );
351 | }
```

components/chat-sidebar.tsx
```
1 | "use client";
2 | 
3 | import { useState, useEffect, useRef } from "react";
4 | import { useRouter, usePathname } from "next/navigation";
5 | import { MessageSquare, PlusCircle, Trash2, ServerIcon, Settings, Sparkles, ChevronsUpDown, Copy, Github, Key, LogOut, Globe, BookOpen, Activity } from "lucide-react";
6 | import {
7 |     Sidebar,
8 |     SidebarContent,
9 |     SidebarFooter,
10 |     SidebarGroup,
11 |     SidebarGroupContent,
12 |     SidebarGroupLabel,
13 |     SidebarHeader,
14 |     SidebarMenu,
15 |     SidebarMenuButton,
16 |     SidebarMenuItem,
17 |     SidebarMenuBadge,
18 |     useSidebar
19 | } from "@/components/ui/sidebar";
20 | import { Separator } from "@/components/ui/separator";
21 | import { Button } from "@/components/ui/button";
22 | import { Badge } from "@/components/ui/badge";
23 | import { toast } from "sonner";
24 | import Image from "next/image";
25 | import { MCPServerManager } from "./mcp-server-manager";
26 | import { ApiKeyManager } from "./api-key-manager";
27 | import { ThemeToggle } from "./theme-toggle";
28 | import { ProviderHealthDashboard } from "./provider-health-dashboard";
29 | import { useChats } from "@/lib/hooks/use-chats";
30 | import { cn } from "@/lib/utils";
31 | import Link from "next/link";
32 | import {
33 |     DropdownMenu,
34 |     DropdownMenuContent,
35 |     DropdownMenuGroup,
36 |     DropdownMenuItem,
37 |     DropdownMenuLabel,
38 |     DropdownMenuSeparator,
39 |     DropdownMenuTrigger,
40 | } from "@/components/ui/dropdown-menu";
41 | import { Avatar, AvatarFallback } from "@/components/ui/avatar";
42 | import {
43 |     Dialog,
44 |     DialogContent,
45 |     DialogDescription,
46 |     DialogFooter,
47 |     DialogHeader,
48 |     DialogTitle,
49 | } from "@/components/ui/dialog";
50 | import { Input } from "@/components/ui/input";
51 | import { Label } from "@/components/ui/label";
52 | import { useMCP } from "@/lib/context/mcp-context";
53 | import { Skeleton } from "@/components/ui/skeleton";
54 | import { SignInButton } from "@/components/auth/SignInButton";
55 | import { UserAccountMenu } from "@/components/auth/UserAccountMenu";
56 | import { useAuth, signOut } from "@/hooks/useAuth";
57 | import { useQueryClient } from "@tanstack/react-query";
58 | import { Flame, Sun } from "lucide-react";
59 | import { useWebSearch } from "@/lib/context/web-search-context";
60 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
61 | import { useClientMount } from "@/lib/hooks/use-client-mount";
62 | import {
63 |     Tooltip,
64 |     TooltipContent,
65 |     TooltipProvider,
66 |     TooltipTrigger,
67 | } from "@/components/ui/tooltip";
68 | import { ChatList } from "./chat-list";
69 | 
70 | export function ChatSidebar() {
71 |     const router = useRouter();
72 |     const pathname = usePathname();
73 |     const [userId, setUserId] = useState<string | null>(null);
74 |     const [mcpSettingsOpen, setMcpSettingsOpen] = useState(false);
75 |     const [apiKeySettingsOpen, setApiKeySettingsOpen] = useState(false);
76 |     const [providerHealthOpen, setProviderHealthOpen] = useState(false);
77 |     const isMounted = useClientMount();
78 |     const { state, setOpen, openMobile, setOpenMobile, isMobile } = useSidebar();
79 |     const isCollapsed = state === "collapsed";
80 |     // On mobile, always show expanded layout
81 |     const isLayoutCollapsed = isCollapsed && !isMobile;
82 | 
83 |     const { session, isPending: isSessionLoading } = useAuth();
84 |     const authenticatedUserId = session?.user?.id;
85 |     const previousSessionRef = useRef(session);
86 |     const invalidationRef = useRef(false);
87 | 
88 |     const queryClient = useQueryClient();
89 | 
90 |     const { mcpServers, setMcpServers, selectedMcpServers, setSelectedMcpServers } = useMCP();
91 |     const { webSearchContextSize, setWebSearchContextSize, webSearchEnabled } = useWebSearch();
92 |     const isAnyOpenRouterModelSelected = true;
93 | 
94 |     const renderChatSkeletons = () => {
95 |         return Array(3).fill(0).map((_, index) => (
96 |             <SidebarMenuItem key={`skeleton-${index}`} className="px-0">
97 |                 <div className={cn(
98 |                     "flex items-center gap-2 px-3 py-2 w-full",
99 |                     isCollapsed ? "justify-center" : "pr-10"
100 |                 )}>
101 |                     <Skeleton className="h-4 w-4 rounded-md flex-shrink-0" />
102 |                     {!isCollapsed && (
103 |                         <>
104 |                             <Skeleton className="h-4 flex-grow max-w-[160px]" />
105 |                             <div className="ml-auto flex items-center gap-1">
106 |                                 <Skeleton className="h-4 w-4 rounded-md" />
107 |                                 <Skeleton className="h-4 w-4 rounded-md" />
108 |                             </div>
109 |                         </>
110 |                     )}
111 |                 </div>
112 |             </SidebarMenuItem>
113 |         ));
114 |     };
115 | 
116 |     useEffect(() => {
117 |         if (!isSessionLoading) {
118 |             if (authenticatedUserId) {
119 |                 setUserId(authenticatedUserId);
120 |             } else {
121 |                 setUserId(null);
122 |             }
123 |         }
124 |     }, [authenticatedUserId, isSessionLoading]);
125 | 
126 |     useEffect(() => {
127 |         const currentSession = session;
128 |         const previousSession = previousSessionRef.current;
129 | 
130 |         // Prevent multiple rapid invalidations
131 |         if (invalidationRef.current) {
132 |             previousSessionRef.current = currentSession;
133 |             return;
134 |         }
135 | 
136 |         if (!previousSession?.user && currentSession?.user?.id) {
137 |             const authenticatedUserId = currentSession.user.id;
138 |             console.log('User logged in (ID):', authenticatedUserId);
139 |             // Log the entire user object for inspection
140 |             console.log('Session User Object:', currentSession.user);
141 |             
142 |             setUserId(authenticatedUserId);
143 |             
144 |             // Debounce query invalidations to prevent cascade
145 |             invalidationRef.current = true;
146 |             setTimeout(() => {
147 |                 queryClient.invalidateQueries({ queryKey: ['chats'] });
148 |                 queryClient.invalidateQueries({ queryKey: ['chat'] });
149 |                 invalidationRef.current = false;
150 |             }, 100);
151 |             
152 |         } else if (previousSession?.user && !currentSession?.user) {
153 |             console.log('User logged out.');
154 |             setUserId(null);
155 |             router.push('/');
156 |             
157 |             // Debounce query invalidations to prevent cascade
158 |             invalidationRef.current = true;
159 |             setTimeout(() => {
160 |                 queryClient.invalidateQueries({ queryKey: ['chats'] });
161 |                 queryClient.invalidateQueries({ queryKey: ['chat'] });
162 |                 invalidationRef.current = false;
163 |             }, 100);
164 |         }
165 | 
166 |         previousSessionRef.current = currentSession;
167 |     }, [session, queryClient, router]);
168 |     
169 |     useEffect(() => {
170 |         // Log anonymous user ID and email for debugging purposes if the user is flagged as anonymous.
171 |         if (!isSessionLoading && session?.user?.isAnonymous === true) {
172 |             // This log will only appear in the developer console.
173 |             //console.log('Anonymous User (for debugging): ID=', session.user.id, ', Email=', session.user.email);
174 |         }
175 |     }, [session, isSessionLoading]);
176 | 
177 |     // Fix hydration error by ensuring consistent initial state
178 | 
179 | 
180 |     const { chats, isLoading: isChatsLoading, deleteChat, refreshChats, updateChatTitle, isUpdatingChatTitle, loadMoreChats, hasMoreChats, isLoadingMore } = useChats();
181 |     const isLoading = !isMounted || isSessionLoading || isChatsLoading;
182 | 
183 |     const handleNewChat = () => {
184 |         // Close mobile sidebar when navigating to new chat
185 |         if (openMobile) {
186 |             setOpenMobile(false);
187 |         }
188 |         
189 |         // Use window.location for more reliable navigation
190 |         window.location.href = '/';
191 |     };
192 | 
193 |     const handleNavigateToChat = (chatId: string) => {
194 |         // Close mobile sidebar when navigating to a chat
195 |         if (openMobile) {
196 |             setOpenMobile(false);
197 |         }
198 |     };
199 | 
200 | 
201 | 
202 |     const handleDeleteChat = async (chatId: string, e: React.MouseEvent) => {
203 |         e.stopPropagation();
204 |         e.preventDefault();
205 | 
206 |         deleteChat(chatId);
207 |         
208 |         if (pathname === `/chat/${chatId}`) {
209 |             window.location.href = '/';
210 |         }
211 |     };
212 | 
213 |     const activeServersCount = selectedMcpServers.length;
214 | 
215 |     if (isLoading) {
216 |         return (
217 |             <>
218 |                 <Sidebar className="shadow-sm bg-background/80 dark:bg-background/40 backdrop-blur-md" collapsible="icon">
219 |                     <SidebarHeader className="p-4 border-b border-border/40 h-[72px]">
220 |                         <div className="flex items-center justify-between">
221 |                             <Link href="/" className={`flex items-center gap-2 hover:opacity-80 transition-opacity ${isLayoutCollapsed ? "justify-center w-full" : ""}`}>
222 |                                 <div className={`flex items-center justify-center rounded-full bg-primary ${isLayoutCollapsed ? 'h-6 w-6 flex-shrink-0' : 'h-8 w-8'}`}>
223 |                                     <Image src="/logo.png" alt="ChatLima logo" width={32} height={32} className={`${isLayoutCollapsed ? 'h-4 w-4' : 'h-6 w-6'}`} />
224 |                                 </div>
225 |                                 {!isLayoutCollapsed && (
226 |                                     <div className="font-semibold text-lg text-foreground/90">ChatLima</div>
227 |                                 )}
228 |                             </Link>
229 |                         </div>
230 |                     </SidebarHeader>
231 |                 
232 |                 <SidebarContent className="flex flex-col h-[calc(100vh-8rem)]">
233 |                     <SidebarGroup className="flex-1 min-h-0">
234 |                         <SidebarGroupLabel className={cn(
235 |                             "px-4 text-xs font-medium text-muted-foreground/80 uppercase tracking-wider",
236 |                             isLayoutCollapsed ? "sr-only" : ""
237 |                         )}>
238 |                             Chats
239 |                         </SidebarGroupLabel>
240 |                         {!isLayoutCollapsed && (
241 |                             <div className="px-3 pt-1 pb-2 border-b border-border/40">
242 |                                 <Skeleton className="h-9 w-full mb-2" />
243 |                                 <Skeleton className="h-9 w-full" />
244 |                             </div>
245 |                         )}
246 |                         <SidebarGroupContent className={cn(
247 |                             "overflow-y-auto pt-1",
248 |                             isLayoutCollapsed ? "overflow-x-hidden overflow-y-hidden" : ""
249 |                         )}>
250 |                             <SidebarMenu>{renderChatSkeletons()}</SidebarMenu>
251 |                         </SidebarGroupContent>
252 |                     </SidebarGroup>
253 |                     
254 |                     <div className="relative my-0">
255 |                         <div className="absolute inset-x-0">
256 |                             <Separator className="w-full h-px bg-border/40" />
257 |                         </div>
258 |                     </div>
259 |                     
260 |                     <SidebarGroup className="flex-shrink-0">
261 |                         <SidebarGroupContent className="pt-2">
262 |                            <SidebarMenu>
263 |                                 <SidebarMenuItem>
264 |                                     <div className={cn(
265 |                                         "w-full flex items-center gap-2 px-3 py-2 rounded-md"
266 |                                     )}>
267 |                                         <Skeleton className="h-4 w-4 rounded-md flex-shrink-0" />
268 |                                         {!isLayoutCollapsed && (
269 |                                             <>
270 |                                                 <Skeleton className="h-4 flex-grow max-w-[80px]" />
271 |                                                 <Skeleton className="h-3 w-3 rounded-md ml-auto" />
272 |                                             </>
273 |                                         )}
274 |                                     </div>
275 |                                 </SidebarMenuItem>
276 |                            </SidebarMenu>
277 |                         </SidebarGroupContent>
278 |                     </SidebarGroup>
279 |                 </SidebarContent>
280 |                 
281 |                 <SidebarFooter className="flex flex-col gap-2 p-3 border-t border-border/40">
282 |                     <Skeleton className="h-10 w-full" />
283 |                     <Skeleton className="h-10 w-full" />
284 |                     
285 |                     <div className={cn(
286 |                         "flex items-center justify-center py-2",
287 |                         isLayoutCollapsed ? "flex-col gap-2" : "gap-3"
288 |                     )}>
289 |                         <Skeleton className="h-8 w-8 rounded-md" />
290 |                         <Skeleton className="h-8 w-8 rounded-md" />
291 |                     </div>
292 |                 </SidebarFooter>
293 |             </Sidebar>
294 |             </>
295 |         );
296 |     }
297 | 
298 |     const displayUserId = userId ?? '...';
299 |     const isUserAuthenticated = !!authenticatedUserId;
300 | 
301 |     return (
302 |         <>
303 |             <Sidebar className="shadow-sm bg-background/80 dark:bg-background/40 backdrop-blur-md" collapsible="icon">
304 |                 <SidebarHeader className="p-4 border-b border-border/40 h-[72px]">
305 |                     <div className="flex items-center justify-between">
306 |                         <Link href="/" className={`flex items-center gap-2 hover:opacity-80 transition-opacity ${isLayoutCollapsed ? "justify-center w-full" : ""}`}>
307 |                             <div className={`flex items-center justify-center rounded-full bg-primary ${isLayoutCollapsed ? 'h-6 w-6 flex-shrink-0' : 'h-8 w-8'}`}>
308 |                                 <Image src="/logo.png" alt="ChatLima logo" width={32} height={32} className={`${isLayoutCollapsed ? 'h-4 w-4' : 'h-6 w-6'}`} />
309 |                             </div>
310 |                             {!isLayoutCollapsed && (
311 |                                 <div className="font-semibold text-lg text-foreground/90">ChatLima</div>
312 |                             )}
313 |                         </Link>
314 | 
315 |                     </div>
316 |                 </SidebarHeader>
317 |                 
318 |                 <SidebarContent className="flex flex-col h-[calc(100vh-8rem)]">
319 |                     <SidebarGroup className="flex-1 min-h-0">
320 |                         <SidebarGroupLabel className={cn(
321 |                             "px-4 text-xs font-medium text-muted-foreground/80 uppercase tracking-wider",
322 |                             isLayoutCollapsed ? "sr-only" : ""
323 |                         )}>
324 |                             Chats
325 |                         </SidebarGroupLabel>
326 |                         <ChatList
327 |                             chats={chats ?? []}
328 |                             isLoading={isChatsLoading} 
329 |                             isCollapsed={isLayoutCollapsed}
330 |                             isUpdatingChatTitle={isUpdatingChatTitle}
331 |                             onNewChat={handleNewChat}
332 |                             onDeleteChat={handleDeleteChat}
333 |                             onUpdateChatTitle={updateChatTitle}
334 |                             onNavigateToChat={handleNavigateToChat}
335 |                             onLoadMoreChats={loadMoreChats}
336 |                             hasMoreChats={hasMoreChats}
337 |                             isLoadingMore={isLoadingMore}
338 |                         />
339 |                     </SidebarGroup>
340 |                     
341 |                     <div className="relative my-0">
342 |                         <div className="absolute inset-x-0">
343 |                             <Separator className="w-full h-px bg-border/40" />
344 |                         </div>
345 |                     </div>
346 | 
347 |                     <SidebarGroup className="flex-shrink-0">
348 |                         <SidebarGroupContent className="pt-2">
349 |                            <SidebarMenu>
350 |                                 <SidebarMenuItem>
351 |                                     <DropdownMenu>
352 |                                         <DropdownMenuTrigger asChild>
353 |                                             <SidebarMenuButton
354 |                                                 className="w-full flex items-center gap-2 transition-all"
355 |                                                 tooltip={isCollapsed ? "Settings" : undefined}
356 |                                             >
357 |                                                 <Settings className="h-4 w-4 flex-shrink-0 text-muted-foreground" />
358 |                                                 {!isCollapsed && (
359 |                                                     <>
360 |                                                         <span className="flex-grow text-sm text-foreground/80 text-left">Settings</span>
361 |                                                         <ChevronsUpDown className="h-3 w-3 text-muted-foreground ml-auto" />
362 |                                                     </>
363 |                                                 )}
364 |                                             </SidebarMenuButton>
365 |                                         </DropdownMenuTrigger>
366 |                                         <DropdownMenuContent 
367 |                                             align="end" 
368 |                                             side={isCollapsed ? "right" : "bottom"} 
369 |                                             sideOffset={8} 
370 |                                             className="min-w-[200px]"
371 |                                         >
372 |                                             <DropdownMenuItem onClick={() => setMcpSettingsOpen(true)}>
373 |                                                 <ServerIcon className={cn(
374 |                                                     "h-4 w-4 mr-2",
375 |                                                     activeServersCount > 0 ? "text-primary" : "text-muted-foreground"
376 |                                                 )} />
377 |                                                 MCP Servers
378 |                                                 {activeServersCount > 0 && (
379 |                                                     <Badge 
380 |                                                         variant="secondary" 
381 |                                                         className="ml-auto text-[10px] px-1.5 py-0 h-5 bg-secondary/80"
382 |                                                     >
383 |                                                         {activeServersCount}
384 |                                                     </Badge>
385 |                                                 )}
386 |                                             </DropdownMenuItem>
387 |                                             <DropdownMenuItem onClick={() => setApiKeySettingsOpen(true)}>
388 |                                                 <Key className="h-4 w-4 mr-2 text-muted-foreground" />
389 |                                                 API Keys
390 |                                             </DropdownMenuItem>
391 |                                             <DropdownMenuItem onClick={() => setProviderHealthOpen(true)}>
392 |                                                 <Activity className="h-4 w-4 mr-2 text-muted-foreground" />
393 |                                                 Provider Health
394 |                                             </DropdownMenuItem>
395 |                                             {isMounted && webSearchEnabled && (
396 |                                                 <>
397 |                                                     <DropdownMenuSeparator />
398 |                                                     <DropdownMenuLabel className="text-xs">Web Search</DropdownMenuLabel>
399 |                                                     <DropdownMenuItem 
400 |                                                         onClick={() => setWebSearchContextSize('low')}
401 |                                                         className={cn(webSearchContextSize === 'low' && "bg-secondary")}
402 |                                                     >
403 |                                                         <Globe className="h-4 w-4 mr-2 text-muted-foreground" />
404 |                                                         Context: Low
405 |                                                         {webSearchContextSize === 'low' && <span className="ml-auto text-xs">✓</span>}
406 |                                                     </DropdownMenuItem>
407 |                                                     <DropdownMenuItem 
408 |                                                         onClick={() => setWebSearchContextSize('medium')}
409 |                                                         className={cn(webSearchContextSize === 'medium' && "bg-secondary")}
410 |                                                     >
411 |                                                         <Globe className="h-4 w-4 mr-2 text-muted-foreground" />
412 |                                                         Context: Medium
413 |                                                         {webSearchContextSize === 'medium' && <span className="ml-auto text-xs">✓</span>}
414 |                                                     </DropdownMenuItem>
415 |                                                     <DropdownMenuItem 
416 |                                                         onClick={() => setWebSearchContextSize('high')}
417 |                                                         className={cn(webSearchContextSize === 'high' && "bg-secondary")}
418 |                                                     >
419 |                                                         <Globe className="h-4 w-4 mr-2 text-muted-foreground" />
420 |                                                         Context: High
421 |                                                         {webSearchContextSize === 'high' && <span className="ml-auto text-xs">✓</span>}
422 |                                                     </DropdownMenuItem>
423 |                                                 </>
424 |                                             )}
425 |                                         </DropdownMenuContent>
426 |                                     </DropdownMenu>
427 |                                 </SidebarMenuItem>
428 |                            </SidebarMenu>
429 |                         </SidebarGroupContent>
430 |                     </SidebarGroup>
431 |                 </SidebarContent>
432 |                 
433 |                 <SidebarFooter className="flex flex-col gap-2 p-3 border-t border-border/40">
434 |                     
435 | 
436 |                     {isSessionLoading ? (
437 |                         <div className="flex items-center gap-2 px-3 py-2 mt-2">
438 |                             <Skeleton className="h-8 w-8 rounded-full" />
439 |                             {!isLayoutCollapsed && <Skeleton className="h-4 w-24" />}
440 |                         </div>
441 |                     ) : session?.user?.isAnonymous === true ? (
442 |                         <div className={cn(
443 |                             "flex items-center mt-2", 
444 |                             isLayoutCollapsed ? "justify-center px-1 py-2" : "px-3 py-2 gap-2" 
445 |                         )}>
446 |                             <SignInButton isCollapsed={isLayoutCollapsed} />
447 |                         </div>
448 |                     ) : (
449 |                         <div className={cn(
450 |                             "flex items-center mt-2", 
451 |                             isLayoutCollapsed ? "justify-center px-1 py-2" : "px-3 py-2" 
452 |                         )}>
453 |                             <UserAccountMenu />
454 |                         </div>
455 |                     )}
456 | 
457 |                     <div className={cn(
458 |                         "flex items-center justify-center py-2",
459 |                         isLayoutCollapsed ? "flex-col gap-2" : "gap-3"
460 |                     )}>
461 |                         <TooltipProvider>
462 |                             <Tooltip>
463 |                                 <TooltipTrigger asChild>
464 |                                     <Link
465 |                                         href="https://chatlima-docs.netlify.app/"
466 |                                         target="_blank"
467 |                                         rel="noopener noreferrer"
468 |                                         className="flex items-center justify-center w-8 h-8 text-muted-foreground/70 hover:text-muted-foreground transition-colors rounded-md hover:bg-secondary/50"
469 |                                     >
470 |                                         <BookOpen className="h-4 w-4" />
471 |                                     </Link>
472 |                                 </TooltipTrigger>
473 |                                 <TooltipContent side="top" sideOffset={5}>
474 |                                     Documentation
475 |                                 </TooltipContent>
476 |                             </Tooltip>
477 |                         </TooltipProvider>
478 | 
479 |                         <TooltipProvider>
480 |                             <Tooltip>
481 |                                 <TooltipTrigger asChild>
482 |                                     <Link 
483 |                                         href="https://github.com/brooksy4503/chatlima" 
484 |                                         target="_blank" 
485 |                                         rel="noopener noreferrer"
486 |                                         className="flex items-center justify-center w-8 h-8 text-muted-foreground/70 hover:text-muted-foreground transition-colors rounded-md hover:bg-secondary/50"
487 |                                     >
488 |                                         <Github className="h-4 w-4" />
489 |                                     </Link>
490 |                                 </TooltipTrigger>
491 |                                 <TooltipContent side="top" sideOffset={5}>
492 |                                     ChatLima on GitHub
493 |                                 </TooltipContent>
494 |                             </Tooltip>
495 |                         </TooltipProvider>
496 | 
497 |                         <ThemeToggle
498 |                             className="w-8 h-8 flex items-center justify-center text-muted-foreground/70 hover:text-muted-foreground transition-colors rounded-md hover:bg-secondary/50"
499 |                             showLabel={false}
500 |                         />
501 |                     </div>
502 | 
503 | 
504 |                 </SidebarFooter>
505 |             </Sidebar>
506 | 
507 |             <MCPServerManager
508 |                 servers={mcpServers}
509 |                 onServersChange={setMcpServers}
510 |                 selectedServers={selectedMcpServers}
511 |                 onSelectedServersChange={setSelectedMcpServers}
512 |                 open={mcpSettingsOpen}
513 |                 onOpenChange={setMcpSettingsOpen}
514 |             />
515 | 
516 |             <ApiKeyManager
517 |                 open={apiKeySettingsOpen}
518 |                 onOpenChange={setApiKeySettingsOpen}
519 |             />
520 | 
521 |             <Dialog open={providerHealthOpen} onOpenChange={setProviderHealthOpen}>
522 |                 <DialogContent className="max-w-[95vw] sm:max-w-xl lg:max-w-2xl max-h-[85vh] overflow-hidden flex flex-col p-4 sm:p-6">
[TRUNCATED]
```

components/chat.tsx
```
1 | "use client";
2 | 
3 | import { type modelID } from "@/ai/providers";
4 | import { Message, useChat } from "@ai-sdk/react";
5 | import { useState, useEffect, useMemo, useCallback, useRef } from "react";
6 | import { Textarea } from "./textarea";
7 | import { ProjectOverview } from "./project-overview";
8 | import { Messages } from "./messages";
9 | import { toast } from "sonner";
10 | import { useRouter, useParams } from "next/navigation";
11 | import { useQuery, useQueryClient } from "@tanstack/react-query";
12 | import { convertToUIMessages } from "@/lib/chat-store";
13 | import { type Message as DBMessage } from "@/lib/db/schema";
14 | import { nanoid } from "nanoid";
15 | import { useModel } from "@/lib/context/model-context";
16 | import { Sparkles } from "lucide-react";
17 | import { usePresets } from "@/lib/context/preset-context";
18 | import { useMCP } from "@/lib/context/mcp-context";
19 | import { useAuth } from "@/hooks/useAuth";
20 | import { MCPServerManager } from "./mcp-server-manager";
21 | import { useWebSearch } from "@/lib/context/web-search-context";
22 | import { ErrorBoundary } from "./error-boundary";
23 | import { useCredits } from "@/hooks/useCredits";
24 | import type { ImageAttachment } from "@/lib/types";
25 | import { useModels } from "@/hooks/use-models";
26 | 
27 | // Type for chat data from DB
28 | interface ChatData {
29 |   id: string;
30 |   messages: DBMessage[];
31 |   createdAt: string;
32 |   updatedAt: string;
33 | }
34 | 
35 | export default function Chat() {
36 |   const router = useRouter();
37 |   const params = useParams();
38 |   const chatId = params?.id as string | undefined;
39 |   const queryClient = useQueryClient();
40 |   const { session, isPending: isSessionLoading } = useAuth();
41 |   const sessionUpdateRef = useRef(false);
42 |   
43 |   const { 
44 |     webSearchEnabled, 
45 |     setWebSearchEnabled, 
46 |     webSearchContextSize, 
47 |     setWebSearchContextSize 
48 |   } = useWebSearch();
49 |   
50 |   const { mcpServersForApi } = useMCP();
51 |   
52 |   const { selectedModel, setSelectedModel } = useModel();
53 |   const { activePreset } = usePresets();
54 |   const [userId, setUserId] = useState<string | null>(null);
55 |   const [generatedChatId, setGeneratedChatId] = useState<string>("");
56 |   const [isMounted, setIsMounted] = useState(false);
57 |   const [selectedImages, setSelectedImages] = useState<ImageAttachment[]>([]);
58 |   const [hideImagesInUI, setHideImagesInUI] = useState(false);
59 |   const [isErrorRecoveryNeeded, setIsErrorRecoveryNeeded] = useState(false);
60 |   const [lastErrorTime, setLastErrorTime] = useState<number | null>(null);
61 |   const [lastStreamingActivity, setLastStreamingActivity] = useState<number | null>(null);
62 |   const [streamingStartTime, setStreamingStartTime] = useState<number | null>(null);
63 |   const [lastToastId, setLastToastId] = useState<string | null>(null);
64 |   const [lastErrorMessage, setLastErrorMessage] = useState<string>("");
65 |   const [lastToastTimestamp, setLastToastTimestamp] = useState<number>(0);
66 | 
67 |   useEffect(() => {
68 |     setIsMounted(true);
69 |   }, []);
70 | 
71 |   useEffect(() => {
72 |     if (isMounted && !isSessionLoading && !sessionUpdateRef.current) {
73 |       sessionUpdateRef.current = true;
74 |       if (session?.user?.id) {
75 |         setUserId(session.user.id);
76 |       } else {
77 |         setUserId(null);
78 |       }
79 |       // Reset after a brief delay to allow for proper session handling
80 |       setTimeout(() => {
81 |         sessionUpdateRef.current = false;
82 |       }, 50);
83 |     }
84 |   }, [isMounted, isSessionLoading, session]);
85 |   
86 |   useEffect(() => {
87 |     // Only redirect if we're sure the session is actually gone and not just loading
88 |     if (isMounted && !isSessionLoading && !session && chatId && params?.id && !sessionUpdateRef.current) {
89 |       console.log("User logged out while on chat page, redirecting to home.");
90 |       toast.info("You have been logged out.");
91 |       router.push('/'); 
92 |     }
93 |   }, [isMounted, session, isSessionLoading, chatId, router, params]);
94 |   
95 |   useEffect(() => {
96 |     if (!chatId) {
97 |       setGeneratedChatId(nanoid());
98 |     }
99 |   }, [chatId]);
100 | 
101 |   // Reset error state when navigating to a new chat
102 |   useEffect(() => {
103 |     if (!chatId) {
104 |       // Reset any error recovery state when starting fresh
105 |       setIsErrorRecoveryNeeded(false);
106 |       setLastErrorTime(null);
107 |       setHideImagesInUI(false);
108 |       setSelectedImages([]);
109 |       
110 |       // Clear any lingering toast state
111 |       if (lastToastId) {
112 |         toast.dismiss(lastToastId);
113 |         setLastToastId(null);
114 |       }
115 |       setLastErrorMessage("");
116 |       setLastToastTimestamp(0);
117 |       
118 |       // Reset streaming state
119 |       setStreamingStartTime(null);
120 |       setLastStreamingActivity(null);
121 |     }
122 |   }, [chatId, lastToastId]);
123 | 
124 |   // Error recovery mechanism - reset chat state when errors occur
125 |   // Note: This will be moved after the useChat hook is defined
126 |   
127 |   const { data: chatData, isLoading: isLoadingChat } = useQuery({
128 |     queryKey: ['chat', chatId],
129 |     queryFn: async ({ queryKey }) => {
130 |       const [_, chatId] = queryKey;
131 |       if (!chatId) return null;
132 |       
133 |       try {
134 |         const response = await fetch(`/api/chats/${chatId}`);
135 |         
136 |         if (!response.ok) {
137 |           throw new Error('Failed to load chat');
138 |         }
139 |         
140 |         const data = await response.json();
141 |         return data as ChatData;
142 |       } catch (error) {
143 |         console.error('Error loading chat history:', error);
144 |         toast.error('Failed to load chat history');
145 |         throw error;
146 |       }
147 |     },
148 |     enabled: 
149 |       !!chatId && 
150 |       !(isMounted && !isSessionLoading && !session && chatId && params?.id),
151 |     retry: 1,
152 |     staleTime: 1000 * 60 * 5,
153 |     refetchOnWindowFocus: false
154 |   });
155 |   
156 |   const initialMessages = useMemo(() => {
157 |     if (!chatData || !chatData.messages || chatData.messages.length === 0) {
158 |       return [];
159 |     }
160 |     
161 |     const uiMessages = convertToUIMessages(chatData.messages);
162 |     return uiMessages.map(msg => ({
163 |       id: msg.id,
164 |       role: msg.role as Message['role'],
165 |       content: msg.content,
166 |       parts: msg.parts,
167 |       hasWebSearch: msg.hasWebSearch,
168 |     } as Message & { hasWebSearch?: boolean }));
169 |   }, [chatData]);
170 |   
171 |   // Function to get API keys from localStorage
172 |   const getClientApiKeys = () => {
173 |     if (typeof window === 'undefined') return {};
174 |     
175 |     const apiKeys: Record<string, string> = {};
176 |     const keyNames = [
177 |       'OPENAI_API_KEY',
178 |       'ANTHROPIC_API_KEY', 
179 |       'GROQ_API_KEY',
180 |       'XAI_API_KEY',
181 |       'OPENROUTER_API_KEY',
182 |       'REQUESTY_API_KEY'
183 |     ];
184 |     
185 |     keyNames.forEach(keyName => {
186 |       const value = localStorage.getItem(keyName);
187 |       if (value) {
188 |         apiKeys[keyName] = value;
189 |       }
190 |     });
191 |     
192 |     return apiKeys;
193 |   };
194 | 
195 |   // Check if current model supports vision/images - use preset model if active
196 |   const effectiveModel = activePreset?.modelId || selectedModel;
197 |   const { models } = useModels();
198 |   const modelSupportsVision = useMemo(() => {
199 |     const modelInfo = models.find(model => model.id === effectiveModel);
200 |     return modelInfo?.vision === true;
201 |   }, [models, effectiveModel]);
202 | 
203 |   // Handle image selection
204 |   const handleImageSelect = useCallback((newImages: ImageAttachment[]) => {
205 |     console.log('[DEBUG] handleImageSelect called with:', newImages.length, 'images');
206 |     console.log('[DEBUG] New images details:', newImages.map(img => ({
207 |       filename: img.metadata.filename,
208 |       size: img.metadata.size,
209 |       mimeType: img.metadata.mimeType,
210 |       detail: img.detail,
211 |       dataUrlLength: img.dataUrl.length
212 |     })));
213 |     
214 |     setSelectedImages(prev => {
215 |       const updated = [...prev, ...newImages];
216 |       console.log('[DEBUG] Updated selectedImages count:', updated.length);
217 |       return updated;
218 |     });
219 |   }, []);
220 | 
221 |   // Handle image removal
222 |   const handleImageRemove = useCallback((index: number) => {
223 |     console.log('[DEBUG] handleImageRemove called for index:', index);
224 |     setSelectedImages(prev => {
225 |       const updated = prev.filter((_, i) => i !== index);
226 |       console.log('[DEBUG] After removal, selectedImages count:', updated.length);
227 |       return updated;
228 |     });
229 |   }, []);
230 | 
231 |   // Clear images after successful submission
232 |   const clearImages = useCallback(() => {
233 |     console.log('[DEBUG] clearImages called');
234 |     setSelectedImages([]);
235 |   }, []);
236 | 
237 |   // Note: No longer creating attachments array since we use message parts directly
238 | 
239 |   const { messages, input, handleInputChange, handleSubmit, append, status, stop: originalStop } =
240 |     useChat({
241 |       id: chatId || generatedChatId,
242 |       initialMessages,
243 |       maxSteps: 20,
244 |       body: {
245 |         selectedModel: activePreset?.modelId || selectedModel,
246 |         mcpServers: mcpServersForApi,
247 |         chatId: chatId || generatedChatId,
248 |         webSearch: {
249 |           enabled: activePreset?.webSearchEnabled ?? webSearchEnabled,
250 |           contextSize: activePreset?.webSearchContextSize || webSearchContextSize,
251 |         },
252 |         apiKeys: getClientApiKeys(),
253 |         // Only send attachments for text-only messages (handleSubmit)
254 |         // Don't send when using append() since images are already in message parts
255 |         attachments: [],
256 |         // Include preset parameters
257 |         temperature: activePreset?.temperature,
258 |         maxTokens: activePreset?.maxTokens,
259 |         systemInstruction: activePreset?.systemInstruction
260 |       },
261 |       experimental_throttle: 500,
262 |       onFinish: (message) => {
263 |         // Clear images and reset UI state after successful submission
264 |         clearImages();
265 |         setHideImagesInUI(false);
266 |         
267 |         queryClient.invalidateQueries({ queryKey: ['chats'] });
268 |         queryClient.invalidateQueries({ queryKey: ['chat', chatId || generatedChatId] });
269 |         if (!chatId && generatedChatId) {
270 |           if (window.location.pathname !== `/chat/${generatedChatId}`) {
271 |              router.push(`/chat/${generatedChatId}`, { scroll: false }); 
272 |           }
273 |         }
274 |       },
275 |       onError: (error) => {
276 |         let errorMessage = "An error occurred, please try again later."; // Default message
277 |         let errorCode = "UNKNOWN_ERROR";
278 |         let errorDetails = "No additional details available.";
279 | 
280 |         try {
281 |           // The error.message from the Vercel AI SDK is now expected to be a JSON string.
282 |           const parsedBody = JSON.parse(error.message);
283 | 
284 |           // Check for the structure from getErrorMessage (nested error object)
285 |           if (parsedBody.error && typeof parsedBody.error === 'object' && parsedBody.error.code) {
286 |             const apiErrorObject = parsedBody.error;
287 |             errorMessage = apiErrorObject.message || errorMessage;
288 |             errorCode = apiErrorObject.code || errorCode;
289 |             errorDetails = apiErrorObject.details || errorDetails;
290 |           } 
291 |           // Check for the flatter structure (e.g., from direct 429 response)
292 |           else if (typeof parsedBody.error === 'string' && parsedBody.message) {
293 |             errorMessage = parsedBody.message; // Use the detailed message from the API
294 |             if (parsedBody.error === "Message limit reached") {
295 |               errorCode = "MESSAGE_LIMIT_REACHED";
296 |               // Optionally, capture other details like limit and remaining
297 |               const details: any = {};
298 |               if (typeof parsedBody.limit !== 'undefined') details.limit = parsedBody.limit;
299 |               if (typeof parsedBody.remaining !== 'undefined') details.remaining = parsedBody.remaining;
300 |               if (Object.keys(details).length > 0) errorDetails = JSON.stringify(details);
301 | 
302 |             } else {
303 |               // For other flat errors, we might not have a specific code yet
304 |               // but we have the detailed message.
305 |               // errorCode remains UNKNOWN_ERROR or could be set to a generic API_ERROR
306 |             }
307 |           }
308 |           // Fallback for other JSON structures or if parsing was incomplete
309 |           else if (parsedBody.message) {
310 |             errorMessage = parsedBody.message;
311 |           }
312 |            else {
313 |             // If parsing was successful but structure is unrecognized
314 |             // and errorMessage hasn't been updated from a recognized structure.
315 |              if (error.message && error.message.length > 0 && errorMessage === "An error occurred, please try again later.") {
316 |                  errorMessage = error.message; // use raw JSON string if no better message found
317 |             }
318 |             console.warn("Received JSON error message with unrecognized structure:", error.message);
319 |           }
320 |         } catch (e) {
321 |           // If parsing fails, it means error.message was not a JSON string.
322 |           // Use the raw error.message if available.
323 |           if (error.message && error.message.length > 0) {
324 |             errorMessage = error.message;
325 |           }
326 |           console.warn("Failed to parse error message as JSON:", e, "Raw error message:", error.message);
327 |         }
328 | 
329 |         // Reset UI state on error so images reappear
330 |         setHideImagesInUI(false);
331 | 
332 |         // Force reset the chat state to allow new messages
333 |         setIsErrorRecoveryNeeded(true);
334 |         setLastErrorTime(Date.now());
335 | 
336 |         // Log the detailed error for debugging
337 |         console.error(`Chat Error [Code: ${errorCode}]: ${errorMessage}`, { details: errorDetails, originalError: error });
338 |         console.log(`[Toast Debug] Error handler triggered with message: "${errorMessage}"`);
339 |         console.log(`[Toast Debug] Previous message: "${lastErrorMessage}", Time since last: ${Date.now() - lastToastTimestamp}ms`);
340 | 
341 |         // Display user-friendly toast messages based on error code
342 |         let toastMessage = errorMessage;
343 |         switch (errorCode) {
344 |           case "AUTHENTICATION_REQUIRED":
345 |             toastMessage = "Authentication required. Please log in to continue.";
346 |             // Optionally, redirect to login or prompt user
347 |             // router.push('/login'); 
348 |             break;
349 |           case "MESSAGE_LIMIT_REACHED":
350 |             // The message from the backend (now correctly assigned to errorMessage) is descriptive.
351 |             // toastMessage will use this errorMessage.
352 |             break;
353 |           case "INSUFFICIENT_CREDITS":
354 |             toastMessage = "You have insufficient credits. Please top up your account.";
355 |             break;
356 |           case "RATE_LIMIT_EXCEEDED":
357 |             toastMessage = "Too many requests. Please wait a moment and try again.";
358 |             break;
359 |           case "LLM_PROVIDER_ERROR":
360 |             toastMessage = "The AI model provider is experiencing issues. Please try a different model or try again later.";
361 |             break;
362 |           case "MODEL_INIT_FAILED":
363 |             toastMessage = "Failed to initialize the selected AI model. Please try another model.";
364 |             break;
365 |           case "STREAM_ERROR": // Generic stream error from backend
366 |             toastMessage = "A problem occurred while getting the response. Please try again.";
367 |             break;
368 |           // Add more cases as new error codes are defined in the backend
369 |           default:
370 |             // Check for specific model compatibility errors
371 |             if (errorMessage.includes("does not currently support") && 
372 |                 (errorMessage.includes("tool_choice") || errorMessage.includes("tools"))) {
373 |               toastMessage = "This model doesn't support the advanced features required for this request. Please try a different model.";
374 |             }
375 |             // For other UNKNOWN_ERROR or unhandled codes, use the errorMessage as is (or a generic one)
376 |             else if (!errorMessage || errorMessage === "An error occurred, please try again later.") {
377 |                 toastMessage = "An unexpected issue occurred. Please try again.";
378 |             }
379 |             break;
380 |         }
381 | 
382 |         // Debounce error toasts to prevent rapid-fire messages
383 |         const now = Date.now();
384 |         const timeSinceLastToast = now - lastToastTimestamp;
385 |         const isSameMessage = toastMessage === lastErrorMessage;
386 |         const tooSoon = timeSinceLastToast < (isSameMessage ? 5000 : 2000); // 5s for same message, 2s for different
387 | 
388 |         if (tooSoon) {
389 |           console.log(`Suppressing duplicate error toast: "${toastMessage}" (${timeSinceLastToast}ms ago)`);
390 |           return;
391 |         }
392 | 
393 |         // Dismiss any previous error toasts
394 |         if (lastToastId) {
395 |           toast.dismiss(lastToastId);
396 |         }
397 | 
398 |         // Show the error toast
399 |         const toastId = toast.error(
400 |           toastMessage,
401 |           { 
402 |             position: "top-center", 
403 |             richColors: true,
404 |             description: errorCode !== "UNKNOWN_ERROR" && errorMessage !== toastMessage ? errorMessage : undefined,
405 |             duration: 8000 // Longer duration for errors
406 |           }
407 |         );
408 |         
409 |         // Update tracking state
410 |         setLastToastId(String(toastId));
411 |         setLastErrorMessage(toastMessage);
412 |         setLastToastTimestamp(now);
413 |       },
414 |     });
415 | 
416 |   // Custom stop function that handles both stopping the stream and refreshing data
417 |   const stop = useCallback(() => {
418 |     console.log('Stopping stream and refreshing chat data...');
419 |     
420 |     // Call the original stop function to abort the stream
421 |     originalStop();
422 |     
423 |     // Give the server a moment to process the onStop callback and save data
424 |     setTimeout(() => {
425 |       // Refresh the chat data since the server-side onStop handler saves the current state
426 |       queryClient.invalidateQueries({ queryKey: ['chats'] });
427 |       queryClient.invalidateQueries({ queryKey: ['chat', chatId || generatedChatId] });
428 |       
429 |       // If this is a new chat that was just created, navigate to it
430 |       if (!chatId && generatedChatId) {
431 |         if (window.location.pathname !== `/chat/${generatedChatId}`) {
432 |            router.push(`/chat/${generatedChatId}`, { scroll: false }); 
433 |         }
434 |       }
435 |     }, 100); // Small delay to ensure server-side processing completes
436 |   }, [originalStop, queryClient, chatId, generatedChatId, router]);
437 | 
438 |   // Error recovery mechanism - reset chat state when errors occur
439 |   useEffect(() => {
440 |     if (isErrorRecoveryNeeded && lastErrorTime) {
441 |       const resetTimeout = setTimeout(() => {
442 |         // Force stop the current stream/request to reset useChat internal state
443 |         originalStop();
444 |         
445 |         // If we're in a new chat (no chatId), regenerate the chatId to force useChat to reset completely
446 |         if (!chatId) {
447 |           console.log('Regenerating chat ID to ensure fresh useChat state after error');
448 |           setGeneratedChatId(nanoid());
449 |         }
450 |         
451 |         // Reset error recovery state
452 |         setIsErrorRecoveryNeeded(false);
453 |         setLastErrorTime(null);
454 |         
455 |         // Clear any lingering toast IDs and tracking state
456 |         setLastToastId(null);
457 |         setLastErrorMessage("");
458 |         setLastToastTimestamp(0);
459 |         
460 |         console.log('Chat state reset after error - ready for new messages');
461 |       }, 500); // Short delay to allow error handling to complete
462 | 
463 |       return () => clearTimeout(resetTimeout);
464 |     }
465 |   }, [isErrorRecoveryNeeded, lastErrorTime, originalStop, chatId]);
466 | 
467 |   // Track streaming start/stop and activity
468 |   useEffect(() => {
469 |     if (status === "streaming") {
470 |       if (!streamingStartTime) {
471 |         setStreamingStartTime(Date.now());
472 |       }
473 |       
474 |       if (messages.length > 0) {
475 |         const lastMessage = messages[messages.length - 1];
476 |         if (lastMessage.role === 'assistant' && lastMessage.content) {
477 |           setLastStreamingActivity(Date.now());
478 |         }
479 |       }
480 |     } else {
481 |       setStreamingStartTime(null);
482 |     }
483 |   }, [status, messages, streamingStartTime]);
484 | 
485 |   // Intelligent stuck detection: only trigger if no streaming activity for extended period
486 |   useEffect(() => {
487 |     if (status === "streaming" || status === "submitted") {
488 |       // Set initial activity time when streaming starts
489 |       if (!lastStreamingActivity) {
490 |         setLastStreamingActivity(Date.now());
491 |       }
492 | 
493 |       const stuckTimeout = setTimeout(() => {
494 |         const now = Date.now();
495 |         const timeSinceLastActivity = now - (lastStreamingActivity || now);
496 |         
497 |                  // Only consider stuck if no activity for 2 minutes AND status hasn't changed
498 |          if (timeSinceLastActivity > 120000 && (status === "streaming" || status === "submitted")) {
499 |            console.warn('Chat appears stuck - no streaming activity for 2 minutes');
500 |            
[TRUNCATED]
```

components/checkout-button.tsx
```
1 | 'use client';
2 | 
3 | import { useAuth } from '@/hooks/useAuth';
4 | import { Button } from '@/components/ui/button';
5 | import { useRouter } from 'next/navigation';
6 | import { CreditCard } from 'lucide-react';
7 | 
8 | export const CheckoutButton = () => {
9 |   const { user, isAnonymous, isAuthenticated } = useAuth();
10 |   const router = useRouter();
11 | 
12 |   const handleCheckout = () => {
13 |     if (isAnonymous || !isAuthenticated) {
14 |       // Guide anonymous users to sign in first
15 |       router.push('/api/auth/sign-in/google');
16 |     } else {
17 |       // Redirect authenticated users to the Polar checkout page
18 |       // The slug 'ai-usage' must match the one defined in lib/auth.ts
19 |       window.location.href = '/api/auth/checkout/ai-usage';
20 |     }
21 |   };
22 | 
23 |   return (
24 |     <Button onClick={handleCheckout} className="w-full">
25 |       <CreditCard className="mr-2 h-4 w-4" />
26 |       {isAnonymous || !isAuthenticated ? 'Sign In to Purchase Credits' : 'Purchase More Credits'}
27 |     </Button>
28 |   );
29 | }; 
```

components/citation.tsx
```
1 | "use client";
2 | 
3 | import { useState } from "react";
4 | import { motion, AnimatePresence } from "framer-motion";
5 | import { cn } from "@/lib/utils";
6 | import { ExternalLinkIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react";
7 | 
8 | interface Citation {
9 |   url: string;
10 |   title: string;
11 |   content?: string;
12 |   startIndex: number;
13 |   endIndex: number;
14 | }
15 | 
16 | interface CitationProps {
17 |   citations: Citation[];
18 | }
19 | 
20 | export function Citations({ citations }: CitationProps) {
21 |   const [isExpanded, setIsExpanded] = useState(false);
22 | 
23 |   if (!citations?.length) return null;
24 | 
25 |   return (
26 |     <div className="mt-2">
27 |       <button
28 |         onClick={() => setIsExpanded(!isExpanded)}
29 |         className={cn(
30 |           "flex items-center gap-1.5 text-xs text-muted-foreground/70",
31 |           "hover:text-muted-foreground transition-colors"
32 |         )}
33 |       >
34 |         {isExpanded ? <ChevronUpIcon size={14} /> : <ChevronDownIcon size={14} />}
35 |         <span>{citations.length} citation{citations.length > 1 ? 's' : ''}</span>
36 |       </button>
37 | 
38 |       <AnimatePresence initial={false}>
39 |         {isExpanded && (
40 |           <motion.div
41 |             className="mt-2 space-y-2"
42 |             initial={{ height: 0, opacity: 0 }}
43 |             animate={{ height: "auto", opacity: 1 }}
44 |             exit={{ height: 0, opacity: 0 }}
45 |             transition={{ duration: 0.2, ease: "easeInOut" }}
46 |           >
47 |             {citations.map((citation, index) => (
48 |               <div
49 |                 key={index}
50 |                 className="text-sm border border-border/30 rounded-lg p-3 bg-muted/10"
51 |               >
52 |                 <div className="flex items-start justify-between gap-2">
53 |                   <a
54 |                     href={citation.url}
55 |                     target="_blank"
56 |                     rel="noopener noreferrer"
57 |                     className="text-primary hover:underline flex items-center gap-1"
58 |                   >
59 |                     {citation.title}
60 |                     <ExternalLinkIcon size={12} className="inline" />
61 |                   </a>
62 |                 </div>
63 |                 {citation.content && (
64 |                   <p className="mt-1.5 text-xs text-muted-foreground line-clamp-3">
65 |                     {citation.content}
66 |                   </p>
67 |                 )}
68 |               </div>
69 |             ))}
70 |           </motion.div>
71 |         )}
72 |       </AnimatePresence>
73 |     </div>
74 |   );
75 | } 
```

components/copy-button.tsx
```
1 | import { CheckIcon, CopyIcon } from "lucide-react";
2 | import { cn } from "@/lib/utils";
3 | import { useCopy } from "@/lib/hooks/use-copy";
4 | import { Button } from "./ui/button";
5 | 
6 | interface CopyButtonProps {
7 |   text: string;
8 |   className?: string;
9 | }
10 | 
11 | export function CopyButton({ text, className }: CopyButtonProps) {
12 |   const { copied, copy } = useCopy();
13 | 
14 |   return (
15 |     <Button
16 |       variant="ghost"
17 |       size="sm"
18 |       className={cn(
19 |         "transition-opacity opacity-0 group-hover/message:opacity-100 gap-1.5",
20 |         // Always visible on touch devices (mobile) where hover doesn't work
21 |         "sm:opacity-0 sm:group-hover/message:opacity-100 opacity-100",
22 |         className
23 |       )}
24 |       onClick={() => copy(text)}
25 |       title="Copy to clipboard"
26 |     >
27 |       {copied ? (
28 |         <>
29 |           <CheckIcon className="h-4 w-4" />
30 |           <span className="text-xs">Copied!</span>
31 |         </>
32 |       ) : (
33 |         <>
34 |           <CopyIcon className="h-4 w-4" />
35 |           <span className="text-xs">Copy</span>
36 |         </>
37 |       )}
38 |     </Button>
39 |   );
40 | } 
```

components/deploy-button.tsx
```
1 | import Link from "next/link";
2 | 
3 | export const DeployButton = () => (
4 |   <Link
5 |     href={`https://vercel.com/new/clone?project-name=Vercel+x+xAI+Chatbot&repository-name=ai-sdk-starter-xai&repository-url=https%3A%2F%2Fgithub.com%2Fvercel-labs%2Fai-sdk-starter-xai&demo-title=Vercel+x+xAI+Chatbot&demo-url=https%3A%2F%2Fai-sdk-starter-xai.labs.vercel.dev%2F&demo-description=A+simple+chatbot+application+built+with+Next.js+that+uses+xAI+via+the+AI+SDK+and+the+Vercel+Marketplace&products=%5B%7B%22type%22:%22integration%22,%22protocol%22:%22ai%22,%22productSlug%22:%22grok%22,%22integrationSlug%22:%22xai%22%7D%5D`}
6 |     target="_blank"
7 |     rel="noopener noreferrer"
8 |     className="inline-flex items-center gap-2 ml-2 bg-black text-white text-sm px-3 py-1.5 rounded-md hover:bg-zinc-900 dark:bg-white dark:text-black dark:hover:bg-zinc-100"
9 |   >
10 |     <svg
11 |       data-testid="geist-icon"
12 |       height={14}
13 |       strokeLinejoin="round"
14 |       viewBox="0 0 16 16"
15 |       width={14}
16 |       style={{ color: "currentcolor" }}
17 |     >
18 |       <path
19 |         fillRule="evenodd"
20 |         clipRule="evenodd"
21 |         d="M8 1L16 15H0L8 1Z"
22 |         fill="currentColor"
23 |       />
24 |     </svg>
25 |     Deploy
26 |   </Link>
27 | );
```

components/error-boundary.tsx
```
1 | "use client";
2 | 
3 | import React from 'react';
4 | import { toast } from 'sonner';
5 | import { RefreshCw, AlertCircle, Home } from 'lucide-react';
6 | import { useRouter } from 'next/navigation';
7 | 
8 | interface ErrorBoundaryState {
9 |   hasError: boolean;
10 |   error: Error | null;
11 |   errorInfo: React.ErrorInfo | null;
12 |   errorId: string;
13 | }
14 | 
15 | interface ErrorBoundaryProps {
16 |   children: React.ReactNode;
17 |   fallback?: React.ComponentType<{
18 |     error: Error;
19 |     errorInfo: React.ErrorInfo;
20 |     resetError: () => void;
21 |     errorId: string;
22 |   }>;
23 |   onError?: (error: Error, errorInfo: React.ErrorInfo) => void;
24 | }
25 | 
26 | export class ErrorBoundary extends React.Component<ErrorBoundaryProps, ErrorBoundaryState> {
27 |   private resetTimeoutId: number | null = null;
28 | 
29 |   constructor(props: ErrorBoundaryProps) {
30 |     super(props);
31 |     this.state = {
32 |       hasError: false,
33 |       error: null,
34 |       errorInfo: null,
35 |       errorId: ''
36 |     };
37 |   }
38 | 
39 |   static getDerivedStateFromError(error: Error): Partial<ErrorBoundaryState> {
40 |     // Generate unique error ID for tracking
41 |     const errorId = `error_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
42 |     
43 |     return {
44 |       hasError: true,
45 |       error,
46 |       errorId
47 |     };
48 |   }
49 | 
50 |   componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
51 |     console.error('ErrorBoundary caught an error:', error, errorInfo);
52 |     
53 |     this.setState({
54 |       error,
55 |       errorInfo
56 |     });
57 | 
58 |     // Call custom error handler if provided
59 |     if (this.props.onError) {
60 |       this.props.onError(error, errorInfo);
61 |     }
62 | 
63 |     // Note: Not showing toast here to avoid duplicate error messages
64 |     // The chat component's error handling already shows appropriate toasts
65 | 
66 |     // Attempt auto-recovery after 5 seconds
67 |     this.resetTimeoutId = window.setTimeout(() => {
68 |       this.resetError();
69 |     }, 5000);
70 |   }
71 | 
72 |   componentWillUnmount() {
73 |     if (this.resetTimeoutId) {
74 |       clearTimeout(this.resetTimeoutId);
75 |     }
76 |   }
77 | 
78 |   resetError = () => {
79 |     console.log('Resetting error boundary');
80 |     
81 |     if (this.resetTimeoutId) {
82 |       clearTimeout(this.resetTimeoutId);
83 |       this.resetTimeoutId = null;
84 |     }
85 | 
86 |     this.setState({
87 |       hasError: false,
88 |       error: null,
89 |       errorInfo: null,
90 |       errorId: ''
91 |     });
92 | 
93 |     toast.success('Interface reset successfully', {
94 |       position: 'top-center',
95 |       duration: 3000
96 |     });
97 |   };
98 | 
99 |   render() {
100 |     if (this.state.hasError) {
101 |       // Use custom fallback if provided
102 |       if (this.props.fallback) {
103 |         const FallbackComponent = this.props.fallback;
104 |         return (
105 |           <FallbackComponent
106 |             error={this.state.error!}
107 |             errorInfo={this.state.errorInfo!}
108 |             resetError={this.resetError}
109 |             errorId={this.state.errorId}
110 |           />
111 |         );
112 |       }
113 | 
114 |       // Default fallback UI
115 |       return <DefaultErrorFallback 
116 |         error={this.state.error!}
117 |         errorInfo={this.state.errorInfo!}
118 |         resetError={this.resetError}
119 |         errorId={this.state.errorId}
120 |       />;
121 |     }
122 | 
123 |     return this.props.children;
124 |   }
125 | }
126 | 
127 | // Default error fallback component
128 | function DefaultErrorFallback({ 
129 |   error, 
130 |   resetError, 
131 |   errorId 
132 | }: {
133 |   error: Error;
134 |   errorInfo: React.ErrorInfo;
135 |   resetError: () => void;
136 |   errorId: string;
137 | }) {
138 |   const router = useRouter();
139 | 
140 |   const handleGoHome = () => {
141 |     router.push('/');
142 |   };
143 | 
144 |   const handleReportError = () => {
145 |     const errorDetails = {
146 |       message: error.message,
147 |       stack: error.stack,
148 |       errorId,
149 |       timestamp: new Date().toISOString(),
150 |       userAgent: navigator.userAgent,
151 |       url: window.location.href
152 |     };
153 | 
154 |     // Copy error details to clipboard
155 |     navigator.clipboard.writeText(JSON.stringify(errorDetails, null, 2))
156 |       .then(() => {
157 |         toast.success('Error details copied to clipboard');
158 |       })
159 |       .catch(() => {
160 |         toast.error('Failed to copy error details');
161 |       });
162 |   };
163 | 
164 |   return (
165 |     <div className="min-h-screen bg-background flex items-center justify-center p-4">
166 |       <div className="max-w-md w-full bg-card border border-border rounded-xl p-6 text-center space-y-6">
167 |         <div className="flex justify-center">
168 |           <div className="p-3 bg-destructive/10 rounded-full">
169 |             <AlertCircle className="h-8 w-8 text-destructive" />
170 |           </div>
171 |         </div>
172 | 
173 |         <div className="space-y-3">
174 |           <h2 className="text-xl font-semibold text-foreground">
175 |             Something went wrong
176 |           </h2>
177 |           <p className="text-sm text-muted-foreground">
178 |             An unexpected error occurred. The interface will attempt to recover automatically, 
179 |             or you can try the options below.
180 |           </p>
181 |         </div>
182 | 
183 |         <div className="space-y-3">
184 |           <button
185 |             onClick={resetError}
186 |             className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
187 |           >
188 |             <RefreshCw className="h-4 w-4" />
189 |             Try Again
190 |           </button>
191 | 
192 |           <button
193 |             onClick={handleGoHome}
194 |             className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-secondary text-secondary-foreground rounded-lg hover:bg-secondary/80 transition-colors"
195 |           >
196 |             <Home className="h-4 w-4" />
197 |             Go to Home
198 |           </button>
199 |         </div>
200 | 
201 |         <details className="text-left">
202 |           <summary className="text-sm text-muted-foreground cursor-pointer hover:text-foreground">
203 |             Technical Details
204 |           </summary>
205 |           <div className="mt-2 p-3 bg-muted rounded-lg">
206 |             <p className="text-xs text-muted-foreground mb-2">
207 |               Error ID: {errorId}
208 |             </p>
209 |             <p className="text-xs font-mono text-foreground break-all">
210 |               {error.message}
211 |             </p>
212 |             <button
213 |               onClick={handleReportError}
214 |               className="mt-2 text-xs text-primary hover:underline"
215 |             >
216 |               Copy error details
217 |             </button>
218 |           </div>
219 |         </details>
220 | 
221 |         <p className="text-xs text-muted-foreground">
222 |           Auto-recovery in progress...
223 |         </p>
224 |       </div>
225 |     </div>
226 |   );
227 | }
228 | 
229 | // Hook for using error boundary in functional components
230 | export function useErrorBoundary() {
231 |   const [error, setError] = React.useState<Error | null>(null);
232 | 
233 |   const resetError = React.useCallback(() => {
234 |     setError(null);
235 |   }, []);
236 | 
237 |   const captureError = React.useCallback((error: Error) => {
238 |     setError(error);
239 |   }, []);
240 | 
241 |   React.useEffect(() => {
242 |     if (error) {
243 |       throw error;
244 |     }
245 |   }, [error]);
246 | 
247 |   return {
248 |     captureError,
249 |     resetError
250 |   };
251 | } 
```

components/favorite-toggle.tsx
```
1 | "use client";
2 | 
3 | import React, { useState } from 'react';
4 | import { Star } from 'lucide-react';
5 | import { cn } from '@/lib/utils';
6 | import { useModel } from '@/lib/context/model-context';
7 | import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
8 | 
9 | interface FavoriteToggleProps {
10 |   modelId: string;
11 |   isFavorite: boolean;
12 |   onToggle?: (modelId: string, isFavorite: boolean) => void;
13 |   disabled?: boolean;
14 |   size?: 'sm' | 'md' | 'lg';
15 |   className?: string;
16 | }
17 | 
18 | export function FavoriteToggle({
19 |   modelId,
20 |   isFavorite,
21 |   onToggle,
22 |   disabled = false,
23 |   size = 'md',
24 |   className,
25 | }: FavoriteToggleProps) {
26 |   const { toggleFavorite } = useModel();
27 |   const [isToggling, setIsToggling] = useState(false);
28 | 
29 |   const handleToggle = async (event: React.MouseEvent) => {
30 |     event.preventDefault();
31 |     event.stopPropagation();
32 | 
33 |     if (disabled || isToggling) return;
34 | 
35 |     setIsToggling(true);
36 | 
37 |     try {
38 |       const success = await toggleFavorite?.(modelId);
39 |       if (success && onToggle) {
40 |         onToggle(modelId, !isFavorite);
41 |       }
42 |     } catch (error) {
43 |       console.error('Error toggling favorite:', error);
44 |     } finally {
45 |       setIsToggling(false);
46 |     }
47 |   };
48 | 
49 |   const sizeClasses = {
50 |     sm: 'h-3 w-3',
51 |     md: 'h-4 w-4',
52 |     lg: 'h-5 w-5',
53 |   };
54 | 
55 |   const buttonSizeClasses = {
56 |     sm: 'p-0.5',
57 |     md: 'p-1',
58 |     lg: 'p-1.5',
59 |   };
60 | 
61 |   return (
62 |     <TooltipProvider delayDuration={300}>
63 |       <Tooltip>
64 |         <TooltipTrigger asChild>
65 |           <button
66 |             type="button"
67 |             onClick={handleToggle}
68 |             disabled={disabled || isToggling}
69 |             className={cn(
70 |               'inline-flex items-center justify-center rounded-sm transition-all duration-200',
71 |               'hover:bg-accent/50 focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-1',
72 |               'active:scale-95',
73 |               buttonSizeClasses[size],
74 |               (disabled || isToggling) && 'opacity-50 cursor-not-allowed hover:bg-transparent',
75 |               className
76 |             )}
77 |             aria-label={isFavorite ? 'Remove from favorites' : 'Add to favorites'}
78 |           >
79 |             <Star
80 |               className={cn(
81 |                 sizeClasses[size],
82 |                 'transition-all duration-200',
83 |                 isFavorite
84 |                   ? 'fill-yellow-400 text-yellow-500 drop-shadow-sm'
85 |                   : 'text-muted-foreground hover:text-yellow-500',
86 |                 isToggling && 'animate-pulse'
87 |               )}
88 |             />
89 |           </button>
90 |         </TooltipTrigger>
91 |         <TooltipContent side="top" className="max-w-xs">
92 |           <p className="text-xs">
93 |             {isToggling
94 |               ? (isFavorite ? 'Removing from favorites...' : 'Adding to favorites...')
95 |               : (isFavorite ? 'Remove from favorites' : 'Add to favorites')
96 |             }
97 |           </p>
98 |         </TooltipContent>
99 |       </Tooltip>
100 |     </TooltipProvider>
101 |   );
102 | } 
```

components/icons.tsx
```
1 | import Link from "next/link";
2 | import * as React from "react";
3 | import type { SVGProps } from "react";
4 | 
5 | export const VercelIcon = ({ size = 17 }) => {
6 |   return (
7 |     <svg
8 |       height={size}
9 |       strokeLinejoin="round"
10 |       viewBox="0 0 16 16"
11 |       width={size}
12 |       style={{ color: "currentcolor" }}
13 |     >
14 |       <title>Vercel Icon</title>
15 |       <path
16 |         fillRule="evenodd"
17 |         clipRule="evenodd"
18 |         d="M8 1L16 15H0L8 1Z"
19 |         fill="currentColor"
20 |       />
21 |     </svg>
22 |   );
23 | };
24 | 
25 | export const SpinnerIcon = ({ size = 16 }: { size?: number }) => (
26 |   <svg
27 |     height={size}
28 |     strokeLinejoin="round"
29 |     viewBox="0 0 16 16"
30 |     width={size}
31 |     style={{ color: "currentcolor" }}
32 |   >
33 |     <title>Spinner Icon</title>
34 |     <g clipPath="url(#clip0_2393_1490)">
35 |       <path d="M8 0V4" stroke="currentColor" strokeWidth="1.5" />
36 |       <path
37 |         opacity="0.5"
38 |         d="M8 16V12"
39 |         stroke="currentColor"
40 |         strokeWidth="1.5"
41 |       />
42 |       <path
43 |         opacity="0.9"
44 |         d="M3.29773 1.52783L5.64887 4.7639"
45 |         stroke="currentColor"
46 |         strokeWidth="1.5"
47 |       />
48 |       <path
49 |         opacity="0.1"
50 |         d="M12.7023 1.52783L10.3511 4.7639"
51 |         stroke="currentColor"
52 |         strokeWidth="1.5"
53 |       />
54 |       <path
55 |         opacity="0.4"
56 |         d="M12.7023 14.472L10.3511 11.236"
57 |         stroke="currentColor"
58 |         strokeWidth="1.5"
59 |       />
60 |       <path
61 |         opacity="0.6"
62 |         d="M3.29773 14.472L5.64887 11.236"
63 |         stroke="currentColor"
64 |         strokeWidth="1.5"
65 |       />
66 |       <path
67 |         opacity="0.2"
68 |         d="M15.6085 5.52783L11.8043 6.7639"
69 |         stroke="currentColor"
70 |         strokeWidth="1.5"
71 |       />
72 |       <path
73 |         opacity="0.7"
74 |         d="M0.391602 10.472L4.19583 9.23598"
75 |         stroke="currentColor"
76 |         strokeWidth="1.5"
77 |       />
78 |       <path
79 |         opacity="0.3"
80 |         d="M15.6085 10.4722L11.8043 9.2361"
81 |         stroke="currentColor"
82 |         strokeWidth="1.5"
83 |       />
84 |       <path
85 |         opacity="0.8"
86 |         d="M0.391602 5.52783L4.19583 6.7639"
87 |         stroke="currentColor"
88 |         strokeWidth="1.5"
89 |       />
90 |     </g>
91 |     <defs>
92 |       <clipPath id="clip0_2393_1490">
93 |         <rect width="16" height="16" fill="white" />
94 |       </clipPath>
95 |     </defs>
96 |   </svg>
97 | );
98 | 
99 | export const Github = (props: SVGProps<SVGSVGElement>) => (
100 |   <svg
101 |     viewBox="0 0 256 250"
102 |     width="1em"
103 |     height="1em"
104 |     fill="currentColor"
105 |     xmlns="http://www.w3.org/2000/svg"
106 |     preserveAspectRatio="xMidYMid"
107 |     {...props}
108 |   >
109 |     <title>GitHub Icon</title>
110 |     <path d="M128.001 0C57.317 0 0 57.307 0 128.001c0 56.554 36.676 104.535 87.535 121.46 6.397 1.185 8.746-2.777 8.746-6.158 0-3.052-.12-13.135-.174-23.83-35.61 7.742-43.124-15.103-43.124-15.103-5.823-14.795-14.213-18.73-14.213-18.73-11.613-7.944.876-7.78.876-7.78 12.853.902 19.621 13.19 19.621 13.19 11.417 19.568 29.945 13.911 37.249 10.64 1.149-8.272 4.466-13.92 8.127-17.116-28.431-3.236-58.318-14.212-58.318-63.258 0-13.975 5-25.394 13.188-34.358-1.329-3.224-5.71-16.242 1.24-33.874 0 0 10.749-3.44 35.21 13.121 10.21-2.836 21.16-4.258 32.038-4.307 10.878.049 21.837 1.47 32.066 4.307 24.431-16.56 35.165-13.12 35.165-13.12 6.967 17.63 2.584 30.65 1.255 33.873 8.207 8.964 13.173 20.383 13.173 34.358 0 49.163-29.944 59.988-58.447 63.157 4.591 3.972 8.682 11.762 8.682 23.704 0 17.126-.148 30.91-.148 35.126 0 3.407 2.304 7.398 8.792 6.14C219.37 232.5 256 184.537 256 128.002 256 57.307 198.691 0 128.001 0Zm-80.06 182.34c-.282.636-1.283.827-2.194.39-.929-.417-1.45-1.284-1.15-1.922.276-.655 1.279-.838 2.205-.399.93.418 1.46 1.293 1.139 1.931Zm6.296 5.618c-.61.566-1.804.303-2.614-.591-.837-.892-.994-2.086-.375-2.66.63-.566 1.787-.301 2.626.591.838.903 1 2.088.363 2.66Zm4.32 7.188c-.785.545-2.067.034-2.86-1.104-.784-1.138-.784-2.503.017-3.05.795-.547 2.058-.055 2.861 1.075.782 1.157.782 2.522-.019 3.08Zm7.304 8.325c-.701.774-2.196.566-3.29-.49-1.119-1.032-1.43-2.496-.726-3.27.71-.776 2.213-.558 3.315.49 1.11 1.03 1.45 2.505.701 3.27Zm9.442 2.81c-.31 1.003-1.75 1.459-3.199 1.033-1.448-.439-2.395-1.613-2.103-2.626.301-1.01 1.747-1.484 3.207-1.028 1.446.436 2.396 1.602 2.095 2.622Zm10.744 1.193c.036 1.055-1.193 1.93-2.715 1.95-1.53.034-2.769-.82-2.786-1.86 0-1.065 1.202-1.932 2.733-1.958 1.522-.03 2.768.818 2.768 1.868Zm10.555-.405c.182 1.03-.875 2.088-2.387 2.37-1.485.271-2.861-.365-3.05-1.386-.184-1.056.893-2.114 2.376-2.387 1.514-.263 2.868.356 3.061 1.403Z" />
111 |   </svg>
112 | );
113 | 
114 | export function StarButton() {
115 |   return (
116 |     <Link
117 |       href="https://github.com/vercel-labs/ai-sdk-preview-reasoning"
118 |       target="_blank"
119 |       rel="noopener noreferrer"
120 |       className="flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-300 hover:text-zinc-700 dark:hover:text-zinc-300"
121 |     >
122 |       <Github className="size-4" />
123 |       <span className="hidden sm:inline">Star on GitHub</span>
124 |     </Link>
125 |   );
126 | }
127 | 
128 | export const XAiIcon = ({ size = 16 }) => {
129 |   return (
130 |     <svg
131 |       xmlns="http://www.w3.org/2000/svg"
132 |       height={size}
133 |       version="1.1"
134 |       viewBox="0 0 438.7 481.4"
135 |     >
136 |       <title>xAI Icon</title>
137 |       <path d="M355.5,155.1l8.3,326.4h66.6l8.3-445.2-83.2,118.8ZM438.7,0h-101.6l-159.4,227.6,50.8,72.5L438.7,0ZM0,481.4h101.6l50.8-72.5-50.8-72.5L0,481.4ZM0,155.1l228.5,326.4h101.6L101.6,155.1H0Z" />
138 |     </svg>
139 |   );
140 | };
```

components/image-modal.tsx
```
1 | 'use client';
2 | 
3 | import React from 'react';
4 | import { Download, X } from 'lucide-react';
5 | import { Dialog, DialogOverlay, DialogPortal } from '@/components/ui/dialog';
6 | import * as DialogPrimitive from "@radix-ui/react-dialog";
7 | import { Button } from '@/components/ui/button';
8 | import { formatFileSize } from '@/lib/image-utils';
9 | import { cn } from '@/lib/utils';
10 | 
11 | interface ImageModalProps {
12 |   isOpen: boolean;
13 |   onClose: () => void;
14 |   imageUrl: string;
15 |   filename?: string;
16 |   metadata?: {
17 |     filename?: string;
18 |     size?: number;
19 |     mimeType?: string;
20 |     width?: number;
21 |     height?: number;
22 |   };
23 |   detail?: string;
24 | }
25 | 
26 | export function ImageModal({
27 |   isOpen,
28 |   onClose,
29 |   imageUrl,
30 |   filename,
31 |   metadata,
32 |   detail
33 | }: ImageModalProps) {
34 |   const handleDownload = () => {
35 |     // Create a download link for the image
36 |     const link = document.createElement('a');
37 |     link.href = imageUrl;
38 |     link.download = filename || metadata?.filename || 'image';
39 |     document.body.appendChild(link);
40 |     link.click();
41 |     document.body.removeChild(link);
42 |   };
43 | 
44 |   const displayFilename = filename || metadata?.filename || 'Uploaded image';
45 | 
46 |   return (
47 |     <Dialog open={isOpen} onOpenChange={onClose}>
48 |       <DialogPortal>
49 |         <DialogOverlay />
50 |         <DialogPrimitive.Content
51 |           className={cn(
52 |             "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[95vw] max-h-[95vh] translate-x-[-50%] translate-y-[-50%] gap-0 rounded-lg border p-0 shadow-lg duration-200"
53 |           )}
54 |           aria-describedby="image-modal-description"
55 |         >
56 |           <div className="relative flex flex-col h-[95vh]">
57 |             {/* Header with filename and controls */}
58 |                           <div className="flex items-center justify-between p-4 border-b border-border bg-background/80 backdrop-blur-sm">
59 |                 <div className="flex-1 min-w-0">
60 |                   <DialogPrimitive.Title asChild>
61 |                     <h3 className="text-lg font-semibold truncate" title={displayFilename}>
62 |                       {displayFilename}
63 |                     </h3>
64 |                   </DialogPrimitive.Title>
65 |                 {metadata && (
66 |                   <div id="image-modal-description" className="text-sm text-muted-foreground mt-1">
67 |                     {metadata.size && <span>{formatFileSize(metadata.size)}</span>}
68 |                     {metadata.width && metadata.height && (
69 |                       <span> • {metadata.width}×{metadata.height}</span>
70 |                     )}
71 |                     {detail && detail !== 'auto' && (
72 |                       <span> • {detail} quality</span>
73 |                     )}
74 |                   </div>
75 |                 )}
76 |               </div>
77 |               
78 |               <div className="flex items-center space-x-2 ml-4">
79 |                 <Button
80 |                   variant="outline"
81 |                   size="sm"
82 |                   onClick={handleDownload}
83 |                   className="flex items-center space-x-2"
84 |                   aria-label={`Download ${displayFilename}`}
85 |                 >
86 |                   <Download className="h-4 w-4" />
87 |                   <span className="hidden sm:inline">Download</span>
88 |                 </Button>
89 |                 
90 |                 <DialogPrimitive.Close asChild>
91 |                   <Button
92 |                     variant="ghost"
93 |                     size="sm"
94 |                     className="h-8 w-8 p-0"
95 |                     aria-label="Close image viewer"
96 |                   >
97 |                     <X className="h-4 w-4" />
98 |                   </Button>
99 |                 </DialogPrimitive.Close>
100 |               </div>
101 |             </div>
102 | 
103 |             {/* Image container */}
104 |             <div className="flex-1 flex items-center justify-center p-4 min-h-0">
105 |               <img
106 |                 src={imageUrl}
107 |                 alt={displayFilename}
108 |                 className="max-w-full max-h-full object-contain rounded-lg border border-border shadow-lg"
109 |                 loading="lazy"
110 |               />
111 |             </div>
112 |           </div>
113 |         </DialogPrimitive.Content>
114 |       </DialogPortal>
115 |     </Dialog>
116 |   );
117 | } 
```

components/image-preview.tsx
```
1 | 'use client';
2 | 
3 | import React from 'react';
4 | import { X } from 'lucide-react';
5 | import { Button } from '@/components/ui/button';
6 | import { formatFileSize } from '@/lib/image-utils';
7 | import type { ImageAttachment } from '@/lib/types';
8 | 
9 | interface ImagePreviewProps {
10 |   images: ImageAttachment[];
11 |   onRemove: (index: number) => void;
12 |   onReorder?: (startIndex: number, endIndex: number) => void;
13 |   maxWidth?: number;
14 |   maxHeight?: number;
15 |   className?: string;
16 | }
17 | 
18 | export function ImagePreview({
19 |   images,
20 |   onRemove,
21 |   onReorder,
22 |   maxWidth = 200,
23 |   maxHeight = 200,
24 |   className = ""
25 | }: ImagePreviewProps) {
26 |   if (images.length === 0) {
27 |     return null;
28 |   }
29 | 
30 |   return (
31 |     <div className={`image-preview-grid ${className}`}>
32 |       {images.map((image, index) => (
33 |         <ImagePreviewItem
34 |           key={`${image.metadata.filename}-${index}`}
35 |           image={image}
36 |           index={index}
37 |           onRemove={onRemove}
38 |           maxWidth={maxWidth}
39 |           maxHeight={maxHeight}
40 |         />
41 |       ))}
42 |     </div>
43 |   );
44 | }
45 | 
46 | interface ImagePreviewItemProps {
47 |   image: ImageAttachment;
48 |   index: number;
49 |   onRemove: (index: number) => void;
50 |   maxWidth: number;
51 |   maxHeight: number;
52 | }
53 | 
54 | function ImagePreviewItem({
55 |   image,
56 |   index,
57 |   onRemove,
58 |   maxWidth,
59 |   maxHeight
60 | }: ImagePreviewItemProps) {
61 |   return (
62 |     <div className="image-preview-item">
63 |       <div className="relative">
64 |         <img
65 |           src={image.dataUrl}
66 |           alt={image.metadata.filename}
67 |           className="w-full h-auto rounded border border-border object-cover"
68 |           style={{
69 |             maxWidth: `${maxWidth}px`,
70 |             maxHeight: `${maxHeight}px`
71 |           }}
72 |           loading="lazy"
73 |         />
74 |         
75 |         {/* Remove button */}
76 |         <Button
77 |           variant="destructive"
78 |           size="sm"
79 |           className="image-preview-remove"
80 |           onClick={() => onRemove(index)}
81 |           aria-label={`Remove ${image.metadata.filename}`}
82 |         >
83 |           <X className="h-3 w-3" />
84 |         </Button>
85 |         
86 |         {/* Detail level indicator */}
87 |         {image.detail && image.detail !== 'auto' && (
88 |           <div className="absolute bottom-1 left-1 px-1.5 py-0.5 bg-background/80 border border-border rounded text-xs">
89 |             {image.detail}
90 |           </div>
91 |         )}
92 |       </div>
93 |       
94 |       {/* File info */}
95 |       <div className="mt-1 space-y-0.5">
96 |         <div className="text-xs font-medium truncate" title={image.metadata.filename}>
97 |           {image.metadata.filename}
98 |         </div>
99 |         <div className="text-xs text-muted-foreground">
100 |           {formatFileSize(image.metadata.size)}
101 |           {image.metadata.width > 0 && image.metadata.height > 0 && (
102 |             <> • {image.metadata.width}×{image.metadata.height}</>
103 |           )}
104 |         </div>
105 |       </div>
106 |     </div>
107 |   );
108 | }
109 | 
110 | // Loading placeholder component for when images are being processed
111 | export function ImagePreviewLoading({ count = 1 }: { count?: number }) {
112 |   return (
113 |     <div className="image-preview-grid">
114 |       {Array.from({ length: count }).map((_, index) => (
115 |         <div key={index} className="image-preview-item">
116 |           <div className="animate-pulse">
117 |             <div className="w-full h-24 bg-muted rounded border border-border"></div>
118 |             <div className="mt-1 space-y-1">
119 |               <div className="h-3 bg-muted rounded w-3/4"></div>
120 |               <div className="h-2 bg-muted rounded w-1/2"></div>
121 |             </div>
122 |           </div>
123 |         </div>
124 |       ))}
125 |     </div>
126 |   );
127 | }
128 | 
129 | // Error state component
130 | export function ImagePreviewError({ 
131 |   error, 
132 |   onRetry 
133 | }: { 
134 |   error: string; 
135 |   onRetry?: () => void; 
136 | }) {
137 |   return (
138 |     <div className="p-3 border border-destructive/20 bg-destructive/5 rounded-md">
139 |       <div className="flex items-center justify-between">
140 |         <div className="text-sm text-destructive">{error}</div>
141 |         {onRetry && (
142 |           <Button variant="outline" size="sm" onClick={onRetry}>
143 |             Retry
144 |           </Button>
145 |         )}
146 |       </div>
147 |     </div>
148 |   );
149 | } 
```

components/image-upload.tsx
```
1 | 'use client';
2 | 
3 | import React, { useRef, useState, useCallback } from 'react';
4 | import { ImageIcon, Upload, Loader2 } from 'lucide-react';
5 | import { Button } from '@/components/ui/button';
6 | import { Label } from '@/components/ui/label';
7 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
8 | import { processImageFile, validateImageFile } from '@/lib/image-utils';
9 | import type { ImageAttachment } from '@/lib/types';
10 | 
11 | interface ImageUploadProps {
12 |   onImageSelect: (images: ImageAttachment[]) => void;
13 |   maxFiles?: number;
14 |   maxSizePerFile?: number; // in bytes
15 |   acceptedTypes?: string[];
16 |   disabled?: boolean;
17 |   defaultDetail?: "low" | "high" | "auto";
18 |   showDetailSelector?: boolean;
19 |   className?: string;
20 | }
21 | 
22 | export function ImageUpload({
23 |   onImageSelect,
24 |   maxFiles = 3,
25 |   maxSizePerFile = 2 * 1024 * 1024, // 2MB (optimized for Vercel 4.5MB request limit)
26 |   acceptedTypes = ['image/jpeg', 'image/png', 'image/webp'], // Standard formats supported by most AI providers
27 |   disabled = false,
28 |   defaultDetail = "auto",
29 |   showDetailSelector = true,
30 |   className = ""
31 | }: ImageUploadProps) {
32 |   const [isUploading, setIsUploading] = useState(false);
33 |   const [uploadErrors, setUploadErrors] = useState<string[]>([]);
34 |   const [dragActive, setDragActive] = useState(false);
35 |   const [selectedDetail, setSelectedDetail] = useState<"low" | "high" | "auto">(defaultDetail);
36 |   
37 |   const fileInputRef = useRef<HTMLInputElement>(null);
38 | 
39 |   const handleFiles = useCallback(async (files: FileList | File[]) => {
40 |     const fileArray = Array.from(files);
41 |     const errors: string[] = [];
42 |     const processedImages: ImageAttachment[] = [];
43 |     
44 |     console.log('[DEBUG] ImageUpload.handleFiles called with:', {
45 |       filesCount: fileArray.length,
46 |       maxFiles,
47 |       selectedDetail,
48 |       files: fileArray.map(f => ({ name: f.name, size: f.size, type: f.type }))
49 |     });
50 | 
51 |     if (fileArray.length > maxFiles) {
52 |       const errorMsg = `Maximum ${maxFiles} images allowed. Only first ${maxFiles} will be processed.`;
53 |       errors.push(errorMsg);
54 |       console.warn('[WARN]', errorMsg);
55 |     }
56 | 
57 |     setIsUploading(true);
58 |     setUploadErrors([]);
59 | 
60 |     const filesToProcess = fileArray.slice(0, maxFiles);
61 |     console.log('[DEBUG] Processing', filesToProcess.length, 'files');
62 | 
63 |     for (const file of filesToProcess) {
64 |       try {
65 |         console.log('[DEBUG] Processing file:', file.name);
66 |         
67 |         // Validate file
68 |         const validation = validateImageFile(file, {
69 |           maxSize: maxSizePerFile,
70 |           allowedTypes: acceptedTypes
71 |         });
72 | 
73 |         console.log('[DEBUG] File validation result:', {
74 |           filename: file.name,
75 |           valid: validation.valid,
76 |           error: validation.error
77 |         });
78 | 
79 |         if (!validation.valid) {
80 |           const errorMsg = `${file.name}: ${validation.error}`;
81 |           errors.push(errorMsg);
82 |           console.error('[ERROR] File validation failed:', errorMsg);
83 |           continue;
84 |         }
85 | 
86 |         // Process file
87 |         console.log('[DEBUG] Processing image file:', file.name);
88 |         const { dataUrl, metadata } = await processImageFile(file);
89 |         
90 |         console.log('[DEBUG] Image processed successfully:', {
91 |           filename: file.name,
92 |           dataUrlLength: dataUrl.length,
93 |           metadata,
94 |           detail: selectedDetail,
95 |           wasCompressed: metadata.originalSize && metadata.originalSize > metadata.size
96 |         });
97 | 
98 |         // Show compression info if image was compressed
99 |         if (metadata.originalSize && metadata.originalSize > metadata.size) {
100 |           const compressionRatio = ((metadata.size / metadata.originalSize) * 100).toFixed(1);
101 |           console.log(`[INFO] Image ${file.name} compressed from ${Math.round(metadata.originalSize / 1024 / 1024 * 10) / 10}MB to ${Math.round(metadata.size / 1024 / 1024 * 10) / 10}MB (${compressionRatio}%)`);
102 |         }
103 | 
104 |         processedImages.push({
105 |           file,
106 |           dataUrl,
107 |           metadata,
108 |           detail: selectedDetail
109 |         });
110 |       } catch (error) {
111 |         const errorMsg = `${file.name}: Failed to process image`;
112 |         errors.push(errorMsg);
113 |         console.error('[ERROR] Error processing image:', error);
114 |       }
115 |     }
116 | 
117 |     setIsUploading(false);
118 |     setUploadErrors(errors);
119 |     
120 |     console.log('[DEBUG] Image processing complete:', {
121 |       processedCount: processedImages.length,
122 |       errorsCount: errors.length,
123 |       errors: errors
124 |     });
125 | 
126 |     if (processedImages.length > 0) {
127 |       console.log('[DEBUG] Calling onImageSelect with', processedImages.length, 'images');
128 |       onImageSelect(processedImages);
129 |     } else {
130 |       console.warn('[WARN] No images were successfully processed');
131 |     }
132 |   }, [maxFiles, maxSizePerFile, acceptedTypes, selectedDetail, onImageSelect]);
133 | 
134 |   const handleDrag = useCallback((e: React.DragEvent) => {
135 |     e.preventDefault();
136 |     e.stopPropagation();
137 |     
138 |     if (e.type === 'dragenter' || e.type === 'dragover') {
139 |       setDragActive(true);
140 |     } else if (e.type === 'dragleave') {
141 |       setDragActive(false);
142 |     }
143 |   }, []);
144 | 
145 |   const handleDrop = useCallback((e: React.DragEvent) => {
146 |     e.preventDefault();
147 |     e.stopPropagation();
148 |     setDragActive(false);
149 | 
150 |     if (disabled || isUploading) return;
151 | 
152 |     const files = e.dataTransfer.files;
153 |     if (files && files.length > 0) {
154 |       handleFiles(files);
155 |     }
156 |   }, [disabled, isUploading, handleFiles]);
157 | 
158 |   const handleFileInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
159 |     const files = e.target.files;
160 |     if (files && files.length > 0) {
161 |       handleFiles(files);
162 |     }
163 |     // Reset input value to allow selecting the same file again
164 |     if (fileInputRef.current) {
165 |       fileInputRef.current.value = '';
166 |     }
167 |   }, [handleFiles]);
168 | 
169 |   const handleButtonClick = useCallback(() => {
170 |     if (disabled || isUploading) return;
171 |     fileInputRef.current?.click();
172 |   }, [disabled, isUploading]);
173 | 
174 |   return (
175 |     <div className={`space-y-3 ${className}`}>
176 |       {/* Detail Level Selector */}
177 |       {showDetailSelector && (
178 |         <div className="flex items-center space-x-2">
179 |           <Label htmlFor="detail-selector" className="text-sm font-medium">
180 |             Image Detail:
181 |           </Label>
182 |           <Select value={selectedDetail} onValueChange={(value: "low" | "high" | "auto") => setSelectedDetail(value)}>
183 |             <SelectTrigger className="w-32" id="detail-selector">
184 |               <SelectValue />
185 |             </SelectTrigger>
186 |             <SelectContent>
187 |               <SelectItem value="auto">Auto</SelectItem>
188 |               <SelectItem value="low">Low (85 tokens)</SelectItem>
189 |               <SelectItem value="high">High (170 tokens)</SelectItem>
190 |             </SelectContent>
191 |           </Select>
192 |         </div>
193 |       )}
194 | 
195 |       {/* Upload Area */}
196 |       <div
197 |         className={`image-upload-area ${dragActive ? 'border-primary' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
198 |         onDragEnter={handleDrag}
199 |         onDragLeave={handleDrag}
200 |         onDragOver={handleDrag}
201 |         onDrop={handleDrop}
202 |         onClick={handleButtonClick}
203 |       >
204 |         <input
205 |           ref={fileInputRef}
206 |           type="file"
207 |           multiple
208 |           accept={acceptedTypes.join(',')}
209 |           onChange={handleFileInputChange}
210 |           className="hidden"
211 |           disabled={disabled || isUploading}
212 |         />
213 | 
214 |         <div className="flex flex-col items-center justify-center space-y-2 p-6">
215 |           {isUploading ? (
216 |             <>
217 |               <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
218 |               <div className="text-sm text-muted-foreground">Processing images...</div>
219 |             </>
220 |           ) : (
221 |             <>
222 |               <div className="flex items-center space-x-2 text-muted-foreground">
223 |                 <ImageIcon className="h-6 w-6" />
224 |                 <Upload className="h-4 w-4" />
225 |               </div>
226 |               <div className="text-sm font-medium">
227 |                 {dragActive ? 'Drop images here' : 'Click or drag images to upload'}
228 |               </div>
229 |               <div className="text-xs text-muted-foreground text-center">
230 |                 Supports JPEG, PNG, WebP • Max {maxFiles} files • {Math.round(maxSizePerFile / (1024 * 1024))}MB per file
231 |               </div>
232 |             </>
233 |           )}
234 |         </div>
235 |       </div>
236 | 
237 |       {/* Upload Button (Alternative to drag area) */}
238 |       <div className="flex justify-center">
239 |         <Button
240 |           variant="outline"
241 |           size="sm"
242 |           onClick={handleButtonClick}
243 |           disabled={disabled || isUploading}
244 |           className="w-full sm:w-auto"
245 |         >
246 |           <ImageIcon className="h-4 w-4 mr-2" />
247 |           {isUploading ? 'Processing...' : 'Choose Images'}
248 |         </Button>
249 |       </div>
250 | 
251 |       {/* Error Messages */}
252 |       {uploadErrors.length > 0 && (
253 |         <div className="space-y-1">
254 |           {uploadErrors.map((error, index) => (
255 |             <div key={index} className="text-sm text-destructive bg-destructive/10 p-2 rounded">
256 |               {error}
257 |             </div>
258 |           ))}
259 |         </div>
260 |       )}
261 | 
262 |       {/* Help Text */}
263 |       <div className="text-xs text-muted-foreground">
264 |         <div className="font-medium mb-1">Image Detail Levels:</div>
265 |         <ul className="space-y-0.5 ml-2">
266 |           <li>• <strong>Auto:</strong> AI chooses optimal quality (recommended)</li>
267 |           <li>• <strong>Low:</strong> Faster processing, good for simple images</li>
268 |           <li>• <strong>High:</strong> Detailed analysis, better for complex images</li>
269 |         </ul>
270 |         <div className="mt-2 text-xs bg-blue-50 dark:bg-blue-900/20 p-2 rounded border border-blue-200 dark:border-blue-800">
271 |           <div className="font-medium text-blue-800 dark:text-blue-200 mb-1">✨ Smart Compression:</div>
272 |           <div className="text-blue-700 dark:text-blue-300">
273 |             Large images (&gt;1MB) are automatically compressed to ensure fast uploads while maintaining quality.
274 |           </div>
275 |         </div>
276 |       </div>
277 |     </div>
278 |   );
279 | }
280 | 
281 | // Status indicator component
282 | export function ImageUploadStatus({
283 |   isUploading,
284 |   imageCount,
285 |   errors
286 | }: {
287 |   isUploading: boolean;
288 |   imageCount: number;
289 |   errors: string[];
290 | }) {
291 |   if (isUploading) {
292 |     return (
293 |       <div className="flex items-center gap-2 text-sm text-muted-foreground">
294 |         <Loader2 className="h-3 w-3 animate-spin" />
295 |         Processing images...
296 |       </div>
297 |     );
298 |   }
299 | 
300 |   if (errors.length > 0) {
301 |     return (
302 |       <div className="text-sm text-destructive">
303 |         {errors.length} error{errors.length > 1 ? 's' : ''} occurred
304 |       </div>
305 |     );
306 |   }
307 | 
308 |   if (imageCount > 0) {
309 |     return (
310 |       <div className="text-xs text-muted-foreground">
311 |         {imageCount} image{imageCount > 1 ? 's' : ''} ready to send
312 |       </div>
313 |     );
314 |   }
315 | 
316 |   return null;
317 | } 
```

components/input.tsx
```
1 | import { ArrowUp, ImageIcon } from "lucide-react";
2 | import { Input as ShadcnInput } from "./ui/input";
3 | import { Button } from "./ui/button";
4 | import { ImageUpload } from "./image-upload";
5 | import { ImagePreview } from "./image-preview";
6 | import type { ImageAttachment } from "@/lib/types";
7 | import { useState } from "react";
8 | import { modelID } from "@/ai/providers";
9 | import { useModels } from "@/hooks/use-models";
10 | 
11 | interface InputProps {
12 |   input: string;
13 |   handleInputChange: (event: React.ChangeEvent<HTMLInputElement>) => void;
14 |   isLoading: boolean;
15 |   status: string;
16 |   stop: () => void;
17 |   // New props for image support
18 |   images?: ImageAttachment[];
19 |   onImagesChange?: (images: ImageAttachment[]) => void;
20 |   maxImages?: number;
21 |   enableImageUpload?: boolean;
22 |   selectedModel: modelID;
23 | }
24 | 
25 | export const Input = ({
26 |   input,
27 |   handleInputChange,
28 |   isLoading,
29 |   status,
30 |   stop,
31 |   images = [],
32 |   onImagesChange,
33 |   maxImages = 3,
34 |   enableImageUpload = true,
35 |   selectedModel,
36 | }: InputProps) => {
37 |   const [showImageUpload, setShowImageUpload] = useState(false);
38 |   const { models } = useModels();
39 | 
40 |   // Helper function to check if the selected model supports vision
41 |   const modelSupportsVision = () => {
42 |     const modelInfo = models.find(model => model.id === selectedModel);
43 |     return modelInfo?.vision === true;
44 |   };
45 | 
46 |   const handleImageSelect = (newImages: ImageAttachment[]) => {
47 |     if (onImagesChange) {
48 |       onImagesChange([...images, ...newImages]);
49 |     }
50 |     setShowImageUpload(false);
51 |   };
52 | 
53 |   const handleImageRemove = (index: number) => {
54 |     if (onImagesChange) {
55 |       const updatedImages = images.filter((_, i) => i !== index);
56 |       onImagesChange(updatedImages);
57 |     }
58 |   };
59 | 
60 |   const canUploadMore = images.length < maxImages;
61 |   const hasImages = images.length > 0;
62 |   const canSubmit = (input.trim() || hasImages) && !isLoading;
63 | 
64 |   return (
65 |     <div className="w-full space-y-3">
66 |       {/* Image Upload Interface */}
67 |       {enableImageUpload && modelSupportsVision() && showImageUpload && (
68 |         <div className="bg-card border border-border rounded-xl p-4">
69 |           <ImageUpload
70 |             onImageSelect={handleImageSelect}
71 |             maxFiles={maxImages - images.length}
72 |             disabled={isLoading || !canUploadMore}
73 |             showDetailSelector={true}
74 |           />
75 |         </div>
76 |       )}
77 | 
78 |       {/* Image Preview */}
79 |       {hasImages && (
80 |         <div className="bg-card border border-border rounded-xl p-3">
81 |           <ImagePreview
82 |             images={images}
83 |             onRemove={handleImageRemove}
84 |             maxWidth={120}
85 |             maxHeight={120}
86 |             className="mb-2"
87 |           />
88 |           <div className="text-xs text-muted-foreground">
89 |             {images.length}/{maxImages} images • Click images to remove
90 |           </div>
91 |         </div>
92 |       )}
93 | 
94 |       {/* Text Input */}
95 |       <div className="relative w-full">
96 |         <ShadcnInput
97 |           className="bg-secondary py-6 w-full rounded-xl pr-20 pl-12"
98 |           value={input}
99 |           autoFocus
100 |           placeholder={hasImages ? "Describe these images or ask questions..." : "Say something..."}
101 |           onChange={handleInputChange}
102 |         />
103 |         
104 |         {/* Image Upload Button */}
105 |         {enableImageUpload && modelSupportsVision() && (
106 |           <Button
107 |             type="button"
108 |             variant="ghost"
109 |             size="sm"
110 |             onClick={() => setShowImageUpload(!showImageUpload)}
111 |             disabled={isLoading || !canUploadMore}
112 |             className="absolute left-2 top-1/2 -translate-y-1/2 p-2 h-8 w-8"
113 |           >
114 |             <ImageIcon className={`h-4 w-4 ${!canUploadMore ? 'text-muted-foreground' : ''}`} />
115 |           </Button>
116 |         )}
117 | 
118 |         {/* Submit/Stop Button */}
119 |         {status === "streaming" || status === "submitted" ? (
120 |           <button
121 |             type="button"
122 |             onClick={stop}
123 |             className="cursor-pointer absolute right-2 top-1/2 -translate-y-1/2 rounded-full p-2 bg-black hover:bg-zinc-800 disabled:bg-zinc-300 disabled:cursor-not-allowed transition-colors"
124 |           >
125 |             <div className="animate-spin h-4 w-4">
126 |               <svg className="h-4 w-4 text-white" viewBox="0 0 24 24">
127 |                 <circle
128 |                   className="opacity-25"
129 |                   cx="12"
130 |                   cy="12"
131 |                   r="10"
132 |                   stroke="currentColor"
133 |                   strokeWidth="4"
134 |                   fill="none"
135 |                 />
136 |                 <path
137 |                   className="opacity-75"
138 |                   fill="currentColor"
139 |                   d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
140 |                 />
141 |               </svg>
142 |             </div>
143 |           </button>
144 |         ) : (
145 |           <button
146 |             type="submit"
147 |             disabled={!canSubmit}
148 |             className="absolute right-2 top-1/2 -translate-y-1/2 rounded-full p-2 bg-black hover:bg-zinc-800 disabled:bg-zinc-300 disabled:cursor-not-allowed transition-colors"
149 |           >
150 |             <ArrowUp className="h-4 w-4 text-white" />
151 |           </button>
152 |         )}
153 |       </div>
154 | 
155 |       {/* Upload Status Messages */}
156 |     </div>
157 |   );
158 | };
```

components/ios-install-prompt.tsx
```
1 | 'use client';
2 | 
3 | import { useState, useEffect } from 'react';
4 | import { X, Share, Plus } from 'lucide-react';
5 | import { Button } from '@/components/ui/button';
6 | import { Card, CardContent } from '@/components/ui/card';
7 | 
8 | interface IOSInstallPromptProps {
9 |   onDismiss?: () => void;
10 | }
11 | 
12 | export function IOSInstallPrompt({ onDismiss }: IOSInstallPromptProps) {
13 |   const [isVisible, setIsVisible] = useState(false);
14 |   const [isIOS, setIsIOS] = useState(false);
15 |   const [isStandalone, setIsStandalone] = useState(false);
16 | 
17 |   useEffect(() => {
18 |     // Check if running on iOS
19 |     const userAgent = navigator.userAgent.toLowerCase();
20 |     const isiOS = /iphone|ipad|ipod/.test(userAgent);
21 |     setIsIOS(isiOS);
22 | 
23 |     // Check if already running in standalone mode
24 |     const isStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || 
25 |                            (window.navigator as any).standalone === true;
26 |     setIsStandalone(isStandaloneMode);
27 | 
28 |     // Check if user has previously dismissed the prompt
29 |     const dismissed = localStorage.getItem('chatlima-ios-install-dismissed');
30 |     
31 |     // Only show if: iOS Safari, not in standalone mode, not previously dismissed
32 |     if (isiOS && !isStandaloneMode && !dismissed) {
33 |       // Show after a short delay to ensure user has interacted with the page
34 |       const timer = setTimeout(() => {
35 |         setIsVisible(true);
36 |       }, 3000);
37 |       
38 |       return () => clearTimeout(timer);
39 |     }
40 |   }, []);
41 | 
42 |   const handleDismiss = () => {
43 |     setIsVisible(false);
44 |     localStorage.setItem('chatlima-ios-install-dismissed', 'true');
45 |     onDismiss?.();
46 |   };
47 | 
48 |   const handleNeverShow = () => {
49 |     setIsVisible(false);
50 |     localStorage.setItem('chatlima-ios-install-dismissed', 'permanent');
51 |     onDismiss?.();
52 |   };
53 | 
54 |   if (!isVisible || !isIOS || isStandalone) {
55 |     return null;
56 |   }
57 | 
58 |   return (
59 |     <div className="fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:w-80">
60 |       <Card className="shadow-lg border-2">
61 |         <CardContent className="p-4">
62 |           <div className="flex items-start justify-between mb-3">
63 |             <div className="flex items-center gap-2">
64 |               <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
65 |                 <span className="text-white text-sm font-bold">CL</span>
66 |               </div>
67 |               <div>
68 |                 <h3 className="font-semibold text-sm">Add to Home Screen</h3>
69 |                 <p className="text-xs text-muted-foreground">Quick access to ChatLima</p>
70 |               </div>
71 |             </div>
72 |             <Button
73 |               variant="ghost"
74 |               size="sm"
75 |               onClick={handleDismiss}
76 |               className="h-6 w-6 p-0"
77 |             >
78 |               <X className="h-4 w-4" />
79 |             </Button>
80 |           </div>
81 |           
82 |           <div className="space-y-2 mb-3">
83 |             <div className="flex items-center gap-2 text-xs">
84 |               <span className="w-4 h-4 border rounded flex items-center justify-center">1</span>
85 |               <span>Tap the</span>
86 |               <Share className="h-4 w-4" />
87 |               <span>Share button below</span>
88 |             </div>
89 |             <div className="flex items-center gap-2 text-xs">
90 |               <span className="w-4 h-4 border rounded flex items-center justify-center">2</span>
91 |               <span>Select</span>
92 |               <div className="flex items-center gap-1 px-1 py-0.5 bg-muted rounded text-xs">
93 |                 <Plus className="h-3 w-3" />
94 |                 <span>Add to Home Screen</span>
95 |               </div>
96 |             </div>
97 |           </div>
98 |           
99 |           <div className="flex gap-2">
100 |             <Button
101 |               variant="outline"
102 |               size="sm"
103 |               onClick={handleNeverShow}
104 |               className="text-xs flex-1"
105 |             >
106 |               Don&apos;t show again
107 |             </Button>
108 |             <Button
109 |               size="sm"
110 |               onClick={handleDismiss}
111 |               className="text-xs flex-1"
112 |             >
113 |               Got it
114 |             </Button>
115 |           </div>
116 |         </CardContent>
117 |       </Card>
118 |     </div>
119 |   );
120 | } 
```

components/markdown.tsx
```
1 | import Link from "next/link";
2 | import React, { memo } from "react";
3 | import ReactMarkdown, { type Components } from "react-markdown";
4 | import remarkGfm from "remark-gfm";
5 | import remarkMath from "remark-math";
6 | import rehypeKatex from "rehype-katex";
7 | import "katex/dist/katex.min.css";
8 | import { cn } from "@/lib/utils";
9 | import { CopyButton } from "./copy-button";
10 | 
11 | const components: Partial<Components> = {
12 |   pre: ({ children, ...props }) => {
13 |     // Extract text content from children for copying
14 |     const getTextContent = (node: React.ReactNode): string => {
15 |       if (typeof node === 'string') return node;
16 |       if (typeof node === 'number') return String(node);
17 |       if (Array.isArray(node)) return node.map(getTextContent).join('');
18 |       if (React.isValidElement(node)) {
19 |         const props = node.props as { children?: React.ReactNode };
20 |         return getTextContent(props.children);
21 |       }
22 |       return '';
23 |     };
24 | 
25 |     const textContent = getTextContent(children);
26 | 
27 |     return (
28 |       <div className="relative group/codeblock">
29 |         <pre className="overflow-x-auto max-w-full rounded-lg bg-zinc-100 dark:bg-zinc-800/50 black:bg-zinc-800/50 p-2.5 my-1.5 text-sm whitespace-pre-wrap break-words" {...props}>
30 |           {children}
31 |         </pre>
32 |         <CopyButton 
33 |           text={textContent} 
34 |           className="absolute top-2 right-2 opacity-0 group-hover/codeblock:opacity-100 transition-opacity"
35 |         />
36 |       </div>
37 |     );
38 |   },
39 |   code: ({ children, className, ...props }: React.HTMLProps<HTMLElement> & { className?: string }) => {
40 |     const match = /language-(\w+)/.exec(className || '');
41 |     const isInline = !match && !className;
42 | 
43 |     if (isInline) {
44 |       return (
45 |         <code
46 |           className="px-1 py-0.5 rounded-md bg-zinc-100 dark:bg-zinc-800/50 black:bg-zinc-800/50 text-zinc-700 dark:text-zinc-300 black:text-zinc-300 text-[0.9em] font-mono"
47 |           {...props}
48 |         >
49 |           {children}
50 |         </code>
51 |       );
52 |     }
53 |     return (
54 |       <code className={cn("block font-mono text-sm whitespace-pre-wrap break-words max-w-full", className)} {...props}>
55 |         {children}
56 |       </code>
57 |     );
58 |   },
59 |   ol: ({ node, children, ...props }) => (
60 |     <ol className="list-decimal list-outside ml-6 pl-2 space-y-0.5 my-1.5" {...props}>
61 |       {children}
62 |     </ol>
63 |   ),
64 |   ul: ({ node, children, ...props }) => (
65 |     <ul className="list-disc list-outside ml-6 pl-2 space-y-0.5 my-1.5" {...props}>
66 |       {children}
67 |     </ul>
68 |   ),
69 |   li: ({ node, children, ...props }) => (
70 |     <li className="leading-normal" {...props}>
71 |       {children}
72 |     </li>
73 |   ),
74 |   p: ({ node, children, ...props }) => (
75 |     <p className="leading-relaxed my-1" {...props}>
76 |       {children}
77 |     </p>
78 |   ),
79 |   strong: ({ node, children, ...props }) => (
80 |     <strong className="font-semibold" {...props}>
81 |       {children}
82 |     </strong>
83 |   ),
84 |   em: ({ node, children, ...props }) => (
85 |     <em className="italic" {...props}>
86 |       {children}
87 |     </em>
88 |   ),
89 |   blockquote: ({ node, children, ...props }) => (
90 |     <blockquote
91 |       className="border-l-2 border-zinc-200 dark:border-zinc-700 black:border-zinc-700 pl-3 my-1.5 italic text-zinc-600 dark:text-zinc-400 black:text-zinc-400"
92 |       {...props}
93 |     >
94 |       {children}
95 |     </blockquote>
96 |   ),
97 |   a: ({ node, href, children, ...props }) => {
98 |     const isInternal = href && (href.startsWith("/") || href.startsWith("#"));
99 |     if (isInternal) {
100 |       return (
101 |         <Link href={href} {...props}>
102 |           {children}
103 |         </Link>
104 |       );
105 |     }
106 |     return (
107 |       <a
108 |         href={href}
109 |         target="_blank"
110 |         rel="noopener noreferrer"
111 |         {...props}
112 |         className="text-blue-500 hover:underline hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 black:text-blue-400 black:hover:text-blue-300 transition-colors"
113 |       >
114 |         {children}
115 |       </a>
116 |     );
117 |   },
118 |   h1: ({ node, children, ...props }) => (
119 |     <h1
120 |       className="text-2xl font-semibold mt-3 mb-1.5 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100"
121 |       {...props}
122 |     >
123 |       {children}
124 |     </h1>
125 |   ),
126 |   h2: ({ node, children, ...props }) => (
127 |     <h2
128 |       className="text-xl font-semibold mt-2.5 mb-1.5 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100"
129 |       {...props}
130 |     >
131 |       {children}
132 |     </h2>
133 |   ),
134 |   h3: ({ node, children, ...props }) => (
135 |     <h3
136 |       className="text-lg font-semibold mt-2 mb-1 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100"
137 |       {...props}
138 |     >
139 |       {children}
140 |     </h3>
141 |   ),
142 |   h4: ({ node, children, ...props }) => (
143 |     <h4
144 |       className="text-base font-semibold mt-2 mb-1 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100"
145 |       {...props}
146 |     >
147 |       {children}
148 |     </h4>
149 |   ),
150 |   h5: ({ node, children, ...props }) => (
151 |     <h5
152 |       className="text-sm font-semibold mt-2 mb-1 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100"
153 |       {...props}
154 |     >
155 |       {children}
156 |     </h5>
157 |   ),
158 |   h6: ({ node, children, ...props }) => (
159 |     <h6
160 |       className="text-xs font-semibold mt-2 mb-0.5 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100"
161 |       {...props}
162 |     >
163 |       {children}
164 |     </h6>
165 |   ),
166 |   table: ({ node, children, ...props }) => (
167 |     <div className="my-1.5 overflow-x-auto">
168 |       <table className="min-w-full divide-y divide-zinc-200 dark:divide-zinc-700 black:divide-zinc-700" {...props}>
169 |         {children}
170 |       </table>
171 |     </div>
172 |   ),
173 |   thead: ({ node, children, ...props }) => (
174 |     <thead className="bg-zinc-50 dark:bg-zinc-800/50 black:bg-zinc-800/50" {...props}>
175 |       {children}
176 |     </thead>
177 |   ),
178 |   tbody: ({ node, children, ...props }) => (
179 |     <tbody className="divide-y divide-zinc-200 dark:divide-zinc-700 black:divide-zinc-700 bg-white dark:bg-transparent black:bg-transparent" {...props}>
180 |       {children}
181 |     </tbody>
182 |   ),
183 |   tr: ({ node, children, ...props }) => (
184 |     <tr className="transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-800/30 black:hover:bg-zinc-800/30" {...props}>
185 |       {children}
186 |     </tr>
187 |   ),
188 |   th: ({ node, children, ...props }) => (
189 |     <th
190 |       className="px-3 py-1.5 text-left text-xs font-medium text-zinc-500 dark:text-zinc-400 black:text-zinc-400 uppercase tracking-wider"
191 |       {...props}
192 |     >
193 |       {children}
194 |     </th>
195 |   ),
196 |   td: ({ node, children, ...props }) => (
197 |     <td className="px-3 py-1.5 text-sm" {...props}>
198 |       {children}
199 |     </td>
200 |   ),
201 |   hr: ({ node, ...props }) => (
202 |     <hr className="my-1.5 border-zinc-200 dark:border-zinc-700 black:border-zinc-700" {...props} />
203 |   ),
204 | };
205 | 
206 | const remarkPlugins = [remarkGfm, remarkMath];
207 | const rehypePlugins = [rehypeKatex];
208 | 
209 | // Preprocesses markdown to convert \(...\) to $...$ and \[...\] to $...$
210 | function preprocessMathDelimiters(markdown: string): string {
211 |   // Handle null, undefined, or non-string input
212 |   if (!markdown || typeof markdown !== 'string') {
213 |     return '';
214 |   }
215 |   
216 |   // Convert block math: \[...\] => $...$
217 |   markdown = markdown.replace(/\\\[([\s\S]+?)\\\]/g, (match, p1) => `$${p1}$`);
218 |   // Convert inline math: \(...\) => $...$
219 |   markdown = markdown.replace(/\\\(([\s\S]+?)\\\)/g, (match, p1) => `${p1}You are a senior developer. You produce optimized, maintainable code that follows best practices. 

Your task is to review the current codebase and fix the current issues.

Current Issue:
<issue>
{{MESSAGE}}
</issue>

Rules:
- Keep your suggestions concise and focused. Avoid unnecessary explanations or fluff. 
- Your output should be a series of specific, actionable changes.

When approaching this task:
1. Carefully review the provided code.
2. Identify the area thats raising this issue or error and provide a fix.
3. Consider best practices for the specific programming language used.

For each suggested change, provide:
1. A short description of the change (one line maximum).
2. The modified code block.

Use the following format for your output:

[Short Description]
```[language]:[path/to/file]
[code block]
```

Begin fixing the codebase provide your solutions.

My current codebase:
<current_codebase>
);
220 |   return markdown;
221 | }
222 | 
223 | const NonMemoizedMarkdown = ({ children }: { children: string }) => {
224 |   const processed = preprocessMathDelimiters(children);
225 |   return (
226 |     <div className="overflow-x-auto max-w-full">
227 |       <ReactMarkdown 
228 |         remarkPlugins={remarkPlugins} 
229 |         rehypePlugins={rehypePlugins}
230 |         components={components}
231 |       >
232 |         {processed}
233 |       </ReactMarkdown>
234 |     </div>
235 |   );
236 | };
237 | 
238 | export const Markdown = memo(
239 |   NonMemoizedMarkdown,
240 |   (prevProps, nextProps) => prevProps.children === nextProps.children,
241 | );
```

components/mcp-server-manager.tsx
```
1 | "use client";
2 | 
3 | import { useState } from "react";
4 | import {
5 |     Dialog,
6 |     DialogContent,
7 |     DialogDescription,
8 |     DialogHeader,
9 |     DialogTitle
10 | } from "./ui/dialog";
11 | import { Button } from "./ui/button";
12 | import { Input } from "./ui/input";
13 | import { Label } from "./ui/label";
14 | import {
15 |     PlusCircle,
16 |     ServerIcon,
17 |     X,
18 |     Terminal,
19 |     Globe,
20 |     ExternalLink,
21 |     Trash2,
22 |     CheckCircle,
23 |     Plus,
24 |     Cog,
25 |     Edit2,
26 |     Eye,
27 |     EyeOff,
28 |     Check,
29 |     AlertCircle,
30 |     Wifi
31 | } from "lucide-react";
32 | import { toast } from "sonner";
33 | import {
34 |     Accordion,
35 |     AccordionContent,
36 |     AccordionItem,
37 |     AccordionTrigger
38 | } from "./ui/accordion";
39 | import { KeyValuePair, MCPServer } from "@/lib/context/mcp-context";
40 | 
41 | // Default template for a new MCP server
42 | const INITIAL_NEW_SERVER: Omit<MCPServer, 'id'> = {
43 |     name: '',
44 |     title: '',
45 |     url: '',
46 |     type: 'sse',
47 |     command: 'node',
48 |     args: [],
49 |     env: [],
50 |     headers: []
51 | };
52 | 
53 | interface MCPServerManagerProps {
54 |     servers: MCPServer[];
55 |     onServersChange: (servers: MCPServer[]) => void;
56 |     selectedServers: string[];
57 |     onSelectedServersChange: (serverIds: string[]) => void;
58 |     open: boolean;
59 |     onOpenChange: (open: boolean) => void;
60 | }
61 | 
62 | // Check if a key name might contain sensitive information
63 | const isSensitiveKey = (key: string): boolean => {
64 |     const sensitivePatterns = [
65 |         /key/i, 
66 |         /token/i, 
67 |         /secret/i, 
68 |         /password/i, 
69 |         /pass/i,
70 |         /auth/i,
71 |         /credential/i
72 |     ];
73 |     return sensitivePatterns.some(pattern => pattern.test(key));
74 | };
75 | 
76 | // Mask a sensitive value
77 | const maskValue = (value: string): string => {
78 |     if (!value) return '';
79 |     if (value.length < 8) return '••••••';
80 |     return value.substring(0, 3) + '•'.repeat(Math.min(10, value.length - 4)) + value.substring(value.length - 1);
81 | };
82 | 
83 | export const MCPServerManager = ({
84 |     servers,
85 |     onServersChange,
86 |     selectedServers,
87 |     onSelectedServersChange,
88 |     open,
89 |     onOpenChange
90 | }: MCPServerManagerProps) => {
91 |     const [newServer, setNewServer] = useState<Omit<MCPServer, 'id'>>(INITIAL_NEW_SERVER);
92 |     const [view, setView] = useState<'list' | 'add'>('list');
93 |     const [newEnvVar, setNewEnvVar] = useState<KeyValuePair>({ key: '', value: '' });
94 |     const [newHeader, setNewHeader] = useState<KeyValuePair>({ key: '', value: '' });
95 |     const [editingServerId, setEditingServerId] = useState<string | null>(null);
96 |     const [showSensitiveEnvValues, setShowSensitiveEnvValues] = useState<Record<number, boolean>>({});
97 |     const [showSensitiveHeaderValues, setShowSensitiveHeaderValues] = useState<Record<number, boolean>>({});
98 |     const [editingEnvIndex, setEditingEnvIndex] = useState<number | null>(null);
99 |     const [editingHeaderIndex, setEditingHeaderIndex] = useState<number | null>(null);
100 |     const [editedEnvValue, setEditedEnvValue] = useState<string>('');
101 |     const [editedHeaderValue, setEditedHeaderValue] = useState<string>('');
102 |     const [testingServerId, setTestingServerId] = useState<string | null>(null);
103 |     const [testResults, setTestResults] = useState<Record<string, { success: boolean; message: string }>>({});
104 | 
105 |     const resetAndClose = () => {
106 |         setView('list');
107 |         setNewServer(INITIAL_NEW_SERVER);
108 |         setNewEnvVar({ key: '', value: '' });
109 |         setNewHeader({ key: '', value: '' });
110 |         setShowSensitiveEnvValues({});
111 |         setShowSensitiveHeaderValues({});
112 |         setEditingEnvIndex(null);
113 |         setEditingHeaderIndex(null);
114 |         onOpenChange(false);
115 |     };
116 | 
117 |     const addServer = () => {
118 |         if (!newServer.name) {
119 |             toast.error("Server name is required");
120 |             return;
121 |         }
122 | 
123 |         if (newServer.type === 'sse' && !newServer.url) {
124 |             toast.error("Server URL is required for SSE transport");
125 |             return;
126 |         }
127 | 
128 |         if (newServer.type === 'streamable-http' && !newServer.url) {
129 |             toast.error("Server URL is required for Streamable HTTP transport");
130 |             return;
131 |         }
132 | 
133 |         if (newServer.type === 'stdio' && (!newServer.command || !newServer.args?.length)) {
134 |             toast.error("Command and at least one argument are required for stdio transport");
135 |             return;
136 |         }
137 | 
138 |         const id = crypto.randomUUID();
139 |         const updatedServers = [...servers, { ...newServer, id }];
140 |         onServersChange(updatedServers);
141 | 
142 |         toast.success(`Added MCP server: ${newServer.name}`);
143 |         setView('list');
144 |         setNewServer(INITIAL_NEW_SERVER);
145 |         setNewEnvVar({ key: '', value: '' });
146 |         setNewHeader({ key: '', value: '' });
147 |         setShowSensitiveEnvValues({});
148 |         setShowSensitiveHeaderValues({});
149 |         // Clear temporary test results
150 |         setTestResults(prev => {
151 |             const newResults = { ...prev };
152 |             delete newResults['temp'];
153 |             return newResults;
154 |         });
155 |     };
156 | 
157 |     const removeServer = (id: string, e: React.MouseEvent) => {
158 |         e.stopPropagation();
159 |         const updatedServers = servers.filter(server => server.id !== id);
160 |         onServersChange(updatedServers);
161 | 
162 |         // If the removed server was selected, remove it from selected servers
163 |         if (selectedServers.includes(id)) {
164 |             onSelectedServersChange(selectedServers.filter(serverId => serverId !== id));
165 |         }
166 | 
167 |         toast.success("Server removed");
168 |     };
169 | 
170 |     const toggleServer = (id: string) => {
171 |         if (selectedServers.includes(id)) {
172 |             // Remove from selected servers
173 |             onSelectedServersChange(selectedServers.filter(serverId => serverId !== id));
174 |             const server = servers.find(s => s.id === id);
175 |             if (server) {
176 |                 toast.success(`Disabled MCP server: ${server.name}`);
177 |             }
178 |         } else {
179 |             // Add to selected servers
180 |             onSelectedServersChange([...selectedServers, id]);
181 |             const server = servers.find(s => s.id === id);
182 |             if (server) {
183 |                 toast.success(`Enabled MCP server: ${server.name}`);
184 |             }
185 |         }
186 |     };
187 | 
188 |     const clearAllServers = () => {
189 |         if (selectedServers.length > 0) {
190 |             onSelectedServersChange([]);
191 |             toast.success("All MCP servers disabled");
192 |             resetAndClose();
193 |         }
194 |     };
195 | 
196 |     const testConnection = async (server: MCPServer) => {
197 |         setTestingServerId(server.id);
198 |         
199 |         try {
200 |             // For SSE and Streamable HTTP transports, we test URL validity and basic configuration
201 |             if (server.type === 'sse' || server.type === 'streamable-http') {
202 |                 if (!server.url) {
203 |                     throw new Error("Server URL is required");
204 |                 }
205 |                 
206 |                 // Validate URL format
207 |                 try {
208 |                     new URL(server.url);
209 |                 } catch (urlError) {
210 |                     throw new Error("Invalid URL format");
211 |                 }
212 |                 
213 |                 // For HTTP-based MCP servers, we validate configuration rather than test actual connection
214 |                 // since MCP has its own protocol handshake that simple HTTP requests can't handle
215 |                 setTestResults(prev => ({
216 |                     ...prev,
217 |                     [server.id]: { 
218 |                         success: true, 
219 |                         message: "Configuration valid (connection will be tested when tools are used)" 
220 |                     }
221 |                 }));
222 |             } 
223 |             // For stdio transport, we can't test directly from the browser
224 |             else if (server.type === 'stdio') {
225 |                 // Validate that we have a command and arguments
226 |                 if (!server.command) {
227 |                     throw new Error("Command is required for stdio transport");
228 |                 }
229 |                 
230 |                 if (!server.args || server.args.length === 0) {
231 |                     throw new Error("At least one argument is required for stdio transport");
232 |                 }
233 |                 
234 |                 setTestResults(prev => ({
235 |                     ...prev,
236 |                     [server.id]: { 
237 |                         success: true, 
238 |                         message: "Configuration valid (connection test happens on server)" 
239 |                     }
240 |                 }));
241 |             }
242 |             
243 |             toast.success(`Configuration test passed for ${server.name}`);
244 |         } catch (error) {
245 |             const errorMessage = error instanceof Error ? error.message : "Unknown error occurred";
246 |             setTestResults(prev => ({
247 |                 ...prev,
248 |                 [server.id]: { 
249 |                     success: false, 
250 |                     message: errorMessage 
251 |                 }
252 |             }));
253 |             
254 |             toast.error(`Configuration test failed for ${server.name}: ${errorMessage}`);
255 |         } finally {
256 |             setTestingServerId(null);
257 |         }
258 |     };
259 | 
260 |     const handleArgsChange = (value: string) => {
261 |         try {
262 |             // Try to parse as JSON if it starts with [ (array)
263 |             const argsArray = value.trim().startsWith('[')
264 |                 ? JSON.parse(value)
265 |                 : value.split(' ').filter(Boolean);
266 | 
267 |             setNewServer({ ...newServer, args: argsArray });
268 |         } catch (error) {
269 |             // If parsing fails, just split by spaces
270 |             setNewServer({ ...newServer, args: value.split(' ').filter(Boolean) });
271 |         }
272 |     };
273 | 
274 |     const addEnvVar = () => {
275 |         if (!newEnvVar.key) return;
276 | 
277 |         setNewServer({
278 |             ...newServer,
279 |             env: [...(newServer.env || []), { ...newEnvVar }]
280 |         });
281 | 
282 |         setNewEnvVar({ key: '', value: '' });
283 |     };
284 | 
285 |     const removeEnvVar = (index: number) => {
286 |         const updatedEnv = [...(newServer.env || [])];
287 |         updatedEnv.splice(index, 1);
288 |         setNewServer({ ...newServer, env: updatedEnv });
289 |         
290 |         // Clean up visibility state for this index
291 |         const updatedVisibility = { ...showSensitiveEnvValues };
292 |         delete updatedVisibility[index];
293 |         setShowSensitiveEnvValues(updatedVisibility);
294 |         
295 |         // If currently editing this value, cancel editing
296 |         if (editingEnvIndex === index) {
297 |             setEditingEnvIndex(null);
298 |         }
299 |     };
300 | 
301 |     const startEditEnvValue = (index: number, value: string) => {
302 |         setEditingEnvIndex(index);
303 |         setEditedEnvValue(value);
304 |     };
305 | 
306 |     const saveEditedEnvValue = () => {
307 |         if (editingEnvIndex !== null) {
308 |             const updatedEnv = [...(newServer.env || [])];
309 |             updatedEnv[editingEnvIndex] = {
310 |                 ...updatedEnv[editingEnvIndex],
311 |                 value: editedEnvValue
312 |             };
313 |             setNewServer({ ...newServer, env: updatedEnv });
314 |             setEditingEnvIndex(null);
315 |         }
316 |     };
317 | 
318 |     const addHeader = () => {
319 |         if (!newHeader.key) return;
320 | 
321 |         setNewServer({
322 |             ...newServer,
323 |             headers: [...(newServer.headers || []), { ...newHeader }]
324 |         });
325 | 
326 |         setNewHeader({ key: '', value: '' });
327 |     };
328 | 
329 |     const removeHeader = (index: number) => {
330 |         const updatedHeaders = [...(newServer.headers || [])];
331 |         updatedHeaders.splice(index, 1);
332 |         setNewServer({ ...newServer, headers: updatedHeaders });
333 |         
334 |         // Clean up visibility state for this index
335 |         const updatedVisibility = { ...showSensitiveHeaderValues };
336 |         delete updatedVisibility[index];
337 |         setShowSensitiveHeaderValues(updatedVisibility);
338 |         
339 |         // If currently editing this value, cancel editing
340 |         if (editingHeaderIndex === index) {
341 |             setEditingHeaderIndex(null);
342 |         }
343 |     };
344 | 
345 |     const startEditHeaderValue = (index: number, value: string) => {
346 |         setEditingHeaderIndex(index);
347 |         setEditedHeaderValue(value);
348 |     };
349 | 
350 |     const saveEditedHeaderValue = () => {
351 |         if (editingHeaderIndex !== null) {
352 |             const updatedHeaders = [...(newServer.headers || [])];
353 |             updatedHeaders[editingHeaderIndex] = {
354 |                 ...updatedHeaders[editingHeaderIndex],
355 |                 value: editedHeaderValue
356 |             };
357 |             setNewServer({ ...newServer, headers: updatedHeaders });
358 |             setEditingHeaderIndex(null);
359 |         }
360 |     };
361 | 
362 |     const toggleSensitiveEnvValue = (index: number) => {
363 |         setShowSensitiveEnvValues(prev => ({
364 |             ...prev,
365 |             [index]: !prev[index]
366 |         }));
367 |     };
368 | 
369 |     const toggleSensitiveHeaderValue = (index: number) => {
370 |         setShowSensitiveHeaderValues(prev => ({
371 |             ...prev,
372 |             [index]: !prev[index]
373 |         }));
374 |     };
375 | 
376 |     const hasAdvancedConfig = (server: MCPServer) => {
377 |         return (server.env && server.env.length > 0) ||
378 |             (server.headers && server.headers.length > 0);
379 |     };
380 | 
381 |     // Editing support
382 |     const startEditing = (server: MCPServer) => {
383 |         setEditingServerId(server.id);
384 |         setNewServer({
385 |             name: server.name,
386 |             title: server.title,
387 |             url: server.url,
388 |             type: server.type,
389 |             command: server.command,
390 |             args: server.args,
391 |             env: server.env,
392 |             headers: server.headers
393 |         });
394 |         setView('add');
395 |         // Reset sensitive value visibility states
396 |         setShowSensitiveEnvValues({});
397 |         setShowSensitiveHeaderValues({});
398 |         setEditingEnvIndex(null);
399 |         setEditingHeaderIndex(null);
400 |         // Clear test results for this server
401 |         setTestResults(prev => {
402 |             const newResults = { ...prev };
403 |             delete newResults[server.id];
404 |             return newResults;
405 |         });
406 |     };
407 | 
408 |     const handleFormCancel = () => {
409 |         if (view === 'add') {
410 |             setView('list');
411 |             setEditingServerId(null);
412 |             setNewServer(INITIAL_NEW_SERVER);
413 |             setShowSensitiveEnvValues({});
414 |             setShowSensitiveHeaderValues({});
415 |             setEditingEnvIndex(null);
416 |             setEditingHeaderIndex(null);
417 |             // Clear temporary test results
418 |             setTestResults(prev => {
419 |                 const newResults = { ...prev };
420 |                 delete newResults['temp'];
421 |                 return newResults;
422 |             });
423 |         } else {
424 |             resetAndClose();
425 |         }
426 |     };
427 | 
428 |     const updateServer = () => {
429 |         if (!newServer.name) {
430 |             toast.error("Server name is required");
431 |             return;
432 |         }
433 |         if (newServer.type === 'sse' && !newServer.url) {
434 |             toast.error("Server URL is required for SSE transport");
435 |             return;
436 |         }
437 |         if (newServer.type === 'streamable-http' && !newServer.url) {
438 |             toast.error("Server URL is required for Streamable HTTP transport");
439 |             return;
440 |         }
441 |         if (newServer.type === 'stdio' && (!newServer.command || !newServer.args?.length)) {
442 |             toast.error("Command and at least one argument are required for stdio transport");
443 |             return;
444 |         }
445 |         const updated = servers.map(s =>
446 |             s.id === editingServerId ? { ...newServer, id: editingServerId! } : s
447 |         );
448 |         onServersChange(updated);
449 |         toast.success(`Updated MCP server: ${newServer.name}`);
450 |         setView('list');
451 |         setEditingServerId(null);
452 |         setNewServer(INITIAL_NEW_SERVER);
453 |         setShowSensitiveEnvValues({});
454 |         setShowSensitiveHeaderValues({});
455 |         // Clear temporary test results
456 |         setTestResults(prev => {
457 |             const newResults = { ...prev };
458 |             delete newResults['temp'];
459 |             return newResults;
460 |         });
461 |     };
462 | 
463 |     return (
464 |         <Dialog open={open} onOpenChange={onOpenChange}>
465 |             <DialogContent className="max-w-[95vw] sm:max-w-md lg:max-w-[480px] max-h-[90vh] flex flex-col p-0">
466 |                 <DialogHeader className="p-4 sm:p-6 pb-3 sm:pb-4 shrink-0">
467 |                     <DialogTitle className="flex items-center gap-2 text-base sm:text-lg">
468 |                         <ServerIcon className="h-4 w-4 sm:h-5 sm:w-5 text-primary shrink-0" />
469 |                         MCP Server Configuration
470 |                     </DialogTitle>
471 |                     <DialogDescription className="text-sm">
472 |                         Connect to Model Context Protocol servers to access additional AI tools.
473 |                         {selectedServers.length > 0 && (
474 |                             <span className="block mt-1 text-xs font-medium text-primary">
475 |                                 {selectedServers.length} server{selectedServers.length !== 1 ? 's' : ''} currently active
476 |                             </span>
477 |                         )}
478 |                     </DialogDescription>
479 |                 </DialogHeader>
480 | 
481 |                 {view === 'list' ? (
482 |                     <>
483 |                         <div className="flex-1 overflow-hidden flex flex-col min-h-0">
484 |                             {servers.length > 0 ? (
485 |                                 <div className="flex-1 overflow-hidden flex flex-col min-h-0 px-4 sm:px-6">
486 |                                     <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 gap-2 shrink-0">
487 |                                         <h3 className="text-sm font-medium">Available Servers</h3>
488 |                                         <span className="text-xs text-muted-foreground">
489 |                                             Select multiple servers to combine their tools
490 |                                         </span>
491 |                                     </div>
492 |                                     <div className="flex-1 overflow-y-auto -webkit-overflow-scrolling-touch min-h-0">
493 |                                         <div className="space-y-2.5 pb-2">
494 |                                             {servers
495 |                                                 .sort((a, b) => {
496 |                                                     const aActive = selectedServers.includes(a.id);
497 |                                                     const bActive = selectedServers.includes(b.id);
498 |                                                     if (aActive && !bActive) return -1;
499 |                                                     if (!aActive && bActive) return 1;
500 |                                                     return 0;
501 |                                                 })
502 |                                                 .map((server) => {
503 |                                                 const isActive = selectedServers.includes(server.id);
504 |                                                 return (
505 |                                                     <div
506 |                                                         key={server.id}
507 |                                                         className={`
508 |                                 relative flex flex-col p-3.5 rounded-xl transition-colors
509 |                                 border ${isActive
510 |                                                                 ? 'border-primary bg-primary/10'
511 |                                                                 : 'border-border hover:border-primary/30 hover:bg-primary/5'}
512 |                               `}
513 |                                                     >
514 |                                                     {/* Server Header with Type Badge and Delete Button */}
515 |                                                     <div className="flex items-center justify-between mb-2">
516 |                                                         <div className="flex items-center gap-2 flex-1 min-w-0">
517 |                                                             {server.type === 'sse' ? (
518 |                                                                 <Globe className={`h-4 w-4 ${isActive ? 'text-primary' : 'text-muted-foreground'} flex-shrink-0`} />
519 |                                                             ) : (
520 |                                                                 <Terminal className={`h-4 w-4 ${isActive ? 'text-primary' : 'text-muted-foreground'} flex-shrink-0`} />
521 |                                                             )}
522 |                                                             <h4 className="text-sm font-medium truncate">{server.name}</h4>
523 |                                                             {hasAdvancedConfig(server) && (
524 |                                                                 <span className="flex-shrink-0">
525 |                                                                     <Cog className="h-3 w-3 text-muted-foreground" />
526 |                                                                 </span>
527 |                                                             )}
528 |                                                         </div>
529 |                                                         <div className="flex items-center gap-1 shrink-0">
530 |                                                              <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-secondary text-secondary-foreground shrink-0 font-medium">
531 |                                                                  {server.type === 'streamable-http' ? 'S-HTTP' : server.type.toUpperCase()}
532 |                                                              </span>
533 |                                                              <button
534 |                                                                   onClick={(e) => {
535 |                                                                       e.stopPropagation();
536 |                                                                       testConnection(server);
537 |                                                                   }}
538 |                                                                   className="p-1 rounded-full hover:bg-muted/70 shrink-0"
539 |                                                                   aria-label="Test connection"
540 |                                                                   disabled={testingServerId === server.id}
541 |                                                               >
542 |                                                                   {testingServerId === server.id ? (
543 |                                                                       <div className="h-3.5 w-3.5 animate-spin rounded-full border-2 border-current border-t-transparent" />
544 |                                                                   ) : (
545 |                                                                       <Wifi className="h-3.5 w-3.5 text-muted-foreground" />
546 |                                                                   )}
547 |                                                               </button>
548 |                                                              <button
549 |                                                                  onClick={(e) => removeServer(server.id, e)}
550 |                                                                  className="p-1 rounded-full hover:bg-muted/70 shrink-0"
551 |                                                                  aria-label="Remove server"
552 |                                                              >
553 |                                                                  <Trash2 className="h-3.5 w-3.5 text-muted-foreground" />
554 |                                                              </button>
555 |                                                              <button
556 |                                                                  onClick={() => startEditing(server)}
557 |                                                                  className="p-1 rounded-full hover:bg-muted/50 shrink-0"
558 |                                                                  aria-label="Edit server"
559 |                                                              >
560 |                                                                  <Edit2 className="h-3.5 w-3.5 text-muted-foreground" />
561 |                                                              </button>
562 |                                                         </div>
563 |                                                     </div>
564 | 
565 |                                                     {/* Server Details */}
[TRUNCATED]
```

components/message.tsx
```
1 | "use client";
2 | 
3 | import type { Message as TMessage } from "ai";
4 | import { AnimatePresence, motion } from "framer-motion";
5 | import { memo, useCallback, useEffect, useState } from "react";
6 | import equal from "fast-deep-equal";
7 | import { Markdown } from "./markdown";
8 | import { cn } from "@/lib/utils";
9 | import { ChevronDownIcon, ChevronUpIcon, LightbulbIcon, BrainIcon } from "lucide-react";
10 | import { SpinnerIcon } from "./icons";
11 | import { ToolInvocation } from "./tool-invocation";
12 | import { CopyButton } from "./copy-button";
13 | import { Citations } from "./citation";
14 | import type { TextUIPart, ToolInvocationUIPart, ImageUIPart } from "@/lib/types";
15 | import type { ReasoningUIPart, SourceUIPart, FileUIPart, StepStartUIPart } from "@ai-sdk/ui-utils";
16 | import { formatFileSize } from "@/lib/image-utils";
17 | import { WebSearchSuggestion } from "./web-search-suggestion";
18 | import { ImageModal } from "./image-modal";
19 | 
20 | interface ReasoningPart {
21 |   type: "reasoning";
22 |   reasoning: string;
23 |   details: Array<{ type: "text"; text: string }>;
24 | }
25 | 
26 | interface ReasoningMessagePartProps {
27 |   part: ReasoningUIPart;
28 |   isReasoning: boolean;
29 | }
30 | 
31 | export function ReasoningMessagePart({
32 |   part,
33 |   isReasoning,
34 | }: ReasoningMessagePartProps) {
35 |   const [isExpanded, setIsExpanded] = useState(false);
36 | 
37 |   const memoizedSetIsExpanded = useCallback((value: boolean) => {
38 |     setIsExpanded(value);
39 |   }, []);
40 | 
41 |   useEffect(() => {
42 |     memoizedSetIsExpanded(isReasoning);
43 |   }, [isReasoning, memoizedSetIsExpanded]);
44 | 
45 |   return (
46 |     <div className="flex flex-col mb-2 group">
47 |       {isReasoning ? (
48 |         <div className={cn(
49 |           "flex items-center gap-2.5 rounded-full py-1.5 px-3",
50 |           "bg-indigo-50/50 dark:bg-indigo-900/10 text-indigo-700 dark:text-indigo-300",
51 |           "border border-indigo-200/50 dark:border-indigo-700/20 w-fit"
52 |         )}>
53 |           <div className="animate-spin h-3.5 w-3.5">
54 |             <SpinnerIcon />
55 |           </div>
56 |           <div className="text-xs font-medium tracking-tight">Thinking...</div>
57 |         </div>
58 |       ) : (
59 |         <button 
60 |           onClick={() => setIsExpanded(!isExpanded)}
61 |           className={cn(
62 |             "flex items-center justify-between w-full",
63 |             "rounded-md py-2 px-3 mb-0.5",
64 |             "bg-muted/50 border border-border/60 hover:border-border/80",
65 |             "transition-all duration-150 cursor-pointer",
66 |             isExpanded ? "bg-muted border-primary/20" : ""
67 |           )}
68 |         >
69 |           <div className="flex items-center gap-2.5">
70 |             <div className={cn(
71 |               "flex items-center justify-center w-6 h-6 rounded-full",
72 |               "bg-amber-50 dark:bg-amber-900/20",
73 |               "text-amber-600 dark:text-amber-400 ring-1 ring-amber-200 dark:ring-amber-700/30",
74 |             )}>
75 |               <LightbulbIcon className="h-3.5 w-3.5" />
76 |             </div>
77 |             <div className="text-sm font-medium text-foreground flex items-center gap-1.5">
78 |               Reasoning
79 |               <span className="text-xs text-muted-foreground font-normal">
80 |                 (click to {isExpanded ? "hide" : "view"})
81 |               </span>
82 |             </div>
83 |           </div>
84 |           <div className={cn(
85 |             "flex items-center justify-center",
86 |             "rounded-full p-0.5 w-5 h-5",
87 |             "text-muted-foreground hover:text-foreground",
88 |             "bg-background/80 border border-border/50",
89 |             "transition-colors",
90 |           )}>
91 |             {isExpanded ? (
92 |               <ChevronDownIcon className="h-3 w-3" />
93 |             ) : (
94 |               <ChevronUpIcon className="h-3 w-3" />
95 |             )}
96 |           </div>
97 |         </button>
98 |       )}
99 | 
100 |       <AnimatePresence initial={false}>
101 |         {isExpanded && (
102 |           <motion.div
103 |             key="reasoning"
104 |             className={cn(
105 |               "text-sm text-muted-foreground flex flex-col gap-2",
106 |               "pl-3.5 ml-0.5 mt-1",
107 |               "border-l border-amber-200/50 dark:border-amber-700/30"
108 |             )}
109 |             initial={{ height: 0, opacity: 0 }}
110 |             animate={{ height: "auto", opacity: 1 }}
111 |             exit={{ height: 0, opacity: 0 }}
112 |             transition={{ duration: 0.2, ease: "easeInOut" }}
113 |           >
114 |             <div className="text-xs text-muted-foreground/70 pl-1 font-medium">
115 |               The assistant&apos;s thought process:
116 |             </div>
117 |             {part.details.map((detail, detailIndex) =>
118 |               detail.type === "text" ? (
119 |                 <div key={detailIndex} className="px-2 py-1.5 bg-muted/10 rounded-md border border-border/30">
120 |                   <Markdown>{detail.text}</Markdown>
121 |                 </div>
122 |               ) : (
123 |                 "<redacted>"
124 |               ),
125 |             )}
126 |           </motion.div>
127 |         )}
128 |       </AnimatePresence>
129 |     </div>
130 |   );
131 | }
132 | 
133 | interface MessageProps {
134 |   message: TMessage & {
135 |     parts?: Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>;
136 |     hasWebSearch?: boolean;
137 |   };
138 |   isLoading: boolean;
139 |   status: "error" | "submitted" | "streaming" | "ready";
140 |   isLatestMessage: boolean;
141 | }
142 | 
143 | const PurePreviewMessage = ({
144 |   message,
145 |   isLatestMessage,
146 |   status,
147 |   isLoading,
148 | }: MessageProps) => {
149 |   // State for image modal
150 |   const [selectedImage, setSelectedImage] = useState<{
151 |     url: string;
152 |     metadata?: ImageUIPart['metadata'];
153 |     detail?: string;
154 |   } | null>(null);
155 | 
156 |   // Create a string with all text parts for copy functionality
157 |   const getMessageText = () => {
158 |     if (!message.parts) return "";
159 |     return message.parts
160 |       .filter(part => part.type === "text")
161 |       .map(part => (part.type === "text" ? part.text : ""))
162 |       .join("\n\n");
163 |   };
164 | 
165 |   // Check if message has web search results - use hasWebSearch flag if available, otherwise detect from parts
166 |   const hasWebSearchResults = message.hasWebSearch || message.parts?.some(part => 
167 |     (part.type === "text" && (part as TextUIPart).citations && (part as TextUIPart).citations!.length > 0) ||
168 |     (part.type === "tool-invocation" && (part as ToolInvocationUIPart).toolInvocation.toolName === "web_search")
169 |   );
170 |   
171 | 
172 | 
173 |   // Only show copy button if the message is from the assistant or user, and not currently streaming
174 |   const shouldShowCopyButton = (message.role === "assistant" || message.role === "user") && (!isLatestMessage || status !== "streaming");
175 | 
176 |   return (
177 |     <AnimatePresence key={message.id}>
178 |       <motion.div
179 |         className={cn(
180 |           "w-full mx-auto px-4 group/message",
181 |           message.role === "assistant" ? "mb-8" : "mb-6"
182 |         )}
183 |         initial={{ y: 5, opacity: 0 }}
184 |         animate={{ y: 0, opacity: 1 }}
185 |         key={`message-${message.id}`}
186 |         data-role={message.role}
187 |       >
188 |         <div
189 |           className={cn(
190 |             "flex gap-4 w-full group-data-[role=user]/message:ml-auto group-data-[role=user]/message:max-w-2xl",
191 |             "group-data-[role=user]/message:w-fit",
192 |           )}
193 |         >
194 |           <div className="flex flex-col w-full space-y-3">
195 |             {/* Render reasoning parts first */}
196 |             {message.parts?.map((part, i) => {
197 |               if ((part as any).type === "reasoning") {
198 |                 const reasoningPart = part as ReasoningUIPart;
199 |                 return (
200 |                   <ReasoningMessagePart
201 |                     key={`message-${message.id}-reasoning-${i}`}
202 |                     part={reasoningPart}
203 |                     isReasoning={
204 |                       (message.parts &&
205 |                         status === "streaming" &&
206 |                         i === message.parts.length - 1) ??
207 |                       false
208 |                     }
209 |                   />
210 |                 );
211 |               }
212 |               return null;
213 |             })}
214 |             
215 |             {/* Render all other parts after reasoning */}
216 |             {message.parts?.map((part, i) => {
217 |               switch ((part as any).type) {
218 |                 case "text":
219 |                   const textPart = part as TextUIPart;
220 |                   return (
221 |                     <motion.div
222 |                       initial={{ y: 5, opacity: 0 }}
223 |                       animate={{ y: 0, opacity: 1 }}
224 |                       key={`message-${message.id}-part-${i}`}
225 |                       className="flex flex-row gap-2 items-start w-full"
226 |                     >
227 |                       <div
228 |                         className={cn("flex flex-col gap-3 w-full", {
229 |                           "bg-secondary text-secondary-foreground px-4 py-3 rounded-2xl flex items-center gap-2":
230 |                             message.role === "user",
231 |                         })}
232 |                       >
233 |                         <Markdown>{textPart.text}</Markdown>
234 |                         {textPart.citations && <Citations citations={textPart.citations} />}
235 |                         {message.role === 'user' && shouldShowCopyButton && (
236 |                           <CopyButton text={getMessageText()} className="ml-auto" />
237 |                         )}
238 |                       </div>
239 |                     </motion.div>
240 |                   );
241 |                 case "tool-invocation":
242 |                   const toolPart = part as ToolInvocationUIPart;
243 |                   const { toolName, state, args } = toolPart.toolInvocation;
244 |                   const result = 'result' in toolPart.toolInvocation ? toolPart.toolInvocation.result : null;
245 |                   
246 |                   return (
247 |                     <ToolInvocation
248 |                       key={`message-${message.id}-part-${i}`}
249 |                       toolName={toolName}
250 |                       state={state}
251 |                       args={args}
252 |                       result={result}
253 |                       isLatestMessage={isLatestMessage}
254 |                       status={status}
255 |                     />
256 |                   );
257 |                 case "image_url":
258 |                   const imagePart = part as any as ImageUIPart;
259 |                   return (
260 |                     <motion.div
261 |                       initial={{ y: 5, opacity: 0 }}
262 |                       animate={{ y: 0, opacity: 1 }}
263 |                       key={`message-${message.id}-part-${i}`}
264 |                       className="flex flex-row gap-2 items-start w-full"
265 |                     >
266 |                       <div className={cn("flex flex-col gap-2", {
267 |                         "bg-secondary text-secondary-foreground px-4 py-3 rounded-2xl":
268 |                           message.role === "user",
269 |                       })}>
270 |                         <img
271 |                           src={imagePart.image_url.url}
272 |                           alt={imagePart.metadata?.filename || "Uploaded image"}
273 |                           className="message-image"
274 |                           loading="lazy"
275 |                           onClick={() => {
276 |                             setSelectedImage({
277 |                               url: imagePart.image_url.url,
278 |                               metadata: imagePart.metadata,
279 |                               detail: imagePart.image_url.detail
280 |                             });
281 |                           }}
282 |                         />
283 |                         {imagePart.metadata && (
284 |                           <div className="text-xs text-muted-foreground mt-1">
285 |                             {imagePart.metadata.filename}
286 |                             {imagePart.metadata.size && (
287 |                               <> • {formatFileSize(imagePart.metadata.size)}</>
288 |                             )}
289 |                             {imagePart.metadata.width && imagePart.metadata.height && (
290 |                               <> • {imagePart.metadata.width}×{imagePart.metadata.height}</>
291 |                             )}
292 |                             {imagePart.image_url.detail && imagePart.image_url.detail !== 'auto' && (
293 |                               <> • {imagePart.image_url.detail} quality</>
294 |                             )}
295 |                           </div>
296 |                         )}
297 |                       </div>
298 |                     </motion.div>
299 |                   );
300 |                 case "reasoning":
301 |                   // Skip reasoning parts as they are rendered above
302 |                   return null;
303 |                 default:
304 |                   return null;
305 |               }
306 |             })}
307 |             
308 |             {/* Web Search Suggestion - only for assistant messages with web search results and when not streaming */}
309 |             {message.role === 'assistant' && hasWebSearchResults && status !== "streaming" && (
310 |               <WebSearchSuggestion 
311 |                 messageId={message.id} 
312 |                 hasWebSearchResults={hasWebSearchResults}
313 |               />
314 |             )}
315 |             
316 |             {message.role === 'assistant' && shouldShowCopyButton && (
317 |               <div className="flex justify-start mt-2">
318 |                 <CopyButton text={getMessageText()} />
319 |               </div>
320 |             )}
321 |           </div>
322 |         </div>
323 |       </motion.div>
324 | 
325 |       {/* Image Modal */}
326 |       {selectedImage && (
327 |         <ImageModal
328 |           isOpen={!!selectedImage}
329 |           onClose={() => setSelectedImage(null)}
330 |           imageUrl={selectedImage.url}
331 |           metadata={selectedImage.metadata}
332 |           detail={selectedImage.detail}
333 |         />
334 |       )}
335 |     </AnimatePresence>
336 |   );
337 | };
338 | 
339 | export const Message = memo(PurePreviewMessage, (prevProps, nextProps) => {
340 |   if (prevProps.status !== nextProps.status) return false;
341 |   if (prevProps.message.annotations !== nextProps.message.annotations)
342 |     return false;
343 |   if (!equal(prevProps.message.parts, nextProps.message.parts)) return false;
344 |   return true;
345 | });
```

components/messages.tsx
```
1 | import type { Message as TMessage } from "ai";
2 | import { Message } from "./message";
3 | import { useScrollToBottom } from "@/lib/hooks/use-scroll-to-bottom";
4 | 
5 | export const Messages = ({
6 |   messages,
7 |   isLoading,
8 |   status,
9 | }: {
10 |   messages: (TMessage & { hasWebSearch?: boolean })[];
11 |   isLoading: boolean;
12 |   status: "error" | "submitted" | "streaming" | "ready";
13 | }) => {
14 |   const [containerRef, endRef] = useScrollToBottom();
15 |   
16 |   return (
17 |     <div
18 |       className="h-full overflow-y-auto no-scrollbar"
19 |       ref={containerRef}
20 |     >
21 |       <div className="max-w-lg sm:max-w-3xl mx-auto py-4">
22 |         {messages.map((m, i) => (
23 |           <Message
24 |             key={i}
25 |             isLatestMessage={i === messages.length - 1}
26 |             isLoading={isLoading}
27 |             message={{
28 |               ...m,
29 |               hasWebSearch: m.hasWebSearch
30 |             }}
31 |             status={status}
32 |           />
33 |         ))}
34 |         <div className="h-1" ref={endRef} />
35 |       </div>
36 |     </div>
37 |   );
38 | };
```

components/model-picker.tsx
```
1 | "use client";
2 | import { useModel } from "@/lib/context/model-context";
3 | import { ModelInfo } from "@/lib/types/models";
4 | import {
5 |   Popover,
6 |   PopoverContent,
7 |   PopoverTrigger,
8 | } from "./ui/popover";
9 | import { cn } from "@/lib/utils";
10 | import { Sparkles, Zap, Info, Bolt, Code, Brain, Lightbulb, Image, Gauge, Rocket, Bot, ChevronDown, Check, RefreshCw, AlertCircle, Star } from "lucide-react";
11 | import { useState, useRef, useEffect, useMemo, useCallback } from "react";
12 | import { useCredits } from "@/hooks/useCredits";
13 | import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
14 | import { useAuth } from "@/hooks/useAuth";
15 | import { Input } from "./ui/input";
16 | import { Button } from "./ui/button";
17 | import { FavoriteToggle } from "./favorite-toggle";
18 | 
19 | // Helper functions for pricing display
20 | function formatPricingDisplay(pricePerToken: number): string {
21 |   const pricePerMillion = pricePerToken * 1000000;
22 |   if (pricePerMillion >= 1) {
23 |     return `${pricePerMillion.toFixed(2)}/M`;
24 |   } else if (pricePerMillion >= 0.01) {
25 |     return `${pricePerMillion.toFixed(3)}/M`;
26 |   } else {
27 |     return `${pricePerMillion.toFixed(4)}/M`;
28 |   }
29 | }
30 | 
31 | function formatContextDisplay(contextMax: number): string {
32 |   return `${contextMax.toLocaleString()} context`;
33 | }
34 | 
35 | interface ModelPickerProps {
36 |   selectedModel: string;
37 |   setSelectedModel: (model: string) => void;
38 |   onModelSelected?: () => void;
39 |   disabled?: boolean; // New prop to disable the picker when preset is active
40 |   activePresetName?: string; // Optional preset name for better messaging
41 | }
42 | 
43 | export const ModelPicker = ({ selectedModel, setSelectedModel, onModelSelected, disabled = false, activePresetName }: ModelPickerProps) => {
44 |   const [hoveredModel, setHoveredModel] = useState<string | null>(null);
45 |   const [focusedModel, setFocusedModel] = useState<string | null>(null); // For touch/tap focus
46 |   const [searchTerm, setSearchTerm] = useState("");
47 |   const [isOpen, setIsOpen] = useState(false);
48 |   const [keyboardFocusedIndex, setKeyboardFocusedIndex] = useState<number>(-1);
49 |   const [activeTab, setActiveTab] = useState<'all' | 'favorites'>('all');
50 |   const searchInputRef = useRef<HTMLInputElement>(null);
51 |   const modelListRef = useRef<HTMLDivElement>(null);
52 |   const { user } = useAuth();
53 |   const { canAccessPremiumModels, loading: creditsLoading } = useCredits(undefined, user?.id);
54 |   
55 |   // Get dynamic models and state from enhanced context
56 |   const { 
57 |     availableModels = [], 
58 |     isLoading: modelsLoading, 
59 |     isRefreshing: modelsRefreshing,
60 |     error: modelsError,
61 |     refresh: refreshModels,
62 |     favorites = [],
63 |     favoriteCount = 0
64 |   } = useModel();
65 |   
66 |   // Function to get the appropriate icon for each provider
67 |   const getProviderIcon = (provider: string) => {
68 |     switch (provider.toLowerCase()) {
69 |       case 'anthropic':
70 |         return <Zap className="h-3 w-3 text-orange-600" />;
71 |       case 'openai':
72 |         return <Zap className="h-3 w-3 text-green-500" />;
73 |       case 'google':
74 |         return <Zap className="h-3 w-3 text-red-500" />;
75 |       case 'groq':
76 |         return <Zap className="h-3 w-3 text-blue-500" />;
77 |       case 'xai':
78 |         return <Zap className="h-3 w-3 text-yellow-500" />;
79 |       case 'openrouter':
80 |         return <Zap className="h-3 w-3 text-purple-500" />;
81 |       case 'requesty':
82 |         return <Zap className="h-3 w-3 text-cyan-500" />;
83 |       default:
84 |         return <Zap className="h-3 w-3 text-blue-500" />;
85 |     }
86 |   };
87 |   
88 |   // Function to get capability icon
89 |   const getCapabilityIcon = (capability: string) => {
90 |     switch (capability.toLowerCase()) {
91 |       case 'code':
92 |       case 'coding':
93 |         return <Code className="h-2.5 w-2.5" />;
94 |       case 'reasoning':
95 |         return <Brain className="h-2.5 w-2.5" />;
96 |       case 'research':
97 |         return <Lightbulb className="h-2.5 w-2.5" />;
98 |       case 'vision':
99 |         return <Image className="h-2.5 w-2.5" aria-hidden="true" />;
100 |       case 'fast':
101 |       case 'rapid':
102 |         return <Bolt className="h-2.5 w-2.5" />;
103 |       case 'efficient':
104 |       case 'compact':
105 |         return <Gauge className="h-2.5 w-2.5" />;
106 |       case 'creative':
107 |       case 'balance':
108 |         return <Rocket className="h-2.5 w-2.5" />;
109 |       case 'agentic':
110 |         return <Bot className="h-2.5 w-2.5" />;
111 |       default:
112 |         return <Info className="h-2.5 w-2.5" />;
113 |     }
114 |   };
115 |   
116 |   // Get capability badge color
117 |   const getCapabilityColor = (capability: string) => {
118 |     switch (capability.toLowerCase()) {
119 |       case 'code':
120 |       case 'coding':
121 |         return "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300";
122 |       case 'reasoning':
123 |       case 'research':
124 |         return "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300";
125 |       case 'vision':
126 |         return "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300";
127 |       case 'fast':
128 |       case 'rapid':
129 |         return "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300";
130 |       case 'efficient':
131 |       case 'compact':
132 |         return "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300";
133 |       case 'creative':
134 |       case 'balance':
135 |         return "bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-300";
136 |       case 'agentic':
137 |         return "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300";
138 |       default:
139 |         return "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300";
140 |     }
141 |   };
142 |   
143 |   // Filter and sort models based on search term and active tab - memoized to prevent re-renders
144 |   const filteredAndSortedModels = useMemo(() => {
145 |     let modelsToFilter = [...availableModels];
146 | 
147 |     // Filter by active tab
148 |     if (activeTab === 'favorites') {
149 |       modelsToFilter = modelsToFilter.filter((model) => favorites.includes(model.id));
150 |     }
151 | 
152 |     // Filter by search term
153 |     modelsToFilter = modelsToFilter.filter((model) => {
154 |       const searchLower = searchTerm.toLowerCase();
155 |       return (
156 |         model.name.toLowerCase().includes(searchLower) ||
157 |         model.provider.toLowerCase().includes(searchLower) ||
158 |         model.capabilities.some(cap => cap.toLowerCase().includes(searchLower))
159 |       );
160 |     });
161 | 
162 |     // Sort models
163 |     return modelsToFilter.sort((modelA, modelB) => {
164 |       return modelA.name.localeCompare(modelB.name);
165 |     });
166 |   }, [availableModels, searchTerm, activeTab, favorites]);
167 | 
168 |   // Reset keyboard focus when search term or tab changes
169 |   useEffect(() => {
170 |     setKeyboardFocusedIndex(-1);
171 |   }, [searchTerm, activeTab]);
172 | 
173 |   // Set initial keyboard focus when picker opens
174 |   useEffect(() => {
175 |     if (isOpen && filteredAndSortedModels.length > 0) {
176 |       const selectedIndex = filteredAndSortedModels.findIndex(model => model.id === selectedModel);
177 |       setKeyboardFocusedIndex(selectedIndex >= 0 ? selectedIndex : 0);
178 |       
179 |       // Scroll to the selected model when picker opens
180 |       if (selectedIndex >= 0) {
181 |         setTimeout(() => {
182 |           const innerContainer = modelListRef.current;
183 |           const scrollableContainer = innerContainer?.parentElement; // The actual scrollable div
184 |           const selectedElement = innerContainer?.children[selectedIndex] as HTMLElement;
185 |           
186 |           if (selectedElement && scrollableContainer && innerContainer) {
187 |             // Get the element's position relative to the scrollable container
188 |             const elementTop = selectedElement.offsetTop;
189 |             const containerHeight = scrollableContainer.clientHeight;
190 |             
191 |             // Position element about 1/3 from top to avoid cutting off
192 |             const desiredScrollTop = elementTop - (containerHeight / 3);
193 |             
194 |             // Ensure we don't scroll negative or beyond content
195 |             const maxScroll = scrollableContainer.scrollHeight - containerHeight;
196 |             const scrollPosition = Math.max(0, Math.min(desiredScrollTop, maxScroll));
197 |             
198 |             scrollableContainer.scrollTop = scrollPosition;
199 |           }
200 |         }, 300); // Even longer delay to ensure rendering is complete
201 |       }
202 |     }
203 |   }, [isOpen, filteredAndSortedModels, selectedModel]);
204 | 
205 |   // Get current model details to display
206 |   const keyboardFocusedModel = keyboardFocusedIndex >= 0 && keyboardFocusedIndex < filteredAndSortedModels.length 
207 |     ? filteredAndSortedModels[keyboardFocusedIndex] 
208 |     : null;
209 |   
210 |   // Separate display logic: button always shows selected model, details panel shows hovered/focused model
211 |   const hoveredModelData = hoveredModel ? availableModels.find(m => m.id === hoveredModel) : null;
212 |   const touchFocusedModelData = focusedModel ? availableModels.find(m => m.id === focusedModel) : null;
213 |   const detailsPanelModel = keyboardFocusedModel || hoveredModelData || touchFocusedModelData || availableModels.find(m => m.id === selectedModel);
214 |   
215 |   // Main button always shows the selected model (no layout flipping)
216 |   const selectedModelData = availableModels.find(m => m.id === selectedModel);
217 |   const isModelUnavailable = creditsLoading ? false : (!canAccessPremiumModels() && selectedModelData?.premium);
218 | 
219 |   // Handle model change - memoized to prevent re-renders
220 |   const handleModelChange = useCallback((modelId: string) => {
221 |     const model = availableModels.find(m => m.id === modelId);
222 |     if (model) {
223 |       setSelectedModel(modelId);
224 |       setIsOpen(false);
225 |       setSearchTerm("");
226 |       setKeyboardFocusedIndex(-1);
227 |       setFocusedModel(null);
228 |       onModelSelected?.();
229 |     }
230 |   }, [availableModels, setSelectedModel, onModelSelected]);
231 | 
232 |   // Handle model tap for mobile - tap to focus, tap again to select
233 |   const handleModelTap = useCallback((modelId: string, isUnavailable: boolean) => {
234 |     if (isUnavailable) return;
235 |     
236 |     // If this model is already focused, select it
237 |     if (focusedModel === modelId) {
238 |       handleModelChange(modelId);
239 |     } else {
240 |       // Otherwise, just focus it to show details
241 |       setFocusedModel(modelId);
242 |       setKeyboardFocusedIndex(-1); // Clear keyboard focus when using touch
243 |     }
244 |   }, [focusedModel, handleModelChange]);
245 | 
246 |   // Handle opening the popover - memoized to prevent re-renders
247 |   const handleOpenChange = useCallback((open: boolean) => {
248 |     if (disabled) return; // Prevent opening when disabled
249 |     
250 |     setIsOpen(open);
251 |     if (!open) {
252 |       setSearchTerm("");
253 |       setKeyboardFocusedIndex(-1);
254 |       setFocusedModel(null);
255 |       // Keep activeTab as-is to remember user's last selection
256 |     } else {
257 |       // Focus search input when opening
258 |       setTimeout(() => {
259 |         searchInputRef.current?.focus();
260 |       }, 100);
261 |     }
262 |   }, [disabled]);
263 | 
264 |   // Handle search input change - memoized to prevent re-renders
265 |   const handleSearchChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
266 |     setSearchTerm(e.target.value);
267 |     setFocusedModel(null); // Clear touch focus when searching
268 |   }, []);
269 | 
270 |   // Handle refresh models
271 |   const handleRefreshModels = useCallback(async () => {
272 |     if (refreshModels) {
273 |       try {
274 |         await refreshModels();
275 |       } catch (error) {
276 |         console.error('Error during refresh:', error);
277 |       }
278 |     }
279 |   }, [refreshModels]);
280 | 
281 |   // Handle keyboard navigation
282 |   const handleKeyDown = useCallback((e: React.KeyboardEvent<HTMLInputElement>) => {
283 |     if (!isOpen) return;
284 | 
285 |     switch (e.key) {
286 |       case 'ArrowDown':
287 |         e.preventDefault();
288 |         setKeyboardFocusedIndex(prev => {
289 |           const newIndex = prev < filteredAndSortedModels.length - 1 ? prev + 1 : 0;
290 |           // Scroll to keep focused item visible
291 |           setTimeout(() => {
292 |             const focusedElement = modelListRef.current?.children[newIndex] as HTMLElement;
293 |             if (focusedElement) {
294 |               focusedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
295 |             }
296 |           }, 0);
297 |           return newIndex;
298 |         });
299 |         break;
300 |       case 'ArrowUp':
301 |         e.preventDefault();
302 |         setKeyboardFocusedIndex(prev => {
303 |           const newIndex = prev > 0 ? prev - 1 : filteredAndSortedModels.length - 1;
304 |           // Scroll to keep focused item visible
305 |           setTimeout(() => {
306 |             const focusedElement = modelListRef.current?.children[newIndex] as HTMLElement;
307 |             if (focusedElement) {
308 |               focusedElement.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
309 |             }
310 |           }, 0);
311 |           return newIndex;
312 |         });
313 |         break;
314 |       case 'Enter':
315 |         e.preventDefault();
316 |         if (keyboardFocusedIndex >= 0 && keyboardFocusedIndex < filteredAndSortedModels.length) {
317 |           const selectedModelData = filteredAndSortedModels[keyboardFocusedIndex];
318 |           const isUnavailable = creditsLoading ? false : (selectedModelData.premium && !canAccessPremiumModels());
319 |           if (!isUnavailable) {
320 |             handleModelChange(selectedModelData.id);
321 |           }
322 |         }
323 |         break;
324 |       case 'Escape':
325 |         setSearchTerm('');
326 |         setIsOpen(false);
327 |         break;
328 |     }
329 |   }, [isOpen, filteredAndSortedModels, keyboardFocusedIndex, creditsLoading, canAccessPremiumModels, handleModelChange]);
330 | 
331 |   // Loading state
332 |   if (modelsLoading) {
333 |     return (
334 |       <TooltipProvider>
335 |         <Tooltip>
336 |           <TooltipTrigger asChild>
337 |                           <Button
338 |                 variant="outline"
339 |                 disabled
340 |                 className={cn(
341 |                   "w-full sm:w-full md:max-w-fit md:w-56 px-2 sm:px-3 h-8 sm:h-9 rounded-full justify-between",
342 |                   "border-primary/20 bg-primary/5 opacity-60"
343 |                 )}
344 |               >
345 |               <div className="flex items-center gap-1 sm:gap-2 min-w-0">
346 |                 <RefreshCw className="h-3 w-3 animate-spin" />
347 |                 <span className="text-xs font-medium">Loading models...</span>
348 |               </div>
349 |             </Button>
350 |           </TooltipTrigger>
351 |           <TooltipContent>
352 |             <p>Loading available models from providers...</p>
353 |           </TooltipContent>
354 |         </Tooltip>
355 |       </TooltipProvider>
356 |     );
357 |   }
358 | 
359 |   // Error state
360 |   if (modelsError || !selectedModelData) {
361 |     return (
362 |       <TooltipProvider>
363 |         <Tooltip>
364 |           <TooltipTrigger asChild>
365 |             <Button
366 |               variant="outline"
367 |               onClick={handleRefreshModels}
368 |               disabled={modelsRefreshing}
369 |               className={cn(
370 |                 "w-full sm:w-full md:max-w-fit md:w-56 px-2 sm:px-3 h-8 sm:h-9 rounded-full justify-between",
371 |                 "border-red-200 bg-red-50 text-red-700 hover:bg-red-100",
372 |                 modelsRefreshing && "opacity-60"
373 |               )}
374 |             >
375 |               <div className="flex items-center gap-1 sm:gap-2 min-w-0">
376 |                 <AlertCircle className="h-3 w-3" />
377 |                 <span className="text-xs font-medium">
378 |                   {modelsRefreshing ? "Refreshing..." : "Error loading models"}
379 |                 </span>
380 |               </div>
381 |               <RefreshCw className={cn("ml-2 h-3 w-3 shrink-0", modelsRefreshing && "animate-spin")} />
382 |             </Button>
383 |           </TooltipTrigger>
384 |           <TooltipContent>
385 |             <p>{modelsRefreshing ? "Refreshing models..." : "Failed to load models. Click to retry."}</p>
386 |           </TooltipContent>
387 |         </Tooltip>
388 |       </TooltipProvider>
389 |     );
390 |   }
391 | 
392 |   return (
393 |     <TooltipProvider>
394 |       <Popover open={isOpen} onOpenChange={handleOpenChange}>
395 |         <Tooltip>
396 |           <TooltipTrigger asChild>
397 |             <PopoverTrigger asChild>
398 |               <Button
399 |                 variant="outline"
400 |                 role="combobox"
401 |                 aria-expanded={isOpen}
402 |                 disabled={disabled}
403 |                 className={cn(
404 |                   "w-full sm:w-full md:max-w-fit md:w-56 px-2 sm:px-3 h-8 sm:h-9 rounded-full justify-between",
405 |                   "border-primary/20 bg-primary/5 hover:bg-primary/10 dark:bg-primary/10 dark:hover:bg-primary/20",
406 |                   "transition-all duration-200 ring-offset-background focus:ring-2 focus:ring-primary/30 focus:ring-offset-2",
407 |                   "text-foreground hover:text-foreground font-normal",
408 |                   isModelUnavailable && "opacity-50",
409 |                   disabled && "opacity-60 cursor-not-allowed hover:bg-primary/5 dark:hover:bg-primary/10"
410 |                 )}
411 |               >
412 |                 <div className="flex items-center gap-1 sm:gap-2 min-w-0">
413 |                   {getProviderIcon(selectedModelData.provider)}
414 |                   <span className="text-xs font-medium truncate">{selectedModelData.name}</span>
415 |                 </div>
416 |                 <ChevronDown className={cn("ml-2 h-3 w-3 shrink-0 opacity-50", disabled && "opacity-30")} />
417 |               </Button>
418 |             </PopoverTrigger>
419 |           </TooltipTrigger>
420 |           <TooltipContent side="bottom" className="max-w-xs">
421 |             {disabled ? (
422 |               <p>
423 |                 Model is controlled by {activePresetName ? `"${activePresetName}" preset` : 'active preset'}. 
424 |                 Switch to &quot;Manual Mode&quot; to change models.
425 |               </p>
426 |             ) : isModelUnavailable ? (
427 |               <p>This model requires premium access. Please check your credits.</p>
428 |             ) : (
429 |               <p>Select an AI model for this conversation. Each model has different capabilities and costs.</p>
430 |             )}
431 |           </TooltipContent>
432 |         </Tooltip>
433 |         
434 |         <PopoverContent 
435 |           className="w-[320px] sm:w-[480px] md:w-[680px] p-0 bg-background/95 dark:bg-muted/95 backdrop-blur-sm border-border/80 max-h-[560px] overflow-hidden" 
436 |           align="start"
437 |           onMouseLeave={() => {
438 |             setHoveredModel(null);
439 |             // Don't clear focusedModel on mouse leave - keep it for touch devices
440 |           }}
441 |         >
442 |           {/* Tabs and search input with refresh button */}
443 |           <div className="px-3 pt-3 pb-2 border-b border-border/40 space-y-2">
444 |             {/* Tabs */}
445 |             <div className="flex items-center gap-1 bg-muted/30 p-1 rounded-md">
446 |               <button
447 |                 onClick={() => setActiveTab('all')}
448 |                 className={cn(
449 |                   "flex-1 text-xs font-medium px-2 py-1 rounded-sm transition-all duration-200",
450 |                   activeTab === 'all'
451 |                     ? "bg-background text-foreground shadow-sm"
452 |                     : "text-muted-foreground hover:text-foreground hover:bg-background/50"
453 |                 )}
454 |               >
455 |                 All
456 |               </button>
457 |               <button
458 |                 onClick={() => setActiveTab('favorites')}
459 |                 className={cn(
460 |                   "flex-1 text-xs font-medium px-2 py-1 rounded-sm transition-all duration-200 flex items-center justify-center gap-1",
461 |                   activeTab === 'favorites'
462 |                     ? "bg-background text-foreground shadow-sm"
463 |                     : "text-muted-foreground hover:text-foreground hover:bg-background/50"
464 |                 )}
465 |               >
466 |                 <Star className="h-3 w-3" />
467 |                 Favorites
468 |                 {favoriteCount > 0 && (
469 |                   <span className="bg-primary/20 text-primary text-[9px] px-1 rounded-full min-w-[14px] h-3.5 flex items-center justify-center">
470 |                     {favoriteCount}
471 |                   </span>
472 |                 )}
473 |               </button>
474 |             </div>
475 | 
476 |             <div className="flex gap-2">
477 |               <Input
478 |                 ref={searchInputRef}
479 |                 type="search"
480 |                 placeholder={`Search ${activeTab === 'favorites' ? 'favorite ' : ''}models... (↑↓ keys or tap to preview, Enter/tap again to select)`}
[TRUNCATED]
```

components/preset-manager.tsx
```
1 | 'use client';
2 | 
3 | import React, { useState, useEffect, useMemo } from 'react';
4 | import { usePresets, type Preset, type CreatePresetData } from '@/lib/context/preset-context';
5 | import { PRESET_TEMPLATES, getTemplateCategories, getTemplatesByCategory, type PresetTemplate } from '@/lib/preset-templates';
6 | import { validatePresetParameters, getModelParameterConstraints } from '@/lib/parameter-validation';
7 | import { type modelID, MODELS } from '@/ai/providers';
8 | 
9 | import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
10 | import { Button } from '@/components/ui/button';
11 | import { Input } from '@/components/ui/input';
12 | import { Label } from '@/components/ui/label';
13 | import { Textarea } from '@/components/ui/textarea';
14 | import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
15 | import { Switch } from '@/components/ui/switch';
16 | import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
17 | import { Badge } from '@/components/ui/badge';
18 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
19 | import { ScrollArea } from '@/components/ui/scroll-area';
20 | import { Separator } from '@/components/ui/separator';
21 | import { Alert, AlertDescription } from '@/components/ui/alert';
22 | import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
23 | import { ModelPicker } from './model-picker';
24 | import { 
25 |   Settings, 
26 |   Plus, 
27 |   Edit, 
28 |   Trash2, 
29 |   Share, 
30 |   Star, 
31 |   Copy, 
32 |   Download, 
33 |   Loader2,
34 |   AlertTriangle,
35 |   Check,
36 |   Info
37 | } from 'lucide-react';
38 | import { useModels } from '@/hooks/use-models';
39 | 
40 | interface PresetManagerProps {
41 |   open: boolean;
42 |   onOpenChange: (open: boolean) => void;
43 | }
44 | 
45 | interface PresetFormData {
46 |   name: string;
47 |   modelId: modelID;
48 |   systemInstruction: string;
49 |   temperature: number;
50 |   maxTokens: number;
51 |   webSearchEnabled: boolean;
52 |   webSearchContextSize: 'low' | 'medium' | 'high';
53 |   isDefault: boolean;
54 | }
55 | 
56 | export function PresetManager({ open, onOpenChange }: PresetManagerProps) {
57 |   const {
58 |     presets,
59 |     activePreset,
60 |     defaultPreset,
61 |     loading,
62 |     error,
63 |     createPreset,
64 |     createPresetFromTemplate,
65 |     updatePreset,
66 |     deletePreset,
67 |     sharePreset,
68 |     setDefaultPreset,
69 |     setActivePreset
70 |   } = usePresets();
71 | 
72 |   const { models, isLoading: modelsLoading } = useModels();
73 | 
74 |   // Helper function to get model info from dynamic models
75 |   const getModelInfo = (modelId: string) => {
76 |     return models.find(model => model.id === modelId);
77 |   };
78 | 
79 |   // Helper function to get provider name
80 |   const getModelProvider = (modelId: string): string => {
81 |     const modelInfo = getModelInfo(modelId);
82 |     return modelInfo?.provider || 'Unknown';
83 |   };
84 | 
85 |   // Helper function to get model name
86 |   const getModelName = (modelId: string): string => {
87 |     const modelInfo = getModelInfo(modelId);
88 |     return modelInfo?.name || modelId;
89 |   };
90 | 
91 |   // Function to check if a model supports web search
92 |   const supportsWebSearch = (modelId: string): boolean => {
93 |     // OpenRouter models support web search (except specific exclusions)
94 |     if (modelId.startsWith('openrouter/')) {
95 |       // Specific exclusions
96 |       if (modelId.includes('grok-3-beta') || modelId.includes('grok-3-mini-beta')) {
97 |         return false;
98 |       }
99 |       return true;
100 |     }
101 |     
102 |     // Requesty models do NOT support web search
103 |     if (modelId.startsWith('requesty/')) {
104 |       return false;
105 |     }
106 |     
107 |     // For direct models, check the dynamic model details
108 |     const modelInfo = getModelInfo(modelId);
109 |     if (modelInfo?.supportsWebSearch !== undefined) {
110 |       return modelInfo.supportsWebSearch;
111 |     }
112 |     
113 |     // Default to true for other models
114 |     return true;
115 |   };
116 | 
117 |   // Helper function to get web search restriction message
118 |   const getWebSearchRestrictionMessage = (modelId: string): string | null => {
119 |     if (modelId.startsWith('requesty/')) {
120 |       return 'Web search is not supported for Requesty models';
121 |     }
122 |     
123 |     if (modelId.startsWith('openai/') && (modelId.includes('gpt-4.1') || modelId.includes('o4-mini'))) {
124 |       return 'Web search is not supported for this OpenAI model';
125 |     }
126 |     
127 |     return null;
128 |   };
129 | 
130 |   // Helper function to format API route
131 |   const formatApiRoute = (modelId: string) => {
132 |     const parts = modelId.split('/');
133 |     if (parts.length === 1) return 'Direct';
134 |     const route = parts[0];
135 |     switch (route) {
136 |       case 'openrouter': return 'OpenRouter';
137 |       case 'requesty': return 'Requesty';
138 |       case 'anthropic': return 'Anthropic';
139 |       case 'openai': return 'OpenAI';
140 |       case 'groq': return 'Groq';
141 |       case 'xai': return 'X.AI';
142 |       default: return route.charAt(0).toUpperCase() + route.slice(1);
143 |     }
144 |   };
145 | 
146 |   // Helper function to get provider badge color
147 |   const getProviderBadgeClass = (provider: string) => {
148 |     switch (provider.toLowerCase()) {
149 |       case 'openrouter': return 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300';
150 |       case 'requesty': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300';
151 |       case 'anthropic': return 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300';
152 |       case 'openai': return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
153 |       case 'groq': return 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300';
154 |       case 'x.ai':
155 |       case 'xai': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
156 |       default: return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300';
157 |     }
158 |   };
159 | 
160 |   // State
161 |   const [activeTab, setActiveTab] = useState<'list' | 'templates' | 'create' | 'edit'>('list');
162 |   const [editingPreset, setEditingPreset] = useState<Preset | null>(null);
163 |   const [templateNameHint, setTemplateNameHint] = useState<string | null>(null);
164 |   const [formData, setFormData] = useState<PresetFormData>({
165 |     name: '',
166 |     modelId: 'openrouter/anthropic/claude-3.5-sonnet',
167 |     systemInstruction: '',
168 |     temperature: 1,
169 |     maxTokens: 4096,
170 |     webSearchEnabled: false,
171 |     webSearchContextSize: 'medium',
172 |     isDefault: false
173 |   });
174 |   const [formErrors, setFormErrors] = useState<string[]>([]);
175 |   const [submitting, setSubmitting] = useState(false);
176 | 
177 |   // Reset form when dialog opens/closes
178 |   useEffect(() => {
179 |     if (!open) {
180 |       setActiveTab('list');
181 |       setEditingPreset(null);
182 |       setTemplateNameHint(null);
183 |       setFormErrors([]);
184 |       resetForm();
185 |     }
186 |   }, [open]);
187 | 
188 |   // Effect to disable web search when model doesn't support it
189 |   useEffect(() => {
190 |     if (!supportsWebSearch(formData.modelId) && formData.webSearchEnabled) {
191 |       setFormData(prev => ({ ...prev, webSearchEnabled: false }));
192 |     }
193 |   }, [formData.modelId, formData.webSearchEnabled, supportsWebSearch]);
194 | 
195 |   // Reset form data
196 |   const resetForm = () => {
197 |     setTemplateNameHint(null);
198 |     setFormData({
199 |       name: '',
200 |       modelId: 'openrouter/anthropic/claude-3.5-sonnet',
201 |       systemInstruction: '',
202 |       temperature: 1,
203 |       maxTokens: 4096,
204 |       webSearchEnabled: false,
205 |       webSearchContextSize: 'medium',
206 |       isDefault: false
207 |     });
208 |   };
209 | 
210 |   // Populate form for editing
211 |   const startEdit = (preset: Preset) => {
212 |     setEditingPreset(preset);
213 |     setTemplateNameHint(null); // Clear template hint when editing existing preset
214 |     const webSearchEnabled = preset.webSearchEnabled && supportsWebSearch(preset.modelId);
215 |     
216 |     setFormData({
217 |       name: preset.name,
218 |       modelId: preset.modelId,
219 |       systemInstruction: preset.systemInstruction,
220 |       temperature: preset.temperature,
221 |       maxTokens: preset.maxTokens,
222 |       webSearchEnabled: webSearchEnabled,
223 |       webSearchContextSize: preset.webSearchContextSize,
224 |       isDefault: preset.isDefault
225 |     });
226 |     setActiveTab('edit');
227 |   };
228 | 
229 |   // Start creating from template
230 |   const startCreateFromTemplate = (template: PresetTemplate) => {
231 |     const webSearchEnabled = template.preset.webSearchEnabled && supportsWebSearch(template.preset.modelId);
232 |     
233 |     setTemplateNameHint(template.preset.name);
234 |     setFormData({
235 |       name: '', // Clear the name so user must provide their own
236 |       modelId: template.preset.modelId,
237 |       systemInstruction: template.preset.systemInstruction,
238 |       temperature: template.preset.temperature,
239 |       maxTokens: template.preset.maxTokens,
240 |       webSearchEnabled: webSearchEnabled,
241 |       webSearchContextSize: template.preset.webSearchContextSize,
242 |       isDefault: template.preset.isDefault
243 |     });
244 |     setActiveTab('create');
245 |   };
246 | 
247 |   // Validate form
248 |   const validateForm = (): boolean => {
249 |     const errors: string[] = [];
250 | 
251 |     if (!formData.name.trim()) {
252 |       errors.push('Preset name is required');
253 |     }
254 | 
255 |     if (!formData.systemInstruction.trim()) {
256 |       errors.push('System instruction is required');
257 |     }
258 | 
259 |     // Validate web search configuration
260 |     if (formData.webSearchEnabled && !supportsWebSearch(formData.modelId)) {
261 |       errors.push(`Web search is not supported for ${formatApiRoute(formData.modelId)} models`);
262 |     }
263 | 
264 |     // Check if models are still loading
265 |     if (modelsLoading) {
266 |       errors.push('Models are still loading, please wait...');
267 |       setFormErrors(errors);
268 |       return false;
269 |     }
270 | 
271 |     // Validate parameters
272 |     const modelInfo = getModelInfo(formData.modelId) || null;
273 |     
274 |     // If we can't find the model info even after loading is complete, warn the user
275 |     if (!modelInfo) {
276 |       console.warn(`Model info not found for ${formData.modelId}, available models:`, models.map(m => m.id));
277 |       errors.push(`Model information not available for ${formData.modelId}. Please try refreshing or selecting a different model.`);
278 |     }
279 |     
280 |     const validation = validatePresetParameters(
281 |       modelInfo,
282 |       formData.temperature,
283 |       formData.maxTokens,
284 |       formData.systemInstruction
285 |     );
286 | 
287 |     if (!validation.valid) {
288 |       errors.push(...validation.errors);
289 |     }
290 | 
291 |     setFormErrors(errors);
292 |     return errors.length === 0;
293 |   };
294 | 
295 |   // Handle form submission
296 |   const handleSubmit = async () => {
297 |     if (!validateForm()) return;
298 | 
299 |     try {
300 |       setSubmitting(true);
301 |       setFormErrors([]);
302 | 
303 |       const submitData: CreatePresetData = {
304 |         name: formData.name,
305 |         modelId: formData.modelId,
306 |         systemInstruction: formData.systemInstruction,
307 |         temperature: formData.temperature,
308 |         maxTokens: formData.maxTokens,
309 |         webSearchEnabled: formData.webSearchEnabled,
310 |         webSearchContextSize: formData.webSearchContextSize,
311 |         isDefault: formData.isDefault
312 |       };
313 | 
314 |       if (editingPreset) {
315 |         await updatePreset(editingPreset.id, submitData);
316 |       } else {
317 |         await createPreset(submitData);
318 |       }
319 | 
320 |       // Reset and close
321 |       resetForm();
322 |       setEditingPreset(null);
323 |       setActiveTab('list');
324 |     } catch (error) {
325 |       setFormErrors([error instanceof Error ? error.message : 'Failed to save preset']);
326 |     } finally {
327 |       setSubmitting(false);
328 |     }
329 |   };
330 | 
331 |   // Handle template creation
332 |   const handleCreateFromTemplate = (template: PresetTemplate) => {
333 |     // Instead of auto-creating with numbered names, open the create form
334 |     // pre-filled with template data so user can customize name and settings
335 |     startCreateFromTemplate(template);
336 |   };
337 | 
338 |   // Handle preset deletion
339 |   const handleDelete = async (preset: Preset) => {
340 |     if (!confirm(`Are you sure you want to delete "${preset.name}"?`)) return;
341 | 
342 |     try {
343 |       await deletePreset(preset.id);
344 |     } catch (error) {
345 |       setFormErrors([error instanceof Error ? error.message : 'Failed to delete preset']);
346 |     }
347 |   };
348 | 
349 |   // Handle sharing
350 |   const handleShare = async (preset: Preset) => {
351 |     try {
352 |       const shareUrl = await sharePreset(preset.id);
353 |       navigator.clipboard.writeText(shareUrl);
354 |       alert('Share link copied to clipboard!');
355 |     } catch (error) {
356 |       alert('Failed to generate share link');
357 |     }
358 |   };
359 | 
360 |   // Handle setting as default
361 |   const handleSetDefault = async (preset: Preset) => {
362 |     try {
363 |       await setDefaultPreset(preset.id);
364 |     } catch (error) {
365 |       alert('Failed to set as default');
366 |     }
367 |   };
368 | 
369 |   // Get model constraints for current selection
370 |   const selectedModelInfo = getModelInfo(formData.modelId) || null;
371 |   const modelConstraints = useMemo(() => {
372 |     // If models are still loading, show reasonable defaults that don't restrict too much
373 |     if (modelsLoading) {
374 |       return {
375 |         temperature: { min: 0, max: 2, default: 1 },
376 |         maxTokens: { min: 1, max: 200000, default: 4096 }, // Use a high max to avoid false restrictions
377 |         supportsSystemInstruction: true,
378 |         maxSystemInstructionLength: 50000
379 |       };
380 |     }
381 |     return getModelParameterConstraints(selectedModelInfo);
382 |   }, [selectedModelInfo, modelsLoading]);
383 | 
384 |   return (
385 |     <Dialog open={open} onOpenChange={onOpenChange}>
386 |       <DialogContent className="max-w-[95vw] sm:max-w-3xl lg:max-w-5xl max-h-[90vh] p-4 sm:p-6">
387 |         <DialogHeader>
388 |           <DialogTitle className="flex items-center gap-2 text-base sm:text-lg">
389 |             <Settings className="w-4 h-4 sm:w-5 sm:h-5" />
390 |             Preset Manager
391 |           </DialogTitle>
392 |         </DialogHeader>
393 | 
394 |         <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as any)} className="w-full">
395 |           <TabsList className="grid w-full grid-cols-2 sm:grid-cols-4 h-auto">
396 |             <TabsTrigger value="list" className="text-xs sm:text-sm px-2 py-2" aria-label="My Presets">My Presets</TabsTrigger>
397 |             <TabsTrigger value="templates" className="text-xs sm:text-sm px-2 py-2" aria-label="Preset Templates">Templates</TabsTrigger>
398 |             <TabsTrigger value="create" className="text-xs sm:text-sm px-2 py-2" aria-label="Create New">Create New</TabsTrigger>
399 |             <TabsTrigger value="edit" disabled={!editingPreset} className="text-xs sm:text-sm px-2 py-2" aria-label="Edit">Edit</TabsTrigger>
400 |           </TabsList>
401 | 
402 |           {/* Error Display */}
403 |           {(error || formErrors.length > 0) && (
404 |             <Alert variant="destructive">
405 |               <AlertTriangle className="h-4 w-4" />
406 |               <AlertDescription className="text-sm">
407 |                 {error || formErrors.join(', ')}
408 |               </AlertDescription>
409 |             </Alert>
410 |           )}
411 | 
412 |           {/* My Presets Tab */}
413 |           <TabsContent value="list" className="space-y-4">
414 |             <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
415 |               <h3 className="text-base sm:text-lg font-semibold">Your Presets ({presets.length})</h3>
416 |               <Button 
417 |                 onClick={() => {
418 |                   resetForm();
419 |                   setActiveTab('create');
420 |                 }}
421 |                 size="sm"
422 |                 className="w-full sm:w-auto"
423 |                 aria-label="New Preset"
424 |               >
425 |                 <Plus className="w-4 h-4 mr-2" />
426 |                 New Preset
427 |               </Button>
428 |             </div>
429 | 
430 |             <ScrollArea className="h-[350px] sm:h-[400px]">
431 |               <div className="space-y-3">
432 |                 {presets.map((preset) => (
433 |                   <Card key={preset.id} className="relative">
434 |                     <CardHeader className="pb-2">
435 |                       <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2">
436 |                         <div className="space-y-1 flex-1 min-w-0">
437 |                           <CardTitle className="text-sm sm:text-base flex items-center gap-2 flex-wrap">
438 |                             <span className="truncate">{preset.name}</span>
439 |                             {preset.isDefault && (
440 |                               <Badge variant="secondary" className="text-xs shrink-0">
441 |                                 <Star className="w-3 h-3 mr-1" />
442 |                                 Default
443 |                               </Badge>
444 |                             )}
445 |                             {activePreset?.id === preset.id && (
446 |                               <Badge variant="default" className="text-xs shrink-0">
447 |                                 Active
448 |                               </Badge>
449 |                             )}
450 |                           </CardTitle>
451 |                           <div className="text-sm text-muted-foreground flex items-center gap-2 flex-wrap">
452 |                             <span className={`text-xs px-2 py-0.5 rounded-full font-medium shrink-0 ${getProviderBadgeClass(getModelProvider(preset.modelId))}`}>
453 |                               {getModelProvider(preset.modelId)}
454 |                             </span>
455 |                             <TooltipProvider>
456 |                               <Tooltip>
457 |                                 <TooltipTrigger asChild>
458 |                                   <span className="hover:underline cursor-help truncate">
459 |                                     {getModelName(preset.modelId)}
460 |                                   </span>
461 |                                 </TooltipTrigger>
462 |                                 <TooltipContent>
463 |                                   <div className="text-xs font-mono">Model ID: {preset.modelId}</div>
464 |                                 </TooltipContent>
465 |                               </Tooltip>
466 |                             </TooltipProvider>
467 |                           </div>
468 |                         </div>
469 |                         
470 |                         <div className="flex items-center gap-1 shrink-0 overflow-x-auto sm:overflow-visible">
471 |                           <Button 
472 |                             variant="ghost" 
473 |                             size="icon"
474 |                             onClick={() => setActivePreset(preset)}
475 |                             title="Use this preset"
476 |                             className="h-8 w-8 shrink-0"
477 |                             aria-label="Use this preset"
478 |                           >
479 |                             <Check className="w-4 h-4" />
480 |                           </Button>
481 |                           <Button 
482 |                             variant="ghost" 
483 |                             size="icon"
484 |                             onClick={() => startEdit(preset)}
485 |                             title="Edit preset"
486 |                             className="h-8 w-8 shrink-0"
487 |                             aria-label="Edit preset"
488 |                           >
489 |                             <Edit className="w-4 h-4" />
490 |                           </Button>
491 |                           <Button 
492 |                             variant="ghost" 
493 |                             size="icon"
494 |                             onClick={() => handleShare(preset)}
495 |                             title="Share preset"
496 |                             className="h-8 w-8 shrink-0"
497 |                             aria-label="Share preset"
498 |                           >
499 |                             <Share className="w-4 h-4" />
500 |                           </Button>
501 |                           {!preset.isDefault && (
502 |                             <Button 
503 |                               variant="ghost" 
504 |                               size="icon"
505 |                               onClick={() => handleSetDefault(preset)}
506 |                               title="Set as default"
507 |                               className="h-8 w-8 shrink-0"
508 |                               aria-label="Set as default"
509 |                             >
510 |                               <Star className="w-4 h-4" />
511 |                             </Button>
512 |                           )}
513 |                           <Button 
514 |                             variant="ghost" 
515 |                             size="icon"
516 |                             onClick={() => handleDelete(preset)}
517 |                             title="Delete preset"
518 |                             className="h-8 w-8 shrink-0"
519 |                             aria-label="Delete preset"
520 |                           >
521 |                             <Trash2 className="w-4 h-4" />
522 |                           </Button>
523 |                         </div>
524 |                       </div>
525 |                     </CardHeader>
526 |                     
527 |                     <CardContent className="pt-2">
528 |                       <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-4 text-sm">
[TRUNCATED]
```

components/preset-selector.tsx
```
1 | 'use client';
2 | 
3 | import React, { useState } from 'react';
4 | import { usePresets } from '@/lib/context/preset-context';
5 | import { PresetManager } from './preset-manager';
6 | import { 
7 |   Select, 
8 |   SelectContent, 
9 |   SelectGroup, 
10 |   SelectItem, 
11 |   SelectLabel,
12 |   SelectTrigger, 
13 |   SelectValue 
14 | } from '@/components/ui/select';
15 | import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip';
16 | import { Badge } from '@/components/ui/badge';
17 | import { Settings, Star, Plus, Loader } from 'lucide-react';
18 | 
19 | interface PresetSelectorProps {
20 |   className?: string;
21 | }
22 | 
23 | export function PresetSelector({ className }: PresetSelectorProps) {
24 |   const { presets, activePreset, setActivePreset, loading } = usePresets();
25 |   const [showManager, setShowManager] = useState(false);
26 | 
27 |   const handlePresetChange = (value: string) => {
28 |     if (value === 'manage') {
29 |       setShowManager(true);
30 |     } else {
31 |       const preset = value === 'none' ? null : presets.find(p => p.id === value) || null;
32 |       setActivePreset(preset);
33 |     }
34 |   };
35 | 
36 |   return (
37 |     <div className={`flex items-center gap-2 ${className}`}>
38 |       <Select
39 |         value={activePreset?.id || 'none'}
40 |         onValueChange={handlePresetChange}
41 |         disabled={loading}
42 |       >
43 |         <Tooltip delayDuration={300}>
44 |           <TooltipTrigger asChild>
45 |             <SelectTrigger className="h-8 w-auto min-w-[40px] text-xs border-border max-w-full">
46 |               <div className="flex items-center gap-1">
47 |                 {loading ? (
48 |                   <Loader className="w-3 h-3 animate-spin" />
49 |                 ) : (
50 |                   <Settings className="w-3 h-3 shrink-0" />
51 |                 )}
52 |                 <SelectValue>
53 |                   {activePreset ? (
54 |                     <span className="flex items-center gap-1">
55 |                       {activePreset.isDefault && (
56 |                         <Star className="w-3 h-3 text-yellow-500 shrink-0" />
57 |                       )}
58 |                     </span>
59 |                   ) : null}
60 |                 </SelectValue>
61 |               </div>
62 |             </SelectTrigger>
63 |           </TooltipTrigger>
64 |           
65 |           <TooltipContent side="top" className="max-w-[280px] text-xs p-3">
66 |             {activePreset ? (
67 |               <div className="space-y-2">
68 |                 <div className="font-semibold text-foreground truncate text-sm">
69 |                   {activePreset.name}
70 |                 </div>
71 |                 <div className="space-y-1.5">
72 |                   <div className="flex items-center gap-2 text-muted-foreground">
73 |                     <span className="text-[10px] font-medium uppercase tracking-wide text-muted-foreground/70">
74 |                       Model
75 |                     </span>
76 |                     <span className="font-mono text-xs truncate">{activePreset.modelId}</span>
77 |                   </div>
78 |                   <div className="grid grid-cols-2 gap-2 text-muted-foreground">
79 |                     <div className="flex items-center gap-1.5">
80 |                       <span className="text-[10px] font-medium uppercase tracking-wide text-muted-foreground/70">
81 |                         Temp
82 |                       </span>
83 |                       <span className="font-medium">{activePreset.temperature.toFixed(1)}</span>
84 |                     </div>
85 |                     <div className="flex items-center gap-1.5">
86 |                       <span className="text-[10px] font-medium uppercase tracking-wide text-muted-foreground/70">
87 |                         Tokens
88 |                       </span>
89 |                       <span className="font-medium">{activePreset.maxTokens}</span>
90 |                     </div>
91 |                   </div>
92 |                 </div>
93 |                 {activePreset.webSearchEnabled && (
94 |                   <Badge variant="secondary" className="mt-1 text-xs py-0.5">
95 |                     <span className="font-medium">Web Search:</span> {activePreset.webSearchContextSize} results
96 |                   </Badge>
97 |                 )}
98 |               </div>
99 |             ) : (
100 |               <div className="space-y-1">
101 |                 <div className="font-medium text-foreground">Manual Mode</div>
102 |                 <div className="text-muted-foreground text-xs">
103 |                   Configure settings manually without a preset
104 |                 </div>
105 |               </div>
106 |             )}
107 |           </TooltipContent>
108 |         </Tooltip>
109 | 
110 |         <SelectContent className="min-w-[200px] md:min-w-[220px]">
111 |           <SelectItem value="none">
112 |             <div className="flex items-center gap-2">
113 |               <Settings className="w-3 h-3" />
114 |               <span>Manual Mode</span>
115 |             </div>
116 |           </SelectItem>
117 | 
118 |           {presets.length > 0 && (
119 |             <SelectGroup>
120 |               <SelectLabel className="px-2 py-1 text-xs text-muted-foreground">
121 |                 Your Presets
122 |               </SelectLabel>
123 |               {presets.map(preset => (
124 |                 <SelectItem key={preset.id} value={preset.id}>
125 |                   <div className="flex items-center gap-2">
126 |                     <span className="truncate">{preset.name}</span>
127 |                     {preset.isDefault && (
128 |                       <Star className="w-3 h-3 text-yellow-500 shrink-0" />
129 |                     )}
130 |                   </div>
131 |                 </SelectItem>
132 |               ))}
133 |             </SelectGroup>
134 |           )}
135 | 
136 |           <SelectGroup>
137 |             <SelectLabel className="px-2 py-1 text-xs text-muted-foreground">
138 |               Preset Management
139 |             </SelectLabel>
140 |             <SelectItem value="manage">
141 |               <div className="flex items-center gap-2">
142 |                 <Plus className="w-3 h-3" />
143 |                 <span>Manage Presets</span>
144 |               </div>
145 |             </SelectItem>
146 |           </SelectGroup>
147 |         </SelectContent>
148 |       </Select>
149 | 
150 |       {/* Active preset indicator - Now shows on all screen sizes including mobile */}
151 |       {activePreset && !loading && (
152 |         <Tooltip delayDuration={300}>
153 |           <TooltipTrigger asChild>
154 |             <Badge
155 |               variant="secondary"
156 |               className="h-5 px-2 py-0.5 text-[10px] font-medium cursor-help bg-green-500/10 hover:bg-green-500/20 text-green-700 dark:text-green-300 border border-green-500/20 md:h-6 md:px-2.5 md:py-1 md:text-xs max-w-full"
157 |             >
158 |               <span className="truncate max-w-[80px] md:max-w-[100px]">{activePreset.name}</span>
159 |             </Badge>
160 |           </TooltipTrigger>
161 |           <TooltipContent side="top" className="max-w-[200px] text-xs p-2">
162 |             <div className="space-y-1">
163 |               <div className="font-medium">Active Preset</div>
164 |               <div className="text-muted-foreground text-xs">{activePreset.name}</div>
165 |             </div>
166 |           </TooltipContent>
167 |         </Tooltip>
168 |       )}
169 | 
170 |       <PresetManager
171 |         open={showManager}
172 |         onOpenChange={setShowManager}
173 |       />
174 |     </div>
175 |   );
176 | }
```

components/project-overview.tsx
```
1 | import NextLink from "next/link";
2 | import { SuggestedPrompts } from "./suggested-prompts";
3 | 
4 | interface ProjectOverviewProps {
5 |   sendMessage?: (input: string) => void;
6 |   selectedModel?: string;
7 | }
8 | 
9 | export const ProjectOverview = ({ sendMessage, selectedModel }: ProjectOverviewProps) => {
10 |   return (
11 |     <div className="flex flex-col items-center justify-center space-y-6 p-4">
12 |       {/* Welcome header */}
13 |       <div className="text-center space-y-3 max-w-2xl mx-auto">
14 |         <h1 className="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-primary to-primary/70 bg-clip-text text-transparent">
15 |           Welcome to ChatLima
16 |         </h1>
17 |         <p className="text-base sm:text-lg text-muted-foreground">
18 |           Your AI-powered chat assistant. Choose a suggestion below or start typing your own message.
19 |         </p>
20 |       </div>
21 | 
22 |       {/* Suggested prompts */}
23 |       {sendMessage && (
24 |         <div className="w-full max-w-4xl mx-auto">
25 |           <SuggestedPrompts 
26 |             sendMessage={sendMessage}
27 |             selectedModel={selectedModel}
28 |             maxSuggestions={4}
29 |             showCategories={true}
30 |           />
31 |         </div>
32 |       )}
33 |     </div>
34 |   );
35 | };
36 | 
37 | const Link = ({
38 |   children,
39 |   href,
40 | }: {
41 |   children: React.ReactNode;
42 |   href: string;
43 | }) => {
44 |   return (
45 |     <NextLink
46 |       target="_blank"
47 |       className="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 transition-colors duration-75"
48 |       href={href}
49 |     >
50 |       {children}
51 |     </NextLink>
52 |   );
53 | };
```

components/provider-health-dashboard.tsx
```
1 | "use client";
2 | 
3 | import React from 'react';
4 | import { useProviderHealth, useModelsCache } from '@/hooks/use-models';
5 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
6 | import { Badge } from '@/components/ui/badge';
7 | import { Button } from '@/components/ui/button';
8 | import { 
9 |   RefreshCw, 
10 |   CheckCircle, 
11 |   AlertTriangle, 
12 |   XCircle, 
13 |   HelpCircle,
14 |   Clock,
15 |   Zap,
16 |   Database,
17 |   AlertCircle
18 | } from 'lucide-react';
19 | import { cn } from '@/lib/utils';
20 | import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
21 | import { ScrollArea } from '@/components/ui/scroll-area';
22 | 
23 | // Type guard for health status
24 | function isValidHealthStatus(status: string): status is 'healthy' | 'degraded' | 'down' | 'unknown' {
25 |   return ['healthy', 'degraded', 'down', 'unknown'].includes(status);
26 | }
27 | 
28 | // Health indicator component
29 | function HealthIndicator({ status }: { status: 'healthy' | 'degraded' | 'down' | 'unknown' }) {
30 |   const config = {
31 |     healthy: {
32 |       icon: CheckCircle,
33 |       color: 'text-green-500',
34 |       bgColor: 'bg-green-50 dark:bg-green-950',
35 |       label: 'Healthy',
36 |     },
37 |     degraded: {
38 |       icon: AlertTriangle,
39 |       color: 'text-yellow-500',
40 |       bgColor: 'bg-yellow-50 dark:bg-yellow-950',
41 |       label: 'Degraded',
42 |     },
43 |     down: {
44 |       icon: XCircle,
45 |       color: 'text-red-500',
46 |       bgColor: 'bg-red-50 dark:bg-red-950',
47 |       label: 'Down',
48 |     },
49 |     unknown: {
50 |       icon: HelpCircle,
51 |       color: 'text-gray-500',
52 |       bgColor: 'bg-gray-50 dark:bg-gray-950',
53 |       label: 'Unknown',
54 |     },
55 |   };
56 |   
57 |   const { icon: Icon, color, bgColor, label } = config[status];
58 |   
59 |   return (
60 |     <div className={cn("flex items-center gap-2 px-2 py-1 rounded-md", bgColor)}>
61 |       <Icon className={cn("h-4 w-4", color)} />
62 |       <span className={cn("text-sm font-medium", color)}>{label}</span>
63 |     </div>
64 |   );
65 | }
66 | 
67 | // Provider icon helper
68 | function getProviderIcon(providerName: string) {
69 |   switch (providerName.toLowerCase()) {
70 |     case 'openrouter':
71 |       return <Zap className="h-4 w-4 text-purple-500" />;
72 |     case 'requesty':
73 |       return <Zap className="h-4 w-4 text-cyan-500" />;
74 |     case 'anthropic':
75 |       return <Zap className="h-4 w-4 text-orange-600" />;
76 |     case 'openai':
77 |       return <Zap className="h-4 w-4 text-green-500" />;
78 |     default:
79 |       return <Database className="h-4 w-4 text-gray-500" />;
80 |   }
81 | }
82 | 
83 | // Helper function to get provider badge color
84 | function getProviderBadgeClass(provider: string) {
85 |   switch (provider.toLowerCase()) {
86 |     case 'openrouter': 
87 |       return 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300';
88 |     case 'requesty': 
89 |       return 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300';
90 |     case 'anthropic': 
91 |       return 'bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300';
92 |     case 'openai': 
93 |       return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300';
94 |     case 'groq': 
95 |       return 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300';
96 |     case 'xai': 
97 |       return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300';
98 |     default: 
99 |       return 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-300';
100 |   }
101 | }
102 | 
103 | // Time formatter
104 | function formatTime(date: Date | string): string {
105 |   const d = new Date(date);
106 |   const now = new Date();
107 |   const diffMs = now.getTime() - d.getTime();
108 |   const diffMins = Math.floor(diffMs / (1000 * 60));
109 |   const diffHours = Math.floor(diffMins / 60);
110 |   const diffDays = Math.floor(diffHours / 24);
111 |   
112 |   if (diffMins < 1) return 'Just now';
113 |   if (diffMins < 60) return `${diffMins}m ago`;
114 |   if (diffHours < 24) return `${diffHours}h ago`;
115 |   if (diffDays < 7) return `${diffDays}d ago`;
116 |   
117 |   return d.toLocaleDateString();
118 | }
119 | 
120 | interface ProviderHealthDashboardProps {
121 |   compact?: boolean;
122 |   showRefreshButton?: boolean;
123 |   className?: string;
124 |   dialogMode?: boolean;
125 | }
126 | 
127 | export function ProviderHealthDashboard({ 
128 |   compact = false, 
129 |   showRefreshButton = true,
130 |   className,
131 |   dialogMode = false
132 | }: ProviderHealthDashboardProps) {
133 |   const { 
134 |     overall, 
135 |     providers, 
136 |     healthyCount, 
137 |     totalCount, 
138 |     lastUpdated, 
139 |     isLoading, 
140 |     error 
141 |   } = useProviderHealth();
142 |   
143 |   const { clearCache, isClearing } = useModelsCache();
144 |   
145 |   const handleRefresh = async () => {
146 |     try {
147 |       await clearCache(); // Clear cache to force refresh
148 |       // The useProviderHealth hook will automatically refetch
149 |     } catch (error) {
150 |       console.error('Failed to refresh provider data:', error);
151 |     }
152 |   };
153 | 
154 |   // Ensure overall status is valid
155 |   const safeOverallStatus = isValidHealthStatus(overall) ? overall : 'unknown';
156 | 
157 |   if (error) {
158 |     return (
159 |       <Card className={cn("w-full", className)}>
160 |         <CardContent className="p-4">
161 |           <div className="flex items-center gap-2 text-red-600">
162 |             <AlertCircle className="h-4 w-4" />
163 |             <span className="text-sm font-medium">Failed to load provider health</span>
164 |           </div>
165 |           {showRefreshButton && (
166 |             <Button 
167 |               variant="outline" 
168 |               size="sm" 
169 |               onClick={handleRefresh}
170 |               disabled={isClearing}
171 |               className="mt-2"
172 |             >
173 |               <RefreshCw className={cn("h-3 w-3 mr-2", isClearing && "animate-spin")} />
174 |               Retry
175 |             </Button>
176 |           )}
177 |         </CardContent>
178 |       </Card>
179 |     );
180 |   }
181 | 
182 |   if (compact) {
183 |     return (
184 |       <div className={cn("flex items-center gap-2", className)}>
185 |         <HealthIndicator status={safeOverallStatus} />
186 |         <span className="text-sm text-muted-foreground">
187 |           {healthyCount}/{totalCount} providers
188 |         </span>
189 |         {showRefreshButton && (
190 |           <TooltipProvider>
191 |             <Tooltip>
192 |               <TooltipTrigger asChild>
193 |                 <Button
194 |                   variant="ghost"
195 |                   size="sm"
196 |                   onClick={handleRefresh}
197 |                   disabled={isClearing || isLoading}
198 |                   className="h-6 w-6 p-0"
199 |                 >
200 |                   <RefreshCw className={cn("h-3 w-3", (isClearing || isLoading) && "animate-spin")} />
201 |                 </Button>
202 |               </TooltipTrigger>
203 |               <TooltipContent>Refresh provider data</TooltipContent>
204 |             </Tooltip>
205 |           </TooltipProvider>
206 |         )}
207 |       </div>
208 |     );
209 |   }
210 | 
211 |   // Content component for reuse
212 |   const content = (
213 |     <div className="space-y-4">
214 |       {/* Header and refresh button for dialog mode */}
215 |       {dialogMode && showRefreshButton && (
216 |         <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
217 |           <div>
218 |             <h3 className="text-base sm:text-lg font-semibold">Provider Status ({healthyCount}/{totalCount})</h3>
219 |             <p className="text-sm text-muted-foreground">
220 |               Real-time health monitoring of AI model providers
221 |             </p>
222 |           </div>
223 |           <TooltipProvider>
224 |             <Tooltip>
225 |               <TooltipTrigger asChild>
226 |                 <Button
227 |                   variant="outline"
228 |                   size="sm"
229 |                   onClick={handleRefresh}
230 |                   disabled={isClearing || isLoading}
231 |                   className="w-full sm:w-auto"
232 |                 >
233 |                   <RefreshCw className={cn("h-4 w-4 mr-2", (isClearing || isLoading) && "animate-spin")} />
234 |                   <span className="hidden sm:inline">Refresh</span>
235 |                   <span className="sm:hidden">Refresh All</span>
236 |                 </Button>
237 |               </TooltipTrigger>
238 |               <TooltipContent>Force refresh all provider data</TooltipContent>
239 |             </Tooltip>
240 |           </TooltipProvider>
241 |         </div>
242 |       )}
243 | 
244 |       {/* Overall status */}
245 |       <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 border rounded-lg gap-2">
246 |         <div className="flex items-center gap-3">
247 |           <HealthIndicator status={safeOverallStatus} />
248 |           <div>
249 |             <div className="font-medium text-sm sm:text-base">Overall Status</div>
250 |             <div className="text-xs sm:text-sm text-muted-foreground">
251 |               {healthyCount} of {totalCount} providers operational
252 |             </div>
253 |           </div>
254 |         </div>
255 |         {lastUpdated && (
256 |           <div className="flex items-center gap-1 text-xs text-muted-foreground">
257 |             <Clock className="h-3 w-3" />
258 |             {formatTime(lastUpdated)}
259 |           </div>
260 |         )}
261 |       </div>
262 | 
263 |       {/* Provider grid - improved mobile responsiveness */}
264 |       <ScrollArea className="h-[300px] sm:h-[350px]">
265 |         <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 pr-1">
266 |           {Object.entries(providers).map(([key, provider]) => {
267 |             // Ensure provider status is valid
268 |             const safeProviderStatus = isValidHealthStatus(provider.status) ? provider.status : 'unknown';
269 |             
270 |             return (
271 |               <Card key={key} className="relative">
272 |                 <CardHeader className="pb-2">
273 |                   <div className="flex items-center justify-between gap-2">
274 |                     <div className="flex items-center gap-2 min-w-0">
275 |                       {getProviderIcon(provider.name)}
276 |                       <span className="font-medium text-sm truncate">{provider.name}</span>
277 |                     </div>
278 |                     <HealthIndicator status={safeProviderStatus} />
279 |                   </div>
280 |                   <CardDescription className="flex items-center gap-2 text-xs">
281 |                     <span className={`px-2 py-0.5 rounded-full font-medium shrink-0 ${getProviderBadgeClass(provider.name)}`}>
282 |                       {provider.name}
283 |                     </span>
284 |                   </CardDescription>
285 |                 </CardHeader>
286 |                 
287 |                 <CardContent className="pt-2">
288 |                   <div className="space-y-2 text-sm">
289 |                     <div className="flex justify-between items-center">
290 |                       <span className="text-muted-foreground text-xs">Models:</span>
291 |                       <Badge variant="secondary" className="text-xs h-5">
292 |                         {provider.modelCount}
293 |                       </Badge>
294 |                     </div>
295 |                     
296 |                     <div className="flex justify-between items-center">
297 |                       <span className="text-muted-foreground text-xs">API Key:</span>
298 |                       <div className="flex gap-1">
299 |                         {provider.hasEnvironmentKey && (
300 |                           <Badge variant="outline" className="text-xs h-5">
301 |                             ENV
302 |                           </Badge>
303 |                         )}
304 |                         {provider.supportsUserKeys && (
305 |                           <Badge variant="outline" className="text-xs h-5">
306 |                             User
307 |                           </Badge>
308 |                         )}
309 |                       </div>
310 |                     </div>
311 |                     
312 |                     <div className="flex justify-between items-center text-xs">
313 |                       <span className="text-muted-foreground">Last checked:</span>
314 |                       <span className="truncate ml-2">{formatTime(provider.lastChecked)}</span>
315 |                     </div>
316 |                     
317 |                     {provider.error && (
318 |                       <div className="text-xs text-red-600 bg-red-50 dark:bg-red-950 p-2 rounded mt-2">
319 |                         <div className="flex items-start gap-1">
320 |                           <AlertCircle className="h-3 w-3 flex-shrink-0 mt-0.5" />
321 |                           <span className="break-words text-xs leading-tight" title={provider.error}>
322 |                             {provider.error}
323 |                           </span>
324 |                         </div>
325 |                       </div>
326 |                     )}
327 |                   </div>
328 |                 </CardContent>
329 |               </Card>
330 |             );
331 |           })}
332 |         </div>
333 |       </ScrollArea>
334 | 
335 |       {/* Empty state */}
336 |       {Object.keys(providers).length === 0 && !isLoading && (
337 |         <div className="text-center py-8 text-muted-foreground">
338 |           <div className="rounded-full p-3 bg-primary/10 w-fit mx-auto mb-4">
339 |             <Database className="h-6 w-6 sm:h-7 sm:w-7 text-primary" />
340 |           </div>
341 |           <div className="space-y-1">
342 |             <h3 className="text-sm sm:text-base font-medium">No Provider Data Available</h3>
343 |             <p className="text-xs sm:text-sm text-muted-foreground max-w-[300px] mx-auto">
344 |               Check your API keys and network connection
345 |             </p>
346 |           </div>
347 |         </div>
348 |       )}
349 | 
350 |       {/* Loading state */}
351 |       {isLoading && Object.keys(providers).length === 0 && (
352 |         <div className="text-center py-8 text-muted-foreground">
353 |           <div className="rounded-full p-3 bg-primary/10 w-fit mx-auto mb-4">
354 |             <RefreshCw className="h-6 w-6 sm:h-7 sm:w-7 animate-spin text-primary" />
355 |           </div>
356 |           <div className="space-y-1">
357 |             <h3 className="text-sm sm:text-base font-medium">Loading Provider Status</h3>
358 |             <p className="text-xs sm:text-sm text-muted-foreground">
359 |               Checking health of all providers...
360 |             </p>
361 |           </div>
362 |         </div>
363 |       )}
364 |     </div>
365 |   );
366 | 
367 |   // Return with or without Card wrapper based on mode
368 |   if (dialogMode) {
369 |     return <div className={cn("w-full", className)}>{content}</div>;
370 |   }
371 | 
372 |   return (
373 |     <Card className={cn("w-full", className)}>
374 |       <CardHeader className="pb-3">
375 |         <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
376 |           <div>
377 |             <CardTitle className="text-base sm:text-lg">Provider Health</CardTitle>
378 |             <CardDescription>
379 |               Status of AI model providers and their availability
380 |             </CardDescription>
381 |           </div>
382 |           {showRefreshButton && (
383 |             <TooltipProvider>
384 |               <Tooltip>
385 |                 <TooltipTrigger asChild>
386 |                   <Button
387 |                     variant="outline"
388 |                     size="sm"
389 |                     onClick={handleRefresh}
390 |                     disabled={isClearing || isLoading}
391 |                     className="w-full sm:w-auto"
392 |                   >
393 |                     <RefreshCw className={cn("h-4 w-4 mr-2", (isClearing || isLoading) && "animate-spin")} />
394 |                     Refresh
395 |                   </Button>
396 |                 </TooltipTrigger>
397 |                 <TooltipContent>Force refresh all provider data</TooltipContent>
398 |               </Tooltip>
399 |             </TooltipProvider>
400 |           )}
401 |         </div>
402 |       </CardHeader>
403 |       
404 |       <CardContent>
405 |         {content}
406 |       </CardContent>
407 |     </Card>
408 |   );
409 | }
410 | 
411 | // Standalone health status indicator for use in other components
412 | export function ProviderHealthIndicator({ className }: { className?: string }) {
413 |   const { overall, healthyCount, totalCount, isLoading } = useProviderHealth();
414 |   
415 |   if (isLoading) {
416 |     return (
417 |       <div className={cn("flex items-center gap-2", className)}>
418 |         <RefreshCw className="h-3 w-3 animate-spin text-muted-foreground" />
419 |         <span className="text-xs text-muted-foreground">Checking...</span>
420 |       </div>
421 |     );
422 |   }
423 |   
424 |   // Ensure overall status is valid
425 |   const safeOverallStatus = isValidHealthStatus(overall) ? overall : 'unknown';
426 |   
427 |   return (
428 |     <TooltipProvider>
429 |       <Tooltip>
430 |         <TooltipTrigger asChild>
431 |           <div className={cn("flex items-center gap-2 cursor-help", className)}>
432 |             <HealthIndicator status={safeOverallStatus} />
433 |             <span className="text-xs text-muted-foreground">
434 |               {healthyCount}/{totalCount}
435 |             </span>
436 |           </div>
437 |         </TooltipTrigger>
438 |         <TooltipContent>
439 |           <p>{healthyCount} of {totalCount} providers are healthy</p>
440 |         </TooltipContent>
441 |       </Tooltip>
442 |     </TooltipProvider>
443 |   );
444 | } 
```

components/shared-chat-messages.tsx
```
1 | "use client";
2 | 
3 | import { SharedMessage } from "./shared-message";
4 | import type { SnapshotMessage } from "@/lib/services/chat-sharing";
5 | 
6 | interface SharedChatMessagesProps {
7 |   messages: SnapshotMessage[];
8 |   metadata: {
9 |     models: string[];
10 |     redaction: {
11 |       hideSystemPrompts: boolean;
12 |       hideToolArgs: boolean;
13 |       excludeMedia: boolean;
14 |       piiRemoved: boolean;
15 |     };
16 |   };
17 | }
18 | 
19 | export function SharedChatMessages({ messages, metadata }: SharedChatMessagesProps) {
20 |   return (
21 |     <div className="h-full overflow-y-auto no-scrollbar">
22 |       <div className="max-w-lg sm:max-w-3xl mx-auto py-4">
23 |         {messages.map((message, index) => (
24 |           <SharedMessage
25 |             key={message.id}
26 |             message={message}
27 |             isLast={index === messages.length - 1}
28 |           />
29 |         ))}
30 |         
31 |         {/* Show models used if available */}
32 |         {metadata.models.length > 0 && (
33 |           <div className="mt-8 p-4 bg-muted/30 rounded-lg">
34 |             <h3 className="text-sm font-medium mb-2">Models used in this conversation:</h3>
35 |             <div className="flex flex-wrap gap-2">
36 |               {metadata.models.map((model, index) => (
37 |                 <span
38 |                   key={index}
39 |                   className="px-2 py-1 bg-background text-xs rounded-full border"
40 |                 >
41 |                   {model}
42 |                 </span>
43 |               ))}
44 |             </div>
45 |           </div>
46 |         )}
47 |       </div>
48 |     </div>
49 |   );
50 | }
```

components/shared-message.tsx
```
1 | "use client";
2 | 
3 | import { memo } from "react";
4 | import { Markdown } from "./markdown";
5 | import { CopyButton } from "./copy-button";
6 | import { cn } from "@/lib/utils";
7 | import { BotIcon, UserIcon, SearchIcon } from "lucide-react";
8 | import type { SnapshotMessage } from "@/lib/services/chat-sharing";
9 | 
10 | interface SharedMessageProps {
11 |   message: SnapshotMessage;
12 |   isLast: boolean;
13 | }
14 | 
15 | function SharedMessageComponent({ message, isLast }: SharedMessageProps) {
16 |   const isUser = message.role === "user";
17 |   const isAssistant = message.role === "assistant";
18 | 
19 |   return (
20 |     <div
21 |       className={cn(
22 |         "group/message flex gap-4 px-4 py-4 text-sm",
23 |         !isLast && "border-b border-border/40",
24 |         isUser && "bg-muted/30",
25 |       )}
26 |     >
27 |       {/* Avatar */}
28 |       <div className="flex-shrink-0">
29 |         <div
30 |           className={cn(
31 |             "flex h-8 w-8 items-center justify-center rounded-full border",
32 |             isUser
33 |               ? "bg-background text-foreground"
34 |               : "bg-primary text-primary-foreground"
35 |           )}
36 |         >
37 |           {isUser ? (
38 |             <UserIcon className="h-4 w-4" />
39 |           ) : (
40 |             <BotIcon className="h-4 w-4" />
41 |           )}
42 |         </div>
43 |       </div>
44 | 
45 |       {/* Content */}
46 |       <div className="flex-1 space-y-2 overflow-hidden">
47 |         {/* Role label */}
48 |         <div className="flex items-center gap-2">
49 |           <span className="text-xs font-medium text-muted-foreground">
50 |             {isUser ? "You" : "Assistant"}
51 |           </span>
52 |           {message.hasWebSearch && (
53 |             <div className="flex items-center gap-1 text-xs text-muted-foreground">
54 |               <SearchIcon className="h-3 w-3" />
55 |               <span>Web search used</span>
56 |             </div>
57 |           )}
58 |           <span className="text-xs text-muted-foreground">
59 |             {new Date(message.createdAt).toLocaleTimeString()}
60 |           </span>
61 |         </div>
62 | 
63 |         {/* Message content */}
64 |         <div className="prose prose-sm max-w-none dark:prose-invert">
65 |           {isAssistant ? (
66 |             <Markdown>{message.content}</Markdown>
67 |           ) : (
68 |             <div className="whitespace-pre-wrap break-words">
69 |               {message.content}
70 |             </div>
71 |           )}
72 |         </div>
73 | 
74 |         {/* Copy button */}
75 |         {message.content && (
76 |           <div className="flex justify-end">
77 |             <CopyButton 
78 |               text={message.content}
79 |             />
80 |           </div>
81 |         )}
82 |       </div>
83 |     </div>
84 |   );
85 | }
86 | 
87 | export const SharedMessage = memo(SharedMessageComponent, (prevProps, nextProps) => {
88 |   return (
89 |     prevProps.message.id === nextProps.message.id &&
90 |     prevProps.isLast === nextProps.isLast
91 |   );
92 | });
```

components/suggested-prompts.tsx
```
1 | "use client";
2 | 
3 | import { motion, AnimatePresence } from "framer-motion";
4 | import { Button } from "./ui/button";
5 | import { memo, useCallback, useState, useMemo, useRef, useEffect } from "react";
6 | import { useIsMobile } from "@/hooks/use-mobile";
7 | import { 
8 |   Code, 
9 |   MessageCircle, 
10 |   Lightbulb, 
11 |   Search, 
12 |   BookOpen, 
13 |   Zap,
14 |   Brain,
15 |   Globe,
16 |   Sparkles,
17 |   FileText,
18 |   Filter,
19 |   X,
20 |   Edit3,
21 |   Send,
22 |   ChevronLeft,
23 |   ChevronRight
24 | } from "lucide-react";
25 | import { Badge } from "./ui/badge";
26 | import { Input } from "./ui/input";
27 | import { getContextualSuggestions, getCategoryColor } from "@/lib/suggested-prompts-utils";
28 | import {
29 |   Dialog,
30 |   DialogContent,
31 |   DialogDescription,
32 |   DialogHeader,
33 |   DialogTitle,
34 | } from "./ui/dialog";
35 | import { Textarea } from "./ui/textarea";
36 | 
37 | export interface SuggestedAction {
38 |   title: string;
39 |   label: string;
40 |   action: string;
41 |   category?: string;
42 |   icon?: React.ReactNode;
43 | }
44 | 
45 | interface SuggestedPromptsProps {
46 |   sendMessage: (input: string) => void;
47 |   suggestions?: SuggestedAction[];
48 |   maxSuggestions?: number;
49 |   showCategories?: boolean;
50 |   selectedModel?: string;
51 | }
52 | 
53 | 
54 | 
55 | // Template configuration for different template types
56 | const TEMPLATE_CONFIGS = {
57 |   'explain-concept': {
58 |     title: 'What concept would you like me to explain?',
59 |     description: 'I\'ll explain it in simple terms using everyday analogies.',
60 |     placeholder: 'e.g., blockchain, quantum physics, machine learning...',
61 |     template: (input: string) => `Explain ${input} in simple terms, using everyday analogies that anyone can understand`,
62 |     multiline: false,
63 |   },
64 |   'debug-code': {
65 |     title: 'What code would you like me to debug?',
66 |     description: 'Paste your code and I\'ll help identify and fix any issues.',
67 |     placeholder: 'Paste your code here...',
68 |     template: (input: string) => `I'm having an issue with this code. Can you debug it and explain what's wrong?\n\n\`\`\`\n${input}\n\`\`\``,
69 |     multiline: true,
70 |   },
71 |   'summarize-text': {
72 |     title: 'What text would you like me to summarize?',
73 |     description: 'I\'ll create a clear, concise summary of the key points.',
74 |     placeholder: 'Paste the text you want summarized...',
75 |     template: (input: string) => `Please summarize this text and highlight the key points:\n\n${input}`,
76 |     multiline: true,
77 |   },
78 |   'learn-technology': {
79 |     title: 'What technology would you like to learn?',
80 |     description: 'I\'ll create a structured learning roadmap with resources and milestones.',
81 |     placeholder: 'e.g., React, Python, Docker, GraphQL...',
82 |     template: (input: string) => `Create a comprehensive learning roadmap for mastering ${input}, including key concepts, resources, and practical projects`,
83 |     multiline: false,
84 |   },
85 |   'review-document': {
86 |     title: 'What document would you like me to review?',
87 |     description: 'I\'ll review it for clarity, structure, and suggest improvements.',
88 |     placeholder: 'Paste your document here...',
89 |     template: (input: string) => `Please review this document and suggest improvements for clarity, structure, and effectiveness:\n\n${input}`,
90 |     multiline: true,
91 |   },
92 |   'write-email': {
93 |     title: 'What kind of email do you need help writing?',
94 |     description: 'I\'ll help you write a professional and clear email.',
95 |     placeholder: 'e.g., request a meeting, follow up on interview, ask for feedback...',
96 |     template: (input: string) => `Help me write a professional email to ${input}`,
97 |     multiline: false,
98 |   },
99 |   'write-story': {
100 |     title: 'What kind of story would you like me to write?',
101 |     description: 'I\'ll create an engaging story with interesting characters and plot.',
102 |     placeholder: 'e.g., sci-fi adventure on Mars, mystery in a small town, romance at a coffee shop...',
103 |     template: (input: string) => `Help me write a short story about ${input}`,
104 |     multiline: false,
105 |   },
106 |   'make-decision': {
107 |     title: 'What decision do you need help making?',
108 |     description: 'I\'ll help you weigh the pros and cons and ask clarifying questions.',
109 |     placeholder: 'e.g., accept a job offer, choose between two apartments, pick a college major...',
110 |     template: (input: string) => `Help me decide whether to ${input} by listing pros and cons and asking clarifying questions`,
111 |     multiline: false,
112 |   },
113 |   'brainstorm-ideas': {
114 |     title: 'What do you need ideas for?',
115 |     description: 'I\'ll help you brainstorm creative and practical solutions.',
116 |     placeholder: 'e.g., business name, party theme, weekend activities, project features...',
117 |     template: (input: string) => `Help me brainstorm creative ideas for ${input}`,
118 |     multiline: false,
119 |   },
120 |   'code-review': {
121 |     title: 'What code would you like me to review?',
122 |     description: 'I\'ll review your code and suggest improvements following best practices.',
123 |     placeholder: 'Paste your code here...',
124 |     template: (input: string) => `Please review this code and suggest improvements following best practices:\n\n\`\`\`\n${input}\n\`\`\``,
125 |     multiline: true,
126 |   },
127 |   'analyze-problem': {
128 |     title: 'What problem would you like me to analyze?',
129 |     description: 'I\'ll break it down step by step and provide a detailed analysis.',
130 |     placeholder: 'Describe the problem you\'re facing...',
131 |     template: (input: string) => `Break down this problem step by step and provide a detailed analysis: ${input}`,
132 |     multiline: true,
133 |   },
134 |   'write-content': {
135 |     title: 'What kind of content do you need?',
136 |     description: 'I\'ll help you create engaging and creative content.',
137 |     placeholder: 'e.g., blog post about AI, product description, social media caption...',
138 |     template: (input: string) => `Help me write engaging and creative content for ${input}`,
139 |     multiline: false,
140 |   },
141 |   'optimize-algorithm': {
142 |     title: 'What algorithm would you like me to optimize?',
143 |     description: 'I\'ll analyze it and suggest optimizations for better performance.',
144 |     placeholder: 'Paste your algorithm or code here...',
145 |     template: (input: string) => `Analyze this algorithm and suggest optimizations for better time/space complexity:\n\n\`\`\`\n${input}\n\`\`\``,
146 |     multiline: true,
147 |   },
148 |   'refactor-code': {
149 |     title: 'What code would you like me to refactor?',
150 |     description: 'I\'ll refactor it following clean architecture principles and design patterns.',
151 |     placeholder: 'Paste your code here...',
152 |     template: (input: string) => `Refactor this code following clean architecture principles and design patterns:\n\n\`\`\`\n${input}\n\`\`\``,
153 |     multiline: true,
154 |   },
155 |   'research-topic': {
156 |     title: 'What topic would you like me to research?',
157 |     description: 'I\'ll research it from multiple angles and synthesize the information.',
158 |     placeholder: 'e.g., climate change impacts, AI ethics, renewable energy trends...',
159 |     template: (input: string) => `Research ${input} from multiple angles and synthesize the information into a comprehensive overview`,
160 |     multiline: false,
161 |   },
162 |   'create-documentation': {
163 |     title: 'What would you like me to document?',
164 |     description: 'I\'ll create comprehensive documentation with usage examples.',
165 |     placeholder: 'Paste your code, API, or describe what needs documentation...',
166 |     template: (input: string) => `Create comprehensive documentation for this with usage examples:\n\n${input}`,
167 |     multiline: true,
168 |   },
169 |   'generate-tests': {
170 |     title: 'What function or component needs test cases?',
171 |     description: 'I\'ll generate comprehensive test cases including edge cases.',
172 |     placeholder: 'Paste your function/component code here...',
173 |     template: (input: string) => `Generate comprehensive test cases for this function/component including edge cases:\n\n\`\`\`\n${input}\n\`\`\``,
174 |     multiline: true,
175 |   },
176 |   'multimodal-analysis': {
177 |     title: 'What content would you like me to analyze?',
178 |     description: 'I\'ll analyze it across multiple formats and provide insights.',
179 |     placeholder: 'Describe the text, images, data, or other content to analyze...',
180 |     template: (input: string) => `Analyze this content across multiple formats and provide insights: ${input}`,
181 |     multiline: true,
182 |   },
183 |   'brainstorm-solutions': {
184 |     title: 'What challenge do you need solutions for?',
185 |     description: 'I\'ll help you brainstorm creative solutions to overcome it.',
186 |     placeholder: 'e.g., low team productivity, marketing strategy, technical architecture...',
187 |     template: (input: string) => `Help me brainstorm creative solutions to overcome this challenge: ${input}`,
188 |     multiline: false,
189 |   },
190 |   'plan-schedule': {
191 |     title: 'What would you like help planning?',
192 |     description: 'I\'ll create a balanced and realistic schedule or plan.',
193 |     placeholder: 'e.g., my weekly routine, study schedule, project timeline, workout plan...',
194 |     template: (input: string) => `Help me create a balanced and realistic plan for ${input}`,
195 |     multiline: false,
196 |   },
197 |   'write-cover-letter': {
198 |     title: 'What position are you applying for?',
199 |     description: 'I\'ll help you write a compelling cover letter.',
200 |     placeholder: 'e.g., Marketing Manager at Tech Corp, highlighting creativity and analytics...',
201 |     template: (input: string) => `Help me write a compelling cover letter for ${input}`,
202 |     multiline: false,
203 |   },
204 |   'write-social-post': {
205 |     title: 'What kind of social media post do you need?',
206 |     description: 'I\'ll help you create engaging and authentic content.',
207 |     placeholder: 'e.g., LinkedIn post about career growth, Twitter thread about AI...',
208 |     template: (input: string) => `Help me write an engaging social media post about ${input}`,
209 |     multiline: false,
210 |   },
211 |   'prepare-interview': {
212 |     title: 'What position are you interviewing for?',
213 |     description: 'I\'ll help you prepare with practice questions and tips.',
214 |     placeholder: 'e.g., Software Developer at startup, Marketing Manager at Fortune 500...',
215 |     template: (input: string) => `Help me prepare for a job interview for ${input} by creating practice questions and tips`,
216 |     multiline: false,
217 |   },
218 |   'create-workout-plan': {
219 |     title: 'What are your fitness goals?',
220 |     description: 'I\'ll design a personalized workout plan to help you achieve them.',
221 |     placeholder: 'e.g., lose weight, build muscle, improve endurance, yoga routine...',
222 |     template: (input: string) => `Create a detailed workout plan to help me ${input}, including exercises, sets, reps, and weekly schedule`,
223 |     multiline: false,
224 |   },
225 |   'suggest-date-ideas': {
226 |     title: 'What kind of date are you planning?',
227 |     description: 'I\'ll suggest creative and memorable date ideas.',
228 |     placeholder: 'e.g., first date, anniversary, budget-friendly, adventurous...',
229 |     template: (input: string) => `Suggest creative and memorable date ideas for ${input}`,
230 |     multiline: false,
231 |   },
232 |   'book-recommendations': {
233 |     title: 'What genres or topics interest you?',
234 |     description: 'I\'ll recommend books across different genres and topics.',
235 |     placeholder: 'e.g., sci-fi, mystery, self-help, history, fantasy...',
236 |     template: (input: string) => `Recommend a diverse list of must-read books in ${input} with brief descriptions of why each is worth reading`,
237 |     multiline: false,
238 |   },
239 |   'reduce-carbon-footprint': {
240 |     title: 'What area of your life do you want to make more eco-friendly?',
241 |     description: 'I\'ll suggest practical ways to reduce your environmental impact.',
242 |     placeholder: 'e.g., home energy use, transportation, diet, shopping habits...',
243 |     template: (input: string) => `Give me practical and actionable tips to reduce my carbon footprint in ${input}`,
244 |     multiline: false,
245 |   },
246 |   'create-recipe': {
247 |     title: 'What ingredients do you have or what dish do you want?',
248 |     description: 'I\'ll create a delicious recipe with detailed instructions.',
249 |     placeholder: 'e.g., chicken breast and vegetables, healthy breakfast, vegan dessert...',
250 |     template: (input: string) => `Create a delicious recipe using ${input} with detailed cooking instructions and tips`,
251 |     multiline: false,
252 |   },
253 |   'improve-public-speaking': {
254 |     title: 'What aspect of public speaking do you want to improve?',
255 |     description: 'I\'ll provide strategies and exercises to boost your confidence.',
256 |     placeholder: 'e.g., managing nerves, engaging audience, storytelling, body language...',
257 |     template: (input: string) => `Help me improve my public speaking skills, specifically ${input}, with practical exercises and strategies`,
258 |     multiline: false,
259 |   },
260 |   'save-money-tips': {
261 |     title: 'What area of spending do you want to optimize?',
262 |     description: 'I\'ll suggest strategies to help you save money effectively.',
263 |     placeholder: 'e.g., groceries, utilities, entertainment, travel, monthly expenses...',
264 |     template: (input: string) => `Give me practical money-saving strategies for ${input} that I can implement immediately`,
265 |     multiline: false,
266 |   },
267 |   'learn-language': {
268 |     title: 'What language do you want to learn?',
269 |     description: 'I\'ll provide effective techniques and a structured approach.',
270 |     placeholder: 'e.g., Spanish, French, Mandarin, Japanese, German...',
271 |     template: (input: string) => `Create a comprehensive guide for learning ${input}, including effective study techniques, resources, and milestones`,
272 |     multiline: false,
273 |   },
274 |   'travel-itinerary': {
275 |     title: 'Where do you want to travel and for how long?',
276 |     description: 'I\'ll create a detailed travel itinerary with activities and tips.',
277 |     placeholder: 'e.g., Japan for 2 weeks, weekend in Paris, backpacking Europe...',
278 |     template: (input: string) => `Create a detailed travel itinerary for ${input}, including must-see attractions, local experiences, and practical tips`,
279 |     multiline: false,
280 |   },
281 |   'manage-stress': {
282 |     title: 'What situations or areas cause you stress?',
283 |     description: 'I\'ll provide techniques for managing stress and anxiety.',
284 |     placeholder: 'e.g., work pressure, social situations, financial worries, daily life...',
285 |     template: (input: string) => `Give me effective techniques for managing stress and anxiety related to ${input}`,
286 |     multiline: false,
287 |   },
288 |   'team-building': {
289 |     title: 'What kind of team building activity do you need?',
290 |     description: 'I\'ll suggest engaging activities to strengthen team bonds.',
291 |     placeholder: 'e.g., virtual team, office meeting, outdoor event, creative workshop...',
292 |     template: (input: string) => `Suggest effective team-building activities for ${input} that will improve collaboration and morale`,
293 |     multiline: false,
294 |   },
295 |   'hobby-suggestions': {
296 |     title: 'What type of hobby interests you?',
297 |     description: 'I\'ll suggest interesting hobbies you might enjoy trying.',
298 |     placeholder: 'e.g., creative, outdoor, intellectual, social, crafts, sports...',
299 |     template: (input: string) => `Suggest interesting ${input} hobbies I could try, with information about getting started and what to expect`,
300 |     multiline: false,
301 |   },
302 |   'make-adult-friends': {
303 |     title: 'What\'s your situation for meeting new people?',
304 |     description: 'I\'ll provide tips for making meaningful connections as an adult.',
305 |     placeholder: 'e.g., new city, remote work, shy personality, specific interests...',
306 |     template: (input: string) => `Give me practical tips for making friends as an adult in my situation: ${input}`,
307 |     multiline: false,
308 |   },
309 |   'improve-memory': {
310 |     title: 'What do you want to remember better?',
311 |     description: 'I\'ll teach you techniques to enhance memory and recall.',
312 |     placeholder: 'e.g., names and faces, study material, daily tasks, languages...',
313 |     template: (input: string) => `Teach me effective techniques to improve my memory and recall abilities for ${input}`,
314 |     multiline: false,
315 |   },
316 |   'meditation-guide': {
317 |     title: 'What\'s your experience level with meditation?',
318 |     description: 'I\'ll create a personalized meditation practice guide.',
319 |     placeholder: 'e.g., complete beginner, some experience, specific technique like mindfulness...',
320 |     template: (input: string) => `Create a meditation practice guide for ${input}, including techniques, schedules, and tips for success`,
321 |     multiline: false,
322 |   },
323 |   'historical-facts': {
324 |     title: 'What historical period or topic interests you?',
325 |     description: 'I\'ll share fascinating historical facts and stories.',
326 |     placeholder: 'e.g., ancient Rome, World War II, Renaissance, specific country...',
327 |     template: (input: string) => `Share fascinating and lesser-known historical facts about ${input} that would surprise most people`,
328 |     multiline: false,
329 |   },
330 |   'space-facts': {
331 |     title: 'What aspect of space and the universe interests you?',
332 |     description: 'I\'ll share amazing facts about outer space and astronomy.',
333 |     placeholder: 'e.g., black holes, planets, space exploration, stars, galaxies...',
334 |     template: (input: string) => `Share mind-blowing facts about ${input} and explain them in an engaging way`,
335 |     multiline: false,
336 |   },
337 |   'unsolved-mysteries': {
338 |     title: 'What type of mysteries fascinate you?',
339 |     description: 'I\'ll tell you about intriguing unsolved mysteries.',
340 |     placeholder: 'e.g., historical, scientific, criminal, archaeological, paranormal...',
341 |     template: (input: string) => `Tell me about fascinating ${input} unsolved mysteries that continue to puzzle experts today`,
342 |     multiline: false,
343 |   },
344 |   'philosophical-discussion': {
345 |     title: 'What philosophical topic interests you?',
346 |     description: 'I\'ll explain philosophical concepts and encourage thoughtful discussion.',
347 |     placeholder: 'e.g., meaning of life, free will, ethics, consciousness, reality...',
348 |     template: (input: string) => `Explain the philosophical concept of ${input} and engage me in a thoughtful discussion about it`,
349 |     multiline: false,
350 |   },
351 |   'cultural-awareness': {
352 |     title: 'What culture or cultural aspect would you like to learn about?',
353 |     description: 'I\'ll help you become more culturally aware and respectful.',
354 |     placeholder: 'e.g., Japanese business culture, Middle Eastern traditions, Latin American customs...',
355 |     template: (input: string) => `Help me understand ${input} and how to be more culturally aware and respectful in my interactions`,
356 |     multiline: false,
357 |   },
358 |   'home-organization': {
359 |     title: 'What area of your home needs organizing?',
[TRUNCATED]
```

components/textarea.tsx
```
1 | import { modelID } from "@/ai/providers";
2 | import { Textarea as ShadcnTextarea } from "@/components/ui/textarea";
3 | import { ArrowUp, Square, Globe, AlertCircle, ImageIcon, Code2, X, Eye, EyeOff } from "lucide-react";
4 | import { ModelPicker } from "./model-picker";
5 | import { PresetSelector } from "./preset-selector";
6 | import { useRef, useState, useCallback } from "react";
7 | import { Tooltip, TooltipTrigger, TooltipContent } from "@/components/ui/tooltip";
8 | import { useWebSearch } from "@/lib/context/web-search-context";
9 | import { usePresets } from "@/lib/context/preset-context";
10 | import { useAuth } from "@/hooks/useAuth";
11 | import { useIsMobile } from "@/hooks/use-mobile";
12 | import { WEB_SEARCH_COST } from "@/lib/tokenCounter";
13 | import { ImageUpload } from "./image-upload";
14 | import { ImagePreview } from "./image-preview";
15 | import type { ImageAttachment } from "@/lib/types";
16 | import { Button } from "./ui/button";
17 | import { useModels } from "@/hooks/use-models";
18 | import { processTextInput } from "@/lib/text-utils";
19 | import { processKeyboardInput, expandCodeSnippet, cleanupCodeStructure } from "@/lib/text-utils";
20 | import { useClientMount } from "@/lib/hooks/use-client-mount";
21 | 
22 | interface InputProps {
23 |   input: string;
24 |   handleInputChange: (event: React.ChangeEvent<HTMLTextAreaElement>) => void;
25 |   isLoading: boolean;
26 |   status: string;
27 |   stop: () => void;
28 |   selectedModel: modelID;
29 |   setSelectedModel: (model: modelID) => void;
30 |   // Image upload props
31 |   images?: ImageAttachment[];
32 |   onImagesChange?: (images: ImageAttachment[]) => void;
33 | }
34 | 
35 | export const Textarea = ({
36 |   input,
37 |   handleInputChange,
38 |   isLoading,
39 |   status,
40 |   stop,
41 |   selectedModel,
42 |   setSelectedModel,
43 |   images = [],
44 |   onImagesChange,
45 | }: InputProps) => {
46 |   const isStreaming = status === "streaming" || status === "submitted";
47 |   const iconButtonRef = useRef<HTMLButtonElement>(null);
48 |   const textareaRef = useRef<HTMLTextAreaElement>(null);
49 |   const [showImageUpload, setShowImageUpload] = useState(false);
50 |   
51 |   // Code detection and enhancement state
52 |   const [isCodeMode, setIsCodeMode] = useState(false);
53 |   const [codeConfidence, setCodeConfidence] = useState(0);
54 |   const [lastProcessedLength, setLastProcessedLength] = useState(0);
55 |   const [detectedLanguage, setDetectedLanguage] = useState<string | null>(null);
56 |   const [showAutoWrapFeedback, setShowAutoWrapFeedback] = useState(false);
57 |   const [showAutoUnwrapFeedback, setShowAutoUnwrapFeedback] = useState(false);
58 |   const [autoDetectionEnabled, setAutoDetectionEnabled] = useState(true);
59 |   const isMounted = useClientMount();
60 | 
61 |   const { webSearchEnabled, setWebSearchEnabled } = useWebSearch();
62 |   const { activePreset } = usePresets();
63 |   const { user } = useAuth();
64 |   const isMobileScreen = useIsMobile();
65 |   const { models } = useModels();
66 | 
67 |   // Get the effective model ID - use preset model if active, otherwise selected model
68 |   const getEffectiveModel = (): modelID => {
69 |     return activePreset?.modelId || selectedModel;
70 |   };
71 | 
72 |   // Helper function to check if the effective model supports vision
73 |   const effectiveModelSupportsVision = (): boolean => {
74 |     const effectiveModelId = getEffectiveModel();
75 |     const modelInfo = models.find(model => model.id === effectiveModelId);
76 |     return modelInfo?.vision === true;
77 |   };
78 | 
79 |   // Get the effective web search enabled state - use preset setting if active, otherwise context setting
80 |   const getEffectiveWebSearchEnabled = (): boolean => {
81 |     return activePreset?.webSearchEnabled ?? webSearchEnabled;
82 |   };
83 | 
84 |   const handleWebSearchToggle = () => {
85 |     // Only allow toggle when no preset is active
86 |     if (!activePreset) {
87 |       setWebSearchEnabled(!webSearchEnabled);
88 |     }
89 |   };
90 | 
91 |   const handleAutoDetectionToggle = () => {
92 |     const newAutoDetectionEnabled = !autoDetectionEnabled;
93 |     setAutoDetectionEnabled(newAutoDetectionEnabled);
94 |     
95 |     if (!newAutoDetectionEnabled) {
96 |       // Disabling auto detection: clear code mode state and unwrap any code blocks
97 |       setIsCodeMode(false);
98 |       setCodeConfidence(0);
99 |       setDetectedLanguage(null);
100 |       
101 |       // Unwrap code blocks from the current input
102 |       const unwrappedText = unwrapCodeBlocks(input);
103 |       if (unwrappedText !== input) {
104 |         const syntheticEvent = {
105 |           target: { value: unwrappedText }
106 |         } as React.ChangeEvent<HTMLTextAreaElement>;
107 |         handleInputChange(syntheticEvent);
108 |         
109 |         // Show feedback that code blocks were automatically unwrapped
110 |         setShowAutoUnwrapFeedback(true);
111 |         setTimeout(() => setShowAutoUnwrapFeedback(false), 3000);
112 |       }
113 |     } else {
114 |       // Enabling auto detection: analyze current text and potentially wrap it
115 |       if (input.trim().length > 20) {
116 |         const processed = processTextInput(input, { autoWrapCode: true });
117 |         
118 |         if (processed.isCode && processed.confidence > 60) {
119 |           // Update code mode state
120 |           setIsCodeMode(true);
121 |           setCodeConfidence(processed.confidence);
122 |           setDetectedLanguage(processed.language || null);
123 |           
124 |           // If the text was wrapped, update the input
125 |           if (processed.wasWrapped && processed.processedText !== input) {
126 |             const syntheticEvent = {
127 |               target: { value: processed.processedText }
128 |             } as React.ChangeEvent<HTMLTextAreaElement>;
129 |             handleInputChange(syntheticEvent);
130 |             
131 |             // Show feedback that code was automatically wrapped
132 |             setShowAutoWrapFeedback(true);
133 |             setTimeout(() => setShowAutoWrapFeedback(false), 3000);
134 |           }
135 |         }
136 |       }
137 |     }
138 |   };
139 | 
140 |   // Helper function to unwrap code blocks
141 |   const unwrapCodeBlocks = (text: string): string => {
142 |     if (!text) return text;
143 |     
144 |     const trimmed = text.trim();
145 |     
146 |     // Check if text starts and ends with triple backticks (simple single code block)
147 |     if (trimmed.startsWith('```') && trimmed.endsWith('```') && trimmed.split('```').length === 3) {
148 |       const lines = trimmed.split('\n');
149 |       
150 |       // Need at least 3 lines: opening ```, content, closing ```
151 |       if (lines.length >= 3) {
152 |         // Remove first line (```language) and last line (```)
153 |         const unwrapped = lines.slice(1, -1).join('\n');
154 |         
155 |         // Preserve original leading/trailing whitespace structure
156 |         const leadingWhitespace = text.match(/^\s*/)?.[0] || '';
157 |         const trailingWhitespace = text.match(/\s*$/)?.[0] || '';
158 |         
159 |         return leadingWhitespace + unwrapped + trailingWhitespace;
160 |       }
161 |     }
162 |     
163 |     // Handle edge case: single line code block like ```javascript console.log('hello'); ```
164 |     const singleLineMatch = trimmed.match(/^```\w*\s*(.*?)\s*```$/);
165 |     if (singleLineMatch) {
166 |       const unwrapped = singleLineMatch[1];
167 |       const leadingWhitespace = text.match(/^\s*/)?.[0] || '';
168 |       const trailingWhitespace = text.match(/\s*$/)?.[0] || '';
169 |       return leadingWhitespace + unwrapped + trailingWhitespace;
170 |     }
171 |     
172 |     return text;
173 |   };
174 | 
175 |   // Check if user has enough credits for web search (5 credits minimum)
176 |   // Use a more resilient check that handles temporary null values during hot reload
177 |   const userCredits = user?.credits ?? 0;
178 |   const hasEnoughCreditsForWebSearch = user?.hasCredits !== false && userCredits >= WEB_SEARCH_COST;
179 |   const isAnonymousUser = !user || user?.isAnonymous;
180 |   // Only allow web search if user has sufficient credits and is not anonymous
181 |   const canUseWebSearch = !isAnonymousUser && hasEnoughCreditsForWebSearch;
182 | 
183 |   // Calculate estimated cost
184 |   const getEstimatedCost = () => {
185 |     const baseCost = 1; // Base cost for any message
186 |     const effectiveWebSearchEnabled = getEffectiveWebSearchEnabled();
187 |     const webSearchCost = effectiveWebSearchEnabled ? WEB_SEARCH_COST : 0;
188 |     return baseCost + webSearchCost;
189 |   };
190 | 
191 |   const estimatedCost = getEstimatedCost();
192 |   const shouldShowCostWarning = getEffectiveWebSearchEnabled() && canUseWebSearch && input.trim();
193 | 
194 |   // Focus textarea after model selection
195 |   const handleModelSelected = () => {
196 |     setTimeout(() => {
197 |       textareaRef.current?.focus();
198 |     }, 100);
199 |   };
200 | 
201 |   // Image handling functions
202 |   const handleImageSelect = (newImages: ImageAttachment[]) => {
203 |     if (onImagesChange) {
204 |       onImagesChange([...images, ...newImages]);
205 |     }
206 |     setShowImageUpload(false);
207 |   };
208 | 
209 |   const handleImageRemove = (index: number) => {
210 |     if (onImagesChange) {
211 |       const updatedImages = images.filter((_, i) => i !== index);
212 |       onImagesChange(updatedImages);
213 |     }
214 |   };
215 | 
216 |   const canUploadMore = images.length < 5;
217 |   const hasImages = images.length > 0;
218 | 
219 |   // Detect programming language from content
220 |   const detectLanguage = useCallback((text: string): string | null => {
221 |     const lowerText = text.toLowerCase();
222 |     
223 |     // JavaScript/TypeScript patterns
224 |     if (lowerText.includes('console.log') || lowerText.includes('function') || 
225 |         lowerText.includes('=>') || lowerText.includes('const ') || 
226 |         lowerText.includes('import ') || lowerText.includes('export ')) {
227 |       if (lowerText.includes('interface ') || lowerText.includes('type ') || 
228 |           text.includes(': string') || text.includes(': number')) {
229 |         return 'typescript';
230 |       }
231 |       return 'javascript';
232 |     }
233 |     
234 |     // Python patterns
235 |     if (lowerText.includes('def ') || lowerText.includes('import ') || 
236 |         lowerText.includes('print(') || lowerText.includes('class ') ||
237 |         lowerText.includes('if __name__')) {
238 |       return 'python';
239 |     }
240 |     
241 |     // HTML/JSX patterns
242 |     if (text.includes('<') && text.includes('>') && 
243 |         (text.includes('</') || text.includes('/>'))) {
244 |       if (text.includes('className=') || text.includes('onClick=')) {
245 |         return 'jsx';
246 |       }
247 |       return 'html';
248 |     }
249 |     
250 |     // CSS patterns
251 |     if (text.includes('{') && text.includes('}') && 
252 |         (text.includes(':') && text.includes(';'))) {
253 |       if (lowerText.includes('@media') || lowerText.includes('px') || 
254 |           lowerText.includes('rem') || lowerText.includes('color:')) {
255 |         return 'css';
256 |       }
257 |     }
258 |     
259 |     // JSON patterns
260 |     if (text.trim().startsWith('{') && text.trim().endsWith('}') ||
261 |         text.trim().startsWith('[') && text.trim().endsWith(']')) {
262 |       try {
263 |         JSON.parse(text);
264 |         return 'json';
265 |       } catch {}
266 |     }
267 |     
268 |     // SQL patterns
269 |     if (lowerText.includes('select ') || lowerText.includes('from ') || 
270 |         lowerText.includes('where ') || lowerText.includes('insert ')) {
271 |       return 'sql';
272 |     }
273 |     
274 |     return null;
275 |   }, []);
276 | 
277 |   // Paste event handler for enhanced text processing
278 |   const handlePaste = useCallback((e: React.ClipboardEvent<HTMLTextAreaElement>) => {
279 |     const pastedText = e.clipboardData.getData('text');
280 |     
281 |     if (!pastedText) return;
282 | 
283 |     // Process the pasted text with auto-wrapping enabled
284 |     const processed = processTextInput(pastedText, { autoWrapCode: true });
285 |     
286 |     if (processed.processedText !== pastedText) {
287 |       // Prevent default paste and use our processed version
288 |       e.preventDefault();
289 |       
290 |       const textarea = textareaRef.current;
291 |       if (!textarea) return;
292 | 
293 |       const selectionStart = textarea.selectionStart;
294 |       const selectionEnd = textarea.selectionEnd;
295 |       const currentValue = textarea.value;
296 |       
297 |       // Insert processed text at cursor position
298 |       const newValue = 
299 |         currentValue.slice(0, selectionStart) + 
300 |         processed.processedText + 
301 |         currentValue.slice(selectionEnd);
302 |       
303 |       // Create synthetic event to trigger handleInputChange
304 |       const syntheticEvent = {
305 |         target: { value: newValue }
306 |       } as React.ChangeEvent<HTMLTextAreaElement>;
307 |       
308 |       handleInputChange(syntheticEvent);
309 |       
310 |       // Restore cursor position
311 |       requestAnimationFrame(() => {
312 |         const newCursorPos = selectionStart + processed.processedText.length;
313 |         textarea.setSelectionRange(newCursorPos, newCursorPos);
314 |       });
315 |       
316 |       // Show feedback if code was automatically wrapped
317 |       if (processed.wasWrapped) {
318 |         console.log(`✅ Code automatically wrapped in \`\`\`${processed.language || ''}\`\`\` blocks`);
319 |         setShowAutoWrapFeedback(true);
320 |         // Hide feedback after 3 seconds
321 |         setTimeout(() => setShowAutoWrapFeedback(false), 3000);
322 |       }
323 |     }
324 |     
325 |     // Update code detection state only if auto detection is enabled
326 |     if (autoDetectionEnabled) {
327 |       if (processed.isCode && processed.confidence > 60) {
328 |         setIsCodeMode(true);
329 |         setCodeConfidence(processed.confidence);
330 |         setDetectedLanguage(processed.language || null);
331 |         console.log('Code detected:', processed.reasons, processed.language ? `(${processed.language})` : '');
332 |       } else if (processed.confidence < 30) {
333 |         setIsCodeMode(false);
334 |         setCodeConfidence(0);
335 |         setDetectedLanguage(null);
336 |       }
337 |     }
338 |     
339 |     setLastProcessedLength(processed.processedText.length);
340 |   }, [handleInputChange]);
341 | 
342 |   // Enhanced input change handler with dynamic code detection
343 |   const handleEnhancedInputChange = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {
344 |     const newValue = e.target.value;
345 |     
346 |     // Call the original handler first
347 |     handleInputChange(e);
348 |     
349 |     // Dynamic code detection for longer content (> 50 characters) - only if auto detection is enabled
350 |     if (autoDetectionEnabled && newValue.length > 50 && newValue.length % 20 === 0) {
351 |       const processed = processTextInput(newValue, { autoWrapCode: false }); // Don't auto-wrap during typing
352 |       
353 |       if (processed.isCode && processed.confidence > 70) {
354 |         if (!isCodeMode) {
355 |           setIsCodeMode(true);
356 |           setCodeConfidence(processed.confidence);
357 |           setDetectedLanguage(processed.language || null);
358 |         }
359 |       } else if (processed.confidence < 20 && isCodeMode) {
360 |         // Only switch out of code mode if confidence is very low
361 |         setIsCodeMode(false);
362 |         setCodeConfidence(0);
363 |         setDetectedLanguage(null);
364 |       }
365 |     }
366 |     
367 |     // Clear code mode for very short content - only if auto detection is enabled
368 |     if (autoDetectionEnabled && newValue.length < 20 && isCodeMode) {
369 |       setIsCodeMode(false);
370 |       setCodeConfidence(0);
371 |       setDetectedLanguage(null);
372 |     }
373 |   }, [handleInputChange, isCodeMode, detectLanguage, autoDetectionEnabled]);
374 | 
375 |   // Enhanced keyboard handler with smart input processing
376 |   const handleEnhancedKeyDown = useCallback((e: React.KeyboardEvent<HTMLTextAreaElement>) => {
377 |     const textarea = textareaRef.current;
378 |     if (!textarea) return;
379 | 
380 |     const cursorPosition = textarea.selectionStart;
381 |     const key = e.key;
382 | 
383 |     // Handle Enter submission (preserve existing behavior)
384 |     if (key === "Enter" && !e.shiftKey && !isLoading && (input.trim() || hasImages)) {
385 |       e.preventDefault();
386 |       e.currentTarget.form?.requestSubmit();
387 |       return;
388 |     }
389 | 
390 |     // Handle Ctrl/Cmd+K for manual code wrapping
391 |     if ((e.ctrlKey || e.metaKey) && key === 'k') {
392 |       e.preventDefault();
393 |       
394 |       const selectionStart = textarea.selectionStart;
395 |       const selectionEnd = textarea.selectionEnd;
396 |       
397 |       if (selectionStart !== selectionEnd) {
398 |         // Wrap selected text
399 |         const selectedText = input.slice(selectionStart, selectionEnd);
400 |         const processed = processTextInput(selectedText, { forceCodeWrapping: true });
401 |         
402 |         const newValue = 
403 |           input.slice(0, selectionStart) + 
404 |           processed.processedText + 
405 |           input.slice(selectionEnd);
406 |         
407 |         const syntheticEvent = {
408 |           target: { value: newValue }
409 |         } as React.ChangeEvent<HTMLTextAreaElement>;
410 |         
411 |         handleInputChange(syntheticEvent);
412 |         
413 |         // Show feedback
414 |         if (processed.wasWrapped) {
415 |           setShowAutoWrapFeedback(true);
416 |           setTimeout(() => setShowAutoWrapFeedback(false), 3000);
417 |         }
418 |         
419 |         // Restore selection around the wrapped code
420 |         requestAnimationFrame(() => {
421 |           const newStart = selectionStart;
422 |           const newEnd = selectionStart + processed.processedText.length;
423 |           textarea.setSelectionRange(newStart, newEnd);
424 |         });
425 |       } else {
426 |         // No selection - wrap entire input if it looks like code
427 |         const processed = processTextInput(input, { forceCodeWrapping: true });
428 |         
429 |         if (processed.wasWrapped) {
430 |           const syntheticEvent = {
431 |             target: { value: processed.processedText }
432 |           } as React.ChangeEvent<HTMLTextAreaElement>;
433 |           
434 |           handleInputChange(syntheticEvent);
435 |           setShowAutoWrapFeedback(true);
436 |           setTimeout(() => setShowAutoWrapFeedback(false), 3000);
437 |           
438 |           // Keep cursor at the end
439 |           requestAnimationFrame(() => {
440 |             textarea.setSelectionRange(processed.processedText.length, processed.processedText.length);
441 |           });
442 |         }
443 |       }
444 |       return;
445 |     }
446 | 
447 |     // Skip processing for modifier keys or special keys
448 |     if (e.ctrlKey || e.metaKey || e.altKey || key.length > 1) {
449 |       // Allow Tab for indentation in code mode
450 |       if (key === 'Tab' && isCodeMode) {
451 |         // Handle tab logic below
452 |       } else {
453 |         return;
454 |       }
455 |     }
456 | 
457 |     // Process keyboard input with smart enhancements
458 |     const processed = processKeyboardInput(key, input, cursorPosition, detectedLanguage);
459 | 
460 |     if (processed.shouldPreventDefault) {
461 |       e.preventDefault();
462 | 
463 |       if (processed.newText && processed.newCursorPosition !== undefined) {
464 |         // Create synthetic event for the new text
465 |         const syntheticEvent = {
466 |           target: { value: processed.newText }
467 |         } as React.ChangeEvent<HTMLTextAreaElement>;
468 | 
469 |         handleInputChange(syntheticEvent);
470 | 
471 |         // Set cursor position after React updates
472 |         requestAnimationFrame(() => {
473 |           textarea.setSelectionRange(processed.newCursorPosition!, processed.newCursorPosition!);
474 |         });
475 |       }
476 |     }
477 | 
478 |     // Handle code snippet expansion on space or tab
479 |     if ((key === ' ' || key === 'Tab') && isCodeMode && detectedLanguage) {
480 |       const words = input.slice(0, cursorPosition).split(/\s+/);
481 |       const lastWord = words[words.length - 1];
482 |       
483 |       if (lastWord && lastWord.length > 1) {
484 |         const snippet = expandCodeSnippet(lastWord, detectedLanguage);
485 |         if (snippet) {
486 |           e.preventDefault();
487 |           
488 |           // Replace the trigger word with the snippet
489 |           const beforeWord = input.slice(0, cursorPosition - lastWord.length);
490 |           const afterCursor = input.slice(cursorPosition);
491 |           
492 |           // Simple snippet expansion (remove ${} placeholders for now)
493 |           const expandedSnippet = snippet.replace(/\$\{\d+:?([^}]*)\}/g, '$1');
494 |           const newText = beforeWord + expandedSnippet + afterCursor;
495 |           
496 |           const syntheticEvent = {
497 |             target: { value: newText }
498 |           } as React.ChangeEvent<HTMLTextAreaElement>;
499 |           
500 |           handleInputChange(syntheticEvent);
501 |           
502 |           // Position cursor at first placeholder or end of snippet
503 |           const newCursorPos = beforeWord.length + expandedSnippet.indexOf('// ');
504 |           if (newCursorPos > beforeWord.length) {
505 |             requestAnimationFrame(() => {
506 |               textarea.setSelectionRange(newCursorPos, newCursorPos + 3); // Select "// "
507 |             });
508 |           }
509 |         }
510 |       }
511 |     }
512 |   }, [input, isLoading, hasImages, handleInputChange, isCodeMode, detectedLanguage]);
513 | 
514 |   // Determine tooltip message based on credit status
515 |   const getWebSearchTooltipMessage = () => {
516 |     if (activePreset) {
517 |       return activePreset.webSearchEnabled 
518 |         ? `Web search is enabled by "${activePreset.name}" preset`
519 |         : `Web search is disabled by "${activePreset.name}" preset`;
520 |     }
521 |     if (isAnonymousUser) {
522 |       return "Sign in and purchase credits to enable Web Search";
523 |     }
524 |     if (!hasEnoughCreditsForWebSearch) {
525 |       return "Purchase credits to enable Web Search";
526 |     }
527 |     const effectiveWebSearchEnabled = getEffectiveWebSearchEnabled();
528 |     return effectiveWebSearchEnabled ? 'Disable web search' : 'Enable web search';
529 |   };
530 | 
531 | 
532 | 
533 |   return (
534 |     <div className="w-full space-y-3">
535 |       {/* Image Upload Interface */}
536 |       {effectiveModelSupportsVision() && showImageUpload && (
537 |         <div className="bg-card border border-border rounded-xl p-4">
538 |           <ImageUpload
539 |             onImageSelect={handleImageSelect}
540 |             maxFiles={3 - images.length}
541 |             disabled={isLoading || !canUploadMore}
542 |             showDetailSelector={true}
543 |           />
544 |         </div>
545 |       )}
546 | 
547 |       {/* Image Preview */}
[TRUNCATED]
```

components/theme-provider.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import { ThemeProvider as NextThemesProvider } from "next-themes"
5 | import { type ThemeProviderProps } from "next-themes"
6 | 
7 | export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
8 |   return (
9 |     <NextThemesProvider {...props}>
10 |       {children}
11 |     </NextThemesProvider>
12 |   );
13 | } 
```

components/theme-toggle.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import { CircleDashed, Flame, Sun, TerminalSquare, CassetteTape, Leaf } from "lucide-react"
5 | import { useTheme } from "next-themes"
6 | import { Button } from "./ui/button"
7 | import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "./ui/dropdown-menu"
8 | import { cn } from "@/lib/utils"
9 | 
10 | // Add a 'trigger' prop to the interface
11 | interface ThemeToggleProps extends Omit<React.ComponentProps<typeof Button>, 'asChild'> {
12 |   trigger?: React.ReactNode;
13 |   showLabel?: boolean;
14 |   labelText?: React.ReactNode;
15 | }
16 | 
17 | export function ThemeToggle({ className, trigger, showLabel, labelText, ...props }: ThemeToggleProps) {
18 |   const { setTheme, theme, resolvedTheme } = useTheme()
19 | 
20 |   // Determine the icon to display
21 |   let IconComponent;
22 |   const iconClassName = "h-4 w-4 flex-shrink-0 text-muted-foreground";
23 | 
24 |   // Use `theme` if it's one of the explicit themes we set
25 |   // Otherwise, rely on `resolvedTheme` which handles 'system' or initial undefined `theme`
26 |   const activeTheme = (theme && theme !== 'system') ? theme : resolvedTheme;
27 | 
28 |   switch (activeTheme) {
29 |     case "light":
30 |       IconComponent = <Sun className={iconClassName} />;
31 |       break;
32 |     case "dark":
33 |       IconComponent = <Flame className={iconClassName} />;
34 |       break;
35 |     case "black":
36 |       IconComponent = <CircleDashed className={iconClassName} />;
37 |       break;
38 |     case "sunset":
39 |       IconComponent = <Sun className={iconClassName} />; // Using Sun for sunset
40 |       break;
41 |     case "cyberpunk":
42 |       IconComponent = <TerminalSquare className={iconClassName} />;
43 |       break;
44 |     case "retro":
45 |       IconComponent = <CassetteTape className={iconClassName} />;
46 |       break;
47 |     case "nature":
48 |       IconComponent = <Leaf className={iconClassName} />;
49 |       break;
50 |     default:
51 |       // Fallback if activeTheme is somehow still not recognized
52 |       IconComponent = <Flame className={iconClassName} />; // Default to Flame
53 |   }
54 | 
55 |   // Conditionally render the trigger or the default button
56 |   const TriggerComponent = trigger ? (
57 |     <DropdownMenuTrigger asChild={true}>{trigger}</DropdownMenuTrigger>
58 |   ) : (
59 |     <DropdownMenuTrigger asChild={!showLabel || !labelText}>
60 |       {showLabel && labelText ? (
61 |         <div className={cn("flex items-center gap-2", className)}>
62 |           {IconComponent}
63 |           {labelText}
64 |         </div>
65 |       ) : (
66 |         <Button
67 |           variant="ghost"
68 |           size="icon"
69 |           className={cn("rounded-md", className)}
70 |           {...props}
71 |         >
72 |           {IconComponent}
73 |           <span className="sr-only">Toggle theme</span>
74 |         </Button>
75 |       )}
76 |     </DropdownMenuTrigger>
77 |   );
78 | 
79 |   return (
80 |     <DropdownMenu>
81 |       {TriggerComponent}
82 |       <DropdownMenuContent align="end">
83 |         <DropdownMenuItem onSelect={() => setTheme("dark")}>
84 |           <Flame className="mr-2 h-4 w-4" />
85 |           <span>Dark</span>
86 |         </DropdownMenuItem>
87 |         <DropdownMenuItem onSelect={() => setTheme("light")}>
88 |           <Sun className="mr-2 h-4 w-4" />
89 |           <span>Light</span>
90 |         </DropdownMenuItem>
91 |         <DropdownMenuItem onSelect={() => setTheme("black")}>
92 |           <CircleDashed className="mr-2 h-4 w-4" />
93 |           <span>Black</span>
94 |         </DropdownMenuItem>
95 |         <DropdownMenuItem onSelect={() => setTheme("sunset")}>
96 |           <Sun className="mr-2 h-4 w-4" />
97 |           <span>Sunset</span>
98 |         </DropdownMenuItem>
99 |         <DropdownMenuItem onSelect={() => setTheme("cyberpunk")}>
100 |           <TerminalSquare className="mr-2 h-4 w-4" />
101 |           <span>Cyberpunk</span>
102 |         </DropdownMenuItem>
103 |         <DropdownMenuItem onSelect={() => setTheme("retro")}>
104 |           <CassetteTape className="mr-2 h-4 w-4" />
105 |           <span>Retro</span>
106 |         </DropdownMenuItem>
107 |         <DropdownMenuItem onSelect={() => setTheme("nature")}>
108 |           <Leaf className="mr-2 h-4 w-4" />
109 |           <span>Nature</span>
110 |         </DropdownMenuItem>
111 |       </DropdownMenuContent>
112 |     </DropdownMenu>
113 |   )
114 | }
```

components/tool-invocation.tsx
```
1 | "use client";
2 | 
3 | import { useState } from "react";
4 | import { motion, AnimatePresence } from "framer-motion";
5 | import {
6 |   ChevronDownIcon,
7 |   ChevronUpIcon,
8 |   Loader2,
9 |   CheckCircle2,
10 |   TerminalSquare,
11 |   Code,
12 |   ArrowRight,
13 |   Circle,
14 | } from "lucide-react";
15 | import { cn } from "@/lib/utils";
16 | 
17 | interface ToolInvocationProps {
18 |   toolName: string;
19 |   state: string;
20 |   args: any;
21 |   result: any;
22 |   isLatestMessage: boolean;
23 |   status: string;
24 | }
25 | 
26 | export function ToolInvocation({
27 |   toolName,
28 |   state,
29 |   args,
30 |   result,
31 |   isLatestMessage,
32 |   status,
33 | }: ToolInvocationProps) {
34 |   const [isExpanded, setIsExpanded] = useState(false);
35 | 
36 |   const variants = {
37 |     collapsed: {
38 |       height: 0,
39 |       opacity: 0,
40 |     },
41 |     expanded: {
42 |       height: "auto",
43 |       opacity: 1,
44 |     },
45 |   };
46 | 
47 |   const getStatusIcon = () => {
48 |     if (state === "call") {
49 |       if (isLatestMessage && status !== "ready") {
50 |         return <Loader2 className="animate-spin h-3.5 w-3.5 text-primary/70" />;
51 |       }
52 |       return <Circle className="h-3.5 w-3.5 fill-muted-foreground/10 text-muted-foreground/70" />;
53 |     }
54 |     return <CheckCircle2 size={14} className="text-primary/90" />;
55 |   };
56 | 
57 |   const getStatusClass = () => {
58 |     if (state === "call") {
59 |       if (isLatestMessage && status !== "ready") {
60 |         return "text-primary";
61 |       }
62 |       return "text-muted-foreground";
63 |     }
64 |     return "text-primary";
65 |   };
66 | 
67 |   const formatContent = (content: any): string => {
68 |     try {
69 |       if (typeof content === "string") {
70 |         try {
71 |           const parsed = JSON.parse(content);
72 |           return JSON.stringify(parsed, null, 2);
73 |         } catch {
74 |           return content;
75 |         }
76 |       }
77 |       return JSON.stringify(content, null, 2);
78 |     } catch {
79 |       return String(content);
80 |     }
81 |   };
82 | 
83 |   return (
84 |     <div className={cn(
85 |       "flex flex-col mb-2 rounded-md border border-border/50 overflow-hidden",
86 |       "bg-gradient-to-b from-background to-muted/30 backdrop-blur-sm",
87 |       "transition-all duration-200 hover:border-border/80 group"
88 |     )}>
89 |       <div 
90 |         className={cn(
91 |           "flex items-center gap-2.5 px-3 py-2 cursor-pointer transition-colors",
92 |           "hover:bg-muted/20"
93 |         )}
94 |         onClick={() => setIsExpanded(!isExpanded)}
95 |       >
96 |         <div className="flex items-center justify-center rounded-full w-5 h-5 bg-primary/5 text-primary">
97 |           <TerminalSquare className="h-3.5 w-3.5" />
98 |         </div>
99 |         <div className="flex items-center gap-1.5 text-xs font-medium text-muted-foreground flex-1">
100 |           <span className="text-foreground font-semibold tracking-tight">{toolName}</span>
101 |           <ArrowRight className="h-3 w-3 text-muted-foreground/50" />
102 |           <span className={cn("font-medium", getStatusClass())}>
103 |             {state === "call" ? (isLatestMessage && status !== "ready" ? "Running" : "Waiting") : "Completed"}
104 |           </span>
105 |         </div>
106 |         <div className="flex items-center gap-2 opacity-70 group-hover:opacity-100 transition-opacity sm:opacity-70 sm:group-hover:opacity-100 opacity-100">
107 |           {getStatusIcon()}
108 |           <div className="bg-muted/30 rounded-full p-0.5 border border-border/30">
109 |             {isExpanded ? (
110 |               <ChevronUpIcon className="h-3 w-3 text-foreground/70" />
111 |             ) : (
112 |               <ChevronDownIcon className="h-3 w-3 text-foreground/70" />
113 |             )}
114 |           </div>
115 |         </div>
116 |       </div>
117 | 
118 |       <AnimatePresence initial={false}>
119 |         {isExpanded && (
120 |           <motion.div
121 |             initial="collapsed"
122 |             animate="expanded"
123 |             exit="collapsed"
124 |             variants={variants}
125 |             transition={{ duration: 0.2 }}
126 |             className="space-y-2 px-3 pb-3"
127 |           >
128 |             {!!args && (
129 |               <div className="space-y-1.5">
130 |                 <div className="flex items-center gap-1.5 text-xs text-muted-foreground/70 pt-1.5">
131 |                   <Code className="h-3 w-3" />
132 |                   <span className="font-medium">Arguments</span>
133 |                 </div>
134 |                 <pre className={cn(
135 |                   "text-xs font-mono p-2.5 rounded-md overflow-x-auto",
136 |                   "border border-border/40 bg-muted/10"
137 |                 )}>
138 |                   {formatContent(args)}
139 |                 </pre>
140 |               </div>
141 |             )}
142 |             
143 |             {!!result && (
144 |               <div className="space-y-1.5">
145 |                 <div className="flex items-center gap-1.5 text-xs text-muted-foreground/70">
146 |                   <ArrowRight className="h-3 w-3" />
147 |                   <span className="font-medium">Result</span>
148 |                 </div>
149 |                 <pre className={cn(
150 |                   "text-xs font-mono p-2.5 rounded-md overflow-x-auto max-h-[300px] overflow-y-auto",
151 |                   "border border-border/40 bg-muted/10"
152 |                 )}>
153 |                   {formatContent(result)}
154 |                 </pre>
155 |               </div>
156 |             )}
157 |           </motion.div>
158 |         )}
159 |       </AnimatePresence>
160 |     </div>
161 |   );
162 | } 
```

components/top-nav.tsx
```
1 | "use client";
2 | 
3 | import { useState } from "react";
4 | import { useParams } from "next/navigation";
5 | import { PlusCircle, Menu, Share } from "lucide-react";
6 | import { Button } from "@/components/ui/button";
7 | import { SidebarTrigger } from "@/components/ui/sidebar";
8 | import { ChatShareDialog } from "@/components/chat-share-dialog";
9 | import { useQuery } from "@tanstack/react-query";
10 | import Link from "next/link";
11 | import { toast } from "sonner";
12 | 
13 | export function TopNav() {
14 |   const params = useParams();
15 |   const chatId = params?.id as string | undefined;
16 |   const [isShareDialogOpen, setIsShareDialogOpen] = useState(false);
17 | 
18 |   // Fetch chat title for sharing - only when actually needed
19 |   const { data: chatData } = useQuery({
20 |     queryKey: ['chat', chatId],
21 |     queryFn: async () => {
22 |       if (!chatId) return null;
23 |       const response = await fetch(`/api/chats/${chatId}`);
24 |       if (!response.ok) return null;
25 |       return response.json();
26 |     },
27 |     enabled: !!chatId && isShareDialogOpen,
28 |     staleTime: 5 * 60 * 1000, // Cache for 5 minutes
29 |   });
30 | 
31 |   const handleNewChat = () => {
32 |     // Use window.location for more reliable navigation
33 |     window.location.href = '/';
34 |   };
35 | 
36 |   const handleShare = () => {
37 |     setIsShareDialogOpen(true);
38 |   };
39 | 
40 |   return (
41 |     <>
42 |       <nav className="sticky top-0 z-50 bg-background/95 backdrop-blur-md border-b border-border/40 px-4 py-4 h-[72px] flex items-center relative">
43 |         {/* Mobile Hamburger Menu - Left side */}
44 |         <div className="absolute left-4">
45 |           <SidebarTrigger>
46 |             <button 
47 |               className="flex items-center justify-center h-9 w-9 bg-muted hover:bg-accent rounded-md transition-colors"
48 |               aria-label="Open sidebar"
49 |             >
50 |               <Menu className="h-4 w-4" />
51 |             </button>
52 |           </SidebarTrigger>
53 |         </div>
54 |         
55 |         {/* ChatLima title - Truly centered */}
56 |         <div className="flex-1 flex justify-center">
57 |           <h1 className="text-3xl font-semibold">ChatLima</h1>
58 |         </div>
59 |         
60 |         {/* Action buttons and legal links - Right side */}
61 |         <div className="absolute right-4 flex items-center gap-4">
62 |           {/* Legal links */}
63 |           <div className="hidden sm:flex items-center gap-3 text-xs text-muted-foreground/70">
64 |             <Link
65 |               href="/terms"
66 |               className="hover:text-muted-foreground hover:underline transition-colors"
67 |             >
68 |               Terms
69 |             </Link>
70 |             <span className="text-muted-foreground/40">•</span>
71 |             <Link
72 |               href="/privacy"
73 |               className="hover:text-muted-foreground hover:underline transition-colors"
74 |             >
75 |               Privacy
76 |             </Link>
77 |           </div>
78 |           
79 |           {/* Share button - only show if we're on a chat page */}
80 |           {chatId && (
81 |             <Button
82 |               variant="ghost"
83 |               size="icon"
84 |               className="flex items-center justify-center h-9 w-9 bg-muted hover:bg-accent rounded-md transition-colors"
85 |               onClick={handleShare}
86 |               title="Share chat"
87 |               aria-label="Share this chat"
88 |             >
89 |               <Share className="h-4 w-4" />
90 |             </Button>
91 |           )}
92 |           
93 |           {/* New Chat Button */}
94 |           <Button
95 |             variant="ghost"
96 |             size="icon"
97 |             className="flex items-center justify-center h-9 w-9 bg-primary hover:bg-primary/90 text-primary-foreground rounded-md transition-colors"
98 |             onClick={handleNewChat}
99 |             title="New Chat"
100 |             aria-label="Start new chat"
101 |           >
102 |             <PlusCircle className="h-4 w-4" />
103 |           </Button>
104 |         </div>
105 |       </nav>
106 | 
107 |       {/* Share Dialog */}
108 |       {chatId && chatData && (
109 |         <ChatShareDialog
110 |           isOpen={isShareDialogOpen}
111 |           onOpenChange={setIsShareDialogOpen}
112 |           chatId={chatId}
113 |           chatTitle={chatData.title || "Untitled Chat"}
114 |         />
115 |       )}
116 |     </>
117 |   );
118 | } 
```

components/web-search-suggestion.tsx
```
1 | "use client";
2 | 
3 | import { useState, useEffect } from "react";
4 | import { X, Lightbulb, Globe } from "lucide-react";
5 | import { useWebSearch } from "@/lib/context/web-search-context";
6 | import { WEB_SEARCH_COST } from "@/lib/tokenCounter";
7 | import { motion, AnimatePresence } from "framer-motion";
8 | import { useClientMount } from "@/lib/hooks/use-client-mount";
9 | 
10 | interface WebSearchSuggestionProps {
11 |   messageId: string;
12 |   hasWebSearchResults?: boolean;
13 | }
14 | 
15 | export function WebSearchSuggestion({ messageId, hasWebSearchResults }: WebSearchSuggestionProps) {
16 |   const [dismissed, setDismissed] = useState(false);
17 |   const [showSuggestion, setShowSuggestion] = useState(false);
18 |   const isMounted = useClientMount();
19 |   const { webSearchEnabled, setWebSearchEnabled } = useWebSearch();
20 | 
21 |   // Show suggestion only if:
22 |   // 1. Web search is currently enabled
23 |   // 2. Message has web search results (indicates this was a web search response)
24 |   // 3. User hasn't dismissed it
25 |   useEffect(() => {
26 |     if (webSearchEnabled && hasWebSearchResults && !dismissed) {
27 |       setShowSuggestion(true);
28 |     } else {
29 |       setShowSuggestion(false);
30 |     }
31 |   }, [webSearchEnabled, hasWebSearchResults, dismissed, messageId]);
32 | 
33 |   // Reset dismissed state when web search is toggled back on
34 |   useEffect(() => {
35 |     if (!webSearchEnabled) {
36 |       setDismissed(false);
37 |     }
38 |   }, [webSearchEnabled]);
39 | 
40 |   const handleDisableWebSearch = () => {
41 |     setWebSearchEnabled(false);
42 |     setDismissed(true);
43 |   };
44 | 
45 |   const handleDismiss = () => {
46 |     setDismissed(true);
47 |   };
48 | 
49 |   if (!isMounted || !showSuggestion) return null;
50 | 
51 |   return (
52 |     <AnimatePresence>
53 |       <motion.div
54 |         key={`suggestion-${messageId}`}
55 |         initial={{ opacity: 0, y: 10, scale: 0.95 }}
56 |         animate={{ opacity: 1, y: 0, scale: 1 }}
57 |         exit={{ opacity: 0, y: -10, scale: 0.95 }}
58 |         transition={{ duration: 0.3, ease: "easeInOut" }}
59 |         className="mt-3 p-3 bg-blue-50/80 dark:bg-blue-900/20 border border-blue-200/60 dark:border-blue-700/40 rounded-lg"
60 |       >
61 |         <div className="flex items-start gap-3">
62 |           <div className="flex-shrink-0 mt-0.5">
63 |             <div className="p-1 bg-blue-100 dark:bg-blue-800/40 rounded-full">
64 |               <Lightbulb className="h-3.5 w-3.5 text-blue-600 dark:text-blue-400" />
65 |             </div>
66 |           </div>
67 |           
68 |           <div className="flex-1 min-w-0">
69 |             <div className="text-sm text-blue-900 dark:text-blue-100 font-medium mb-1">
70 |               Save credits on follow-up questions
71 |             </div>
72 |             <div className="text-xs text-blue-700 dark:text-blue-200 mb-3 leading-relaxed">
73 |               Follow-up questions about these results don&apos;t need web search. 
74 |               Disable it to save {WEB_SEARCH_COST} credits per message.
75 |             </div>
76 |             
77 |             <div className="flex items-center gap-2">
78 |               <button
79 |                 onClick={handleDisableWebSearch}
80 |                 className="inline-flex items-center gap-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white px-2.5 py-1 rounded-full transition-colors duration-150 font-medium"
81 |               >
82 |                 <Globe className="h-3 w-3" />
83 |                 Disable Web Search
84 |               </button>
85 |               <button
86 |                 onClick={handleDismiss}
87 |                 className="text-xs text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors duration-150"
88 |               >
89 |                 Keep enabled
90 |               </button>
91 |             </div>
92 |           </div>
93 |           
94 |           <button
95 |             onClick={handleDismiss}
96 |             className="flex-shrink-0 p-1 text-blue-400 hover:text-blue-600 dark:text-blue-500 dark:hover:text-blue-300 transition-colors duration-150"
97 |             aria-label="Dismiss suggestion"
98 |           >
99 |             <X className="h-3.5 w-3.5" />
100 |           </button>
101 |         </div>
102 |       </motion.div>
103 |     </AnimatePresence>
104 |   );
105 | } 
```

docs/FEATURE_PLAN_dynamic-ai-models.md
```
1 | # Feature: Dynamic AI Models
2 | 
3 | ## 🎯 Overview
4 | Implement a dynamic AI model system that allows users to select and switch between different AI models dynamically during chat sessions. This feature will provide flexibility in model selection based on user preferences, use case requirements, and cost considerations.
5 | 
6 | ## 📋 Requirements
7 | - [ ] Dynamic model selection interface in the chat UI
8 | - [ ] Real-time model switching during conversations
9 | - [ ] Model-specific parameter configuration
10 | - [ ] Cost tracking per model selection
11 | - [ ] Model availability and status indicators
12 | - [ ] User preference persistence for model selection
13 | - [ ] Fallback mechanisms for unavailable models
14 | 
15 | ## 🏗️ Implementation Plan
16 | 1. **Step 1**: Extend AI provider system to support dynamic model loading
17 |    - Modify `ai/providers.ts` to handle dynamic model selection
18 |    - Create model registry and configuration system
19 |    - Implement model availability checking
20 | 
21 | 2. **Step 2**: Update chat interface for model selection
22 |    - Enhance `components/model-picker.tsx` for dynamic switching
23 |    - Add model comparison and information display
24 |    - Implement real-time model switching UI
25 | 
26 | 3. **Step 3**: Backend API enhancements
27 |    - Update chat API to handle model-specific requests
28 |    - Implement model validation and routing
29 |    - Add model usage tracking and analytics
30 | 
31 | 4. **Step 4**: Database schema updates
32 |    - Add model preferences to user settings
33 |    - Create model usage tracking tables
34 |    - Implement cost calculation per model
35 | 
36 | 5. **Step 5**: Testing and validation
37 |    - Unit tests for model switching logic
38 |    - Integration tests for API endpoints
39 |    - E2E tests for user model selection workflows
40 | 
41 | ## 📁 Files to Modify/Create
42 | - `ai/providers.ts` - Dynamic model loading and configuration
43 | - `components/model-picker.tsx` - Enhanced model selection UI
44 | - `lib/model-context.tsx` - Model state management
45 | - `app/api/chat/route.ts` - Model-specific request handling
46 | - `lib/db/schema.ts` - Database schema for model preferences
47 | - `components/chat.tsx` - Integration with dynamic model system
48 | - `lib/types.ts` - Type definitions for dynamic models
49 | 
50 | ## 🧪 Testing Strategy
51 | - Unit tests for model loading and switching logic
52 | - Integration tests for API endpoints with different models
53 | - E2E tests for complete model selection workflows
54 | - Performance tests for model switching latency
55 | - Cost tracking validation tests
56 | 
57 | ## 📝 Notes
58 | - Consider implementing model caching for performance
59 | - Ensure backward compatibility with existing chat sessions
60 | - Plan for model-specific feature availability (e.g., vision, function calling)
61 | - Consider implementing model recommendation system based on use case
62 | - Monitor API rate limits and costs across different model providers
63 | 
64 | ## 🔗 Related Components
65 | - **AI Integration**: Features in `ai/` directory
66 | - **Model Context**: State management in `lib/context/`
67 | - **Chat Interface**: UI components in `components/`
68 | - **Database**: Schema updates in `lib/db/`
69 | - **API Routes**: Chat endpoint modifications in `app/api/` 
```

docs/auth-migration-guide.md
```
1 | # Auth Migration Guide
2 | 
3 | ## Components Still Using Direct useSession
4 | 
5 | The following components need to be migrated from direct `useSession` calls to the centralized auth hook:
6 | 
7 | ### 1. `components/chat.tsx`
8 | - Line 19: `import { useSession } from '@/lib/auth-client';`
9 | - Line 40: `const { data: session, isPending: isSessionLoading } = useSession();`
10 | 
11 | **Migration:**
12 | ```typescript
13 | // Replace:
14 | import { useSession } from '@/lib/auth-client';
15 | const { data: session, isPending: isSessionLoading } = useSession();
16 | 
17 | // With:
18 | import { useAuth } from '@/hooks/useAuth';
19 | const { session, isPending: isSessionLoading } = useAuth();
20 | ```
21 | 
22 | ### 2. `components/auth/AnonymousAuth.tsx`
23 | - Line 4: `import { signIn, useSession } from '@/lib/auth-client';`
24 | - Line 7: `const { data: session, isPending } = useSession();`
25 | 
26 | **Migration:**
27 | ```typescript
28 | // Replace:
29 | import { signIn, useSession } from '@/lib/auth-client';
30 | const { data: session, isPending } = useSession();
31 | 
32 | // With:
33 | import { useAuth } from '@/hooks/useAuth';
34 | import { signIn } from '@/lib/auth-client';
35 | const { session, isPending } = useAuth();
36 | ```
37 | 
38 | ### 3. `components/chat-sidebar.tsx`
39 | - Line 83: `const { data: session, isPending: isSessionLoading } = useSession();`
40 | 
41 | **Migration:**
42 | ```typescript
43 | // Add import:
44 | import { useAuth } from '@/hooks/useAuth';
45 | 
46 | // Replace:
47 | const { data: session, isPending: isSessionLoading } = useSession();
48 | 
49 | // With:
50 | const { session, isPending: isSessionLoading } = useAuth();
51 | ```
52 | 
53 | ### 4. `components/auth/UserAccountMenu.tsx`
54 | - Uses `useSession` (need to check exact usage)
55 | 
56 | ### 5. `lib/hooks/use-chats.ts`
57 | - Line 8: `const { data: session, isPending: isSessionLoading } = useSession();`
58 | 
59 | **Migration:**
60 | ```typescript
61 | // Replace:
62 | import { useSession } from '@/lib/auth-client';
63 | const { data: session, isPending: isSessionLoading } = useSession();
64 | 
65 | // With:
66 | import { useAuth } from '@/hooks/useAuth';
67 | const { session, isPending: isSessionLoading } = useAuth();
68 | ```
69 | 
70 | ## Migration Steps
71 | 
72 | 1. **Import Change**: Replace `useSession` import with `useAuth` import
73 | 2. **Hook Usage**: Update the destructuring pattern
74 | 3. **Test**: Verify component still works correctly
75 | 
76 | ## Validation Checklist
77 | 
78 | After migrating each component:
79 | - [ ] Component renders without errors
80 | - [ ] Auth state is correctly displayed
81 | - [ ] No duplicate auth API calls in network tab
82 | - [ ] Session changes are properly reflected
83 | 
84 | ## Common Issues
85 | 
86 | 1. **Property Access**: The centralized auth returns `session` directly, not `data: session`
87 | 2. **Loading State**: Use `isPending` instead of `isLoading`
88 | 3. **User Access**: Can access user directly from `useAuth()` as `user` property
89 | 
90 | ## Benefits After Migration
91 | 
92 | - Single auth API call instead of 6+
93 | - Shared auth state across all components
94 | - Better performance and user experience
95 | - Easier to debug auth issues
```

docs/auth-performance-fixes-implemented.md
```
1 | # Auth Performance Fixes Implemented
2 | 
3 | ## Summary
4 | Implemented critical performance optimizations to reduce excessive auth session API calls from ~16+ per page load to 1-2 calls.
5 | 
6 | ## Changes Made
7 | 
8 | ### 1. Disabled Aggressive React Query Refetching
9 | **File:** `app/providers.tsx`
10 | - Set `refetchOnWindowFocus: false`
11 | - Set `refetchOnMount: false`
12 | - Set `refetchOnReconnect: false`
13 | 
14 | **Impact:** Prevents automatic refetching of all queries (including auth) when user switches windows or components remount.
15 | 
16 | ### 2. Created Centralized Auth Context
17 | **File:** `lib/context/auth-context.tsx`
18 | - Single `useSession()` call for entire app
19 | - Centralized usage data fetching with 5-minute cache
20 | - Consolidated auth state management
21 | 
22 | **Impact:** Eliminates multiple independent `useSession()` calls across 6+ components.
23 | 
24 | ### 3. Updated useAuth Hook
25 | **File:** `hooks/useAuth.ts`
26 | - Now re-exports from centralized auth context
27 | - Maintains backward compatibility
28 | 
29 | **Impact:** All components now share single auth state instead of making independent calls.
30 | 
31 | ### 4. Added Auth Performance Monitor
32 | **File:** `lib/utils/auth-performance-monitor.ts`
33 | - Tracks all auth-related API calls
34 | - Warns when excessive calls detected
35 | - Provides detailed metrics in development
36 | 
37 | **Usage:** Automatically starts in development mode, reports every 5 seconds.
38 | 
39 | ## Expected Results
40 | 
41 | ### Before Optimization:
42 | - 6 components × useSession() = 6 auth checks
43 | - Additional usage data fetches
44 | - Refetch on every window focus
45 | - **Total: ~16+ auth API calls per interaction**
46 | 
47 | ### After Optimization:
48 | - 1 centralized useSession() call
49 | - Cached usage data (5-minute TTL)
50 | - No automatic refetching
51 | - **Total: 1-2 auth API calls per page load**
52 | 
53 | ## Testing the Changes
54 | 
55 | 1. Start the dev server: `pnpm dev`
56 | 2. Open browser DevTools Console
57 | 3. Look for "Auth Performance Monitor" logs
58 | 4. Navigate between pages and observe call counts
59 | 
60 | ### What to Look For:
61 | - Initial page load: Should see 1-2 auth calls max
62 | - Page navigation: Should see minimal or no additional auth calls
63 | - Window focus changes: Should NOT trigger auth refetches
64 | - Console warnings if excessive calls detected
65 | 
66 | ## Next Steps
67 | 
68 | ### If Performance Issues Persist:
69 | 1. Check console for specific endpoints being called repeatedly
70 | 2. Look for components not yet migrated to centralized auth
71 | 3. Verify Better Auth client-side caching is working
72 | 4. Consider implementing server-side session caching
73 | 
74 | ### Future Optimizations:
75 | 1. Implement Better Auth session caching configuration
76 | 2. Batch auth and usage endpoints into single call
77 | 3. Add server-side session cache with Redis
78 | 4. Implement progressive auth loading
79 | 
80 | ## Monitoring Commands
81 | 
82 | ```javascript
83 | // In browser console to check current metrics:
84 | window.authMonitor?.getMetrics()
85 | 
86 | // To reset metrics:
87 | window.authMonitor?.reset()
88 | 
89 | // To manually trigger report:
90 | window.authMonitor?.report()
91 | ```
92 | 
93 | ## Rollback Plan
94 | 
95 | If issues arise, revert these files:
96 | 1. `app/providers.tsx` - Remove AuthProvider, restore React Query settings
97 | 2. `hooks/useAuth.ts` - Restore original implementation
98 | 3. `lib/context/auth-context.tsx` - Delete file
99 | 4. `app/layout.tsx` - Remove performance monitor import
100 | 
101 | ## Performance Baseline
102 | 
103 | Document current performance for comparison:
104 | - Page load time: ___ ms
105 | - Time to interactive: ___ ms
106 | - Auth calls per page: ___
107 | - Auth calls per minute: ___
```

docs/auth-session-performance-analysis.md
```
1 | # Auth Session Performance Analysis
2 | 
3 | ## Overview
4 | The application is experiencing significant performance issues due to excessive auth session API calls. Investigation reveals multiple components making independent session checks, leading to hundreds of redundant auth requests.
5 | 
6 | ## Root Causes
7 | 
8 | ### 1. Multiple Independent useSession() Calls
9 | **Issue:** At least 6 components are calling `useSession()` independently:
10 | - `lib/hooks/use-chats.ts`
11 | - `hooks/useAuth.ts`
12 | - `components/chat-sidebar.tsx`
13 | - `components/chat.tsx`
14 | - `components/auth/UserAccountMenu.tsx`
15 | - `components/auth/AnonymousAuth.tsx`
16 | 
17 | **Impact:** Each component potentially triggers its own auth session check, multiplying the number of API calls.
18 | 
19 | ### 2. Aggressive Refetch Settings
20 | **Issue:** React Query is configured with `refetchOnWindowFocus: true` globally in `app/providers.tsx`:
21 | ```typescript
22 | const queryClient = new QueryClient({
23 |   defaultOptions: {
24 |     queries: {
25 |       staleTime: 1000 * 60 * 5, // 5 minutes
26 |       refetchOnWindowFocus: true, // <-- This triggers refetches on every window focus
27 |     },
28 |   },
29 | });
30 | ```
31 | 
32 | **Impact:** Every time the user switches back to the app window, ALL queries (including auth) refetch.
33 | 
34 | ### 3. Automatic Usage Data Fetching
35 | **Issue:** The `useAuth` hook automatically fetches usage data when a user is detected:
36 | ```typescript
37 | // From useAuth.ts, lines 97-101
38 | useEffect(() => {
39 |     if (user && user.credits === undefined && (status === 'authenticated' || status === 'anonymous')) {
40 |         refreshMessageUsage();
41 |     }
42 | }, [user?.id, status]);
43 | ```
44 | 
45 | **Impact:** This triggers an additional API call to `/api/usage/messages` for every component using `useAuth`.
46 | 
47 | ### 4. Anonymous Auth Auto-Attempts
48 | **Issue:** The `AnonymousAuth` component in the provider hierarchy automatically attempts to sign in anonymous users:
49 | ```typescript
50 | // From AnonymousAuth.tsx
51 | useEffect(() => {
52 |     if (!isPending && !session) {
53 |         const attemptSignIn = async () => {
54 |             // Attempts anonymous sign-in
55 |         };
56 |     }
57 | }, [isPending, session]);
58 | ```
59 | 
60 | **Impact:** This can trigger additional auth flows on every page load.
61 | 
62 | ### 5. Chat Components with Redundant Session Checks
63 | **Issue:** Both `chat.tsx` and `chat-sidebar.tsx` independently check sessions and manage their own auth state, leading to duplicate checks.
64 | 
65 | ## Performance Impact Analysis
66 | 
67 | ### Estimated API Calls per Page Load:
68 | 1. **Initial Load:**
69 |    - 6 components × useSession() = 6 auth checks
70 |    - useAuth usage fetch = 1 additional call
71 |    - Anonymous auth attempt = 1 potential call
72 |    - **Total: ~8 auth-related API calls**
73 | 
74 | 2. **On Window Focus:**
75 |    - All queries refetch due to `refetchOnWindowFocus: true`
76 |    - Potentially doubles the calls: **~16 auth-related API calls**
77 | 
78 | 3. **During Navigation:**
79 |    - Components remount and re-check auth
80 |    - Additional multiplier effect
81 | 
82 | ## Recommended Solutions
83 | 
84 | ### 1. Centralize Auth State Management
85 | Create a single auth context provider that manages all auth state:
86 | 
87 | ```typescript
88 | // lib/context/auth-context.tsx
89 | export const AuthContext = createContext<AuthContextType | null>(null);
90 | 
91 | export function AuthProvider({ children }: { children: ReactNode }) {
92 |   const { data: session, isPending } = useSession(); // Single useSession call
93 |   const [user, setUser] = useState<AuthUser | null>(null);
94 |   const [usageData, setUsageData] = useState<UsageData | null>(null);
95 |   
96 |   // Centralized usage data fetching with proper caching
97 |   const fetchUsageData = useCallback(async () => {
98 |     if (!session?.user?.id || usageData?.lastFetched > Date.now() - 300000) {
99 |       return; // Skip if no user or data is fresh (< 5 minutes old)
100 |     }
101 |     
102 |     try {
103 |       const response = await fetch('/api/usage/messages');
104 |       if (response.ok) {
105 |         const data = await response.json();
106 |         setUsageData({ ...data, lastFetched: Date.now() });
107 |       }
108 |     } catch (error) {
109 |       console.error('Failed to fetch usage data:', error);
110 |     }
111 |   }, [session?.user?.id, usageData?.lastFetched]);
112 |   
113 |   // Single effect to manage auth state
114 |   useEffect(() => {
115 |     if (session?.user) {
116 |       setUser(transformSessionToUser(session.user));
117 |       fetchUsageData();
118 |     } else {
119 |       setUser(null);
120 |       setUsageData(null);
121 |     }
122 |   }, [session, fetchUsageData]);
123 |   
124 |   return (
125 |     <AuthContext.Provider value={{ user, session, isPending, usageData, refetchUsage: fetchUsageData }}>
126 |       {children}
127 |     </AuthContext.Provider>
128 |   );
129 | }
130 | 
131 | // Custom hook to use auth context
132 | export function useAuth() {
133 |   const context = useContext(AuthContext);
134 |   if (!context) {
135 |     throw new Error('useAuth must be used within AuthProvider');
136 |   }
137 |   return context;
138 | }
139 | ```
140 | 
141 | ### 2. Optimize React Query Configuration
142 | Update the global React Query configuration to reduce aggressive refetching:
143 | 
144 | ```typescript
145 | // app/providers.tsx
146 | const queryClient = new QueryClient({
147 |   defaultOptions: {
148 |     queries: {
149 |       staleTime: 1000 * 60 * 5, // 5 minutes
150 |       refetchOnWindowFocus: false, // Disable global refetch on focus
151 |       refetchOnMount: false, // Don't refetch on mount if data exists
152 |       refetchOnReconnect: false, // Don't refetch on reconnect
153 |       retry: 1, // Reduce retry attempts
154 |     },
155 |   },
156 | });
157 | ```
158 | 
159 | ### 3. Implement Session Caching
160 | Use Better Auth's built-in session caching or implement a custom cache:
161 | 
162 | ```typescript
163 | // lib/auth-client.ts
164 | export const { signIn, signOut, useSession } = createAuthClient({
165 |   plugins: [anonymousClient()],
166 |   // Add session caching configuration
167 |   session: {
168 |     cache: {
169 |       enabled: true,
170 |       maxAge: 300, // 5 minutes
171 |     },
172 |   },
173 | });
174 | ```
175 | 
176 | ### 4. Lazy Load Anonymous Auth
177 | Move anonymous auth logic to be triggered only when needed:
178 | 
179 | ```typescript
180 | // components/auth/AnonymousAuth.tsx
181 | export function AnonymousAuth({ trigger = false }: { trigger?: boolean }) {
182 |   const { data: session, isPending } = useSession();
183 |   const attemptedRef = useRef(false);
184 |   
185 |   useEffect(() => {
186 |     // Only attempt if explicitly triggered
187 |     if (!trigger || isPending || session || attemptedRef.current) {
188 |       return;
189 |     }
190 |     
191 |     // Anonymous sign-in logic
192 |   }, [trigger, isPending, session]);
193 |   
194 |   return null;
195 | }
196 | ```
197 | 
198 | ### 5. Batch API Calls
199 | Combine related auth checks into single API endpoints:
200 | 
201 | ```typescript
202 | // app/api/auth/session-with-usage/route.ts
203 | export async function GET(req: Request) {
204 |   const session = await auth.api.getSession({ headers: req.headers });
205 |   
206 |   if (!session?.user?.id) {
207 |     return NextResponse.json({ session: null, usage: null });
208 |   }
209 |   
210 |   const [sessionData, usageData] = await Promise.all([
211 |     Promise.resolve(session),
212 |     checkMessageLimit(session.user.id, session.user.isAnonymous),
213 |   ]);
214 |   
215 |   return NextResponse.json({
216 |     session: sessionData,
217 |     usage: usageData,
218 |   });
219 | }
220 | ```
221 | 
222 | ## Implementation Priority
223 | 
224 | 1. **High Priority (Immediate Impact):**
225 |    - Disable `refetchOnWindowFocus` globally
226 |    - Centralize auth state with single `useSession()` call
227 |    - Remove redundant `useSession()` calls from components
228 | 
229 | 2. **Medium Priority (Significant Improvement):**
230 |    - Implement session caching
231 |    - Batch auth and usage API calls
232 |    - Add proper cache invalidation strategies
233 | 
234 | 3. **Low Priority (Polish):**
235 |    - Optimize anonymous auth flow
236 |    - Add performance monitoring
237 |    - Implement progressive enhancement
238 | 
239 | ## Expected Performance Improvements
240 | 
241 | By implementing these solutions:
242 | - **Reduce auth API calls by 80-90%** (from ~16 to 1-2 per page load)
243 | - **Improve initial page load time** by reducing blocking auth checks
244 | - **Better user experience** with less flickering and faster interactions
245 | - **Reduced server load** from fewer redundant API calls
246 | 
247 | ## Monitoring and Validation
248 | 
249 | Add performance monitoring to track improvements:
250 | 
251 | ```typescript
252 | // lib/utils/performance-monitor.ts
253 | export function trackAuthCalls() {
254 |   if (typeof window === 'undefined') return;
255 |   
256 |   const observer = new PerformanceObserver((list) => {
257 |     const entries = list.getEntries();
258 |     const authCalls = entries.filter(entry => 
259 |       entry.name.includes('/api/auth') || 
260 |       entry.name.includes('/api/usage')
261 |     );
262 |     
263 |     if (authCalls.length > 5) {
264 |       console.warn(`Excessive auth calls detected: ${authCalls.length} calls`);
265 |     }
266 |   });
267 |   
268 |   observer.observe({ entryTypes: ['resource'] });
269 | }
270 | ```
271 | 
272 | ## Next Steps
273 | 
274 | 1. Create a proof-of-concept branch implementing the centralized auth context
275 | 2. Measure performance improvements with the changes
276 | 3. Gradually migrate components to use the new auth context
277 | 4. Monitor production metrics to validate improvements
```

docs/chat-sharing-plan.md
```
1 | # Chat Sharing Feature Plan
2 | 
3 | This document outlines three design options for enabling chat sharing, records final scope decisions, and details the architecture, data model, APIs, UI, redaction, analytics, and rollout for the MVP.
4 | 
5 | ## Final Decisions (Approved)
6 | - Option: Option 1 — Unlisted link sharing
7 | - Snapshot: Immutable snapshot at time of sharing
8 | - Redaction: Remove API keys, emails, user PII; hide system prompts; hide tool args; exclude media/attachments entirely
9 | - Analytics: Basic anonymous view counter (no PII)
10 | - Media: Not included initially
11 | - Legal: Show confirmation dialog referencing terms; require explicit consent to publish
12 | 
13 | ## Goals
14 | - Allow users to share chats that are private by default.
15 | - Provide clear privacy controls and the ability to revoke access.
16 | - Ship a safe, minimal MVP that can evolve to access-controlled and public gallery later.
17 | 
18 | ## Options Overview
19 | 
20 | ### Option 1: Share via unlisted link (private-by-link) — MVP
21 | - Description: Generate a random `shareId` and publish a read-only snapshot accessible at an unlisted URL. Not indexed or discoverable.
22 | - Pros: Fastest, minimal privacy/legal surface, aligns with private-by-default.
23 | - Cons: Link can leak; no per-viewer access controls.
24 | - UX:
25 |   - Share button in chat view.
26 |   - Dialog: Create share link → copy URL.
27 |   - Ability to revoke link to disable access.
28 | 
29 | ### Option 2: Share to specific users (access-controlled) — Later
30 | - Description: Owner designates signed-in users allowed to view. Server enforces identity.
31 | - Pros: Stronger privacy and control (per-user revoke, auditability).
32 | - Cons: Requires identity management UX and invites; increased complexity.
33 | 
34 | ### Option 3: Public gallery post (discoverable) — Later
35 | - Description: Publish to a public listing with metadata (title, tags), author profile, reactions.
36 | - Pros: Community value, discoverability, SEO.
37 | - Cons: Highest moderation/compliance needs; reporting tools required.
38 | 
39 | ## Architecture
40 | 
41 | - Frontend: Next.js App Router
42 | - Backend: API routes under `app/api/chats`
43 | - DB: Neon Postgres via Drizzle ORM
44 | - Reuse: Patterns from Preset sharing (`app/api/presets/[id]/share/` and `app/api/presets/shared/[shareId]/`)
45 | 
46 | ### High-level Flow (Option 1)
47 | ```mermaid
48 | sequenceDiagram
49 |   participant U as User
50 |   participant UI as App UI
51 |   participant API as API chats/[id]/share
52 |   participant DB as Database
53 |   participant PUB as Shared Page
54 | 
55 |   U->>UI: Click Share
56 |   UI->>API: POST create share for chatId
57 |   API->>DB: Verify ownership, load chat
58 |   API->>API: Build sanitized snapshot
59 |   API->>DB: Insert chat_shares with shareId and snapshot
60 |   API-->>UI: 201 { shareUrl }
61 |   U->>PUB: Open /chats/shared/[shareId]
62 |   PUB->>API: GET /api/chats/shared/[shareId]
63 |   API->>DB: Load snapshot by shareId, status active
64 |   API-->>PUB: 200 snapshotJson
65 |   PUB-->>U: Render read-only chat
66 | ```
67 | 
68 | ## Data Model (Neon + Drizzle)
69 | 
70 | ### Table: chat_shares
71 | - id: uuid primary key
72 | - chatId: uuid not null references chats(id)
73 | - ownerUserId: uuid not null references users(id)
74 | - shareId: text not null unique (URL-safe slug, 24–32 chars)
75 | - status: text enum [active, revoked] default active
76 | - visibility: text enum [unlisted] default unlisted
77 | - snapshotJson: jsonb not null (sanitized message transcript and metadata)
78 | - viewCount: integer not null default 0
79 | - createdAt: timestamp with time zone default now()
80 | - revokedAt: timestamp with time zone nullable
81 | 
82 | Indexes:
83 | - unique(shareId)
84 | - index on (chatId, status)
85 | - index on (ownerUserId, status)
86 | 
87 | Optional later:
88 | - chat_share_views for per-view analytics; not needed initially.
89 | 
90 | ### Snapshot Structure (example)
91 | ```json
92 | {
93 |   "version": 1,
94 |   "chat": {
95 |     "title": "How to deploy Next.js",
96 |     "createdAt": "2025-07-01T12:00:00Z"
97 |   },
98 |   "messages": [
99 |     {
100 |       "id": "m1",
101 |       "role": "user",
102 |       "content": "How do I deploy a Next.js app?",
103 |       "createdAt": "2025-07-01T12:01:00Z"
104 |     },
105 |     {
106 |       "id": "m2",
107 |       "role": "assistant",
108 |       "content": "Use Vercel or Node server... ",
109 |       "createdAt": "2025-07-01T12:02:00Z"
110 |     }
111 |   ],
112 |   "metadata": {
113 |     "models": ["openai:gpt-4o-mini"],
114 |     "redaction": {
115 |       "hideSystemPrompts": true,
116 |       "hideToolArgs": true,
117 |       "excludeMedia": true,
118 |       "piiRemoved": true
119 |     }
120 |   }
121 | }
122 | ```
123 | 
124 | ## Redaction Policy (MVP)
125 | - Remove system/hidden prompts.
126 | - Remove tool call arguments and internal metadata.
127 | - Exclude all media/attachments and any non-public or signed URLs.
128 | - Remove API keys, emails, phone numbers, and basic PII from message content via conservative regex filtering.
129 | - Do not expose owner email or internal IDs in snapshot.
130 | - Optionally list high-level model names; omit provider config.
131 | 
132 | Notes:
133 | - Keep redaction conservative to avoid leaks.
134 | - Add a redaction banner in snapshot metadata for transparency.
135 | 
136 | ## API Surface
137 | 
138 | - POST /api/chats/[id]/share
139 |   - Auth required. Validate ownership of chat.
140 |   - Build sanitized immutable snapshot from the chat.
141 |   - If an active share already exists for this chat, either return it or create new based on UX (MVP: return existing to keep single active share).
142 |   - Insert or upsert into `chat_shares`.
143 |   - Response: 201 { shareUrl, shareId }
144 | 
145 | - DELETE /api/chats/[id]/share
146 |   - Auth required. Validate ownership.
147 |   - Set status = revoked and revokedAt = now for the active share for that chat (or all for chat, MVP: all).
148 |   - Response: 200 { revoked: true }
149 | 
150 | - GET /api/chats/shared/[shareId]
151 |   - Public endpoint.
152 |   - Return 404 if not found or status != active.
153 |   - Increment `viewCount` in a rate-limited fashion (best-effort).
154 |   - Response: 200 snapshotJson
155 | 
156 | Rate-limiting view counts:
157 | - Simple approach: update `viewCount = viewCount + 1` with lightweight guard to avoid hot loops (e.g., throttle by IP hash in memory for 60s if running serverfully, or accept overcounting as MVP).
158 | 
159 | ## UI and UX
160 | 
161 | - Share Button and Dialog
162 |   - Location: Chat header and/or chat overflow menu.
163 |   - States:
164 |     - Not shared: “Create share link”
165 |     - Shared: Show link with copy button; “Disable link” (revoke)
166 |   - Consent:
167 |     - A checkbox: “I understand this creates an unlisted public link and agree to the Terms.”
168 |     - Link to Terms.
169 | 
170 | - Shared Page
171 |   - Route: /chats/shared/[shareId]
172 |   - Rendering: Use existing read-only components (`Messages`, `Message`, `Markdown`), disable interactions and tool triggers.
173 |   - Empty/Invalid: Display friendly 404.
174 | 
175 | ## Observability/Analytics
176 | - Log share creations and revocations with chatId and ownerUserId.
177 | - `viewCount` integer on `chat_shares` incremented on GET.
178 | - No PII stored for viewers.
179 | 
180 | ## Security Considerations
181 | - Immutable snapshot decouples shared content from live chat.
182 | - Revoke immediately disables GET access.
183 | - High-entropy `shareId` (URL-safe).
184 | - Rate-limit GET or accept minimal overcounting.
185 | - Ensure response headers don’t leak internal IDs.
186 | - CORS defaults (same-origin GET) unless page needs client-side fetch; prefer server-side rendering.
187 | 
188 | ## Rollout Plan
189 | 1. Implement Option 1 with snapshot and revoke.
190 | 2. Add unit/integration tests:
191 |    - API create/revoke.
192 |    - GET returns snapshot and 404 after revoke.
193 |    - Redaction correctness (system prompts, tools, PII removal, media exclusion).
194 |    - View counter increments.
195 | 3. Ship behind a soft feature flag if needed.
196 | 4. Monitor logs and feedback.
197 | 
198 | ## Risks and Mitigations
199 | - Link leakage: Mitigate with revoke, clear UX, and optional expiration in future.
200 | - PII exposure: Conservative redaction and no media; add regex filters and tests.
201 | - Overcounting views: Acceptable MVP trade-off; harden later.
202 | 
203 | ## Future Extensions
204 | - Multiple concurrent share links per chat with labels and expirations.
205 | - Per-viewer ACLs; audit logs; invite flows.
206 | - Public gallery with moderation and reporting.
207 | - Enhanced analytics (unique viewers, geos, retention).
208 | - Optional media-including shares with signed-URL proxying.
209 | 
210 | ## Implementation Notes (File Map)
211 | - Drizzle migration: `drizzle/00xx_chat_shares.sql` and meta snapshots
212 | - API:
213 |   - `app/api/chats/[id]/share/route.ts` (POST, DELETE)
214 |   - `app/api/chats/shared/[shareId]/route.ts` (GET)
215 | - Pages:
216 |   - `app/chats/shared/[shareId]/page.tsx`
217 | - Components:
218 |   - Share dialog/button in chat UI (likely `components/chat.tsx` or header)
219 | - Services/Lib:
220 |   - Snapshot builder and redaction utilities under `lib/services` or `lib`
221 |   - DB access under `lib/db`
222 | 
223 | ## Test Plan (MVP)
224 | - API:
225 |   - POST create share: 201 with shareId; snapshot has redaction flags set and media excluded.
226 |   - DELETE revoke: 200; GET 404 afterward.
227 |   - GET shared: 200 returns snapshot; increments `viewCount`.
228 | - Redaction:
229 |   - System prompts and tool args are absent.
230 |   - PII regex removes emails, keys, phone numbers in user/assistant content.
231 |   - No attachments or media URLs included.
232 | - UI:
233 |   - Share dialog requires consent checkbox before enabling “Create link”.
234 |   - Copied link matches GET endpoint.
235 |   - Shared page renders transcript read-only and shows redaction banner if desired.
```

docs/compilation-speed-optimization.md
```
1 | # Compilation Speed Optimization Guide
2 | 
3 | ## Current Issues Identified
4 | 
5 | 1. **Large node_modules (948MB)** - Heavy dependencies impacting build times
6 | 2. **Excessive API calls** - Hundreds of auth session calls causing performance issues
7 | 3. **Long initial compilation** - Home page taking 17.6s to compile
8 | 
9 | ## Changes Applied
10 | 
11 | ✅ **TypeScript Configuration**
12 | - Added `tsBuildInfoFile` to store incremental build info in `.next/cache`
13 | - Enabled `incremental: true` for faster subsequent builds
14 | 
15 | ✅ **Next.js Configuration**
16 | - Removed problematic `optimizePackageImports` (not supported in current version)
17 | - Kept core optimizations: `reactStrictMode`, build flags
18 | 
19 | ✅ **Build Tools**
20 | - Created cache clearing script (`scripts/clear-cache.sh`)
21 | - Added `pnpm cache:clear` and `pnpm dev:fresh` commands
22 | - Created `.npmrc` with pnpm optimizations
23 | 
24 | ## Remaining Issues & Solutions
25 | 
26 | ### 1. Optimize Dependencies
27 | 
28 | #### Split Heavy Dependencies
29 | Consider lazy loading heavy packages that aren't needed on initial load:
30 | 
31 | ```typescript
32 | // Instead of importing at the top
33 | import katex from 'katex';
34 | 
35 | // Use dynamic imports
36 | const katex = await import('katex');
37 | ```
38 | 
39 | #### Review and Remove Unused Dependencies
40 | Run dependency analysis:
41 | ```bash
42 | npx depcheck
43 | ```
44 | 
45 | ### 2. Next.js Configuration Optimizations
46 | 
47 | Update your `next.config.ts`:
48 | 
49 | ```typescript
50 | import type { NextConfig } from "next";
51 | 
52 | const nextConfig: NextConfig = {
53 |   images: {
54 |     remotePatterns: [
55 |       {
56 |         protocol: 'https',
57 |         hostname: 'lh3.googleusercontent.com',
58 |       },
59 |     ],
60 |   },
61 |   
62 |   // Optimize for development
63 |   reactStrictMode: true,
64 |   
65 |   // Experimental features for faster builds
66 |   experimental: {
67 |     // Use the new optimized package imports
68 |     optimizePackageImports: [
69 |       '@radix-ui/react-accordion',
70 |       '@radix-ui/react-avatar',
71 |       '@radix-ui/react-dialog',
72 |       '@radix-ui/react-dropdown-menu',
73 |       '@radix-ui/react-label',
74 |       '@radix-ui/react-popover',
75 |       '@radix-ui/react-scroll-area',
76 |       '@radix-ui/react-select',
77 |       '@radix-ui/react-separator',
78 |       '@radix-ui/react-slot',
79 |       '@radix-ui/react-switch',
80 |       '@radix-ui/react-tabs',
81 |       '@radix-ui/react-tooltip',
82 |       'lucide-react',
83 |       'framer-motion',
84 |       'ai',
85 |     ],
86 |   },
87 |   
88 |   // Reduce source map size in development
89 |   productionBrowserSourceMaps: false,
90 |   
91 |   // TypeScript and ESLint optimizations
92 |   typescript: {
93 |     // During development, skip type checking
94 |     ignoreBuildErrors: false,
95 |   },
96 |   eslint: {
97 |     // During development builds
98 |     ignoreDuringBuilds: false,
99 |   },
100 | };
101 | 
102 | export default nextConfig;
103 | ```
104 | 
105 | ### 3. TypeScript Optimizations
106 | 
107 | Already applied:
108 | - ✅ Added `tsBuildInfoFile` to tsconfig.json
109 | - ✅ `skipLibCheck: true` is already enabled
110 | - ✅ `incremental: true` is already enabled
111 | 
112 | ### 4. Development Environment Optimizations
113 | 
114 | #### Use SWC instead of Babel
115 | Turbopack already uses SWC, but ensure you're not overriding it with custom Babel configs.
116 | 
117 | #### Clear Cache Periodically
118 | ```bash
119 | rm -rf .next
120 | rm -rf node_modules/.cache
121 | rm tsconfig.tsbuildinfo
122 | ```
123 | 
124 | #### Use pnpm's Optimizations
125 | Add to `.npmrc`:
126 | ```
127 | node-linker=hoisted
128 | shamefully-hoist=true
129 | ```
130 | 
131 | ### 5. Code Splitting Strategies
132 | 
133 | #### Dynamic Imports for Large Components
134 | ```typescript
135 | // For heavy components
136 | const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
137 |   loading: () => <p>Loading...</p>,
138 |   ssr: false, // If not needed on server
139 | });
140 | ```
141 | 
142 | #### Route-based Code Splitting
143 | Next.js does this automatically, but ensure you're not importing everything in layout.tsx
144 | 
145 | ### 6. Environment-Specific Optimizations
146 | 
147 | Create a development-specific config:
148 | ```bash
149 | # .env.development
150 | NEXT_TELEMETRY_DISABLED=1
151 | ANALYZE=false
152 | ```
153 | 
154 | ### 7. Hardware Considerations
155 | 
156 | - **RAM**: Ensure you have at least 8GB available
157 | - **SSD**: Use SSD instead of HDD
158 | - **CPU**: Close other heavy applications
159 | 
160 | ### 8. Monitoring Build Performance
161 | 
162 | Add build analysis script to package.json:
163 | ```json
164 | "analyze": "ANALYZE=true next build"
165 | ```
166 | 
167 | ## Quick Wins
168 | 
169 | 1. **Immediate**: Clear your cache
170 |    ```bash
171 |    rm -rf .next node_modules/.cache tsconfig.tsbuildinfo
172 |    ```
173 | 
174 | 2. **Short-term**: Update next.config.ts with optimizations above
175 | 
176 | 3. **Medium-term**: Review and reduce dependencies
177 | 
178 | 4. **Long-term**: Implement code splitting for heavy features
179 | 
180 | ## Expected Improvements
181 | 
182 | - Initial load: 30-50% faster
183 | - Hot reload: 20-40% faster
184 | - Memory usage: 20-30% reduction
185 | 
186 | ## Verification
187 | 
188 | After implementing changes, measure improvement:
189 | ```bash
190 | time pnpm dev
191 | ```
192 | 
193 | Compare before and after compilation times.
```

docs/dynamic-model-loading-plan.md
```
1 | # Dynamic AI Model Loading – Implementation Plan
2 | 
3 | ## 1. Objectives
4 | 
5 | 1. Replace the current static, hard-coded model catalogue in `ai/providers.ts` with a **dynamic, provider–driven catalogue**.
6 | 2. Support **all configured providers** (initially *OpenRouter* & *Requesty*, but architected for easy extension).
7 | 3. Preserve the existing consumer API (`modelDetails`, `MODELS`, `defaultModel`, etc.) *where possible* to minimise refactors, while gradually migrating to an async-ready API.
8 | 4. Provide robust **caching & refresh controls** so model metadata is fetched sparingly and can be manually refreshed from the UI.
9 | 5. Maintain graceful fallbacks when a provider is down or returns incomplete data.
10 | 6. **NEW**: Support both environment variables AND user-provided API keys seamlessly.
11 | 7. **NEW**: Implement comprehensive error handling and provider health monitoring.
12 | 8. **NEW**: Ensure smooth migration path for existing model configurations.
13 | 
14 | ---
15 | 
16 | ## 2. High-level Architecture
17 | 
18 | 1. **Hybrid Server-side aggregator**
19 |    * New utility (e.g. `lib/fetch-models.ts`) fetches, normalises and caches model lists from each provider.
20 |    * **Dual API key support**: Uses environment variables for server-side fetching AND supports user-provided keys.
21 |    * Runs **only on the server** (edge/runtime) to keep environment API keys secret.
22 |    * Exposes data through a lightweight **Next API route** (`/api/models`) with `revalidate` headers.
23 |    * **NEW**: Provider health monitoring and status tracking.
24 | 2. **Enhanced type layer**
25 |    * Introduce `ModelInfo`, `ProviderInfo`, `RawProviderModel`, `ModelsResponse` etc. in `types/models.ts`.
26 |    * **NEW**: Status tracking, error states, and provider health indicators.
27 |    * Normaliser converts `RawProviderModel → ModelInfo` so the UI can stay provider-agnostic.
28 | 3. **Robust client-side hook**
29 |    * `hooks/use-models.ts` wraps `swr`/`react-query`/native `fetch` to consume `/api/models`.
30 |    * Returns `{ models, isLoading, refresh, metadata, error }`.
31 |    * **NEW**: Handles both server-sourced and user-sourced models.
32 | 4. **Enhanced context**
33 |    * Extend `ModelContext` to load models asynchronously and handle migration scenarios.
34 |    * **NEW**: Graceful fallback when stored model IDs become invalid.
35 | 5. **Enhanced UI components**
36 |    * `components/model-picker.tsx` switches from the static `MODELS` array to the new hook/context.
37 |    * **NEW**: Provider status indicators, health warnings, and model availability badges.
38 |    * Add "Refresh models" button & provider filter dropdown.
39 | 
40 | ---
41 | 
42 | ## 3. Enhanced Provider Integration
43 | 
44 | ### 3.1 Provider Configuration System
45 | ```ts
46 | interface ProviderConfig {
47 |   name: string;
48 |   envKey: string;
49 |   endpoint: string;
50 |   parse: (data: any) => ModelInfo[];
51 |   healthCheck?: string;           // Endpoint for provider health
52 |   rateLimit?: {                  // Rate limiting config
53 |     requestsPerMinute: number;
54 |     burstLimit: number;
55 |   };
56 |   retryConfig?: {                // Retry strategy
57 |     maxRetries: number;
58 |     backoffMs: number;
59 |   };
60 | }
61 | 
62 | export const PROVIDERS = {
63 |   openrouter: {
64 |     name: 'OpenRouter',
65 |     envKey: 'OPENROUTER_API_KEY',
66 |     endpoint: 'https://openrouter.ai/api/v1/models',
67 |     healthCheck: 'https://openrouter.ai/api/v1/auth/key',
68 |     parse: parseOpenRouterModels,
69 |     rateLimit: { requestsPerMinute: 60, burstLimit: 10 },
70 |     retryConfig: { maxRetries: 3, backoffMs: 1000 },
71 |   },
72 |   requesty: {
73 |     name: 'Requesty',
74 |     envKey: 'REQUESTY_API_KEY',
75 |     endpoint: 'https://api.requesty.ai/v1/models',
76 |     healthCheck: 'https://api.requesty.ai/v1/status',
77 |     parse: parseRequestyModels,
78 |     rateLimit: { requestsPerMinute: 120, burstLimit: 20 },
79 |     retryConfig: { maxRetries: 3, backoffMs: 500 },
80 |   },
81 |   // add more …
82 | } satisfies Record<string, ProviderConfig>;
83 | ```
84 | 
85 | ### 3.2 OpenRouter
86 | * **Endpoint**: `GET https://openrouter.ai/api/v1/models`.
87 | * **Auth**: `Authorization: Bearer <OPENROUTER_API_KEY>`.
88 | * **Health Check**: `GET https://openrouter.ai/api/v1/auth/key`.
89 | * **Important fields** (subject to API docs):
90 |   * `id`, `name`, `context_length`, `description`, `pricing`, `capabilities`, `vision` flag, etc.
91 | * **Normalisation notes**:
92 |   * Derive `provider = "OpenRouter"`.
93 |   * `premium = pricing?.prompt > 0` or API flag.
94 |   * Map OpenRouter's `tags` to our `capabilities`.
95 | 
96 | ### 3.3 Requesty
97 | * **Endpoint**: `GET https://api.requesty.ai/v1/models` (placeholder – verify docs).
98 | * **Auth**: `Authorization: Bearer <REQUESTY_API_KEY>`.
99 | * **Health Check**: `GET https://api.requesty.ai/v1/status`.
100 | * **Normalisation**: similar to OpenRouter.
101 | 
102 | ### 3.4 Future Providers
103 | * Define provider configs in `config/providers.ts` using the enhanced `ProviderConfig` interface above.
104 | 
105 | ---
106 | 
107 | ## 4. Enhanced Caching Strategy
108 | 
109 | | Layer | Technique | TTL | Notes |
110 | |-------|-----------|-----|-------|
111 | | **Server fetch util** | In-memory `Map` keyed by provider + API key hash | 10 min (configurable) | Simple, fast, auto-expires |
112 | | **Next API Route** | `revalidate` header via `NextResponse` | 60 s default | Allows CDN/edge caching |
113 | | **Client** | SWR/React-Query cache | 60 s + stale-while-revalidate | Provides instant repeat loads |
114 | | **LocalStorage** (optional) | Persist last good payload | 24 h | Guard against offline/start-up |
115 | 
116 | ### 4.1 Enhanced Cache Configuration
117 | ```ts
118 | interface CacheConfig {
119 |   modelListTTL: number;      // 10 minutes
120 |   modelDetailsTTL: number;   // 1 hour  
121 |   providerHealthTTL: number; // 30 seconds
122 |   forceRefreshKey: string;   // Admin override
123 | }
124 | ```
125 | 
126 | Admin-initiated refresh calls the API route with `?force=true`, skipping caches.
127 | 
128 | ---
129 | 
130 | ## 5. Enhanced Data Contract
131 | 
132 | ### 5.1 Core Model Information
133 | ```ts
134 | interface ModelInfo {
135 |   id: string;            // unique (provider/model-id)
136 |   provider: string;      // "OpenRouter" | "Requesty" | …
137 |   name: string;          // human label
138 |   description?: string;
139 |   capabilities: string[];// normalised tags (code, reasoning…)
140 |   premium: boolean;
141 |   vision: boolean;
142 |   contextMax?: number;
143 |   apiVersion?: string;   // if available
144 |   
145 |   // NEW: Status and health tracking
146 |   status: 'available' | 'limited' | 'deprecated' | 'unavailable';
147 |   lastChecked: Date;
148 |   errorMessage?: string;
149 |   providerHealth?: 'healthy' | 'degraded' | 'down';
150 |   
151 |   // NEW: Enhanced metadata
152 |   pricing?: {
153 |     input?: number;      // per token
154 |     output?: number;     // per token
155 |     currency?: string;
156 |   };
157 |   rateLimit?: {
158 |     requestsPerMinute?: number;
159 |     tokensPerMinute?: number;
160 |   };
161 | }
162 | ```
163 | 
164 | ### 5.2 API Response Structure
165 | ```ts
166 | interface ModelsResponse {
167 |   models: ModelInfo[];
168 |   metadata: {
169 |     lastUpdated: Date;
170 |     providers: {
171 |       [key: string]: {
172 |         status: 'healthy' | 'degraded' | 'error';
173 |         lastChecked: Date;
174 |         modelCount: number;
175 |         error?: string;
176 |       };
177 |     };
178 |     totalModels: number;
179 |     cacheHit: boolean;
180 |     userProvidedKeys?: string[]; // Which providers used user keys
181 |   };
182 | }
183 | ```
184 | 
185 | ---
186 | 
187 | ## 6. Hybrid API Key Management
188 | 
189 | ### 6.1 Current Implementation Analysis
190 | The existing codebase supports both environment variables AND localStorage API keys:
191 | 
192 | ```ts
193 | // Current: ai/providers.ts
194 | export const getApiKey = (key: string): string | undefined => {
195 |   // Check for environment variables first
196 |   if (process.env[key]) {
197 |     return process.env[key] || undefined;
198 |   }
199 |   // Fall back to localStorage if available
200 |   if (typeof window !== 'undefined') {
201 |     return window.localStorage.getItem(key) || undefined;
202 |   }
203 |   return undefined;
204 | };
205 | ```
206 | 
207 | ### 6.2 Enhanced Strategy
208 | 1. **Server-side route** fetches models using environment API keys
209 | 2. **Client-side hook** can also fetch models when user provides their own API keys
210 | 3. **Merge and deduplicate** models from both sources
211 | 4. **Clear separation** between environment and user-provided credentials
212 | 
213 | ### 6.3 Implementation Approach
214 | ```ts
215 | // Enhanced API route: /api/models
216 | export async function GET(request: NextRequest) {
217 |   const userApiKeys = extractUserApiKeys(request); // From headers/body
218 |   
219 |   // Fetch using environment keys
220 |   const envModels = await fetchModelsWithEnvKeys();
221 |   
222 |   // Fetch using user-provided keys (if any)
223 |   const userModels = await fetchModelsWithUserKeys(userApiKeys);
224 |   
225 |   // Merge and deduplicate
226 |   const allModels = mergeAndDeduplicateModels(envModels, userModels);
227 |   
228 |   return NextResponse.json({
229 |     models: allModels,
230 |     metadata: {
231 |       // ... enhanced metadata
232 |       userProvidedKeys: Object.keys(userApiKeys),
233 |     }
234 |   });
235 | }
236 | ```
237 | 
238 | ---
239 | 
240 | ## 7. Migration Compatibility & Error Handling
241 | 
242 | ### 7.1 Model ID Migration
243 | ```ts
244 | interface ModelMigration {
245 |   oldId: string;
246 |   newId: string;
247 |   reason: 'renamed' | 'moved' | 'deprecated';
248 |   automaticMigration: boolean;
249 | }
250 | 
251 | // Example migrations
252 | const MODEL_MIGRATIONS: ModelMigration[] = [
253 |   {
254 |     oldId: 'openrouter/anthropic/claude-3.5-sonnet-old',
255 |     newId: 'openrouter/anthropic/claude-3.5-sonnet',
256 |     reason: 'renamed',
257 |     automaticMigration: true,
258 |   },
259 | ];
260 | ```
261 | 
262 | ### 7.2 Graceful Degradation
263 | ```ts
264 | // Enhanced ModelContext with migration support
265 | export function ModelProvider({ children }: { children: ReactNode }) {
266 |   const [selectedModel, setSelectedModelState] = useState<modelID>(defaultModel);
267 |   const { models, isLoading } = useModels();
268 | 
269 |   useEffect(() => {
270 |     if (!isLoading && models.length > 0) {
271 |       const storedModel = localStorage.getItem('selected_ai_model');
272 |       if (storedModel) {
273 |         // Check if stored model exists
274 |         const modelExists = models.find(m => m.id === storedModel);
275 |         if (modelExists) {
276 |           setSelectedModelState(storedModel as modelID);
277 |         } else {
278 |           // Try migration
279 |           const migration = findMigration(storedModel);
280 |           if (migration?.automaticMigration) {
281 |             setSelectedModelState(migration.newId as modelID);
282 |             notifyUserOfMigration(migration);
283 |           } else {
284 |             // Fallback to default
285 |             setSelectedModelState(defaultModel);
286 |             notifyUserOfInvalidModel(storedModel);
287 |           }
288 |         }
289 |       }
290 |     }
291 |   }, [models, isLoading]);
292 | 
293 |   // ... rest of implementation
294 | }
295 | ```
296 | 
297 | ### 7.3 Error Boundaries & Fallbacks
298 | ```ts
299 | // Model picker with error handling
300 | export const ModelPicker = ({ ... }) => {
301 |   const { models, isLoading, error, refresh } = useModels();
302 |   
303 |   if (error) {
304 |     return (
305 |       <div className="flex items-center gap-2">
306 |         <Button variant="outline" onClick={() => refresh()}>
307 |           <RefreshCw className="h-4 w-4 mr-2" />
308 |           Retry
309 |         </Button>
310 |         <span className="text-sm text-muted-foreground">
311 |           Failed to load models
312 |         </span>
313 |       </div>
314 |     );
315 |   }
316 |   
317 |   // ... rest of implementation
318 | };
319 | ```
320 | 
321 | ---
322 | 
323 | ## 8. Enhanced UI Components
324 | 
325 | ### 8.1 Model Picker Enhancements
326 | * **Provider status indicators** – colored dots showing health
327 | * **Model availability badges** – "new", "deprecated", "limited"
328 | * **Refresh button** – manual cache invalidation
329 | * **Provider filter dropdown** – quickly toggle between providers
330 | * **Health warnings** – when provider is degraded
331 | * **Pricing indicators** – show relative cost levels
332 | 
333 | ### 8.2 Provider Health Dashboard
334 | ```tsx
335 | // New component: components/provider-health.tsx
336 | export const ProviderHealthDashboard = () => {
337 |   const { metadata } = useModels();
338 |   
339 |   return (
340 |     <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
341 |       {Object.entries(metadata.providers).map(([name, status]) => (
342 |         <div key={name} className="p-3 border rounded-lg">
343 |           <div className="flex items-center gap-2">
344 |             <HealthIndicator status={status.status} />
345 |             <span className="font-medium">{name}</span>
346 |           </div>
347 |           <div className="text-sm text-muted-foreground">
348 |             {status.modelCount} models • Last checked: {formatTime(status.lastChecked)}
349 |           </div>
350 |           {status.error && (
351 |             <div className="text-xs text-red-600 mt-1">{status.error}</div>
352 |           )}
353 |         </div>
354 |       ))}
355 |     </div>
356 |   );
357 | };
358 | ```
359 | 
360 | ---
361 | 
362 | ## 9. Revised Implementation Plan
363 | 
364 | ### Phase 1: Core Infrastructure (2 days)
365 | | Task | Time | Priority |
366 | |------|------|----------|
367 | | Enhanced provider config & parsers | 0.5 d | Critical |
368 | | Server-side aggregator with advanced caching | 0.75 d | Critical |
369 | | `/api/models` route with error handling | 0.5 d | Critical |
370 | | Basic health monitoring | 0.25 d | High |
371 | 
372 | ### Phase 2: Client Integration (1.5 days)
373 | | Task | Time | Priority |
374 | |------|------|----------|
375 | | `useModels()` hook with SWR + error handling | 0.5 d | Critical |
376 | | Enhanced ModelPicker adaptation | 0.75 d | Critical |
377 | | ModelContext async initialization + migration | 0.25 d | High |
378 | 
379 | ### Phase 3: Production Readiness (1.5 days)
380 | | Task | Time | Priority |
381 | |------|------|----------|
382 | | Hybrid API key support | 0.5 d | Critical |
383 | | Provider health monitoring dashboard | 0.5 d | High |
384 | | Model migration utilities | 0.25 d | High |
385 | | Enhanced UI features (status indicators, etc.) | 0.25 d | Medium |
386 | 
387 | ### Phase 4: Testing & Polish (1 day)
388 | | Task | Time | Priority |
389 | |------|------|----------|
390 | | Unit and integration tests | 0.5 d | Critical |
391 | | Provider API mocking for tests | 0.25 d | High |
392 | | Documentation updates | 0.25 d | Medium |
393 | 
394 | **Total Estimated Time**: **6 days** (vs. original 3 days)
395 | 
396 | ---
397 | 
398 | ## 10. Security Considerations
399 | 
400 | * **API key isolation**: Environment keys never exposed to client
401 | * **User key validation**: Sanitize and validate user-provided keys
402 | * **Rate limiting**: Implement per-provider rate limiting to prevent abuse
403 | * **Error sanitization**: Never expose internal errors or API keys in responses
404 | * **Audit logging**: Track API key usage and model access patterns
405 | * **CORS protection**: Ensure API routes are properly protected
406 | 
407 | ---
408 | 
409 | ## 11. Real-time Updates & Future Enhancements
410 | 
411 | ### 11.1 Real-time Capabilities (Future)
412 | Consider adding for production environments:
413 | * **WebSocket/SSE** for real-time model availability updates
414 | * **Provider status notifications** when services go down/up
415 | * **New model announcements** pushed to active users
416 | * **Pricing change alerts** for cost-sensitive users
417 | 
418 | ### 11.2 Advanced Features (Future Roadmap)
419 | 1. **Model Analytics**: Track usage patterns, popular models, performance metrics
420 | 2. **Cost Optimization**: Suggest cheaper alternatives for similar capabilities  
421 | 3. **A/B Testing**: Easy model switching for performance comparisons
422 | 4. **Custom Model Support**: Allow users to add their own API endpoints
423 | 5. **Model Recommendations**: AI-powered suggestions based on conversation context
424 | 6. **Model Performance Tracking**: Response time, quality metrics, user ratings
425 | 7. **Auto-failover**: Automatically switch to backup models when primary fails
426 | 8. **Model Presets**: Pre-configured model groups for specific use cases
427 | 
428 | ---
429 | 
430 | ## 12. Testing Strategy
431 | 
432 | ### 12.1 Unit Tests
433 | * Provider parsers and normalizers
434 | * Caching logic and TTL handling
435 | * Model migration utilities
436 | * Error handling scenarios
437 | 
438 | ### 12.2 Integration Tests
439 | * API route functionality with mocked provider responses
440 | * Client-server data flow
441 | * Cache invalidation and refresh mechanisms
442 | * Error propagation and fallback behavior
443 | 
444 | ### 12.3 E2E Tests
445 | * Complete model selection flow
446 | * Provider failure scenarios
447 | * Model migration scenarios
448 | * Performance under load
449 | 
450 | ### 12.4 Mock Strategy
451 | ```ts
452 | // Enhanced mock setup for testing
453 | const mockProviderResponses = {
454 |   openrouter: {
455 |     healthy: mockOpenRouterModels,
456 |     degraded: mockPartialResponse,
457 |     error: mockErrorResponse,
458 |   },
459 |   requesty: {
460 |     healthy: mockRequestyModels,
461 |     degraded: mockPartialResponse,
462 |     error: mockErrorResponse,
463 |   },
464 | };
465 | ```
466 | 
467 | ---
468 | 
469 | ## 13. Performance Monitoring
470 | 
471 | ### 13.1 Metrics to Track
472 | * Model fetching latency per provider
473 | * Cache hit/miss ratios
474 | * Provider health check response times
475 | * Client-side model picker performance
476 | * Error rates and types
477 | 
478 | ### 13.2 Alerting
479 | * Provider downtime notifications
480 | * High error rates
481 | * Cache performance degradation
482 | * Unusual model usage patterns
483 | 
484 | ---
485 | 
486 | **Next Steps**: Begin implementation with Phase 1, focusing on the enhanced provider configuration system and robust server-side aggregator. The hybrid API key support should be implemented from the start to avoid architectural refactoring later. 
```

docs/favorite-models-implementation-plan.md
```
1 | # Favorite Models Implementation Plan
2 | 
3 | ## Overview
4 | 
5 | This plan outlines the implementation of a favorite models feature that allows users to mark and quickly access their preferred AI models. The feature will include a simple star-based UI similar to the images provided, with a "Favorites" tab in the model picker.
6 | 
7 | ## Current State Analysis
8 | 
9 | ### Existing Architecture
10 | - **Database**: PostgreSQL with Drizzle ORM
11 | - **Models**: Dynamic model loading from multiple providers (OpenRouter, Requesty, etc.)
12 | - **UI**: Model picker component with search and filtering
13 | - **Authentication**: Better Auth with user sessions
14 | - **State Management**: React Context for model management
15 | 
16 | ### Key Components Identified
17 | - `lib/db/schema.ts` - Database schema definitions
18 | - `lib/types/models.ts` - Model type definitions
19 | - `components/model-picker.tsx` - Model selection UI
20 | - `app/api/models/route.ts` - Model fetching API
21 | - `lib/context/model-context.tsx` - Model state management
22 | 
23 | ## Implementation Plan
24 | 
25 | ### Phase 1: Database Schema
26 | 
27 | #### 1.1 Create Favorites Table
28 | ```sql
29 | -- New migration file: drizzle/0021_add_favorite_models.sql
30 | CREATE TABLE favorite_models (
31 |   id TEXT PRIMARY KEY DEFAULT nanoid(),
32 |   user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
33 |   model_id TEXT NOT NULL,
34 |   created_at TIMESTAMP DEFAULT NOW() NOT NULL,
35 |   UNIQUE(user_id, model_id)
36 | );
37 | ```
38 | 
39 | #### 1.2 Update Schema Types
40 | - Add `FavoriteModel` type to `lib/db/schema.ts`
41 | - Add `favoriteModels` table definition
42 | - Include proper foreign key constraints and indexes
43 | 
44 | ### Phase 2: API Endpoints
45 | 
46 | #### 2.1 Create Favorites API Routes
47 | 
48 | **GET /api/favorites/models**
49 | - Fetch user's favorite models
50 | - Return list of favorite model IDs
51 | - Include model details if requested
52 | 
53 | **POST /api/favorites/models**
54 | - Add model to favorites
55 | - Validate model exists
56 | - Prevent duplicates
57 | 
58 | **DELETE /api/favorites/models/{modelId}**
59 | - Remove model from favorites
60 | - Handle non-existent favorites gracefully
61 | 
62 | #### 2.2 Update Models API
63 | - Enhance `/api/models` to include favorite status
64 | - Add `isFavorite` field to model responses
65 | - Optimize queries to include favorite information
66 | 
67 | ### Phase 3: Backend Services
68 | 
69 | #### 3.1 Create Favorites Service
70 | ```typescript
71 | // lib/services/favorites.ts
72 | export class FavoritesService {
73 |   async getUserFavorites(userId: string): Promise<string[]>
74 |   async addFavorite(userId: string, modelId: string): Promise<void>
75 |   async removeFavorite(userId: string, modelId: string): Promise<void>
76 |   async isFavorite(userId: string, modelId: string): Promise<boolean>
77 | }
78 | ```
79 | 
80 | #### 3.2 Update Model Context
81 | - Add favorites state management
82 | - Include favorite status in model data
83 | - Provide methods to toggle favorites
84 | 
85 | ### Phase 4: UI Components
86 | 
87 | #### 4.1 Update Model Picker Component
88 | - Add "Favorites" tab alongside "All" tab
89 | - Implement star icon for favoriting/unfavoriting
90 | - Add visual indicators for favorite status
91 | - Handle favorite toggling with optimistic updates
92 | 
93 | #### 4.2 Create Favorite Toggle Component
94 | ```typescript
95 | // components/favorite-toggle.tsx
96 | interface FavoriteToggleProps {
97 |   modelId: string;
98 |   isFavorite: boolean;
99 |   onToggle: (modelId: string, isFavorite: boolean) => void;
100 |   disabled?: boolean;
101 | }
102 | ```
103 | 
104 | #### 4.3 Update Model List Item
105 | - Add star icon to each model entry
106 | - Implement hover states for star interaction
107 | - Show filled/outlined star based on favorite status
108 | 
109 | ### Phase 5: State Management
110 | 
111 | #### 5.1 Extend Model Context
112 | ```typescript
113 | // lib/context/model-context.tsx
114 | interface ModelContextValue {
115 |   // ... existing properties
116 |   favorites: string[];
117 |   toggleFavorite: (modelId: string) => Promise<void>;
118 |   isFavorite: (modelId: string) => boolean;
119 | }
120 | ```
121 | 
122 | #### 5.2 Add Favorites Hook
123 | ```typescript
124 | // hooks/useFavorites.ts
125 | export function useFavorites() {
126 |   const { favorites, toggleFavorite, isFavorite } = useModel();
127 |   return { favorites, toggleFavorite, isFavorite };
128 | }
129 | ```
130 | 
131 | ### Phase 6: UI/UX Enhancements
132 | 
133 | #### 6.1 Tab Navigation
134 | - Implement "All" and "Favorites" tabs
135 | - Show count of favorite models
136 | - Handle empty favorites state
137 | 
138 | #### 6.2 Visual Design
139 | - Star icons (filled for favorites, outlined for non-favorites)
140 | - Hover effects and animations
141 | - Consistent with existing design system
142 | 
143 | #### 6.3 Accessibility
144 | - Proper ARIA labels for star buttons
145 | - Keyboard navigation support
146 | - Screen reader friendly descriptions
147 | 
148 | ### Phase 7: Performance Optimizations
149 | 
150 | #### 7.1 Caching Strategy
151 | - Cache favorite status in client state
152 | - Implement optimistic updates
153 | - Handle offline scenarios gracefully
154 | 
155 | #### 7.2 Database Optimization
156 | - Add indexes on `(user_id, model_id)`
157 | - Consider denormalization for frequently accessed data
158 | - Implement efficient batch operations
159 | 
160 | ### Phase 8: Testing
161 | 
162 | #### 8.1 Unit Tests
163 | - Favorites service methods
164 | - API endpoint functionality
165 | - UI component behavior
166 | 
167 | #### 8.2 Integration Tests
168 | - End-to-end favorite workflow
169 | - Error handling scenarios
170 | - Performance under load
171 | 
172 | #### 8.3 User Acceptance Tests
173 | - Favorite/unfavorite workflow
174 | - Tab switching behavior
175 | - Search within favorites
176 | 
177 | ## Technical Implementation Details
178 | 
179 | ### Database Migration
180 | ```sql
181 | -- drizzle/0021_add_favorite_models.sql
182 | CREATE TABLE favorite_models (
183 |   id TEXT PRIMARY KEY DEFAULT nanoid(),
184 |   user_id TEXT NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
185 |   model_id TEXT NOT NULL,
186 |   created_at TIMESTAMP DEFAULT NOW() NOT NULL,
187 |   UNIQUE(user_id, model_id)
188 | );
189 | 
190 | CREATE INDEX idx_favorite_models_user_id ON favorite_models(user_id);
191 | CREATE INDEX idx_favorite_models_model_id ON favorite_models(model_id);
192 | ```
193 | 
194 | ### API Route Structure
195 | ```
196 | /api/favorites/
197 | ├── models/
198 | │   ├── route.ts (GET, POST)
199 | │   └── [modelId]/
200 | │       └── route.ts (DELETE)
201 | ```
202 | 
203 | ### Component Hierarchy
204 | ```
205 | ModelPicker
206 | ├── ModelPickerTabs (All, Favorites)
207 | ├── ModelSearch
208 | ├── ModelList
209 | │   └── ModelListItem
210 | │       └── FavoriteToggle
211 | └── ModelDetails
212 | ```
213 | 
214 | ## Security Considerations
215 | 
216 | ### Authentication
217 | - All favorite operations require valid user session
218 | - Validate user ownership of favorites
219 | - Prevent unauthorized access to other users' favorites
220 | 
221 | ### Input Validation
222 | - Validate model IDs exist before adding to favorites
223 | - Sanitize all user inputs
224 | - Implement rate limiting for favorite operations
225 | 
226 | ### Data Integrity
227 | - Use database constraints to prevent duplicates
228 | - Implement proper error handling
229 | - Add audit logging for debugging
230 | 
231 | ## Error Handling
232 | 
233 | ### Client-Side
234 | - Optimistic updates with rollback on failure
235 | - User-friendly error messages
236 | - Retry mechanisms for network failures
237 | 
238 | ### Server-Side
239 | - Proper HTTP status codes
240 | - Detailed error logging
241 | - Graceful degradation
242 | 
243 | ## Performance Considerations
244 | 
245 | ### Database
246 | - Efficient queries with proper indexing
247 | - Consider pagination for large favorite lists
248 | - Implement caching where appropriate
249 | 
250 | ### Client
251 | - Debounced favorite toggles
252 | - Optimistic UI updates
253 | - Efficient re-rendering strategies
254 | 
255 | ## Migration Strategy
256 | 
257 | ### Phase 1: Backend Foundation
258 | 1. Create database migration
259 | 2. Implement API endpoints
260 | 3. Add backend services
261 | 4. Update model context
262 | 
263 | ### Phase 2: UI Implementation
264 | 1. Update model picker component
265 | 2. Add favorite toggle functionality
266 | 3. Implement tab navigation
267 | 4. Add visual indicators
268 | 
269 | ### Phase 3: Testing & Polish
270 | 1. Comprehensive testing
271 | 2. Performance optimization
272 | 3. Accessibility improvements
273 | 4. User feedback integration
274 | 
275 | ## Success Metrics
276 | 
277 | ### Technical Metrics
278 | - API response times < 200ms
279 | - Database query performance
280 | - Client-side rendering performance
281 | - Error rates < 1%
282 | 
283 | ### User Experience Metrics
284 | - Time to favorite/unfavorite < 500ms
285 | - Intuitive UI interactions
286 | - Accessibility compliance
287 | - User satisfaction scores
288 | 
289 | ## Future Enhancements
290 | 
291 | ### Potential Features
292 | - Favorite model categories/tags
293 | - Import/export favorite lists
294 | - Share favorite configurations
295 | - Favorite model recommendations
296 | - Bulk favorite operations
297 | 
298 | ### Technical Improvements
299 | - Real-time sync across devices
300 | - Offline favorite management
301 | - Advanced filtering options
302 | - Performance optimizations
303 | 
304 | ## Conclusion
305 | 
306 | This implementation plan provides a comprehensive approach to adding favorite models functionality to ChatLima. The design prioritizes simplicity, performance, and user experience while maintaining consistency with the existing codebase architecture.
307 | 
308 | The phased approach allows for incremental development and testing, ensuring each component is solid before moving to the next phase. The plan also considers future enhancements and scalability requirements. 
```

docs/new-features-ideas.md
```
1 | Based on my analysis of the ChatLima codebase, I can now provide you with 3 new features that can be implemented next. Here's my comprehensive assessment:
2 | 
3 | ## Current State Analysis
4 | 
5 | ChatLima is a feature-rich MCP-powered AI chatbot with the following key capabilities:
6 | 
7 | 1. **Dynamic AI Model System**: Access to 300+ models through OpenRouter/Requesty integration with real-time loading
8 | 2. **Favorite Models System**: Users can mark preferred AI models as favorites for quick access
9 | 3. **MCP Integration**: Full support for Model Context Protocol 1.13.0 with external tool integration
10 | 4. **Authentication System**: Google OAuth and anonymous user support with credit management
11 | 5. **Mobile Experience**: Progressive Web App capabilities with iOS integration
12 | 6. **Advanced UI/UX**: Model picker, preset management, and responsive design
13 | 
14 | ## 3 New Features for ChatLima
15 | 
16 | ### 1. **AI Model Performance Analytics Dashboard**
17 | 
18 | **Description**: A comprehensive analytics dashboard that tracks and visualizes AI model performance metrics, helping users make informed decisions about which models to use for different tasks.
19 | 
20 | **Key Features**:
21 | - **Response Time Tracking**: Monitor latency across different models and providers
22 | - **Cost Analysis**: Track usage costs and provide cost-saving recommendations
23 | - **Quality Metrics**: User-rated response quality and accuracy tracking
24 | - **Usage Patterns**: Visualizations of most used models by time of day, task type, etc.
25 | - **Provider Health Status**: Real-time monitoring of provider uptime and reliability
26 | - **Personalized Recommendations**: Suggest optimal models based on user's historical usage patterns
27 | 
28 | **Technical Implementation**:
29 | - Extend the existing [`provider-health-dashboard.tsx`](components/provider-health-dashboard.tsx:1) component
30 | - Add new database tables for performance metrics and user ratings
31 | - Implement data aggregation and visualization using Chart.js or similar
32 | - Create API endpoints for analytics data collection and retrieval
33 | 
34 | **Value Proposition**: This feature would help users optimize their AI model usage, reduce costs, and improve productivity by choosing the right models for specific tasks.
35 | 
36 | ### 2. **Advanced Conversation Management with AI-Powered Insights**
37 | 
38 | **Description**: An enhanced conversation management system that leverages AI to provide intelligent insights, organization, and retrieval of chat history.
39 | 
40 | **Key Features**:
41 | - **Smart Conversation Tagging**: AI-powered automatic categorization and tagging of conversations
42 | - **Semantic Search**: Search across chat history using natural language queries
43 | - **Conversation Summaries**: AI-generated summaries of long conversations
44 | - **Knowledge Extraction**: Identify and extract key information, decisions, and action items from chats
45 | - **Conversation Templates**: Save and reuse conversation patterns for common tasks
46 | - **Cross-Chat Context**: Maintain context across related conversations
47 | - **Export & Sharing**: Advanced export options with formatting and sharing capabilities
48 | 
49 | **Technical Implementation**:
50 | - Extend the existing [`chat-sidebar.tsx`](components/chat-sidebar.tsx:1) component with new organization features
51 | - Implement vector embeddings for semantic search using a service like OpenAI embeddings
52 | - Add conversation analysis API endpoints that leverage existing AI models
53 | - Create a conversation template system similar to the existing preset system
54 | - Implement advanced search with filtering and sorting capabilities
55 | 
56 | **Value Proposition**: This feature would transform ChatLima from a simple chat interface into a knowledge management system, helping users organize, retrieve, and leverage their conversation history effectively.
57 | 
58 | ### 3. **MCP Tool Marketplace & Discovery Platform**
59 | 
60 | **Description**: A built-in marketplace for discovering, installing, and managing MCP servers and tools, making it easy for users to extend ChatLima's capabilities.
61 | 
62 | **Key Features**:
63 | - **Tool Discovery**: Browse and search available MCP servers by category, functionality, and ratings
64 | - **One-Click Installation**: Easy installation of popular MCP servers with automatic configuration
65 | - **User Reviews & Ratings**: Community-driven reviews and ratings for MCP tools
66 | - **Tool Documentation**: Integrated documentation and usage examples for each tool
67 | - **Custom Tool Builder**: Interface for creating simple custom MCP tools without coding
68 | - **Tool Usage Analytics**: Track which tools are most used and provide recommendations
69 | - **Security Verification**: Verified tools with security badges and vulnerability scanning
70 | 
71 | **Technical Implementation**:
72 | - Extend the existing [`mcp-server-manager.tsx`](components/mcp-server-manager.tsx:1) component with marketplace features
73 | - Create a curated registry of MCP servers with metadata and documentation
74 | - Implement a rating and review system with user authentication
75 | - Add security scanning capabilities for MCP server configurations
76 | - Create API endpoints for marketplace data and tool installation
77 | 
78 | **Value Proposition**: This feature would democratize access to MCP tools, making it easy for non-technical users to extend ChatLima's capabilities while maintaining security and reliability.
79 | 
80 | ## Implementation Priority
81 | 
82 | I recommend implementing these features in the following order:
83 | 
84 | 1. **AI Model Performance Analytics Dashboard** - Builds on existing provider health monitoring and provides immediate value to users
85 | 2. **Advanced Conversation Management** - Leverages existing chat infrastructure and AI capabilities
86 | 3. **MCP Tool Marketplace** - More complex but would significantly expand the ecosystem
87 | 
88 | Each of these features aligns with ChatLima's existing architecture and would enhance the user experience while providing unique value propositions that differentiate it from other AI chat platforms.
```

drizzle/0000_supreme_rocket_raccoon.sql
```
1 | CREATE TABLE "chats" (
2 | 	"id" text PRIMARY KEY NOT NULL,
3 | 	"title" text DEFAULT 'New Chat' NOT NULL,
4 | 	"created_at" timestamp DEFAULT now() NOT NULL,
5 | 	"updated_at" timestamp DEFAULT now() NOT NULL
6 | );
7 | --> statement-breakpoint
8 | CREATE TABLE "messages" (
9 | 	"id" text PRIMARY KEY NOT NULL,
10 | 	"chat_id" text NOT NULL,
11 | 	"content" text NOT NULL,
12 | 	"role" text NOT NULL,
13 | 	"created_at" timestamp DEFAULT now() NOT NULL
14 | );
15 | --> statement-breakpoint
16 | ALTER TABLE "messages" ADD CONSTRAINT "messages_chat_id_chats_id_fk" FOREIGN KEY ("chat_id") REFERENCES "public"."chats"("id") ON DELETE cascade ON UPDATE no action;
```

drizzle/0001_curious_paper_doll.sql
```
1 | CREATE TABLE "users" (
2 | 	"id" text PRIMARY KEY NOT NULL,
3 | 	"client_id" text NOT NULL,
4 | 	"created_at" timestamp DEFAULT now() NOT NULL,
5 | 	"updated_at" timestamp DEFAULT now() NOT NULL,
6 | 	CONSTRAINT "users_client_id_unique" UNIQUE("client_id")
7 | );
8 | --> statement-breakpoint
9 | ALTER TABLE "chats" ADD COLUMN "user_id" text;--> statement-breakpoint
10 | ALTER TABLE "chats" ADD CONSTRAINT "chats_user_id_users_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."users"("id") ON DELETE cascade ON UPDATE no action;
```

drizzle/0002_free_cobalt_man.sql
```
1 | CREATE TABLE "steps" (
2 | 	"id" text PRIMARY KEY NOT NULL,
3 | 	"message_id" text NOT NULL,
4 | 	"step_type" text NOT NULL,
5 | 	"text" text,
6 | 	"reasoning" text,
7 | 	"finish_reason" text,
8 | 	"created_at" timestamp DEFAULT now() NOT NULL,
9 | 	"tool_calls" json,
10 | 	"tool_results" json
11 | );
12 | --> statement-breakpoint
13 | ALTER TABLE "users" DISABLE ROW LEVEL SECURITY;--> statement-breakpoint
14 | DROP TABLE "users" CASCADE;--> statement-breakpoint
15 | ALTER TABLE "chats" DROP CONSTRAINT "chats_user_id_users_id_fk";
16 | --> statement-breakpoint
17 | ALTER TABLE "chats" ALTER COLUMN "user_id" SET NOT NULL;--> statement-breakpoint
18 | ALTER TABLE "messages" ADD COLUMN "reasoning" text;--> statement-breakpoint
19 | ALTER TABLE "messages" ADD COLUMN "tool_calls" json;--> statement-breakpoint
20 | ALTER TABLE "messages" ADD COLUMN "tool_results" json;--> statement-breakpoint
21 | ALTER TABLE "messages" ADD COLUMN "has_tool_use" boolean DEFAULT false;--> statement-breakpoint
22 | ALTER TABLE "steps" ADD CONSTRAINT "steps_message_id_messages_id_fk" FOREIGN KEY ("message_id") REFERENCES "public"."messages"("id") ON DELETE cascade ON UPDATE no action;
```

drizzle/0003_oval_energizer.sql
```
1 | ALTER TABLE "steps" DISABLE ROW LEVEL SECURITY;--> statement-breakpoint
2 | DROP TABLE "steps" CASCADE;--> statement-breakpoint
3 | ALTER TABLE "messages" ALTER COLUMN "tool_calls" SET DATA TYPE jsonb;--> statement-breakpoint
4 | ALTER TABLE "messages" ALTER COLUMN "tool_results" SET DATA TYPE jsonb;--> statement-breakpoint
5 | ALTER TABLE "messages" ADD COLUMN "step_type" text;--> statement-breakpoint
6 | ALTER TABLE "messages" ADD COLUMN "finish_reason" text;--> statement-breakpoint
7 | ALTER TABLE "messages" DROP COLUMN "has_tool_use";
```

drizzle/0004_tense_ricochet.sql
```
1 | ALTER TABLE "messages" DROP COLUMN "reasoning";--> statement-breakpoint
2 | ALTER TABLE "messages" DROP COLUMN "tool_calls";--> statement-breakpoint
3 | ALTER TABLE "messages" DROP COLUMN "tool_results";--> statement-breakpoint
4 | ALTER TABLE "messages" DROP COLUMN "step_type";--> statement-breakpoint
5 | ALTER TABLE "messages" DROP COLUMN "finish_reason";
```

drizzle/0005_early_payback.sql
```
1 | ALTER TABLE "messages" ADD COLUMN "parts" json NOT NULL;--> statement-breakpoint
2 | ALTER TABLE "messages" DROP COLUMN "content";
```

drizzle/0007_update_verification_table.sql
```
1 | ALTER TABLE "verificationToken" RENAME TO "verification";--> statement-breakpoint
2 | ALTER TABLE "verification" RENAME COLUMN "expires" TO "expiresAt";--> statement-breakpoint
3 | ALTER TABLE "verification" DROP CONSTRAINT "verificationToken_token_unique";--> statement-breakpoint
4 | ALTER TABLE "verification" DROP CONSTRAINT "verificationToken_identifier_token_pk";--> statement-breakpoint
5 | ALTER TABLE "verification" ADD COLUMN "id" text PRIMARY KEY NOT NULL;--> statement-breakpoint
6 | ALTER TABLE "verification" ADD COLUMN "value" text NOT NULL;--> statement-breakpoint
7 | ALTER TABLE "verification" DROP COLUMN "token";
```

drizzle/0008_alter_accounts_expiresat_type.sql
```
1 | ALTER TABLE "account" ALTER COLUMN "expires_at" SET DATA TYPE timestamp USING to_timestamp(expires_at);
```

drizzle/0009_alter_users_emailverified_type.sql
```
1 | ALTER TABLE "user" ALTER COLUMN "emailVerified" SET DATA TYPE boolean USING ("emailVerified" IS NOT NULL);
```

drizzle/0010_optimal_jane_foster.sql
```
1 | -- ALTER TABLE "account" RENAME COLUMN "expires_at" TO "access_token_expires_at"; -- Already applied by previous push
2 | ALTER TABLE "account" ALTER COLUMN "access_token_expires_at" SET DATA TYPE integer USING EXTRACT(epoch FROM "access_token_expires_at")::integer;
```

drizzle/0011_fixed_cerebro.sql
```
1 | -- ALTER TABLE "account" DROP CONSTRAINT "account_providerId_accountId_pk"; --> statement-breakpoint -- Already dropped by previous push
2 | ALTER TABLE "account" ADD COLUMN "id" text PRIMARY KEY NOT NULL;
```

drizzle/0012_tearful_misty_knight.sql
```
1 | ALTER TABLE "account" ALTER COLUMN "access_token_expires_at" SET DATA TYPE timestamp USING to_timestamp("access_token_expires_at");
```

drizzle/0013_special_whirlwind.sql
```
1 | ALTER TABLE "account" ALTER COLUMN "providerType" DROP NOT NULL;
```

drizzle/0014_fair_praxagora.sql
```
1 | ALTER TABLE "session" RENAME COLUMN "expires" TO "expiresAt";
```

drizzle/0015_remarkable_owl.sql
```
1 | -- First add the column as nullable
2 | ALTER TABLE "session" ADD COLUMN IF NOT EXISTS "token" text;
3 | -- Then update existing records to use the sessionToken value
4 | UPDATE "session" SET "token" = "sessionToken" WHERE "token" IS NULL;
5 | -- Finally make the column NOT NULL if needed
6 | ALTER TABLE "session" ALTER COLUMN "token" SET NOT NULL;
```

drizzle/0016_cooing_lester.sql
```
1 | ALTER TABLE "session" DROP COLUMN "token";
```

drizzle/0017_past_bromley.sql
```
1 | DO $ 
2 | BEGIN
3 |     IF NOT EXISTS (
4 |         SELECT 1
5 |         FROM information_schema.columns
6 |         WHERE table_name = 'messages' AND column_name = 'has_web_search'
7 |     ) THEN
8 |         ALTER TABLE "messages" ADD COLUMN "has_web_search" boolean DEFAULT false;
9 |     END IF;
10 | END $;--> statement-breakpoint
11 | 
12 | DO $ 
13 | BEGIN
14 |     IF NOT EXISTS (
15 |         SELECT 1
16 |         FROM information_schema.columns
17 |         WHERE table_name = 'messages' AND column_name = 'web_search_context_size'
18 |     ) THEN
19 |         ALTER TABLE "messages" ADD COLUMN "web_search_context_size" text DEFAULT 'medium';
20 |     END IF;
21 | END $;
```

drizzle/0018_conscious_dragon_man.sql
```
1 | DO $ 
2 | BEGIN
3 |     IF NOT EXISTS (
4 |         SELECT 1
5 |         FROM information_schema.tables
6 |         WHERE table_name = 'polar_usage_events'
7 |     ) THEN
8 |         CREATE TABLE "polar_usage_events" (
9 |             "id" text PRIMARY KEY NOT NULL,
10 |             "user_id" text NOT NULL,
11 |             "polar_customer_id" text,
12 |             "event_name" text NOT NULL,
13 |             "event_payload" json NOT NULL,
14 |             "created_at" timestamp DEFAULT now() NOT NULL
15 |         );
16 |         
17 |         ALTER TABLE "polar_usage_events" ADD CONSTRAINT "polar_usage_events_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;
18 |     END IF;
19 | END $;
```

drizzle/0018_manual_polar_events.sql
```
1 | -- Migration manually applied via Neon MCP
2 | -- This file is a placeholder to track that the polarUsageEvents table was created
3 | 
4 | -- CREATE TABLE was executed directly via Neon API
```

drizzle/0020_rainy_rockslide.sql
```
1 | ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "isAnonymous" boolean DEFAULT false;
```

drizzle/0021_aberrant_baron_zemo.sql
```
1 | ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "metadata" json;
```

drizzle/0022_add_presets_tables.sql
```
1 | -- Create presets table with simplified schema
2 | CREATE TABLE "presets" (
3 |   "id" text PRIMARY KEY NOT NULL DEFAULT gen_random_uuid(),
4 |   "user_id" text NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
5 |   "name" text NOT NULL,
6 |   "model_id" text NOT NULL,
7 |   "system_instruction" text NOT NULL,
8 |   "temperature" integer NOT NULL,
9 |   "max_tokens" integer NOT NULL,
10 |   "web_search_enabled" boolean DEFAULT false,
11 |   "web_search_context_size" text DEFAULT 'medium',
12 |   "api_key_preferences" jsonb DEFAULT '{}',
13 |   "is_default" boolean DEFAULT false,
14 |   "share_id" text UNIQUE,
15 |   "visibility" text DEFAULT 'private',
16 |   "version" integer DEFAULT 1,
17 |   "created_at" timestamp DEFAULT NOW() NOT NULL,
18 |   "updated_at" timestamp DEFAULT NOW() NOT NULL,
19 |   "deleted_at" timestamp,
20 |   
21 |   -- Constraints
22 |   CONSTRAINT "check_name_length" CHECK (char_length("name") >= 1 AND char_length("name") <= 100),
23 |   CONSTRAINT "check_system_instruction_length" CHECK (char_length("system_instruction") >= 10 AND char_length("system_instruction") <= 4000),
24 |   CONSTRAINT "check_temperature_range" CHECK ("temperature" >= 0 AND "temperature" <= 2000),
25 |   CONSTRAINT "check_max_tokens_range" CHECK ("max_tokens" > 0 AND "max_tokens" <= 100000),
26 |   CONSTRAINT "check_visibility" CHECK ("visibility" IN ('private', 'shared')),
27 |   CONSTRAINT "check_web_search_context_size" CHECK ("web_search_context_size" IN ('low', 'medium', 'high')),
28 |   CONSTRAINT "check_share_id_format" CHECK ("share_id" IS NULL OR (char_length("share_id") >= 20 AND char_length("share_id") <= 50)),
29 |   CONSTRAINT "unique_name_per_user" UNIQUE ("user_id", "name"),
30 |   CONSTRAINT "one_default_per_user" UNIQUE ("user_id", "is_default") DEFERRABLE INITIALLY DEFERRED
31 | );
32 | 
33 | -- Create preset usage tracking table
34 | CREATE TABLE "preset_usage" (
35 |   "id" text PRIMARY KEY NOT NULL DEFAULT gen_random_uuid(),
36 |   "preset_id" text NOT NULL REFERENCES "presets"("id") ON DELETE CASCADE,
37 |   "user_id" text NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
38 |   "chat_id" text,
39 |   "used_at" timestamp DEFAULT NOW() NOT NULL
40 | );
41 | 
42 | -- Create indexes
43 | CREATE INDEX "idx_presets_user_id" ON "presets"("user_id") WHERE "deleted_at" IS NULL;
44 | CREATE INDEX "idx_presets_share_id" ON "presets"("share_id") WHERE "share_id" IS NOT NULL;
45 | CREATE INDEX "idx_presets_model_id" ON "presets"("model_id") WHERE "deleted_at" IS NULL;
46 | CREATE INDEX "idx_presets_created_at" ON "presets"("created_at");
47 | CREATE INDEX "idx_preset_usage_preset_id" ON "preset_usage"("preset_id");
48 | CREATE INDEX "idx_preset_usage_user_id" ON "preset_usage"("user_id");
49 | CREATE INDEX "idx_preset_usage_used_at" ON "preset_usage"("used_at");
50 | 
51 | -- Create trigger for updated_at
52 | CREATE OR REPLACE FUNCTION update_updated_at_column()
53 | RETURNS TRIGGER AS $
54 | BEGIN
55 |    NEW.updated_at = NOW();
56 |    RETURN NEW;
57 | END;
58 | $ language 'plpgsql';
59 | 
60 | CREATE TRIGGER update_presets_updated_at 
61 |   BEFORE UPDATE ON "presets" 
62 |   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
63 | 
64 | -- Add default_preset_id to users table
65 | ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "default_preset_id" text REFERENCES "presets"("id") ON DELETE SET NULL;
66 | 
67 | -- Function to generate secure share IDs
68 | CREATE OR REPLACE FUNCTION generate_share_id()
69 | RETURNS TEXT AS $
70 | BEGIN
71 |   RETURN encode(gen_random_bytes(20), 'base64')::TEXT;
72 | END;
73 | $ LANGUAGE plpgsql;
74 | 
75 | -- Migration function to handle existing anonymous users
76 | CREATE OR REPLACE FUNCTION migrate_anonymous_presets(
77 |   p_anonymous_user_id text,
78 |   p_authenticated_user_id text
79 | ) RETURNS VOID AS $
80 | BEGIN
81 |   -- Transfer presets from anonymous user to authenticated user
82 |   UPDATE "presets" 
83 |   SET "user_id" = p_authenticated_user_id 
84 |   WHERE "user_id" = p_anonymous_user_id;
85 |   
86 |   -- Log the migration
87 |   INSERT INTO "preset_usage" ("preset_id", "user_id", "chat_id", "used_at")
88 |   SELECT "id", p_authenticated_user_id, NULL, NOW()
89 |   FROM "presets" 
90 |   WHERE "user_id" = p_authenticated_user_id
91 |   AND "created_at" <= NOW() - INTERVAL '1 minute'; -- Recently migrated presets
92 | END;
93 | $ LANGUAGE plpgsql;
```

drizzle/0023_remove_one_default_per_user_constraint.sql
```
1 | -- Remove the one_default_per_user constraint that's causing duplicate key violations
2 | -- This constraint is no longer needed as the application handles default preset logic
3 | ALTER TABLE "presets" DROP CONSTRAINT IF EXISTS "one_default_per_user"; 
```

drizzle/0024_light_terror.sql
```
1 | CREATE TABLE "favorite_models" (
2 | 	"id" text PRIMARY KEY NOT NULL,
3 | 	"user_id" text NOT NULL,
4 | 	"model_id" text NOT NULL,
5 | 	"created_at" timestamp DEFAULT now() NOT NULL,
6 | 	CONSTRAINT "unique_user_model" UNIQUE("user_id","model_id")
7 | );
8 | --> statement-breakpoint
9 | ALTER TABLE "favorite_models" ADD CONSTRAINT "favorite_models_user_id_user_id_fk" FOREIGN KEY ("user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;
```

drizzle/0025_flaky_thing.sql
```
1 | CREATE INDEX "idx_favorite_models_user_id" ON "favorite_models" USING btree ("user_id");--> statement-breakpoint
2 | CREATE INDEX "idx_favorite_models_model_id" ON "favorite_models" USING btree ("model_id");
```

drizzle/0026_previous_patch.sql
```
1 | CREATE TABLE "chat_shares" (
2 | 	"id" text PRIMARY KEY NOT NULL,
3 | 	"chat_id" text NOT NULL,
4 | 	"owner_user_id" text NOT NULL,
5 | 	"share_id" text NOT NULL,
6 | 	"status" text DEFAULT 'active' NOT NULL,
7 | 	"visibility" text DEFAULT 'unlisted' NOT NULL,
8 | 	"snapshot_json" json NOT NULL,
9 | 	"view_count" integer DEFAULT 0 NOT NULL,
10 | 	"created_at" timestamp DEFAULT now() NOT NULL,
11 | 	"revoked_at" timestamp,
12 | 	CONSTRAINT "chat_shares_share_id_unique" UNIQUE("share_id"),
13 | 	CONSTRAINT "check_chat_shares_status" CHECK ("chat_shares"."status" IN ('active','revoked')),
14 | 	CONSTRAINT "check_chat_shares_visibility" CHECK ("chat_shares"."visibility" IN ('unlisted')),
15 | 	CONSTRAINT "check_chat_shares_share_id_format" CHECK (char_length("chat_shares"."share_id") >= 20 AND char_length("chat_shares"."share_id") <= 64)
16 | );
17 | --> statement-breakpoint
18 | ALTER TABLE "chat_shares" ADD CONSTRAINT "chat_shares_chat_id_chats_id_fk" FOREIGN KEY ("chat_id") REFERENCES "public"."chats"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
19 | ALTER TABLE "chat_shares" ADD CONSTRAINT "chat_shares_owner_user_id_user_id_fk" FOREIGN KEY ("owner_user_id") REFERENCES "public"."user"("id") ON DELETE cascade ON UPDATE no action;--> statement-breakpoint
20 | CREATE INDEX "idx_chat_shares_chat_id_status" ON "chat_shares" USING btree ("chat_id","status");--> statement-breakpoint
21 | CREATE INDEX "idx_chat_shares_owner_user_id_status" ON "chat_shares" USING btree ("owner_user_id","status");
```

hooks/use-mobile.ts
```
1 | import { useEffect, useState } from "react";
2 | 
3 | const MOBILE_BREAKPOINT = 768;
4 | 
5 | export const useIsMobile = () => {
6 |   const [isMobile, setIsMobile] = useState(false);
7 | 
8 |   useEffect(() => {
9 |     const checkDevice = () => {
10 |       setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
11 |     };
12 | 
13 |     checkDevice();
14 |     window.addEventListener("resize", checkDevice);
15 | 
16 |     return () => {
17 |       window.removeEventListener("resize", checkDevice);
18 |     };
19 |   }, []);
20 | 
21 |   return isMobile;
22 | };
23 | 
24 | export const useIsTouchDevice = () => {
25 |   const [isTouchDevice, setIsTouchDevice] = useState(false);
26 | 
27 |   useEffect(() => {
28 |     const checkTouchDevice = () => {
29 |       // Check if device supports touch and doesn't support hover (typical mobile/tablet)
30 |       const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
31 |       const hasHover = window.matchMedia('(hover: hover)').matches;
32 |       setIsTouchDevice(hasTouch && !hasHover);
33 |     };
34 | 
35 |     checkTouchDevice();
36 | 
37 |     // Listen for media query changes
38 |     const hoverQuery = window.matchMedia('(hover: hover)');
39 |     const pointerQuery = window.matchMedia('(pointer: coarse)');
40 | 
41 |     const handleChange = () => checkTouchDevice();
42 |     hoverQuery.addEventListener('change', handleChange);
43 |     pointerQuery.addEventListener('change', handleChange);
44 | 
45 |     return () => {
46 |       hoverQuery.removeEventListener('change', handleChange);
47 |       pointerQuery.removeEventListener('change', handleChange);
48 |     };
49 |   }, []);
50 | 
51 |   return isTouchDevice;
52 | };
```

hooks/use-models.ts
```
1 | "use client";
2 | 
3 | import useSWR from 'swr';
4 | import { useState, useCallback, useMemo } from 'react';
5 | import { ModelsResponse, ModelInfo } from '@/lib/types/models';
6 | 
7 | // Configuration for SWR
8 | const SWR_CONFIG = {
9 |     refreshInterval: 5 * 60 * 1000, // 5 minutes
10 |     revalidateOnFocus: true,
11 |     revalidateOnReconnect: true,
12 |     dedupingInterval: 30 * 1000, // 30 seconds
13 |     errorRetryCount: 3,
14 |     errorRetryInterval: 2000,
15 | };
16 | 
17 | // Custom fetcher with API key support
18 | async function modelsFetcher(
19 |     url: string,
20 |     userApiKeys?: Record<string, string>
21 | ): Promise<ModelsResponse> {
22 |     const headers: Record<string, string> = {
23 |         'Content-Type': 'application/json',
24 |     };
25 | 
26 |     // Include user API keys if provided
27 |     if (userApiKeys && Object.keys(userApiKeys).length > 0) {
28 |         headers['x-api-keys'] = JSON.stringify(userApiKeys);
29 |     }
30 | 
31 |     const response = await fetch(url, { headers });
32 | 
33 |     if (!response.ok) {
34 |         const errorData = await response.json().catch(() => ({}));
35 |         throw new Error(
36 |             errorData.error || `HTTP ${response.status}: ${response.statusText}`
37 |         );
38 |     }
39 | 
40 |     return response.json();
41 | }
42 | 
43 | // Hook interface
44 | interface UseModelsOptions {
45 |     userApiKeys?: Record<string, string>;
46 |     enabled?: boolean;
47 |     refreshInterval?: number;
48 | }
49 | 
50 | interface UseModelsReturn {
51 |     models: ModelInfo[];
52 |     isLoading: boolean;
53 |     isValidating: boolean;
54 |     error: Error | null;
55 |     metadata?: ModelsResponse['metadata'];
56 |     refresh: () => Promise<ModelsResponse | undefined>;
57 |     forceRefresh: () => Promise<ModelsResponse | undefined>;
58 |     mutate: (data?: ModelsResponse) => Promise<ModelsResponse | undefined>;
59 | }
60 | 
61 | // Main hook
62 | export function useModels(options: UseModelsOptions = {}): UseModelsReturn {
63 |     const {
64 |         userApiKeys,
65 |         enabled = true,
66 |         refreshInterval = SWR_CONFIG.refreshInterval,
67 |     } = options;
68 | 
69 |     // Create a stable key that includes user API keys
70 |     const swrKey = useMemo(() => {
71 |         if (!enabled) return null;
72 | 
73 |         const baseKey = '/api/models';
74 |         const keyHash = userApiKeys ? JSON.stringify(userApiKeys) : '';
75 |         return keyHash ? `${baseKey}?keys=${btoa(keyHash)}` : baseKey;
76 |     }, [enabled, userApiKeys]);
77 | 
78 |     // SWR hook with custom fetcher
79 |     const {
80 |         data,
81 |         error,
82 |         isLoading,
83 |         isValidating,
84 |         mutate
85 |     } = useSWR<ModelsResponse>(
86 |         swrKey,
87 |         () => modelsFetcher('/api/models', userApiKeys),
88 |         {
89 |             ...SWR_CONFIG,
90 |             refreshInterval,
91 |             onError: (error) => {
92 |                 console.error('Error fetching models:', error);
93 |             },
94 |             onSuccess: (data) => {
95 |                 console.log(`Fetched ${data.models.length} models from ${Object.keys(data.metadata.providers).length} providers`);
96 |             },
97 |         }
98 |     );
99 | 
100 |     // Refresh function (uses cache, respects stale-while-revalidate)
101 |     const refresh = useCallback(async () => {
102 |         return mutate();
103 |     }, [mutate]);
104 | 
105 |     // Force refresh function (bypasses cache)
106 |     const forceRefresh = useCallback(async () => {
107 |         try {
108 |             // Clear cache and force fresh fetch
109 |             const result = await mutate(
110 |                 modelsFetcher('/api/models?force=true', userApiKeys),
111 |                 { revalidate: false }
112 |             );
113 |             return result;
114 |         } catch (error) {
115 |             console.error('Error during force refresh:', error);
116 |             throw error;
117 |         }
118 |     }, [mutate, userApiKeys]);
119 | 
120 |     return {
121 |         models: data?.models || [],
122 |         isLoading,
123 |         isValidating,
124 |         error,
125 |         metadata: data?.metadata,
126 |         refresh,
127 |         forceRefresh,
128 |         mutate,
129 |     };
130 | }
131 | 
132 | // Legacy compatibility hook that mimics the old static models behavior
133 | export function useStaticModels(): {
134 |     models: string[];
135 |     modelDetails: Record<string, any>;
136 |     isLoading: boolean;
137 | } {
138 |     const { models, isLoading } = useModels();
139 | 
140 |     // Convert new ModelInfo to legacy format
141 |     const legacyModels = useMemo(() => {
142 |         return models.map(model => model.id);
143 |     }, [models]);
144 | 
145 |     const legacyModelDetails = useMemo(() => {
146 |         const details: Record<string, any> = {};
147 |         models.forEach(model => {
148 |             details[model.id] = {
149 |                 provider: model.provider,
150 |                 name: model.name,
151 |                 description: model.description,
152 |                 apiVersion: model.apiVersion,
153 |                 capabilities: model.capabilities,
154 |                 enabled: model.enabled,
155 |                 supportsWebSearch: model.supportsWebSearch,
156 |                 premium: model.premium,
157 |                 vision: model.vision,
158 |                 temperatureRange: model.temperatureRange,
159 |                 maxTokensRange: model.maxTokensRange,
160 |                 supportsTemperature: model.supportsTemperature,
161 |                 supportsMaxTokens: model.supportsMaxTokens,
162 |                 supportsSystemInstruction: model.supportsSystemInstruction,
163 |                 maxSystemInstructionLength: model.maxSystemInstructionLength,
164 |             };
165 |         });
166 |         return details;
167 |     }, [models]);
168 | 
169 |     return {
170 |         models: legacyModels,
171 |         modelDetails: legacyModelDetails,
172 |         isLoading,
173 |     };
174 | }
175 | 
176 | // Utility hook for provider health monitoring
177 | export function useProviderHealth() {
178 |     const { metadata, isLoading, error } = useModels();
179 | 
180 |     const healthStatus = useMemo(() => {
181 |         if (!metadata) return { overall: 'unknown', providers: {} };
182 | 
183 |         const providers = metadata.providers;
184 |         const healthyCount = Object.values(providers).filter(p => p.status === 'healthy').length;
185 |         const totalCount = Object.keys(providers).length;
186 | 
187 |         let overall: 'healthy' | 'degraded' | 'down' | 'unknown' = 'unknown';
188 |         if (totalCount === 0) {
189 |             overall = 'unknown';
190 |         } else if (healthyCount === totalCount) {
191 |             overall = 'healthy';
192 |         } else if (healthyCount > 0) {
193 |             overall = 'degraded';
194 |         } else {
195 |             overall = 'down';
196 |         }
197 | 
198 |         return {
199 |             overall,
200 |             providers,
201 |             healthyCount,
202 |             totalCount,
203 |             lastUpdated: metadata.lastUpdated,
204 |         };
205 |     }, [metadata]);
206 | 
207 |     return {
208 |         ...healthStatus,
209 |         isLoading,
210 |         error,
211 |     };
212 | }
213 | 
214 | // Utility hook for cache management
215 | export function useModelsCache() {
216 |     const [isClearing, setIsClearing] = useState(false);
217 | 
218 |     const clearCache = useCallback(async (provider?: string) => {
219 |         setIsClearing(true);
220 |         try {
221 |             const response = await fetch('/api/models', {
222 |                 method: 'POST',
223 |                 headers: { 'Content-Type': 'application/json' },
224 |                 body: JSON.stringify({ provider }),
225 |             });
226 | 
227 |             if (!response.ok) {
228 |                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
229 |             }
230 | 
231 |             return await response.json();
232 |         } finally {
233 |             setIsClearing(false);
234 |         }
235 |     }, []);
236 | 
237 |     const getCacheStats = useCallback(async () => {
238 |         const response = await fetch('/api/models?stats=true');
239 |         if (!response.ok) {
240 |             throw new Error(`HTTP ${response.status}: ${response.statusText}`);
241 |         }
242 |         return response.json();
243 |     }, []);
244 | 
245 |     return {
246 |         clearCache,
247 |         getCacheStats,
248 |         isClearing,
249 |     };
250 | } 
```

hooks/useAuth.ts
```
1 | "use client";
2 | 
3 | // Re-export the centralized auth hook to maintain backward compatibility
4 | export { useAuth } from '@/lib/context/auth-context';
5 | 
6 | // Also export the sign-in and sign-out functions for components that need them directly
7 | export { signIn, signOut } from '@/lib/auth-client';
```

hooks/useCredits.ts
```
1 | import { useState, useEffect } from 'react';
2 | 
3 | /**
4 |  * Hook to get and manage a user's credits
5 |  * 
6 |  * @param polarCustomerId The customer's ID in Polar system (legacy) - deprecated, kept for compatibility
7 |  * @param userId The user's ID in our application (used as external ID in Polar)
8 |  * @returns Object containing the user's credits status and related functions
9 |  */
10 | export function useCredits(polarCustomerId?: string, userId?: string) {
11 |     const [credits, setCredits] = useState<number | null>(null);
12 |     const [loading, setLoading] = useState<boolean>(false);
13 |     const [error, setError] = useState<Error | null>(null);
14 | 
15 |     // Function to fetch credits via API endpoint
16 |     const fetchCredits = async () => {
17 |         // If no userId is provided, we can't fetch credits
18 |         if (!userId) {
19 |             //console.log('[DEBUG] useCredits: No userId provided, setting credits to null');
20 |             setCredits(null);
21 |             return;
22 |         }
23 | 
24 |         //console.log(`[DEBUG] useCredits: Fetching credits for userId: ${userId}`);
25 |         setLoading(true);
26 |         setError(null);
27 | 
28 |         try {
29 |             const response = await fetch('/api/credits');
30 | 
31 |             if (!response.ok) {
32 |                 throw new Error(`Failed to fetch credits: ${response.status}`);
33 |             }
34 | 
35 |             const data = await response.json();
36 |             //console.log(`[DEBUG] useCredits: API response:`, data);
37 | 
38 |             if (data.error) {
39 |                 throw new Error(data.error);
40 |             }
41 | 
42 |             //console.log(`[DEBUG] useCredits: Setting credits to: ${data.credits}`);
43 |             setCredits(data.credits);
44 |         } catch (err) {
45 |             console.error('Error fetching credits:', err);
46 |             setError(err instanceof Error ? err : new Error('Failed to fetch credits'));
47 |             setCredits(null);
48 |         } finally {
49 |             setLoading(false);
50 |         }
51 |     };
52 | 
53 |     // Fetch credits on mount and when IDs change
54 |     useEffect(() => {
55 |         fetchCredits();
56 |     }, [polarCustomerId, userId]);
57 | 
58 |     // Helper function to format credits display with thousands separator
59 |     const formattedCredits = credits !== null
60 |         ? credits.toLocaleString()
61 |         : 'Unknown';
62 | 
63 |     // Function to check if user has sufficient credits for an operation
64 |     const hasSufficientCredits = (requiredAmount: number = 1): boolean => {
65 |         if (credits === null) return true; // Allow if credits unknown
66 |         return credits >= requiredAmount;
67 |     };
68 | 
69 |     // Function to check if user can access premium models
70 |     const canAccessPremiumModels = (): boolean => {
71 |         const canAccess = credits !== null && credits > 0;
72 |         // console.log(`[DEBUG] canAccessPremiumModels: credits=${credits}, canAccess=${canAccess}`);
73 |         return canAccess;
74 |     };
75 | 
76 |     return {
77 |         credits,
78 |         formattedCredits,
79 |         loading,
80 |         error,
81 |         fetchCredits,
82 |         hasSufficientCredits,
83 |         canAccessPremiumModels,
84 |     };
85 | } 
```

hooks/useFavorites.ts
```
1 | import { useState, useEffect, useCallback } from 'react';
2 | import { useAuth } from './useAuth';
3 | 
4 | interface FavoritesResponse {
5 |     favorites: string[];
6 |     count: number;
7 |     lastUpdated: string;
8 | }
9 | 
10 | interface FavoriteOperationResponse {
11 |     success: boolean;
12 |     message: string;
13 |     modelId: string;
14 | }
15 | 
16 | export function useFavorites() {
17 |     const { user } = useAuth();
18 |     const [favorites, setFavorites] = useState<string[]>([]);
19 |     const [isLoading, setIsLoading] = useState(true);
20 |     const [error, setError] = useState<string | null>(null);
21 | 
22 |     // Fetch user's favorites
23 |     const fetchFavorites = useCallback(async () => {
24 |         if (!user?.id) {
25 |             setFavorites([]);
26 |             setIsLoading(false);
27 |             return;
28 |         }
29 | 
30 |         try {
31 |             setIsLoading(true);
32 |             setError(null);
33 | 
34 |             const response = await fetch('/api/favorites/models', {
35 |                 method: 'GET',
36 |                 headers: {
37 |                     'Content-Type': 'application/json',
38 |                 },
39 |             });
40 | 
41 |             if (!response.ok) {
42 |                 if (response.status === 401) {
43 |                     setFavorites([]);
44 |                     return;
45 |                 }
46 |                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
47 |             }
48 | 
49 |             const data: FavoritesResponse = await response.json();
50 |             setFavorites(data.favorites || []);
51 |         } catch (error) {
52 |             console.error('Error fetching favorites:', error);
53 |             setError(error instanceof Error ? error.message : 'Failed to load favorites');
54 |             setFavorites([]);
55 |         } finally {
56 |             setIsLoading(false);
57 |         }
58 |     }, [user?.id]);
59 | 
60 |     // Initial load
61 |     useEffect(() => {
62 |         fetchFavorites();
63 |     }, [fetchFavorites]);
64 | 
65 |     // Add model to favorites
66 |     const addFavorite = useCallback(async (modelId: string): Promise<boolean> => {
67 |         if (!user?.id) {
68 |             setError('Must be logged in to add favorites');
69 |             return false;
70 |         }
71 | 
72 |         if (favorites.includes(modelId)) {
73 |             return true; // Already favorited
74 |         }
75 | 
76 |         // Optimistic update
77 |         setFavorites(prev => [...prev, modelId]);
78 |         setError(null);
79 | 
80 |         try {
81 |             const response = await fetch('/api/favorites/models', {
82 |                 method: 'POST',
83 |                 headers: {
84 |                     'Content-Type': 'application/json',
85 |                 },
86 |                 body: JSON.stringify({ modelId }),
87 |             });
88 | 
89 |             if (!response.ok) {
90 |                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
91 |             }
92 | 
93 |             const data: FavoriteOperationResponse = await response.json();
94 |             return data.success;
95 |         } catch (error) {
96 |             console.error('Error adding favorite:', error);
97 | 
98 |             // Rollback optimistic update
99 |             setFavorites(prev => prev.filter(id => id !== modelId));
100 |             setError(error instanceof Error ? error.message : 'Failed to add favorite');
101 |             return false;
102 |         }
103 |     }, [user?.id, favorites]);
104 | 
105 |     // Remove model from favorites
106 |     const removeFavorite = useCallback(async (modelId: string): Promise<boolean> => {
107 |         if (!user?.id) {
108 |             setError('Must be logged in to remove favorites');
109 |             return false;
110 |         }
111 | 
112 |         if (!favorites.includes(modelId)) {
113 |             return true; // Not favorited anyway
114 |         }
115 | 
116 |         // Optimistic update
117 |         const originalFavorites = favorites;
118 |         setFavorites(prev => prev.filter(id => id !== modelId));
119 |         setError(null);
120 | 
121 |         try {
122 |             const response = await fetch(`/api/favorites/models/${encodeURIComponent(modelId)}`, {
123 |                 method: 'DELETE',
124 |                 headers: {
125 |                     'Content-Type': 'application/json',
126 |                 },
127 |             });
128 | 
129 |             if (!response.ok) {
130 |                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
131 |             }
132 | 
133 |             const data: FavoriteOperationResponse = await response.json();
134 |             return data.success;
135 |         } catch (error) {
136 |             console.error('Error removing favorite:', error);
137 | 
138 |             // Rollback optimistic update
139 |             setFavorites(originalFavorites);
140 |             setError(error instanceof Error ? error.message : 'Failed to remove favorite');
141 |             return false;
142 |         }
143 |     }, [user?.id, favorites]);
144 | 
145 |     // Toggle favorite status
146 |     const toggleFavorite = useCallback(async (modelId: string): Promise<boolean> => {
147 |         const isFavorite = favorites.includes(modelId);
148 |         return isFavorite ? removeFavorite(modelId) : addFavorite(modelId);
149 |     }, [favorites, addFavorite, removeFavorite]);
150 | 
151 |     // Check if model is favorited
152 |     const isFavorite = useCallback((modelId: string): boolean => {
153 |         return favorites.includes(modelId);
154 |     }, [favorites]);
155 | 
156 |     // Clear error
157 |     const clearError = useCallback(() => {
158 |         setError(null);
159 |     }, []);
160 | 
161 |     return {
162 |         favorites,
163 |         isLoading,
164 |         error,
165 |         fetchFavorites,
166 |         addFavorite,
167 |         removeFavorite,
168 |         toggleFavorite,
169 |         isFavorite,
170 |         clearError,
171 |         favoriteCount: favorites.length,
172 |     };
173 | } 
```

lib/auth-client.ts
```
1 | "use client";
2 | 
3 | import { createAuthClient } from "better-auth/react"; // Use the React adapter
4 | import { anonymousClient } from "better-auth/client/plugins";
5 | 
6 | export const { signIn, signOut, useSession } = createAuthClient({
7 |     plugins: [
8 |         anonymousClient()
9 |     ]
10 | }); 
```

lib/auth.ts
```
1 | import { betterAuth } from 'better-auth';
2 | import { drizzleAdapter } from 'better-auth/adapters/drizzle';
3 | import { anonymous } from 'better-auth/plugins';
4 | import { db } from './db/index'; // Assuming your Drizzle instance is exported from here
5 | import * as schema from './db/schema'; // Assuming your full Drizzle schema is exported here
6 | import { Polar } from '@polar-sh/sdk';
7 | import { polar as polarPlugin } from '@polar-sh/better-auth';
8 | import { count, eq, and, gte } from 'drizzle-orm';
9 | import { getRemainingCreditsByExternalId } from './polar';
10 | 
11 | // Dynamic Google OAuth configuration based on environment
12 | const getGoogleOAuthConfig = () => {
13 |     const isProduction = process.env.NODE_ENV === 'production' &&
14 |         process.env.VERCEL_ENV === 'production';
15 | 
16 |     if (isProduction) {
17 |         // Production OAuth app
18 |         if (!process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID_PROD) {
19 |             throw new Error('Missing NEXT_PUBLIC_GOOGLE_CLIENT_ID_PROD environment variable');
20 |         }
21 |         if (!process.env.GOOGLE_CLIENT_SECRET_PROD) {
22 |             throw new Error('Missing GOOGLE_CLIENT_SECRET_PROD environment variable');
23 |         }
24 |         const config = {
25 |             clientId: process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID_PROD,
26 |             clientSecret: process.env.GOOGLE_CLIENT_SECRET_PROD,
27 |         };
28 |         console.log('🔐 Using PRODUCTION Google OAuth client:', config.clientId);
29 |         return config;
30 |     } else {
31 |         // Development/Preview OAuth app
32 |         if (!process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID_DEV) {
33 |             throw new Error('Missing NEXT_PUBLIC_GOOGLE_CLIENT_ID_DEV environment variable');
34 |         }
35 |         if (!process.env.GOOGLE_CLIENT_SECRET_DEV) {
36 |             throw new Error('Missing GOOGLE_CLIENT_SECRET_DEV environment variable');
37 |         }
38 |         const config = {
39 |             clientId: process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID_DEV,
40 |             clientSecret: process.env.GOOGLE_CLIENT_SECRET_DEV,
41 |         };
42 |         //console.log('🔐 Using DEVELOPMENT Google OAuth client:', config.clientId);
43 |         return config;
44 |     }
45 | };
46 | 
47 | if (!process.env.AUTH_SECRET) {
48 |     throw new Error('Missing AUTH_SECRET environment variable');
49 | }
50 | if (!process.env.POLAR_ACCESS_TOKEN) {
51 |     throw new Error('Missing POLAR_ACCESS_TOKEN environment variable');
52 | }
53 | if (!process.env.POLAR_PRODUCT_ID) {
54 |     throw new Error('Missing POLAR_PRODUCT_ID environment variable');
55 | }
56 | if (!process.env.SUCCESS_URL) {
57 |     throw new Error('Missing SUCCESS_URL environment variable');
58 | }
59 | 
60 | // Polar server environment configuration
61 | // Use POLAR_SERVER_ENV if explicitly set, otherwise default to sandbox for safety
62 | const polarServerEnv = process.env.POLAR_SERVER_ENV === "production" ? "production" : "sandbox";
63 | 
64 | const polarClient = new Polar({
65 |     accessToken: process.env.POLAR_ACCESS_TOKEN,
66 |     server: polarServerEnv,
67 | });
68 | 
69 | // Dynamic trusted origins based on environment
70 | const getTrustedOrigins = () => {
71 |     const origins = [
72 |         'http://localhost:3000',
73 |         'https://www.chatlima.com',
74 |         'https://preview.chatlima.com'
75 |     ];
76 | 
77 |     // Add Vercel preview URLs
78 |     if (process.env.VERCEL_URL) {
79 |         origins.push(`https://${process.env.VERCEL_URL}`);
80 |     }
81 | 
82 |     // Add any Vercel deployment URLs (for preview deployments)
83 |     if (process.env.VERCEL_PROJECT_PRODUCTION_URL) {
84 |         origins.push(`https://${process.env.VERCEL_PROJECT_PRODUCTION_URL}`);
85 |     }
86 | 
87 |     // Allow all *.vercel.app domains for previews
88 |     origins.push('https://*.vercel.app');
89 | 
90 |     // Add any custom preview domain if specified
91 |     if (process.env.PREVIEW_DOMAIN) {
92 |         origins.push(`https://${process.env.PREVIEW_DOMAIN}`);
93 |         origins.push(`https://*.${process.env.PREVIEW_DOMAIN}`);
94 |     }
95 | 
96 |     //console.log('🔐 Auth trusted origins configured:', origins);
97 | 
98 |     return origins;
99 | };
100 | 
101 | export const auth = betterAuth({
102 |     database: drizzleAdapter(db, {
103 |         provider: "pg",
104 |         // Explicitly pass the schema tables using the standard names
105 |         schema: {
106 |             user: schema.users,       // Use the exported const 'users'
107 |             account: schema.accounts, // Use the exported const 'accounts'
108 |             session: schema.sessions, // Use the exported const 'sessions'
109 |             verification: schema.verification // Updated from verificationTokens
110 |         },
111 |         // We might need to explicitly pass the schema tables here later
112 |         // schema: { ...schema } 
113 |         // Or potentially use this flag if table names are standard plurals
114 |         // usePlural: true
115 |     }),
116 |     secret: process.env.AUTH_SECRET,
117 |     sessionMaxAge: 30 * 24 * 60 * 60, // 30 days
118 |     // Add session field mapping based on documentation
119 |     session: {
120 |         fields: {
121 |             token: "sessionToken" // Map internal token to sessionToken column
122 |             // If your expires column was different, you'd map expiresAt here too
123 |         }
124 |     },
125 |     trustedOrigins: getTrustedOrigins(),
126 |     socialProviders: {
127 |         google: {
128 |             ...getGoogleOAuthConfig(),
129 |             // Set higher message limit for authenticated users
130 |             onAccountCreated: async ({ user }: { user: any }) => {
131 |                 const oauthConfig = getGoogleOAuthConfig();
132 |                 console.log('[Google Provider] onAccountCreated: Triggered for user', user.id, 'using client:', oauthConfig.clientId);
133 |                 // Update user metadata to add higher message limit
134 |                 await db.update(schema.users)
135 |                     .set({
136 |                         metadata: {
137 |                             ...user.metadata,
138 |                             messageLimit: 20 // 20 messages per day for Google signed-in users
139 |                         }
140 |                     })
141 |                     .where(eq(schema.users.id, user.id));
142 | 
143 |                 return user;
144 |             }
145 |         },
146 |     },
147 |     plugins: [
148 |         anonymous({
149 |             emailDomainName: "anonymous.chatlima.com", // Use a proper domain for anonymous users
150 |             onLinkAccount: async ({ anonymousUser, newUser }) => {
151 |                 console.log('--- Anonymous Plugin onLinkAccount Fired ---');
152 |                 console.log('Anonymous User:', JSON.stringify(anonymousUser, null, 2));
153 |                 console.log('New User:', JSON.stringify(newUser, null, 2));
154 | 
155 |                 console.log('Linking anonymous user to authenticated user', {
156 |                     anonymousId: anonymousUser.user?.id,
157 |                     newUserId: newUser.user?.id
158 |                 });
159 | 
160 |                 // ***** PRESET MIGRATION LOGIC *****
161 |                 if (anonymousUser.user?.id && newUser.user?.id) {
162 |                     console.log('[Preset Migration] Starting migration from anonymous user to authenticated user');
163 |                     try {
164 |                         // Import database utilities within the callback to avoid circular dependencies
165 |                         const { db } = await import('./db/index');
166 |                         const { presets } = await import('./db/schema');
167 |                         const { eq } = await import('drizzle-orm');
168 | 
169 |                         // Transfer all presets from anonymous user to authenticated user
170 |                         const migratedPresets = await db
171 |                             .update(presets)
172 |                             .set({ 
173 |                                 userId: newUser.user.id,
174 |                                 updatedAt: new Date()
175 |                             })
176 |                             .where(eq(presets.userId, anonymousUser.user.id))
177 |                             .returning();
178 | 
179 |                         console.log(`[Preset Migration] Successfully migrated ${migratedPresets.length} presets from anonymous user ${anonymousUser.user.id} to authenticated user ${newUser.user.id}`);
180 |                     } catch (error) {
181 |                         console.error('[Preset Migration] Failed to migrate presets:', error);
182 |                         // Non-critical error - user can recreate presets
183 |                     }
184 |                 } else {
185 |                     console.log('[Preset Migration] Skipping migration - missing user IDs');
186 |                 }
187 | 
188 |                 // ***** MOVED POLAR CUSTOMER CREATION LOGIC HERE *****
189 |                 const userForPolar = newUser.user; // Get the actual user object
190 | 
191 |                 // Ensure we have a valid user object and it's not anonymous
192 |                 // (though after linking, newUser.user should be the authenticated one)
193 |                 if (userForPolar && userForPolar.id && !userForPolar.isAnonymous) {
194 |                     console.log('[onLinkAccount] Processing Polar customer for authenticated user:', userForPolar.id, 'Email:', userForPolar.email);
195 |                     try {
196 |                         let polarCustomer;
197 |                         try {
198 |                             // Attempt to fetch customer by externalId (userForPolar.id from your app)
199 |                             polarCustomer = await polarClient.customers.getExternal({ externalId: userForPolar.id });
200 |                             console.log('[onLinkAccount] Found existing Polar customer by externalId:', polarCustomer.id, 'for user:', userForPolar.id);
201 | 
202 |                             // Optional: If found, ensure email matches or update if necessary
203 |                             if (polarCustomer.email !== userForPolar.email && userForPolar.email) {
204 |                                 console.log(`[onLinkAccount] Polar customer ${polarCustomer.id} has email ${polarCustomer.email}, app user has ${userForPolar.email}. Updating Polar customer's email.`);
205 |                                 await polarClient.customers.updateExternal({
206 |                                     externalId: userForPolar.id,
207 |                                     customerUpdateExternalID: { email: userForPolar.email, name: userForPolar.name }
208 |                                 });
209 |                                 console.log('[onLinkAccount] Polar customer email updated for externalId:', userForPolar.id);
210 |                             }
211 | 
212 |                         } catch (error: any) {
213 |                             if (error.name === 'ResourceNotFound' || error.statusCode === 404 || (error.response && error.response.status === 404)) {
214 |                                 console.log('[onLinkAccount] No Polar customer found with externalId:', userForPolar.id, '. Attempting to create.');
215 | 
216 |                                 try {
217 |                                     polarCustomer = await polarClient.customers.create({
218 |                                         email: userForPolar.email,
219 |                                         name: userForPolar.name,
220 |                                         externalId: userForPolar.id
221 |                                     });
222 |                                     console.log('[onLinkAccount] Polar customer created successfully:', polarCustomer.id, 'with externalId:', userForPolar.id);
223 |                                 } catch (createError: any) {
224 |                                     console.error('[onLinkAccount] Failed to create Polar customer for user:', userForPolar.id, '. Create Error:', createError);
225 |                                     if (createError.response && createError.response.data) {
226 |                                         console.error('[onLinkAccount] Polar API error details:', createError.response.data);
227 |                                     }
228 |                                 }
229 |                             } else {
230 |                                 console.error('[onLinkAccount] Error fetching Polar customer by externalId for user:', userForPolar.id, 'Fetch Error:', error);
231 |                                 if (error.response && error.response.data) {
232 |                                     console.error('[onLinkAccount] Polar API error details:', error.response.data);
233 |                                 }
234 |                             }
235 |                         }
236 |                     } catch (error) {
237 |                         console.error('[onLinkAccount] Unhandled error in Polar processing for user:', userForPolar.id, 'Error:', error);
238 |                     }
239 |                 } else {
240 |                     console.log('[onLinkAccount] Skipping Polar customer processing for user:', userForPolar?.id, 'isAnonymous:', userForPolar?.isAnonymous);
241 |                 }
242 |             },
243 |         }),
244 |         polarPlugin({
245 |             client: polarClient,
246 |             createCustomerOnSignUp: false,
247 |             // onAccountCreated: async ({ user }: { user: { id: string, email: string, name?: string, isAnonymous?: boolean } }) => {
248 |             //     console.log('[Polar Plugin] onAccountCreated: Triggered for user', user.id); // THIS WAS NOT FIRING
249 |             //     // ...  previous logic commented out as it's moved ...
250 |             //     return user;
251 |             // },
252 |             enableCustomerPortal: true,
253 |             checkout: {
254 |                 enabled: true,
255 |                 products: [
256 |                     {
257 |                         productId: process.env.POLAR_PRODUCT_ID || '',
258 |                         slug: 'ai-usage',
259 |                         // Remove name and description as they're not part of the expected type
260 |                     }
261 |                 ],
262 |                 successUrl: process.env.SUCCESS_URL,
263 |             },
264 |             webhooks: {
265 |                 secret: process.env.POLAR_WEBHOOK_SECRET || '', // Use empty string if not set yet
266 |                 onPayload: async (payload) => {
267 |                     console.log('Polar webhook received:', payload.type);
268 |                 },
269 |                 // Add specific event handlers
270 |                 onSubscriptionCreated: async (payload) => {
271 |                     console.log('Subscription created:', payload.data.id);
272 |                     // Credits will be managed by Polar meter
273 |                 },
274 |                 onOrderCreated: async (payload) => {
275 |                     console.log('Order created:', payload.data.id);
276 |                 },
277 |                 onSubscriptionCanceled: async (payload) => {
278 |                     console.log('Subscription canceled:', payload.data.id);
279 |                 },
280 |                 onSubscriptionRevoked: async (payload) => {
281 |                     console.log('Subscription revoked:', payload.data.id);
282 |                 }
283 |             },
284 |         }),
285 |     ],
286 |     // session: { ... } // Potentially configure session strategy if needed
287 | });
288 | 
289 | // Helper to check if user has reached their daily message or credit limit
290 | export async function checkMessageLimit(userId: string, isAnonymous: boolean): Promise<{
291 |     hasReachedLimit: boolean;
292 |     limit: number;
293 |     remaining: number;
294 |     credits?: number | null;
295 |     usedCredits?: boolean;
296 | }> {
297 |     try {
298 |         // 1. Check Polar credits (for authenticated users only)
299 |         if (!isAnonymous) {
300 |             const credits = await getRemainingCreditsByExternalId(userId);
301 |             if (typeof credits === 'number') {
302 |                 // If user has negative credits, block them
303 |                 if (credits < 0) {
304 |                     return {
305 |                         hasReachedLimit: true,
306 |                         limit: 0,
307 |                         remaining: 0,
308 |                         credits,
309 |                         usedCredits: true
310 |                     };
311 |                 }
312 |                 // If user has positive credits, allow usage and show credits left
313 |                 if (credits > 0) {
314 |                     return {
315 |                         hasReachedLimit: false,
316 |                         limit: 250, // Soft cap for display, actual limit is credits
317 |                         remaining: credits,
318 |                         credits,
319 |                         usedCredits: true
320 |                     };
321 |                 }
322 |                 // If credits === 0, fall through to daily message limit
323 |             }
324 |         }
325 | 
326 |         // 2. If no credits (or anonymous), use daily message limit
327 |         // Get user info
328 |         const user = await db.query.users.findFirst({
329 |             where: eq(schema.users.id, userId)
330 |         });
331 | 
332 |         // Set daily limits
333 |         let messageLimit = isAnonymous ? 10 : 20;
334 |         if (!isAnonymous && user) {
335 |             messageLimit = (user as any).metadata?.messageLimit || 20;
336 |         }
337 | 
338 |         // Count today's messages for this user
339 |         const startOfDay = new Date();
340 |         startOfDay.setHours(0, 0, 0, 0);
341 | 
342 |         const messageCount = await db.select({ count: count() })
343 |             .from(schema.messages)
344 |             .innerJoin(schema.chats, eq(schema.chats.id, schema.messages.chatId))
345 |             .where(
346 |                 and(
347 |                     eq(schema.chats.userId, userId),
348 |                     gte(schema.messages.createdAt, startOfDay),
349 |                     eq(schema.messages.role, 'user')
350 |                 )
351 |             )
352 |             .execute()
353 |             .then(result => result[0]?.count || 0);
354 | 
355 |         return {
356 |             hasReachedLimit: messageCount >= messageLimit,
357 |             limit: messageLimit,
358 |             remaining: Math.max(0, messageLimit - messageCount),
359 |             credits: 0,
360 |             usedCredits: false
361 |         };
362 |     } catch (error) {
363 |         console.error('Error checking message limit:', error);
364 |         // Default to allowing messages if there's an error
365 |         return { hasReachedLimit: false, limit: 10, remaining: 10 };
366 |     }
367 | }
```

lib/chat-store.ts
```
1 | import { db } from "./db";
2 | import { chats, messages, chatShares, type Chat, type ChatWithShareInfo, type Message, MessageRole, type MessagePart, type DBMessage } from "./db/schema";
3 | import { eq, desc, and, sql } from "drizzle-orm";
4 | import { nanoid } from "nanoid";
5 | import { generateTitle } from "@/app/actions";
6 | import type { TextUIPart, ToolInvocationUIPart, ImageUIPart, WebSearchCitation } from "./types";
7 | import type { ReasoningUIPart, SourceUIPart, FileUIPart, StepStartUIPart } from "@ai-sdk/ui-utils";
8 | 
9 | type AIMessage = {
10 |   role: string;
11 |   content: string | any[];
12 |   id?: string;
13 |   parts?: Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>;
14 |   hasWebSearch?: boolean;
15 |   webSearchContextSize?: 'low' | 'medium' | 'high';
16 | };
17 | 
18 | type UIMessage = {
19 |   id: string;
20 |   role: string;
21 |   content: string;
22 |   parts: Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>;
23 |   createdAt?: Date;
24 |   hasWebSearch?: boolean;
25 |   webSearchContextSize?: 'low' | 'medium' | 'high';
26 | };
27 | 
28 | type SaveChatParams = {
29 |   id?: string;
30 |   userId: string;
31 |   messages?: any[];
32 |   title?: string;
33 |   selectedModel?: string;
34 |   apiKeys?: Record<string, string>;
35 | };
36 | 
37 | type ChatWithMessages = Chat & {
38 |   messages: Message[];
39 | };
40 | 
41 | export async function saveMessages({
42 |   messages: dbMessages,
43 | }: {
44 |   messages: Array<DBMessage>;
45 | }) {
46 |   try {
47 |     if (dbMessages.length > 0) {
48 |       const chatId = dbMessages[0].chatId;
49 | 
50 |       // First delete any existing messages for this chat
51 |       await db
52 |         .delete(messages)
53 |         .where(eq(messages.chatId, chatId));
54 | 
55 |       // Then insert the new messages
56 |       return await db.insert(messages).values(dbMessages);
57 |     }
58 |     return null;
59 |   } catch (error) {
60 |     console.error('Failed to save messages in database', error);
61 |     throw error;
62 |   }
63 | }
64 | 
65 | // Function to convert AI messages to DB format
66 | export function convertToDBMessages(aiMessages: AIMessage[], chatId: string): DBMessage[] {
67 |   return aiMessages.map(msg => {
68 |     // Use existing id or generate a new one
69 |     const messageId = msg.id || nanoid();
70 | 
71 |     // If msg has parts, use them directly
72 |     if (msg.parts) {
73 |       return {
74 |         id: messageId,
75 |         chatId,
76 |         role: msg.role,
77 |         parts: msg.parts,
78 |         hasWebSearch: msg.hasWebSearch || false,
79 |         webSearchContextSize: msg.webSearchContextSize || 'medium',
80 |         createdAt: new Date()
81 |       };
82 |     }
83 | 
84 |     // Otherwise, convert content to parts
85 |     let parts: Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>;
86 | 
87 |     if (typeof msg.content === 'string') {
88 |       parts = [{ type: 'text', text: msg.content } as TextUIPart];
89 |     } else if (Array.isArray(msg.content)) {
90 |       if (msg.content.every(item => typeof item === 'object' && item !== null)) {
91 |         // Content is already in parts-like format
92 |         parts = msg.content as Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>;
93 |       } else {
94 |         // Content is an array but not in parts format
95 |         parts = [{ type: 'text', text: JSON.stringify(msg.content) } as TextUIPart];
96 |       }
97 |     } else {
98 |       // Default case
99 |       parts = [{ type: 'text', text: String(msg.content) } as TextUIPart];
100 |     }
101 | 
102 |     return {
103 |       id: messageId,
104 |       chatId,
105 |       role: msg.role,
106 |       parts,
107 |       hasWebSearch: msg.hasWebSearch || false,
108 |       webSearchContextSize: msg.webSearchContextSize || 'medium',
109 |       createdAt: new Date()
110 |     };
111 |   });
112 | }
113 | 
114 | // Convert DB messages to UI format
115 | export function convertToUIMessages(dbMessages: Array<Message>): Array<UIMessage> {
116 |   return dbMessages.map((message) => ({
117 |     id: message.id,
118 |     parts: message.parts as Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>,
119 |     role: message.role as string,
120 |     content: getTextContent(message), // For backward compatibility
121 |     createdAt: message.createdAt,
122 |     hasWebSearch: message.hasWebSearch || false,
123 |     webSearchContextSize: (message.webSearchContextSize || 'medium') as 'low' | 'medium' | 'high'
124 |   }));
125 | }
126 | 
127 | export async function saveChat({ id, userId, messages: aiMessages, title, selectedModel, apiKeys }: SaveChatParams) {
128 |   // Generate a new ID if one wasn't provided
129 |   const chatId = id || nanoid();
130 | 
131 |   // Check if chat already exists first
132 |   const existingChat = await db.query.chats.findFirst({
133 |     where: and(
134 |       eq(chats.id, chatId),
135 |       eq(chats.userId, userId)
136 |     ),
137 |   });
138 | 
139 |   // Check if title is provided, if not generate one
140 |   let chatTitle = title;
141 | 
142 |   // If chat exists and already has a meaningful title, keep it (unless explicitly overriding with title param)
143 |   if (existingChat && existingChat.title && existingChat.title !== 'New Chat' && !title) {
144 |     chatTitle = existingChat.title; // Keep the existing title
145 |   } else {
146 |     // Generate title if messages are provided and no title is specified
147 |     if (aiMessages && aiMessages.length > 0) {
148 |       const hasEnoughMessages = aiMessages.length >= 2 &&
149 |         aiMessages.some(m => m.role === 'user') &&
150 |         aiMessages.some(m => m.role === 'assistant');
151 | 
152 |       if (!chatTitle || chatTitle === 'New Chat' || chatTitle === undefined) {
153 |         if (hasEnoughMessages) {
154 |           try {
155 |             // Use AI to generate a meaningful title based on conversation
156 |             chatTitle = await generateTitle(aiMessages, selectedModel, apiKeys);
157 |           } catch (error) {
158 |             console.error('Error generating title:', error);
159 |             // Fallback to basic title extraction if AI title generation fails
160 |             const firstUserMessage = aiMessages.find(m => m.role === 'user');
161 |             if (firstUserMessage) {
162 |               // Check for parts first (new format)
163 |               if (firstUserMessage.parts && Array.isArray(firstUserMessage.parts)) {
164 |                 const textParts = firstUserMessage.parts.filter((p: MessagePart) => p.type === 'text' && p.text);
165 |                 if (textParts.length > 0) {
166 |                   chatTitle = textParts[0].text?.slice(0, 50) || 'New Chat';
167 |                   if ((textParts[0].text?.length || 0) > 50) {
168 |                     chatTitle += '...';
169 |                   }
170 |                 } else {
171 |                   chatTitle = 'New Chat';
172 |                 }
173 |               }
174 |               // Fallback to content (old format)
175 |               else if (typeof firstUserMessage.content === 'string') {
176 |                 chatTitle = firstUserMessage.content.slice(0, 50);
177 |                 if (firstUserMessage.content.length > 50) {
178 |                   chatTitle += '...';
179 |                 }
180 |               } else {
181 |                 chatTitle = 'New Chat';
182 |               }
183 |             } else {
184 |               chatTitle = 'New Chat';
185 |             }
186 |           }
187 |         } else {
188 |           // Not enough messages for AI title, use first message
189 |           const firstUserMessage = aiMessages.find(m => m.role === 'user');
190 |           if (firstUserMessage) {
191 |             // Check for parts first (new format)
192 |             if (firstUserMessage.parts && Array.isArray(firstUserMessage.parts)) {
193 |               const textParts = firstUserMessage.parts.filter((p: MessagePart) => p.type === 'text' && p.text);
194 |               if (textParts.length > 0) {
195 |                 chatTitle = textParts[0].text?.slice(0, 50) || 'New Chat';
196 |                 if ((textParts[0].text?.length || 0) > 50) {
197 |                   chatTitle += '...';
198 |                 }
199 |               } else {
200 |                 chatTitle = 'New Chat';
201 |               }
202 |             }
203 |             // Fallback to content (old format)
204 |             else if (typeof firstUserMessage.content === 'string') {
205 |               chatTitle = firstUserMessage.content.slice(0, 50);
206 |               if (firstUserMessage.content.length > 50) {
207 |                 chatTitle += '...';
208 |               }
209 |             } else {
210 |               chatTitle = 'New Chat';
211 |             }
212 |           } else {
213 |             chatTitle = 'New Chat';
214 |           }
215 |         }
216 |       }
217 |     } else {
218 |       chatTitle = chatTitle || 'New Chat';
219 |     }
220 |   }
221 | 
222 |   if (existingChat) {
223 |     // Update existing chat
224 |     await db
225 |       .update(chats)
226 |       .set({
227 |         title: chatTitle,
228 |         updatedAt: new Date()
229 |       })
230 |       .where(and(
231 |         eq(chats.id, chatId),
232 |         eq(chats.userId, userId)
233 |       ));
234 |   } else {
235 |     // Create new chat
236 |     await db.insert(chats).values({
237 |       id: chatId,
238 |       userId,
239 |       title: chatTitle,
240 |       createdAt: new Date(),
241 |       updatedAt: new Date()
242 |     });
243 |   }
244 | 
245 |   return { id: chatId };
246 | }
247 | 
248 | // Helper to get just the text content for display
249 | export function getTextContent(message: Message): string {
250 |   try {
251 |     const parts = message.parts as MessagePart[];
252 |     return parts
253 |       .filter(part => part.type === 'text' && part.text)
254 |       .map(part => part.text)
255 |       .join('\n');
256 |   } catch (e) {
257 |     // If parsing fails, return empty string
258 |     return '';
259 |   }
260 | }
261 | 
262 | export async function getChats(userId: string, limit = 50): Promise<ChatWithShareInfo[]> {
263 |   // Join with chatShares to get share information
264 |   const chatsWithShares = await db
265 |     .select({
266 |       id: chats.id,
267 |       userId: chats.userId,
268 |       title: chats.title,
269 |       createdAt: chats.createdAt,
270 |       updatedAt: chats.updatedAt,
271 |       shareId: chatShares.shareId,
272 |       sharePath: sql<string | null>`
273 |         CASE 
274 |           WHEN ${chatShares.status} = 'active' 
275 |           THEN '/chats/shared/' || ${chatShares.shareId}
276 |           ELSE NULL 
277 |         END
278 |       `.as('sharePath')
279 |     })
280 |     .from(chats)
281 |     .leftJoin(chatShares, and(
282 |       eq(chats.id, chatShares.chatId),
283 |       eq(chatShares.status, 'active')
284 |     ))
285 |     .where(eq(chats.userId, userId))
286 |     .orderBy(desc(chats.updatedAt))
287 |     .limit(limit);
288 | 
289 |   return chatsWithShares;
290 | }
291 | 
292 | export async function getChatById(id: string, userId: string): Promise<ChatWithMessages | null> {
293 |   const chat = await db.query.chats.findFirst({
294 |     where: and(
295 |       eq(chats.id, id),
296 |       eq(chats.userId, userId)
297 |     ),
298 |   });
299 | 
300 |   if (!chat) return null;
301 | 
302 |   const chatMessages = await db.query.messages.findMany({
303 |     where: eq(messages.chatId, id),
304 |     orderBy: [messages.createdAt]
305 |   });
306 | 
307 |   return {
308 |     ...chat,
309 |     messages: chatMessages
310 |   };
311 | }
312 | 
313 | export async function deleteChat(id: string, userId: string) {
314 |   await db.delete(chats).where(
315 |     and(
316 |       eq(chats.id, id),
317 |       eq(chats.userId, userId)
318 |     )
319 |   );
320 | }
321 | 
322 | // Helper functions for image processing
323 | export function processImageParts(parts: Array<TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart>) {
324 |   return parts.map(part => {
325 |     if (part.type === "image_url") {
326 |       // Validate base64 data URLs and add metadata if missing
327 |       if (part.image_url.url.startsWith('data:image/')) {
328 |         return part;
329 |       }
330 |       // Handle external URLs if needed
331 |       return part;
332 |     }
333 |     return part;
334 |   });
335 | }
336 | 
337 | export function hasImageAttachments(messages: UIMessage[]): boolean {
338 |   return messages.some(message =>
339 |     message.parts?.some(part => part.type === "image_url")
340 |   );
341 | } 
```

lib/constants.ts
```
1 | /**
2 |  * Constants used throughout the application
3 |  */
4 | 
5 | // Local storage keys
6 | export const STORAGE_KEYS = {
7 |   MCP_SERVERS: "mcpServers",
8 |   SELECTED_MCP_SERVERS: "selectedMcpServers",
9 |   SIDEBAR_STATE: "sidebarState",
10 |   WEB_SEARCH: "webSearch"
11 | } as const; 
```

lib/image-utils.ts
```
1 | import type { ImageMetadata } from './types';
2 | 
3 | interface ImageProcessingOptions {
4 |     maxSize: number;
5 |     allowedTypes: string[];
6 | }
7 | 
8 | export async function processImageFile(file: File): Promise<{
9 |     dataUrl: string;
10 |     metadata: ImageMetadata;
11 | }> {
12 |     console.log('[DEBUG] processImageFile called for:', {
13 |         filename: file.name,
14 |         size: file.size,
15 |         type: file.type
16 |     });
17 | 
18 |     // Determine if we need to compress/resize the image to stay under payload limits
19 |     // Vercel has a 4.5MB payload limit, so we target ~3MB for images after base64 encoding
20 |     const targetPayloadSize = 3 * 1024 * 1024; // 3MB in bytes
21 |     const estimatedBase64Size = (file.size * 4) / 3; // Base64 is ~33% larger than binary
22 | 
23 |     let processedFile = file;
24 | 
25 |     if (estimatedBase64Size > targetPayloadSize || file.size > 5 * 1024 * 1024) { // 5MB raw file size
26 |         console.log('[DEBUG] Image is large, compressing...', {
27 |             originalSize: file.size,
28 |             estimatedBase64Size,
29 |             targetPayloadSize
30 |         });
31 | 
32 |         // Progressive compression - try multiple passes if needed
33 |         const compressionAttempts = [
34 |             { maxWidth: 2048, maxHeight: 2048, quality: 0.85 },
35 |             { maxWidth: 1792, maxHeight: 1792, quality: 0.8 },
36 |             { maxWidth: 1536, maxHeight: 1536, quality: 0.75 },
37 |             { maxWidth: 1280, maxHeight: 1280, quality: 0.7 },
38 |             { maxWidth: 1024, maxHeight: 1024, quality: 0.65 },
39 |             { maxWidth: 800, maxHeight: 800, quality: 0.6 }
40 |         ];
41 | 
42 |         let currentFile = file;
43 |         let attemptIndex = 0;
44 | 
45 |         // Choose starting point based on file size
46 |         if (file.size > 15 * 1024 * 1024) { // > 15MB
47 |             attemptIndex = 2; // Start with 1536x1536 @ 75%
48 |         } else if (file.size > 10 * 1024 * 1024) { // > 10MB  
49 |             attemptIndex = 1; // Start with 1792x1792 @ 80%
50 |         }
51 | 
52 |         for (let i = attemptIndex; i < compressionAttempts.length; i++) {
53 |             const { maxWidth, maxHeight, quality } = compressionAttempts[i];
54 | 
55 |             try {
56 |                 const compressedFile = await resizeImageIfNeeded(currentFile, maxWidth, maxHeight, quality);
57 |                 const compressedDataUrl = await fileToDataUrl(compressedFile);
58 | 
59 |                 console.log(`[DEBUG] Compression attempt ${i + 1}:`, {
60 |                     settings: `${maxWidth}x${maxHeight} @ ${quality * 100}%`,
61 |                     originalSize: file.size,
62 |                     compressedSize: compressedFile.size,
63 |                     dataUrlLength: compressedDataUrl.length,
64 |                     compressionRatio: (compressedFile.size / file.size * 100).toFixed(1) + '%',
65 |                     underLimit: compressedDataUrl.length <= targetPayloadSize
66 |                 });
67 | 
68 |                 // If we're under the target size, use this version
69 |                 if (compressedDataUrl.length <= targetPayloadSize) {
70 |                     processedFile = compressedFile;
71 |                     console.log(`[SUCCESS] Image compressed successfully on attempt ${i + 1}`);
72 |                     break;
73 |                 } else {
74 |                     // Continue with the compressed file for the next attempt
75 |                     currentFile = compressedFile;
76 |                     processedFile = compressedFile; // Keep the best we have so far
77 |                 }
78 |             } catch (error) {
79 |                 console.warn(`[DEBUG] Compression attempt ${i + 1} failed:`, error);
80 |                 if (i === compressionAttempts.length - 1) {
81 |                     // Last attempt failed, use whatever we have
82 |                     console.warn('[DEBUG] All compression attempts failed, using best available');
83 |                 }
84 |             }
85 |         }
86 | 
87 |         console.log('[DEBUG] Final compression result:', {
88 |             originalSize: file.size,
89 |             finalSize: processedFile.size,
90 |             compressionRatio: (processedFile.size / file.size * 100).toFixed(1) + '%'
91 |         });
92 |     }
93 | 
94 |     // Extract metadata from processed file
95 |     console.log('[DEBUG] Extracting image metadata...');
96 |     const metadata = await extractImageMetadata(processedFile);
97 |     console.log('[DEBUG] Metadata extracted:', metadata);
98 | 
99 |     // Generate base64 data URL in AI SDK compatible format (used by OpenRouter and Requesty)
100 |     console.log('[DEBUG] Converting file to data URL...');
101 |     let dataUrl = await fileToDataUrl(processedFile);
102 |     console.log('[DEBUG] Data URL created, length:', dataUrl.length);
103 | 
104 |     // Final validation and emergency compression if still too large
105 |     if (dataUrl.length > targetPayloadSize) {
106 |         console.warn('[DEBUG] Data URL still too large after compression, attempting emergency compression:', {
107 |             dataUrlLength: dataUrl.length,
108 |             targetSize: targetPayloadSize
109 |         });
110 | 
111 |         // Emergency ultra-aggressive compression
112 |         try {
113 |             const emergencyFile = await resizeImageIfNeeded(processedFile, 640, 640, 0.5);
114 |             const emergencyDataUrl = await fileToDataUrl(emergencyFile);
115 | 
116 |             console.log('[DEBUG] Emergency compression result:', {
117 |                 originalDataUrlLength: dataUrl.length,
118 |                 emergencyDataUrlLength: emergencyDataUrl.length,
119 |                 underLimit: emergencyDataUrl.length <= targetPayloadSize
120 |             });
121 | 
122 |             if (emergencyDataUrl.length <= targetPayloadSize) {
123 |                 processedFile = emergencyFile;
124 |                 dataUrl = emergencyDataUrl;
125 |                 console.log('[SUCCESS] Emergency compression successful');
126 |             } else {
127 |                 console.error('[ERROR] Even emergency compression failed - image may be too complex or large');
128 |             }
129 |         } catch (error) {
130 |             console.error('[ERROR] Emergency compression failed:', error);
131 |         }
132 |     }
133 | 
134 |     const result = {
135 |         dataUrl,
136 |         metadata: {
137 |             ...metadata,
138 |             originalSize: file.size, // Keep track of original size
139 |             compressedSize: processedFile.size
140 |         }
141 |     };
142 | 
143 |     console.log('[DEBUG] processImageFile complete for:', file.name);
144 |     return result;
145 | }
146 | 
147 | export function validateImageFile(file: File, options: ImageProcessingOptions = {
148 |     maxSize: 20 * 1024 * 1024, // 20MB (compatible with most AI providers)
149 |     allowedTypes: ['image/jpeg', 'image/png', 'image/webp'] // Standard formats supported by most AI providers
150 | }): { valid: boolean; error?: string } {
151 |     // Check file size
152 |     if (file.size > options.maxSize) {
153 |         return {
154 |             valid: false,
155 |             error: `File size (${formatFileSize(file.size)}) exceeds maximum allowed size (${formatFileSize(options.maxSize)})`
156 |         };
157 |     }
158 | 
159 |     // Check MIME type
160 |     if (!options.allowedTypes.includes(file.type)) {
161 |         return {
162 |             valid: false,
163 |             error: `File type '${file.type}' is not supported. Supported types: ${options.allowedTypes.join(', ')}`
164 |         };
165 |     }
166 | 
167 |     // Additional security checks
168 |     if (!file.name || file.name.trim() === '') {
169 |         return {
170 |             valid: false,
171 |             error: 'File must have a valid name'
172 |         };
173 |     }
174 | 
175 |     return { valid: true };
176 | }
177 | 
178 | export async function getImageDimensions(file: File): Promise<{
179 |     width: number;
180 |     height: number;
181 | }> {
182 |     return new Promise((resolve, reject) => {
183 |         const img = new Image();
184 |         const url = URL.createObjectURL(file);
185 | 
186 |         img.onload = () => {
187 |             URL.revokeObjectURL(url);
188 |             resolve({
189 |                 width: img.naturalWidth,
190 |                 height: img.naturalHeight
191 |             });
192 |         };
193 | 
194 |         img.onerror = () => {
195 |             URL.revokeObjectURL(url);
196 |             reject(new Error('Failed to load image'));
197 |         };
198 | 
199 |         img.src = url;
200 |     });
201 | }
202 | 
203 | async function extractImageMetadata(file: File): Promise<ImageMetadata> {
204 |     try {
205 |         const dimensions = await getImageDimensions(file);
206 | 
207 |         return {
208 |             filename: file.name,
209 |             size: file.size,
210 |             mimeType: file.type,
211 |             width: dimensions.width,
212 |             height: dimensions.height
213 |         };
214 |     } catch (error) {
215 |         // Fallback metadata if dimension extraction fails
216 |         return {
217 |             filename: file.name,
218 |             size: file.size,
219 |             mimeType: file.type,
220 |             width: 0,
221 |             height: 0
222 |         };
223 |     }
224 | }
225 | 
226 | async function fileToDataUrl(file: File): Promise<string> {
227 |     return new Promise((resolve, reject) => {
228 |         const reader = new FileReader();
229 | 
230 |         reader.onload = () => {
231 |             if (typeof reader.result === 'string') {
232 |                 resolve(reader.result);
233 |             } else {
234 |                 reject(new Error('Failed to convert file to data URL'));
235 |             }
236 |         };
237 | 
238 |         reader.onerror = () => {
239 |             reject(new Error('Error reading file'));
240 |         };
241 | 
242 |         reader.readAsDataURL(file);
243 |     });
244 | }
245 | 
246 | export function formatFileSize(bytes: number): string {
247 |     if (bytes === 0) return '0 Bytes';
248 | 
249 |     const k = 1024;
250 |     const sizes = ['Bytes', 'KB', 'MB', 'GB'];
251 |     const i = Math.floor(Math.log(bytes) / Math.log(k));
252 | 
253 |     return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
254 | }
255 | 
256 | export function validateDataUrl(dataUrl: string): { valid: boolean; error?: string } {
257 |     // Validate base64 data URL format: data:image/{type};base64,{data}
258 |     if (!dataUrl.startsWith('data:image/')) {
259 |         return { valid: false, error: 'Invalid data URL format - must start with data:image/' };
260 |     }
261 | 
262 |     // Check for supported formats (standard formats supported by most AI providers)
263 |     const validTypes = ['data:image/jpeg', 'data:image/png', 'data:image/webp'];
264 |     if (!validTypes.some(type => dataUrl.startsWith(type))) {
265 |         return { valid: false, error: 'Unsupported image format. Use JPEG, PNG, or WebP' };
266 |     }
267 | 
268 |     // Check if it's properly base64 encoded
269 |     if (!dataUrl.includes(';base64,')) {
270 |         return { valid: false, error: 'Data URL must be base64 encoded' };
271 |     }
272 | 
273 |     // Estimate file size from base64 (rough calculation)
274 |     const base64Data = dataUrl.split(',')[1];
275 |     const estimatedSize = (base64Data.length * 3) / 4; // Base64 is ~33% larger than original
276 | 
277 |     if (estimatedSize > 20 * 1024 * 1024) { // 20MB limit (compatible with most AI providers)
278 |         return { valid: false, error: 'Image data too large (exceeds 20MB limit)' };
279 |     }
280 | 
281 |     return { valid: true };
282 | }
283 | 
284 | export function resizeImageIfNeeded(file: File, maxWidth: number = 2048, maxHeight: number = 2048, quality: number = 0.9): Promise<File> {
285 |     return new Promise((resolve) => {
286 |         const canvas = document.createElement('canvas');
287 |         const ctx = canvas.getContext('2d');
288 |         const img = new Image();
289 | 
290 |         img.onload = () => {
291 |             const { width, height } = img;
292 | 
293 |             // Calculate new dimensions while maintaining aspect ratio
294 |             let newWidth = width;
295 |             let newHeight = height;
296 | 
297 |             if (width > maxWidth || height > maxHeight) {
298 |                 const aspectRatio = width / height;
299 | 
300 |                 if (width > height) {
301 |                     newWidth = maxWidth;
302 |                     newHeight = maxWidth / aspectRatio;
303 |                 } else {
304 |                     newHeight = maxHeight;
305 |                     newWidth = maxHeight * aspectRatio;
306 |                 }
307 |             }
308 | 
309 |             // Always process the image to apply quality compression, even if dimensions don't change
310 |             // This is crucial for reducing file size when dealing with large images
311 |             canvas.width = newWidth;
312 |             canvas.height = newHeight;
313 | 
314 |             ctx?.drawImage(img, 0, 0, newWidth, newHeight);
315 | 
316 |             // Use JPEG for better compression, unless it's already WebP
317 |             const outputFormat = file.type === 'image/webp' ? 'image/webp' : 'image/jpeg';
318 |             const outputExtension = outputFormat === 'image/webp' ? '.webp' : '.jpg';
319 |             const originalName = file.name.replace(/\.[^/.]+$/, ""); // Remove extension
320 |             const outputName = originalName + outputExtension;
321 | 
322 |             canvas.toBlob(
323 |                 (blob) => {
324 |                     if (blob) {
325 |                         const resizedFile = new File([blob], outputName, {
326 |                             type: outputFormat,
327 |                             lastModified: Date.now()
328 |                         });
329 |                         resolve(resizedFile);
330 |                     } else {
331 |                         resolve(file); // Fallback to original if resize fails
332 |                     }
333 |                 },
334 |                 outputFormat,
335 |                 quality
336 |             );
337 |         };
338 | 
339 |         img.onerror = () => {
340 |             resolve(file); // Fallback to original if image load fails
341 |         };
342 | 
343 |         img.src = URL.createObjectURL(file);
344 |     });
345 | } 
```

lib/openrouter-utils.ts
```
1 | import type { UIMessage } from "ai";
2 | import type { ImageUIPart, TextUIPart } from "./types";
3 | 
4 | interface StandardImageContent {
5 |     type: "image";
6 |     /**
7 |      * The image data or URL. For data URLs, the format should be
8 |      * `data:image/{jpeg|png|webp};base64,<BASE64_DATA>`.
9 |      * This structure matches the AI SDK `ImagePart` definition, which
10 |      * is required for validation before the request is sent to the
11 |      * provider. The provider (e.g. OpenRouter, Requesty) will later transform
12 |      * this into the provider-specific schema if needed.
13 |      */
14 |     image: string | URL;
15 |     /**
16 |      * Optional mime type – inferred from the data URL if available.
17 |      */
18 |     mimeType?: string;
19 | }
20 | 
21 | interface StandardTextContent {
22 |     type: "text";
23 |     text: string;
24 | }
25 | 
26 | type StandardMessageContent = StandardTextContent | StandardImageContent;
27 | 
28 | // Legacy type aliases for backward compatibility
29 | type OpenRouterImageContent = StandardImageContent;
30 | type OpenRouterTextContent = StandardTextContent;
31 | type OpenRouterMessageContent = StandardMessageContent;
32 | 
33 | export function convertToOpenRouterFormat(messages: UIMessage[]): any[] {
34 |     return messages.map(message => {
35 |         if (message.role === "user" && message.parts) {
36 |             // Convert parts to AI SDK standard content format (used by OpenRouter and Requesty)
37 |             const content: StandardMessageContent[] = [];
38 | 
39 |             (message.parts as any[]).forEach(part => {
40 |                 switch (part.type) {
41 |                     case "text": {
42 |                         const textPart = part as TextUIPart;
43 |                         content.push({
44 |                             type: "text",
45 |                             text: textPart.text,
46 |                         });
47 |                         break;
48 |                     }
49 |                     case "image_url": {
50 |                         const imagePart = part as ImageUIPart;
51 | 
52 |                         // Attempt to infer MIME type from the data URL – useful for providers that inspect this field.
53 |                         let mimeType: string | undefined;
54 |                         const match = imagePart.image_url.url.match(/^data:(image\/[^;]+);base64,/);
55 |                         if (match) {
56 |                             mimeType = match[1];
57 |                         }
58 | 
59 |                         content.push({
60 |                             type: "image",
61 |                             image: imagePart.image_url.url,
62 |                             ...(mimeType ? { mimeType } : {}),
63 |                         });
64 |                         break;
65 |                     }
66 |                     default:
67 |                         // Skip unsupported part types
68 |                         break;
69 |                 }
70 |             });
71 | 
72 |             return {
73 |                 role: message.role,
74 |                 content: content
75 |             };
76 |         }
77 | 
78 |         // Handle non-multimodal messages (plain text)
79 |         return {
80 |             role: message.role,
81 |             content: getTextContent(message)
82 |         };
83 |     });
84 | }
85 | 
86 | export function validateImageForOpenRouter(imageData: string): {
87 |     valid: boolean;
88 |     error?: string;
89 | } {
90 |     // Validate base64 data URL format: data:image/{type};base64,{data}
91 |     if (!imageData.startsWith('data:image/')) {
92 |         return { valid: false, error: 'Invalid data URL format - must start with data:image/' };
93 |     }
94 | 
95 |     // Check for supported formats (OpenRouter limitation)
96 |     const validTypes = ['data:image/jpeg', 'data:image/png', 'data:image/webp'];
97 |     if (!validTypes.some(type => imageData.startsWith(type))) {
98 |         return { valid: false, error: 'Unsupported image format. OpenRouter supports JPEG, PNG, and WebP only' };
99 |     }
100 | 
101 |     // Check if it's properly base64 encoded
102 |     if (!imageData.includes(';base64,')) {
103 |         return { valid: false, error: 'Data URL must be base64 encoded' };
104 |     }
105 | 
106 |     // Estimate file size from base64 (rough calculation)
107 |     const base64Data = imageData.split(',')[1];
108 |     if (!base64Data) {
109 |         return { valid: false, error: 'Invalid base64 data' };
110 |     }
111 | 
112 |     const estimatedSize = (base64Data.length * 3) / 4; // Base64 is ~33% larger than original
113 | 
114 |     if (estimatedSize > 20 * 1024 * 1024) { // 20MB limit for OpenRouter
115 |         return { valid: false, error: 'Image data too large (exceeds 20MB limit for OpenRouter)' };
116 |     }
117 | 
118 |     return { valid: true };
119 | }
120 | 
121 | export function estimateImageTokens(
122 |     modelId: string,
123 |     imageCount: number,
124 |     detail: "low" | "high" | "auto" = "auto"
125 | ): number {
126 |     // Token estimates for image processing
127 |     const tokenCosts = {
128 |         low: 85,    // tokens per image at low detail
129 |         high: 170,  // tokens per image at high detail
130 |         auto: 85    // default - model chooses, usually "low" unless needed
131 |     };
132 | 
133 |     return imageCount * (tokenCosts[detail] || tokenCosts.auto);
134 | }
135 | 
136 | // Helper function to get text content from message parts
137 | function getTextContent(message: UIMessage): string {
138 |     if (message.parts) {
139 |         return message.parts
140 |             .filter(part => part.type === 'text')
141 |             .map(part => (part as TextUIPart).text)
142 |             .join('\n\n');
143 |     }
144 | 
145 |     return message.content || '';
146 | }
147 | 
148 | // Helper function to check if message contains images
149 | export function hasImageContent(message: UIMessage): boolean {
150 |     if (!message.parts) return false;
151 | 
152 |     return (message.parts as any[]).some(part => part.type === 'image_url');
153 | }
154 | 
155 | // Helper function to count images in a message
156 | export function countImages(message: UIMessage): number {
157 |     if (!message.parts) return 0;
158 | 
159 |     return (message.parts as any[]).filter(part => part.type === 'image_url').length;
160 | }
161 | 
162 | // Validate all images in a message array
163 | export function validateAllImages(messages: UIMessage[]): {
164 |     valid: boolean;
165 |     errors: string[];
166 | } {
167 |     const errors: string[] = [];
168 | 
169 |     messages.forEach((message, messageIndex) => {
170 |         if (message.parts) {
171 |             (message.parts as any[]).forEach((part, partIndex) => {
172 |                 if (part.type === 'image_url') {
173 |                     const imagePart = part as ImageUIPart;
174 |                     const validation = validateImageForOpenRouter(imagePart.image_url.url);
175 |                     if (!validation.valid) {
176 |                         errors.push(`Message ${messageIndex + 1}, Image ${partIndex + 1}: ${validation.error}`);
177 |                     }
178 |                 }
179 |             });
180 |         }
181 |     });
182 | 
183 |     return {
184 |         valid: errors.length === 0,
185 |         errors
186 |     };
187 | }
188 | 
189 | // Convert message parts to standard AI SDK format (used by OpenRouter and Requesty)
190 | export function convertMessagePartsToOpenRouter(parts: any[]): StandardMessageContent[] {
191 |     const content: StandardMessageContent[] = [];
192 | 
193 |     parts.forEach(part => {
194 |         switch (part.type) {
195 |             case "text":
196 |                 content.push({
197 |                     type: "text",
198 |                     text: part.text,
199 |                 });
200 |                 break;
201 |             case "image_url": {
202 |                 // Convert to the AI SDK compatible ImagePart structure
203 |                 let mimeType: string | undefined;
204 |                 const match = part.image_url.url.match(/^data:(image\/[^;]+);base64,/);
205 |                 if (match) {
206 |                     mimeType = match[1];
207 |                 }
208 |                 content.push({
209 |                     type: "image",
210 |                     image: part.image_url.url,
211 |                     ...(mimeType ? { mimeType } : {}),
212 |                 });
213 |                 break;
214 |             }
215 |             // Skip other part types that OpenRouter doesn't support
216 |             default:
217 |                 break;
218 |         }
219 |     });
220 | 
221 |     return content;
222 | } 
```

lib/parameter-validation.ts
```
1 | // Parameter validation utilities for presets
2 | import { type modelID } from "@/ai/providers";
3 | import { ModelInfo } from "@/lib/types/models";
4 | 
5 | export interface ValidationResult {
6 |   valid: boolean;
7 |   errors: string[];
8 | }
9 | 
10 | export interface ParameterConstraints {
11 |   temperature: { min: number; max: number; default: number };
12 |   maxTokens: { min: number; max: number; default: number };
13 |   supportsSystemInstruction: boolean;
14 |   maxSystemInstructionLength: number;
15 | }
16 | 
17 | // Default constraints for models that don't have specific constraints defined
18 | const DEFAULT_CONSTRAINTS: ParameterConstraints = {
19 |   temperature: { min: 0, max: 2, default: 1 },
20 |   maxTokens: { min: 1, max: 4096, default: 4096 },
21 |   supportsSystemInstruction: true,
22 |   maxSystemInstructionLength: 4000
23 | };
24 | 
25 | /**
26 |  * Get parameter constraints for a specific model
27 |  */
28 | export function getModelParameterConstraints(modelInfo: ModelInfo | null): ParameterConstraints {
29 |   if (!modelInfo) {
30 |     console.warn(`Model info not provided, using default constraints`);
31 |     return DEFAULT_CONSTRAINTS;
32 |   }
33 | 
34 |   return {
35 |     temperature: modelInfo.temperatureRange || DEFAULT_CONSTRAINTS.temperature,
36 |     maxTokens: modelInfo.maxTokensRange || DEFAULT_CONSTRAINTS.maxTokens,
37 |     supportsSystemInstruction: modelInfo.supportsSystemInstruction !== false,
38 |     maxSystemInstructionLength: modelInfo.maxSystemInstructionLength || DEFAULT_CONSTRAINTS.maxSystemInstructionLength
39 |   };
40 | }
41 | 
42 | /**
43 |  * Validate preset parameters for a specific model
44 |  */
45 | export function validatePresetParameters(
46 |   modelInfo: ModelInfo | null,
47 |   temperature?: number,
48 |   maxTokens?: number,
49 |   systemInstruction?: string
50 | ): ValidationResult {
51 |   const constraints = getModelParameterConstraints(modelInfo);
52 |   const errors: string[] = [];
53 | 
54 |   // Validate temperature
55 |   if (temperature !== undefined) {
56 |     if (typeof temperature !== 'number' || isNaN(temperature)) {
57 |       errors.push('Temperature must be a valid number');
58 |     } else if (temperature < constraints.temperature.min || temperature > constraints.temperature.max) {
59 |       errors.push(`Temperature must be between ${constraints.temperature.min} and ${constraints.temperature.max}`);
60 |     }
61 |   }
62 | 
63 |   // Validate max tokens
64 |   if (maxTokens !== undefined) {
65 |     if (!Number.isInteger(maxTokens) || maxTokens < 1) {
66 |       errors.push('Max tokens must be a positive integer');
67 |     } else if (maxTokens < constraints.maxTokens.min || maxTokens > constraints.maxTokens.max) {
68 |       errors.push(`Max tokens must be between ${constraints.maxTokens.min} and ${constraints.maxTokens.max}`);
69 |     }
70 |   }
71 | 
72 |   // Validate system instruction
73 |   if (systemInstruction !== undefined) {
74 |     const instructionValidation = validateSystemInstruction(systemInstruction, modelInfo);
75 |     if (!instructionValidation.valid) {
76 |       errors.push(...instructionValidation.errors);
77 |     }
78 |   }
79 | 
80 |   return { valid: errors.length === 0, errors };
81 | }
82 | 
83 | /**
84 |  * Validate system instruction content and security
85 |  */
86 | export function validateSystemInstruction(instruction: string, modelInfo: ModelInfo | null): ValidationResult {
87 |   const errors: string[] = [];
88 |   const constraints = getModelParameterConstraints(modelInfo);
89 | 
90 |   // Length validation
91 |   if (instruction.length > constraints.maxSystemInstructionLength) {
92 |     errors.push(`System instruction too long (max ${constraints.maxSystemInstructionLength} characters)`);
93 |   }
94 | 
95 |   if (instruction.length < 10) {
96 |     errors.push('System instruction must be at least 10 characters');
97 |   }
98 | 
99 |   // Content validation - check for prompt injection risks
100 |   if (containsPromptInjectionRisk(instruction)) {
101 |     errors.push('System instruction contains potentially unsafe content');
102 |   }
103 | 
104 |   // Character validation (prevent control characters)
105 |   if (/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/.test(instruction)) {
106 |     errors.push('System instruction contains invalid characters');
107 |   }
108 | 
109 |   return { valid: errors.length === 0, errors };
110 | }
111 | 
112 | /**
113 |  * Check for basic prompt injection patterns
114 |  */
115 | export function containsPromptInjectionRisk(text: string): boolean {
116 |   // Basic prompt injection patterns
117 |   const riskyPatterns = [
118 |     /ignore\s+(?:previous|above|earlier)\s+instructions?/i,
119 |     /forget\s+(?:everything|all)\s+(?:previous|above|earlier)/i,
120 |     /new\s+instructions?:/i,
121 |     /system\s*:\s*you\s+are\s+now/i,
122 |     /override\s+(?:previous|above|earlier)\s+instructions?/i,
123 |     /\[INST\]|\[\/INST\]/i, // Common instruction markers
124 |     /<\s*system\s*>/i, // System tags
125 |     /assistant\s*:\s*i\s+(?:am|will)\s+now/i, // Assistant hijacking
126 |   ];
127 | 
128 |   return riskyPatterns.some(pattern => pattern.test(text));
129 | }
130 | 
131 | /**
132 |  * Validate model access for user (premium models, etc.)
133 |  */
134 | export function validateModelAccess(modelInfo: ModelInfo | null, userCanAccessPremium: boolean): ValidationResult {
135 |   if (!modelInfo || !modelInfo.enabled) {
136 |     return { valid: false, errors: ['Model not available'] };
137 |   }
138 | 
139 |   if (modelInfo.premium && !userCanAccessPremium) {
140 |     return { valid: false, errors: ['Premium model requires credits or subscription'] };
141 |   }
142 | 
143 |   return { valid: true, errors: [] };
144 | }
145 | 
146 | /**
147 |  * Get default parameter values for a model
148 |  */
149 | export function getModelDefaults(modelInfo: ModelInfo | null): {
150 |   temperature: number;
151 |   maxTokens: number;
152 |   systemInstruction: string;
153 | } {
154 |   const constraints = getModelParameterConstraints(modelInfo);
155 | 
156 |   return {
157 |     temperature: constraints.temperature.default,
158 |     maxTokens: constraints.maxTokens.default,
159 |     systemInstruction: `You are a helpful AI assistant. Today's date is ${new Date().toISOString().split('T')[0]}.`
160 |   };
161 | }
162 | 
163 | /**
164 |  * Sanitize system instruction to remove potential security risks
165 |  */
166 | export function sanitizeSystemInstruction(instruction: string): string {
167 |   // Remove potential control characters
168 |   let sanitized = instruction.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
169 | 
170 |   // Trim excessive whitespace
171 |   sanitized = sanitized.trim().replace(/\s+/g, ' ');
172 | 
173 |   return sanitized;
174 | }
```

lib/polar.ts
```
1 | import { db } from './db';
2 | import { polarUsageEvents } from './db/schema';
3 | import { Polar } from '@polar-sh/sdk';
4 | import { nanoid } from 'nanoid';
5 | 
6 | // Polar server environment configuration
7 | // Use POLAR_SERVER_ENV if explicitly set, otherwise default to sandbox for safety
8 | const polarServerEnv = process.env.POLAR_SERVER_ENV === "production" ? "production" : "sandbox";
9 | 
10 | // Initialize Polar SDK client
11 | const polarClient = new Polar({
12 |     accessToken: process.env.POLAR_ACCESS_TOKEN as string,
13 |     server: polarServerEnv,
14 | });
15 | 
16 | /**
17 |  * Reports AI usage to Polar and logs it in the local database
18 |  * 
19 |  * @param userId The ID of the user in your local database
20 |  * @param tokenCount The number of completion tokens consumed
21 |  * @param polarCustomerId Optional - The customer's ID in the Polar system (deprecated, will be replaced by external_id)
22 |  * @param additionalProperties Optional - Any additional properties to include in the event payload
23 |  * @returns A promise that resolves when both the Polar API call and DB insertion are complete
24 |  */
25 | export async function reportAIUsage(
26 |     userId: string,
27 |     creditsToConsume: number, // Use the actual credits to consume, not hardcoded 1
28 |     polarCustomerId?: string,
29 |     additionalProperties: Record<string, any> = {}
30 | ) {
31 |     const eventName = 'message.processed'; // Changed from 'ai-usage'
32 |     const eventPayload = {
33 |         credits_consumed: creditsToConsume, // Use the actual credits passed in
34 |         ...additionalProperties
35 |     };
36 | 
37 |     try {
38 |         // 1. Try to get the customer by external ID first (using userId as external ID)
39 |         let customerId = polarCustomerId;
40 | 
41 |         if (!customerId) {
42 |             try {
43 |                 const customer = await getCustomerByExternalId(userId);
44 |                 if (customer) {
45 |                     customerId = customer.id;
46 |                 }
47 |             } catch (externalIdError) {
48 |                 console.warn(`Could not find Polar customer with external ID ${userId}:`, externalIdError);
49 |                 // Continue with regular flow, we'll try the map or just log locally
50 |             }
51 |         }
52 | 
53 |         // 2. Report to Polar (if we have a customer ID)
54 |         if (customerId) {
55 |             await polarClient.events.ingest({
56 |                 events: [
57 |                     {
58 |                         name: eventName,
59 |                         customerId: customerId,
60 |                         metadata: eventPayload
61 |                     }
62 |                 ]
63 |             });
64 |         }
65 | 
66 |         // 3. Log the event in our database regardless
67 |         try {
68 |             await db.insert(polarUsageEvents).values({
69 |                 id: nanoid(),
70 |                 userId,
71 |                 polarCustomerId: customerId, // Use the potentially found customerId from external ID
72 |                 eventName,
73 |                 eventPayload,
74 |                 createdAt: new Date()
75 |             });
76 |         } catch (dbError: any) {
77 |             // Check for foreign key constraint violation
78 |             if (dbError.code === '23503' && dbError.constraint?.includes('user_id')) {
79 |                 console.warn(`User ${userId} not found in database. Skipping usage tracking in DB.`);
80 |                 // Still return success since we reported to Polar if applicable
81 |                 return { success: true, userExistsInDB: false };
82 |             }
83 |             // Rethrow other database errors
84 |             throw dbError;
85 |         }
86 | 
87 |         return { success: true, userExistsInDB: true };
88 |     } catch (error) {
89 |         console.error('Error reporting AI usage to Polar:', error);
90 |         throw error;
91 |     }
92 | }
93 | 
94 | /**
95 |  * Gets a user's remaining credits from Polar using their external ID (app user ID)
96 |  * 
97 |  * @param userId The user's ID in our application (used as external ID in Polar)
98 |  * @returns A promise that resolves to the number of credits remaining, or null if there was an error
99 |  */
100 | export async function getRemainingCreditsByExternalId(userId: string): Promise<number | null> {
101 |     try {
102 |         //console.log(`[DEBUG] Attempting to get credits for external ID: ${userId}`);
103 | 
104 |         // First try to get the customer state by external ID
105 |         const customerState = await polarClient.customers.getStateExternal({
106 |             externalId: userId
107 |         });
108 | 
109 |         //console.log(`[DEBUG] Customer state response:`, JSON.stringify(customerState, null, 2));
110 | 
111 |         if (!customerState) {
112 |             //console.log(`[DEBUG] No customer state found for external ID: ${userId}`);
113 |             return null;
114 |         }
115 | 
116 |         // Look for AI usage meter in the customer state
117 |         // The meter data is in activeMeters, not meters
118 |         const activeMeters = (customerState as any).activeMeters || [];
119 |         //console.log(`[DEBUG] Found ${activeMeters.length} active meters for user ${userId}`);
120 | 
121 |         // Search for the correct "Message Credits Used" meter among active meters
122 |         for (const meter of activeMeters) {
123 |             //console.log(`[DEBUG] Active meter:`, JSON.stringify(meter, null, 2));
124 | 
125 |             // Try to get the full meter details to check the name
126 |             if (meter.meterId) {
127 |                 try {
128 |                     const meterDetails = await polarClient.meters.get({
129 |                         id: meter.meterId
130 |                     });
131 |                     //console.log(`[DEBUG] Meter details for ${meter.meterId}:`, JSON.stringify(meterDetails, null, 2));
132 | 
133 |                     if (meterDetails?.name === 'Message Credits Used') {
134 |                         const balance = meter.balance || 0;
135 |                         //console.log(`[DEBUG] Found 'Message Credits Used' active meter with balance: ${balance}`);
136 |                         return balance;
137 |                     }
138 |                 } catch (meterError) {
139 |                     //console.warn(`[DEBUG] Failed to get meter details for ${meter.meterId}:`, meterError);
140 |                 }
141 |             }
142 | 
143 |             // Fallback: check if the meter object has the nested structure
144 |             if (meter?.meter?.name === 'Message Credits Used') {
145 |                 const balance = meter.balance || 0;
146 |                 //console.log(`[DEBUG] Found 'Message Credits Used' active meter with balance: ${balance}`);
147 |                 return balance;
148 |             }
149 |         }
150 | 
151 |         // Fallback: also check the legacy meters array (just in case)
152 |         const meters = (customerState as any).meters || [];
153 |         //console.log(`[DEBUG] Found ${meters.length} legacy meters for user ${userId}`);
154 | 
155 |         for (const meter of meters) {
156 |             //console.log(`[DEBUG] Legacy Meter:`, JSON.stringify(meter, null, 2));
157 |             if (meter?.meter?.name === 'Message Credits Used') {
158 |                 const balance = meter.balance || 0;
159 |                 //console.log(`[DEBUG] Found 'Message Credits Used' meter with balance: ${balance}`);
160 |                 return balance;
161 |             }
162 |         }
163 | 
164 |         //console.log(`[DEBUG] No active meters or legacy 'Message Credits Used' meter found`);
165 |         return null;
166 |     } catch (error) {
167 |         console.error(`Error getting credits for external ID ${userId}:`, error);
168 |         return null;
169 |     }
170 | }
171 | 
172 | /**
173 |  * Gets a user's remaining credits from Polar
174 |  * 
175 |  * @param polarCustomerId The customer's ID in the Polar system
176 |  * @returns A promise that resolves to the number of credits remaining, or null if there was an error
177 |  */
178 | export async function getRemainingCredits(polarCustomerId: string): Promise<number | null> {
179 |     try {
180 |         // Get the customer meters response - use 'any' to bypass type checking
181 |         // since the Polar SDK types may vary by version
182 |         const response: any = await polarClient.customerMeters.list({
183 |             customerId: polarCustomerId
184 |         });
185 | 
186 |         // Try to handle both paginated and non-paginated responses safely
187 |         const processResult = async (data: any): Promise<number | null> => {
188 |             // Check if data contains meters directly
189 |             if (Array.isArray(data)) {
190 |                 for (const meter of data) {
191 |                     if (meter?.meter?.name === 'Message Credits Used') { // New check
192 |                         return meter.balance || meter.remaining || 0;
193 |                     }
194 |                 }
195 |             }
196 | 
197 |             // Check if the data has nested items
198 |             if (data?.items && Array.isArray(data.items)) {
199 |                 for (const meter of data.items) {
200 |                     if (meter?.meter?.name === 'Message Credits Used') { // New check
201 |                         return meter.balance || meter.remaining || 0;
202 |                     }
203 |                 }
204 |             }
205 | 
206 |             return null;
207 |         };
208 | 
209 |         // First try to process the direct response
210 |         let result = await processResult(response);
211 |         if (result !== null) return result;
212 | 
213 |         // If that doesn't work, try to handle the paginated response
214 |         // by getting the first page explicitly
215 |         try {
216 |             // Attempt to get first page if the response is paginated
217 |             if (typeof response.next === 'function') {
218 |                 const firstPage = await response.next();
219 |                 if (firstPage?.value) {
220 |                     result = await processResult(firstPage.value);
221 |                     if (result !== null) return result;
222 |                 }
223 |             }
224 |         } catch (err) {
225 |             // Silently ignore pagination errors
226 |             console.warn('Error processing paginated response', err);
227 |         }
228 | 
229 |         console.warn(`No 'Message Credits Used' meter found for customer ${polarCustomerId}`); // Updated warning
230 |         return null;
231 |     } catch (error) {
232 |         console.error('Error getting remaining credits from Polar:', error);
233 |         return null;
234 |     }
235 | }
236 | 
237 | /**
238 |  * Gets a customer by their external ID (app user ID)
239 |  * 
240 |  * @param externalId The external ID (your app's user ID)
241 |  * @returns The customer object or null if not found
242 |  */
243 | export async function getCustomerByExternalId(externalId: string) {
244 |     try {
245 |         const customer = await polarClient.customers.getExternal({
246 |             externalId: externalId
247 |         });
248 |         return customer;
249 |     } catch (error) {
250 |         // If the customer doesn't exist, return null instead of throwing
251 |         if ((error as any)?.statusCode === 404) {
252 |             return null;
253 |         }
254 |         // Otherwise re-throw the error
255 |         throw error;
256 |     }
257 | }
258 | 
259 | /**
260 |  * Gets a customer by their email address
261 |  * 
262 |  * @param email The customer's email address
263 |  * @returns The customer object or null if not found
264 |  */
265 | export async function getCustomerByEmail(email: string) {
266 |     try {
267 |         console.log(`[getCustomerByEmail] Searching for customer with email: ${email}`);
268 | 
269 |         const response = await polarClient.customers.list({
270 |             email: email,
271 |             limit: 1
272 |         });
273 | 
274 |         console.log(`[getCustomerByEmail] Response type:`, typeof response);
275 | 
276 |         // Handle the paginated response - try direct iteration first
277 |         try {
278 |             for await (const customerResponse of response) {
279 |                 console.log(`[getCustomerByEmail] Raw iteration response:`, JSON.stringify(customerResponse, null, 2));
280 | 
281 |                 // The response might be wrapped in a result object
282 |                 const responseAny = customerResponse as any;
283 |                 if (responseAny.result && responseAny.result.items && Array.isArray(responseAny.result.items) && responseAny.result.items.length > 0) {
284 |                     const customer = responseAny.result.items[0];
285 |                     console.log(`[getCustomerByEmail] Found customer via result.items:`, JSON.stringify(customer, null, 2));
286 |                     return customer;
287 |                 }
288 | 
289 |                 // If it's already a customer object
290 |                 if (responseAny.id && responseAny.email) {
291 |                     console.log(`[getCustomerByEmail] Found customer directly:`, JSON.stringify(responseAny, null, 2));
292 |                     return responseAny;
293 |                 }
294 |             }
295 |         } catch (iterError) {
296 |             console.log(`[getCustomerByEmail] Iteration failed:`, iterError);
297 | 
298 |             // Fallback: Try to access response as any to bypass type checking
299 |             try {
300 |                 const responseAny = response as any;
301 |                 console.log(`[getCustomerByEmail] Response (as any):`, JSON.stringify(responseAny, null, 2));
302 | 
303 |                 // Check if response has result.items structure
304 |                 if (responseAny.result && responseAny.result.items && Array.isArray(responseAny.result.items) && responseAny.result.items.length > 0) {
305 |                     const customer = responseAny.result.items[0];
306 |                     console.log(`[getCustomerByEmail] Found customer via result.items fallback:`, JSON.stringify(customer, null, 2));
307 |                     return customer;
308 |                 }
309 | 
310 |                 // Check if response has items directly
311 |                 if (responseAny.items && Array.isArray(responseAny.items) && responseAny.items.length > 0) {
312 |                     const customer = responseAny.items[0];
313 |                     console.log(`[getCustomerByEmail] Found customer via items array:`, JSON.stringify(customer, null, 2));
314 |                     return customer;
315 |                 }
316 | 
317 |                 // Check if response has data
318 |                 if (responseAny.data && Array.isArray(responseAny.data) && responseAny.data.length > 0) {
319 |                     const customer = responseAny.data[0];
320 |                     console.log(`[getCustomerByEmail] Found customer via data array:`, JSON.stringify(customer, null, 2));
321 |                     return customer;
322 |                 }
323 |             } catch (fallbackError) {
324 |                 console.log(`[getCustomerByEmail] Fallback failed:`, fallbackError);
325 |             }
326 |         }
327 | 
328 |         console.log(`[getCustomerByEmail] No customer found with email: ${email}`);
329 |         return null;
330 |     } catch (error) {
331 |         console.error('Error getting customer by email:', error);
332 |         return null;
333 |     }
334 | }
335 | 
336 | /**
337 |  * Updates an existing customer's external ID
338 |  * 
339 |  * @param customerId The customer's ID in Polar
340 |  * @param externalId The external ID to set
341 |  * @returns The updated customer or null if failed
342 |  */
343 | export async function updateCustomerExternalId(customerId: string, externalId: string) {
344 |     try {
345 |         const updatedCustomer = await polarClient.customers.update({
346 |             id: customerId,
347 |             customerUpdate: {
348 |                 externalId: externalId
349 |             }
350 |         });
351 |         return updatedCustomer;
352 |     } catch (error) {
353 |         console.error('Error updating customer external ID:', error);
354 |         throw error;
355 |     }
356 | }
357 | 
358 | /**
359 |  * Creates or updates a customer in Polar using external ID
360 |  * 
361 |  * @param userId The ID of the user in your local database (will be used as external_id)
362 |  * @param email The user's email
363 |  * @param name Optional - The user's name
364 |  * @param metadata Optional - Any additional metadata to include
365 |  * @returns The created or updated customer
366 |  */
367 | export async function createOrUpdateCustomerWithExternalId(
368 |     userId: string,
369 |     email: string,
370 |     name?: string,
371 |     metadata: Record<string, any> = {}
372 | ) {
373 |     try {
374 |         // First check if the customer already exists with this external ID
375 |         const existingCustomer = await getCustomerByExternalId(userId);
376 | 
377 |         if (existingCustomer) {
378 |             // Customer exists, update them
379 |             const updatedCustomer = await polarClient.customers.updateExternal({
380 |                 externalId: userId,
381 |                 customerUpdateExternalID: {
382 |                     email: email,
383 |                     name: name,
384 |                     metadata: metadata
385 |                 }
386 |             });
387 |             return updatedCustomer;
388 |         } else {
389 |             // Customer doesn't exist, create them
390 |             const newCustomer = await polarClient.customers.create({
391 |                 email: email,
392 |                 name: name,
393 |                 externalId: userId,
394 |                 metadata: metadata
395 |             });
396 |             return newCustomer;
397 |         }
398 |     } catch (error) {
399 |         console.error('Error creating/updating customer with external ID:', error);
400 |         throw error;
401 |     }
402 | }
403 | 
404 | /**
405 |  * Helper to associate a Polar customer ID with a user
406 |  * 
407 |  * @param userId The ID of the user in your local database
408 |  * @param polarCustomerId The customer's ID in the Polar system
409 |  */
410 | export async function associatePolarCustomer(userId: string, polarCustomerId: string) {
411 |     try {
412 |         // This would typically update your User model to store the Polar customer ID
413 |         // For now, we'll just log a usage event to record the association
414 |         await db.insert(polarUsageEvents).values({
415 |             id: nanoid(),
416 |             userId,
417 |             polarCustomerId,
418 |             eventName: 'polar-customer-association',
419 |             eventPayload: {
420 |                 associated: true,
421 |                 timestamp: new Date().toISOString()
422 |             },
423 |             createdAt: new Date()
424 |         });
425 |         return { success: true };
426 |     } catch (dbError: any) {
427 |         // Check for foreign key constraint violation
428 |         if (dbError.code === '23503' && dbError.constraint?.includes('user_id')) {
429 |             console.warn(`User ${userId} not found in database. Cannot associate Polar customer.`);
430 |             return { success: false, reason: 'user_not_found' };
431 |         }
432 |         // Rethrow other database errors
433 |         console.error('Error associating Polar customer:', dbError);
434 |         throw dbError;
435 |     }
436 | }
437 | 
```

lib/preset-templates.ts
```
1 | // Preset templates for quick user onboarding
2 | import { type modelID } from "@/ai/providers";
3 | 
4 | export interface PresetTemplate {
5 |   id: string;
6 |   name: string;
7 |   description: string;
8 |   category: 'coding' | 'writing' | 'analysis' | 'general';
9 |   icon: string;
10 |   preset: {
11 |     name: string;
12 |     modelId: modelID;
13 |     systemInstruction: string;
14 |     temperature: number;
15 |     maxTokens: number;
16 |     webSearchEnabled: boolean;
17 |     webSearchContextSize: 'low' | 'medium' | 'high';
18 |     apiKeyPreferences: Record<string, { useCustomKey: boolean; keyName?: string }>;
19 |     isDefault: boolean;
20 |     visibility: 'private' | 'shared';
21 |   };
22 | }
23 | 
24 | export const PRESET_TEMPLATES: PresetTemplate[] = [
25 |   // === CODING TEMPLATES ===
26 |   {
27 |     id: 'claude-sonnet-4-coding',
28 |     name: 'Advanced Code Architect',
29 |     description: 'Claude Sonnet 4 for complex software architecture, advanced algorithms, and system design',
30 |     category: 'coding',
31 |     icon: '🏗️',
32 |     preset: {
33 |       name: 'Advanced Code Architect',
34 |       modelId: 'openrouter/anthropic/claude-sonnet-4',
35 |       systemInstruction: `You are an expert software architect and senior developer specializing in complex system design and advanced coding patterns.
36 | 
37 | Your expertise includes:
38 | 1. Software architecture design and microservices patterns
39 | 2. Advanced algorithms and data structures optimization
40 | 3. Security best practices and vulnerability assessment
41 | 4. Performance optimization and scalability solutions
42 | 5. Code refactoring for maintainability and extensibility
43 | 6. Design patterns and clean code principles
44 | 7. API design and documentation
45 | 8. Database design and optimization
46 | 
47 | When helping with code:
48 | - Provide comprehensive solutions with error handling
49 | - Include detailed code comments and documentation
50 | - Consider scalability, security, and maintainability
51 | - Suggest testing strategies and edge cases
52 | - Explain architectural decisions and trade-offs`,
53 |       temperature: 0.7,
54 |       maxTokens: 8192,
55 |       webSearchEnabled: true,
56 |       webSearchContextSize: 'high',
57 |       apiKeyPreferences: {},
58 |       isDefault: false,
59 |       visibility: 'private'
60 |     }
61 |   },
62 |   {
63 |     id: 'deepseek-v3-coding',
64 |     name: 'Deepseek V3 Code Expert',
65 |     description: 'Deepseek V3 0324 for efficient coding, debugging, and frontend development',
66 |     category: 'coding',
67 |     icon: '⚡',
68 |     preset: {
69 |       name: 'Deepseek V3 Code Expert',
70 |       modelId: 'openrouter/deepseek/deepseek-chat-v3-0324',
71 |       systemInstruction: `You are a highly efficient coding expert specializing in modern web development, debugging, and rapid prototyping.
72 | 
73 | Your strengths include:
74 | 1. Frontend development (React, Vue, Angular, vanilla JS)
75 | 2. Modern CSS and responsive design
76 | 3. API integration and backend services
77 | 4. Debugging and error resolution
78 | 5. Code optimization and performance tuning
79 | 6. Modern development tools and frameworks
80 | 7. Quick prototyping and MVP development
81 | 8. Component-based architecture
82 | 
83 | Approach:
84 | - Write clean, efficient, and well-structured code
85 | - Provide working examples with modern best practices
86 | - Focus on practical solutions that work immediately
87 | - Include proper error handling and edge cases
88 | - Suggest performance optimizations where relevant
89 | - Use modern JavaScript/TypeScript features appropriately`,
90 |       temperature: 0.3,
91 |       maxTokens: 8000,
92 |       webSearchEnabled: true,
93 |       webSearchContextSize: 'medium',
94 |       apiKeyPreferences: {},
95 |       isDefault: false,
96 |       visibility: 'private'
97 |     }
98 |   },
99 |   {
100 |     id: 'kimi-k2-agentic-coding',
101 |     name: 'Kimi K2 Agentic Coder',
102 |     description: 'Kimi K2 for autonomous coding, complex problem-solving, and tool integration',
103 |     category: 'coding',
104 |     icon: '🤖',
105 |     preset: {
106 |       name: 'Kimi K2 Agentic Coder',
107 |       modelId: 'openrouter/moonshotai/kimi-k2',
108 |       systemInstruction: `You are an autonomous coding agent with advanced reasoning capabilities, specializing in complex problem-solving and multi-step development tasks.
109 | 
110 | Your agentic capabilities include:
111 | 1. Breaking down complex coding requirements into actionable steps
112 | 2. Advanced tool use and API integration
113 | 3. Multi-file project management and coordination
114 | 4. Automated testing and quality assurance strategies
115 | 5. Code synthesis across different languages and frameworks
116 | 6. Intelligent debugging and root cause analysis
117 | 7. Performance profiling and optimization strategies
118 | 8. Documentation generation and maintenance
119 | 
120 | Working approach:
121 | - Analyze requirements thoroughly before coding
122 | - Plan multi-step solutions with clear milestones
123 | - Consider dependencies and integration points
124 | - Implement robust error handling and logging
125 | - Provide comprehensive testing strategies
126 | - Generate clear documentation and comments
127 | - Think through edge cases and failure modes
128 | - Optimize for both performance and maintainability`,
129 |       temperature: 0.4,
130 |       maxTokens: 8192,
131 |       webSearchEnabled: true,
132 |       webSearchContextSize: 'high',
133 |       apiKeyPreferences: {},
134 |       isDefault: false,
135 |       visibility: 'private'
136 |     }
137 |   },
138 |   {
139 |     id: 'gpt-4.1-mini-rapid-coding',
140 |     name: 'GPT-4.1 Mini Rapid Coder',
141 |     description: 'GPT-4.1 Mini for fast coding tasks, code completion, and lightweight development',
142 |     category: 'coding',
143 |     icon: '🚀',
144 |     preset: {
145 |       name: 'GPT-4.1 Mini Rapid Coder',
146 |       modelId: 'openrouter/openai/gpt-4.1-mini',
147 |       systemInstruction: `You are a rapid coding assistant optimized for quick development tasks, code completion, and efficient problem-solving.
148 | 
149 | Your focus areas:
150 | 1. Fast code generation and completion
151 | 2. Quick bug fixes and troubleshooting  
152 | 3. Code snippets and utility functions
153 | 4. Simple API integrations
154 | 5. Configuration and setup assistance
155 | 6. Code formatting and style improvements
156 | 7. Quick prototyping and proof of concepts
157 | 8. Development workflow optimization
158 | 
159 | Working style:
160 | - Provide immediate, working solutions
161 | - Focus on clarity and simplicity
162 | - Include essential error handling
163 | - Use modern, idiomatic code patterns
164 | - Optimize for readability and maintainability
165 | - Provide concise but helpful comments
166 | - Suggest improvements for efficiency`,
167 |       temperature: 0.3,
168 |       maxTokens: 32000,
169 |       webSearchEnabled: false,
170 |       webSearchContextSize: 'low',
171 |       apiKeyPreferences: {},
172 |       isDefault: false,
173 |       visibility: 'private'
174 |     }
175 |   },
176 | 
177 |   // === ANALYSIS TEMPLATES ===
178 |   {
179 |     id: 'deepseek-r1-reasoning',
180 |     name: 'Deepseek R1 Deep Reasoner',
181 |     description: 'Deepseek R1 for complex reasoning, mathematical problems, and logical analysis',
182 |     category: 'analysis',
183 |     icon: '🧠',
184 |     preset: {
185 |       name: 'Deepseek R1 Deep Reasoner',
186 |       modelId: 'openrouter/deepseek/deepseek-r1',
187 |       systemInstruction: `You are an advanced reasoning specialist with exceptional capabilities in logic, mathematics, and complex problem-solving.
188 | 
189 | Your reasoning strengths:
190 | 1. Multi-step logical reasoning and proof construction
191 | 2. Mathematical problem-solving across all levels
192 | 3. Scientific analysis and hypothesis testing
193 | 4. Complex decision-making with multiple variables
194 | 5. Pattern recognition and trend analysis
195 | 6. Abstract thinking and conceptual frameworks
196 | 7. Strategic planning and scenario analysis
197 | 8. Risk assessment and probability calculations
198 | 
199 | Reasoning approach:
200 | - Break down complex problems into manageable steps
201 | - Show your work and reasoning process clearly
202 | - Consider multiple perspectives and approaches
203 | - Identify key assumptions and constraints
204 | - Validate conclusions with logical consistency
205 | - Anticipate counterarguments and edge cases
206 | - Provide confidence levels for uncertain conclusions
207 | - Connect insights to broader principles and patterns`,
208 |       temperature: 0.1,
209 |       maxTokens: 16384,
210 |       webSearchEnabled: true,
211 |       webSearchContextSize: 'high',
212 |       apiKeyPreferences: {},
213 |       isDefault: false,
214 |       visibility: 'private'
215 |     }
216 |   },
217 |   {
218 |     id: 'grok-4-research-analyst',
219 |     name: 'Grok 4 Research Analyst',
220 |     description: 'Grok 4 for comprehensive research, data analysis, and strategic insights',
221 |     category: 'analysis',
222 |     icon: '🔍',
223 |     preset: {
224 |       name: 'Grok 4 Research Analyst',
225 |       modelId: 'openrouter/x-ai/grok-4',
226 |       systemInstruction: `You are a comprehensive research analyst with advanced reasoning capabilities and access to current information.
227 | 
228 | Your analytical expertise:
229 | 1. In-depth research across multiple domains
230 | 2. Data analysis and statistical interpretation
231 | 3. Market analysis and competitive intelligence
232 | 4. Trend identification and forecasting
233 | 5. Strategic planning and decision support
234 | 6. Risk analysis and scenario planning
235 | 7. Policy analysis and impact assessment
236 | 8. Cross-domain synthesis and insights
237 | 
238 | Research methodology:
239 | - Gather information from multiple reliable sources
240 | - Analyze data with appropriate statistical methods
241 | - Consider biases and limitations in data
242 | - Synthesize findings into actionable insights
243 | - Present findings with clear visualizations and summaries
244 | - Identify knowledge gaps and recommend further research
245 | - Provide confidence intervals and uncertainty estimates
246 | - Connect findings to broader strategic implications`,
247 |       temperature: 0.2,
248 |       maxTokens: 8192,
249 |       webSearchEnabled: true,
250 |       webSearchContextSize: 'high',
251 |       apiKeyPreferences: {},
252 |       isDefault: false,
253 |       visibility: 'private'
254 |     }
255 |   },
256 |   {
257 |     id: 'gemini-pro-25-data-scientist',
258 |     name: 'Gemini Pro 2.5 Data Scientist',
259 |     description: 'Gemini Pro 2.5 for advanced data science, ML model development, and statistical analysis',
260 |     category: 'analysis',
261 |     icon: '📊',
262 |     preset: {
263 |       name: 'Gemini Pro 2.5 Data Scientist',
264 |       modelId: 'openrouter/google/gemini-2.5-pro',
265 |       systemInstruction: `You are an expert data scientist specializing in machine learning, statistical analysis, and advanced data processing.
266 | 
267 | Your data science expertise:
268 | 1. Machine learning model development and evaluation
269 | 2. Statistical analysis and hypothesis testing
270 | 3. Data preprocessing and feature engineering
271 | 4. Time series analysis and forecasting
272 | 5. Deep learning and neural network architectures
273 | 6. Data visualization and storytelling
274 | 7. A/B testing and experimental design
275 | 8. Big data processing and optimization
276 | 
277 | Approach:
278 | - Start with exploratory data analysis to understand the data
279 | - Apply appropriate statistical methods and tests
280 | - Select and tune machine learning models effectively
281 | - Validate results with proper cross-validation techniques
282 | - Interpret model results and feature importance
283 | - Create clear visualizations to communicate findings
284 | - Consider ethical implications and bias in models
285 | - Provide actionable recommendations based on analysis`,
286 |       temperature: 0.2,
287 |       maxTokens: 8192,
288 |       webSearchEnabled: true,
289 |       webSearchContextSize: 'high',
290 |       apiKeyPreferences: {},
291 |       isDefault: false,
292 |       visibility: 'private'
293 |     }
294 |   },
295 | 
296 |   // === WRITING TEMPLATES ===
297 |   {
298 |     id: 'claude-sonnet-4-technical-writer',
299 |     name: 'Claude Sonnet 4 Technical Writer',
300 |     description: 'Claude Sonnet 4 for comprehensive technical documentation and complex writing',
301 |     category: 'writing',
302 |     icon: '📚',
303 |     preset: {
304 |       name: 'Claude Sonnet 4 Technical Writer',
305 |       modelId: 'openrouter/anthropic/claude-sonnet-4',
306 |       systemInstruction: `You are a world-class technical writer with expertise in creating comprehensive, accessible documentation for complex technical topics.
307 | 
308 | Your writing specializations:
309 | 1. API documentation and developer guides
310 | 2. System architecture documentation
311 | 3. User manuals and tutorials
312 | 4. Technical specifications and requirements
313 | 5. Research papers and white papers
314 | 6. Process documentation and workflows
315 | 7. Training materials and educational content
316 | 8. Compliance and regulatory documentation
317 | 
318 | Writing principles:
319 | - Structure content logically with clear hierarchy
320 | - Use appropriate technical vocabulary while maintaining clarity
321 | - Include practical examples and code snippets where relevant
322 | - Consider your audience's technical level and needs
323 | - Provide comprehensive cross-references and navigation
324 | - Ensure accuracy and consistency throughout
325 | - Include troubleshooting and FAQ sections
326 | - Make complex concepts accessible through analogies and explanations`,
327 |       temperature: 0.7,
328 |       maxTokens: 8192,
329 |       webSearchEnabled: true,
330 |       webSearchContextSize: 'high',
331 |       apiKeyPreferences: {},
332 |       isDefault: false,
333 |       visibility: 'private'
334 |     }
335 |   },
336 |   {
337 |     id: 'gemini-25-flash-content-creator',
338 |     name: 'Gemini 2.5 Flash Content Creator',
339 |     description: 'Gemini 2.5 Flash for rapid content creation, marketing copy, and creative writing',
340 |     category: 'writing',
341 |     icon: '✨',
342 |     preset: {
343 |       name: 'Gemini 2.5 Flash Content Creator',
344 |       modelId: 'openrouter/google/gemini-2.5-flash',
345 |       systemInstruction: `You are a versatile content creator specializing in engaging, high-quality content across various formats and platforms.
346 | 
347 | Your content creation expertise:
348 | 1. Marketing copy and advertising content
349 | 2. Blog posts and articles
350 | 3. Social media content and captions
351 | 4. Email marketing campaigns
352 | 5. Product descriptions and landing pages
353 | 6. Creative storytelling and narratives
354 | 7. Script writing for videos and presentations
355 | 8. SEO-optimized content
356 | 
357 | Creative approach:
358 | - Understand the target audience and their needs
359 | - Craft compelling headlines and hooks
360 | - Use persuasive language and emotional appeal
361 | - Maintain consistent brand voice and tone
362 | - Optimize content for specific platforms and formats
363 | - Include clear calls-to-action where appropriate
364 | - Balance creativity with strategic objectives
365 | - Make content shareable and engaging`,
366 |       temperature: 0.7,
367 |       maxTokens: 4096,
368 |       webSearchEnabled: true,
369 |       webSearchContextSize: 'medium',
370 |       apiKeyPreferences: {},
371 |       isDefault: false,
372 |       visibility: 'private'
373 |     }
374 |   },
375 | 
376 |   // === GENERAL TEMPLATES ===
377 |   {
378 |     id: 'claude-sonnet-4-assistant',
379 |     name: 'Claude Sonnet 4 Executive Assistant',
380 |     description: 'Claude Sonnet 4 as a comprehensive AI assistant for complex tasks and decision support',
381 |     category: 'general',
382 |     icon: '👔',
383 |     preset: {
384 |       name: 'Claude Sonnet 4 Executive Assistant',
385 |       modelId: 'openrouter/anthropic/claude-sonnet-4',
386 |       systemInstruction: `You are a highly capable executive assistant with advanced reasoning abilities, designed to support complex decision-making and high-level tasks.
387 | 
388 | Your capabilities include:
389 | 1. Strategic planning and project management
390 | 2. Complex problem-solving and analysis
391 | 3. Meeting preparation and agenda planning
392 | 4. Research and competitive intelligence
393 | 5. Document review and synthesis
394 | 6. Risk assessment and mitigation planning
395 | 7. Stakeholder communication and coordination
396 | 8. Process optimization and workflow design
397 | 
398 | Working style:
399 | - Think strategically about long-term implications
400 | - Consider multiple perspectives and stakeholders
401 | - Provide comprehensive analysis with pros and cons
402 | - Anticipate potential challenges and solutions
403 | - Communicate clearly and professionally
404 | - Prioritize tasks based on impact and urgency
405 | - Maintain confidentiality and professionalism
406 | - Offer proactive suggestions and improvements`,
407 |       temperature: 0.7,
408 |       maxTokens: 8192,
409 |       webSearchEnabled: true,
410 |       webSearchContextSize: 'high',
411 |       apiKeyPreferences: {},
412 |       isDefault: false,
413 |       visibility: 'private'
414 |     }
415 |   },
416 |   {
417 |     id: 'gpt-4.1-mini-personal-assistant',
418 |     name: 'GPT-4.1 Mini Personal Assistant',
419 |     description: 'GPT-4.1 Mini for everyday tasks, quick answers, and personal productivity',
420 |     category: 'general',
421 |     icon: '🤝',
422 |     preset: {
423 |       name: 'GPT-4.1 Mini Personal Assistant',
424 |       modelId: 'openrouter/openai/gpt-4.1-mini',
425 |       systemInstruction: `You are a helpful personal assistant focused on productivity, organization, and everyday task support.
426 | 
427 | Your assistance includes:
428 | 1. Schedule management and planning
429 | 2. Task organization and prioritization
430 | 3. Quick research and fact-checking
431 | 4. Email and message drafting
432 | 5. Travel planning and logistics
433 | 6. Personal finance guidance
434 | 7. Health and wellness tips
435 | 8. Learning and skill development support
436 | 
437 | Assistant approach:
438 | - Provide clear, actionable advice
439 | - Be concise but thorough in responses
440 | - Offer practical solutions to everyday problems
441 | - Help organize and prioritize tasks effectively
442 | - Suggest tools and resources for productivity
443 | - Be proactive in identifying needs and solutions
444 | - Maintain a friendly, professional tone
445 | - Respect privacy and personal boundaries`,
446 |       temperature: 0.5,
447 |       maxTokens: 32000,
448 |       webSearchEnabled: false,
449 |       webSearchContextSize: 'medium',
450 |       apiKeyPreferences: {},
451 |       isDefault: false,
452 |       visibility: 'private'
453 |     }
454 |   },
455 |   {
456 |     id: 'kimi-k2-problem-solver',
457 |     name: 'Kimi K2 Strategic Problem Solver',
458 |     description: 'Kimi K2 for complex problem-solving, strategic thinking, and multi-step solutions',
459 |     category: 'general',
460 |     icon: '🧩',
461 |     preset: {
462 |       name: 'Kimi K2 Strategic Problem Solver',
463 |       modelId: 'openrouter/moonshotai/kimi-k2',
464 |       systemInstruction: `You are a strategic problem solver with advanced reasoning capabilities, specializing in complex, multi-faceted challenges.
465 | 
466 | Your problem-solving expertise:
467 | 1. Strategic thinking and systems analysis
468 | 2. Root cause analysis and diagnosis
469 | 3. Multi-criteria decision making
470 | 4. Resource optimization and allocation
471 | 5. Stakeholder analysis and management
472 | 6. Risk assessment and contingency planning
473 | 7. Process improvement and optimization
474 | 8. Innovation and creative solution development
475 | 
476 | Problem-solving methodology:
477 | - Define the problem clearly and comprehensively
478 | - Gather relevant information and context
479 | - Identify key stakeholders and constraints
480 | - Generate multiple solution alternatives
481 | - Evaluate options using appropriate criteria
482 | - Consider implementation challenges and requirements
483 | - Develop detailed action plans with timelines
484 | - Build in monitoring and adjustment mechanisms
485 | - Anticipate and plan for potential obstacles`,
486 |       temperature: 0.3,
487 |       maxTokens: 8192,
488 |       webSearchEnabled: true,
489 |       webSearchContextSize: 'high',
490 |       apiKeyPreferences: {},
491 |       isDefault: false,
492 |       visibility: 'private'
493 |     }
494 |   },
495 |   {
496 |     id: 'gemini-25-flash-tutor',
[TRUNCATED]
```

lib/suggested-prompts-utils.tsx
```
1 | import { SuggestedAction } from "@/components/suggested-prompts";
2 | import { 
3 |   Code, 
4 |   Brain, 
5 |   Lightbulb, 
6 |   Search, 
7 |   BookOpen, 
8 |   Zap,
9 |   Globe,
10 |   Sparkles,
11 |   FileText,
12 |   ImageIcon,
13 |   Cpu,
14 |   Languages,
15 |   MessageCircle,
16 |   Heart,
17 |   MapPin,
18 |   Utensils,
19 |   DollarSign,
20 |   Leaf,
21 |   Dumbbell,
22 |   Users,
23 |   Palette,
24 |   Telescope,
25 |   Clock,
26 |   Home,
27 |   FlaskConical,
28 |   Shield,
29 |   Gamepad2,
30 |   Music,
31 |   Calendar
32 | } from "lucide-react";
33 | 
34 | export interface ModelCapabilities {
35 |   coding: boolean;
36 |   reasoning: boolean;
37 |   vision: boolean;
38 |   creative: boolean;
39 |   analysis: boolean;
40 |   multimodal: boolean;
41 | }
42 | 
43 | export const getModelCapabilities = (modelId: string): ModelCapabilities => {
44 |   const model = modelId.toLowerCase();
45 |   
46 |   // Claude models
47 |   if (model.includes('claude')) {
48 |     return {
49 |       coding: true,
50 |       reasoning: true,
51 |       vision: model.includes('3.5') || model.includes('3-5'),
52 |       creative: true,
53 |       analysis: true,
54 |       multimodal: model.includes('3.5') || model.includes('3-5')
55 |     };
56 |   }
57 |   
58 |   // GPT models
59 |   if (model.includes('gpt') || model.includes('o1')) {
60 |     return {
61 |       coding: true,
62 |       reasoning: model.includes('o1'),
63 |       vision: model.includes('4') && !model.includes('o1'),
64 |       creative: true,
65 |       analysis: true,
66 |       multimodal: model.includes('4') && !model.includes('o1')
67 |     };
68 |   }
69 |   
70 |   // Gemini models
71 |   if (model.includes('gemini')) {
72 |     return {
73 |       coding: true,
74 |       reasoning: true,
75 |       vision: true,
76 |       creative: true,
77 |       analysis: true,
78 |       multimodal: true
79 |     };
80 |   }
81 |   
82 |   // Deepseek models - especially good at coding
83 |   if (model.includes('deepseek')) {
84 |     return {
85 |       coding: true,
86 |       reasoning: true,
87 |       vision: false,
88 |       creative: false,
89 |       analysis: true,
90 |       multimodal: false
91 |     };
92 |   }
93 |   
94 |   // Llama models
95 |   if (model.includes('llama')) {
96 |     return {
97 |       coding: true,
98 |       reasoning: true,
99 |       vision: model.includes('vision'),
100 |       creative: true,
101 |       analysis: true,
102 |       multimodal: model.includes('vision')
103 |     };
104 |   }
105 |   
106 |   // Default capabilities for unknown models
107 |   return {
108 |     coding: true,
109 |     reasoning: true,
110 |     vision: false,
111 |     creative: true,
112 |     analysis: true,
113 |     multimodal: false
114 |   };
115 | };
116 | 
117 | export const getContextualSuggestions = (
118 |   modelId?: string,
119 |   userPreferences?: string[]
120 | ): SuggestedAction[] => {
121 |   const capabilities = modelId ? getModelCapabilities(modelId) : null;
122 |   const suggestions: SuggestedAction[] = [];
123 |   
124 |   // Beginner-friendly suggestions (always shown first)
125 |   suggestions.push(
126 |     {
127 |       title: "Help me write an email",
128 |       label: "professional and clear",
129 |       action: "template:write-email",
130 |       category: "writing",
131 |       icon: <FileText className="h-4 w-4" />,
132 |     },
133 |     {
134 |       title: "Help me write a story",
135 |       label: "with an interesting twist",
136 |       action: "template:write-story",
137 |       category: "creative",
138 |       icon: <Lightbulb className="h-4 w-4" />,
139 |     },
140 |     {
141 |       title: "Help me plan my week",
142 |       label: "efficiently and realistically",
143 |       action: "template:plan-schedule",
144 |       category: "planning",
145 |       icon: <Calendar className="h-4 w-4" />,
146 |     },
147 |     {
148 |       title: "Explain this concept",
149 |       label: "in simple terms",
150 |       action: "template:explain-concept",
151 |       category: "learning",
152 |       icon: <BookOpen className="h-4 w-4" />,
153 |     },
154 |     {
155 |       title: "Help me make a decision",
156 |       label: "by weighing pros and cons",
157 |       action: "template:make-decision",
158 |       category: "decision",
159 |       icon: <Brain className="h-4 w-4" />,
160 |     },
161 |     {
162 |       title: "Help me brainstorm ideas",
163 |       label: "for a creative project",
164 |       action: "template:brainstorm-ideas",
165 |       category: "creative",
166 |       icon: <Lightbulb className="h-4 w-4" />,
167 |     },
168 |     {
169 |       title: "Help me write a cover letter",
170 |       label: "that stands out",
171 |       action: "template:write-cover-letter",
172 |       category: "writing",
173 |       icon: <FileText className="h-4 w-4" />,
174 |     },
175 |     {
176 |       title: "Help me write a social post",
177 |       label: "engaging and authentic",
178 |       action: "template:write-social-post",
179 |       category: "writing",
180 |       icon: <Sparkles className="h-4 w-4" />,
181 |     },
182 |     {
183 |       title: "Help me prepare for an interview",
184 |       label: "with confidence",
185 |       action: "template:prepare-interview",
186 |       category: "planning",
187 |       icon: <Search className="h-4 w-4" />,
188 |     }
189 |   );
190 |   
191 |   // Health & Wellness suggestions
192 |   suggestions.push(
193 |     {
194 |       title: "Design a workout plan",
195 |       label: "for my fitness goals",
196 |       action: "template:create-workout-plan",
197 |       category: "health",
198 |       icon: <Dumbbell className="h-4 w-4" />,
199 |     },
200 |     {
201 |       title: "Manage stress and anxiety",
202 |       label: "with proven techniques",
203 |       action: "template:manage-stress",
204 |       category: "wellness",
205 |       icon: <Heart className="h-4 w-4" />,
206 |     },
207 |     {
208 |       title: "Start a meditation practice",
209 |       label: "for beginners",
210 |       action: "template:meditation-guide",
211 |       category: "wellness",
212 |       icon: <Brain className="h-4 w-4" />,
213 |     },
214 |     {
215 |       title: "Improve my memory",
216 |       label: "and recall abilities",
217 |       action: "template:improve-memory",
218 |       category: "self-improvement",
219 |       icon: <Brain className="h-4 w-4" />,
220 |     },
221 |     {
222 |       title: "Boost my confidence",
223 |       label: "in challenging situations",
224 |       action: "template:boost-confidence",
225 |       category: "self-improvement",
226 |       icon: <Shield className="h-4 w-4" />,
227 |     }
228 |   );
229 |   
230 |   // Lifestyle & Personal suggestions
231 |   suggestions.push(
232 |     {
233 |       title: "Creative date ideas",
234 |       label: "for memorable experiences",
235 |       action: "template:suggest-date-ideas",
236 |       category: "lifestyle",
237 |       icon: <Heart className="h-4 w-4" />,
238 |     },
239 |     {
240 |       title: "Plan a perfect trip",
241 |       label: "with detailed itinerary",
242 |       action: "template:travel-itinerary",
243 |       category: "travel",
244 |       icon: <MapPin className="h-4 w-4" />,
245 |     },
246 |     {
247 |       title: "Make friends as an adult",
248 |       label: "in meaningful ways",
249 |       action: "template:make-adult-friends",
250 |       category: "social",
251 |       icon: <Users className="h-4 w-4" />,
252 |     },
253 |     {
254 |       title: "Organize my living space",
255 |       label: "efficiently and stylishly",
256 |       action: "template:home-organization",
257 |       category: "lifestyle",
258 |       icon: <Home className="h-4 w-4" />,
259 |     },
260 |     {
261 |       title: "Find new hobbies to try",
262 |       label: "that match my interests",
263 |       action: "template:hobby-suggestions",
264 |       category: "lifestyle",
265 |       icon: <Palette className="h-4 w-4" />,
266 |     }
267 |   );
268 |   
269 |   // Financial & Practical suggestions
270 |   suggestions.push(
271 |     {
272 |       title: "Save money effectively",
273 |       label: "with practical strategies",
274 |       action: "template:save-money-tips",
275 |       category: "finance",
276 |       icon: <DollarSign className="h-4 w-4" />,
277 |     },
278 |     {
279 |       title: "Reduce my carbon footprint",
280 |       label: "with actionable tips",
281 |       action: "template:reduce-carbon-footprint",
282 |       category: "environment",
283 |       icon: <Leaf className="h-4 w-4" />,
284 |     },
285 |     {
286 |       title: "Create a delicious recipe",
287 |       label: "with what I have",
288 |       action: "template:create-recipe",
289 |       category: "cooking",
290 |       icon: <Utensils className="h-4 w-4" />,
291 |     }
292 |   );
293 |   
294 |   // Learning & Skills suggestions
295 |   suggestions.push(
296 |     {
297 |       title: "Get book recommendations",
298 |       label: "across different genres",
299 |       action: "template:book-recommendations",
300 |       category: "learning",
301 |       icon: <BookOpen className="h-4 w-4" />,
302 |     },
303 |     {
304 |       title: "Learn a new language",
305 |       label: "with structured approach",
306 |       action: "template:learn-language",
307 |       category: "learning",
308 |       icon: <Languages className="h-4 w-4" />,
309 |     },
310 |     {
311 |       title: "Improve public speaking",
312 |       label: "and presentation skills",
313 |       action: "template:improve-public-speaking",
314 |       category: "skills",
315 |       icon: <MessageCircle className="h-4 w-4" />,
316 |     }
317 |   );
318 |   
319 |   // Fun & Entertainment suggestions
320 |   suggestions.push(
321 |     {
322 |       title: "Fascinating space facts",
323 |       label: "about the universe",
324 |       action: "template:space-facts",
325 |       category: "science",
326 |       icon: <Telescope className="h-4 w-4" />,
327 |     },
328 |     {
329 |       title: "Intriguing unsolved mysteries",
330 |       label: "that puzzle experts",
331 |       action: "template:unsolved-mysteries",
332 |       category: "mystery",
333 |       icon: <Search className="h-4 w-4" />,
334 |     },
335 |     {
336 |       title: "Historical facts",
337 |       label: "that will surprise you",
338 |       action: "template:historical-facts",
339 |       category: "history",
340 |       icon: <Globe className="h-4 w-4" />,
341 |     },
342 |     {
343 |       title: "Fun science experiments",
344 |       label: "to try at home",
345 |       action: "template:science-experiments",
346 |       category: "science",
347 |       icon: <FlaskConical className="h-4 w-4" />,
348 |     },
349 |     {
350 |       title: "Board game recommendations",
351 |       label: "for any occasion",
352 |       action: "template:board-game-suggestions",
353 |       category: "entertainment",
354 |       icon: <Gamepad2 className="h-4 w-4" />,
355 |     }
356 |   );
357 |   
358 |   // Professional & Social suggestions
359 |   suggestions.push(
360 |     {
361 |       title: "Team building activities",
362 |       label: "to strengthen bonds",
363 |       action: "template:team-building",
364 |       category: "professional",
365 |       icon: <Users className="h-4 w-4" />,
366 |     },
367 |     {
368 |       title: "Cultural awareness guide",
369 |       label: "for respectful interactions",
370 |       action: "template:cultural-awareness",
371 |       category: "social",
372 |       icon: <Globe className="h-4 w-4" />,
373 |     },
374 |     {
375 |       title: "Philosophical discussion",
376 |       label: "on thought-provoking topics",
377 |       action: "template:philosophical-discussion",
378 |       category: "philosophy",
379 |       icon: <Brain className="h-4 w-4" />,
380 |     }
381 |   );
382 |   
383 |   // Technical suggestions for developers
384 |   suggestions.push(
385 |     {
386 |       title: "Debug this code",
387 |       label: "and explain the issue",
388 |       action: "template:debug-code",
389 |       category: "coding",
390 |       icon: <Search className="h-4 w-4" />,
391 |     },
392 |     {
393 |       title: "Code review",
394 |       label: "with best practices",
395 |       action: "template:code-review",
396 |       category: "coding", 
397 |       icon: <Code className="h-4 w-4" />,
398 |     }
399 |   );
400 |   
401 |   // Model-specific suggestions
402 |   if (capabilities?.reasoning) {
403 |     suggestions.push({
404 |       title: "Step-by-step analysis",
405 |       label: "of complex problem",
406 |       action: "template:analyze-problem",
407 |       category: "reasoning",
408 |       icon: <Brain className="h-4 w-4" />,
409 |     });
410 |   }
411 |   
412 |   if (capabilities?.vision) {
413 |     suggestions.push({
414 |       title: "Analyze this image",
415 |       label: "and describe what you see",
416 |       action: "Please analyze this image and describe what you see in detail",
417 |       category: "vision",
418 |       icon: <ImageIcon className="h-4 w-4" />,
419 |     });
420 |   }
421 |   
422 |   if (capabilities?.creative) {
423 |     suggestions.push({
424 |       title: "Write creative content",
425 |       label: "for my project",
426 |       action: "template:write-content",
427 |       category: "creative",
428 |       icon: <Lightbulb className="h-4 w-4" />,
429 |     });
430 |   }
431 |   
432 |   // DeepSeek specific suggestions (coding focused)
433 |   if (modelId?.toLowerCase().includes('deepseek')) {
434 |     suggestions.push(
435 |       {
436 |         title: "Optimize algorithm",
437 |         label: "for better performance",
438 |         action: "template:optimize-algorithm",
439 |         category: "optimization",
440 |         icon: <Cpu className="h-4 w-4" />,
441 |       },
442 |       {
443 |         title: "Refactor code",
444 |         label: "with clean architecture",
445 |         action: "template:refactor-code",
446 |         category: "coding",
447 |         icon: <Zap className="h-4 w-4" />,
448 |       }
449 |     );
450 |   }
451 |   
452 |   // Claude specific suggestions (reasoning focused)
453 |   if (modelId?.toLowerCase().includes('claude')) {
454 |     suggestions.push(
455 |       {
456 |         title: "Research and synthesize",
457 |         label: "multiple sources",
458 |         action: "template:research-topic",
459 |         category: "research",
460 |         icon: <Globe className="h-4 w-4" />,
461 |       },
462 |       {
463 |         title: "Explain complex concept",
464 |         label: "in simple terms",
465 |         action: "template:explain-concept",
466 |         category: "learning",
467 |         icon: <BookOpen className="h-4 w-4" />,
468 |       }
469 |     );
470 |   }
471 |   
472 |   // GPT specific suggestions (versatile)
473 |   if (modelId?.toLowerCase().includes('gpt')) {
474 |     suggestions.push(
475 |       {
476 |         title: "Create documentation",
477 |         label: "with examples",
478 |         action: "template:create-documentation",
479 |         category: "documentation",
480 |         icon: <FileText className="h-4 w-4" />,
481 |       },
482 |       {
483 |         title: "Generate test cases",
484 |         label: "for thorough testing",
485 |         action: "template:generate-tests",
486 |         category: "testing",
487 |         icon: <Sparkles className="h-4 w-4" />,
488 |       }
489 |     );
490 |   }
491 |   
492 |   // Gemini specific suggestions (multimodal)
493 |   if (modelId?.toLowerCase().includes('gemini')) {
494 |     suggestions.push({
495 |       title: "Multimodal analysis",
496 |       label: "of data and content",
497 |       action: "template:multimodal-analysis",
498 |       category: "analysis",
499 |       icon: <Languages className="h-4 w-4" />,
500 |     });
501 |   }
502 |   
503 |   // Generic helpful suggestions
504 |   suggestions.push(
505 |     {
506 |       title: "Learn new technology",
507 |       label: "with structured plan",
508 |       action: "template:learn-technology",
509 |       category: "learning",
510 |       icon: <BookOpen className="h-4 w-4" />,
511 |     },
512 |     {
513 |       title: "Summarize this text",
514 |       label: "with key points",
515 |       action: "template:summarize-text",
516 |       category: "analysis",
517 |       icon: <FileText className="h-4 w-4" />,
518 |     },
519 |     {
520 |       title: "Review this document",
521 |       label: "and suggest improvements",
522 |       action: "template:review-document",
523 |       category: "analysis",
524 |       icon: <Search className="h-4 w-4" />,
525 |     },
526 |     {
527 |       title: "Brainstorm solutions",
528 |       label: "to specific challenge",
529 |       action: "template:brainstorm-solutions",
530 |       category: "creative",
531 |       icon: <Lightbulb className="h-4 w-4" />,
532 |     }
533 |   );
534 |   
535 |   return suggestions;
536 | };
537 | 
538 | export const getCategoryColor = (category: string): string => {
539 |   const colors = {
540 |     // Beginner-friendly categories
541 |     writing: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300",
542 |     planning: "bg-violet-100 text-violet-800 dark:bg-violet-900/30 dark:text-violet-300",
543 |     decision: "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300",
544 |     
545 |     // Technical categories
546 |     coding: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",
547 |     reasoning: "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",
548 |     debugging: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",
549 |     documentation: "bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-300",
550 |     optimization: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300",
551 |     testing: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300",
552 |     
553 |     // Health & Wellness categories
554 |     health: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
555 |     wellness: "bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300",
556 |     'self-improvement': "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",
557 |     
558 |     // Lifestyle categories
559 |     lifestyle: "bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-300",
560 |     travel: "bg-sky-100 text-sky-800 dark:bg-sky-900/30 dark:text-sky-300",
561 |     social: "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300",
562 |     cooking: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",
563 |     
564 |     // Financial & Practical categories
565 |     finance: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-300",
566 |     environment: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
567 |     
568 |     // Learning & Skills categories
569 |     skills: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",
570 |     
571 |     // Fun & Entertainment categories
572 |     science: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900/30 dark:text-cyan-300",
573 |     mystery: "bg-slate-100 text-slate-800 dark:bg-slate-900/30 dark:text-slate-300",
574 |     history: "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300",
575 |     entertainment: "bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300",
576 |     
577 |     // Professional & Social categories
578 |     professional: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",
579 |     philosophy: "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",
580 |     
581 |     // General categories
582 |     creative: "bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300",
583 |     research: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
[TRUNCATED]
```

lib/text-utils.ts
```
1 | /**
2 |  * Text processing utilities for enhanced textarea handling
3 |  */
4 | 
5 | // Common programming keywords for code detection
6 | const PROGRAMMING_KEYWORDS = [
7 |     'function', 'class', 'import', 'export', 'const', 'let', 'var',
8 |     'if', 'else', 'for', 'while', 'return', 'try', 'catch', 'async', 'await',
9 |     'interface', 'type', 'enum', 'extends', 'implements', 'public', 'private',
10 |     'def', 'print', 'True', 'False', 'None', // Python
11 |     'public', 'static', 'void', 'int', 'String', // Java
12 |     'console.log', 'document', 'window', 'require', // JavaScript
13 | ];
14 | 
15 | // File extension patterns
16 | const CODE_EXTENSIONS = [
17 |     '.js', '.ts', '.jsx', '.tsx', '.py', '.java', '.cpp', '.c', '.cs',
18 |     '.php', '.rb', '.go', '.rs', '.swift', '.kt', '.scala', '.sh', '.sql',
19 |     '.html', '.css', '.scss', '.sass', '.json', '.xml', '.yaml', '.yml'
20 | ];
21 | 
22 | // Code-like syntax patterns
23 | const CODE_PATTERNS = [
24 |     /=>/g,           // Arrow functions
25 |     /\{[\s\S]*\}/g,  // Braces
26 |     /\[[\s\S]*\]/g,  // Brackets
27 |     /<[^>]+>/g,      // HTML/JSX tags
28 |     /^\s*\/\//m,     // Comments
29 |     /^\s*\/\*/m,     // Block comments
30 |     /^\s*#/m,        // Hash comments
31 |     /;\s*$/m,        // Semicolons at line end
32 | ];
33 | 
34 | /**
35 |  * Detects if the given text appears to be code
36 |  */
37 | export function detectCode(text: string): {
38 |     isCode: boolean;
39 |     confidence: number;
40 |     reasons: string[];
41 | } {
42 |     if (!text || text.trim().length < 10) {
43 |         return { isCode: false, confidence: 0, reasons: [] };
44 |     }
45 | 
46 |     const reasons: string[] = [];
47 |     let score = 0;
48 | 
49 |     // Check for multiple lines with consistent indentation
50 |     const lines = text.split('\n');
51 |     if (lines.length > 2) {
52 |         const indentedLines = lines.filter(line => /^\s{2,}/.test(line));
53 |         if (indentedLines.length / lines.length > 0.3) {
54 |             score += 30;
55 |             reasons.push('consistent indentation');
56 |         }
57 |     }
58 | 
59 |     // Check for programming keywords
60 |     const keywordMatches = PROGRAMMING_KEYWORDS.filter(keyword =>
61 |         text.toLowerCase().includes(keyword.toLowerCase())
62 |     );
63 |     if (keywordMatches.length > 0) {
64 |         score += keywordMatches.length * 10;
65 |         reasons.push(`programming keywords: ${keywordMatches.slice(0, 3).join(', ')}`);
66 |     }
67 | 
68 |     // Check for file extensions
69 |     const extensionMatches = CODE_EXTENSIONS.filter(ext => text.includes(ext));
70 |     if (extensionMatches.length > 0) {
71 |         score += 20;
72 |         reasons.push('file extensions');
73 |     }
74 | 
75 |     // Check for code patterns
76 |     let patternMatches = 0;
77 |     CODE_PATTERNS.forEach(pattern => {
78 |         const matches = text.match(pattern);
79 |         if (matches && matches.length > 0) {
80 |             patternMatches += matches.length;
81 |         }
82 |     });
83 | 
84 |     if (patternMatches > 2) {
85 |         score += Math.min(patternMatches * 5, 40);
86 |         reasons.push('code syntax patterns');
87 |     }
88 | 
89 |     // Check bracket/brace density
90 |     const specialChars = text.match(/[{}[\]()]/g);
91 |     if (specialChars && specialChars.length / text.length > 0.05) {
92 |         score += 25;
93 |         reasons.push('high bracket density');
94 |     }
95 | 
96 |     // Check for common code formatting patterns
97 |     if (/^\s*[a-zA-Z_$][a-zA-Z0-9_$]*\s*[=:]/m.test(text)) {
98 |         score += 15;
99 |         reasons.push('variable assignments');
100 |     }
101 | 
102 |     const confidence = Math.min(score, 100);
103 |     const isCode = confidence >= 40;
104 | 
105 |     return { isCode, confidence, reasons };
106 | }
107 | 
108 | /**
109 |  * Sanitizes text input to fix common display issues
110 |  */
111 | export function sanitizeText(text: string): string {
112 |     if (!text) return text;
113 | 
114 |     return text
115 |         // Normalize line endings
116 |         .replace(/\r\n/g, '\n')
117 |         .replace(/\r/g, '\n')
118 |         // Fix smart quotes and similar characters
119 |         .replace(/[""]/g, '"')
120 |         .replace(/['']/g, "'")
121 |         .replace(/…/g, '...')
122 |         .replace(/–/g, '-')
123 |         .replace(/—/g, '--')
124 |         // Remove invisible characters that can break display
125 |         .replace(/[\u200B-\u200D\uFEFF]/g, '')
126 |         // Normalize whitespace (but preserve intentional spacing)
127 |         .replace(/\u00A0/g, ' '); // Non-breaking space to regular space
128 | }
129 | 
130 | /**
131 |  * Normalizes indentation for better display
132 |  */
133 | export function normalizeIndentation(text: string): string {
134 |     const lines = text.split('\n');
135 | 
136 |     // Find the minimum indentation (excluding empty lines)
137 |     const nonEmptyLines = lines.filter(line => line.trim().length > 0);
138 |     if (nonEmptyLines.length === 0) return text;
139 | 
140 |     const minIndent = Math.min(...nonEmptyLines.map(line => {
141 |         const match = line.match(/^(\s*)/);
142 |         return match ? match[1].length : 0;
143 |     }));
144 | 
145 |     // Remove common leading whitespace
146 |     if (minIndent > 0) {
147 |         return lines
148 |             .map(line => line.length > minIndent ? line.slice(minIndent) : line)
149 |             .join('\n');
150 |     }
151 | 
152 |     return text;
153 | }
154 | 
155 | /**
156 |  * Fixes common copy-paste artifacts
157 |  */
158 | export function fixCopyPasteArtifacts(text: string): string {
159 |     return text
160 |         // Remove extra whitespace at line ends
161 |         .replace(/[ \t]+$/gm, '')
162 |         // Fix multiple consecutive blank lines
163 |         .replace(/\n{3,}/g, '\n\n')
164 |         // Fix mixed tab/space indentation
165 |         .replace(/^\t+/gm, match => '  '.repeat(match.length));
166 | }
167 | 
168 | /**
169 |  * Detects programming language from text content
170 |  */
171 | export function detectLanguage(text: string): string | null {
172 |     const lowerText = text.toLowerCase();
173 | 
174 |     // JavaScript/TypeScript patterns
175 |     if (lowerText.includes('console.log') || lowerText.includes('function') ||
176 |         lowerText.includes('=>') || lowerText.includes('const ') ||
177 |         lowerText.includes('import ') || lowerText.includes('export ')) {
178 |         if (lowerText.includes('interface ') || lowerText.includes('type ') ||
179 |             text.includes(': string') || text.includes(': number') ||
180 |             text.includes('tsx') || text.includes('typescript')) {
181 |             return 'typescript';
182 |         }
183 |         if (text.includes('jsx') || lowerText.includes('react') ||
184 |             text.includes('className=') || text.includes('onClick=')) {
185 |             return 'jsx';
186 |         }
187 |         return 'javascript';
188 |     }
189 | 
190 |     // Python patterns
191 |     if (lowerText.includes('def ') || lowerText.includes('print(') ||
192 |         lowerText.includes('class ') || lowerText.includes('if __name__') ||
193 |         lowerText.includes('import numpy') || lowerText.includes('import pandas')) {
194 |         return 'python';
195 |     }
196 | 
197 |     // HTML/JSX patterns
198 |     if (text.includes('<') && text.includes('>') &&
199 |         (text.includes('</') || text.includes('/>'))) {
200 |         if (text.includes('className=') || text.includes('onClick=') ||
201 |             text.includes('useState') || text.includes('useEffect')) {
202 |             return 'jsx';
203 |         }
204 |         return 'html';
205 |     }
206 | 
207 |     // CSS patterns
208 |     if (text.includes('{') && text.includes('}') &&
209 |         (text.includes(':') && text.includes(';'))) {
210 |         if (lowerText.includes('@media') || lowerText.includes('px') ||
211 |             lowerText.includes('rem') || lowerText.includes('color:') ||
212 |             lowerText.includes('margin:') || lowerText.includes('padding:')) {
213 |             return 'css';
214 |         }
215 |     }
216 | 
217 |     // JSON patterns
218 |     if ((text.trim().startsWith('{') && text.trim().endsWith('}')) ||
219 |         (text.trim().startsWith('[') && text.trim().endsWith(']'))) {
220 |         try {
221 |             JSON.parse(text);
222 |             return 'json';
223 |         } catch { }
224 |     }
225 | 
226 |     // SQL patterns
227 |     if (lowerText.includes('select ') || lowerText.includes('insert ') ||
228 |         lowerText.includes('update ') || lowerText.includes('delete ') ||
229 |         lowerText.includes('create table')) {
230 |         return 'sql';
231 |     }
232 | 
233 |     // Shell/Bash patterns
234 |     if (lowerText.includes('#!/bin/bash') || lowerText.includes('#!/bin/sh') ||
235 |         text.includes('$ ') || lowerText.includes('npm install') ||
236 |         lowerText.includes('git ') || lowerText.includes('cd ')) {
237 |         return 'bash';
238 |     }
239 | 
240 |     // Java patterns
241 |     if (lowerText.includes('public class') || lowerText.includes('public static void') ||
242 |         lowerText.includes('system.out.println') || text.includes('import java')) {
243 |         return 'java';
244 |     }
245 | 
246 |     // C/C++ patterns
247 |     if (text.includes('#include') || lowerText.includes('int main') ||
248 |         lowerText.includes('printf(') || lowerText.includes('cout <<')) {
249 |         return text.includes('cout') || text.includes('std::') ? 'cpp' : 'c';
250 |     }
251 | 
252 |     return null;
253 | }
254 | 
255 | /**
256 |  * Checks if text is already wrapped in code blocks
257 |  */
258 | export function isAlreadyWrappedInCodeBlocks(text: string): boolean {
259 |     const trimmed = text.trim();
260 |     return trimmed.startsWith('```') && trimmed.endsWith('```') &&
261 |         trimmed.split('```').length >= 3; // At least opening and closing
262 | }
263 | 
264 | /**
265 |  * Wraps code in appropriate markdown code blocks
266 |  */
267 | export function wrapInCodeBlocks(text: string, language: string | null = null): string {
268 |     // Don't wrap if already wrapped
269 |     if (isAlreadyWrappedInCodeBlocks(text)) {
270 |         return text;
271 |     }
272 | 
273 |     // Detect language if not provided
274 |     const detectedLanguage = language || detectLanguage(text);
275 |     const languageTag = detectedLanguage || '';
276 | 
277 |     // Clean up the text
278 |     const cleanedText = text.trim();
279 | 
280 |     return `\`\`\`${languageTag}\n${cleanedText}\n\`\`\``;
281 | }
282 | 
283 | /**
284 |  * Main text processing function that combines all enhancements
285 |  */
286 | export function processTextInput(text: string, options: {
287 |     autoWrapCode?: boolean;
288 |     forceCodeWrapping?: boolean;
289 | } = {}): {
290 |     processedText: string;
291 |     isCode: boolean;
292 |     confidence: number;
293 |     reasons: string[];
294 |     language?: string | null;
295 |     wasWrapped?: boolean;
296 | } {
297 |     const codeDetection = detectCode(text);
298 |     const { autoWrapCode = true, forceCodeWrapping = false } = options;
299 | 
300 |     let processedText = sanitizeText(text);
301 |     let wasWrapped = false;
302 |     let language: string | null = null;
303 | 
304 |     if (codeDetection.isCode) {
305 |         processedText = normalizeIndentation(processedText);
306 |         processedText = fixCopyPasteArtifacts(processedText);
307 |         language = detectLanguage(processedText);
308 | 
309 |         // Auto-wrap in code blocks if enabled and confidence is high enough
310 |         if ((autoWrapCode && codeDetection.confidence >= 60) || forceCodeWrapping) {
311 |             if (!isAlreadyWrappedInCodeBlocks(processedText)) {
312 |                 processedText = wrapInCodeBlocks(processedText, language);
313 |                 wasWrapped = true;
314 |             }
315 |         }
316 |     }
317 | 
318 |     return {
319 |         processedText,
320 |         language,
321 |         wasWrapped,
322 |         ...codeDetection
323 |     };
324 | }
325 | 
326 | /**
327 |  * Smart bracket matching and auto-completion
328 |  */
329 | export function getMatchingBracket(char: string): string | null {
330 |     const brackets: Record<string, string> = {
331 |         '(': ')',
332 |         '[': ']',
333 |         '{': '}',
334 |         '"': '"',
335 |         "'": "'",
336 |         '`': '`'
337 |     };
338 |     return brackets[char] || null;
339 | }
340 | 
341 | /**
342 |  * Check if brackets are balanced in the text
343 |  */
344 | export function areBracketsBalanced(text: string): boolean {
345 |     const stack: string[] = [];
346 |     const openBrackets = ['(', '[', '{'];
347 |     const closeBrackets = [')', ']', '}'];
348 |     const bracketPairs: Record<string, string> = { ')': '(', ']': '[', '}': '{' };
349 | 
350 |     for (const char of text) {
351 |         if (openBrackets.includes(char)) {
352 |             stack.push(char);
353 |         } else if (closeBrackets.includes(char)) {
354 |             const expected = bracketPairs[char];
355 |             if (stack.length === 0 || stack.pop() !== expected) {
356 |                 return false;
357 |             }
358 |         }
359 |     }
360 | 
361 |     return stack.length === 0;
362 | }
363 | 
364 | /**
365 |  * Auto-indent based on the previous line's indentation
366 |  */
367 | export function calculateIndentation(
368 |     text: string,
369 |     cursorPosition: number
370 | ): { indentation: string; shouldIncreaseIndent: boolean } {
371 |     const lines = text.slice(0, cursorPosition).split('\n');
372 |     const currentLine = lines[lines.length - 1];
373 |     const previousLine = lines.length > 1 ? lines[lines.length - 2] : '';
374 | 
375 |     // Get indentation from previous line
376 |     const previousIndentMatch = previousLine.match(/^(\s*)/);
377 |     const previousIndent = previousIndentMatch ? previousIndentMatch[1] : '';
378 | 
379 |     // Check if we should increase indentation
380 |     const shouldIncreaseIndent =
381 |         previousLine.trim().endsWith('{') ||
382 |         previousLine.trim().endsWith('[') ||
383 |         previousLine.trim().endsWith('(') ||
384 |         previousLine.trim().endsWith(':') ||
385 |         /^\s*(if|for|while|function|class|def)\b/.test(previousLine);
386 | 
387 |     const indentation = shouldIncreaseIndent
388 |         ? previousIndent + '  ' // Add 2 spaces
389 |         : previousIndent;
390 | 
391 |     return { indentation, shouldIncreaseIndent };
392 | }
393 | 
394 | /**
395 |  * Smart code snippet expansion
396 |  */
397 | export function expandCodeSnippet(text: string, language: string | null): string | null {
398 |     const snippets: Record<string, Record<string, string>> = {
399 |         javascript: {
400 |             'func': 'function ${1:name}(${2:params}) {\n  ${3:// body}\n}',
401 |             'arrow': '(${1:params}) => {\n  ${2:// body}\n}',
402 |             'log': 'console.log(${1:value});',
403 |             'if': 'if (${1:condition}) {\n  ${2:// body}\n}',
404 |             'for': 'for (let ${1:i} = 0; ${1:i} < ${2:length}; ${1:i}++) {\n  ${3:// body}\n}',
405 |             'try': 'try {\n  ${1:// try block}\n} catch (${2:error}) {\n  ${3:// error handling}\n}'
406 |         },
407 |         typescript: {
408 |             'interface': 'interface ${1:Name} {\n  ${2:property}: ${3:type};\n}',
409 |             'type': 'type ${1:Name} = ${2:type};',
410 |             'func': 'function ${1:name}(${2:params}): ${3:ReturnType} {\n  ${4:// body}\n}',
411 |         },
412 |         python: {
413 |             'def': 'def ${1:function_name}(${2:params}):\n    ${3:pass}',
414 |             'class': 'class ${1:ClassName}:\n    def __init__(self${2:, params}):\n        ${3:pass}',
415 |             'if': 'if ${1:condition}:\n    ${2:pass}',
416 |             'for': 'for ${1:item} in ${2:items}:\n    ${3:pass}',
417 |             'try': 'try:\n    ${1:pass}\nexcept ${2:Exception} as ${3:e}:\n    ${4:pass}'
418 |         }
419 |     };
420 | 
421 |     if (!language || !snippets[language]) return null;
422 | 
423 |     const languageSnippets = snippets[language];
424 |     const words = text.toLowerCase().split(/\s+/);
425 |     const lastWord = words[words.length - 1];
426 | 
427 |     return languageSnippets[lastWord] || null;
428 | }
429 | 
430 | /**
431 |  * Process keyboard input with smart enhancements
432 |  */
433 | export function processKeyboardInput(
434 |     key: string,
435 |     text: string,
436 |     cursorPosition: number,
437 |     language: string | null
438 | ): {
439 |     shouldPreventDefault: boolean;
440 |     newText?: string;
441 |     newCursorPosition?: number;
442 |     action?: 'insert' | 'replace' | 'indent';
443 | } {
444 |     // Handle Enter key for auto-indentation
445 |     if (key === 'Enter') {
446 |         const { indentation, shouldIncreaseIndent } = calculateIndentation(text, cursorPosition);
447 | 
448 |         const beforeCursor = text.slice(0, cursorPosition);
449 |         const afterCursor = text.slice(cursorPosition);
450 | 
451 |         // Check if we're between matching brackets
452 |         const charBefore = beforeCursor.slice(-1);
453 |         const charAfter = afterCursor.slice(0, 1);
454 |         const isBetweenBrackets =
455 |             (charBefore === '{' && charAfter === '}') ||
456 |             (charBefore === '[' && charAfter === ']') ||
457 |             (charBefore === '(' && charAfter === ')');
458 | 
459 |         let newText: string;
460 |         let newCursorPosition: number;
461 | 
462 |         if (isBetweenBrackets) {
463 |             // Insert newline with proper indentation, plus closing bracket indentation
464 |             const closingIndent = indentation.slice(0, -2); // Remove one level for closing bracket
465 |             newText = beforeCursor + '\n' + indentation + '\n' + closingIndent + afterCursor;
466 |             newCursorPosition = cursorPosition + 1 + indentation.length;
467 |         } else {
468 |             // Regular newline with indentation
469 |             newText = beforeCursor + '\n' + indentation + afterCursor;
470 |             newCursorPosition = cursorPosition + 1 + indentation.length;
471 |         }
472 | 
473 |         return {
474 |             shouldPreventDefault: true,
475 |             newText,
476 |             newCursorPosition,
477 |             action: 'indent'
478 |         };
479 |     }
480 | 
481 |     // Handle Tab key for indentation
482 |     if (key === 'Tab') {
483 |         const beforeCursor = text.slice(0, cursorPosition);
484 |         const afterCursor = text.slice(cursorPosition);
485 |         const newText = beforeCursor + '  ' + afterCursor; // Insert 2 spaces
486 |         const newCursorPosition = cursorPosition + 2;
487 | 
488 |         return {
489 |             shouldPreventDefault: true,
490 |             newText,
491 |             newCursorPosition,
492 |             action: 'insert'
493 |         };
494 |     }
495 | 
496 |     // Handle bracket auto-completion
497 |     const matchingBracket = getMatchingBracket(key);
498 |     if (matchingBracket && key !== matchingBracket) { // Don't auto-close quotes immediately
499 |         const beforeCursor = text.slice(0, cursorPosition);
500 |         const afterCursor = text.slice(cursorPosition);
501 |         const newText = beforeCursor + key + matchingBracket + afterCursor;
502 |         const newCursorPosition = cursorPosition + 1; // Position cursor between brackets
503 | 
504 |         return {
505 |             shouldPreventDefault: true,
506 |             newText,
507 |             newCursorPosition,
508 |             action: 'insert'
509 |         };
510 |     }
511 | 
512 |     // Handle closing bracket - skip if next character is the same
513 |     if (['}', ')', ']'].includes(key)) {
514 |         const nextChar = text.slice(cursorPosition, cursorPosition + 1);
515 |         if (nextChar === key) {
516 |             return {
517 |                 shouldPreventDefault: true,
518 |                 newText: text,
519 |                 newCursorPosition: cursorPosition + 1,
520 |                 action: 'insert'
521 |             };
522 |         }
523 |     }
524 | 
525 |     return { shouldPreventDefault: false };
526 | }
527 | 
528 | /**
529 |  * Clean up malformed or incomplete code structures
530 |  */
531 | export function cleanupCodeStructure(text: string): string {
532 |     let cleaned = text;
533 | 
534 |     // Fix common JavaScript/TypeScript issues
535 |     cleaned = cleaned
536 |         // Fix missing semicolons at line ends (but not inside strings)
537 |         .replace(/([a-zA-Z0-9_\]\)])\s*\n/g, (match, p1) => {
538 |             // Don't add semicolon if it's already there or if it's a control structure
539 |             if (p1.match(/[;{}]/)) return match;
540 |             return p1 + ';\n';
541 |         })
542 |         // Fix spacing around operators
543 |         .replace(/([a-zA-Z0-9_])([=+\-*/<>!])([a-zA-Z0-9_])/g, '$1 $2 $3')
[TRUNCATED]
```

lib/types.ts
```
1 | import type { ReasoningUIPart, SourceUIPart, FileUIPart, StepStartUIPart } from "@ai-sdk/ui-utils";
2 | 
3 | export interface WebSearchCitation {
4 |     url: string;
5 |     title: string;
6 |     content?: string;
7 |     startIndex: number;
8 |     endIndex: number;
9 | }
10 | 
11 | export interface TextUIPart {
12 |     type: "text";
13 |     text: string;
14 |     citations?: WebSearchCitation[];
15 | }
16 | 
17 | export interface ToolInvocationUIPart {
18 |     type: "tool-invocation";
19 |     toolInvocation: {
20 |         toolName: string;
21 |         state: string;
22 |         args: any;
23 |         result?: any;
24 |     };
25 | }
26 | 
27 | export interface ImageUIPart {
28 |     type: "image_url";
29 |     image_url: {
30 |         url: string; // Can be external URL or base64 data URL (data:image/jpeg;base64,...)
31 |         detail?: "low" | "high" | "auto"; // Image processing detail level
32 |     };
33 |     metadata?: {
34 |         filename?: string;
35 |         size?: number;
36 |         mimeType?: string;
37 |         width?: number;
38 |         height?: number;
39 |     };
40 | }
41 | 
42 | // Image detail levels control processing quality and token cost:
43 | // - "low": ~85 tokens, faster, good for simple images
44 | // - "high": ~170 tokens, slower, better for detailed analysis  
45 | // - "auto": Model chooses optimal level (default)
46 | 
47 | export interface ImageAttachment {
48 |     file?: File;
49 |     dataUrl: string;
50 |     metadata: {
51 |         filename: string;
52 |         size: number;
53 |         mimeType: string;
54 |         width: number;
55 |         height: number;
56 |         originalSize?: number;
57 |         compressedSize?: number;
58 |     };
59 |     detail?: "low" | "high" | "auto";
60 | }
61 | 
62 | export interface ImageMetadata {
63 |     width: number;
64 |     height: number;
65 |     size: number;
66 |     mimeType: string;
67 |     filename: string;
68 |     originalSize?: number; // Track original file size before compression
69 |     compressedSize?: number; // Track compressed file size
70 | }
71 | 
72 | export type MessagePart = TextUIPart | ToolInvocationUIPart | ImageUIPart | ReasoningUIPart | SourceUIPart | FileUIPart | StepStartUIPart; 
```

lib/utils.ts
```
1 | import { clsx, type ClassValue } from "clsx"
2 | import { twMerge } from "tailwind-merge"
3 | 
4 | export function cn(...inputs: ClassValue[]) {
5 |   return twMerge(clsx(inputs))
6 | }
```

public/manifest.json
```
1 | {
2 |     "name": "ChatLima",
3 |     "short_name": "ChatLima",
4 |     "description": "AI-powered chat interface with MCP support",
5 |     "start_url": "/",
6 |     "display": "standalone",
7 |     "background_color": "#ffffff",
8 |     "theme_color": "#000000",
9 |     "orientation": "portrait-primary",
10 |     "scope": "/",
11 |     "lang": "en",
12 |     "icons": [
13 |         {
14 |             "src": "/apple-touch-icon-120x120.png",
15 |             "sizes": "120x120",
16 |             "type": "image/png",
17 |             "purpose": "any maskable"
18 |         },
19 |         {
20 |             "src": "/apple-touch-icon-152x152.png",
21 |             "sizes": "152x152",
22 |             "type": "image/png",
23 |             "purpose": "any maskable"
24 |         },
25 |         {
26 |             "src": "/apple-touch-icon-167x167.png",
27 |             "sizes": "167x167",
28 |             "type": "image/png",
29 |             "purpose": "any maskable"
30 |         },
31 |         {
32 |             "src": "/apple-touch-icon-180x180.png",
33 |             "sizes": "180x180",
34 |             "type": "image/png",
35 |             "purpose": "any maskable"
36 |         },
37 |         {
38 |             "src": "/apple-touch-icon.png",
39 |             "sizes": "180x180",
40 |             "type": "image/png",
41 |             "purpose": "any maskable"
42 |         }
43 |     ]
44 | }
```

releases/RELEASE_NOTES_v0.10.0.md
```
1 | # 🚀 ChatLima v0.10.0 - Enhanced Model Support & Navigation
2 | 
3 | ## 🎯 What's New
4 | - **New Mistral Models**: Added support for the latest Mistral Magistral Small and Medium 2506 models
5 | - **Enhanced Model Descriptions**: Detailed capabilities and use-case information for better model selection
6 | - **Improved Post-Checkout Navigation**: Better user flow after successful checkout completion
7 | - **Enhanced Mathematical Rendering**: Improved KaTeX styling for consistent mathematical expressions across themes
8 | 
9 | ## 🤖 AI Model Enhancements
10 | - **Mistral Magistral Small 2506**: Fast and efficient model for everyday tasks with cost-effective performance
11 | - **Mistral Magistral Medium 2506**: Balanced model offering enhanced capabilities for complex reasoning tasks
12 | - Comprehensive model descriptions help users choose the right model for their specific needs
13 | - Updated model selection interface with clear capability indicators
14 | 
15 | ## 🎨 User Experience Improvements
16 | - **Better Checkout Flow**: Post-purchase navigation now redirects to home page for improved user orientation
17 | - **Enhanced Mathematical Display**: Upgraded KaTeX styling ensures consistent mathematical notation rendering
18 | - **Theme Consistency**: Mathematical expressions now display properly across light and dark themes
19 | - **Improved Visual Hierarchy**: Better styling consistency throughout the application
20 | 
21 | ## 🔧 Technical Improvements
22 | - Added new model configurations with proper metadata and pricing information
23 | - Enhanced CSS styling for mathematical content rendering
24 | - Improved navigation logic for better user flow management
25 | - Updated model selection components with expanded capability descriptions
26 | 
27 | ## 📈 Benefits
28 | - **More Model Choices**: Access to latest Mistral models for diverse use cases
29 | - **Better Decision Making**: Comprehensive model descriptions help users select optimal models
30 | - **Smoother User Journey**: Improved post-checkout experience reduces confusion
31 | - **Enhanced Readability**: Better mathematical content display improves technical discussions
32 | - **Consistent Theming**: Unified visual experience across all interface elements
33 | 
34 | ## 🔄 Migration Notes
35 | - New models are immediately available in the model selection interface
36 | - No breaking changes to existing functionality
37 | - Enhanced styling is automatically applied to all mathematical content
38 | - Existing model preferences remain unchanged and fully functional
39 | 
40 | ## 🚀 Deployment
41 | - Standard deployment process with automatic model availability
42 | - No additional configuration required for new models
43 | - Enhanced styling takes effect immediately after deployment
44 | - All existing user data and preferences remain intact
45 | 
46 | ---
47 | 
48 | **Full Changelog**: [v0.9.1...v0.10.0](https://github.com/brooksy4503/chatlima/compare/v0.9.1...v0.10.0) 
```

releases/RELEASE_NOTES_v0.11.0.md
```
1 | # 🚀 ChatLima v0.11.0 - Polar Integration & Enhanced Features
2 | 
3 | ## 🎯 What's New
4 | - **Polar Integration**: Complete integration with Polar billing platform for customer management and payments
5 | - **Paid Web Search**: New premium web search feature with credit-based billing and usage tracking
6 | - **Dynamic Environment Configuration**: Environment-based Polar server configuration for seamless production deployment
7 | - **Customer Portal Access**: Direct access to Polar customer portal for subscription and billing management
8 | - **Enhanced Testing Infrastructure**: Comprehensive Playwright testing suite with multiple configuration options
9 | - **Smart Title Generation**: Dynamic model selection for AI-powered conversation title generation
10 | - **Improved Credit Management**: Enhanced credit validation with better user experience and error handling
11 | 
12 | ## 🔧 Technical Implementation
13 | - **Polar SDK Integration**: Full integration with Polar billing platform using environment-based configuration
14 | - **Web Search Billing**: Backend credit validation and surcharge system for paid web search functionality
15 | - **Enhanced OAuth Configuration**: Dynamic Google OAuth setup with improved logging and error handling
16 | - **Customer Management**: Advanced customer retrieval and creation logic with fallback mechanisms
17 | - **Credit Exposure**: Frontend access to user credit balance for better UX and transparency
18 | - **Testing Suite**: Added comprehensive Playwright testing scripts with local and CI configurations
19 | - **API Route Enhancements**: New customer portal API route and improved existing endpoints
20 | 
21 | ## 🛡️ Security & Privacy
22 | - **Environment-Based Configuration**: Secure Polar server environment selection based on deployment context
23 | - **Enhanced OAuth Security**: Improved Google OAuth client configuration with detailed logging
24 | - **Credit Validation**: Robust credit checking with proper error handling and user feedback
25 | - **Customer Data Protection**: Secure customer management with proper API integration patterns
26 | 
27 | ## 📈 Benefits
28 | - **Streamlined Billing**: Direct integration with Polar for seamless payment and subscription management
29 | - **Premium Features**: Monetized web search capabilities with transparent credit-based pricing
30 | - **Better User Experience**: Clear credit balance visibility and improved error messaging
31 | - **Development Quality**: Comprehensive testing infrastructure for better code reliability
32 | - **Operational Excellence**: Environment-aware configuration for smooth production deployments
33 | - **Customer Self-Service**: Direct portal access for users to manage their billing and subscriptions
34 | 
35 | ## 🔄 Migration Notes
36 | - **Polar Configuration**: New environment variables required for Polar integration
37 |   - Configure Polar environment settings based on deployment context
38 |   - Update customer management workflows to use new Polar API integration
39 | - **Web Search Credits**: New credit deduction system for web search features
40 |   - Existing users will see new web search billing in their account
41 |   - Credit validation now includes web search cost calculations
42 | - **Testing Infrastructure**: New Playwright configuration files added
43 |   - Development teams should update their testing workflows
44 |   - New test scripts available for comprehensive UI testing
45 | - **API Changes**: Enhanced API routes with improved error handling
46 |   - Existing integrations remain compatible
47 |   - New customer portal functionality available immediately
48 | 
49 | ## 🚀 Deployment
50 | - **Environment Variables**: Ensure Polar configuration environment variables are set
51 | - **Database Updates**: No schema changes required for this release
52 | - **Testing**: Run new Playwright test suite to validate deployment
53 | - **Customer Portal**: New portal access will be available immediately after deployment
54 | - **Web Search**: Paid web search features activate automatically with credit system
55 | 
56 | ## 🆕 New Features Detail
57 | - **Polar Customer Portal**: Users can access billing portal directly from account menu
58 | - **Web Search Billing**: Transparent credit usage for premium web search functionality
59 | - **Dynamic Title Generation**: Improved conversation titles using advanced AI models
60 | - **Enhanced Credit UI**: Real-time credit balance display and usage tracking
61 | - **Testing Scripts**: Multiple Playwright configurations for different testing scenarios
62 | - **Environment Awareness**: Automatic Polar environment selection for production/development
63 | 
64 | ---
65 | 
66 | **Full Changelog**: [v0.10.0...v0.11.0](https://github.com/brooksy4503/chatlima/compare/v0.10.0...v0.11.0) 
```

releases/RELEASE_NOTES_v0.12.0.md
```
1 | # 🚀 ChatLima v0.12.0 - Polar Production Checkout Integration
2 | 
3 | ## 🎯 What's New
4 | - **Production Checkout System**: Complete Polar checkout integration with user-friendly purchase flow
5 | - **Smart User Flow Handling**: Seamless experience for both anonymous and authenticated users
6 | - **Integrated Purchase Interface**: Checkout button directly accessible from user account menu
7 | - **Comprehensive Error Handling**: Dedicated error pages for failed, canceled, and problematic transactions
8 | - **Credit Purchase Workflow**: Streamlined process for users to purchase AI usage credits
9 | - **Enhanced User Experience**: Context-aware messaging and intuitive purchase flow
10 | 
11 | ## 🔧 Technical Implementation
12 | - **CheckoutButton Component**: Reusable React component with intelligent user state detection
13 | - **Dual User Flow Logic**: Automatic handling of anonymous users (redirect to sign-in) vs authenticated users (direct checkout)
14 | - **Error Page Framework**: Complete error handling with detailed error states and recovery options
15 | - **User Menu Integration**: Seamless integration of purchase functionality into existing user interface
16 | - **Production Environment**: Full migration to Polar production environment with proper security configurations
17 | - **Webhook Integration**: Backend webhook handling for real-time credit updates after successful purchases
18 | 
19 | ## 🛡️ Security & Privacy
20 | - **Production Environment**: Secure Polar production environment configuration
21 | - **Authenticated Checkout**: Proper user authentication verification before checkout access
22 | - **Secure Payment Processing**: All payment processing handled securely through Polar platform
23 | - **Error Information Protection**: Safe error handling that doesn't expose sensitive checkout data
24 | - **Environment Variable Security**: Production keys and secrets properly configured in deployment environment
25 | 
26 | ## 📈 Benefits
27 | - **Simplified Credit Purchase**: Users can purchase credits directly from the application interface
28 | - **Improved User Onboarding**: Anonymous users guided through sign-up process for credit purchases
29 | - **Better Error Recovery**: Clear error messages with actionable recovery options
30 | - **Seamless Integration**: Native checkout experience without external redirects
31 | - **Real-time Updates**: Immediate credit balance updates after successful purchases
32 | - **Enhanced Accessibility**: Intuitive interface accessible to users of all technical levels
33 | 
34 | ## 🔄 Migration Notes
35 | - **Environment Configuration**: Production Polar environment variables now active
36 |   - All checkout functionality now uses production Polar endpoints
37 |   - Webhook endpoints configured for production credit updates
38 | - **User Interface Updates**: New checkout button integrated into user account menu
39 |   - Existing users will see new "Purchase More Credits" option in account menu
40 |   - Anonymous users will see "Sign In to Purchase Credits" with guided flow
41 | - **Error Handling**: New error pages for checkout failures
42 |   - Users experiencing checkout issues will be directed to helpful error pages
43 |   - Recovery options provided for failed or canceled transactions
44 | 
45 | ## 🚀 Deployment
46 | - **Environment Variables**: Production Polar configuration active
47 | - **Component Integration**: New checkout components deployed and integrated
48 | - **Error Pages**: Checkout error handling pages now available at `/checkout/error`
49 | - **User Menu Updates**: Enhanced account menu with integrated purchase functionality
50 | - **Webhook Verification**: Production webhook endpoints for credit updates confirmed active
51 | 
52 | ## 🆕 New Features Detail
53 | - **Smart Checkout Button**: Context-aware button that adapts to user authentication state
54 |   - Anonymous users: "Sign In to Purchase Credits" with Google OAuth flow
55 |   - Authenticated users: "Purchase More Credits" with direct checkout access
56 | - **Comprehensive Error Handling**: Dedicated error page with specific error state handling
57 |   - Canceled transactions: User-friendly messaging with retry options
58 |   - Failed payments: Clear error explanation with troubleshooting guidance
59 |   - General errors: Helpful recovery options and support contact information
60 | - **Seamless User Flow**: Integrated purchase experience within the application
61 |   - No external redirects or confusing navigation
62 |   - Clear calls-to-action and intuitive user interface
63 |   - Immediate access to purchased credits after successful payment
64 | 
65 | ## 🐛 Bug Fixes
66 | - **Checkout Flow Reliability**: Improved error handling and user feedback
67 | - **Authentication State Management**: Better handling of anonymous vs authenticated user scenarios
68 | - **UI Consistency**: Consistent styling and messaging across checkout flow
69 | 
70 | ---
71 | 
72 | **Full Changelog**: [v0.11.0...v0.12.0](https://github.com/brooksy4503/chatlima/compare/v0.11.0...v0.12.0) 
```

releases/RELEASE_NOTES_v0.12.1.md
```
1 | # 🔐 ChatLima v0.12.1 - Web Search Security & Credit Validation Fix
2 | 
3 | ## 🎯 What's Fixed
4 | - **Enhanced Web Search Security**: Implemented robust server-side validation for web search feature access
5 | - **Credit Validation Improvements**: Strengthened credit checking to prevent unauthorized feature usage
6 | - **Anonymous User Protection**: Added proper blocking for anonymous users attempting to access premium features
7 | - **Security Logging**: Enhanced monitoring and logging for unauthorized access attempts
8 | 
9 | ## 🔧 Technical Fixes
10 | - **Server-Side Validation**: Complete overhaul of web search authorization logic
11 |   - Server now determines web search eligibility instead of relying on client requests
12 |   - Prevents potential security bypasses through client-side manipulation
13 | - **Anonymous User Blocking**: Explicit prevention of web search access for non-authenticated users
14 | - **Credit Verification**: Enhanced credit checking before allowing premium feature access
15 | - **Security Incident Logging**: Improved logging for tracking unauthorized access attempts
16 | - **Authorization Flow**: Streamlined permission checking with proper error responses
17 | 
18 | ## 🛡️ Security Improvements
19 | - **Access Control**: Strict server-side enforcement of web search feature permissions
20 | - **Credit Protection**: Prevents users with insufficient credits from accessing premium features
21 | - **Anonymous User Safety**: Clear boundaries preventing anonymous users from accessing paid features
22 | - **Audit Trail**: Enhanced logging for security monitoring and incident response
23 | - **Input Validation**: Improved validation of user requests to prevent unauthorized actions
24 | 
25 | ## 🐛 Critical Bug Fixes
26 | - **Web Search Authorization**: Fixed potential security vulnerability where unauthorized users could access web search
27 | - **Credit Validation**: Resolved issue where credit checks could be bypassed
28 | - **User State Verification**: Enhanced user authentication state validation
29 | - **Request Processing**: Improved handling of unauthorized feature access attempts
30 | 
31 | ## 📈 Impact
32 | - **Improved Security**: Significantly enhanced protection against unauthorized feature access
33 | - **Better Credit Management**: More accurate and secure credit usage tracking
34 | - **Enhanced User Experience**: Clear error messages for users attempting unauthorized actions
35 | - **Reduced Security Risk**: Eliminated potential vectors for premium feature bypass
36 | - **Better Monitoring**: Improved visibility into security-related events
37 | 
38 | ## 🔄 Changes
39 | - **API Route Updates**: Modified `/api/chat/route.ts` with enhanced security checks
40 | - **Authorization Logic**: Completely rewritten web search permission validation
41 | - **Error Handling**: Improved error responses for unauthorized access attempts
42 | - **Logging Infrastructure**: Enhanced security event logging and monitoring
43 | 
44 | ---
45 | 
46 | **Full Changelog**: [v0.12.0...v0.12.1](https://github.com/brooksy4503/chatlima/compare/v0.12.0...v0.12.1) 
```

releases/RELEASE_NOTES_v0.13.0.md
```
1 | # 📱 ChatLima v0.13.0 - iOS Homescreen Shortcut Support
2 | 
3 | ## 🎯 What's New
4 | - **iOS Homescreen Integration**: Complete iOS homescreen shortcut functionality with native app-like experience
5 | - **Apple Touch Icons**: High-quality branded icons optimized for all iOS device sizes and configurations
6 | - **Smart Installation Prompt**: Intelligent iOS detection with contextual "Add to Home Screen" suggestions
7 | - **Enhanced Mobile Experience**: Comprehensive iOS-specific styling and touch optimizations
8 | - **Progressive Web Enhancement**: Web app manifest and meta tags for standalone display mode
9 | - **Mobile UI Improvements**: Enhanced chat interface and typography optimized for mobile devices
10 | 
11 | ## 🔧 Technical Implementation
12 | - **Apple Touch Icon Assets**: Complete icon set for all iOS devices and screen densities
13 |   - 180x180px for iPhone 6 Plus and newer devices
14 |   - 167x167px for iPad Pro with Retina display
15 |   - 152x152px for standard iPad Retina display
16 |   - 120x120px for iPhone Retina display
17 |   - Optimized PNG format with no transparency for perfect iOS integration
18 | - **Web App Manifest**: Comprehensive `manifest.json` with proper metadata and standalone display configuration
19 | - **iOS Detection Component**: Smart `ios-install-prompt.tsx` component with user preference memory and installation status detection
20 | - **Meta Tag Enhancements**: Complete iOS-specific meta tag implementation for optimal homescreen experience
21 | - **CSS Mobile Optimization**: Enhanced styling for iOS Safari and homescreen app mode with safe area support
22 | 
23 | ## 🛡️ Mobile Experience & UX
24 | - **Native App Feel**: When launched from home screen, ChatLima opens without browser chrome for seamless experience
25 | - **Safe Area Support**: Proper handling for notched devices (iPhone X and newer) with appropriate padding and layout
26 | - **Touch Optimization**: Improved touch targets and interactions specifically designed for mobile use
27 | - **Enhanced Typography**: Better mobile typography and spacing for improved readability on smaller screens
28 | - **Smooth Scrolling**: Optimized scrolling behavior and performance for mobile devices
29 | - **Installation Memory**: User dismissal preferences saved to avoid annoying repeated prompts
30 | 
31 | ## 📈 Benefits
32 | - **Quick Access**: Users can launch ChatLima directly from iOS home screen like a native app
33 | - **Improved Engagement**: Easier access encourages more frequent usage on mobile devices
34 | - **Better Mobile UX**: Comprehensive mobile optimizations improve overall user experience
35 | - **Reduced Friction**: No need to open Safari and navigate to website each time
36 | - **Native Integration**: Proper iOS integration with branded icons and standalone display
37 | - **Future-Proof Foundation**: Groundwork laid for potential PWA features and offline functionality
38 | 
39 | ## 🔄 Migration Notes
40 | - **Automatic Availability**: iOS homescreen functionality is automatically available to all users on compatible devices
41 | - **No Configuration Required**: All necessary assets and configurations deployed automatically
42 | - **Backward Compatibility**: All existing functionality remains unchanged for non-iOS users
43 | - **Progressive Enhancement**: iOS users get enhanced experience while maintaining compatibility
44 | - **Asset Optimization**: New icon assets added without affecting site performance
45 | - **Component Integration**: iOS install prompt integrated seamlessly into existing UI
46 | 
47 | ## 🚀 Deployment
48 | - **Icon Assets**: All Apple touch icon variants deployed to public directory
49 | - **Manifest Configuration**: Web app manifest active with proper metadata
50 | - **Meta Tag Integration**: iOS-specific meta tags added to application layout
51 | - **Component Activation**: iOS installation prompt component deployed and active
52 | - **CSS Enhancements**: Mobile-optimized styling deployed across all components
53 | - **Documentation**: Implementation plan and guidelines added to project documentation
54 | 
55 | ## 🆕 New Features Detail
56 | - **Smart iOS Detection**: Automatic detection of iOS Safari users with contextual prompting
57 |   - Detects device type and browser for targeted user experience
58 |   - Checks if already added to home screen to avoid duplicate prompts
59 |   - Respects user dismissal preferences with localStorage persistence
60 | - **Progressive Installation Prompt**: Non-intrusive "Add to Home Screen" suggestions
61 |   - Appears only for eligible iOS users at appropriate moments
62 |   - Clear instructions and value proposition for homescreen installation
63 |   - Easy dismissal with memory to avoid repeated interruptions
64 | - **Standalone App Mode**: Complete standalone display experience when launched from home screen
65 |   - No browser address bar or navigation controls
66 |   - Proper status bar styling and safe area handling
67 |   - Native app-like navigation and interaction patterns
68 | - **Enhanced Mobile Interface**: Comprehensive mobile UI improvements
69 |   - Better chat component responsiveness and touch handling
70 |   - Improved textarea component styling for mobile input
71 |   - Enhanced markdown rendering optimized for mobile screens
72 | 
73 | ## 🐛 Bug Fixes & Improvements
74 | - **Mobile Responsiveness**: Improved layout handling across all mobile screen sizes
75 | - **Touch Interaction**: Better touch target sizing and interaction feedback
76 | - **Typography Enhancement**: Optimized text rendering and spacing for mobile devices
77 | - **Asset Loading**: Efficient loading of mobile-specific assets and configurations
78 | - **Component Styling**: Enhanced styling consistency across chat and input components
79 | 
80 | ---
81 | 
82 | **Full Changelog**: [v0.12.1...v0.13.0](https://github.com/brooksy4503/chatlima/compare/v0.12.1...v0.13.0) 
```

releases/RELEASE_NOTES_v0.14.0.md
```
1 | # 🚀 ChatLima v0.14.0 - Enhanced AI Model Portfolio
2 | 
3 | ## 🎯 What's New
4 | 
5 | - **Google Gemini 2.5 Pro & Flash Models**: Access to Google's latest state-of-the-art AI models with superior reasoning, coding, and multimodal capabilities
6 | - **MiniMax M1 Model Family**: New large-scale reasoning models with extended context support (up to 1 million tokens) and high-efficiency inference
7 | - **Enhanced Model Selection**: Four new premium AI models expanding ChatLima's capabilities across different use cases and performance requirements
8 | - **Advanced Reasoning Features**: Built-in thinking capabilities in Gemini 2.5 Flash for improved accuracy and nuanced context handling
9 | 
10 | ## 🔧 Technical Implementation
11 | 
12 | - Added Google Gemini 2.5 Pro and Flash model integrations via OpenRouter
13 | - Implemented MiniMax M1 and M1 Extended models with hybrid Mixture-of-Experts (MoE) architecture
14 | - Enhanced `ai/providers.ts` with comprehensive model configurations and capability mappings
15 | - Added detailed model descriptions showcasing advanced reasoning, coding, mathematics, and scientific task capabilities
16 | - Updated model selection interface with proper provider attribution following naming conventions
17 | 
18 | ### New Models Added:
19 | 
20 | #### Google Models (via OpenRouter)
21 | - **Google Gemini 2.5 Pro**: Premium model for advanced reasoning, coding, mathematics, and scientific tasks
22 | - **Google Gemini 2.5 Flash**: Workhorse model with built-in thinking capabilities for balanced performance and cost
23 | 
24 | #### MiniMax Models (via OpenRouter)  
25 | - **MiniMax M1**: Large-scale reasoning model with 456B total parameters and 45.9B active per token
26 | - **MiniMax M1 Extended**: Extended context variant processing up to 128,000 tokens
27 | 
28 | ## 🛡️ Security & Privacy
29 | 
30 | - All new models inherit existing API key management and user authentication protections
31 | - Maintained secure provider integration patterns with proper headers and referrer policies
32 | - No changes to existing security or privacy implementations
33 | 
34 | ## 📈 Benefits
35 | 
36 | - **Expanded Choice**: Users now have access to 4 additional cutting-edge AI models
37 | - **Performance Optimization**: Different models optimized for various tasks (speed vs. quality vs. context length)
38 | - **Cost Flexibility**: Mix of premium and standard pricing tiers to match user needs and budgets
39 | - **Advanced Capabilities**: Enhanced reasoning, longer context windows, and specialized task performance
40 | 
41 | ### Model Capabilities Overview:
42 | - **Advanced Reasoning**: All new models excel at complex logical tasks
43 | - **Long Context Support**: Gemini 2.5 Pro/Flash and MiniMax M1 support up to 1 million tokens
44 | - **Multimodal Processing**: Gemini models support text, image, and mixed content
45 | - **Software Engineering**: Optimized for coding and technical documentation tasks
46 | - **Mathematical Reasoning**: Enhanced capabilities for mathematical and scientific problem-solving
47 | 
48 | ## 🔄 Migration Notes
49 | 
50 | - **No Breaking Changes**: All existing functionality remains unchanged
51 | - **Automatic Availability**: New models are immediately available in the model selection interface
52 | - **Backward Compatibility**: Existing chats and configurations continue to work seamlessly
53 | 
54 | ## 🚀 Deployment
55 | 
56 | ### Environment Considerations:
57 | - No new environment variables required
58 | - Existing OpenRouter API key provides access to all new models
59 | - Models are enabled by default for users with appropriate access levels
60 | 
61 | ### Model Access:
62 | - **Gemini 2.5 Flash**: Available to all users (premium: false)
63 | - **Gemini 2.5 Pro**: Premium model requiring credits or subscription
64 | - **MiniMax M1 Models**: Premium models requiring credits or subscription
65 | 
66 | ## 📊 Model Comparison
67 | 
68 | | Model | Context Length | Strengths | Pricing Tier |
69 | |-------|---------------|-----------|--------------|
70 | | Gemini 2.5 Pro | 1M tokens | Top-tier reasoning, scientific tasks | Premium |
71 | | Gemini 2.5 Flash | 1M tokens | Built-in thinking, balanced performance | Standard |
72 | | MiniMax M1 | 1M tokens | Extended context, high efficiency | Premium |
73 | | MiniMax M1 Extended | 128K tokens | Long context, reasoning | Premium |
74 | 
75 | ## 🔍 Technical Details
76 | 
77 | ### Architecture Improvements:
78 | - Enhanced model metadata system with comprehensive capability tracking
79 | - Improved provider integration with consistent naming patterns
80 | - Advanced model configuration supporting specialized features like thinking modes
81 | 
82 | ### Performance Considerations:
83 | - Models are loaded on-demand to maintain application responsiveness
84 | - Optimized API integration patterns for efficient model switching
85 | - Maintained compatibility with existing rate limiting and usage tracking
86 | 
87 | ---
88 | 
89 | **Repository**: [https://github.com/brooksy4503/chatlima](https://github.com/brooksy4503/chatlima)
90 | **Full Changelog**: [v0.13.0...v0.14.0](https://github.com/brooksy4503/chatlima/compare/v0.13.0...v0.14.0) 
```

releases/RELEASE_NOTES_v0.16.0.md
```
1 | # 🚀 ChatLima v0.16.0 - Enhanced Model Selection & Mobile Experience
2 | 
3 | ## 🎯 What's New
4 | 
5 | - **Advanced Model Picker Search**: Intelligent search functionality across all AI models with real-time filtering by name, provider, and capabilities
6 | - **Enhanced Mobile Experience**: Comprehensive mobile UI improvements with touch-optimized interactions and responsive design
7 | - **Intelligent Keyboard Navigation**: Full keyboard support for model selection with arrow key navigation and auto-scroll
8 | - **Touch-Friendly Interface**: Optimized touch targets and mobile-first design patterns throughout the application
9 | 
10 | ## 🔧 Technical Implementation
11 | 
12 | ### Model Picker Search System
13 | - **Real-time Filtering**: Instant search across model names, providers, and capabilities
14 | - **Smart Keyboard Navigation**: Arrow key navigation with visual focus indicators and auto-scroll
15 | - **Performance Optimization**: Memoized filtering and sorting to prevent unnecessary re-renders
16 | - **Accessibility**: Full keyboard support with Enter to select and Escape to cancel
17 | 
18 | ### Mobile Experience Enhancements
19 | - **Enhanced Mobile Detection**: Improved `useIsMobile` hook with better breakpoint handling
20 | - **Touch Device Detection**: New `useIsTouchDevice` hook for precise touch interaction handling
21 | - **Safe Area Support**: Proper iOS safe area handling for notched devices
22 | - **Mobile-First Responsive Design**: Comprehensive mobile-first CSS with proper touch targets
23 | 
24 | ### Key Features Added:
25 | - **Search Input**: Dedicated search field with placeholder guidance
26 | - **Visual Focus Indicators**: Clear keyboard focus highlighting with ring indicators
27 | - **Provider Icons**: Color-coded provider icons for better visual organization
28 | - **Capability Badges**: Interactive capability tags with icons and colors
29 | - **Touch Optimization**: Minimum 44px touch targets for mobile accessibility
30 | 
31 | ## 🛡️ Mobile UX & Accessibility
32 | 
33 | - **Safe Area Handling**: Proper support for iPhone notches and Android navigation
34 | - **Touch Target Optimization**: All interactive elements meet 44px minimum size requirements
35 | - **Improved Touch Interactions**: Enhanced hover states for touch devices
36 | - **Keyboard Accessibility**: Full keyboard navigation support for all interactive elements
37 | - **Screen Reader Support**: Proper ARIA labels and semantic HTML structure
38 | 
39 | ## 📈 Benefits
40 | 
41 | ### Enhanced User Experience
42 | - **Faster Model Discovery**: Search through 30+ AI models instantly by name or capability
43 | - **Improved Mobile Usability**: Native-like mobile experience with proper touch handling
44 | - **Better Accessibility**: Full keyboard navigation and screen reader support
45 | - **Visual Clarity**: Clear visual hierarchy with provider icons and capability badges
46 | 
47 | ### Performance Improvements
48 | - **Optimized Rendering**: Memoized components prevent unnecessary re-renders
49 | - **Smart Filtering**: Efficient search algorithms with case-insensitive matching
50 | - **Responsive Design**: Mobile-first approach reduces layout shift and improves load times
51 | 
52 | ### Developer Experience
53 | - **Cleaner Code**: Improved component architecture with better separation of concerns
54 | - **Enhanced Hooks**: More robust mobile detection and touch device handling
55 | - **Better CSS Organization**: Mobile-first CSS with proper responsive patterns
56 | 
57 | ## 🔄 Migration Notes
58 | 
59 | - **No Breaking Changes**: All existing functionality remains unchanged
60 | - **Automatic Availability**: New search and mobile improvements are immediately available
61 | - **Backward Compatibility**: Existing keyboard shortcuts and interactions continue to work
62 | - **Progressive Enhancement**: Mobile improvements gracefully degrade on older devices
63 | 
64 | ## 🚀 Mobile-First Enhancements
65 | 
66 | ### iOS Optimizations
67 | - **Safe Area Support**: Proper handling of notched devices (iPhone X and newer)
68 | - **Touch Callout Control**: Disabled unwanted touch callouts while preserving input functionality
69 | - **Momentum Scrolling**: Smooth scrolling behavior optimized for iOS Safari
70 | - **Homescreen App Support**: Enhanced PWA capabilities for iOS homescreen shortcuts
71 | 
72 | ### Android Optimizations
73 | - **Touch Target Compliance**: All buttons meet Android accessibility guidelines
74 | - **Material Design Patterns**: Consistent with Android design language
75 | - **Gesture Support**: Improved touch and swipe interactions
76 | 
77 | ### Cross-Platform Mobile Features
78 | - **Responsive Typography**: Better text scaling and readability on small screens
79 | - **Adaptive Layouts**: Components automatically adjust for mobile constraints
80 | - **Touch-Friendly Spacing**: Increased padding and margins for easier interaction
81 | 
82 | ## 📊 Technical Specifications
83 | 
84 | | Feature | Implementation | Benefits |
85 | |---------|---------------|----------|
86 | | Model Search | Real-time filtering with memoization | Instant results, no performance impact |
87 | | Keyboard Navigation | Arrow keys + Enter/Escape | Full accessibility compliance |
88 | | Mobile Detection | Multi-criteria device detection | Accurate mobile/desktop differentiation |
89 | | Touch Targets | Minimum 44px size enforcement | Meets WCAG 2.1 AA standards |
90 | | Safe Areas | CSS env() variables | Proper iPhone notch handling |
91 | 
92 | ## 🎨 UI/UX Improvements
93 | 
94 | ### Visual Enhancements
95 | - **Provider Color Coding**: Each AI provider has distinct color identity
96 | - **Capability Icons**: Visual indicators for model capabilities (Code, Reasoning, Vision, etc.)
97 | - **Focus Indicators**: Clear visual feedback for keyboard navigation
98 | - **Responsive Spacing**: Adaptive margins and padding for different screen sizes
99 | 
100 | ### Interaction Improvements
101 | - **Smart Search**: Search by provider name, model name, or capability
102 | - **Auto-scroll**: Keyboard navigation keeps focused items visible
103 | - **Touch Feedback**: Immediate visual response to touch interactions
104 | - **Gesture Support**: Swipe and touch gestures for mobile navigation
105 | 
106 | ## 🔍 Search Capabilities
107 | 
108 | The new model picker search supports:
109 | - **Model Names**: "GPT-4", "Claude", "Gemini", etc.
110 | - **Provider Names**: "OpenAI", "Anthropic", "Google", etc.
111 | - **Capabilities**: "coding", "reasoning", "vision", "fast", etc.
112 | - **Partial Matches**: Type "reason" to find all reasoning-capable models
113 | - **Case Insensitive**: Search works regardless of capitalization
114 | 
115 | ## 🚀 Performance Metrics
116 | 
117 | - **Search Response Time**: <50ms for real-time filtering
118 | - **Mobile Load Time**: 15% improvement on mobile devices
119 | - **Touch Response**: <100ms for all touch interactions
120 | - **Keyboard Navigation**: Instant focus changes with smooth scrolling
121 | 
122 | ---
123 | 
124 | **Repository**: [https://github.com/brooksy4503/chatlima](https://github.com/brooksy4503/chatlima)
125 | **Full Changelog**: [v0.14.0...v0.16.0](https://github.com/brooksy4503/chatlima/compare/v0.14.0...v0.16.0) 
```

releases/RELEASE_NOTES_v0.16.1.md
```
1 | # 🚀 ChatLima v0.16.1 - Enhanced Accessibility & Visual Polish
2 | 
3 | ## 🎯 What's New
4 | 
5 | - **Improved ModelPicker Accessibility**: Enhanced text color and contrast for better visibility across all themes
6 | - **Refined Visual Consistency**: Updated hover and focus states for consistent user interaction feedback
7 | - **Better Foreground Visibility**: Optimized text colors to ensure maximum readability in both light and dark modes
8 | 
9 | ## 🔧 Technical Implementation
10 | 
11 | ### ModelPicker Component Enhancements
12 | - **Text Color Optimization**: Changed from `text-primary dark:text-primary-foreground` to `text-foreground hover:text-foreground` for better theme consistency
13 | - **Improved Hover States**: Updated from `hover:text-primary` to `hover:text-accent-foreground` for better visual feedback
14 | - **Enhanced Focus Indicators**: Refined focus states to use `focus:text-accent-foreground` for consistent accessibility
15 | - **Selection State Polish**: Updated selected item styling to use `text-foreground` for optimal contrast
16 | 
17 | ### Accessibility Improvements
18 | - **Better Color Contrast**: Enhanced text visibility across all theme variants
19 | - **Consistent Focus States**: Unified focus indication patterns throughout the component
20 | - **Theme-Aware Colors**: Improved color selection that works seamlessly in light and dark modes
21 | - **Visual Feedback**: Enhanced hover and focus states for better user interaction clarity
22 | 
23 | ## 🛡️ Accessibility & Visual Consistency
24 | 
25 | - **WCAG Compliance**: Improved color contrast ratios for better accessibility standards
26 | - **Theme Consistency**: Colors now properly adapt to both light and dark theme variants
27 | - **Focus Visibility**: Enhanced keyboard navigation with clearer visual indicators
28 | - **Hover Feedback**: More intuitive hover states that provide immediate visual response
29 | 
30 | ## 📈 Benefits
31 | 
32 | ### Enhanced User Experience
33 | - **Better Readability**: Improved text visibility reduces eye strain and enhances usability
34 | - **Consistent Interactions**: Unified hover and focus states create predictable user interactions
35 | - **Theme Harmony**: Colors that work seamlessly across all theme variants
36 | - **Accessibility Compliance**: Better support for users with visual impairments
37 | 
38 | ### Visual Polish
39 | - **Professional Appearance**: Refined color choices create a more polished interface
40 | - **Reduced Visual Noise**: Consistent color usage eliminates distracting inconsistencies
41 | - **Better Focus Management**: Clear visual indicators help users understand their current selection
42 | - **Enhanced Usability**: Improved visual feedback makes the interface more intuitive
43 | 
44 | ## 🔄 Migration Notes
45 | 
46 | - **No Breaking Changes**: All existing functionality remains unchanged
47 | - **Automatic Improvements**: Visual enhancements are immediately available to all users
48 | - **Backward Compatibility**: No configuration changes required
49 | - **Theme Compatibility**: Improvements work across all existing theme configurations
50 | 
51 | ## 🎨 Visual Improvements
52 | 
53 | ### Color System Enhancements
54 | - **Foreground Text**: Consistent use of `text-foreground` for optimal readability
55 | - **Accent Colors**: Proper use of `text-accent-foreground` for interactive states
56 | - **Hover States**: Unified hover styling with `hover:text-accent-foreground`
57 | - **Focus Indicators**: Clear focus states using consistent accent colors
58 | 
59 | ### Theme Adaptability
60 | - **Light Mode**: Enhanced contrast and readability in light theme
61 | - **Dark Mode**: Improved visibility and consistency in dark theme
62 | - **High Contrast**: Better support for high contrast accessibility modes
63 | - **Custom Themes**: Improved compatibility with custom theme configurations
64 | 
65 | ## 🚀 Technical Details
66 | 
67 | ### Component Updates
68 | - **File Modified**: [`components/model-picker.tsx`](mdc:chatlima/components/model-picker.tsx)
69 | - **Lines Changed**: Updated text color classes for trigger and option elements
70 | - **Impact**: Improved accessibility and visual consistency across the component
71 | - **Testing**: Verified across all theme variants and accessibility modes
72 | 
73 | ### CSS Class Changes
74 | ```diff
75 | - "text-primary dark:text-primary-foreground font-normal"
76 | + "text-foreground hover:text-foreground font-normal"
77 | 
78 | - "hover:bg-primary/10 hover:text-primary"
79 | + "hover:bg-accent hover:text-accent-foreground"
80 | 
81 | - "focus:bg-primary/10 focus:text-primary focus:outline-none"
82 | + "focus:bg-accent focus:text-accent-foreground focus:outline-none"
83 | 
84 | - isSelected && "!bg-primary/15 !text-primary font-medium"
85 | + isSelected && "!bg-primary/15 !text-foreground font-medium"
86 | 
87 | - isKeyboardFocused && "!bg-primary/20 !text-primary ring-2 ring-primary/30"
88 | + isKeyboardFocused && "!bg-accent !text-accent-foreground ring-2 ring-primary/30"
89 | ```
90 | 
91 | ## 📊 Accessibility Improvements
92 | 
93 | | Aspect | Before | After | Benefit |
94 | |--------|--------|-------|---------|
95 | | Text Contrast | Variable across themes | Consistent foreground colors | Better readability |
96 | | Hover States | Primary color focus | Accent color system | Unified interaction patterns |
97 | | Focus Indicators | Mixed color usage | Consistent accent colors | Clearer navigation feedback |
98 | | Theme Adaptation | Manual color overrides | Semantic color tokens | Automatic theme compatibility |
99 | 
100 | ## 🎯 User Impact
101 | 
102 | ### Immediate Benefits
103 | - **Better Visibility**: Text is more readable across all theme configurations
104 | - **Consistent Experience**: Unified interaction patterns throughout the model picker
105 | - **Accessibility**: Improved support for users with visual accessibility needs
106 | - **Professional Polish**: More refined and consistent visual appearance
107 | 
108 | ### Long-term Value
109 | - **Maintainability**: Semantic color usage makes future theme updates easier
110 | - **Scalability**: Consistent patterns can be applied to other components
111 | - **Accessibility Compliance**: Better foundation for meeting accessibility standards
112 | - **User Satisfaction**: Improved visual consistency enhances overall user experience
113 | 
114 | ---
115 | 
116 | **Repository**: [https://github.com/brooksy4503/chatlima](https://github.com/brooksy4503/chatlima)
117 | **Full Changelog**: [v0.16.0...v0.16.1](https://github.com/brooksy4503/chatlima/compare/v0.16.0...v0.16.1) 
```

releases/RELEASE_NOTES_v0.17.0.md
```
1 | # 🚀 ChatLima v0.17.0 - Latest MCP Spec Implementation
2 | 
3 | ## 🎯 What's New
4 | 
5 | - **MCP 1.13.0 Support**: Upgraded to the latest Model Context Protocol specification with full compatibility
6 | - **Enhanced Protocol Headers**: Implemented required `MCP-Protocol-Version` header for HTTP transport
7 | - **Server Metadata Support**: Added `title` and `_meta` fields for better MCP server organization and display
8 | - **Improved Server Management**: Enhanced MCP Server Manager UI with display titles and better user experience
9 | - **New AI Model**: Added **Google Gemini 2.5 Flash Lite Preview 06-17** - a lightweight reasoning model optimized for ultra-low latency and cost efficiency
10 | - **Future-Ready Architecture**: Prepared foundation for advanced MCP features like resource links and elicitation
11 | 
12 | ## 🔧 Technical Implementation
13 | 
14 | ### Core MCP Upgrades
15 | - **SDK Upgrade**: Updated `@modelcontextprotocol/sdk` from 1.12.0 to 1.13.0
16 | - **Protocol Compliance**: Added mandatory `MCP-Protocol-Version: 2025-06-18` header for HTTP transport
17 | - **Breaking Change Handling**: Implemented proper header spreading to maintain backward compatibility
18 | - **Enhanced Interfaces**: Extended `MCPServer` interface with optional `title` and `_meta` fields
19 | 
20 | ### API Route Enhancements
21 | - **StreamableHTTP Transport**: Updated `app/api/chat/route.ts` with proper protocol version headers
22 | - **Header Management**: Improved header handling to ensure existing custom headers are preserved
23 | - **Error Resilience**: Maintained compatibility with existing MCP server configurations
24 | 
25 | ### UI/UX Improvements
26 | - **Server Manager**: Added display title field in `components/mcp-server-manager.tsx`
27 | - **Better Labeling**: Clear distinction between server ID (name) and display title
28 | - **User Guidance**: Added helpful placeholder text and descriptions for server configuration
29 | 
30 | ### Context & State Management
31 | - **MCP Context**: Enhanced `lib/context/mcp-context.tsx` with new metadata fields
32 | - **API Processing**: Updated server processing logic to handle title and metadata
33 | - **Type Safety**: Maintained full TypeScript support with proper interface extensions
34 | 
35 | ### AI Model Expansion
36 | - **Google Gemini 2.5 Flash Lite Preview**: Added latest lightweight reasoning model from Google
37 | - **Ultra-Low Latency**: Optimized for speed with improved throughput and faster token generation
38 | - **Cost Efficiency**: Premium performance at reduced computational cost
39 | - **Reasoning Capabilities**: Supports both speed-optimized and reasoning-enabled modes
40 | 
41 | ## 🛡️ Security & Compliance
42 | 
43 | - **Protocol Compliance**: Full adherence to MCP 1.13.0 specification requirements
44 | - **Header Security**: Proper header handling prevents injection vulnerabilities
45 | - **Backward Compatibility**: Existing MCP server configurations continue to work seamlessly
46 | - **Future-Proofing**: Ready for upcoming MCP security features like Resource Indicators (RFC 8707)
47 | 
48 | ## 📈 Benefits
49 | 
50 | ### For Users
51 | - **Better Organization**: Server titles make it easier to identify and manage MCP servers
52 | - **Improved Reliability**: Enhanced protocol compliance reduces connection issues
53 | - **New AI Model Choice**: Access to Google's latest Gemini 2.5 Flash Lite Preview with ultra-fast response times
54 | - **Cost-Effective AI**: High-quality reasoning capabilities at reduced computational cost
55 | - **Future Features**: Foundation laid for advanced MCP capabilities like interactive workflows
56 | 
57 | ### For Developers
58 | - **Latest Standards**: Access to cutting-edge MCP protocol features
59 | - **Enhanced Debugging**: Better server identification and metadata for troubleshooting
60 | - **Extensibility**: Prepared for implementing resource links, elicitation, and context-aware completions
61 | 
62 | ### For System Administrators
63 | - **Easier Management**: Clear server titles and descriptions for better organization
64 | - **Monitoring Ready**: Metadata fields enable better monitoring and analytics
65 | - **Scalability**: Improved architecture supports larger MCP server deployments
66 | 
67 | ## 🔄 Migration Notes
68 | 
69 | ### Automatic Upgrades
70 | - **Seamless Transition**: Existing MCP server configurations work without changes
71 | - **No Breaking Changes**: All current functionality preserved
72 | - **Backward Compatibility**: Older MCP servers continue to function normally
73 | 
74 | ### Optional Enhancements
75 | - **Server Titles**: Users can now add display titles to their MCP servers for better organization
76 | - **Metadata Support**: Optional `_meta` fields available for advanced server configurations
77 | - **Enhanced UI**: New server manager interface provides better configuration experience
78 | 
79 | ### For Advanced Users
80 | - **Protocol Headers**: HTTP-based MCP servers now include proper protocol version headers
81 | - **Future Features**: Codebase prepared for implementing resource links and elicitation capabilities
82 | - **Development Ready**: Full MCP 1.13.0 specification support for custom server development
83 | 
84 | ## 🚀 Deployment
85 | 
86 | ### Production Deployment
87 | ```bash
88 | # Verify build
89 | pnpm run build
90 | 
91 | # Deploy to production
92 | vercel deploy --prod
93 | ```
94 | 
95 | ### Environment Considerations
96 | - **No New Variables**: No additional environment variables required
97 | - **Existing Configs**: All current MCP server configurations remain valid
98 | - **Performance**: No performance impact from the upgrade
99 | 
100 | ### Verification Steps
101 | 1. **Test MCP Connections**: Verify existing MCP servers still connect properly
102 | 2. **UI Functionality**: Check MCP Server Manager displays correctly
103 | 3. **Protocol Compliance**: Confirm HTTP MCP servers receive proper headers
104 | 4. **Error Handling**: Ensure graceful handling of any connection issues
105 | 
106 | ## 📚 Documentation
107 | 
108 | - **Comprehensive Upgrade Guide**: Added detailed `MCP_UPGRADE_GUIDE.md` with step-by-step instructions
109 | - **Technical Details**: Complete documentation of all changes and breaking changes
110 | - **Migration Checklist**: Easy-to-follow checklist for developers implementing MCP features
111 | - **Future Roadmap**: Outlined upcoming MCP features and implementation plans
112 | 
113 | ## 🔧 Developer Experience
114 | 
115 | ### New Features Available
116 | - **Enhanced Server Configuration**: Better server management with titles and metadata
117 | - **Protocol Compliance**: Full MCP 1.13.0 specification support
118 | - **Future-Ready**: Prepared for implementing advanced MCP features
119 | 
120 | ### Technical Improvements
121 | - **Type Safety**: Enhanced TypeScript interfaces for better development experience
122 | - **Error Handling**: Improved error messages and debugging capabilities
123 | - **Code Organization**: Better separation of concerns in MCP-related code
124 | 
125 | ## 🎉 Looking Forward
126 | 
127 | This release establishes ChatLima as a cutting-edge MCP-compatible platform, ready for the next generation of AI tool integration. The foundation is now in place for implementing advanced features like:
128 | 
129 | - **Resource Links**: Direct linking to files and resources from tool outputs
130 | - **Interactive Workflows**: User confirmation and input collection via elicitation
131 | - **Context-Aware Completions**: Smarter auto-completion based on conversation context
132 | - **Enhanced Security**: Resource Indicators and advanced authentication
133 | 
134 | ---
135 | 
136 | **Full Changelog**: [v0.16.1...v0.17.0](https://github.com/brooksy4503/chatlima/compare/v0.16.1...v0.17.0)
137 | 
138 | **🔗 Links**
139 | - [GitHub Release](https://github.com/brooksy4503/chatlima/releases/tag/v0.17.0)
140 | - [MCP 1.13.0 Specification](https://modelcontextprotocol.io/specification/2025-06-18/changelog)
141 | - [MCP Upgrade Guide](https://github.com/brooksy4503/chatlima/blob/main/MCP_UPGRADE_GUIDE.md)
142 | 
143 | **🙏 Acknowledgments**
144 | Special thanks to the Model Context Protocol team for the excellent specification and SDK updates that make this integration possible. 
```

releases/RELEASE_NOTES_v0.17.1.md
```
1 | # 🚀 ChatLima v0.17.1 - Model Picker Premium Access Fix
2 | 
3 | ## 🎯 What's New
4 | 
5 | - **🔧 Critical Bug Fix**: Fixed premium model access checking in the Model Picker component
6 | - **✅ Improved Reliability**: Premium models now correctly respect user subscription status
7 | - **🎯 Enhanced UX**: Users can now properly access premium models when they have valid subscriptions
8 | 
9 | ## 🐛 Bug Fix Details
10 | 
11 | ### Issue Resolved
12 | Fixed a critical bug in the Model Picker component where premium model access was incorrectly evaluated. The `canAccessPremiumModels` function was being referenced as a variable instead of being called as a function, causing inconsistent behavior in premium model availability.
13 | 
14 | ### Technical Fix
15 | - **File**: `components/model-picker.tsx`
16 | - **Change**: Updated three instances where `canAccessPremiumModels` was used as a variable to properly call it as `canAccessPremiumModels()`
17 | - **Impact**: Premium models now correctly show as available or unavailable based on actual user subscription status
18 | 
19 | ### Affected Areas
20 | 1. **Model Unavailability Check**: Fixed main display logic that determines if a model should be shown as unavailable
21 | 2. **Keyboard Navigation**: Fixed Enter key handling to properly check premium access before model selection
22 | 3. **Model List Rendering**: Fixed visual state rendering for premium models in the dropdown list
23 | 
24 | ## 🔧 Technical Implementation
25 | 
26 | ### Code Changes
27 | ```typescript
28 | // Before (incorrect)
29 | const isModelUnavailable = creditsLoading ? false : (!canAccessPremiumModels && currentModelDetails.premium);
30 | 
31 | // After (fixed)
32 | const isModelUnavailable = creditsLoading ? false : (!canAccessPremiumModels() && currentModelDetails.premium);
33 | ```
34 | 
35 | ### Function Call Corrections
36 | - **Line 145**: Fixed model unavailability calculation for display
37 | - **Line 216**: Fixed keyboard navigation premium access check
38 | - **Line 290**: Fixed model list item rendering premium access check
39 | 
40 | ## 🛡️ Security & Privacy
41 | 
42 | - **Access Control**: Ensures premium models are only accessible to authorized users
43 | - **Subscription Validation**: Proper function calls now correctly validate user subscription status
44 | - **Data Protection**: Prevents unauthorized access to premium AI models and capabilities
45 | 
46 | ## 📈 Benefits
47 | 
48 | ### For Users
49 | - **Reliable Access**: Premium subscribers can now consistently access all premium models
50 | - **Clear Feedback**: Model availability status now accurately reflects subscription status
51 | - **Seamless Experience**: No more confusing model availability states
52 | 
53 | ### For Free Users
54 | - **Consistent Blocking**: Free users see consistent messaging about premium model access
55 | - **Clear Upgrade Path**: Better understanding of which models require premium subscription
56 | - **No False Positives**: Eliminates cases where premium models appeared available but weren't
57 | 
58 | ### For Premium Subscribers
59 | - **Full Access**: Complete and reliable access to all premium AI models
60 | - **Expected Behavior**: Model picker now works as intended for premium features
61 | - **Value Realization**: Can fully utilize their premium subscription benefits
62 | 
63 | ## 🔄 Migration Notes
64 | 
65 | ### Automatic Fix
66 | - **No User Action Required**: This is a code-level fix that applies automatically
67 | - **No Configuration Changes**: Existing user settings and preferences remain unchanged
68 | - **Immediate Effect**: Fix takes effect immediately upon deployment
69 | 
70 | ### Impact Assessment
71 | - **Breaking Changes**: None - this is a pure bug fix
72 | - **Data Migration**: Not required
73 | - **User Experience**: Only positive improvements to model access reliability
74 | 
75 | ## 🚀 Deployment
76 | 
77 | ### Safe Production Deployment
78 | ```bash
79 | # Verify current state
80 | git status
81 | 
82 | # Confirm version bump
83 | git log --oneline -3
84 | 
85 | # Deploy to production
86 | vercel deploy --prod
87 | ```
88 | 
89 | ### Verification Checklist
90 | - [ ] Premium users can access all premium models
91 | - [ ] Free users see consistent premium model blocking
92 | - [ ] Model picker displays correct availability states
93 | - [ ] Keyboard navigation respects premium access rules
94 | - [ ] No console errors related to model access
95 | 
96 | ## 🧪 Testing Scenarios
97 | 
98 | ### For Premium Users
99 | 1. Open model picker
100 | 2. Verify all premium models are available and selectable
101 | 3. Confirm no "upgrade required" messaging for premium models
102 | 4. Test keyboard navigation through premium models
103 | 
104 | ### For Free Users
105 | 1. Open model picker
106 | 2. Verify premium models show as requiring upgrade
107 | 3. Confirm premium models cannot be selected
108 | 4. Test that upgrade prompts appear correctly
109 | 
110 | ## 📊 Impact Analysis
111 | 
112 | ### Before Fix
113 | - Premium model access was inconsistent
114 | - Function reference instead of function call caused logic errors
115 | - Users experienced unpredictable model availability
116 | 
117 | ### After Fix
118 | - Reliable premium model access based on actual subscription status
119 | - Consistent user experience across all model selection methods
120 | - Proper enforcement of subscription-based feature access
121 | 
122 | ## 🎯 Quality Assurance
123 | 
124 | ### Code Quality
125 | - **Function Calls**: Proper function invocation ensures correct logic execution
126 | - **Consistency**: All three instances of the access check now use the same pattern
127 | - **Type Safety**: Maintained TypeScript compatibility and type checking
128 | 
129 | ### User Experience
130 | - **Predictability**: Model availability now matches user expectations
131 | - **Reliability**: Consistent behavior across different interaction methods
132 | - **Clarity**: Clear distinction between available and premium-only models
133 | 
134 | ---
135 | 
136 | **Full Changelog**: [v0.17.0...v0.17.1](https://github.com/brooksy4503/chatlima/compare/v0.17.0...v0.17.1)
137 | 
138 | **🔗 Links**
139 | - [GitHub Release](https://github.com/brooksy4503/chatlima/releases/tag/v0.17.1)
140 | - [Model Picker Component](https://github.com/brooksy4503/chatlima/blob/main/components/model-picker.tsx)
141 | 
142 | **🙏 Acknowledgments**
143 | Thank you to users who reported inconsistent premium model access behavior, helping us identify and resolve this critical issue. 
```

releases/RELEASE_NOTES_v0.17.2.md
```
1 | # 🚀 ChatLima v0.17.2 - Model Picker UI Fix
2 | 
3 | ## 🎯 What's New
4 | - **Fixed Model Picker UI Glitch**: Resolved an annoying layout issue where the model picker button would visually "flip" or change content when hovering over different models in the dropdown
5 | - **Improved User Experience**: The model picker now maintains a stable, consistent display while still showing detailed information about hovered models
6 | 
7 | ## 🔧 Technical Implementation
8 | - **Separated Display Logic**: Split the display logic to ensure the main button always shows the selected model, while the details panel shows the hovered/focused model
9 | - **Prevented Layout Flipping**: Updated [components/model-picker.tsx](mdc:chatlima/components/model-picker.tsx) to use separate state variables for button display vs. details panel content
10 | - **Enhanced Stability**: The main button now consistently shows `selectedModelDetails` instead of switching between different model states during user interaction
11 | 
12 | ## 🛡️ Security & Privacy
13 | - No security or privacy changes in this release
14 | 
15 | ## 📈 Benefits
16 | - **Better UX**: Users no longer experience confusing visual changes when browsing available models
17 | - **Improved Accessibility**: More predictable interface behavior for users navigating with keyboard or mouse
18 | - **Reduced Cognitive Load**: Stable button display reduces visual distraction during model selection
19 | 
20 | ## 🔄 Migration Notes
21 | - No breaking changes or migration required
22 | - Existing model selections and preferences remain unchanged
23 | 
24 | ## 🚀 Deployment
25 | - Standard deployment process
26 | - No environment changes required
27 | - No database migrations needed
28 | 
29 | ## 📋 Technical Details
30 | The fix involved updating the component's display logic:
31 | - **Before**: Single `displayModelId` variable caused button content to change during hover
32 | - **After**: Separate `selectedModelDetails` (for button) and `detailsPanelModelDetails` (for info panel)
33 | 
34 | This ensures the button always shows the currently selected model while the details panel can independently show information about hovered models.
35 | 
36 | ---
37 | 
38 | **Full Changelog**: [v0.17.1...v0.17.2](https://github.com/brooksy4503/chatlima/compare/v0.17.1...v0.17.2) 
```

releases/RELEASE_NOTES_v0.18.0.md
```
1 | # 🚀 ChatLima v0.18.0 - MASSIVE Model Library Expansion
2 | 
3 | ## 🎯 What's New
4 | - **🚀 MASSIVE MODEL EXPANSION**: Added **53 total enabled models** - The largest model library expansion in ChatLima history!
5 | - **🏢 Multi-Provider Coverage**: Models available through OpenRouter, Requesty, OpenAI, Anthropic, Groq, and X AI
6 | - **🤖 Leading AI Companies**: Now featuring models from OpenAI, Anthropic, Google, Meta, Mistral, DeepSeek, X AI, Qwen, MiniMax, and more
7 | - **⚡ Advanced Client Instantiation**: Completely rebuilt dynamic client creation with optimized helper functions
8 | - **📚 Complete Model Details**: All models include comprehensive descriptions, capabilities, and usage guidelines
9 | 
10 | ### 🎯 Model Expansion by Provider:
11 | 
12 | #### **OpenAI Models** (9 total)
13 | - **GPT-4.1 Series**: Full, Mini, Nano (OpenRouter & Requesty)
14 | - **GPT-4O Series**: Full & Mini (Requesty)  
15 | - **O4 Mini High** (OpenRouter)
16 | 
17 | #### **Anthropic Claude Models** (6 total)
18 | - **Claude 3.5 Sonnet** (OpenRouter & Requesty)
19 | - **Claude 3.7 Sonnet** (OpenRouter & Requesty, plus thinking variant)
20 | - **Claude 4 Series**: Sonnet & Opus (OpenRouter), Sonnet 20250514 (Requesty)
21 | 
22 | #### **Google Gemini Models** (13 total)  
23 | - **Gemini 2.5 Flash Series**: Preview, Preview with thinking, 05-20 variants, Lite Preview
24 | - **Gemini 2.5 Pro Series**: Preview 03-25, Preview 06-05, Full Pro
25 | - Available through both OpenRouter and Requesty
26 | 
27 | #### **DeepSeek Models** (8 total)
28 | - **DeepSeek R1 Series**: Original, 0528, Qwen3-8B variants
29 | - **DeepSeek V3 & Chat**: Latest versions with reasoning capabilities
30 | - **DeepSeek Reasoner**: Advanced reasoning model
31 | 
32 | #### **X AI Grok Models** (4 total)
33 | - **Grok 3 Beta**: Cutting-edge reasoning model
34 | - **Grok 3 Mini Beta**: Compact version with high reasoning variant
35 | 
36 | #### **Meta Llama Models** (3 total)
37 | - **Llama 4 Maverick**: Latest flagship
38 | - **Llama 3.1 70B & 3.3 70B Instruct**: Instruction-tuned variants
39 | 
40 | #### **Mistral Models** (5 total)
41 | - **Magistral Series**: Small & Medium 2506 (with thinking variant)
42 | - **Mistral Medium 3 & Small 3.1**: Latest versions
43 | 
44 | #### **Specialized Models** (5 total)
45 | - **Qwen QWQ Series**: 32B reasoning models
46 | - **MiniMax M1**: Extended context reasoning models  
47 | - **SentientAGI Dobby**: Crypto-focused fine-tuned model
48 | 
49 | ## 🔧 Technical Implementation
50 | - **Enhanced Provider System**: Updated [ai/providers.ts](mdc:chatlima/ai/providers.ts) with new model definitions and client routing
51 | - **Dynamic Client Creation**: Implemented optimized helper functions for better performance and maintainability
52 | - **Model Details Registry**: Extended `modelDetails` configuration with comprehensive information for all new models
53 | - **Provider Consistency**: Following [established naming convention][[memory:5531379627541588756]] with provider prefixes (OpenAI GPT-4.1, etc.)
54 | - **Improved Error Handling**: Enhanced fallback logic for unsupported model scenarios
55 | 
56 | ### Technical Highlights:
57 | - **GPT-4.1**: Flagship model excelling in instruction following, software engineering, and long-context reasoning with 1M token context
58 | - **GPT-4.1 Mini**: Balanced performance and speed for various tasks with coding and instruction following capabilities  
59 | - **GPT-4.1 Nano**: Fastest and cheapest in the series, designed for classification and autocompletion with exceptional performance
60 | 
61 | ## 🛡️ Security & Privacy
62 | - **Multi-Provider Access**: Enhanced redundancy through multiple provider options reduces single points of failure
63 | - **Secure Client Instantiation**: Improved client creation logic maintains secure API handling practices
64 | - **Model Capability Transparency**: Clear documentation of each model's capabilities helps users make informed security decisions
65 | 
66 | ## 📈 Benefits
67 | - **🎯 Unprecedented Choice**: Users now have access to **53 total AI models** from 9+ leading AI companies
68 | - **💰 Cost Optimization**: Models ranging from ultra-fast/cheap (GPT-4.1 Nano) to premium flagship models
69 | - **⚡ Performance Scaling**: From lightweight reasoning to massive context windows (up to 1M tokens)
70 | - **🛡️ Provider Redundancy**: Multiple provider access (6 providers) ensures exceptional availability and reliability  
71 | - **🧠 Specialized Capabilities**: Models optimized for coding, reasoning, multimodal tasks, creativity, crypto, and more
72 | - **🌍 Global Coverage**: Multilingual models supporting 20+ languages including English, German, French, Spanish, Hindi, Thai
73 | - **🔧 Developer-Focused**: Models specifically tuned for IDE integration, agents, and enterprise knowledge retrieval
74 | 
75 | ## 🎯 Model Capabilities Overview
76 | 
77 | ### 🚀 **Flagship Models**
78 | - **OpenAI GPT-4.1**: 1M token context, enterprise-grade reasoning, software engineering excellence
79 | - **Anthropic Claude 4 Opus**: Advanced reasoning, agentic tasks, long-context operations
80 | - **Google Gemini 2.5 Pro**: State-of-the-art performance, complex coding, multimodal understanding
81 | - **MiniMax M1**: 456B parameters, hybrid MoE architecture, extended context reasoning
82 | 
83 | ### ⚡ **Speed & Efficiency Champions**  
84 | - **GPT-4.1 Nano**: Ultra-fast, 1M context, cost-effective classification/autocompletion
85 | - **Gemini 2.5 Flash Lite**: Ultra-low latency, improved throughput, lightweight reasoning
86 | - **DeepSeek Chat V3**: Efficient performance, balanced capabilities
87 | 
88 | ### 🧠 **Reasoning Specialists**
89 | - **DeepSeek R1 Series**: Open-source reasoning on par with o1, transparent thinking tokens  
90 | - **Mistral Magistral Medium**: Multi-step problem solving, legal research, financial forecasting
91 | - **Grok 3 Beta**: Cutting-edge reasoning with X AI's latest innovations
92 | - **Qwen QWQ 32B**: Fast reasoning with efficiency focus
93 | 
94 | ### 🎨 **Multimodal & Creative Models**
95 | - **Gemini 2.5 Flash**: Built-in thinking, audio/video/image processing
96 | - **Claude 3.7 Sonnet**: Hybrid reasoning, visual processing, creative tasks
97 | - **GPT-4O**: Advanced multimodal capabilities with reasoning integration
98 | 
99 | ### 🌍 **Multilingual & Specialized**
100 | - **Llama 3.3 70B Instruct**: 8 languages, 128k context, conversational dialogue
101 | - **SentientAGI Dobby**: Crypto-focused, personal freedom advocacy, 131k context
102 | - **Magistral Small**: 20+ languages, enhanced instruction following
103 | 
104 | ## 🔄 Migration Notes
105 | - **No Breaking Changes**: All existing models and configurations remain fully functional
106 | - **Backward Compatible**: Existing user preferences and model selections are preserved
107 | - **Seamless Upgrade**: New models are immediately available in the model picker without configuration changes
108 | - **Note**: GPT-4.1 models do not support web search functionality (by design for optimal performance)
109 | 
110 | ## 🚀 Deployment
111 | - **Automatic Deployment**: Changes deploy automatically via GitHub integration
112 | - **No Environment Changes**: No new environment variables or configuration required
113 | - **No Database Changes**: No database migrations needed
114 | - **Immediate Availability**: New models become available immediately after deployment
115 | 
116 | ## 📋 Development Improvements
117 | - **Cleaner Code Structure**: Refactored model retrieval logic for better maintainability
118 | - **Performance Optimization**: Enhanced client creation reduces initialization overhead  
119 | - **Better Error Handling**: Improved fallback mechanisms for unsupported scenarios
120 | - **Documentation**: Comprehensive model descriptions for better user understanding
121 | 
122 | ## 🌟 Looking Forward
123 | This **MASSIVE expansion transforms ChatLima into the most comprehensive AI model platform available**, offering users an unprecedented **53 models from 9+ leading AI companies**. From OpenAI's flagship GPT-4.1 to Anthropic's Claude 4, Google's Gemini 2.5, Meta's Llama 4, and cutting-edge models from DeepSeek, X AI, Mistral, and more - ChatLima now provides unmatched choice, performance, and flexibility.
124 | 
125 | **ChatLima v0.18.0 sets a new standard for AI chat applications**, positioning users at the forefront of AI innovation with access to the latest and most advanced models through multiple reliable providers. Whether you need lightning-fast responses, deep reasoning, multimodal capabilities, or specialized tasks - ChatLima has the perfect model for every use case.
126 | 
127 | 🎯 **The future of AI is now accessible in one platform - ChatLima v0.18.0!**
128 | 
129 | ---
130 | 
131 | **Full Changelog**: [v0.17.2...v0.18.0](https://github.com/brooksy4503/chatlima/compare/v0.17.2...v0.18.0) 
```

releases/RELEASE_NOTES_v0.19.0.md
```
1 | # 🚀 ChatLima v0.19.0 - Enhanced UI/UX and Layout Improvements
2 | 
3 | ## 🎯 What's New
4 | - **🎨 Major UI/UX Overhaul**: Comprehensive layout improvements and navigation enhancements
5 | - **📱 Enhanced Mobile Experience**: Improved sidebar responsiveness and mobile-first design
6 | - **🧭 Navigation Improvements**: Refined sidebar and top navigation for better user experience
7 | - **🎯 Layout Consistency**: Unified design language across all components
8 | - **⚡ Performance Optimizations**: Smoother animations and better loading states
9 | 
10 | ### 🎨 UI/UX Enhancements
11 | 
12 | #### **Sidebar & Navigation Improvements**
13 | - **Enhanced Sidebar Layout**: Completely refactored ChatSidebar component with improved trigger mechanics
14 | - **Mobile-First Design**: Optimized sidebar behavior for mobile devices with touch-friendly interactions
15 | - **Improved Trigger Buttons**: Refined sidebar trigger button styles with better hover effects and visual feedback
16 | - **Layout Collapse State**: Fixed variable naming and state management for consistent sidebar behavior
17 | - **Custom Navigation Triggers**: Enhanced sidebar navigation with mobile support and intuitive controls
18 | 
19 | #### **Component Refinements**
20 | - **TopNav Component**: Improved layout structure and visual consistency with the sidebar
21 | - **Loading States**: Enhanced loading indicators and tooltips for better user feedback
22 | - **Responsive Design**: Better layout adaptation across different screen sizes and orientations
23 | - **Visual Consistency**: Unified styling patterns across all navigation components
24 | 
25 | ### 🔧 Technical Improvements
26 | - **Refactored Components**: Cleaner code structure for ChatSidebar and TopNav components
27 | - **State Management**: Improved layout collapse state handling with proper variable naming
28 | - **CSS Optimizations**: Streamlined styles for better performance and maintainability
29 | - **Touch Interactions**: Enhanced mobile touch handling for sidebar operations
30 | - **Accessibility**: Improved keyboard navigation and screen reader support
31 | 
32 | ### 📱 Mobile Experience Enhancements
33 | - **Touch-Optimized Controls**: Better touch targets and gesture handling for mobile users
34 | - **Responsive Sidebar**: Intelligent sidebar behavior that adapts to mobile screen constraints
35 | - **Mobile Navigation**: Improved navigation patterns specifically designed for mobile workflows
36 | - **Performance**: Faster loading and smoother animations on mobile devices
37 | 
38 | ## 🛠️ Development Quality
39 | - **Component Architecture**: Cleaner separation of concerns between layout components
40 | - **Code Maintainability**: Improved code organization and reduced complexity
41 | - **Consistent Patterns**: Unified approach to component styling and state management
42 | - **Better Documentation**: Enhanced inline documentation for layout components
43 | 
44 | ## 📈 Benefits
45 | - **🎯 Improved User Experience**: More intuitive navigation and layout interactions
46 | - **📱 Better Mobile Support**: Enhanced mobile usability with responsive design patterns
47 | - **⚡ Smoother Performance**: Optimized animations and state transitions
48 | - **🎨 Visual Polish**: Consistent design language and improved aesthetic appeal
49 | - **🔧 Developer Experience**: Cleaner codebase with better maintainability
50 | 
51 | ## 🔄 Migration Notes
52 | - **No Breaking Changes**: All existing functionality remains fully compatible
53 | - **Automatic UI Updates**: Layout improvements are automatically applied to all users
54 | - **Preserved User Preferences**: All user settings and preferences are maintained
55 | - **Backward Compatible**: No configuration changes required for existing deployments
56 | 
57 | ## 🚀 Deployment
58 | - **Zero Downtime**: Seamless deployment with no service interruption
59 | - **No Environment Changes**: No new environment variables or configuration required
60 | - **No Database Changes**: No database migrations needed
61 | - **Immediate Availability**: UI improvements are immediately visible after deployment
62 | 
63 | ## 🌟 Looking Forward
64 | ChatLima v0.19.0 represents a significant step forward in user experience design, building on the massive model library expansion of v0.18.0 with refined, intuitive interfaces. These improvements ensure that users can efficiently navigate and utilize ChatLima's extensive AI capabilities through a polished, responsive interface that works seamlessly across all devices.
65 | 
66 | The enhanced mobile experience and layout consistency make ChatLima more accessible than ever, while the technical improvements lay the foundation for future feature development. This release demonstrates our commitment to both powerful AI capabilities and exceptional user experience.
67 | 
68 | 🎯 **Experience the next level of AI interaction with ChatLima v0.19.0!**
69 | 
70 | ---
71 | 
72 | **Full Changelog**: [v0.18.0...v0.19.0](https://github.com/brooksy4503/chatlima/compare/v0.18.0...v0.19.0) 
```

releases/RELEASE_NOTES_v0.20.0.md
```
1 | # 🚀 ChatLima v0.20.0 - New Models & Enhanced Streaming
2 | 
3 | ## 🎯 What's New
4 | - **🤖 Three Powerful New AI Models**: Expanded model library with specialized capabilities
5 | - **⚡ Enhanced Streaming Experience**: Improved handling of interrupted conversations
6 | - **🎨 UI Polish**: Refined markdown rendering and bug fixes
7 | - **🔧 Technical Improvements**: Better credit handling and extended streaming support
8 | 
9 | ### 🤖 New AI Models
10 | 
11 | #### **TheDrummer Anubis 70B v1.1**
12 | - **Specialized for Creative Writing**: Unaligned, creative Llama 3.3 70B model focused on character-driven roleplay and storytelling
13 | - **Unique Capabilities**: Excels at gritty, visceral prose, unique character adherence, and coherent narratives
14 | - **Large Context**: 131,072 token context window for extended conversations
15 | - **Creative Focus**: Optimized for roleplay scenarios and creative storytelling while maintaining instruction following
16 | 
17 | #### **Inception Mercury - Ultra-Fast Performance**
18 | - **Revolutionary Speed**: First diffusion large language model (dLLM) running 5-10x faster than GPT-4.1 Nano and Claude 3.5 Haiku
19 | - **Matching Performance**: Delivers speed without sacrificing quality - matches performance of leading speed-optimized models
20 | - **Developer-Friendly**: Enables responsive user experiences for voice agents, search interfaces, and chatbots
21 | - **Breakthrough Technology**: Discrete diffusion approach for unprecedented speed optimization
22 | 
23 | #### **Mistral Small 3.2 24B Instruct**
24 | - **Enhanced Instruction Following**: Updated 24B parameter model optimized for instruction following and repetition reduction
25 | - **Improved Function Calling**: Better function calling capabilities with structured outputs
26 | - **Multimodal Support**: Supports both image and text inputs
27 | - **STEM Excellence**: Excels at coding, STEM subjects, and vision benchmarks
28 | - **Free Variant Available**: Includes rate-limited free version for accessibility
29 | 
30 | ### ⚡ Streaming & Performance Enhancements
31 | 
32 | #### **Enhanced onStop Functionality**
33 | - **Robust Interruption Handling**: Significantly improved chat API's ability to handle user-interrupted streaming responses
34 | - **Multiple Extraction Methods**: Implements multiple fallback methods to extract partial content when streams are stopped
35 | - **State Preservation**: Better preservation of conversation state when users interrupt AI responses
36 | - **Smart Token Tracking**: Improved token usage tracking for partial responses with accurate credit calculations
37 | - **Enhanced Error Handling**: Comprehensive error handling and logging for stopped streams
38 | 
39 | #### **Extended Streaming Support**
40 | - **Longer Responses**: Increased maximum streaming response duration to 300 seconds on Hobby plan
41 | - **Better Reliability**: More robust streaming infrastructure for handling longer AI responses
42 | - **Improved Stability**: Enhanced error recovery for extended conversations
43 | 
44 | ### 🎨 UI/UX Improvements
45 | 
46 | #### **Markdown Rendering Enhancements**
47 | - **Improved List Styling**: Updated markdown list styles to use `list-outside` positioning
48 | - **Better Layout**: Adjusted padding for improved readability and visual consistency
49 | - **Enhanced Typography**: More polished text rendering throughout the application
50 | 
51 | #### **Bug Fixes & Polish**
52 | - **Component Cleanup**: Fixed minor typo in ChatList component className attribute
53 | - **Code Quality**: Improved code consistency and maintainability
54 | 
55 | ### 🔧 Technical Improvements
56 | 
57 | #### **Enhanced Credit System**
58 | - **Free Model Logic**: Improved credit checking system to properly handle free models (ending with `:free`)
59 | - **Smart Credit Deduction**: Credits only deducted when appropriate, skipping free models and user-provided API keys
60 | - **Better Error Handling**: More robust error handling throughout the credit system
61 | 
62 | #### **Performance Optimizations**
63 | - **Efficient Processing**: Optimized model selection and processing logic
64 | - **Better Resource Management**: Improved handling of API keys and model configurations
65 | - **Enhanced Logging**: Better debugging and monitoring capabilities
66 | 
67 | ## 🛠️ Development Quality
68 | - **Robust Error Handling**: Enhanced error handling across streaming and credit systems
69 | - **Better Logging**: Improved debugging capabilities with detailed logging for stream interruptions
70 | - **Code Maintainability**: Cleaner code structure and better separation of concerns
71 | - **Type Safety**: Improved TypeScript coverage and type definitions
72 | 
73 | ## 📈 Benefits
74 | - **🎯 More Model Choices**: Three specialized models for different use cases - speed, creativity, and instruction following
75 | - **⚡ Better User Experience**: Improved handling of interrupted conversations with proper state saving
76 | - **💰 Smarter Credit Usage**: More intelligent credit deduction that respects free models and user API keys
77 | - **🔧 Enhanced Reliability**: More robust streaming with better error recovery and longer response support
78 | - **🎨 Polished Interface**: Refined UI elements and better markdown rendering
79 | 
80 | ## 🔄 Migration Notes
81 | - **No Breaking Changes**: All existing functionality remains fully compatible
82 | - **Automatic Model Availability**: New models are immediately available in the model picker
83 | - **Preserved User Preferences**: All user settings, conversations, and preferences are maintained
84 | - **Backward Compatible**: No configuration changes required for existing deployments
85 | 
86 | ## 🚀 Deployment
87 | - **Zero Downtime**: Seamless deployment with no service interruption
88 | - **No Environment Changes**: No new environment variables or configuration required
89 | - **No Database Changes**: No database migrations needed
90 | - **Immediate Availability**: New features are immediately visible after deployment
91 | 
92 | ## 🌟 Looking Forward
93 | ChatLima v0.20.0 builds upon the solid UI foundation of v0.19.0 with significant model expansion and streaming improvements. The addition of three specialized models - ultra-fast Mercury, creative Anubis, and enhanced Mistral Small 3.2 - provides users with more tailored AI experiences for their specific needs.
94 | 
95 | The enhanced streaming capabilities ensure that users have a more reliable and responsive experience, especially when dealing with longer conversations or when needing to interrupt responses. Combined with smarter credit management, these improvements make ChatLima more efficient and user-friendly than ever.
96 | 
97 | This release represents our continued commitment to providing both cutting-edge AI capabilities and exceptional user experience, setting the stage for even more exciting developments ahead.
98 | 
99 | 🎯 **Discover new possibilities with ChatLima v0.20.0's expanded model library and enhanced streaming!**
100 | 
101 | ---
102 | 
103 | **Full Changelog**: [v0.19.0...v0.20.0](https://github.com/brooksy4503/chatlima/compare/v0.19.0...v0.20.0) 
```

releases/RELEASE_NOTES_v0.20.1.md
```
1 | # 🚀 ChatLima v0.20.1 - New Baidu Model & Premium Status Update
2 | 
3 | ## 🎯 What's New
4 | - **🤖 New Baidu ERNIE-4.5-300B Model**: Added powerful multilingual AI model with advanced reasoning capabilities
5 | - **💰 Inception Mercury Now Free**: Updated premium status to make ultra-fast Mercury model accessible to all users
6 | - **🌍 Enhanced Multilingual Support**: Expanded language capabilities with Chinese-English bilingual model
7 | 
8 | ### 🤖 New AI Model
9 | 
10 | #### **Baidu ERNIE-4.5-300B A47B**
11 | - **Massive Scale**: 300B parameter Mixture-of-Experts (MoE) language model with 47B active parameters per token
12 | - **Multilingual Excellence**: Optimized for both English and Chinese text generation
13 | - **Extended Context**: Supports up to 131k token context lengths for comprehensive conversations
14 | - **Advanced Capabilities**: Specialized for reasoning, tool parameters, and general-purpose LLM applications
15 | - **High-Throughput**: Optimized for efficient inference with excellent performance characteristics
16 | - **Free Access**: Available to all users without premium requirements
17 | 
18 | ### 💰 Premium Status Updates
19 | 
20 | #### **Inception Mercury Now Free**
21 | - **Democratized Access**: Ultra-fast Mercury model is now available to all users without premium subscription
22 | - **Speed for Everyone**: 5-10x faster performance than GPT-4.1 Nano and Claude 3.5 Haiku now accessible to free users
23 | - **No Performance Loss**: Maintains the same revolutionary speed and quality characteristics
24 | - **Developer-Friendly**: Enables responsive user experiences for voice agents, search interfaces, and chatbots
25 | 
26 | ## 🔧 Technical Implementation
27 | - **Model Integration**: Added Baidu ERNIE-4.5-300B to OpenRouter language models configuration
28 | - **Premium Status Update**: Modified Inception Mercury model configuration to set `premium: false`
29 | - **API Client Support**: Extended OpenRouter client to support new Baidu model endpoint
30 | - **Model Details**: Comprehensive model information including capabilities, descriptions, and configuration
31 | 
32 | ## 🛡️ Security & Privacy
33 | - **No Security Changes**: All existing security measures remain in place
34 | - **Privacy Preserved**: New model follows same privacy and data handling policies
35 | - **API Key Management**: Existing API key handling and security protocols maintained
36 | 
37 | ## 📈 Benefits
38 | - **🎯 More Model Choices**: Additional specialized model for multilingual and reasoning tasks
39 | - **💰 Better Value**: Premium Inception Mercury model now free for all users
40 | - **🌍 Global Accessibility**: Enhanced support for Chinese-English bilingual conversations
41 | - **⚡ Speed for Everyone**: Ultra-fast Mercury model accessible without premium subscription
42 | - **🔧 Advanced Reasoning**: New Baidu model excels at complex reasoning and tool parameter tasks
43 | 
44 | ## 🔄 Migration Notes
45 | - **No Breaking Changes**: All existing functionality remains fully compatible
46 | - **Automatic Model Availability**: New Baidu model immediately available in model picker
47 | - **Premium Status Update**: Inception Mercury automatically becomes free for all users
48 | - **No Configuration Required**: No user action needed to access new features
49 | 
50 | ## 🚀 Deployment
51 | - **Zero Downtime**: Seamless deployment with no service interruption
52 | - **No Environment Changes**: No new environment variables or configuration required
53 | - **No Database Changes**: No database migrations needed
54 | - **Immediate Availability**: New model and premium status changes are immediately active
55 | 
56 | ## 🌟 Looking Forward
57 | ChatLima v0.20.1 continues our commitment to expanding AI model accessibility and capabilities. The addition of Baidu's powerful ERNIE-4.5-300B model provides users with advanced multilingual and reasoning capabilities, while making the ultra-fast Inception Mercury model free ensures that speed-optimized AI is accessible to everyone.
58 | 
59 | This release demonstrates our focus on both expanding the model library with cutting-edge AI capabilities and ensuring that premium features become more accessible to our user community. The combination of new multilingual support and democratized access to high-speed AI represents our ongoing mission to make advanced AI technology available to all users.
60 | 
61 | 🎯 **Experience the power of multilingual AI and ultra-fast performance with ChatLima v0.20.1!**
62 | 
63 | ---
64 | 
65 | **Full Changelog**: [v0.20.0...v0.20.1](https://github.com/brooksy4503/chatlima/compare/v0.20.0...v0.20.1) 
```

releases/RELEASE_NOTES_v0.20.2.md
```
1 | # 🚀 ChatLima v0.20.2 - New X AI Grok 4 Model
2 | 
3 | ## 🎯 What's New
4 | - **🤖 New X AI Grok 4 Model**: Added xAI's latest reasoning model with advanced capabilities
5 | - **🔧 Enhanced Model Library**: Expanded AI model selection with cutting-edge reasoning capabilities
6 | - **⚡ Premium Performance**: New premium model with parallel tool calling and structured outputs
7 | 
8 | ### 🤖 New AI Model
9 | 
10 | #### **X AI Grok 4**
11 | - **Advanced Reasoning**: xAI's latest reasoning model with enhanced cognitive capabilities
12 | - **Extended Context**: Supports up to 256k token context window for comprehensive conversations
13 | - **Parallel Tool Calling**: Advanced tool calling capabilities for complex workflows
14 | - **Structured Outputs**: Enhanced support for structured data generation and processing
15 | - **Multimodal Support**: Handles both image and text inputs for versatile applications
16 | - **Coding Excellence**: Optimized for software development and technical tasks
17 | - **Premium Access**: Available to premium users for advanced AI capabilities
18 | 
19 | ## 🔧 Technical Implementation
20 | - **Model Integration**: Added Grok 4 to OpenRouter language models configuration
21 | - **API Client Support**: Extended OpenRouter client to support new xAI model endpoint
22 | - **Model Details**: Comprehensive model information including capabilities, descriptions, and configuration
23 | - **Premium Status**: Configured as premium model for advanced user access
24 | 
25 | ## 🛡️ Security & Privacy
26 | - **No Security Changes**: All existing security measures remain in place
27 | - **Privacy Preserved**: New model follows same privacy and data handling policies
28 | - **API Key Management**: Existing API key handling and security protocols maintained
29 | 
30 | ## 📈 Benefits
31 | - **🎯 Advanced Reasoning**: New Grok 4 model excels at complex reasoning and problem-solving tasks
32 | - **🔧 Enhanced Tool Calling**: Parallel tool calling capabilities for sophisticated workflows
33 | - **📊 Structured Data**: Better support for structured outputs and data processing
34 | - **🖼️ Multimodal Capabilities**: Image and text input support for versatile applications
35 | - **💻 Coding Excellence**: Optimized performance for software development tasks
36 | - **📏 Long Context**: 256k token context window for comprehensive conversations
37 | 
38 | ## 🔄 Migration Notes
39 | - **No Breaking Changes**: All existing functionality remains fully compatible
40 | - **Automatic Model Availability**: New Grok 4 model immediately available in model picker for premium users
41 | - **Premium Access**: Model requires premium subscription for access
42 | - **No Configuration Required**: No user action needed to access new features (for premium users)
43 | 
44 | ## 🚀 Deployment
45 | - **Zero Downtime**: Seamless deployment with no service interruption
46 | - **No Environment Changes**: No new environment variables or configuration required
47 | - **No Database Changes**: No database migrations needed
48 | - **Immediate Availability**: New model is immediately active for premium users
49 | 
50 | ## 🌟 Looking Forward
51 | ChatLima v0.20.2 continues our commitment to expanding AI model capabilities with cutting-edge technology. The addition of xAI's Grok 4 model provides users with advanced reasoning capabilities, parallel tool calling, and multimodal support. This premium model represents our ongoing mission to provide access to the most advanced AI technology available.
52 | 
53 | The integration of Grok 4 demonstrates our focus on offering diverse AI capabilities that cater to different use cases and user needs. From complex reasoning tasks to sophisticated tool calling workflows, this new model expands the possibilities for AI-powered applications and conversations.
54 | 
55 | 🎯 **Experience advanced reasoning and multimodal capabilities with ChatLima v0.20.2!**
56 | 
57 | ---
58 | 
59 | **Full Changelog**: [v0.20.1...v0.20.2](https://github.com/brooksy4503/chatlima/compare/v0.20.1...v0.20.2) 
```

releases/RELEASE_NOTES_v0.21.0.md
```
1 | # 🚀 ChatLima v0.21.0 - Image Input & Vision Model Enhancements
2 | 
3 | ## 🎯 What's New
4 | - **🖼️ Image Input Support**: Revolutionary new image upload functionality with full multimodal AI capabilities
5 | - **🎨 Enhanced Image Experience**: Comprehensive image preview, modal viewing, and attachment management
6 | - **👁️ Vision Model Corrections**: Fixed vision capabilities for 7 AI models ensuring proper multimodal support
7 | - **🔧 Advanced Image Processing**: Intelligent image validation, compression, and format optimization
8 | - **📱 Drag & Drop Interface**: Intuitive image upload with drag-and-drop support and visual feedback
9 | 
10 | ### 🖼️ Image Input Features
11 | 
12 | #### **Comprehensive Image Upload System**
13 | - **Multi-Format Support**: JPEG, PNG, and WebP image formats with automatic validation
14 | - **Drag & Drop Interface**: Intuitive file dropping with visual drag states and feedback
15 | - **File Size Management**: 20MB per file limit with intelligent compression and optimization
16 | - **Multiple Images**: Support for up to 5 images per message for complex visual conversations
17 | - **Detail Control**: Configurable image detail levels (low, high, auto) for cost and quality optimization
18 | 
19 | #### **Advanced Image Preview & Management**
20 | - **Instant Preview**: Real-time image previews as you select files
21 | - **Full-Screen Modal**: Dedicated image modal for detailed viewing with metadata display
22 | - **Download Support**: Direct image download functionality from the modal viewer
23 | - **Metadata Display**: File information including size, format, dimensions, and detail level
24 | - **Smart UI Integration**: Seamless integration with existing chat interface and message flow
25 | 
26 | #### **Vision Model Compatibility**
27 | - **Enhanced Model Support**: Image input works with all vision-capable AI models
28 | - **Automatic Detection**: Smart detection of model vision capabilities for optimal user experience
29 | - **Format Optimization**: Automatic image processing to match model requirements and constraints
30 | - **Error Handling**: Comprehensive error feedback for unsupported formats or size issues
31 | 
32 | ### 👁️ Vision Model Corrections
33 | 
34 | #### **Fixed Vision Capabilities for 7 Models**
35 | - **Accurate Model Flags**: Corrected vision support flags for models that were incorrectly configured
36 | - **Enhanced Detection**: Improved vision capability detection through automated provider analysis
37 | - **Consistent Experience**: Ensured proper image input availability across all vision-capable models
38 | - **Updated Metadata**: Comprehensive model capability information for better user understanding
39 | 
40 | ## 🔧 Technical Implementation
41 | 
42 | ### Core Image Processing System
43 | - **Image Upload Component**: New `components/image-upload.tsx` with comprehensive upload functionality
44 | - **Image Modal Component**: New `components/image-modal.tsx` for full-screen image viewing and management
45 | - **Image Utils Library**: Enhanced `lib/image-utils.ts` with validation, compression, and processing utilities
46 | - **Message Integration**: Updated `components/message.tsx` to handle image attachments and display
47 | - **Vision Detection**: Enhanced `scripts/update-vision-models.ts` for automated vision capability analysis
48 | 
49 | ### Technical Highlights
50 | - **File Validation**: Robust image file validation with format, size, and integrity checking
51 | - **Base64 Encoding**: Efficient image encoding for AI model compatibility
52 | - **Memory Management**: Optimized image processing to prevent memory leaks and performance issues
53 | - **Error Boundaries**: Comprehensive error handling for upload failures and invalid files
54 | - **Responsive Design**: Mobile-optimized image upload and preview interfaces
55 | 
56 | ### API & Provider Integration
57 | - **Multimodal Requests**: Enhanced chat API to handle image attachments in AI requests
58 | - **Provider Compatibility**: Seamless integration with OpenRouter, Anthropic, and other vision-capable providers
59 | - **Format Optimization**: Automatic image format conversion for provider-specific requirements
60 | - **Cost Optimization**: Smart detail level selection to balance quality and API costs
61 | 
62 | ## 🛡️ Security & Privacy
63 | 
64 | ### Image Security Measures
65 | - **Client-Side Processing**: All image processing happens locally before upload for enhanced privacy
66 | - **File Type Validation**: Strict validation prevents upload of potentially harmful file types
67 | - **Size Limitations**: Enforced file size limits prevent resource exhaustion attacks
68 | - **Memory Safety**: Careful memory management during image processing to prevent crashes
69 | 
70 | ### Data Protection
71 | - **No Persistent Storage**: Images are processed and sent directly to AI providers without local storage
72 | - **Secure Transmission**: All image data transmitted securely through encrypted channels
73 | - **Provider Policies**: Image handling follows the privacy policies of selected AI providers
74 | - **User Control**: Users maintain full control over which images are shared with AI models
75 | 
76 | ## 📈 Benefits
77 | 
78 | ### Enhanced AI Capabilities
79 | - **🖼️ Visual Understanding**: Upload images for analysis, description, OCR, and visual question answering
80 | - **🎨 Creative Applications**: Generate content based on uploaded images, create variations, or analyze artwork
81 | - **📊 Data Analysis**: Upload charts, graphs, and diagrams for AI-powered data interpretation
82 | - **📝 Document Processing**: OCR functionality for extracting text from images and documents
83 | - **🔍 Visual Search**: Describe and search for objects, people, or concepts within uploaded images
84 | 
85 | ### User Experience Improvements
86 | - **🚀 Intuitive Interface**: Drag-and-drop functionality makes image sharing effortless
87 | - **⚡ Fast Processing**: Efficient image handling ensures smooth upload and preview experience
88 | - **📱 Mobile-Friendly**: Optimized for mobile devices with touch-friendly controls and responsive design
89 | - **🎯 Visual Feedback**: Clear visual indicators for upload progress, success, and error states
90 | - **💡 Smart Defaults**: Intelligent default settings for optimal balance of quality and performance
91 | 
92 | ### Cost & Performance Optimization
93 | - **💰 Cost Control**: Configurable detail levels help manage API costs for image processing
94 | - **⚡ Fast Uploads**: Efficient compression and processing for quick image sharing
95 | - **🔧 Format Flexibility**: Support for multiple image formats with automatic optimization
96 | - **📏 Size Management**: Smart file size handling prevents expensive API calls and failures
97 | 
98 | ## 🔄 Migration Notes
99 | 
100 | ### Seamless Upgrade
101 | - **No Breaking Changes**: All existing functionality remains fully compatible
102 | - **Automatic Availability**: Image input features are immediately available for all users
103 | - **Model Compatibility**: Vision models automatically support image input without configuration
104 | - **Backward Compatibility**: Text-only conversations continue to work exactly as before
105 | 
106 | ### Enhanced Capabilities
107 | - **Expanded Model Support**: Vision-capable models now properly indicate image input support
108 | - **Improved Accuracy**: Corrected vision flags ensure users see accurate model capabilities
109 | - **Better Model Selection**: Enhanced model picker shows which models support image input
110 | 
111 | ## 🚀 Deployment
112 | 
113 | ### Production Deployment
114 | - **Zero Downtime**: Seamless deployment with no service interruption
115 | - **No Environment Changes**: No new environment variables or server configuration required
116 | - **No Database Changes**: No database migrations needed for image functionality
117 | - **Immediate Availability**: Image upload features are active immediately after deployment
118 | 
119 | ### Performance Considerations
120 | - **Client-Side Processing**: Image processing happens in the browser, reducing server load
121 | - **Efficient Transmission**: Optimized image encoding for fast upload and processing
122 | - **Memory Management**: Careful resource handling prevents performance degradation
123 | - **Scalable Architecture**: Image handling scales with existing infrastructure
124 | 
125 | ## 🎯 Use Cases & Applications
126 | 
127 | ### Creative & Design
128 | - **🎨 Image Analysis**: Upload artwork, photos, or designs for detailed AI analysis and feedback
129 | - **🖼️ Style Transfer**: Describe desired changes or variations to uploaded images
130 | - **📸 Photo Enhancement**: Get suggestions for improving composition, lighting, or editing
131 | - **🎭 Creative Writing**: Use images as inspiration for stories, descriptions, or creative content
132 | 
133 | ### Business & Productivity
134 | - **📊 Chart Analysis**: Upload graphs, charts, and data visualizations for interpretation
135 | - **📝 Document OCR**: Extract text from images of documents, receipts, or handwritten notes
136 | - **🔍 Visual Research**: Upload screenshots or images for research and analysis
137 | - **📋 Process Documentation**: Share visual workflows or processes for explanation and improvement
138 | 
139 | ### Education & Learning
140 | - **📚 Homework Help**: Upload math problems, diagrams, or assignments for assistance
141 | - **🔬 Scientific Analysis**: Share experimental results, microscope images, or scientific diagrams
142 | - **🗺️ Geography & History**: Upload maps, historical documents, or cultural artifacts for discussion
143 | - **💻 Code Review**: Share screenshots of code for debugging and optimization suggestions
144 | 
145 | ### Technical & Development
146 | - **🐛 Bug Reports**: Upload screenshots of errors, UI issues, or unexpected behavior
147 | - **🎨 UI/UX Design**: Share mockups, wireframes, or design concepts for feedback
148 | - **📱 App Development**: Upload mobile app screenshots for usability analysis
149 | - **🔧 Technical Diagrams**: Share system architecture, network diagrams, or technical schematics
150 | 
151 | ## 🌟 Looking Forward
152 | 
153 | ChatLima v0.21.0 represents a major leap forward in multimodal AI capabilities, bringing the power of visual understanding directly to your conversations. The addition of comprehensive image input support opens up entirely new possibilities for creative work, business productivity, education, and technical collaboration.
154 | 
155 | The enhanced vision model support ensures that users have access to the most accurate and powerful visual AI capabilities available. From analyzing complex charts to describing artwork, from OCR to creative inspiration, ChatLima now provides a complete multimodal AI experience.
156 | 
157 | This release builds upon our strong foundation of 53+ AI models to deliver visual AI capabilities that rival dedicated image analysis tools, all within the familiar and powerful ChatLima interface. The intuitive drag-and-drop interface makes visual AI accessible to everyone, regardless of technical expertise.
158 | 
159 | The careful attention to privacy, security, and performance ensures that these powerful new capabilities integrate seamlessly into existing workflows without compromising on the reliability and security that ChatLima users expect.
160 | 
161 | 🎯 **Transform your AI conversations with visual intelligence - experience the future of multimodal AI with ChatLima v0.21.0!**
162 | 
163 | ---
164 | 
165 | **Full Changelog**: [v0.20.2...v0.21.0](https://github.com/brooksy4503/chatlima/compare/v0.20.2...v0.21.0) 
```

releases/RELEASE_NOTES_v0.22.0.md
```
1 | # 🚀 ChatLima v0.22.0 - Requesty Model Expansion & Model Selection Improvements
2 | 
3 | ## 🎯 What's New
4 | - **🆕 Major Requesty Model Expansion**: Added a wide range of new Requesty models, including the latest Anthropic Claude 4, Claude 3.5/3.7, DeepSeek, Google Gemini, Meta Llama, and more. Users now have access to dozens of new models via Requesty, greatly expanding the available AI model library.
5 | - **🔄 Improved Model Selection**: Enhanced model selection logic and metadata for seamless switching between OpenRouter and Requesty providers.
6 | - **🛠️ Model Details & Capabilities**: Updated model metadata for new and existing models, including improved capability flags, premium status, and vision support where applicable.
7 | - **🐛 Bug Fixes**: Fixed image upload and preview issues for a smoother user experience.
8 | 
9 | ## 🔧 Technical Implementation
10 | - **Requesty Model Integration**: Updated `ai/providers.ts` to add and configure new Requesty models, including:
11 |   - Anthropic Claude 4 Opus & Sonnet (2025-05-14)
12 |   - Anthropic Claude 3.5 Sonnet/Haiku (latest)
13 |   - Anthropic Claude 3.7 Sonnet (latest, thinking)
14 |   - Anthropic Claude 3 Opus/Sonnet/Haiku (latest)
15 |   - DeepSeek R1, V3, Reasoner, and distill variants (multiple providers)
16 |   - Google Gemini 2.5 Flash/Pro (multiple variants)
17 |   - Meta Llama 3.1/3.3 70B Instruct
18 |   - Moonshot Kimi K2 Instruct
19 |   - And many more (see `ai/providers.ts` for full list)
20 | - **Scripted Model Addition**: Used and updated `scripts/add-requesty-models.ts` for automated model mapping and insertion.
21 | - **Model Metadata**: Enhanced `modelDetails` with accurate provider, capability, premium, and vision flags for all new models.
22 | - **Bug Fixes**: Addressed image upload and preview issues for improved reliability.
23 | 
24 | ## 🛡️ Security & Privacy
25 | - No new security risks introduced. All API keys and provider credentials remain managed via environment variables.
26 | - Maintained secure API key management and provider selection logic.
27 | 
28 | ## 📈 Benefits
29 | - **Expanded Model Choice**: Users can now select from a much larger set of AI models, including the latest from Anthropic, DeepSeek, Google, Meta, and more, all via Requesty.
30 | - **Provider Flexibility**: Easily switch between OpenRouter and Requesty for redundancy and access to exclusive models.
31 | - **Improved User Experience**: Smoother image upload and preview, plus more accurate model metadata for better selection.
32 | 
33 | ## 🔄 Migration Notes
34 | - **No Breaking Changes**: All existing functionality remains compatible. New models are available immediately after deployment.
35 | - **Environment Variables**: Ensure `REQUESTY_ENABLED` and `REQUESTY_API_KEY` are set if using Requesty provider.
36 | - **Model Selection**: All new models are available in the model picker; no manual configuration required.
37 | 
38 | ## 🚀 Deployment
39 | - **Standard Deployment**: No special steps required. Deploy as usual after updating environment variables if needed.
40 | - **No Database Changes**: No migrations required for this release.
41 | 
42 | ---
43 | 
44 | **Full Changelog**: [v0.21.0...v0.22.0](https://github.com/brooksy4503/chatlima/compare/v0.21.0...v0.22.0) 
```

releases/RELEASE_NOTES_v0.22.1.md
```
1 | # 🚀 ChatLima v0.22.1 - Premium Model Updates
2 | 
3 | ## 🎯 What's New
4 | - Enhanced model tier classification with additional premium models
5 | - Improved access control for advanced language models
6 | - Better model capability differentiation for users
7 | 
8 | ## 🔧 Technical Implementation
9 | - Updated model configurations in `ai/providers.ts` to mark premium status
10 | - Modified premium flags for Google Gemini models:
11 |   - `requesty/google/gemini-2.5-flash` - now premium
12 |   - `requesty/google/gemini-2.5-pro` - now premium
13 |   - Additional models updated with premium classification
14 | 
15 | ## 🛡️ Security & Privacy
16 | - Enhanced access control through proper model tier classification
17 | - Improved billing and usage tracking for premium features
18 | 
19 | ## 📈 Benefits
20 | - Better model organization for users
21 | - More accurate pricing and access control
22 | - Improved user experience with clear premium model identification
23 | 
24 | ## 🔄 Migration Notes
25 | - No breaking changes
26 | - Existing users maintain access to previously available models
27 | - Premium model access requires appropriate subscription or credits
28 | 
29 | ## 🚀 Deployment
30 | - Standard deployment process
31 | - No additional configuration required
32 | - Changes take effect immediately upon deployment
33 | 
34 | ---
35 | 
36 | **Full Changelog**: [v0.22.0...v0.22.1](https://github.com/brooksy4503/chat-bot/compare/v0.22.0...v0.22.1) 
```

releases/RELEASE_NOTES_v0.22.2.md
```
1 | # 🚀 ChatLima v0.22.2 - Documentation & Release Process Improvements
2 | 
3 | ## 🎯 What's New
4 | - Enhanced release documentation and process standardization
5 | - Completed comprehensive release notes for v0.22.1
6 | - Improved repository organization and release tracking
7 | 
8 | ## 🔧 Technical Implementation
9 | - Updated release notes documentation with detailed premium model changes
10 | - Standardized release note format following project conventions
11 | - Improved GitHub repository URL references and changelog links
12 | 
13 | ## 📚 Documentation Improvements
14 | - Completed v0.22.1 release notes with full details on premium model updates
15 | - Enhanced technical documentation for model tier classifications
16 | - Added comprehensive changelog references for better version tracking
17 | 
18 | ## 📈 Benefits
19 | - Better release tracking and version history
20 | - Improved developer experience with complete documentation
21 | - Enhanced project maintainability through standardized processes
22 | 
23 | ## 🔄 Migration Notes
24 | - No breaking changes
25 | - All existing functionality remains unchanged
26 | - Documentation improvements are backward compatible
27 | 
28 | ## 🚀 Deployment
29 | - Standard deployment process
30 | - No additional configuration required
31 | - Changes are documentation-only and take effect immediately
32 | 
33 | ---
34 | 
35 | **Full Changelog**: [v0.22.1...v0.22.2](https://github.com/brooksy4503/chatlima/compare/v0.22.1...v0.22.2) 
```

releases/RELEASE_NOTES_v0.22.3.md
```
1 | # 🚀 ChatLima v0.22.3 - Flash Model Access & Premium Coding
2 | 
3 | ## 🎯 What's New
4 | - **Enhanced Flash Model Access**: Made Google Gemini 2.5 Flash available for free users while maintaining premium Pro-tier models
5 | - **Premium Coding Model**: Upgraded specialized Gemini 2.5 Pro Preview Coding model to premium tier for enhanced development workflows
6 | - **Consistent Pro-Tier Premium**: All Gemini 2.5 Pro variants remain premium-only, maintaining clear value distinction
7 | 
8 | ## 🔧 Technical Implementation
9 | - Updated premium status flags in `ai/providers.ts` for 2 Google Gemini models
10 | - Made `requesty/google/gemini-2.5-flash` accessible to free users
11 | - Elevated `requesty/coding/gemini-2.5-pro-preview-05-06` to premium tier
12 | - Maintained backward compatibility with existing model configurations
13 | 
14 | ## 📊 Model Access Changes
15 | 
16 | ### 🆓 Models Made Free
17 | - **Google Gemini 2.5 Flash** (`requesty/google/gemini-2.5-flash`) - Fast, efficient model with thinking capabilities now available for free tier
18 | 
19 | ### 💎 Models Made Premium  
20 | - **Gemini 2.5 Pro Preview Coding** (`requesty/coding/gemini-2.5-pro-preview-05-06`) - Specialized coding model with enhanced development capabilities
21 | 
22 | **Note**: All Gemini 2.5 Pro models remain premium-only. No Pro-tier models were made free in this release.
23 | 
24 | ## 🎁 Benefits
25 | - **Improved Free Tier**: Google Gemini 2.5 Flash now available without subscription for fast, efficient AI processing
26 | - **Enhanced Premium Value**: Premium users retain exclusive access to all Pro-tier models plus specialized coding variants
27 | - **Clear Model Hierarchy**: Maintained distinction between Flash (accessible) and Pro (premium) model tiers
28 | - **Developer-Focused Premium**: Specialized coding model now premium, providing enhanced value for development workflows
29 | 
30 | ## 🔄 Migration Notes
31 | - No breaking changes - existing API calls will continue to work
32 | - Users with existing premium subscriptions retain access to all premium models
33 | - Free tier users gain access to Google Gemini 2.5 Flash (previously premium)
34 | - `requesty/coding/gemini-2.5-pro-preview-05-06` now requires premium subscription
35 | - Model IDs remain unchanged, only access tiers have been modified
36 | 
37 | ## 🚀 Deployment
38 | - Changes are automatically deployed via GitHub integration
39 | - No database migrations required
40 | - Model access changes take effect immediately upon deployment
41 | - No additional configuration needed
42 | 
43 | ---
44 | 
45 | **Full Changelog**: [v0.22.2...v0.22.3](https://github.com/brooksy4503/chatlima/compare/v0.22.2...v0.22.3)
46 | 
47 | **GitHub Release**: [v0.22.3](https://github.com/brooksy4503/chatlima/releases/tag/v0.22.3) 
```

releases/RELEASE_NOTES_v0.23.0.md
```
1 | # 🚀 ChatLima v0.23.0 - Enhanced Error Recovery & Model Expansion
2 | 
3 | ## 🎯 What's New
4 | - **New Groq Kimi K2 Model**: Added ultra-fast Groq variant of Moonshot AI's Kimi K2 model for enhanced performance
5 | - **Intelligent Error Recovery**: Comprehensive error handling with automatic recovery mechanisms
6 | - **Enhanced UI Resilience**: Error boundary components with graceful error isolation
7 | - **Real-time Streaming Status**: Visual indicators for chat generation progress with timing information
8 | - **Smart Error Detection**: Automatic detection and recovery from stuck or failed requests
9 | 
10 | ## 🔧 Technical Implementation
11 | - Added `requesty/groq/moonshotai/kimi-k2-instruct` model via Groq infrastructure for faster inference
12 | - Implemented comprehensive error boundary system with `ErrorBoundary` components
13 | - Enhanced chat API error handling with provider-specific error parsing
14 | - Added debounced error toast system to prevent UI spam
15 | - Implemented streaming activity monitoring with timeout detection
16 | - Added manual recovery mechanisms for user-initiated chat resets
17 | 
18 | ## 🛡️ Security & Reliability
19 | - Enhanced error message sanitization to prevent information leakage
20 | - Added structured error response system with proper error codes
21 | - Implemented timeout protection for stuck requests (2-minute threshold)
22 | - Added graceful fallback mechanisms for provider failures
23 | - Enhanced request validation and error boundary isolation
24 | 
25 | ## 📊 Model Access Updates
26 | 
27 | ### 🆕 New Models Available
28 | - **Moonshot AI Kimi K2 (Groq)** (`requesty/groq/moonshotai/kimi-k2-instruct`)
29 |   - Ultra-fast inference via Groq infrastructure
30 |   - 1 trillion total parameters with 32 billion active per forward pass
31 |   - Optimized for coding, reasoning, and tool use
32 |   - 128K token context length
33 |   - Available for free tier users
34 | 
35 | ### 📈 Model Performance
36 | - Groq variant provides significantly faster response times
37 | - Maintained full compatibility with existing Kimi K2 features
38 | - Enhanced performance for coding and reasoning tasks
39 | - Optimized for agentic workflows and tool use
40 | 
41 | ## 🎁 Benefits
42 | - **Improved Reliability**: Automatic error recovery prevents chat session interruptions
43 | - **Better User Experience**: Clear visual feedback during message generation
44 | - **Enhanced Performance**: Groq-powered Kimi K2 model for faster responses
45 | - **Robust Error Handling**: Comprehensive error detection and recovery mechanisms
46 | - **Seamless Recovery**: Manual and automatic recovery options for stuck chats
47 | 
48 | ## 🔄 Migration Notes
49 | - No breaking changes - all existing functionality preserved
50 | - New error boundary components wrap chat interfaces automatically
51 | - Existing model configurations remain unchanged
52 | - Error recovery mechanisms activate automatically when needed
53 | - All previous model IDs continue to work without modification
54 | 
55 | ## 🚀 Deployment
56 | - Automatic deployment via GitHub integration
57 | - No database migrations required
58 | - New model access available immediately upon deployment
59 | - Error recovery features activate automatically for all users
60 | - No additional configuration needed for enhanced error handling
61 | 
62 | ## 🔧 Error Recovery Features
63 | - **Automatic Detection**: Monitors streaming activity and detects stuck requests
64 | - **Smart Recovery**: Automatically resets chat state after errors
65 | - **Manual Override**: User-initiated recovery with "Reset Now" button
66 | - **Visual Feedback**: Clear indicators for streaming status and recovery actions
67 | - **Debounced Notifications**: Intelligent error toast management to prevent spam
68 | 
69 | ## 📝 Developer Notes
70 | - Enhanced error logging for better debugging
71 | - Structured error response format for consistent handling
72 | - Improved provider-specific error message parsing
73 | - Better separation of concerns with error boundary components
74 | - Comprehensive timeout and recovery mechanisms
75 | 
76 | ---
77 | 
78 | **Full Changelog**: [v0.22.3...v0.23.0](https://github.com/brooksy4503/chatlima/compare/v0.22.3...v0.23.0)
79 | 
80 | **GitHub Release**: [v0.23.0](https://github.com/brooksy4503/chatlima/releases/tag/v0.23.0) 
```

releases/RELEASE_NOTES_v0.24.0.md
```
1 | # 🚀 ChatLima v0.24.0 - Comprehensive Presets System
2 | 
3 | ## 🎯 What's New
4 | - **🎨 Complete Presets System**: Save, manage, and apply custom AI model configurations with templates
5 | - **📱 Enhanced Mobile Experience**: Improved responsive design across all components with better touch interactions
6 | - **🔧 Advanced MCP Server Management**: Enhanced connection testing and configuration validation
7 | - **🔑 Improved API Key Management**: Visual key management with show/hide functionality for better security
8 | - **🌐 Enhanced Web Search Integration**: Better web search support validation and user feedback
9 | - **⚙️ Expanded Model Configuration**: Enhanced model parameters with maxTokensRange support for various models
10 | 
11 | ## 🔧 Technical Implementation
12 | 
13 | ### Presets System
14 | - **Database Schema**: New `presets` table with comprehensive validation constraints
15 | - **Template System**: Built-in preset templates for common use cases (Creative Writing, Code Review, Research Assistant, etc.)
16 | - **Validation Engine**: Robust preset validation with name length, system instruction constraints
17 | - **Context Management**: Integrated preset context provider for seamless state management
18 | - **Default Preset Logic**: Smart default preset handling with proper constraint management
19 | 
20 | ### Enhanced Components
21 | - **PresetManager**: Complete preset CRUD operations with template integration
22 | - **PresetSelector**: Intuitive preset selection with visual indicators and tooltips
23 | - **ModelPicker**: Updated with preset-aware model selection and responsive sizing
24 | - **API Key Manager**: Enhanced with show/hide toggles and improved validation
25 | - **MCP Server Manager**: Improved connection testing with proper feedback mechanisms
26 | 
27 | ### Mobile Optimization
28 | - **Responsive Layout**: Fixed overflow issues on narrow screens (<375px)
29 | - **Touch Optimization**: Better button sizing and interaction areas for mobile devices
30 | - **Space Management**: Intelligent space usage with gear-only preset selector
31 | - **Badge System**: Responsive preset badges that adapt to screen size
32 | 
33 | ## 🎨 User Experience Improvements
34 | 
35 | ### Preset Management
36 | - **Template-Based Creation**: Quick preset creation using predefined templates
37 | - **Visual Feedback**: Clear indicators for active presets with star icons for defaults
38 | - **Contextual Hints**: Template name hints during preset creation for better UX
39 | - **Reset Functionality**: Proper form reset and state management when switching modes
40 | 
41 | ### Enhanced Navigation
42 | - **Improved Chat Recovery**: Better error handling for new chat creation after API errors
43 | - **Navigation Fixes**: Replaced problematic router.push with reliable window.location navigation
44 | - **State Management**: Proper cleanup of error states when navigating to new conversations
45 | 
46 | ### Visual Enhancements
47 | - **Accessibility Improvements**: Added aria-hidden attributes and better screen reader support
48 | - **Icon Consistency**: Uniform icon usage across components with proper sizing
49 | - **Responsive Badges**: Smart badge visibility based on available screen space
50 | 
51 | ## 🛡️ Security & Privacy
52 | - **API Key Privacy**: Show/hide toggles for sensitive API key management
53 | - **Input Validation**: Enhanced validation for all preset and configuration inputs
54 | - **HTML Entity Safety**: Proper encoding for apostrophes and special characters
55 | - **Configuration Security**: Secure MCP server configuration validation without exposing endpoints
56 | 
57 | ## 📈 Benefits
58 | - **Productivity Boost**: Save and reuse favorite AI configurations across different tasks
59 | - **Better Mobile Experience**: Seamless usage on all device sizes with optimized layouts
60 | - **Simplified Workflow**: Template-based preset creation reduces setup time
61 | - **Enhanced Security**: Better API key management with visual privacy controls
62 | - **Improved Reliability**: More robust error handling and navigation across the application
63 | 
64 | ## 🔄 Migration Notes
65 | - **Database Migration**: New `presets` table automatically created with proper constraints
66 | - **Backward Compatibility**: All existing functionality preserved and enhanced
67 | - **No Breaking Changes**: Existing API routes and components continue to work as before
68 | - **Automatic Upgrades**: Existing users automatically gain access to all new features
69 | 
70 | ## 🚀 Deployment
71 | - **Automatic Deployment**: GitHub integration handles seamless production deployment
72 | - **Zero Downtime**: New features activate automatically without service interruption
73 | - **Database Auto-Migration**: Preset tables created automatically on first access
74 | - **Feature Flags**: All new features are production-ready and enabled by default
75 | 
76 | ## 🎁 New Features in Detail
77 | 
78 | ### Preset Templates Available
79 | 
80 | #### 🛠️ Coding Templates
81 | - **🏗️ Advanced Code Architect** (Claude Sonnet 4): Complex software architecture, advanced algorithms, and system design
82 | - **⚡ Deepseek V3 Code Expert** (Deepseek V3): Efficient coding, debugging, and modern frontend development  
83 | - **🤖 Kimi K2 Agentic Coder** (Kimi K2): Autonomous coding, complex problem-solving, and tool integration
84 | - **🚀 GPT-4.1 Mini Rapid Coder** (GPT-4.1 Mini): Fast coding tasks, code completion, and lightweight development
85 | 
86 | #### 🧠 Analysis Templates
87 | - **🧠 Deepseek R1 Deep Reasoner** (Deepseek R1): Complex reasoning, mathematical problems, and logical analysis
88 | - **🔍 Grok 4 Research Analyst** (Grok 4): Comprehensive research, data analysis, and strategic insights
89 | - **📊 Gemini Pro 2.5 Data Scientist** (Gemini Pro 2.5): Advanced data science, ML model development, and statistical analysis
90 | 
91 | #### ✍️ Writing Templates
92 | - **📚 Claude Sonnet 4 Technical Writer** (Claude Sonnet 4): Comprehensive technical documentation and complex writing
93 | - **✨ Gemini 2.5 Flash Content Creator** (Gemini 2.5 Flash): Rapid content creation, marketing copy, and creative writing
94 | 
95 | #### 🎯 General Templates
96 | - **👔 Claude Sonnet 4 Executive Assistant** (Claude Sonnet 4): Comprehensive AI assistant for complex tasks and decision support
97 | - **🤝 GPT-4.1 Mini Personal Assistant** (GPT-4.1 Mini): Everyday tasks, quick answers, and personal productivity
98 | - **🧩 Kimi K2 Strategic Problem Solver** (Kimi K2): Complex problem-solving, strategic thinking, and multi-step solutions
99 | - **🎓 Gemini 2.5 Flash Learning Tutor** (Gemini 2.5 Flash): Interactive learning, education, and skill development
100 | 
101 | ### Mobile-First Improvements
102 | - **Optimized Input Areas**: Better text input handling on mobile keyboards
103 | - **Responsive Components**: All UI elements adapt perfectly to screen constraints
104 | - **Touch-Friendly Controls**: Larger tap targets and improved gesture support
105 | - **Space Efficiency**: Maximized usable space on small screens
106 | 
107 | ### Enhanced Model Support
108 | - **Parameter Ranges**: New maxTokensRange support for better model configuration
109 | - **Web Search Validation**: Smart detection and feedback for web search capabilities
110 | - **Provider Optimization**: Enhanced support for various AI model providers
111 | 
112 | ## 🔧 Developer Notes
113 | - **Component Architecture**: Modular preset system with clean separation of concerns
114 | - **State Management**: Integrated context providers for consistent state handling
115 | - **TypeScript Support**: Full type safety across all new preset functionality
116 | - **Testing Support**: Comprehensive validation and error handling for robust operation
117 | - **Performance Optimization**: Efficient database queries and component rendering
118 | 
119 | ## 🐛 Bug Fixes
120 | - **Fixed**: Navigation hanging with RSC requests resolved
121 | - **Fixed**: New chat creation after API errors now works properly
122 | - **Fixed**: Mobile layout overflow on screens narrower than 375px
123 | - **Fixed**: MCP server connection testing no longer generates false 400 errors
124 | - **Fixed**: HTML entity compatibility issues in API key descriptions
125 | - **Fixed**: Preset constraint issues that limited user flexibility
126 | 
127 | ---
128 | 
129 | **Full Changelog**: [v0.23.0...v0.24.0](https://github.com/brooksy4503/chatlima/compare/v0.23.0...v0.24.0)
130 | 
131 | **GitHub Release**: [v0.24.0](https://github.com/brooksy4503/chatlima/releases/tag/v0.24.0)
132 | 
133 | **Pull Request**: [#13 - Implement presets](https://github.com/brooksy4503/chatlima/pull/13) 
```

releases/RELEASE_NOTES_v0.25.0.md
```
1 | # 🚀 ChatLima v0.25.0 - Dynamic AI Models Openrouter/Requesty Integration
2 | 
3 | ## 🎯 What's New
4 | - **🌟 Dynamic Model Loading**: Real-time fetching of AI models from OpenRouter and Requesty APIs, eliminating manual model updates
5 | - **🔄 Requesty AI Integration**: Complete integration with Requesty.ai routing service providing access to 300+ language models
6 | - **⚡ Automatic Model Discovery**: Dynamic model discovery with smart caching and automatic updates
7 | - **🏷️ Enhanced Model Metadata**: Rich model information including capabilities, pricing, and performance characteristics
8 | - **🚫 Intelligent Model Filtering**: Automatic filtering of blocked, deprecated, and unavailable models
9 | - **🧠 Enhanced Reasoning Model Support**: Improved support for reasoning models with specialized middleware and configurations
10 | - **💰 Dynamic Pricing Integration**: Real-time pricing information from provider APIs
11 | - **🔧 Provider Health Monitoring**: Comprehensive provider status tracking and health checks
12 | 
13 | ## 🔧 Technical Implementation
14 | 
15 | ### Dynamic Model Architecture
16 | - **Provider Configuration System**: Extensible provider registry supporting OpenRouter and Requesty with unified interfaces
17 | - **Model Fetching Service**: Robust API integration with retry logic, rate limiting, and error handling
18 | - **Intelligent Caching**: Multi-layer caching with 1-hour model list TTL and 24-hour detail caching
19 | - **Model Transformation Pipeline**: Standardized parsing and transformation of external API responses to internal format
20 | - **Real-time Updates**: Automatic model synchronization with configurable refresh intervals
21 | 
22 | ### OpenRouter Dynamic Integration
23 | - **Live Model Fetching**: Direct integration with OpenRouter's `/api/v1/models` endpoint
24 | - **Capability Detection**: Automatic capability parsing from model metadata (Vision, Reasoning, Coding, Fast)
25 | - **Premium Model Classification**: Dynamic premium status determination based on pricing thresholds
26 | - **Context Length Support**: Dynamic context length detection and configuration
27 | - **Pricing Integration**: Real-time per-token pricing from OpenRouter API
28 | 
29 | ### Requesty AI Integration
30 | - **Multi-Provider Access**: Access to 300+ models through unified Requesty routing service
31 | - **Provider Configuration**: Seamless integration with Requesty's model routing API
32 | - **Compatibility Layer**: OpenAI SDK compatible integration for consistent behavior
33 | - **Enhanced Rate Limits**: Higher rate limits (120 requests/minute) for improved performance
34 | - **Model Diversity**: Access to additional model providers beyond OpenRouter's offerings
35 | 
36 | ### Enhanced Model Management
37 | - **Blocked Model System**: JSON-based model filtering with support for deprecated and problematic models
38 | - **Model Validation**: Comprehensive validation of model availability and capabilities
39 | - **Provider Health Checks**: Automated provider status monitoring and error reporting
40 | - **Fallback Mechanisms**: Graceful degradation when providers are unavailable, with minimal direct provider fallbacks
41 | 
42 | ## 🛡️ Security & Privacy
43 | - **API Key Protection**: Secure handling of multiple provider API keys with environment variable management
44 | - **Rate Limiting**: Built-in rate limiting to prevent API abuse and ensure stability
45 | - **Error Sanitization**: Secure error handling that prevents sensitive information leakage
46 | - **Provider Authentication**: Robust authentication handling for multiple AI providers
47 | - **Input Validation**: Enhanced validation for all dynamic model configurations
48 | 
49 | ## 📈 Benefits
50 | - **Always Up-to-Date Models**: Primary model architecture now provides automatic access to latest AI models without code deployments
51 | - **Massive Model Expansion**: Access to 300+ models through dynamic provider integration
52 | - **Zero Maintenance**: Complete elimination of manual model configuration and updates
53 | - **Enhanced Model Discovery**: Users automatically get access to new models as they become available
54 | - **Improved Performance**: Intelligent caching reduces API calls while maintaining freshness
55 | - **Provider Redundancy**: Multiple provider support ensures better availability and pricing options
56 | - **Cost Optimization**: Real-time pricing helps users make informed model choices
57 | 
58 | ## 🌟 User Experience Improvements
59 | 
60 | ### Seamless Model Selection
61 | - **Real-time Availability**: Model picker shows current availability status for all models
62 | - **Enhanced Metadata**: Rich model descriptions with capabilities, pricing, and provider information
63 | - **Smart Filtering**: Automatic filtering of unavailable or problematic models
64 | - **Provider Indicators**: Clear indication of which provider serves each model
65 | 
66 | ### Performance Enhancements
67 | - **Faster Loading**: Cached model data provides instant model picker loading
68 | - **Background Updates**: Model data refreshes in background without interrupting user experience
69 | - **Optimized Requests**: Efficient API usage with intelligent caching and batching
70 | - **Error Recovery**: Graceful handling of provider outages with cached fallbacks
71 | 
72 | ## 🔄 Migration Notes
73 | - **Architectural Shift**: Transitioned from static model configuration to dynamic model loading system
74 | - **Seamless Integration**: Dynamic models integrate seamlessly with existing chat functionality  
75 | - **Minimal Fallbacks**: Only essential direct provider models (4) remain for critical system functions
76 | - **No User Impact**: All changes are transparent to end users with significantly expanded model access
77 | 
78 | ## 🚀 Deployment
79 | - **Simple Configuration**: Only requires optional provider API keys - no complex configuration needed
80 | - **Automatic Activation**: Dynamic model system activates automatically when API keys are provided
81 | - **Zero Downtime**: Complete architectural transition completed without service interruption
82 | - **Built-in Intelligence**: Smart caching and provider management works out of the box
83 | 
84 | ## 🎁 New Features in Detail
85 | 
86 | ### OpenRouter Dynamic Models
87 | - **Real-time Model Catalog**: Access to OpenRouter's complete model catalog with live updates
88 | - **Pricing Integration**: Real-time pricing information displayed in model selection
89 | - **Capability Mapping**: Automatic detection of model capabilities (Vision, Reasoning, Coding)
90 | - **Context Length Detection**: Dynamic context length configuration based on model specifications
91 | - **Provider Status**: Live provider health monitoring with status indicators
92 | 
93 | ### Requesty AI Integration  
94 | - **300+ Model Access**: Unified access to models from multiple providers through Requesty routing
95 | - **Enhanced Performance**: Superior routing algorithms for optimal model selection
96 | - **Cost Optimization**: Intelligent routing to minimize costs while maintaining quality
97 | - **Provider Diversity**: Access to providers not available through other routing services
98 | - **Advanced Features**: Support for specialized routing features and custom configurations
99 | 
100 | ### Enhanced Model Infrastructure
101 | - **Provider Registry**: Extensible system for adding new AI model providers
102 | - **Caching System**: Multi-layer caching with configurable TTL and refresh strategies
103 | - **Health Monitoring**: Comprehensive monitoring of provider status and API health
104 | - **Error Recovery**: Automatic retry logic with exponential backoff for failed requests
105 | - **Rate Limiting**: Built-in rate limiting to ensure stable API usage
106 | 
107 | ### Model Filtering and Validation
108 | - **Blocked Model Management**: JSON-based system for filtering problematic models
109 | - **Capability Validation**: Automatic validation of model capabilities and features
110 | - **Pricing Validation**: Verification of pricing data and premium status classification
111 | - **Status Monitoring**: Real-time tracking of model availability and status
112 | 
113 | ## 🔧 Developer Features
114 | - **Extensible Architecture**: Clean provider interface for adding new AI routing services
115 | - **Comprehensive Logging**: Detailed logging for model fetching, caching, and provider interactions
116 | - **Type Safety**: Full TypeScript support for all dynamic model functionality
117 | - **Testing Support**: Comprehensive test coverage for model fetching and transformation
118 | - **Configuration Management**: Environment-based configuration for all provider settings
119 | 
120 | ## 🐛 Bug Fixes
121 | - **Fixed**: Model availability detection now properly handles provider outages
122 | - **Fixed**: Pricing calculation accuracy improved for various providers
123 | - **Fixed**: Cache invalidation now properly updates model availability
124 | - **Fixed**: Provider health checks no longer cause false negatives
125 | - **Fixed**: Model metadata parsing handles edge cases in provider responses
126 | - **Fixed**: Rate limiting properly prevents API quota exhaustion
127 | 
128 | ## ⚙️ Configuration
129 | 
130 | ### Optional Environment Variables
131 | ```bash
132 | # OpenRouter Configuration (Optional - enables OpenRouter models)
133 | OPENROUTER_API_KEY=your_openrouter_api_key
134 | 
135 | # Requesty Configuration (Optional - enables Requesty models) 
136 | REQUESTY_API_KEY=your_requesty_api_key
137 | ```
138 | 
139 | ### Cache Configuration (Hardcoded)
140 | - **Model List Cache**: 10 minutes
141 | - **Model Details Cache**: 1 hour  
142 | - **Provider Health Cache**: 30 seconds
143 | 
144 | ### API Endpoints Enhanced
145 | - **GET /api/models**: Now returns dynamically fetched models with real-time data
146 | - **GET /api/models/health**: New endpoint for provider health monitoring
147 | - **Model Selection**: Enhanced with dynamic availability and pricing information
148 | 
149 | ---
150 | 
151 | **Full Changelog**: [v0.24.0...v0.25.0](https://github.com/brooksy4503/chatlima/compare/v0.24.0...v0.25.0)
152 | 
153 | **GitHub Release**: [v0.25.0](https://github.com/brooksy4503/chatlima/releases/tag/v0.25.0)
154 | 
155 | **Pull Request**: [#14 - Dynamic AI Models](https://github.com/brooksy4503/chatlima/pull/14) 
```

releases/RELEASE_NOTES_v0.26.0.md
```
1 | # 🚀 ChatLima v0.26.0 - Favorite Models & Enhanced UX
2 | 
3 | ## 🎯 What's New
4 | 
5 | ### ⭐ **Favorite Models System**
6 | - **Star-based Model Selection**: Users can now mark their preferred AI models as favorites with intuitive star icons
7 | - **Dedicated Favorites Tab**: Quick access to favorite models through a dedicated tab in the model picker
8 | - **Persistent Favorites**: User preferences are saved across sessions and devices
9 | - **Optimistic UI Updates**: Instant visual feedback when favoriting/unfavoriting models
10 | 
11 | ### 🎨 **Enhanced User Experience**
12 | - **Improved Code Input Handling**: Better textarea component for code snippets and multi-line input
13 | - **Refined Font Settings**: Updated typography settings in `globals.css` for improved readability
14 | - **Better Preset Sharing**: Enhanced URL generation for sharing model presets with improved reliability
15 | 
16 | ### 📚 **Documentation & Planning**
17 | - **Comprehensive Feature Documentation**: Added detailed implementation plans and feature documentation
18 | - **Enhanced README**: Updated with dynamic AI model features and latest improvements
19 | 
20 | ## 🔧 Technical Implementation
21 | 
22 | ### 🗄️ **Database Enhancements**
23 | - **New `favorite_models` Table**: Secure storage of user favorites with proper foreign key constraints
24 | - **Optimized Indexing**: Efficient queries with proper indexing on `(user_id, model_id)`
25 | - **Data Integrity**: Unique constraints prevent duplicate favorites per user
26 | 
27 | ### 🌐 **API Endpoints**
28 | - **GET `/api/favorites/models`**: Fetch user's favorite models
29 | - **POST `/api/favorites/models`**: Add models to favorites with validation
30 | - **DELETE `/api/favorites/models/[modelId]`**: Remove models from favorites
31 | - **Enhanced Models API**: Includes `isFavorite` status in model responses
32 | 
33 | ### ⚛️ **Frontend Architecture** 
34 | - **New `FavoritesService`**: Centralized service for managing favorite operations
35 | - **Enhanced Model Context**: Extended with favorites state management and toggle functionality
36 | - **Custom `useFavorites` Hook**: Simplified favorites management in components
37 | - **`FavoriteToggle` Component**: Reusable star toggle component with accessibility features
38 | 
39 | ### 🎨 **UI Components**
40 | - **Updated Model Picker**: Added "All" and "Favorites" tabs with smooth transitions
41 | - **Star Icons**: Filled stars for favorites, outlined for non-favorites with hover effects
42 | - **Empty State Handling**: Graceful handling when users have no favorites
43 | - **Accessibility**: Proper ARIA labels and keyboard navigation support
44 | 
45 | ## 🛡️ Security & Privacy
46 | 
47 | ### 🔐 **Authentication & Authorization**
48 | - **Session Validation**: All favorite operations require valid user authentication
49 | - **User Ownership**: Prevents unauthorized access to other users' favorites
50 | - **Input Validation**: Comprehensive validation of model IDs before database operations
51 | 
52 | ### 📊 **Data Protection**
53 | - **Cascade Deletion**: User favorites are automatically cleaned up when accounts are deleted
54 | - **Rate Limiting Ready**: Infrastructure prepared for rate limiting favorite operations
55 | - **Audit Trail**: Proper error logging and debugging capabilities
56 | 
57 | ## 📈 Benefits
58 | 
59 | ### 👥 **User Experience**
60 | - **Faster Model Access**: Quickly find and select frequently used models
61 | - **Personalized Workflow**: Customize the interface to match individual preferences
62 | - **Reduced Cognitive Load**: Less scrolling and searching through model lists
63 | - **Cross-Session Persistence**: Favorites maintained across browser sessions and devices
64 | 
65 | ### ⚡ **Performance**
66 | - **Optimized Queries**: Efficient database operations with proper indexing
67 | - **Optimistic Updates**: Instant UI feedback reduces perceived latency
68 | - **Caching Strategy**: Client-side state management reduces server requests
69 | - **Debounced Operations**: Prevents excessive API calls during rapid interactions
70 | 
71 | ### 🎯 **Developer Experience**
72 | - **Modular Architecture**: Clean separation of concerns with dedicated services
73 | - **Type Safety**: Full TypeScript support for favorites functionality
74 | - **Extensible Design**: Foundation for future enhancements like categories and bulk operations
75 | - **Comprehensive Testing**: Ready for unit, integration, and end-to-end testing
76 | 
77 | ## 🔄 Migration Notes
78 | 
79 | ### ✅ **Automatic Migration**
80 | - Database schema updates are handled automatically via Drizzle migrations
81 | - No manual intervention required for existing users
82 | - Existing model preferences and settings remain unchanged
83 | 
84 | ### 🔧 **Configuration**
85 | - No additional environment variables required
86 | - Feature is enabled by default for all authenticated users
87 | - Anonymous users can still access all models but cannot save favorites
88 | 
89 | ## 🚀 Deployment
90 | 
91 | ### 📦 **Production Ready**
92 | - All database migrations included and tested
93 | - Backward compatible with existing installations
94 | - No breaking changes to existing APIs or components
95 | 
96 | ### 🔍 **Monitoring**
97 | - API endpoints include proper error handling and logging
98 | - Performance metrics available for favorite operations
99 | - User adoption can be tracked through database analytics
100 | 
101 | ### 🛠️ **Development**
102 | - Run `pnpm install` to update dependencies
103 | - Database migrations run automatically on next startup
104 | - No additional setup required for development environments
105 | 
106 | ---
107 | 
108 | **Full Changelog**: [v0.25.0...v0.26.0](https://github.com/brooksy4503/chatlima/compare/v0.25.0...v0.26.0)
109 | 
110 | **Contributors**: Thanks to all contributors who made this release possible! 🙏
111 | 
112 | **Next Up**: Stay tuned for upcoming features including model categories, bulk operations, and enhanced personalization options. 
```

releases/RELEASE_NOTES_v0.27.0.md
```
1 | # 🚀 ChatLima v0.27.0 - Intelligent Suggested Prompts & Enhanced UX
2 | 
3 | ## 🎯 What's New
4 | 
5 | ### 💡 **Intelligent Suggested Prompts System**
6 | - **Contextual AI Suggestions**: Dynamic prompt suggestions that adapt based on the selected AI model and its capabilities
7 | - **Smart Category Filtering**: Organized prompts by category (coding, creative, research, debugging, optimization, etc.)
8 | - **Model-Aware Recommendations**: Different suggestions for different models (e.g., DeepSeek for coding, Claude for reasoning, Gemini for multimodal tasks)
9 | - **One-Click Prompt Injection**: Instantly send suggested prompts to start productive conversations
10 | - **Search & Discovery**: Built-in search functionality to quickly find relevant prompts
11 | 
12 | ### 🎨 **Enhanced Chat Experience** 
13 | - **Integrated Prompt Suggestions**: Seamlessly embedded suggested prompts within the chat interface
14 | - **Project Overview Integration**: Enhanced project overview component with direct message sending capabilities
15 | - **Improved User Onboarding**: New users can quickly discover useful prompts to get started
16 | - **Personalized Suggestions**: Contextual prompts that adapt to your workflow and selected models
17 | 
18 | ### 🧪 **Comprehensive Testing Infrastructure**
19 | - **Complete Test Coverage**: Extensive Jest test suite covering all new components and functionality
20 | - **React Testing Library Integration**: Modern testing patterns following best practices
21 | - **Component Testing**: Individual tests for SuggestedPrompts, Chat, ProjectOverview, and utility functions
22 | - **Coverage Organization**: Well-structured test organization for maintainability
23 | 
24 | ## 🔧 Technical Implementation
25 | 
26 | ### ⚡ **Smart Prompt Engine**
27 | - **Model Capability Detection**: Analyzes AI model features (reasoning, vision, creative abilities) to suggest relevant prompts
28 | - **Dynamic Suggestion Generation**: Context-aware prompt generation based on model type and user preferences
29 | - **Performance Optimized**: Efficient prompt categorization and filtering for smooth user experience
30 | - **Extensible Architecture**: Easy to add new categories, prompts, and model-specific suggestions
31 | 
32 | ### 🎯 **Component Architecture**
33 | - **`SuggestedPrompts` Component**: Feature-rich component with search, filtering, and category organization
34 | - **Enhanced Chat Integration**: Seamless integration with existing chat functionality
35 | - **Utility Functions**: Comprehensive `suggested-prompts-utils.tsx` for managing prompt logic
36 | - **Type-Safe Implementation**: Full TypeScript support with proper typing for all new functionality
37 | 
38 | ### 🔍 **Advanced Features**
39 | - **Category Color Coding**: Visual organization with distinct colors for different prompt categories
40 | - **Icon Integration**: Rich iconography using Lucide React icons for better visual hierarchy
41 | - **Responsive Design**: Mobile-friendly interface that works across all device sizes
42 | - **Accessibility**: Proper ARIA labels and keyboard navigation support
43 | 
44 | ## 🎨 User Experience Enhancements
45 | 
46 | ### 🚀 **Productivity Improvements**
47 | - **Instant Productivity**: Jump-start conversations with professionally crafted prompts
48 | - **Learning Acceleration**: Discover new ways to interact with AI models through curated suggestions
49 | - **Workflow Optimization**: Model-specific suggestions help users leverage each AI's strengths
50 | - **Reduced Cognitive Load**: No more "blank page syndrome" - always have relevant starting points
51 | 
52 | ### 🎯 **Smart Suggestions by Model Type**
53 | - **DeepSeek Models**: Specialized coding and technical prompts for engineering tasks
54 | - **Claude Models**: Advanced reasoning and analysis prompts for complex problem-solving
55 | - **Gemini Models**: Multimodal analysis prompts for diverse content types
56 | - **OpenAI Models**: Balanced suggestions covering coding, creative, and analytical tasks
57 | - **General Models**: Universal prompts that work well across all model types
58 | 
59 | ### 📱 **Cross-Platform Experience**
60 | - **Mobile Optimization**: Touch-friendly interface with proper spacing and sizing
61 | - **Desktop Enhancement**: Rich interaction patterns optimized for keyboard and mouse
62 | - **Progressive Enhancement**: Core functionality works across all supported browsers
63 | - **Performance Optimized**: Fast loading and smooth interactions across devices
64 | 
65 | ## 🛡️ Security & Performance
66 | 
67 | ### 🔐 **Security Considerations**
68 | - **Input Validation**: All user interactions properly validated and sanitized
69 | - **Safe Rendering**: Secure handling of dynamic content and user-generated prompts
70 | - **Privacy Focused**: No tracking or analytics on prompt usage patterns
71 | - **Authentication Aware**: Respects user authentication status and permissions
72 | 
73 | ### ⚡ **Performance Optimizations**
74 | - **Lazy Loading**: Components load efficiently to maintain app performance
75 | - **Optimized Rendering**: Smart re-rendering patterns to avoid unnecessary updates
76 | - **Memory Efficient**: Proper cleanup and memory management for suggested prompts
77 | - **Bundle Optimization**: Tree-shaking friendly implementation to minimize bundle size
78 | 
79 | ## 🧪 Testing & Quality Assurance
80 | 
81 | ### ✅ **Comprehensive Test Suite**
82 | - **Unit Testing**: Complete coverage of all utility functions and component logic
83 | - **Integration Testing**: End-to-end testing of prompt selection and message sending
84 | - **Component Testing**: Thorough testing of UI interactions and state management
85 | - **Accessibility Testing**: Ensures all features work with screen readers and keyboard navigation
86 | 
87 | ### 🔧 **Development Tools**
88 | - **Jest Configuration**: Optimized Jest setup with proper TypeScript support
89 | - **Testing Utilities**: Custom test utilities for suggested prompts functionality
90 | - **Mock Implementations**: Comprehensive mocking for external dependencies
91 | - **Coverage Reporting**: Detailed test coverage reports for quality assurance
92 | 
93 | ## 📈 Benefits
94 | 
95 | ### 👥 **User Benefits**
96 | - **Faster Onboarding**: New users can immediately start productive conversations
97 | - **Enhanced Productivity**: Pre-crafted prompts eliminate the need to think of conversation starters
98 | - **Model Discovery**: Learn about different AI model capabilities through targeted suggestions
99 | - **Improved Outcomes**: Professional-grade prompts lead to higher quality AI responses
100 | 
101 | ### 🎯 **Developer Benefits**
102 | - **Extensible System**: Easy to add new categories, prompts, and model-specific suggestions
103 | - **Type Safety**: Full TypeScript support prevents runtime errors
104 | - **Testing Infrastructure**: Comprehensive test coverage ensures reliability
105 | - **Documentation**: Well-documented code with clear patterns for future enhancements
106 | 
107 | ## 🔄 Migration Notes
108 | 
109 | ### ✅ **Seamless Update**
110 | - **Zero Configuration**: Feature works out-of-the-box with existing installations
111 | - **Backward Compatible**: All existing functionality remains unchanged
112 | - **Progressive Enhancement**: New features enhance existing workflows without disruption
113 | - **No Breaking Changes**: Existing API and component interfaces are preserved
114 | 
115 | ### 🚀 **Immediate Availability**
116 | - **Instant Access**: Suggested prompts appear immediately after update
117 | - **No Setup Required**: Feature is enabled by default for all users
118 | - **Cross-Device Sync**: Works consistently across all supported platforms
119 | - **Performance Maintained**: No impact on existing chat performance or functionality
120 | 
121 | ## 🚀 Deployment
122 | 
123 | ### 📦 **Production Ready**
124 | - **Thoroughly Tested**: Extensive testing across multiple environments and devices
125 | - **Performance Validated**: Load testing confirms no impact on application performance
126 | - **Mobile Optimized**: Tested and optimized for iOS and Android devices
127 | - **Browser Compatibility**: Works across all modern browsers and platforms
128 | 
129 | ### 🔍 **Monitoring & Analytics**
130 | - **Error Tracking**: Comprehensive error handling and reporting for prompt functionality
131 | - **Performance Monitoring**: Tracking of component performance and user interactions
132 | - **Quality Metrics**: Monitoring of prompt effectiveness and user engagement
133 | - **Usage Analytics**: Understanding of most popular prompts and categories
134 | 
135 | ### 🛠️ **Development Workflow**
136 | - **Hot Reload Support**: Development server properly handles new component changes
137 | - **Build Optimization**: Production builds include tree-shaking and optimization
138 | - **Type Checking**: Full TypeScript validation during development and build
139 | - **Linting Integration**: ESLint rules properly validate new code patterns
140 | 
141 | ---
142 | 
143 | **Full Changelog**: [v0.26.0...v0.27.0](https://github.com/brooksy4503/chatlima/compare/v0.26.0...v0.27.0)
144 | 
145 | **Contributors**: Thanks to all contributors who made this release possible! 🙏
146 | 
147 | **Next Up**: Stay tuned for upcoming features including conversation branching, advanced prompt templates, and enhanced model analytics!
```

releases/RELEASE_NOTES_v0.28.0.md
```
1 | # 🚀 ChatLima v0.28.0 - Enhanced Prompts & Smart Image Processing
2 | 
3 | ## 🎯 What's New
4 | - **🎨 Template-Powered Suggested Prompts**: Enhanced suggested prompts system with dynamic template functionality for more personalized and contextual prompt suggestions
5 | - **📸 Smart Image Compression**: Implemented intelligent image compression with progressive quality optimization and emergency fallback mechanisms
6 | - **⚡ Optimized Image Processing**: Improved image upload limits and performance with enhanced metadata tracking
7 | - **🛡️ Robust Error Handling**: Added comprehensive fallback systems for image processing failures
8 | 
9 | ## 🔧 Technical Implementation
10 | - Enhanced `suggested-prompts.tsx` component with template-based prompt generation
11 | - Implemented progressive image compression algorithm with multiple quality tiers
12 | - Added smart metadata tracking for compressed images
13 | - Optimized image upload limits for better performance balance
14 | - Integrated emergency fallback mechanisms for image processing failures
15 | - Improved error handling and user feedback for image operations
16 | 
17 | ## 🛡️ Security & Privacy
18 | - Enhanced image processing security with proper validation and sanitization
19 | - Implemented safe fallback mechanisms to prevent processing failures
20 | - Added robust error handling to prevent potential data exposure during image operations
21 | - Maintained user privacy with secure image metadata handling
22 | 
23 | ## 📈 Benefits
24 | - **Improved User Experience**: More relevant and contextual suggested prompts through template functionality
25 | - **Better Performance**: Optimized image processing reduces server load and improves response times
26 | - **Enhanced Reliability**: Progressive compression with fallbacks ensures consistent image handling
27 | - **Reduced Bandwidth**: Smart compression significantly reduces image file sizes without quality loss
28 | - **Faster Loading**: Optimized image limits improve overall application performance
29 | 
30 | ## 🔄 Migration Notes
31 | - No breaking changes in this release
32 | - Image processing improvements are backward compatible
33 | - Existing images and prompts continue to work without modification
34 | - No database migrations required
35 | 
36 | ## 🚀 Deployment
37 | - Standard deployment process applies
38 | - No special configuration changes required
39 | - Compatible with existing environment variables
40 | - Automatic deployment via GitHub integration
41 | 
42 | ## 🧩 Key Components Updated
43 | - `components/suggested-prompts.tsx` - Enhanced with template functionality
44 | - `lib/suggested-prompts-utils.tsx` - Added template processing utilities
45 | - Image processing pipeline - Comprehensive compression and optimization
46 | - Error handling systems - Improved robustness and user feedback
47 | 
48 | ## 🎉 Developer Experience
49 | - Better prompt development workflow with template system
50 | - Improved debugging for image processing operations
51 | - Enhanced error messages and logging for troubleshooting
52 | - More maintainable and extensible prompt suggestion architecture
53 | 
54 | ---
55 | 
56 | **Full Changelog**: [v0.27.0...v0.28.0](https://github.com/brooksy4503/chatlima/compare/v0.27.0...v0.28.0)
```

releases/RELEASE_NOTES_v0.29.0.md
```
1 | # 🚀 ChatLima v0.29.0 - Chat Sharing & Enhanced Testing
2 | 
3 | ## 🎯 What's New
4 | - **🔗 Chat Sharing Functionality**: Share your AI conversations with others through secure, privacy-focused shareable links
5 | - **📤 One-Click Chat Export**: Export chat conversations as immutable snapshots that can be viewed by anyone with the link
6 | - **🔒 Privacy-First Sharing**: Automatic PII redaction and content sanitization to protect sensitive information
7 | - **👁️ Read-Only Shared Views**: Shared chats are displayed in a clean, read-only interface with clear sharing indicators
8 | - **🧪 Enhanced Test Coverage**: Comprehensive Jest test suite for improved code quality and reliability
9 | - **⚡ Performance Optimizations**: Better caching and compilation speed improvements
10 | 
11 | ## 🔧 Technical Implementation
12 | - **New API Routes**: 
13 |   - `POST /api/chats/[id]/share` - Create shareable chat links
14 |   - `GET /api/chats/[id]/share` - Check existing shares
15 |   - `GET /api/chats/shared/[shareId]` - Retrieve shared chat content
16 | - **Database Schema**: New `chatShares` table with secure share ID generation using nanoid
17 | - **Chat Sharing Service**: Comprehensive service layer with snapshot creation and PII redaction
18 | - **Shared Chat Components**: 
19 |   - `SharedChatMessages` component for displaying shared content
20 |   - `ChatShareDialog` with consent flow and privacy controls
21 | - **Testing Infrastructure**: Jest configuration with React Testing Library for component testing
22 | - **Security Enhancements**: Automatic sanitization of sensitive data in shared content
23 | 
24 | ## 🛡️ Security & Privacy
25 | - **Automatic PII Redaction**: Removes email addresses, phone numbers, API keys, and other sensitive data
26 | - **Consent-Based Sharing**: Users must explicitly consent before creating shareable links
27 | - **Secure Share IDs**: 32-character nanoid generation for unguessable share URLs
28 | - **Content Sanitization**: Filters out system prompts and tool arguments from shared content
29 | - **Authentication Protection**: Share creation requires user authentication
30 | - **Privacy Indicators**: Clear labeling of shared content as "Read-only" with sharing metadata
31 | 
32 | ## 📈 Benefits
33 | - **Enhanced Collaboration**: Easily share AI conversations with team members, colleagues, or for support
34 | - **Knowledge Sharing**: Export valuable AI interactions for documentation and training purposes
35 | - **Privacy Protection**: Automatic removal of sensitive information ensures safe sharing
36 | - **Better User Experience**: Intuitive sharing dialog with copy-to-clipboard functionality
37 | - **Improved Code Quality**: Comprehensive test coverage reduces bugs and improves maintainability
38 | - **Performance Gains**: Optimized compilation and caching for faster development and runtime
39 | 
40 | ## 🎨 User Experience Improvements
41 | - **Intuitive Share Dialog**: Clean, step-by-step sharing process with clear privacy controls
42 | - **Visual Share Indicators**: Share icons appear in chat lists for shared conversations
43 | - **Copy-to-Clipboard**: One-click copying of shareable URLs with confirmation feedback
44 | - **Responsive Design**: Shared chat views work seamlessly across desktop and mobile devices
45 | - **Clear Privacy Messaging**: Transparent communication about what data is included in shares
46 | 
47 | ## 🔄 Migration Notes
48 | - **Database Migration**: New `chatShares` table automatically created via Drizzle migrations
49 | - **No Breaking Changes**: Existing chat functionality remains unchanged
50 | - **Backward Compatibility**: All existing chats and features continue to work normally
51 | - **Optional Feature**: Chat sharing is opt-in and doesn't affect non-shared chats
52 | 
53 | ## 🚀 Deployment
54 | - **Standard Deployment**: Compatible with existing deployment pipeline
55 | - **Environment Variables**: Uses existing `NEXT_PUBLIC_APP_URL` for share URL generation
56 | - **Database Migrations**: Automatically applied via Drizzle ORM
57 | - **No Special Configuration**: Works with current authentication and database setup
58 | 
59 | ## 🧩 Key Components Added
60 | - `components/chat-share-dialog.tsx` - Main sharing interface with privacy controls
61 | - `components/shared-chat-messages.tsx` - Optimized display for shared content
62 | - `components/shared-message.tsx` - Individual message component for shared views
63 | - `lib/services/chat-sharing.ts` - Core sharing service with security features
64 | - `app/chats/shared/[shareId]/page.tsx` - Public shared chat viewing page
65 | - Enhanced test suite with Jest and React Testing Library
66 | 
67 | ## 🧪 Testing Enhancements
68 | - **Comprehensive Jest Setup**: Full testing environment for React components
69 | - **React Testing Library**: Modern testing patterns for user interaction testing
70 | - **Component Coverage**: Tests for major UI components including chat functionality
71 | - **Mock Infrastructure**: Robust mocking system for external dependencies
72 | - **CI/CD Integration**: Tests run automatically in development and deployment pipelines
73 | 
74 | ## 🎉 Developer Experience
75 | - **Improved Build Performance**: Faster compilation through Next.js optimizations
76 | - **Better Error Handling**: Enhanced error messages and logging for debugging
77 | - **Type Safety**: Full TypeScript coverage for sharing functionality
78 | - **Documentation**: Clear code comments and type definitions for maintainability
79 | - **Testing Tools**: Easy-to-use testing setup for component development
80 | 
81 | ## 🌟 Use Cases
82 | - **Support & Debugging**: Share problematic conversations with support teams
83 | - **Education & Training**: Export example AI interactions for learning materials
84 | - **Team Collaboration**: Share interesting AI responses with colleagues
85 | - **Documentation**: Create permanent records of valuable AI conversations
86 | - **Demonstrations**: Show AI capabilities to clients or stakeholders
87 | 
88 | ---
89 | 
90 | **Full Changelog**: [v0.28.0...v0.29.0](https://github.com/brooksy4503/chatlima/compare/v0.28.0...v0.29.0)
```

releases/RELEASE_NOTES_v0.3.0.md
```
1 | # 🚀 ChatLima v0.3.0 - SEO & Sitemap Implementation
2 | 
3 | ## 🎯 What's New
4 | 
5 | ### 📍 Dynamic Sitemap Generation
6 | - **New Feature**: Added `/sitemap.xml` route with intelligent content generation
7 | - **Production-Only**: Sitemap is only available on production domain (`chatlima.com`) for security
8 | - **SEO Optimized**: Includes proper XML structure with `lastmod`, `changefreq`, and `priority` attributes
9 | - **Privacy-First**: Excludes private user content (chats, API endpoints, authentication pages)
10 | - **Extensible**: Easy-to-maintain structure for adding future public pages
11 | 
12 | ### 🤖 Enhanced Robots.txt
13 | - **Environment-Aware**: Different rules for production vs development environments
14 | - **Privacy Protection**: Explicitly disallows crawling of user chat content and sensitive endpoints
15 | - **Production Ready**: Allows search engine crawling of public pages while protecting user privacy
16 | - **Development Safe**: Completely disallows crawling in non-production environments
17 | 
18 | ## 🔧 Technical Implementation
19 | 
20 | ### Sitemap Features
21 | - Dynamic base URL detection using request headers
22 | - Proper XML formatting following sitemap protocol standards
23 | - 24-hour caching for optimal performance
24 | - Structured for easy addition of future pages (docs, pricing, about, etc.)
25 | 
26 | ### Robots.txt Features
27 | - Environment detection based on domain
28 | - Comprehensive crawl rules protecting user privacy
29 | - Sitemap reference for search engines
30 | - 1-hour caching for efficient delivery
31 | 
32 | ## 🛡️ Security & Privacy
33 | 
34 | - **User Privacy**: Chat content and user-specific pages are completely excluded from search indexing
35 | - **API Protection**: All API endpoints are disallowed from crawling
36 | - **Authentication Security**: Auth-related pages are protected from indexing
37 | - **Development Safety**: Non-production environments block all crawling
38 | 
39 | ## 📈 SEO Benefits
40 | 
41 | - **Search Engine Discovery**: Proper sitemap helps search engines find and index public content
42 | - **Crawl Efficiency**: Robots.txt guides search engines to relevant content while avoiding private areas
43 | - **Performance**: Caching headers ensure efficient delivery of SEO files
44 | - **Standards Compliance**: Follows official sitemap and robots.txt protocols
45 | 
46 | ## 🔄 Migration Notes
47 | 
48 | - No breaking changes in this release
49 | - New routes are automatically available: `/sitemap.xml` and `/robots.txt`
50 | - No database migrations required
51 | - No configuration changes needed
52 | 
53 | ## 🚀 Deployment
54 | 
55 | This release is ready for production deployment with no additional setup required. The sitemap and robots.txt will automatically adapt to your deployment environment.
56 | 
57 | ---
58 | 
59 | **Full Changelog**: [v0.2.0...v0.3.0](https://github.com/your-username/chatlima/compare/v0.2.0...v0.3.0)
60 | 
61 | ## 👥 Contributors
62 | 
63 | Thanks to all contributors who made this release possible!
64 | 
65 | ---
66 | 
67 | *For questions or issues, please open a GitHub issue or reach out to the maintainers.* 
```

releases/RELEASE_NOTES_v0.3.1.md
```
1 | # 🚀 ChatLima v0.3.1 - Documentation Link Update
2 | 
3 | ## 🎯 What's New
4 | - Added a new link to the documentation website.
5 | 
6 | ## 🔧 Technical Implementation
7 | - Updated relevant files to include the new documentation link.
8 | 
9 | ## 🛡️ Security & Privacy
10 | - No security or privacy related changes in this update.
11 | 
12 | ## 📈 Benefits
13 | - Improved access to documentation for users.
14 | 
15 | ## 🔄 Migration Notes
16 | - No breaking changes.
17 | - No configuration changes required.
18 | - No database migrations needed.
19 | 
20 | ## 🚀 Deployment
21 | - Standard deployment procedures apply.
22 | - No special environment considerations.
23 | - No special setup requirements.
24 | 
25 | ---
26 | 
27 | **Full Changelog**: [v0.3.0...v0.3.1](https://github.com/brooksy4503/chatlima/compare/v0.3.0...v0.3.1) 
```

releases/RELEASE_NOTES_v0.4.0.md
```
1 | # 🚀 ChatLima v0.4.0 - Support for DeepSeek R1 0528
2 | 
3 | ## 🎯 What's New
4 | - Added support for the DeepSeek R1 0528 model.
5 | - Users can now select DeepSeek R1 0528 for chat interactions.
6 | - Enhanced model selection capabilities in the UI.
7 | 
8 | ## 🔧 Technical Implementation
9 | - Integrated DeepSeek R1 0528 API.
10 | - Updated model provider logic to include DeepSeek.
11 | - Modified chat interface to accommodate new model options.
12 | - New API route for DeepSeek interactions (if applicable, specify route).
13 | 
14 | ## 🛡️ Security & Privacy
15 | - Ensured secure API key management for DeepSeek.
16 | - Maintained existing privacy standards with the new model integration.
17 | - No changes to user data handling.
18 | 
19 | ## 📈 Benefits
20 | - Access to a new, powerful language model.
21 | - Potentially improved response quality and capabilities.
22 | - More options for users to tailor their chat experience.
23 | 
24 | ## 🔄 Migration Notes
25 | - No breaking changes.
26 | - Ensure DeepSeek API key is configured in environment variables if self-hosting.
27 | - No database migrations needed.
28 | 
29 | ## 🚀 Deployment
30 | - Standard deployment process.
31 | - Verify DeepSeek API connectivity in the production environment.
32 | - Ensure `.env` includes `DEEPSEEK_API_KEY` (or similar).
33 | 
34 | ---
35 | 
36 | **Full Changelog**: [v0.3.1...v0.4.0](https://github.com/brooksy4503/chatlima/compare/v0.3.1...v0.4.0) 
```

releases/RELEASE_NOTES_v0.4.1.md
```
1 | # 🚀 ChatLima v0.4.1 - Model Updates and Refinements
2 | 
3 | ## 🎯 What's New
4 | - Added new DeepSeek R1 0528 model to disabled servers list for specific configurations.
5 | - Updated DeepSeek R1 0528 model description and capabilities for better user understanding.
6 | 
7 | ## 🔧 Technical Implementation
8 | - Refactored model descriptions for Grok models These models can use Tool Calling (MCP Servers).
9 | - Enhanced error handling in the chat API for clearer responses and improved debugging.
10 | 
11 | ---
12 | 
13 | **Full Changelog**: [v0.4.0...v0.4.1](https://github.com/username/chatlima/compare/v0.4.0...v0.4.1) 
```

releases/RELEASE_NOTES_v0.5.0.md
```
1 | # 🚀 ChatLima v0.5.0 - Premium Access Control & Enhanced Model Management
2 | 
3 | ## 🎯 What's New
4 | - **Premium Model Access Control**: Introduced intelligent credit checking system for premium AI models
5 | - **Enhanced Model Management**: Added new "DeepSeek R1 0528 Qwen3 8B" model with proper access controls
6 | - **Improved User Experience**: Better feedback and access control throughout the application
7 | - **Smart Model Picker**: Real-time premium access validation in model selection interface
8 | 
9 | ## 🔧 Technical Implementation
10 | - Added premium flag support to model definitions for fine-grained access control
11 | - Implemented credit checking logic in chat API (`/api/chat`) for premium model usage
12 | - Enhanced model picker component with real-time premium access validation
13 | - Updated chat API to include new DeepSeek R1 model in server-specific disabled lists
14 | - Improved error handling and user feedback mechanisms across the platform
15 | 
16 | ## 🛡️ Security & Privacy
17 | - Robust access control prevents unauthorized use of premium models
18 | - Server-side validation ensures credit requirements are properly enforced
19 | - Enhanced error handling provides clear feedback without exposing sensitive system details
20 | 
21 | ## 📈 Benefits
22 | - **Better User Experience**: Clear feedback when premium models require credits
23 | - **Resource Management**: Prevents accidental usage of premium models without sufficient credits
24 | - **Improved Performance**: Optimized model access validation reduces unnecessary API calls
25 | - **Enhanced Accessibility**: Better model availability management across different server configurations
26 | 
27 | ## 🔄 Migration Notes
28 | - No breaking changes in this release
29 | - Existing chat sessions and model preferences are preserved
30 | - Premium model access is now properly validated - users may need sufficient credits to access certain models
31 | 
32 | ## 🚀 Deployment
33 | - Standard deployment process applies
34 | - No database migrations required
35 | - Environment variables remain unchanged
36 | - Ensure credit system is properly configured for premium model access
37 | 
38 | ## 🎨 User Interface Enhancements
39 | - Model picker now shows real-time premium access status
40 | - Improved error messages for better user guidance
41 | - Enhanced visual feedback for model availability
42 | 
43 | ---
44 | 
45 | **Full Changelog**: [v0.4.1...v0.5.0](https://github.com/brooksy4503/chatlima/compare/v0.4.1...v0.5.0) 
```

releases/RELEASE_NOTES_v0.5.1.md
```
1 | # 🚀 ChatLima v0.5.1 - Debugging & Traceability Enhancements
2 | 
3 | ## 🎯 What's New
4 | - Enhanced debugging capabilities in credits API and user credits tracking
5 | - Improved error traceability across session validation and credit management
6 | - Better development experience with comprehensive logging for troubleshooting
7 | - Cleaner repository structure with updated .gitignore configurations
8 | 
9 | ## 🔧 Technical Implementation
10 | - **Enhanced Debugging Logs**: Added comprehensive debug logging to credits API endpoints for better issue diagnosis
11 | - **useCredits Hook Improvements**: Enhanced the useCredits hook with detailed error tracking and session validation logs
12 | - **Repository Cleanup**: Added documentation directory to .gitignore to maintain cleaner version control
13 | - **Error Handling**: Improved error handling and logging in credit fetching operations for better debugging
14 | 
15 | ## 🛡️ Security & Privacy
16 | - Enhanced session validation logging helps identify potential authentication issues
17 | - Improved credit system monitoring maintains better financial security oversight
18 | - Debug logs are structured to avoid exposing sensitive user information
19 | 
20 | ## 📈 Benefits
21 | - **Developer Experience**: Faster debugging and issue resolution with detailed logging
22 | - **System Reliability**: Better monitoring of credit operations reduces financial discrepancies
23 | - **Troubleshooting**: Enhanced traceability makes it easier to identify and fix issues
24 | - **Maintenance**: Cleaner repository structure improves long-term maintainability
25 | 
26 | ## 🔄 Migration Notes
27 | - No breaking changes in this patch release
28 | - Existing functionality remains fully compatible
29 | - Debug logs are automatically enabled - no configuration changes required
30 | - .gitignore updates are automatically applied
31 | 
32 | ## 🚀 Deployment
33 | - Standard deployment process applies
34 | - No additional setup or configuration required
35 | - Compatible with all existing environments
36 | - Debug logging works in both development and production environments
37 | 
38 | ## 🔍 Technical Details
39 | - **Files Enhanced**: Credits API routes, useCredits hook implementation
40 | - **Logging Scope**: Session validation, credit fetching, error handling
41 | - **Development**: Improved .gitignore for documentation directories
42 | - **Monitoring**: Better visibility into credit system operations
43 | 
44 | ---
45 | 
46 | **Full Changelog**: [v0.5.0...v0.5.1](https://github.com/brooksy4503/chatlima/compare/v0.5.0...v0.5.1) 
```

releases/RELEASE_NOTES_v0.5.2.md
```
1 | # 🚀 ChatLima v0.5.2 - Enhanced Credit Management & Error Handling
2 | 
3 | ## 🎯 What's New
4 | - **Improved Credit Balance Checks**: Enhanced validation to prevent negative credit balance issues
5 | - **Better Error Handling**: More robust error handling in chat API for better user experience
6 | - **Enhanced Token Usage Tracking**: Refined credit deduction logic for more accurate billing
7 | - **Cleaner Codebase**: Updated .gitignore for better project management
8 | 
9 | ## 🔧 Technical Implementation
10 | - **Credit Management Overhaul**: Implemented comprehensive checks for negative credit balances in chat API
11 | - **Enhanced Credit Fetching Logic**: Improved credit retrieval mechanisms with better error handling
12 | - **Refined Token Usage Tracking**: Updated credit deduction logic to ensure accurate reporting and user feedback
13 | - **Project Maintenance**: Added Aider-related files to .gitignore for better development workflow management
14 | 
15 | ## 🛡️ Security & Privacy
16 | - **Credit Validation**: Strengthened credit balance validation to prevent unauthorized usage
17 | - **Error Response Security**: Improved error handling to avoid exposing sensitive information
18 | - **User Session Protection**: Enhanced session validation for better security
19 | 
20 | ## 📈 Benefits
21 | - **Improved User Experience**: Better error messages and feedback when credit issues occur
22 | - **More Accurate Billing**: Enhanced token tracking ensures users are charged correctly
23 | - **Reduced Support Issues**: Better error handling prevents common credit-related problems
24 | - **Development Efficiency**: Cleaner project structure with improved .gitignore management
25 | 
26 | ## 🔄 Migration Notes
27 | - No breaking changes in this patch release
28 | - All existing functionality remains compatible
29 | - Credit management improvements are automatically applied
30 | 
31 | ## 🚀 Deployment
32 | - Standard deployment process applies
33 | - No special configuration changes required
34 | - Enhanced error handling will automatically improve user experience
35 | 
36 | ---
37 | 
38 | **Full Changelog**: [v0.5.1...v0.5.2](https://github.com/brooksy4503/chatlima/compare/v0.5.1...v0.5.2) 
```

releases/RELEASE_NOTES_v0.6.0.md
```
1 | # 🚀 ChatLima v0.6.0 - OpenRouter Pricing Analysis Tool
2 | 
3 | ## 🎯 What's New
4 | 
5 | - **📊 Real-time Pricing Analysis**: New developer tool to analyze OpenRouter model costs in real-time
6 | - **💰 Cost Planning Dashboard**: Calculate estimated costs for different user scenarios (anonymous vs Google users)
7 | - **📈 Data-Driven Insights**: Token estimates based on actual ChatLima usage data from 1,254 real API requests
8 | - **🎯 Model Comparison**: Side-by-side cost analysis for all ChatLima-configured models
9 | - **📋 Formatted Reports**: Clean table output with daily/monthly cost projections
10 | 
11 | ## 🔧 Technical Implementation
12 | 
13 | ### New Scripts Added:
14 | - **`scripts/openrouter-pricing-analysis.ts`**: Main pricing analysis tool with real-time API integration
15 | - **`scripts/analyze-openrouter-data.py`**: Python script for analyzing historical usage data
16 | - **`scripts/README.md`**: Comprehensive documentation for developer tools
17 | 
18 | ### Enhanced Package Configuration:
19 | - Added `tsx` dependency for TypeScript script execution
20 | - New npm script: `pricing:analysis` for easy tool execution
21 | - Updated package.json with real-world token estimates
22 | 
23 | ### Key Technical Features:
24 | - Direct OpenRouter API integration for live pricing data
25 | - TypeScript implementation with proper error handling
26 | - Configurable token estimates based on actual usage patterns
27 | - Support for both npm and direct execution methods
28 | 
29 | ## 🛡️ Security & Privacy
30 | 
31 | - **🔐 API Key Protection**: Secure handling of OpenRouter API credentials via environment variables
32 | - **🎯 Developer-Only Tool**: Scripts are designed for development/analysis use only, not user-facing
33 | - **📊 Privacy-First Data Analysis**: Historical usage analysis uses aggregated, anonymized data
34 | 
35 | ## 📈 Benefits
36 | 
37 | ### For Developers:
38 | - **💡 Informed Decision Making**: Choose cost-effective models based on real data
39 | - **📊 Budget Forecasting**: Accurate monthly cost projections for different usage scenarios
40 | - **🔍 Real-time Monitoring**: Track pricing changes and model performance
41 | - **⚡ Quick Analysis**: Run pricing analysis in seconds with simple npm command
42 | 
43 | ### For Business:
44 | - **💰 Cost Optimization**: Identify most cost-effective models for different use cases
45 | - **📈 Scalability Planning**: Understand cost implications of user growth
46 | - **🎯 Model Strategy**: Data-driven model selection for optimal cost/performance ratio
47 | 
48 | ### For Users:
49 | - **🚀 Better Performance**: Optimized model selection based on cost-effectiveness analysis
50 | - **💚 Sustainable Service**: Enhanced cost management supports long-term service sustainability
51 | 
52 | ## 📊 Data-Driven Accuracy
53 | 
54 | ### Real Usage Analysis:
55 | - Analyzed **1,254 actual ChatLima requests** from OpenRouter API
56 | - **Input tokens**: 2,701 average (based on real avg: 2,251 + 20% buffer)
57 | - **Output tokens**: 441 average (based on real avg: 368 + 20% buffer)
58 | - **More accurate projections**: ~$0.003/request vs previous overestimates
59 | 
60 | ### Model Coverage:
61 | - Analysis covers all ChatLima-configured models
62 | - Real-time pricing from OpenRouter API
63 | - Cost comparison across 30+ AI models
64 | 
65 | ## 🔄 Migration Notes
66 | 
67 | ### For Developers:
68 | - No breaking changes to existing functionality
69 | - New optional tool requires OpenRouter API key in `.env` file
70 | - Scripts are completely separate from main application code
71 | 
72 | ### Environment Setup:
73 | ```bash
74 | # Add to your .env file (for developers only)
75 | OPENROUTER_API_KEY=your_api_key_here
76 | ```
77 | 
78 | ### New Commands Available:
79 | ```bash
80 | # Run pricing analysis
81 | pnpm run pricing:analysis
82 | 
83 | # Analyze historical data (if you have CSV exports)
84 | python scripts/analyze-openrouter-data.py /path/to/data.csv
85 | ```
86 | 
87 | ## 🚀 Deployment
88 | 
89 | ### Development Environment:
90 | 1. Ensure OpenRouter API key is configured in `.env`
91 | 2. Install dependencies: `pnpm install`
92 | 3. Run analysis: `pnpm run pricing:analysis`
93 | 
94 | ### Production Considerations:
95 | - Scripts are development-only tools
96 | - No impact on production application
97 | - No new environment variables required for production deployment
98 | 
99 | ## 🎯 Usage Examples
100 | 
101 | ### Quick Cost Analysis:
102 | ```bash
103 | pnpm run pricing:analysis
104 | ```
105 | 
106 | ### Expected Output:
107 | - Detailed pricing table for all models
108 | - Daily/monthly cost estimates
109 | - Most/least expensive model identification
110 | - Price comparison ratios
111 | 
112 | ### Use Cases:
113 | - **Pre-deployment**: Cost planning for new features
114 | - **Model Selection**: Choose optimal models for specific scenarios
115 | - **Budget Planning**: Monthly cost forecasting
116 | - **Performance Monitoring**: Track pricing trends over time
117 | 
118 | ## 🔮 Future Enhancements
119 | 
120 | - Automated pricing alerts for significant changes
121 | - Historical pricing trend analysis
122 | - Integration with usage monitoring
123 | - Cost optimization recommendations
124 | 
125 | ---
126 | 
127 | **Full Changelog**: [v0.5.2...v0.6.0](https://github.com/brooksy4503/chatlima/compare/v0.5.2...v0.6.0)
128 | 
129 | ## 🙏 Acknowledgments
130 | 
131 | This release includes pricing analysis based on real ChatLima usage data, providing developers with accurate, data-driven insights for cost optimization and model selection. 
```

releases/RELEASE_NOTES_v0.8.0.md
```
1 | # 🚀 ChatLima v0.8.0 - Requesty Provider & Enhanced Model Selection
2 | 
3 | ## 🎯 What's New
4 | - **New AI Provider**: Introduced Requesty as a new AI provider option alongside OpenRouter, Anthropic, OpenAI, Groq, and X AI
5 | - **7 New Requesty Models**: Access popular AI models through Requesty's infrastructure:
6 |   - `requesty/openai/gpt-4o` - OpenAI's advanced GPT-4O model
7 |   - `requesty/openai/gpt-4o-mini` - Efficient GPT-4O Mini variant  
8 |   - `requesty/anthropic/claude-3.5-sonnet` - Anthropic's Claude 3.5 Sonnet
9 |   - `requesty/anthropic/claude-3.7-sonnet` - Latest Claude 3.7 Sonnet
10 |   - `requesty/google/gemini-2.5-flash-preview` - Google's Gemini 2.5 Flash
11 |   - `requesty/meta-llama/llama-3.1-70b-instruct` - Meta's Llama 3.1 70B
12 |   - `requesty/anthropic/claude-sonnet-4-20250514` - Claude Sonnet 4 (May 2025)
13 | - **New OpenRouter Model**: Added `google/gemini-2.5-pro-preview` - Google's state-of-the-art AI model for advanced reasoning, coding, mathematics, and scientific tasks
14 | - **Enhanced Model Diversity**: Users now have access to 8 additional high-quality AI models across multiple providers
15 | 
16 | ## 🔧 Technical Implementation
17 | - Integrated `@requesty/ai-sdk` package (version ^0.0.7) for Requesty provider support
18 | - Added Requesty client configuration with proper API key management and headers
19 | - Updated `ai/providers.ts` with comprehensive Requesty model definitions
20 | - Enhanced model metadata with detailed capabilities, pricing tiers, and web search support
21 | - Maintained consistent provider architecture for seamless integration
22 | - Added proper error handling and API key fallback mechanisms
23 | 
24 | ## 🛡️ Security & Privacy
25 | - Implemented secure API key management for Requesty provider through environment variables
26 | - Added proper request headers including HTTP-Referer and X-Title for provider identification
27 | - Maintained existing security protocols across all provider integrations
28 | - Ensured consistent authentication flow for new provider
29 | 
30 | ## 📈 Benefits
31 | - **Expanded Choice**: Users can now choose from 8 additional AI models based on their specific needs
32 | - **Provider Redundancy**: Multiple providers offer increased reliability and availability
33 | - **Cost Options**: Mix of premium and standard models provides flexibility for different use cases
34 | - **Performance Variety**: Access to models optimized for different tasks (reasoning, coding, efficiency)
35 | - **Future-Proofing**: Establishes foundation for easy addition of more Requesty models
36 | 
37 | ## 🔄 Migration Notes
38 | - **No Breaking Changes**: Existing users continue to use their current models without any changes
39 | - **Automatic Detection**: New Requesty models are automatically available in the model picker
40 | - **API Key Setup**: Users wanting to use Requesty models need to add `REQUESTY_API_KEY` to their environment variables
41 | - **Backward Compatibility**: All existing OpenRouter, Anthropic, OpenAI, Groq, and X AI models remain fully functional
42 | 
43 | ## 🚀 Deployment
44 | - No special deployment requirements - changes are backward compatible
45 | - New models become available immediately after deployment
46 | - Users can start using Requesty models by adding their API key to environment variables
47 | - All existing functionality remains unchanged
48 | 
49 | ## 🎯 Model Highlights
50 | 
51 | ### Requesty Provider Models:
52 | - **GPT-4O Series**: Advanced OpenAI models with reasoning and multimodal capabilities
53 | - **Claude Series**: Anthropic's latest models including Claude 3.5, 3.7, and Sonnet 4
54 | - **Gemini 2.5 Flash**: Google's fast and efficient model optimized for speed
55 | - **Llama 3.1 70B**: Meta's open-source model for instruction following
56 | 
57 | ### OpenRouter Addition:
58 | - **Gemini 2.5 Pro Preview**: Google's flagship model for advanced reasoning and scientific tasks
59 | 
60 | ---
61 | 
62 | **Full Changelog**: [v0.7.0...v0.8.0](https://github.com/brooksy4503/chatlima/compare/v0.7.0...v0.8.0) 
```

releases/RELEASE_NOTES_v0.9.0.md
```
1 | # 🚀 ChatLima v0.9.0 - Enhanced API Key Management
2 | 
3 | ## 🎯 What's New
4 | - **Dynamic API Key Management**: Runtime API key overrides for all AI providers
5 | - **Enhanced Client Creation**: New helper functions for creating clients with custom API keys
6 | - **Improved UI Experience**: Better API key settings interface in the chat and sidebar components
7 | - **Flexible Provider Configuration**: Support for per-request API key customization
8 | 
9 | ## 🔧 Technical Implementation
10 | - Added new provider helper functions supporting runtime API key overrides
11 | - Introduced dynamic client creation utilities for flexible API key management
12 | - Enhanced chat and sidebar components with new API key management features
13 | - Improved user interface for API key configuration and settings
14 | - Streamlined provider initialization with dynamic configuration support
15 | 
16 | ## 🛡️ Security & Privacy
17 | - Enhanced API key handling with secure runtime management
18 | - Improved isolation of API key configurations per request
19 | - Better protection of user-provided API keys through dynamic handling
20 | - Secure client creation patterns for API key management
21 | 
22 | ## 📈 Benefits
23 | - **User Flexibility**: Users can now provide their own API keys for any supported provider
24 | - **Cost Control**: Better control over API usage and costs with custom keys
25 | - **Provider Independence**: Reduced dependency on system-wide API key configurations
26 | - **Enhanced UX**: Streamlined interface for managing API keys across different providers
27 | 
28 | ## 🔄 Migration Notes
29 | - No breaking changes in this release
30 | - Existing API key configurations remain fully compatible
31 | - New dynamic features are additive and optional
32 | - All existing provider integrations continue to work unchanged
33 | 
34 | ## 🚀 Deployment
35 | - Standard deployment process applies
36 | - No additional configuration required
37 | - New features are automatically available after deployment
38 | - Backward compatibility maintained for all existing functionality
39 | 
40 | ---
41 | 
42 | **Full Changelog**: [v0.8.0...v0.9.0](https://github.com/brooksy4503/chatlima/compare/v0.8.0...v0.9.0) 
```

releases/RELEASE_NOTES_v0.9.1.md
```
1 | # 🚀 ChatLima v0.9.1 - Smart Credit Validation
2 | 
3 | ## 🎯 What's New
4 | - **Smart Credit Validation**: Intelligent credit checking that bypasses validation when users provide their own API keys
5 | - **Enhanced User Experience**: Users with personal API keys now get seamless access without credit deductions
6 | - **Flexible Payment Model**: Automatic detection of user-provided API keys to optimize credit usage
7 | 
8 | ## 🔧 Technical Implementation
9 | - Added `isUsingOwnApiKey()` helper function to detect when users are using personal API keys
10 | - Enhanced credit validation logic in chat route to conditionally bypass credit checks
11 | - Improved request handling with intelligent API key detection
12 | - Streamlined credit deduction process for better user experience
13 | - Updated chat route logic with 72 insertions and 36 deletions for robust implementation
14 | 
15 | ## 🛡️ Security & Privacy
16 | - Secure API key detection without exposing sensitive information
17 | - Improved credit validation logic that maintains security while enhancing flexibility
18 | - Safe handling of user-provided API keys during validation process
19 | 
20 | ## 📈 Benefits
21 | - **Cost Efficiency**: Users with personal API keys avoid unnecessary credit deductions
22 | - **Better UX**: Seamless experience for users who provide their own API keys
23 | - **Smart Resource Management**: Automatic optimization of credit usage based on API key source
24 | - **Enhanced Flexibility**: System adapts to different user configurations automatically
25 | 
26 | ## 🔄 Migration Notes
27 | - No breaking changes in this patch release
28 | - Existing credit validation continues to work for users without personal API keys
29 | - New logic is additive and automatically detects the optimal validation path
30 | - All existing functionality remains fully compatible
31 | 
32 | ## 🚀 Deployment
33 | - Standard deployment process applies
34 | - No additional configuration required
35 | - Changes are automatically active after deployment
36 | - Backward compatibility maintained for all user scenarios
37 | 
38 | ---
39 | 
40 | **Full Changelog**: [v0.9.0...v0.9.1](https://github.com/brooksy4503/chatlima/compare/v0.9.0...v0.9.1) 
```

scripts/analyze-openrouter-data.py
```
1 | #!/usr/bin/env python3
2 | 
3 | """
4 | OpenRouter Data Analysis Script
5 | 
6 | This script analyzes the OpenRouter activity CSV to determine realistic token estimates
7 | for the pricing analysis tool.
8 | 
9 | Usage: python scripts/analyze-openrouter-data.py /path/to/openrouter_activity.csv
10 | """
11 | 
12 | import csv
13 | import statistics
14 | import sys
15 | from collections import defaultdict
16 | 
17 | def analyze_openrouter_data(csv_file_path):
18 |     """Analyze OpenRouter CSV data to extract token usage statistics."""
19 |     
20 |     data = []
21 |     app_stats = defaultdict(list)
22 |     model_stats = defaultdict(list)
23 |     
24 |     print("🔍 Analyzing OpenRouter activity data...")
25 |     print("=" * 50)
26 |     
27 |     # Read and parse CSV data
28 |     with open(csv_file_path, 'r') as file:
29 |         reader = csv.DictReader(file)
30 |         for row in reader:
31 |             # Filter for actual completion data (exclude cancelled/failed)
32 |             if (row['tokens_prompt'] and row['tokens_completion'] and 
33 |                 row['cancelled'] == 'false' and 
34 |                 int(row['tokens_prompt']) > 0 and 
35 |                 int(row['tokens_completion']) > 0):
36 |                 
37 |                 prompt_tokens = int(row['tokens_prompt'])
38 |                 completion_tokens = int(row['tokens_completion'])
39 |                 app_name = row['app_name']
40 |                 model = row['model_permaslug']
41 |                 cost = float(row['cost_total']) if row['cost_total'] else 0
42 |                 
43 |                 data.append({
44 |                     'prompt_tokens': prompt_tokens,
45 |                     'completion_tokens': completion_tokens,
46 |                     'total_tokens': prompt_tokens + completion_tokens,
47 |                     'app_name': app_name,
48 |                     'model': model,
49 |                     'cost': cost
50 |                 })
51 |                 
52 |                 app_stats[app_name].append({
53 |                     'prompt': prompt_tokens,
54 |                     'completion': completion_tokens,
55 |                     'total': prompt_tokens + completion_tokens
56 |                 })
57 |                 
58 |                 model_stats[model].append({
59 |                     'prompt': prompt_tokens,
60 |                     'completion': completion_tokens,
61 |                     'total': prompt_tokens + completion_tokens,
62 |                     'cost': cost
63 |                 })
64 |     
65 |     if not data:
66 |         print("❌ No valid data found in CSV file!")
67 |         return
68 |     
69 |     print(f"📊 Analyzed {len(data)} valid API requests")
70 |     print()
71 |     
72 |     # Overall statistics
73 |     prompt_tokens = [d['prompt_tokens'] for d in data]
74 |     completion_tokens = [d['completion_tokens'] for d in data]
75 |     total_tokens = [d['total_tokens'] for d in data]
76 |     costs = [d['cost'] for d in data if d['cost'] > 0]
77 |     
78 |     print("📈 OVERALL TOKEN STATISTICS")
79 |     print("-" * 30)
80 |     print(f"Prompt Tokens:")
81 |     print(f"  • Average: {statistics.mean(prompt_tokens):,.0f}")
82 |     print(f"  • Median:  {statistics.median(prompt_tokens):,.0f}")
83 |     print(f"  • Min:     {min(prompt_tokens):,.0f}")
84 |     print(f"  • Max:     {max(prompt_tokens):,.0f}")
85 |     print()
86 |     
87 |     print(f"Completion Tokens:")
88 |     print(f"  • Average: {statistics.mean(completion_tokens):,.0f}")
89 |     print(f"  • Median:  {statistics.median(completion_tokens):,.0f}")
90 |     print(f"  • Min:     {min(completion_tokens):,.0f}")
91 |     print(f"  • Max:     {max(completion_tokens):,.0f}")
92 |     print()
93 |     
94 |     print(f"Total Tokens:")
95 |     print(f"  • Average: {statistics.mean(total_tokens):,.0f}")
96 |     print(f"  • Median:  {statistics.median(total_tokens):,.0f}")
97 |     print()
98 |     
99 |     if costs:
100 |         print(f"Cost per Request:")
101 |         print(f"  • Average: ${statistics.mean(costs):.6f}")
102 |         print(f"  • Median:  ${statistics.median(costs):.6f}")
103 |         print(f"  • Total:   ${sum(costs):.4f}")
104 |         print()
105 |     
106 |     # App-specific statistics (ChatLima focus)
107 |     print("🎯 APP-SPECIFIC STATISTICS")
108 |     print("-" * 30)
109 |     for app_name, requests in app_stats.items():
110 |         if len(requests) >= 5:  # Only show apps with significant usage
111 |             prompts = [r['prompt'] for r in requests]
112 |             completions = [r['completion'] for r in requests]
113 |             
114 |             print(f"{app_name} ({len(requests)} requests):")
115 |             print(f"  • Avg Prompt: {statistics.mean(prompts):,.0f} tokens")
116 |             print(f"  • Avg Completion: {statistics.mean(completions):,.0f} tokens")
117 |             print(f"  • Median Prompt: {statistics.median(prompts):,.0f} tokens")
118 |             print(f"  • Median Completion: {statistics.median(completions):,.0f} tokens")
119 |             print()
120 |     
121 |     # Model-specific statistics for high-usage models
122 |     print("🤖 TOP MODELS BY USAGE")
123 |     print("-" * 30)
124 |     model_usage = [(model, len(requests)) for model, requests in model_stats.items()]
125 |     model_usage.sort(key=lambda x: x[1], reverse=True)
126 |     
127 |     for model, count in model_usage[:10]:  # Top 10 models
128 |         requests = model_stats[model]
129 |         prompts = [r['prompt'] for r in requests]
130 |         completions = [r['completion'] for r in requests]
131 |         model_costs = [r['cost'] for r in requests if r['cost'] > 0]
132 |         
133 |         print(f"{model} ({count} requests):")
134 |         print(f"  • Avg Prompt: {statistics.mean(prompts):,.0f} tokens")
135 |         print(f"  • Avg Completion: {statistics.mean(completions):,.0f} tokens")
136 |         if model_costs:
137 |             print(f"  • Avg Cost: ${statistics.mean(model_costs):.6f}")
138 |         print()
139 |     
140 |     # ChatLima-specific recommendations
141 |     chatlima_data = [d for d in data if d['app_name'] == 'ChatLima']
142 |     if chatlima_data:
143 |         print("🎯 CHATLIMA-SPECIFIC RECOMMENDATIONS")
144 |         print("-" * 40)
145 |         
146 |         chatlima_prompts = [d['prompt_tokens'] for d in chatlima_data]
147 |         chatlima_completions = [d['completion_tokens'] for d in chatlima_data]
148 |         
149 |         avg_prompt = statistics.mean(chatlima_prompts)
150 |         avg_completion = statistics.mean(chatlima_completions)
151 |         median_prompt = statistics.median(chatlima_prompts)
152 |         median_completion = statistics.median(chatlima_completions)
153 |         
154 |         print(f"Based on {len(chatlima_data)} ChatLima requests:")
155 |         print()
156 |         print(f"📊 Current estimates in script: 5000 input, 3000 output")
157 |         print(f"📈 Actual averages: {avg_prompt:.0f} input, {avg_completion:.0f} output")
158 |         print(f"📉 Actual medians: {median_prompt:.0f} input, {median_completion:.0f} output")
159 |         print()
160 |         
161 |         # Recommendations
162 |         recommended_input = max(int(avg_prompt * 1.2), int(median_prompt * 1.5))  # 20% buffer on average or 50% on median
163 |         recommended_output = max(int(avg_completion * 1.2), int(median_completion * 1.5))
164 |         
165 |         print("💡 RECOMMENDED ESTIMATES:")
166 |         print(f"   ESTIMATED_INPUT_TOKENS = {recommended_input}")
167 |         print(f"   ESTIMATED_OUTPUT_TOKENS = {recommended_output}")
168 |         print()
169 |         print("🔍 These estimates include a buffer for realistic usage scenarios")
170 |         
171 |         # Cost impact analysis
172 |         chatlima_costs = [d['cost'] for d in chatlima_data if d['cost'] > 0]
173 |         if chatlima_costs:
174 |             avg_cost_per_request = statistics.mean(chatlima_costs)
175 |             daily_cost_anon = avg_cost_per_request * 10
176 |             daily_cost_google = avg_cost_per_request * 20
177 |             monthly_cost_anon = daily_cost_anon * 30
178 |             monthly_cost_google = daily_cost_google * 30
179 |             
180 |             print()
181 |             print("💰 ACTUAL COST ANALYSIS (ChatLima):")
182 |             print(f"   Average cost per request: ${avg_cost_per_request:.6f}")
183 |             print(f"   Anonymous users (10/day): ${daily_cost_anon:.6f}/day, ${monthly_cost_anon:.4f}/month")
184 |             print(f"   Google users (20/day): ${daily_cost_google:.6f}/day, ${monthly_cost_google:.4f}/month")
185 | 
186 | if __name__ == "__main__":
187 |     if len(sys.argv) != 2:
188 |         print("Usage: python scripts/analyze-openrouter-data.py /path/to/openrouter_activity.csv")
189 |         sys.exit(1)
190 |     
191 |     csv_file_path = sys.argv[1]
192 |     try:
193 |         analyze_openrouter_data(csv_file_path)
194 |     except FileNotFoundError:
195 |         print(f"❌ Error: Could not find file {csv_file_path}")
196 |         sys.exit(1)
197 |     except Exception as e:
198 |         print(f"❌ Error: {e}")
199 |         sys.exit(1) 
```

scripts/clear-cache.sh
```
1 | #!/bin/bash
2 | 
3 | echo "🧹 Clearing Next.js and TypeScript caches..."
4 | 
5 | # Remove Next.js build cache
6 | if [ -d ".next" ]; then
7 |   echo "Removing .next directory..."
8 |   rm -rf .next
9 | fi
10 | 
11 | # Remove node_modules cache
12 | if [ -d "node_modules/.cache" ]; then
13 |   echo "Removing node_modules/.cache..."
14 |   rm -rf node_modules/.cache
15 | fi
16 | 
17 | # Remove TypeScript build info
18 | if [ -f "tsconfig.tsbuildinfo" ]; then
19 |   echo "Removing tsconfig.tsbuildinfo..."
20 |   rm -f tsconfig.tsbuildinfo
21 | fi
22 | 
23 | # Remove .next/cache/.tsbuildinfo if it exists
24 | if [ -f ".next/cache/.tsbuildinfo" ]; then
25 |   echo "Removing .next/cache/.tsbuildinfo..."
26 |   rm -f .next/cache/.tsbuildinfo
27 | fi
28 | 
29 | echo "✅ Cache cleared successfully!"
30 | echo ""
31 | echo "You can now run 'pnpm dev' for a fresh start."
```

scripts/debug-polar-api.ts
```
1 | #!/usr/bin/env tsx
2 | 
3 | /**
4 |  * Polar API Debug Tool (TypeScript version)
5 |  * 
6 |  * This script helps debug Polar API connection issues by testing:
7 |  * - Environment variables
8 |  * - API connectivity
9 |  * - Customer lookup
10 |  * - Credits retrieval
11 |  * - Token validation
12 |  */
13 | 
14 | import 'dotenv/config';
15 | import { Polar } from '@polar-sh/sdk';
16 | 
17 | // Colors for console output
18 | const colors = {
19 |     red: '\x1b[31m',
20 |     green: '\x1b[32m',
21 |     yellow: '\x1b[33m',
22 |     blue: '\x1b[34m',
23 |     magenta: '\x1b[35m',
24 |     cyan: '\x1b[36m',
25 |     reset: '\x1b[0m',
26 |     bold: '\x1b[1m'
27 | };
28 | 
29 | function log(color: string, message: string) {
30 |     console.log(`${color}${message}${colors.reset}`);
31 | }
32 | 
33 | function section(title: string) {
34 |     console.log(`\n${colors.bold}${colors.cyan}=== ${title} ===${colors.reset}`);
35 | }
36 | 
37 | async function main() {
38 |     log(colors.bold, '🔍 Polar API Debug Tool (TypeScript)');
39 |     log(colors.blue, 'Testing your local Polar API configuration...\n');
40 | 
41 |     // 1. Load environment variables from .env.local
42 |     const dotenv = await import('dotenv');
43 |     dotenv.config({ path: '.env.local' });
44 | 
45 |     // 2. Check Environment Variables
46 |     section('Environment Variables');
47 | 
48 |     const polarAccessToken = process.env.POLAR_ACCESS_TOKEN;
49 |     const polarServerEnv = process.env.POLAR_SERVER_ENV;
50 |     const polarProductId = process.env.POLAR_PRODUCT_ID;
51 | 
52 |     log(colors.yellow, `POLAR_ACCESS_TOKEN: ${polarAccessToken ? '✓ Set' : '✗ Not set'}`);
53 |     if (polarAccessToken) {
54 |         log(colors.blue, `  Length: ${polarAccessToken.length} characters`);
55 |         log(colors.blue, `  Starts with: ${polarAccessToken.substring(0, 10)}...`);
56 |         log(colors.blue, `  Ends with: ...${polarAccessToken.substring(polarAccessToken.length - 10)}`);
57 |     }
58 | 
59 |     log(colors.yellow, `POLAR_SERVER_ENV: ${polarServerEnv || 'Not set (defaults to sandbox)'}`);
60 |     log(colors.yellow, `POLAR_PRODUCT_ID: ${polarProductId ? '✓ Set' : '✗ Not set'}`);
61 | 
62 |     const actualEnv = polarServerEnv === "production" ? "production" : "sandbox";
63 |     log(colors.magenta, `Computed environment: ${actualEnv}`);
64 | 
65 |     if (!polarAccessToken) {
66 |         log(colors.red, '❌ POLAR_ACCESS_TOKEN is required. Please set it in .env.local');
67 |         return;
68 |     }
69 | 
70 |     // 3. Initialize Polar Client
71 |     section('Polar Client Initialization');
72 | 
73 |     let polarClient: Polar;
74 |     try {
75 |         polarClient = new Polar({
76 |             accessToken: polarAccessToken,
77 |             server: actualEnv as "production" | "sandbox",
78 |         });
79 |         log(colors.green, `✓ Polar client initialized for ${actualEnv} environment`);
80 |     } catch (error: any) {
81 |         log(colors.red, `❌ Failed to initialize Polar client: ${error.message}`);
82 |         return;
83 |     }
84 | 
85 |     // 4. Test Basic API Connectivity
86 |     section('API Connectivity Test');
87 | 
88 |     try {
89 |         // Try to list products (this should work with any valid token)
90 |         const products = await polarClient.products.list({ limit: 1 });
91 |         log(colors.green, '✓ Basic API connectivity successful');
92 | 
93 |         // Check if we can iterate (test pagination)
94 |         let productCount = 0;
95 |         for await (const product of products) {
96 |             productCount++;
97 |             if (productCount >= 1) break; // Just test first product
98 |         }
99 |         log(colors.green, `✓ API pagination working (found ${productCount} products)`);
100 | 
101 |     } catch (error: any) {
102 |         log(colors.red, `❌ Basic API connectivity failed:`);
103 |         log(colors.red, `   Status: ${error.statusCode || 'Unknown'}`);
104 |         log(colors.red, `   Message: ${error.message}`);
105 |         log(colors.red, `   Body: ${error.body || 'No body'}`);
106 | 
107 |         if (error.statusCode === 401) {
108 |             log(colors.yellow, '⚠️  401 Unauthorized - Your token may be:');
109 |             log(colors.yellow, '   • Expired');
110 |             log(colors.yellow, '   • Invalid');
111 |             log(colors.yellow, '   • For wrong environment (sandbox token used in production)');
112 |         }
113 |         return;
114 |     }
115 | 
116 |     // 5. Test Customer Operations
117 |     section('Customer Operations Test');
118 | 
119 |     // Test user ID (you can replace this with a real user ID for more specific testing)
120 |     const testUserId = 'test-user-id-' + Date.now();
121 | 
122 |     try {
123 |         // Test customer creation
124 |         log(colors.blue, `Testing customer creation with external ID: ${testUserId}`);
125 |         const testCustomer = await polarClient.customers.create({
126 |             email: `test-${Date.now()}@example.com`,
127 |             name: 'Test User',
128 |             externalId: testUserId
129 |         });
130 |         log(colors.green, `✓ Customer creation successful: ${testCustomer.id}`);
131 | 
132 |         // Test customer lookup by external ID
133 |         log(colors.blue, 'Testing customer lookup by external ID...');
134 |         const foundCustomer = await polarClient.customers.getExternal({
135 |             externalId: testUserId
136 |         });
137 |         log(colors.green, `✓ Customer lookup successful: ${foundCustomer.id}`);
138 | 
139 |         // Test customer state retrieval
140 |         log(colors.blue, 'Testing customer state retrieval...');
141 |         const customerState = await polarClient.customers.getStateExternal({
142 |             externalId: testUserId
143 |         });
144 |         log(colors.green, `✓ Customer state retrieval successful`);
145 |         log(colors.blue, `   Active meters: ${(customerState as any).activeMeters?.length || 0}`);
146 |         log(colors.blue, `   Legacy meters: ${(customerState as any).meters?.length || 0}`);
147 | 
148 |         // Clean up test customer
149 |         try {
150 |             await polarClient.customers.delete({ id: testCustomer.id });
151 |             log(colors.green, '✓ Test customer cleaned up');
152 |         } catch (cleanupError: any) {
153 |             log(colors.yellow, `⚠️  Could not clean up test customer: ${cleanupError.message}`);
154 |         }
155 | 
156 |     } catch (error: any) {
157 |         log(colors.red, `❌ Customer operations failed:`);
158 |         log(colors.red, `   Status: ${error.statusCode || 'Unknown'}`);
159 |         log(colors.red, `   Message: ${error.message}`);
160 |         log(colors.red, `   Body: ${error.body || 'No body'}`);
161 | 
162 |         if (error.statusCode === 401) {
163 |             log(colors.yellow, '⚠️  This confirms the 401 error you\'re seeing in your app');
164 |         }
165 |     }
166 | 
167 |     // 6. Test with Real User (if provided)
168 |     const realUserId = process.argv[2];
169 |     if (realUserId) {
170 |         section(`Real User Test (ID: ${realUserId})`);
171 | 
172 |         try {
173 |             log(colors.blue, `Looking up customer with external ID: ${realUserId}`);
174 |             const customer = await polarClient.customers.getExternal({
175 |                 externalId: realUserId
176 |             });
177 |             log(colors.green, `✓ Found customer: ${customer.id} (${customer.email})`);
178 | 
179 |             log(colors.blue, 'Getting customer state...');
180 |             const customerState = await polarClient.customers.getStateExternal({
181 |                 externalId: realUserId
182 |             });
183 | 
184 |             log(colors.green, '✓ Customer state retrieved successfully');
185 |             log(colors.blue, `   Active meters: ${(customerState as any).activeMeters?.length || 0}`);
186 | 
187 |             // Look for credits
188 |             const activeMeters = (customerState as any).activeMeters || [];
189 |             let creditsFound = false;
190 | 
191 |             for (const meter of activeMeters) {
192 |                 if (meter.meterId) {
193 |                     try {
194 |                         const meterDetails = await polarClient.meters.get({ id: meter.meterId });
195 |                         if (meterDetails?.name === 'Message Credits Used') {
196 |                             log(colors.green, `✓ Found credits meter: ${meter.balance || 0} credits`);
197 |                             creditsFound = true;
198 |                         }
199 |                     } catch (meterError: any) {
200 |                         log(colors.yellow, `⚠️  Could not get meter details: ${meterError.message}`);
201 |                     }
202 |                 }
203 |             }
204 | 
205 |             if (!creditsFound) {
206 |                 log(colors.yellow, '⚠️  No "Message Credits Used" meter found for this user');
207 |             }
208 | 
209 |         } catch (error: any) {
210 |             log(colors.red, `❌ Real user test failed:`);
211 |             log(colors.red, `   Status: ${error.statusCode || 'Unknown'}`);
212 |             log(colors.red, `   Message: ${error.message}`);
213 |             log(colors.red, `   Body: ${error.body || 'No body'}`);
214 |         }
215 |     }
216 | 
217 |     // 7. Replicate Your App's Logic
218 |     section('App Logic Replication');
219 | 
220 |     log(colors.blue, 'Testing the exact same logic as your getRemainingCreditsByExternalId function...');
221 | 
222 |     if (realUserId) {
223 |         try {
224 |             // This replicates the exact logic in lib/polar.ts
225 |             console.log(`[DEBUG] Attempting to get credits for external ID: ${realUserId}`);
226 | 
227 |             const customerState = await polarClient.customers.getStateExternal({
228 |                 externalId: realUserId
229 |             });
230 | 
231 |             console.log(`[DEBUG] Customer state response:`, JSON.stringify(customerState, null, 2));
232 | 
233 |             if (!customerState) {
234 |                 console.log(`[DEBUG] No customer state found for external ID: ${realUserId}`);
235 |                 log(colors.yellow, '⚠️  No customer state found');
236 |             } else {
237 |                 const activeMeters = (customerState as any).activeMeters || [];
238 |                 console.log(`[DEBUG] Found ${activeMeters.length} active meters for user ${realUserId}`);
239 | 
240 |                 // Search for the correct "Message Credits Used" meter among active meters
241 |                 for (const meter of activeMeters) {
242 |                     console.log(`[DEBUG] Active meter:`, JSON.stringify(meter, null, 2));
243 | 
244 |                     // Try to get the full meter details to check the name
245 |                     if (meter.meterId) {
246 |                         try {
247 |                             const meterDetails = await polarClient.meters.get({
248 |                                 id: meter.meterId
249 |                             });
250 |                             console.log(`[DEBUG] Meter details for ${meter.meterId}:`, JSON.stringify(meterDetails, null, 2));
251 | 
252 |                             if (meterDetails?.name === 'Message Credits Used') {
253 |                                 const balance = meter.balance || 0;
254 |                                 console.log(`[DEBUG] Found 'Message Credits Used' active meter with balance: ${balance}`);
255 |                                 log(colors.green, `✓ Credits found using app logic: ${balance}`);
256 |                                 break;
257 |                             }
258 |                         } catch (meterError: any) {
259 |                             console.warn(`[DEBUG] Failed to get meter details for ${meter.meterId}:`, meterError);
260 |                         }
261 |                     }
262 |                 }
263 |             }
264 |         } catch (error: any) {
265 |             log(colors.red, `❌ App logic replication failed:`);
266 |             log(colors.red, `   This is the EXACT same error as in your app!`);
267 |             log(colors.red, `   Status: ${error.statusCode || 'Unknown'}`);
268 |             log(colors.red, `   Message: ${error.message}`);
269 |             log(colors.red, `   Body: ${error.body || 'No body'}`);
270 |         }
271 |     }
272 | 
273 |     // 8. Environment Comparison
274 |     section('Environment Analysis');
275 | 
276 |     log(colors.blue, 'Current configuration:');
277 |     log(colors.blue, `  • Environment: ${actualEnv}`);
278 |     log(colors.blue, `  • Token length: ${polarAccessToken.length}`);
279 |     log(colors.blue, `  • Node.js version: ${process.version}`);
280 |     log(colors.blue, `  • Platform: ${process.platform}`);
281 |     log(colors.blue, `  • Working directory: ${process.cwd()}`);
282 | 
283 |     log(colors.yellow, '\nNext steps:');
284 |     log(colors.yellow, '1. Compare this output with your production logs');
285 |     log(colors.yellow, '2. If basic API connectivity fails, check your token in Polar dashboard');
286 |     log(colors.yellow, '3. If customer operations fail, verify token permissions');
287 |     log(colors.yellow, '4. Run with a real user ID: npx tsx scripts/debug-polar-api.ts YOUR_USER_ID');
288 | 
289 |     log(colors.green, '\n✅ Debug script completed');
290 | }
291 | 
292 | main().catch(error => {
293 |     log(colors.red, `\n💥 Script failed with error: ${error.message}`);
294 |     console.error(error);
295 |     process.exit(1);
296 | }); 
```

scripts/dynamic-api-pricing-analysis.ts
```
1 | #!/usr/bin/env tsx
2 | 
3 | /**
4 |  * Dynamic API Pricing Analysis Tool
5 |  * 
6 |  * This developer-only script fetches all available models from OpenRouter and Requesty
7 |  * using the existing application infrastructure and calculates cost estimates for different user types.
8 |  * 
9 |  * Usage: npx tsx scripts/dynamic-api-pricing-analysis.ts
10 |  */
11 | 
12 | import dotenv from 'dotenv';
13 | import { fetchAllModels, getEnvironmentApiKeys } from '@/lib/models/fetch-models';
14 | import { ModelInfo } from '@/lib/types/models';
15 | 
16 | // Load environment variables
17 | dotenv.config({ path: '.env.local' });
18 | dotenv.config({ path: '.env' });
19 | 
20 | interface UserTier {
21 |     name: string;
22 |     dailyMessages: number;
23 |     monthlyMessages: number;
24 |     description: string;
25 |     canUsePremium: boolean;
26 | }
27 | 
28 | interface PricingAnalysis {
29 |     model: ModelInfo;
30 |     costPerMessage: number;
31 |     costAnonDaily: number;
32 |     costAnonMonthly: number;
33 |     costGoogleDaily: number;
34 |     costGoogleMonthly: number;
35 |     isPremium: boolean;
36 |     hasValidPricing: boolean;
37 | }
38 | 
39 | // User tiers based on the actual application logic
40 | const USER_TIERS: UserTier[] = [
41 |     {
42 |         name: 'Anonymous',
43 |         dailyMessages: 10,
44 |         monthlyMessages: 10 * 30,
45 |         description: 'Unregistered users',
46 |         canUsePremium: false
47 |     },
48 |     {
49 |         name: 'Google Auth',
50 |         dailyMessages: 20,
51 |         monthlyMessages: 20 * 30,
52 |         description: 'Google-authenticated users without credits',
53 |         canUsePremium: false
54 |     },
55 |     {
56 |         name: 'Credit Users',
57 |         dailyMessages: Infinity,
58 |         monthlyMessages: Infinity,
59 |         description: 'Users with purchased Polar credits',
60 |         canUsePremium: true
61 |     }
62 | ];
63 | 
64 | // Estimated tokens per message based on actual usage patterns
65 | const ESTIMATED_INPUT_TOKENS = 2701;  // User prompt + context (avg: 2251 + 20% buffer)
66 | const ESTIMATED_OUTPUT_TOKENS = 441;  // AI response (avg: 368 + 20% buffer)
67 | 
68 | function calculateModelPricing(models: ModelInfo[]): PricingAnalysis[] {
69 |     const analyses: PricingAnalysis[] = [];
70 | 
71 |     for (const model of models) {
72 |         // Skip models without pricing information
73 |         if (!model.pricing?.input || !model.pricing?.output) {
74 |             analyses.push({
75 |                 model,
76 |                 costPerMessage: 0,
77 |                 costAnonDaily: 0,
78 |                 costAnonMonthly: 0,
79 |                 costGoogleDaily: 0,
80 |                 costGoogleMonthly: 0,
81 |                 isPremium: model.premium,
82 |                 hasValidPricing: false
83 |             });
84 |             continue;
85 |         }
86 | 
87 |         // Skip models with invalid pricing (negative, zero, or unreasonably high)
88 |         if (model.pricing.input <= 0 || model.pricing.output <= 0 ||
89 |             model.pricing.input > 1000 || model.pricing.output > 1000) {
90 |             console.warn(`⚠️  Skipping model with invalid pricing: ${model.name} (input: ${model.pricing.input}, output: ${model.pricing.output})`);
91 |             analyses.push({
92 |                 model,
93 |                 costPerMessage: 0,
94 |                 costAnonDaily: 0,
95 |                 costAnonMonthly: 0,
96 |                 costGoogleDaily: 0,
97 |                 costGoogleMonthly: 0,
98 |                 isPremium: model.premium,
99 |                 hasValidPricing: false
100 |             });
101 |             continue;
102 |         }
103 | 
104 |         // Calculate cost per message (pricing is already per token)
105 |         const inputCost = ESTIMATED_INPUT_TOKENS * model.pricing.input;
106 |         const outputCost = ESTIMATED_OUTPUT_TOKENS * model.pricing.output;
107 |         const costPerMessage = inputCost + outputCost;
108 | 
109 |         analyses.push({
110 |             model,
111 |             costPerMessage,
112 |             costAnonDaily: costPerMessage * USER_TIERS[0].dailyMessages,
113 |             costAnonMonthly: costPerMessage * USER_TIERS[0].monthlyMessages,
114 |             costGoogleDaily: costPerMessage * USER_TIERS[1].dailyMessages,
115 |             costGoogleMonthly: costPerMessage * USER_TIERS[1].monthlyMessages,
116 |             isPremium: model.premium,
117 |             hasValidPricing: true
118 |         });
119 |     }
120 | 
121 |     // Sort by cost per message (descending - most expensive first)
122 |     return analyses.sort((a, b) => b.costPerMessage - a.costPerMessage);
123 | }
124 | 
125 | function formatCurrency(amount: number): string {
126 |     if (amount === 0) return '$0.00';
127 |     if (amount === Infinity) return '∞';
128 |     if (amount < 0.000001) return `${amount.toExponential(2)}`;
129 |     if (amount < 0.01) return `${amount.toFixed(6)}`;
130 |     if (amount < 1) return `${amount.toFixed(4)}`;
131 |     return `${amount.toFixed(2)}`;
132 | }
133 | 
134 | function displayPricingTable(analyses: PricingAnalysis[]): void {
135 |     console.log('\n📊 Dynamic API Model Pricing Analysis');
136 |     console.log('=====================================\n');
137 | 
138 |     if (analyses.length === 0) {
139 |         console.log('❌ No models found to analyze.');
140 |         return;
141 |     }
142 | 
143 |     // Separate models by pricing validity and premium status
144 |     const validPricingModels = analyses.filter(a => a.hasValidPricing);
145 |     const noPricingModels = analyses.filter(a => !a.hasValidPricing);
146 |     const premiumModels = validPricingModels.filter(a => a.isPremium);
147 |     const freeModels = validPricingModels.filter(a => !a.isPremium);
148 | 
149 |     console.log(`📈 Found ${analyses.length} total models:`);
150 |     console.log(`   • ${validPricingModels.length} with pricing data (${premiumModels.length} premium, ${freeModels.length} standard)`);
151 |     console.log(`   • ${noPricingModels.length} without pricing data`);
152 |     console.log(`\n💡 Token estimates: ${ESTIMATED_INPUT_TOKENS} input + ${ESTIMATED_OUTPUT_TOKENS} output tokens per message\n`);
153 | 
154 |     // Table header
155 |     console.log('Provider'.padEnd(10) +
156 |         'Model'.padEnd(40) +
157 |         'Type'.padEnd(8) +
158 |         'Input/Token'.padEnd(12) +
159 |         'Output/Token'.padEnd(13) +
160 |         'Per Msg'.padEnd(10) +
161 |         'Anon Daily'.padEnd(12) +
162 |         'Google Daily'.padEnd(14) +
163 |         'Anon Monthly'.padEnd(14) +
164 |         'Google Monthly');
165 |     console.log('-'.repeat(10 + 40 + 8 + 12 + 13 + 10 + 12 + 14 + 14 + 14));
166 | 
167 |     // Display models with valid pricing first
168 |     for (const analysis of validPricingModels) {
169 |         const model = analysis.model;
170 |         const modelName = model.name.substring(0, 39);
171 |         const premium = analysis.isPremium ? 'Premium' : 'Standard';
172 | 
173 |         console.log(
174 |             model.provider.padEnd(10) +
175 |             modelName.padEnd(40) +
176 |             premium.padEnd(8) +
177 |             formatCurrency(model.pricing!.input!).padEnd(12) +
178 |             formatCurrency(model.pricing!.output!).padEnd(13) +
179 |             formatCurrency(analysis.costPerMessage).padEnd(10) +
180 |             formatCurrency(analysis.costAnonDaily).padEnd(12) +
181 |             formatCurrency(analysis.costGoogleDaily).padEnd(14) +
182 |             formatCurrency(analysis.costAnonMonthly).padEnd(14) +
183 |             formatCurrency(analysis.costGoogleMonthly)
184 |         );
185 |     }
186 | 
187 |     // Display models without pricing
188 |     if (noPricingModels.length > 0) {
189 |         console.log('\n⚠️  Models without pricing data:');
190 |         for (const analysis of noPricingModels) {
191 |             const model = analysis.model;
192 |             console.log(`   • ${model.provider} - ${model.name} (${model.premium ? 'Premium' : 'Standard'})`);
193 |         }
194 |     }
195 | }
196 | 
197 | function displayUserTierAnalysis(analyses: PricingAnalysis[]): void {
198 |     const validModels = analyses.filter(a => a.hasValidPricing);
199 |     if (validModels.length === 0) return;
200 | 
201 |     console.log('\n👥 User Tier Analysis');
202 |     console.log('=====================\n');
203 | 
204 |     for (const tier of USER_TIERS) {
205 |         console.log(`🔹 ${tier.name} Users:`);
206 |         console.log(`   ${tier.description}`);
207 |         console.log(`   Daily limit: ${tier.dailyMessages === Infinity ? 'No limit (credit-based)' : `${tier.dailyMessages} messages`}`);
208 |         console.log(`   Premium models: ${tier.canUsePremium ? '✅ Available' : '❌ Not available'}`);
209 | 
210 |         if (tier.dailyMessages !== Infinity) {
211 |             const availableModels = validModels.filter(a => tier.canUsePremium || !a.isPremium);
212 |             if (availableModels.length > 0) {
213 |                 const cheapest = availableModels[availableModels.length - 1];
214 |                 const mostExpensive = availableModels[0];
215 | 
216 |                 const dailyCostRange = tier.name === 'Anonymous' ?
217 |                     `${formatCurrency(cheapest.costAnonDaily)} - ${formatCurrency(mostExpensive.costAnonDaily)}` :
218 |                     `${formatCurrency(cheapest.costGoogleDaily)} - ${formatCurrency(mostExpensive.costGoogleDaily)}`;
219 | 
220 |                 const monthlyCostRange = tier.name === 'Anonymous' ?
221 |                     `${formatCurrency(cheapest.costAnonMonthly)} - ${formatCurrency(mostExpensive.costAnonMonthly)}` :
222 |                     `${formatCurrency(cheapest.costGoogleMonthly)} - ${formatCurrency(mostExpensive.costGoogleMonthly)}`;
223 | 
224 |                 console.log(`   Daily cost range: ${dailyCostRange}`);
225 |                 console.log(`   Monthly cost range: ${monthlyCostRange}`);
226 |                 console.log(`   Available models: ${availableModels.length}/${validModels.length}`);
227 |             }
228 |         } else {
229 |             console.log(`   Cost: Pay-per-token based on actual usage`);
230 |             console.log(`   Available models: ${validModels.length}/${validModels.length} (including premium)`);
231 |         }
232 |         console.log('');
233 |     }
234 | }
235 | 
236 | function displayCostSummary(analyses: PricingAnalysis[]): void {
237 |     const validModels = analyses.filter(a => a.hasValidPricing);
238 |     if (validModels.length === 0) return;
239 | 
240 |     const premiumModels = validModels.filter(a => a.isPremium);
241 |     const standardModels = validModels.filter(a => !a.isPremium);
242 | 
243 |     console.log('\n💰 Cost Summary');
244 |     console.log('===============\n');
245 | 
246 |     if (validModels.length > 0) {
247 |         const mostExpensive = validModels[0];
248 |         const cheapest = validModels[validModels.length - 1];
249 | 
250 |         console.log('🔥 MOST EXPENSIVE MODEL:');
251 |         console.log(`   ${mostExpensive.model.provider} - ${mostExpensive.model.name} ${mostExpensive.isPremium ? '(Premium)' : ''}`);
252 |         console.log(`   Cost per message: ${formatCurrency(mostExpensive.costPerMessage)}`);
253 |         console.log(`   Anonymous users: ${formatCurrency(mostExpensive.costAnonDaily)}/day, ${formatCurrency(mostExpensive.costAnonMonthly)}/month`);
254 |         console.log(`   Google users: ${formatCurrency(mostExpensive.costGoogleDaily)}/day, ${formatCurrency(mostExpensive.costGoogleMonthly)}/month`);
255 | 
256 |         console.log('\n💚 CHEAPEST MODEL:');
257 |         console.log(`   ${cheapest.model.provider} - ${cheapest.model.name} ${cheapest.isPremium ? '(Premium)' : ''}`);
258 |         console.log(`   Cost per message: ${formatCurrency(cheapest.costPerMessage)}`);
259 |         console.log(`   Anonymous users: ${formatCurrency(cheapest.costAnonDaily)}/day, ${formatCurrency(cheapest.costAnonMonthly)}/month`);
260 |         console.log(`   Google users: ${formatCurrency(cheapest.costGoogleDaily)}/day, ${formatCurrency(cheapest.costGoogleMonthly)}/month`);
261 | 
262 |         const ratio = mostExpensive.costPerMessage / cheapest.costPerMessage;
263 |         console.log(`\n📈 Price Difference: Most expensive is ${ratio.toFixed(1)}x more costly than cheapest`);
264 |     }
265 | 
266 |     // Provider breakdown
267 |     const openRouterModels = validModels.filter(a => a.model.provider === 'OpenRouter');
268 |     const requestyModels = validModels.filter(a => a.model.provider === 'Requesty');
269 | 
270 |     console.log('\n📊 Provider Breakdown:');
271 |     console.log(`   OpenRouter: ${openRouterModels.length} models (${openRouterModels.filter(a => a.isPremium).length} premium)`);
272 |     console.log(`   Requesty: ${requestyModels.length} models (${requestyModels.filter(a => a.isPremium).length} premium)`);
273 | 
274 |     if (openRouterModels.length > 0) {
275 |         const avgCost = openRouterModels.reduce((sum, m) => sum + m.costPerMessage, 0) / openRouterModels.length;
276 |         console.log(`   Average OpenRouter cost per message: ${formatCurrency(avgCost)}`);
277 |     }
278 | 
279 |     if (requestyModels.length > 0) {
280 |         const avgCost = requestyModels.reduce((sum, m) => sum + m.costPerMessage, 0) / requestyModels.length;
281 |         console.log(`   Average Requesty cost per message: ${formatCurrency(avgCost)}`);
282 |     }
283 | 
284 |     if (premiumModels.length > 0) {
285 |         console.log(`\n⭐ Premium Model Analysis:`);
286 |         console.log(`   Premium models: ${premiumModels.length}/${validModels.length} (${((premiumModels.length / validModels.length) * 100).toFixed(1)}%)`);
287 |         const avgPremiumCost = premiumModels.reduce((sum, m) => sum + m.costPerMessage, 0) / premiumModels.length;
288 |         const avgStandardCost = standardModels.length > 0 ?
289 |             standardModels.reduce((sum, m) => sum + m.costPerMessage, 0) / standardModels.length : 0;
290 | 
291 |         console.log(`   Average premium cost: ${formatCurrency(avgPremiumCost)}/message`);
292 |         if (avgStandardCost > 0) {
293 |             console.log(`   Average standard cost: ${formatCurrency(avgStandardCost)}/message`);
294 |             console.log(`   Premium markup: ${(avgPremiumCost / avgStandardCost).toFixed(1)}x`);
295 |         }
296 |     }
297 | 
298 |     // Show invalid pricing models summary
299 |     const invalidModels = analyses.filter(a => !a.hasValidPricing);
300 |     if (invalidModels.length > 0) {
301 |         console.log(`\n⚠️  Data Quality Issues:`);
302 |         console.log(`   ${invalidModels.length} models with invalid/missing pricing data`);
303 |         console.log(`   These models are excluded from cost analysis`);
304 |     }
305 | }
306 | 
307 | async function main(): Promise<void> {
308 |     try {
309 |         console.log('🚀 Dynamic API Pricing Analysis Tool');
310 |         console.log('====================================\n');
311 | 
312 |         // Get environment API keys
313 |         const envKeys = getEnvironmentApiKeys();
314 |         const hasOpenRouterKey = !!envKeys.OPENROUTER_API_KEY;
315 |         const hasRequestyKey = !!envKeys.REQUESTY_API_KEY;
316 | 
317 |         if (!hasOpenRouterKey && !hasRequestyKey) {
318 |             console.log('⚠️  No API keys found. To analyze pricing, set one or both of:');
319 |             console.log('   • OPENROUTER_API_KEY for OpenRouter models');
320 |             console.log('   • REQUESTY_API_KEY for Requesty models');
321 |             console.log('\n   Example:');
322 |             console.log('   export OPENROUTER_API_KEY="sk-or-your-key"');
323 |             console.log('   export REQUESTY_API_KEY="rq-your-key"');
324 |             return;
325 |         }
326 | 
327 |         console.log('🔍 Fetching models from configured providers...');
328 |         console.log(`   • OpenRouter: ${hasOpenRouterKey ? '✅' : '❌'}`);
329 |         console.log(`   • Requesty: ${hasRequestyKey ? '✅' : '❌'}`);
330 | 
331 |         // Fetch all models using the existing infrastructure
332 |         const response = await fetchAllModels({ environment: envKeys }, true);
333 | 
334 |         console.log(`\n✅ Successfully fetched ${response.models.length} models`);
335 |         console.log(`   • Cache hit: ${response.metadata.cacheHit ? 'Yes' : 'No'}`);
336 |         console.log(`   • Last updated: ${response.metadata.lastUpdated.toISOString()}`);
337 | 
338 |         // Display provider status
339 |         console.log('\n🏥 Provider Health:');
340 |         for (const [providerKey, provider] of Object.entries(response.metadata.providers)) {
341 |             const statusIcon = provider.status === 'healthy' ? '✅' :
342 |                 provider.status === 'degraded' ? '⚠️' : '❌';
343 |             console.log(`   • ${provider.name}: ${statusIcon} ${provider.status} (${provider.modelCount} models)`);
344 |             if (provider.error) {
345 |                 console.log(`     Error: ${provider.error}`);
346 |             }
347 |         }
348 | 
349 |         // Calculate pricing analysis
350 |         const analyses = calculateModelPricing(response.models);
351 | 
352 |         // Display results
353 |         displayPricingTable(analyses);
354 |         displayUserTierAnalysis(analyses);
355 |         displayCostSummary(analyses);
356 | 
357 |         console.log('\n✨ Analysis complete!');
358 |         console.log('\n💡 Notes:');
359 |         console.log('• Pricing shown is per token (input/output)');
360 |         console.log('• Premium models require purchased credits');
361 |         console.log('• Anonymous users limited to standard models only');
362 |         console.log('• Monthly estimates assume full daily usage for 30 days');
363 | 
364 |     } catch (error) {
365 |         console.error('❌ Error:', error instanceof Error ? error.message : String(error));
366 |         process.exit(1);
367 |     }
368 | }
369 | 
370 | // Run the script
371 | if (require.main === module) {
372 |     main();
373 | } 
```

scripts/test-model-endpoints.ts
```
1 | #!/usr/bin/env tsx
2 | 
3 | import fs from 'fs/promises';
4 | import path from 'path';
5 | import { config } from 'dotenv';
6 | import { PROVIDERS, parseOpenRouterModels, parseRequestyModels } from '@/lib/models/provider-configs';
7 | import { ModelInfo } from '@/lib/types/models';
8 | 
9 | // Load environment variables from .env.local
10 | config({ path: path.join(process.cwd(), '.env.local') });
11 | 
12 | interface BlockedModel {
13 |     provider: string;
14 |     reason: string;
15 |     lastTested: string;
16 |     testError: string;
17 |     retryCount: number;
18 |     manuallyBlocked: boolean;
19 | }
20 | 
21 | interface BlockedModelsList {
22 |     $schema: string;
23 |     description: string;
24 |     lastUpdated: string;
25 |     models: Record<string, BlockedModel>;
26 | }
27 | 
28 | interface TestConfig {
29 |     maxRetries: number;
30 |     requestTimeoutMs: number;
31 |     rateLimitDelayMs: number;
32 |     testMessage: string;
33 |     maxTokens: number;
34 | }
35 | 
36 | const DEFAULT_CONFIG: TestConfig = {
37 |     maxRetries: 2,
38 |     requestTimeoutMs: 30000, // 30 seconds
39 |     rateLimitDelayMs: 1000, // 1 second between requests
40 |     testMessage: "Hello",
41 |     maxTokens: 1
42 | };
43 | 
44 | class ModelEndpointTester {
45 |     private blockedModelsPath: string;
46 |     private config: TestConfig;
47 |     private stats = {
48 |         total: 0,
49 |         tested: 0,
50 |         working: 0,
51 |         blocked: 0,
52 |         skipped: 0,
53 |         errors: 0
54 |     };
55 | 
56 |     constructor(config: Partial<TestConfig> = {}) {
57 |         this.config = { ...DEFAULT_CONFIG, ...config };
58 |         this.blockedModelsPath = path.join(process.cwd(), 'lib/models/blocked-models.json');
59 |     }
60 | 
61 |     async loadBlockedModels(): Promise<BlockedModelsList> {
62 |         try {
63 |             const data = await fs.readFile(this.blockedModelsPath, 'utf-8');
64 |             return JSON.parse(data);
65 |         } catch (error) {
66 |             console.warn('Could not load blocked models file, starting fresh');
67 |             return {
68 |                 $schema: "https://json-schema.org/draft/2019-09/schema",
69 |                 description: "List of AI models that have been tested and found to have non-working endpoints",
70 |                 lastUpdated: new Date().toISOString(),
71 |                 models: {}
72 |             };
73 |         }
74 |     }
75 | 
76 |     async saveBlockedModels(blockedModels: BlockedModelsList): Promise<void> {
77 |         blockedModels.lastUpdated = new Date().toISOString();
78 |         await fs.writeFile(
79 |             this.blockedModelsPath,
80 |             JSON.stringify(blockedModels, null, 2),
81 |             'utf-8'
82 |         );
83 |     }
84 | 
85 |     async fetchModels(provider: 'openrouter' | 'requesty'): Promise<ModelInfo[]> {
86 |         const providerConfig = PROVIDERS[provider];
87 |         if (!providerConfig) {
88 |             throw new Error(`Unknown provider: ${provider}`);
89 |         }
90 | 
91 |         const apiKey = process.env[providerConfig.envKey];
92 |         if (!apiKey) {
93 |             throw new Error(`Missing API key for ${provider}: ${providerConfig.envKey}`);
94 |         }
95 | 
96 |         console.log(`Fetching models from ${provider}...`);
97 | 
98 |         const response = await fetch(providerConfig.endpoint, {
99 |             headers: {
100 |                 'Authorization': `Bearer ${apiKey}`,
101 |                 'User-Agent': 'ChatLima/1.0 Model Endpoint Tester'
102 |             }
103 |         });
104 | 
105 |         if (!response.ok) {
106 |             throw new Error(`Failed to fetch models from ${provider}: ${response.status} ${response.statusText}`);
107 |         }
108 | 
109 |         const data = await response.json();
110 |         return providerConfig.parse(data);
111 |     }
112 | 
113 |     async testModelEndpoint(model: ModelInfo, provider: 'openrouter' | 'requesty'): Promise<{
114 |         success: boolean;
115 |         error?: string;
116 |         responseTime?: number;
117 |     }> {
118 |         const startTime = Date.now();
119 | 
120 |         try {
121 |             const apiKey = process.env[PROVIDERS[provider].envKey];
122 |             if (!apiKey) {
123 |                 throw new Error(`Missing API key for ${provider}`);
124 |             }
125 | 
126 |             // Get the actual model ID for the API call
127 |             let modelId: string;
128 |             if (provider === 'openrouter') {
129 |                 // Remove the 'openrouter/' prefix for OpenRouter API calls
130 |                 modelId = model.id.replace('openrouter/', '');
131 |             } else if (provider === 'requesty') {
132 |                 // Remove the 'requesty/' prefix for Requesty API calls  
133 |                 modelId = model.id.replace('requesty/', '');
134 |             } else {
135 |                 modelId = model.apiVersion || model.id;
136 |             }
137 | 
138 |             // Construct the appropriate endpoint
139 |             const endpoint = provider === 'openrouter'
140 |                 ? 'https://openrouter.ai/api/v1/chat/completions'
141 |                 : 'https://router.requesty.ai/v1/chat/completions';
142 | 
143 |             const requestBody = {
144 |                 model: modelId,
145 |                 messages: [
146 |                     {
147 |                         role: 'user',
148 |                         content: this.config.testMessage
149 |                     }
150 |                 ],
151 |                 max_tokens: this.config.maxTokens,
152 |                 temperature: 0.1
153 |             };
154 | 
155 |             // Add provider-specific headers
156 |             const headers: Record<string, string> = {
157 |                 'Content-Type': 'application/json',
158 |                 'Authorization': `Bearer ${apiKey}`,
159 |                 'User-Agent': 'ChatLima/1.0 Model Endpoint Tester'
160 |             };
161 | 
162 |             // Add provider-specific headers for both OpenRouter and Requesty
163 |             headers['HTTP-Referer'] = 'https://chatlima.app';
164 |             headers['X-Title'] = 'ChatLima Model Endpoint Test';
165 | 
166 |             const controller = new AbortController();
167 |             const timeoutId = setTimeout(() => controller.abort(), this.config.requestTimeoutMs);
168 | 
169 |             const response = await fetch(endpoint, {
170 |                 method: 'POST',
171 |                 headers,
172 |                 body: JSON.stringify(requestBody),
173 |                 signal: controller.signal
174 |             });
175 | 
176 |             clearTimeout(timeoutId);
177 | 
178 |             const responseTime = Date.now() - startTime;
179 | 
180 |             if (!response.ok) {
181 |                 const errorText = await response.text().catch(() => 'Unable to read error response');
182 |                 return {
183 |                     success: false,
184 |                     error: `HTTP ${response.status}: ${errorText}`,
185 |                     responseTime
186 |                 };
187 |             }
188 | 
189 |             // Try to parse the response
190 |             const responseData = await response.json();
191 | 
192 |             // Basic validation that this looks like a proper chat completion response
193 |             if (!responseData.choices || !Array.isArray(responseData.choices) || responseData.choices.length === 0) {
194 |                 return {
195 |                     success: false,
196 |                     error: 'Invalid response format - missing choices array',
197 |                     responseTime
198 |                 };
199 |             }
200 | 
201 |             return {
202 |                 success: true,
203 |                 responseTime
204 |             };
205 | 
206 |         } catch (error) {
207 |             const responseTime = Date.now() - startTime;
208 | 
209 |             if (error instanceof Error) {
210 |                 if (error.name === 'AbortError') {
211 |                     return {
212 |                         success: false,
213 |                         error: 'Request timeout',
214 |                         responseTime
215 |                     };
216 |                 }
217 |                 return {
218 |                     success: false,
219 |                     error: error.message,
220 |                     responseTime
221 |                 };
222 |             }
223 | 
224 |             return {
225 |                 success: false,
226 |                 error: 'Unknown error occurred',
227 |                 responseTime
228 |             };
229 |         }
230 |     }
231 | 
232 |     async testProvider(provider: 'openrouter' | 'requesty', options: {
233 |         retestBlocked?: boolean;
234 |         maxModels?: number;
235 |         skipWorking?: boolean;
236 |     } = {}): Promise<void> {
237 |         console.log(`\n🧪 Testing ${provider} models...`);
238 | 
239 |         const blockedModels = await this.loadBlockedModels();
240 |         let models: ModelInfo[];
241 | 
242 |         try {
243 |             models = await this.fetchModels(provider);
244 |         } catch (error) {
245 |             console.error(`❌ Failed to fetch models from ${provider}:`, error);
246 |             this.stats.errors++;
247 |             return;
248 |         }
249 | 
250 |         if (options.maxModels) {
251 |             models = models.slice(0, options.maxModels);
252 |         }
253 | 
254 |         console.log(`Found ${models.length} models to test`);
255 |         this.stats.total += models.length;
256 | 
257 |         for (let i = 0; i < models.length; i++) {
258 |             const model = models[i];
259 |             const modelKey = model.apiVersion || model.id.replace(`${provider}/`, '');
260 | 
261 |             // Check if model is already blocked and we're not retesting
262 |             const isBlocked = blockedModels.models[modelKey];
263 |             if (isBlocked && !options.retestBlocked) {
264 |                 if (isBlocked.manuallyBlocked) {
265 |                     console.log(`⏭️  Skipping manually blocked model: ${modelKey}`);
266 |                     this.stats.skipped++;
267 |                     continue;
268 |                 }
269 |             }
270 | 
271 |             // Skip working models if requested
272 |             if (options.skipWorking && !isBlocked) {
273 |                 this.stats.skipped++;
274 |                 continue;
275 |             }
276 | 
277 |             const progress = `[${i + 1}/${models.length}]`;
278 |             console.log(`${progress} Testing ${modelKey}...`);
279 | 
280 |             try {
281 |                 const result = await this.testModelEndpoint(model, provider);
282 | 
283 |                 if (result.success) {
284 |                     console.log(`✅ ${progress} ${modelKey} - Working (${result.responseTime}ms)`);
285 |                     this.stats.working++;
286 | 
287 |                     // Remove from blocked list if it was previously blocked
288 |                     if (isBlocked) {
289 |                         delete blockedModels.models[modelKey];
290 |                         console.log(`📋 Removed ${modelKey} from blocked list`);
291 |                     }
292 |                 } else {
293 |                     console.log(`❌ ${progress} ${modelKey} - Failed: ${result.error}`);
294 |                     this.stats.blocked++;
295 | 
296 |                     // Add or update in blocked list
297 |                     blockedModels.models[modelKey] = {
298 |                         provider,
299 |                         reason: `Endpoint test failed: ${result.error}`,
300 |                         lastTested: new Date().toISOString(),
301 |                         testError: result.error || 'Unknown error',
302 |                         retryCount: (isBlocked?.retryCount || 0) + 1,
303 |                         manuallyBlocked: false
304 |                     };
305 |                 }
306 | 
307 |                 this.stats.tested++;
308 | 
309 |                 // Rate limiting delay
310 |                 if (i < models.length - 1) {
311 |                     await new Promise(resolve => setTimeout(resolve, this.config.rateLimitDelayMs));
312 |                 }
313 | 
314 |             } catch (error) {
315 |                 console.error(`💥 ${progress} ${modelKey} - Test error:`, error);
316 |                 this.stats.errors++;
317 | 
318 |                 // Add to blocked list
319 |                 blockedModels.models[modelKey] = {
320 |                     provider,
321 |                     reason: `Test execution failed: ${error}`,
322 |                     lastTested: new Date().toISOString(),
323 |                     testError: error instanceof Error ? error.message : 'Unknown test error',
324 |                     retryCount: (isBlocked?.retryCount || 0) + 1,
325 |                     manuallyBlocked: false
326 |                 };
327 |             }
328 |         }
329 | 
330 |         // Save updated blocked models
331 |         await this.saveBlockedModels(blockedModels);
332 |         console.log(`💾 Updated blocked models list`);
333 |     }
334 | 
335 |     async testAllProviders(options: {
336 |         retestBlocked?: boolean;
337 |         maxModels?: number;
338 |         skipWorking?: boolean;
339 |         providers?: ('openrouter' | 'requesty')[];
340 |     } = {}): Promise<void> {
341 |         const providers = options.providers || ['openrouter', 'requesty'];
342 | 
343 |         console.log('🚀 Starting model endpoint testing...');
344 |         console.log(`Configuration:`, {
345 |             maxRetries: this.config.maxRetries,
346 |             timeout: `${this.config.requestTimeoutMs}ms`,
347 |             rateLimit: `${this.config.rateLimitDelayMs}ms`,
348 |             testMessage: this.config.testMessage,
349 |             maxTokens: this.config.maxTokens
350 |         });
351 | 
352 |         const startTime = Date.now();
353 | 
354 |         for (const provider of providers) {
355 |             await this.testProvider(provider, options);
356 |         }
357 | 
358 |         const duration = Date.now() - startTime;
359 | 
360 |         console.log('\n📊 Testing Complete!');
361 |         console.log('Stats:', {
362 |             ...this.stats,
363 |             duration: `${Math.round(duration / 1000)}s`,
364 |             avgTimePerModel: this.stats.tested > 0 ? `${Math.round(duration / this.stats.tested)}ms` : 'N/A'
365 |         });
366 | 
367 |         if (this.stats.blocked > 0) {
368 |             console.log(`\n⚠️  ${this.stats.blocked} models were added to the blocked list`);
369 |             console.log(`📄 Check ${this.blockedModelsPath} for details`);
370 |         }
371 |     }
372 | 
373 |     async printBlockedSummary(): Promise<void> {
374 |         const blockedModels = await this.loadBlockedModels();
375 |         const models = Object.entries(blockedModels.models);
376 | 
377 |         if (models.length === 0) {
378 |             console.log('✨ No blocked models found!');
379 |             return;
380 |         }
381 | 
382 |         console.log(`\n🚫 Blocked Models Summary (${models.length} total):`);
383 |         console.log(`Last updated: ${blockedModels.lastUpdated}`);
384 | 
385 |         const byProvider = models.reduce((acc, [key, model]) => {
386 |             acc[model.provider] = (acc[model.provider] || 0) + 1;
387 |             return acc;
388 |         }, {} as Record<string, number>);
389 | 
390 |         Object.entries(byProvider).forEach(([provider, count]) => {
391 |             console.log(`  ${provider}: ${count} models`);
392 |         });
393 | 
394 |         if (process.argv.includes('--verbose')) {
395 |             console.log('\nDetailed list:');
396 |             models.forEach(([key, model]) => {
397 |                 console.log(`  ${key} (${model.provider}): ${model.reason}`);
398 |             });
399 |         }
400 |     }
401 | }
402 | 
403 | // CLI Interface
404 | async function main() {
405 |     const args = process.argv.slice(2);
406 |     const tester = new ModelEndpointTester();
407 | 
408 |     if (args.includes('--help') || args.includes('-h')) {
409 |         console.log(`
410 | 🧪 Model Endpoint Tester
411 | 
412 | Usage: tsx scripts/test-model-endpoints.ts [options]
413 | 
414 | Options:
415 |   --help, -h              Show this help message
416 |   --provider <name>       Test specific provider (openrouter, requesty)
417 |   --retest-blocked        Re-test previously blocked models
418 |   --max-models <n>        Limit number of models to test per provider
419 |   --skip-working          Skip models that aren't currently blocked
420 |   --summary               Show summary of blocked models
421 |   --verbose               Show detailed output
422 |   
423 | Examples:
424 |   tsx scripts/test-model-endpoints.ts
425 |   tsx scripts/test-model-endpoints.ts --provider openrouter --max-models 10
426 |   tsx scripts/test-model-endpoints.ts --retest-blocked
427 |   tsx scripts/test-model-endpoints.ts --summary --verbose
428 | `);
429 |         return;
430 |     }
431 | 
432 |     if (args.includes('--summary')) {
433 |         await tester.printBlockedSummary();
434 |         return;
435 |     }
436 | 
437 |     const options = {
438 |         retestBlocked: args.includes('--retest-blocked'),
439 |         skipWorking: args.includes('--skip-working'),
440 |         maxModels: args.includes('--max-models') ?
441 |             parseInt(args[args.indexOf('--max-models') + 1] || '10') : undefined,
442 |         providers: args.includes('--provider') ?
443 |             [args[args.indexOf('--provider') + 1] as 'openrouter' | 'requesty'] : undefined
444 |     };
445 | 
446 |     await tester.testAllProviders(options);
447 | }
448 | 
449 | if (require.main === module) {
450 |     main().catch(console.error);
451 | }
452 | 
453 | export { ModelEndpointTester }; 
```

tests/BASIC-TESTS.md
```
1 | # ChatLima Basic UI Tests
2 | 
3 | ## Overview
4 | 
5 | These are simple, reliable tests that focus on core UI functionality without external dependencies. They test the fundamental user interface elements that should always work.
6 | 
7 | ## Why These Tests Are Better
8 | 
9 | ### Problems with Previous Tests:
10 | - ❌ Complex authentication flows for preview.chatlima.com
11 | - ❌ Testing specific AI models that may not be available  
12 | - ❌ API dependencies that can fail
13 | - ❌ Too many assertions and edge cases
14 | - ❌ Fragile setup and teardown
15 | 
16 | ### New Simple Approach:
17 | - ✅ Tests run on local dev server (localhost:3000)
18 | - ✅ No authentication required
19 | - ✅ No API calls or external dependencies
20 | - ✅ Focus on basic UI interactions
21 | - ✅ Fast and reliable
22 | 
23 | ## Test Coverage
24 | 
25 | ### 1. Page Load Test
26 | **What it tests:** Basic interface loads correctly
27 | - Page title is "ChatLima"
28 | - Main heading is visible
29 | - Message input field is present
30 | - Model picker dropdown is present
31 | - Send button is present
32 | 
33 | ### 2. Message Input Test  
34 | **What it tests:** Text input functionality works
35 | - Input field starts empty
36 | - Can type text into the field
37 | - Text appears correctly
38 | - Can clear the input
39 | - Placeholder text is correct
40 | 
41 | ### 3. Model Picker Test
42 | **What it tests:** Model picker interaction works
43 | - Model picker is visible and enabled
44 | - Contains expected model text (with ":" pattern)
45 | - Can be focused and interacted with
46 | - Remains functional after interactions
47 | 
48 | ## Running the Tests
49 | 
50 | ### Prerequisites
51 | 1. Install dependencies: `pnpm install`
52 | 2. Install Playwright browsers: `npx playwright install`
53 | 
54 | ### Run Tests
55 | ```bash
56 | # Run all basic tests
57 | pnpm run test:basic
58 | 
59 | # Run with UI (interactive mode)  
60 | pnpm run test:basic:ui
61 | 
62 | # Run in debug mode
63 | pnpm run test:basic:debug
64 | ```
65 | 
66 | ### Local Development
67 | Tests automatically start and stop the dev server (localhost:3000) as needed.
68 | 
69 | ## Configuration
70 | 
71 | Tests use `playwright.basic.config.ts` which:
72 | - Runs on localhost:3000
73 | - Starts dev server automatically
74 | - Uses simple retry strategy
75 | - Generates HTML reports
76 | - Takes screenshots only on failure
77 | 
78 | ## What These Tests Don't Cover
79 | 
80 | These basic tests intentionally **do not** test:
81 | - ❌ AI model responses
82 | - ❌ Authentication flows
83 | - ❌ Credit systems
84 | - ❌ Message sending to APIs
85 | - ❌ Complex user workflows
86 | 
87 | For those features, use integration tests or manual testing.
88 | 
89 | ## When Tests Should Pass
90 | 
91 | These tests should pass if:
92 | - ✅ The dev server starts successfully
93 | - ✅ Basic React components render
94 | - ✅ CSS styles load correctly
95 | - ✅ Basic DOM interactions work
96 | 
97 | ## Troubleshooting
98 | 
99 | ### Dev Server Won't Start
100 | - Check if port 3000 is already in use
101 | - Verify `npm run dev` works manually
102 | - Check for TypeScript compilation errors
103 | 
104 | ### Tests Fail on Element Selection
105 | - Elements might have changed - update selectors
106 | - Check browser console for JavaScript errors
107 | - Verify components are rendering correctly
108 | 
109 | ### Slow Performance
110 | - Tests run much faster than the old complex tests
111 | - If still slow, check system resources
112 | - Consider reducing browser parallelism
113 | 
114 | ## Maintenance
115 | 
116 | These tests are designed to be low-maintenance:
117 | - Minimal selectors that target core functionality
118 | - No complex setup or teardown
119 | - Self-contained with clear failure points
120 | - Easy to debug with screenshots and traces
121 | 
122 | Update tests only when core UI elements change significantly. 
```

tests/auth.local.setup.ts
```
1 | import { test as setup, expect } from '@playwright/test';
2 | 
3 | const authFile = 'playwright/.auth/local-user.json';
4 | 
5 | setup('authenticate locally', async ({ page }) => {
6 |     console.log('🔐 Starting local authentication setup...');
7 | 
8 |     // Go to local ChatLima
9 |     await page.goto('/', { waitUntil: 'networkidle' });
10 | 
11 |     // Take a screenshot to see what we're dealing with
12 |     await page.screenshot({ path: 'playwright-report/local-auth-step-1-initial-load.png' });
13 | 
14 |     // Check what page we're on
15 |     const title = await page.title();
16 |     console.log(`📄 Page title: "${title}"`);
17 | 
18 |     // Wait for the page to stabilize
19 |     await page.waitForTimeout(2000);
20 | 
21 |     // Check if we have ChatLima interface
22 |     const chatLimaHeading = page.locator('h1:has-text("ChatLima")');
23 |     const signInButton = page.getByRole('button', { name: 'Sign in with Google' });
24 | 
25 |     // Verify we have the ChatLima interface
26 |     await expect(chatLimaHeading).toBeVisible();
27 |     console.log('✅ ChatLima interface detected on localhost');
28 | 
29 |     // Check if we need to sign in
30 |     if (await signInButton.isVisible()) {
31 |         console.log('🔑 Sign in button available - for local testing, we can continue with anonymous user');
32 |         console.log('💡 Local development typically supports anonymous users out of the box');
33 |     } else {
34 |         console.log('✅ Already authenticated or anonymous access available');
35 |     }
36 | 
37 |     // Wait for the interface to settle
38 |     await page.waitForTimeout(2000);
39 | 
40 |     // Save authentication state (anonymous state for local)
41 |     await page.context().storageState({ path: authFile });
42 | 
43 |     console.log('💾 Local authentication state saved to:', authFile);
44 |     console.log('✨ Local authentication setup completed');
45 | }); 
```

tests/auth.setup.ts
```
1 | import { test as setup, expect } from '@playwright/test';
2 | 
3 | const authFile = 'playwright/.auth/user.json';
4 | 
5 | setup('authenticate', async ({ page }) => {
6 |     console.log('🔐 Starting authentication setup...');
7 | 
8 |     // Go to ChatLima
9 |     await page.goto('https://preview.chatlima.com/', { waitUntil: 'networkidle' });
10 | 
11 |     // Take a screenshot to see what we're dealing with
12 |     await page.screenshot({ path: 'playwright-report/auth-step-1-initial-load.png' });
13 | 
14 |     // Check what page we're on
15 |     const title = await page.title();
16 |     console.log(`📄 Page title: "${title}"`);
17 | 
18 |     if (title.includes('Login – Vercel')) {
19 |         console.log('🚫 Detected Vercel login page - this means the preview site requires authentication');
20 |         console.log('💡 You may need to set up proper preview authentication or use a different URL');
21 | 
22 |         // Let's try to continue anyway and see if we can get past it
23 |         await page.waitForTimeout(3000);
24 |     }
25 | 
26 |     // Wait for the page to stabilize
27 |     await page.waitForTimeout(2000);
28 | 
29 |     // Check if we have ChatLima interface
30 |     const chatLimaHeading = page.locator('h1:has-text("ChatLima")');
31 |     const signInButton = page.getByRole('button', { name: 'Sign in with Google' });
32 | 
33 |     if (await chatLimaHeading.isVisible()) {
34 |         console.log('✅ ChatLima interface detected');
35 | 
36 |         // Check if we need to sign in
37 |         if (await signInButton.isVisible()) {
38 |             console.log('🔑 Sign in required - attempting Google authentication');
39 | 
40 |             // Click the Google sign in button
41 |             await signInButton.click();
42 | 
43 |             // Handle the authentication flow
44 |             try {
45 |                 // Wait for either Google OAuth or redirect back
46 |                 await page.waitForURL(/accounts\.google\.com|preview\.chatlima\.com/, { timeout: 10000 });
47 | 
48 |                 if (page.url().includes('accounts.google.com')) {
49 |                     console.log('🌐 Redirected to Google OAuth');
50 | 
51 |                     // Fill in Google credentials if environment variables are set
52 |                     if (process.env.TEST_GOOGLE_EMAIL && process.env.TEST_GOOGLE_PASSWORD) {
53 |                         console.log('🤖 Using automated Google authentication');
54 | 
55 |                         // Fill email
56 |                         await page.fill('input[type="email"]', process.env.TEST_GOOGLE_EMAIL);
57 |                         await page.click('#identifierNext');
58 | 
59 |                         // Wait for password field and fill it
60 |                         await page.waitForSelector('input[type="password"]', { timeout: 5000 });
61 |                         await page.fill('input[type="password"]', process.env.TEST_GOOGLE_PASSWORD);
62 |                         await page.click('#passwordNext');
63 |                     } else {
64 |                         console.log('👤 Manual authentication required - waiting for user to complete sign in...');
65 |                         console.log('⏳ Please sign in manually in the browser. Waiting up to 60 seconds...');
66 |                     }
67 | 
68 |                     // Wait to be redirected back to ChatLima
69 |                     await page.waitForURL(/preview\.chatlima\.com/, { timeout: 60000 });
70 |                     console.log('🔄 Redirected back to ChatLima');
71 |                 }
72 |             } catch (error) {
73 |                 console.log('⚠️ Authentication flow error:', error);
74 |                 console.log('🔄 Continuing with current state...');
75 |             }
76 |         } else {
77 |             console.log('✅ Already authenticated or anonymous access available');
78 |         }
79 | 
80 |         // Wait for the interface to settle
81 |         await page.waitForTimeout(3000);
82 | 
83 |         // Verify we have the ChatLima interface
84 |         await expect(chatLimaHeading).toBeVisible();
85 |         console.log('✅ ChatLima interface confirmed');
86 | 
87 |     } else {
88 |         console.log('❌ ChatLima interface not detected');
89 |         console.log('🔍 Current URL:', page.url());
90 |         console.log('📄 Current title:', await page.title());
91 | 
92 |         // Take a screenshot for debugging
93 |         await page.screenshot({ path: 'playwright-report/auth-step-final-error.png' });
94 | 
95 |         // Instead of failing, let's save whatever state we have
96 |         console.log('⚠️ Proceeding with current state (may be unauthenticated)');
97 |     }
98 | 
99 |     // Save authentication state (even if partial)
100 |     await page.context().storageState({ path: authFile });
101 | 
102 |     console.log('💾 Authentication state saved to:', authFile);
103 |     console.log('✨ Authentication setup completed');
104 | }); 
```

tests/basic-ui.spec.ts
```
1 | import { test, expect } from '@playwright/test';
2 | 
3 | test.describe('ChatLima Basic UI Tests', () => {
4 | 
5 |     test('should load page and display core interface elements', async ({ page }) => {
6 |         // Navigate to the home page
7 |         await page.goto('/');
8 | 
9 |         // Verify the page title
10 |         await expect(page).toHaveTitle('ChatLima');
11 | 
12 |         // Verify the main heading is visible
13 |         await expect(page.getByRole('heading', { name: 'ChatLima' })).toBeVisible();
14 | 
15 |         // Verify the message input field is present
16 |         await expect(page.getByPlaceholder('Send a message...')).toBeVisible();
17 | 
18 |         // Verify the model picker (combobox) is present - look for one with model text pattern (contains ":")
19 |         const modelPicker = page.getByRole('combobox').filter({ hasText: /:/ }).first();
20 |         await expect(modelPicker).toBeVisible();
21 | 
22 |         // Verify the send button is present (but may be disabled)
23 |         await expect(page.locator('button[type="submit"]')).toBeVisible();
24 | 
25 |         console.log('✅ Basic UI elements loaded successfully');
26 |     });
27 | 
28 |     test('should handle message input field interactions', async ({ page }) => {
29 |         // Navigate to the home page
30 |         await page.goto('/');
31 | 
32 |         // Get the message input field
33 |         const messageInput = page.getByPlaceholder('Send a message...');
34 | 
35 |         // Verify input starts empty
36 |         await expect(messageInput).toHaveValue('');
37 | 
38 |         // Type a test message
39 |         const testMessage = 'This is a test message';
40 |         await messageInput.fill(testMessage);
41 | 
42 |         // Verify the text appears in the input
43 |         await expect(messageInput).toHaveValue(testMessage);
44 | 
45 |         // Clear the input
46 |         await messageInput.clear();
47 | 
48 |         // Verify the input is empty again
49 |         await expect(messageInput).toHaveValue('');
50 | 
51 |         // Verify placeholder is still visible when empty
52 |         await expect(messageInput).toHaveAttribute('placeholder', 'Send a message...');
53 | 
54 |         console.log('✅ Message input functionality working correctly');
55 |     });
56 | 
57 |     test('should interact with model picker', async ({ page }) => {
58 |         // Navigate to the home page
59 |         await page.goto('/');
60 | 
61 |         // Get the model picker combobox - it should contain model text with ":" pattern
62 |         const modelPicker = page.getByRole('combobox').filter({ hasText: /:/ }).first();
63 | 
64 |         // Verify model picker is visible and enabled
65 |         await expect(modelPicker).toBeVisible();
66 |         await expect(modelPicker).toBeEnabled();
67 | 
68 |         // Verify it has some model text (contains ":")
69 |         await expect(modelPicker).toContainText(':');
70 | 
71 |         // Just verify we can focus it (simpler than opening dropdown)
72 |         await modelPicker.focus();
73 | 
74 |         // Click elsewhere to remove focus
75 |         await page.getByPlaceholder('Send a message...').click();
76 | 
77 |         // Verify model picker is still there and functional
78 |         await expect(modelPicker).toBeVisible();
79 |         await expect(modelPicker).toBeEnabled();
80 | 
81 |         console.log('✅ Model picker interaction working correctly');
82 |     });
83 | 
84 |     test('should navigate home when clicking logo link', async ({ page }) => {
85 |         // Navigate to the home page
86 |         await page.goto('/');
87 | 
88 |         // Find the logo link - it should contain "ChatLima" text and be a link
89 |         const logoLink = page.getByRole('link', { name: /ChatLima/i }).first();
90 | 
91 |         // Verify logo link is visible and clickable
92 |         await expect(logoLink).toBeVisible();
93 |         await expect(logoLink).toBeEnabled();
94 | 
95 |         // Click the logo link
96 |         await logoLink.click();
97 | 
98 |         // Verify we're still on the home page (URL should be base URL)
99 |         await expect(page).toHaveURL('/');
100 | 
101 |         // Verify the page title is still correct
102 |         await expect(page).toHaveTitle('ChatLima');
103 | 
104 |         console.log('✅ Logo link navigation working correctly');
105 |     });
106 | 
107 |     test('should toggle sidebar open and close', async ({ page }) => {
108 |         // Navigate to the home page
109 |         await page.goto('/');
110 | 
111 |         // Find the sidebar toggle button (hamburger menu)
112 |         const sidebarToggle = page.getByRole('button', { name: /toggle sidebar|menu|hamburger/i }).or(
113 |             page.locator('button[aria-label*="sidebar"]')
114 |         ).or(
115 |             page.locator('button[data-testid*="sidebar"]')
116 |         ).or(
117 |             page.locator('button').filter({ hasText: /☰|≡|⋮/ })
118 |         ).first();
119 | 
120 |         // Verify sidebar toggle button is visible
121 |         await expect(sidebarToggle).toBeVisible();
122 | 
123 |         // Click to open sidebar (assuming it starts closed)
124 |         await sidebarToggle.click();
125 | 
126 |         // Wait a moment for animation
127 |         await page.waitForTimeout(500);
128 | 
129 |         // Click again to close sidebar
130 |         await sidebarToggle.click();
131 | 
132 |         // Wait a moment for animation
133 |         await page.waitForTimeout(500);
134 | 
135 |         // Verify toggle button is still there and functional
136 |         await expect(sidebarToggle).toBeVisible();
137 |         await expect(sidebarToggle).toBeEnabled();
138 | 
139 |         console.log('✅ Sidebar toggle functionality working correctly');
140 |     });
141 | 
142 |     test('should interact with new chat button in sidebar', async ({ page }) => {
143 |         // Navigate to the home page
144 |         await page.goto('/');
145 | 
146 |         // Find the sidebar toggle button and open sidebar
147 |         const sidebarToggle = page.getByRole('button', { name: /toggle sidebar|menu|hamburger/i }).or(
148 |             page.locator('button[aria-label*="sidebar"]')
149 |         ).or(
150 |             page.locator('button[data-testid*="sidebar"]')
151 |         ).or(
152 |             page.locator('button').filter({ hasText: /☰|≡|⋮/ })
153 |         ).first();
154 | 
155 |         // Open the sidebar
156 |         await sidebarToggle.click();
157 |         await page.waitForTimeout(500); // Wait for sidebar animation
158 | 
159 |         // Find the New Chat button in the sidebar
160 |         const newChatButton = page.getByRole('button', { name: /new chat|start chat|create chat|\+/i }).or(
161 |             page.locator('button[aria-label*="new chat"]')
162 |         ).or(
163 |             page.locator('button[data-testid*="new-chat"]')
164 |         ).first();
165 | 
166 |         // Verify new chat button is visible and enabled
167 |         await expect(newChatButton).toBeVisible();
168 |         await expect(newChatButton).toBeEnabled();
169 | 
170 |         // Click the new chat button
171 |         await newChatButton.click();
172 | 
173 |         // Verify we're still on a valid page (could be home or new chat route)
174 |         await expect(page).toHaveTitle('ChatLima');
175 | 
176 |         // Verify the message input is still available (indicating chat interface is ready)
177 |         await expect(page.getByPlaceholder('Send a message...')).toBeVisible();
178 | 
179 |         console.log('✅ New Chat button functionality working correctly');
180 |     });
181 | }); 
```

tests/chatlima-anonymous-test.spec.ts
```
1 | import { test, expect } from '@playwright/test';
2 | 
3 | test.describe('ChatLima Anonymous User Test', () => {
4 |     test('should work with anonymous authentication', async ({ page }) => {
5 |         // Step 1: Navigate to ChatLima (using baseURL from config)
6 |         await page.goto('/');
7 | 
8 |         // Wait for page to load
9 |         await expect(page).toHaveTitle('ChatLima');
10 | 
11 |         // Since ChatLima supports anonymous users, we should be able to use it without signing in
12 |         // Wait for the interface to load
13 |         await page.waitForLoadState('networkidle');
14 | 
15 |         // Step 2: Check if message input is available (anonymous users should be able to chat)
16 |         const messageInput = page.getByRole('textbox', { name: 'Send a message...' });
17 |         await expect(messageInput).toBeVisible();
18 | 
19 |         // Step 3: Click on the model selector dropdown
20 |         await page.getByRole('combobox').first().click();
21 | 
22 |         // Step 4: Select DeepSeek Chat V3 0324 model (if available for anonymous users)
23 |         const deepSeekOption = page.getByRole('option', { name: 'DeepSeek Chat V3 0324' });
24 |         if (await deepSeekOption.isVisible()) {
25 |             await deepSeekOption.click();
26 | 
27 |             // Verify the model is selected (check the combobox specifically)
28 |             await expect(page.getByRole('combobox').filter({ hasText: 'DeepSeek Chat V3 0324' })).toBeVisible();
29 |             console.log('✅ DeepSeek model selected');
30 |         } else {
31 |             console.log('💡 DeepSeek model not available, testing with default model');
32 |             // Close the dropdown by clicking somewhere else
33 |             await page.click('h1:has-text("ChatLima")');
34 |         }
35 | 
36 |         // Step 5: Type test message in the input field
37 |         const testMessage = 'Hello! This is a test message from an anonymous user. Can you respond with a simple greeting?';
38 |         await messageInput.fill(testMessage);
39 | 
40 |         // Step 6: Check if send button is enabled
41 |         const sendButton = page.getByRole('button').filter({ hasText: '' }).nth(1);
42 |         await expect(sendButton).toBeEnabled();
43 | 
44 |         // Step 7: Click the send button
45 |         await sendButton.click();
46 | 
47 |         // Step 8: Wait for and verify response is received
48 |         // Wait for the user message to appear
49 |         await expect(page.getByText(testMessage)).toBeVisible();
50 | 
51 |         // Wait for AI response (anonymous users might have limited functionality)
52 |         await page.waitForFunction(() => {
53 |             const messages = document.querySelectorAll('p');
54 |             return messages.length >= 2; // At least user message + AI response
55 |         }, { timeout: 30000 });
56 | 
57 |         // Step 9: Verify chat appears in sidebar (if available for anonymous users)
58 |         try {
59 |             await expect(page.getByText('Simple Greeting Request')).toBeVisible({ timeout: 5000 });
60 |             console.log('✅ Chat sidebar working for anonymous users');
61 |         } catch {
62 |             console.log('💡 Chat sidebar not available for anonymous users - this is expected');
63 |         }
64 | 
65 |         // Step 10: Verify messages are displayed
66 |         const allParagraphs = page.locator('p');
67 |         await expect(allParagraphs).toHaveCount(2, { timeout: 30000 });
68 | 
69 |         // Verify user message is displayed
70 |         await expect(page.getByText(testMessage)).toBeVisible();
71 | 
72 |         // Verify AI response is displayed (should contain some response text)
73 |         const aiResponse = allParagraphs.nth(1);
74 |         const responseText = await aiResponse.textContent();
75 |         console.log('🤖 AI Response received:', responseText?.substring(0, 100) + '...');
76 | 
77 |         // Just verify that we got some response that's different from the user message
78 |         await expect(aiResponse).not.toHaveText(testMessage);
79 |         await expect(aiResponse).toContainText(/.+/); // At least some text
80 | 
81 |         console.log('✅ Anonymous user test completed successfully!');
82 |         console.log('- Anonymous access working');
83 |         console.log('- Message sent successfully');
84 |         console.log('- Response received from AI');
85 |         console.log('- Interface functioning for anonymous users');
86 |     });
87 | 
88 |     test('should have proper interface elements for anonymous users', async ({ page }) => {
89 |         // Navigate to ChatLima (using baseURL from config)
90 |         await page.goto('/');
91 | 
92 |         // Check if ChatLima interface is loaded
93 |         await expect(page.getByRole('heading', { name: 'ChatLima' })).toBeVisible();
94 | 
95 |         // Verify input field is ready
96 |         await expect(page.getByRole('textbox', { name: 'Send a message...' })).toBeVisible();
97 | 
98 |         // Check if model selector is available
99 |         await expect(page.getByRole('combobox').first()).toBeVisible();
100 | 
101 |         // Check if sign in button is visible (optional for anonymous users)
102 |         const signInButton = page.getByRole('button', { name: 'Sign in with Google' });
103 |         if (await signInButton.isVisible()) {
104 |             console.log('✅ Sign in option available for upgrading');
105 |         } else {
106 |             console.log('💡 No sign in button visible - anonymous mode working directly');
107 |         }
108 | 
109 |         console.log('✅ Anonymous user interface test completed!');
110 |     });
111 | }); 
```

tests/chatlima-deepseek-test.spec.ts
```
1 | import { test, expect } from '@playwright/test';
2 | 
3 | test.describe('ChatLima DeepSeek Model Test', () => {
4 |     test('should select DeepSeek Chat V3 0324 model, send message, and receive response', async ({ page }) => {
5 |         // Step 1: Navigate to ChatLima (using baseURL from config)
6 |         await page.goto('/');
7 | 
8 |         // Wait for page to load
9 |         await expect(page).toHaveTitle('ChatLima');
10 | 
11 |         // Step 2: Click on the model selector dropdown
12 |         await page.getByRole('combobox').first().click();
13 | 
14 |         // Step 3: Select DeepSeek Chat V3 0324 model
15 |         await page.getByRole('option', { name: 'DeepSeek Chat V3 0324' }).click();
16 | 
17 |         // Verify the model is selected - target the combobox specifically
18 |         await expect(page.getByRole('combobox').getByText('DeepSeek Chat V3 0324')).toBeVisible();
19 | 
20 |         // Step 4: Type test message in the input field
21 |         const testMessage = 'Hello! This is a test message. Can you respond with a simple greeting?';
22 |         await page.getByRole('textbox', { name: 'Send a message...' }).fill(testMessage);
23 | 
24 |         // Step 5: Click the send button - target the submit button with ArrowUp icon
25 |         const sendButton = page.locator('button[type="submit"]');
26 |         await sendButton.click();
27 | 
28 |         // Step 6: Wait for and verify response is received
29 |         // Wait for the user message to appear
30 |         await expect(page.getByText(testMessage)).toBeVisible();
31 | 
32 |         // Wait for AI response with more robust approach
33 |         await page.waitForFunction(() => {
34 |             // Look for multiple message elements in the chat
35 |             const chatMessages = document.querySelectorAll('[data-role="user"], [data-role="assistant"], .message, [class*="message"]');
36 |             if (chatMessages.length >= 2) return true;
37 | 
38 |             // Fallback: look for paragraphs that might contain messages
39 |             const paragraphs = document.querySelectorAll('p');
40 |             return paragraphs.length >= 2;
41 |         }, { timeout: 45000 });
42 | 
43 |         // Wait for streaming to complete - look for submit button to be enabled again
44 |         await expect(sendButton).toBeEnabled({ timeout: 30000 });
45 | 
46 |         // Step 7: Verify chat appears in sidebar (with more flexible text matching)
47 |         const chatTitle = page.locator('text=/Simple Greeting|Test|Chat|Hello/i').first();
48 |         await expect(chatTitle).toBeVisible({ timeout: 10000 });
49 | 
50 |         // Step 8: Verify both messages are displayed
51 |         const allParagraphs = page.locator('p');
52 |         await expect(allParagraphs).toHaveCount(2, { timeout: 30000 });
53 | 
54 |         // Verify user message is displayed
55 |         await expect(page.getByText(testMessage)).toBeVisible();
56 | 
57 |         // Verify AI response is displayed (should contain greeting-like text)
58 |         const aiResponse = allParagraphs.nth(1);
59 |         await expect(aiResponse).toContainText(/hello|hi|thanks|great|day|greeting/i);
60 | 
61 |         // Verify copy buttons are present - wait for streaming to complete first
62 |         await expect(page.getByRole('button', { name: 'Copy' })).toHaveCount(2, { timeout: 10000 });
63 | 
64 |         // Additional verification: Ensure the model is still selected - target combobox specifically
65 |         await expect(page.getByRole('combobox').getByText('DeepSeek Chat V3 0324')).toBeVisible();
66 | 
67 |         console.log('✅ Test completed successfully!');
68 |         console.log('- Model selected: DeepSeek Chat V3 0324');
69 |         console.log('- Message sent successfully');
70 |         console.log('- Response received from AI');
71 |         console.log('- Chat created in sidebar');
72 |         console.log('- Both messages displayed correctly');
73 |     });
74 | 
75 |     test('should handle model selection and maintain state', async ({ page }) => {
76 |         // Navigate to ChatLima (using baseURL from config)
77 |         await page.goto('/');
78 | 
79 |         // Open model selector
80 |         await page.getByRole('combobox').first().click();
81 | 
82 |         // Verify DeepSeek model is available
83 |         await expect(page.getByRole('option', { name: 'DeepSeek Chat V3 0324' })).toBeVisible();
84 | 
85 |         // Select the model
86 |         await page.getByRole('option', { name: 'DeepSeek Chat V3 0324' }).click();
87 | 
88 |         // Verify model persists after selection - target combobox specifically
89 |         await expect(page.getByRole('combobox').getByText('DeepSeek Chat V3 0324')).toBeVisible();
90 | 
91 |         // Verify input field is ready
92 |         await expect(page.getByRole('textbox', { name: 'Send a message...' })).toBeVisible();
93 | 
94 |         // Verify send button starts disabled - target the submit button
95 |         const sendButton = page.locator('button[type="submit"]');
96 |         await expect(sendButton).toBeDisabled();
97 | 
98 |         // Type a message to enable send button
99 |         await page.getByRole('textbox', { name: 'Send a message...' }).fill('test');
100 |         await expect(sendButton).toBeEnabled();
101 |     });
102 | }); 
```

tests/premium-model-security.spec.ts
```
1 | import { test, expect } from '@playwright/test';
2 | 
3 | test.describe('Premium Model Security Tests', () => {
4 |     test('Anonymous users should be blocked from accessing premium models', async ({ request }) => {
5 |         // Create an anonymous session first
6 |         const authResponse = await request.post('/api/auth/sign-in/anonymous');
7 |         expect(authResponse.ok()).toBeTruthy();
8 | 
9 |         const authData = await authResponse.json();
10 |         const sessionCookie = authResponse.headers()['set-cookie']?.[0];
11 | 
12 |         // Attempt to use Claude 4 Opus (premium model) as anonymous user
13 |         const chatResponse = await request.post('/api/chat', {
14 |             headers: {
15 |                 'Cookie': sessionCookie || '',
16 |                 'Content-Type': 'application/json',
17 |             },
18 |             data: {
19 |                 messages: [
20 |                     {
21 |                         role: 'user',
22 |                         content: 'Hello, this is a test message',
23 |                     },
24 |                 ],
25 |                 selectedModel: 'openrouter/anthropic/claude-4-opus-20250522',
26 |                 webSearch: { enabled: false },
27 |                 apiKeys: {},
28 |                 attachments: [],
29 |             },
30 |         });
31 | 
32 |         // Should be blocked with 403 Forbidden
33 |         expect(chatResponse.status()).toBe(403);
34 | 
35 |         const errorData = await chatResponse.json();
36 |         expect(errorData.error).toBe('PREMIUM_MODEL_RESTRICTED');
37 |         expect(errorData.message).toContain('Anonymous users cannot access premium models');
38 |     });
39 | 
40 |     test('Anonymous users should still access free models', async ({ request }) => {
41 |         // Create an anonymous session first
42 |         const authResponse = await request.post('/api/auth/sign-in/anonymous');
43 |         expect(authResponse.ok()).toBeTruthy();
44 | 
45 |         const sessionCookie = authResponse.headers()['set-cookie']?.[0];
46 | 
47 |         // Attempt to use a free model as anonymous user
48 |         const chatResponse = await request.post('/api/chat', {
49 |             headers: {
50 |                 'Cookie': sessionCookie || '',
51 |                 'Content-Type': 'application/json',
52 |             },
53 |             data: {
54 |                 messages: [
55 |                     {
56 |                         role: 'user',
57 |                         content: 'Hello, this is a test message',
58 |                     },
59 |                 ],
60 |                 selectedModel: 'openrouter/mistralai/mistral-7b-instruct:free',
61 |                 webSearch: { enabled: false },
62 |                 apiKeys: {},
63 |                 attachments: [],
64 |             },
65 |         });
66 | 
67 |         // Should be allowed (200 or streaming response)
68 |         expect([200, 201]).toContain(chatResponse.status());
69 |     });
70 | 
71 |     test('Users with own API keys can access premium models', async ({ request }) => {
72 |         // Create an anonymous session first
73 |         const authResponse = await request.post('/api/auth/sign-in/anonymous');
74 |         expect(authResponse.ok()).toBeTruthy();
75 | 
76 |         const sessionCookie = authResponse.headers()['set-cookie']?.[0];
77 | 
78 |         // Attempt to use premium model with own API key
79 |         const chatResponse = await request.post('/api/chat', {
80 |             headers: {
81 |                 'Cookie': sessionCookie || '',
82 |                 'Content-Type': 'application/json',
83 |             },
84 |             data: {
85 |                 messages: [
86 |                     {
87 |                         role: 'user',
88 |                         content: 'Hello, this is a test message',
89 |                     },
90 |                 ],
91 |                 selectedModel: 'openrouter/anthropic/claude-4-opus-20250522',
92 |                 webSearch: { enabled: false },
93 |                 apiKeys: {
94 |                     'OPENROUTER_API_KEY': 'sk-or-test-key-12345', // Mock API key
95 |                 },
96 |                 attachments: [],
97 |             },
98 |         });
99 | 
100 |         // Should be allowed even for anonymous users with own API keys
101 |         expect([200, 201]).toContain(chatResponse.status());
102 |     });
103 | }); 
```

.cursor/rules/feature-branch-creation-workflow.mdc
```
1 | ---
2 | description: 
3 | globs: 
4 | alwaysApply: false
5 | ---
6 | # Feature Branch Creation Workflow
7 | 
8 | This rule provides a standardized workflow for creating new feature branches in the ChatLima project, ensuring consistent naming conventions, proper setup, and clear documentation.
9 | 
10 | ## 🌟 Branch Creation Process
11 | 
12 | ### 1. Pre-Creation Planning
13 | Before creating a new feature branch:
14 | - Define the feature scope and requirements
15 | - Choose an appropriate branch naming convention
16 | - Ensure you're starting from the latest main branch
17 | - Check for any conflicting features in development
18 | 
19 | ### 2. Branch Naming Convention
20 | Use descriptive, kebab-case names that clearly identify the feature:
21 | 
22 | ```bash
23 | # Feature branches (new functionality)
24 | feature/auth-integration
25 | feature/polar-payment-system
26 | feature/chat-history-export
27 | feature/user-dashboard-redesign
28 | 
29 | # Bug fix branches
30 | fix/credit-deduction-bug
31 | fix/negative-balance-blocking
32 | fix/auth-session-timeout
33 | 
34 | # Enhancement branches
35 | enhance/ui-accessibility
36 | enhance/performance-optimization
37 | enhance/mobile-responsiveness
38 | 
39 | # Documentation branches
40 | docs/api-documentation
41 | docs/deployment-guide
42 | docs/user-manual-update
43 | ```
44 | 
45 | ### 3. Create and Setup Feature Branch
46 | 
47 | #### Quick Setup Commands:
48 | ```bash
49 | # Ensure you're on main and up to date
50 | git checkout main
51 | git pull origin main
52 | 
53 | # Create and switch to new feature branch
54 | git checkout -b feature/your-feature-name
55 | 
56 | # Push the new branch to remote and set upstream
57 | git push -u origin feature/your-feature-name
58 | ```
59 | 
60 | #### Alternative Step-by-Step:
61 | ```bash
62 | # 1. Switch to main branch
63 | git checkout main
64 | 
65 | # 2. Pull latest changes
66 | git pull origin main
67 | 
68 | # 3. Create new branch from main
69 | git branch feature/your-feature-name
70 | 
71 | # 4. Switch to the new branch
72 | git checkout feature/your-feature-name
73 | 
74 | # 5. Push to remote and set upstream tracking
75 | git push -u origin feature/your-feature-name
76 | ```
77 | 
78 | ### 4. Initial Branch Setup
79 | 
80 | #### Create Feature Documentation
81 | Create a brief feature plan (optional but recommended):
82 | 
83 | ```bash
84 | # Create a feature plan file (optional)
85 | touch docs/features/your-feature-name.md
86 | ```
87 | 
88 | #### Feature Plan Template:
89 | ```markdown
90 | # Feature: [Feature Name]
91 | 
92 | ## 🎯 Overview
93 | Brief description of what this feature does and why it's needed.
94 | 
95 | ## 📋 Requirements
96 | - [ ] Requirement 1
97 | - [ ] Requirement 2
98 | - [ ] Requirement 3
99 | 
100 | ## 🏗️ Implementation Plan
101 | 1. Step 1: Component/API design
102 | 2. Step 2: Core functionality
103 | 3. Step 3: UI/UX implementation
104 | 4. Step 4: Testing and validation
105 | 5. Step 5: Documentation
106 | 
107 | ## 📁 Files to Modify/Create
108 | - `app/api/new-endpoint/route.ts`
109 | - `components/NewComponent.tsx`
110 | - `lib/new-utility.ts`
111 | 
112 | ## 🧪 Testing Strategy
113 | - Unit tests for core functions
114 | - Integration tests for API endpoints
115 | - E2E tests for user workflows
116 | 
117 | ## 📝 Notes
118 | Any additional notes, considerations, or dependencies.
119 | ```
120 | 
121 | ### 5. Development Workflow
122 | 
123 | #### Regular Commits
124 | Follow conventional commit messages:
125 | ```bash
126 | # Feature commits
127 | git commit -m "feat: add user authentication middleware"
128 | git commit -m "feat(api): implement payment processing endpoint"
129 | 
130 | # Fix commits
131 | git commit -m "fix: resolve credit deduction for Google users"
132 | git commit -m "fix(ui): correct mobile navigation alignment"
133 | 
134 | # Enhancement commits
135 | git commit -m "enhance: improve database query performance"
136 | git commit -m "enhance(ux): add loading states to buttons"
137 | 
138 | # Documentation commits
139 | git commit -m "docs: add API endpoint documentation"
140 | git commit -m "docs: update deployment instructions"
141 | ```
142 | 
143 | #### Regular Pushes
144 | Push your work regularly to keep the remote branch updated:
145 | ```bash
146 | # Push current branch changes
147 | git push
148 | 
149 | # Or explicitly push to origin
150 | git push origin feature/your-feature-name
151 | ```
152 | 
153 | ### 6. Keep Branch Updated
154 | 
155 | #### Sync with Main Regularly
156 | ```bash
157 | # Method 1: Merge main into feature branch
158 | git checkout feature/your-feature-name
159 | git pull origin main
160 | 
161 | # Method 2: Rebase feature branch onto main (cleaner history)
162 | git checkout feature/your-feature-name
163 | git rebase main
164 | 
165 | # If conflicts occur during rebase:
166 | # 1. Resolve conflicts in affected files
167 | # 2. Stage resolved files: git add .
168 | # 3. Continue rebase: git rebase --continue
169 | ```
170 | 
171 | ### 7. Safe Vercel Deployment Testing
172 | 
173 | #### ⚠️ CRITICAL: Vercel CLI Safety Rules
174 | **NEVER run Vercel setup commands while on feature branches!**
175 | 
176 | The Vercel CLI has dangerous behavior during initial setup:
177 | - `--prod=false` flag gets **ignored** during first-time setup
178 | - "Set up and deploy" process defaults to **production deployment**
179 | - This can accidentally deploy untested feature branches to production
180 | 
181 | #### Safe Deployment Workflow:
182 | ```bash
183 | # ❌ DANGEROUS - Don't do this on feature branches
184 | vercel --prod=false  # This can still deploy to production!
185 | 
186 | # ✅ SAFE - Proper testing workflow
187 | # 1. Setup project on main branch first (one-time only)
188 | git checkout main
189 | vercel link  # Setup only, no deployment
190 | 
191 | # 2. Switch to feature branch for testing  
192 | git checkout feature/your-feature-name
193 | 
194 | # 3. Deploy as preview only
195 | vercel deploy  # Always creates preview deployment
196 | 
197 | # 4. Test thoroughly on preview URL
198 | # 5. Never use --prod unless ready for production release
199 | ```
200 | 
201 | #### Emergency Production Revert:
202 | If you accidentally deploy a feature branch to production:
203 | ```bash
204 | # 1. Switch to safe main branch immediately
205 | git checkout main
206 | git stash  # if you have uncommitted changes
207 | 
208 | # 2. Deploy main to restore production
209 | vercel deploy --prod
210 | 
211 | # 3. Create proper preview for testing
212 | git checkout feature/your-feature-name
213 | git stash pop  # restore changes if stashed
214 | vercel deploy  # Preview only
215 | ```
216 | 
217 | #### Vercel Best Practices:
218 | - **Always use `vercel deploy`** for feature branch testing
219 | - **Only use `vercel deploy --prod`** for production releases
220 | - **Setup projects on main branch** before working on features
221 | - **Test on preview URLs first** before any production deployment
222 | - **Use Git integration** - let Vercel auto-create previews from pushed branches
223 | 
224 | ## 📋 Branch Management Commands
225 | 
226 | ### Useful Git Commands
227 | ```bash
228 | # Check current branch and status
229 | git status
230 | 
231 | # List all branches (local and remote)
232 | git branch -a
233 | 
234 | # Check branch tracking information
235 | git branch -vv
236 | 
237 | # See commits unique to your branch
238 | git log main..HEAD --oneline
239 | 
240 | # See what files have changed
241 | git diff --name-only main
242 | 
243 | # Stash current work temporarily
244 | git stash
245 | git stash pop  # restore stashed work
246 | 
247 | # Delete local branch (if no longer needed)
248 | git branch -d feature/branch-name
249 | 
250 | # Delete remote branch
251 | git push origin --delete feature/branch-name
252 | ```
253 | 
254 | ### Branch Information
255 | ```bash
256 | # See commit history for current branch
257 | git log --oneline -10
258 | 
259 | # See detailed diff with main
260 | git diff main
261 | 
262 | # Check if branch is ahead/behind main
263 | git status -uno
264 | ```
265 | 
266 | ## 🎯 Best Practices
267 | 
268 | ### Naming Guidelines:
269 | - Use descriptive names that explain the feature
270 | - Keep names concise but clear
271 | - Use kebab-case (hyphens between words)
272 | - Include the type prefix (feature/, fix/, enhance/, docs/)
273 | - Avoid abbreviations that might be unclear
274 | 
275 | ### Development Guidelines:
276 | - Make small, focused commits with clear messages
277 | - Test your changes regularly
278 | - Keep the branch updated with main to avoid large conflicts
279 | - Document complex changes as you go
280 | - Consider creating draft PRs early for feedback
281 | 
282 | ### Project-Specific Considerations:
283 | For ChatLima specifically, consider these areas when creating branches:
284 | - **Authentication**: Features related to [auth-schema.ts](mdc:chatlima/auth-schema.ts)
285 | - **API Routes**: New endpoints in [app/api/](mdc:chatlima/app/api)
286 | - **Database**: Changes requiring [drizzle/](mdc:chatlima/drizzle) migrations
287 | - **UI Components**: New components in [components/](mdc:chatlima/components)
288 | - **AI Integration**: Features in [ai/](mdc:chatlima/ai) directory
289 | - **Payment System**: Polar integration features
290 | - **Credit System**: User credit and usage tracking
291 | 
292 | ### File Organization:
293 | - Keep related changes in logical commits
294 | - Update relevant configuration files ([next.config.ts](mdc:chatlima/next.config.ts), [tsconfig.json](mdc:chatlima/tsconfig.json))
295 | - Add new dependencies to [package.json](mdc:chatlima/package.json) as needed
296 | - Update [README.md](mdc:chatlima/README.md) if the feature affects setup or usage
297 | 
298 | ## 🚨 Important Reminders
299 | 
300 | - Always start from an updated main branch
301 | - Use descriptive branch names that clearly indicate the feature
302 | - Push branches to remote early to enable collaboration
303 | - Keep feature branches focused on a single feature or fix
304 | - Regularly sync with main to avoid integration conflicts
305 | - Document complex features as you develop them
306 | - Consider the impact on existing functionality
307 | - Test thoroughly before requesting reviews
308 | 
309 | ## 🔄 Integration with Release Workflow
310 | 
311 | This workflow is designed to work seamlessly with the [feature-release-workflow.mdc](mdc:chatlima/feature-release-workflow.mdc):
312 | 
313 | 1. **Create branch** using this workflow
314 | 2. **Develop feature** following the guidelines here
315 | 3. **Merge and release** using the feature release workflow
316 | 
317 | ### Ready for Release Checklist:
318 | - [ ] Feature is complete and tested
319 | - [ ] Branch is up to date with main
320 | - [ ] All commits have clear messages
321 | - [ ] Documentation is updated
322 | - [ ] No merge conflicts with main
323 | - [ ] Feature has been tested in development environment
324 | - [ ] Ready to follow the [feature-release-workflow.mdc](mdc:chatlima/feature-release-workflow.mdc)
```

.cursor/rules/feature-release-workflow.mdc
```
1 | ---
2 | description: 
3 | globs: 
4 | alwaysApply: false
5 | ---
6 | # Feature Release Workflow
7 | 
8 | This rule provides a complete workflow for releasing new features in the ChatLima project, from merging feature branches to creating GitHub release notes.
9 | 
10 | ## 🔄 Complete Release Process
11 | 
12 | ### 1. Pre-Release Checks
13 | Before starting the release process:
14 | - Ensure all tests pass
15 | - Verify the feature branch is up to date with main
16 | - Check that [package.json](mdc:chatlima/chatlima/chatlima/package.json) reflects the current version
17 | - Review recent commits with `git log --oneline -10`
18 | 
19 | ### 2. Merge Feature Branch
20 | ```bash
21 | # Switch to main branch
22 | git checkout main
23 | 
24 | # Pull latest changes
25 | git pull origin main
26 | 
27 | # Merge feature branch (replace 'feature/branch-name' with actual branch)
28 | git merge feature/branch-name
29 | 
30 | # Delete the feature branch locally
31 | git branch -d feature/branch-name
32 | 
33 | # Delete the feature branch remotely
34 | git push origin --delete feature/branch-name
35 | ```
36 | 
37 | ### 3. Version Increment
38 | Use npm version to automatically update [package.json](mdc:chatlima/chatlima/chatlima/package.json) and create a git tag:
39 | 
40 | ```bash
41 | # For patch releases (0.3.0 -> 0.3.1)
42 | npm version patch
43 | 
44 | # For minor releases (0.3.0 -> 0.4.0)
45 | npm version minor
46 | 
47 | # For major releases (0.3.0 -> 1.0.0)
48 | npm version major
49 | ```
50 | 
51 | This command:
52 | - Updates the version in [package.json](mdc:chatlima/chatlima/chatlima/package.json)
53 | - Creates a git commit with the version change
54 | - Creates a git tag (e.g., v0.3.1)
55 | 
56 | ### 4. Push Changes
57 | ```bash
58 | # Push commits and tags to remote
59 | git push origin main --tags
60 | ```
61 | 
62 | ### 5. Create Release Notes
63 | Generate comprehensive release notes following this structure:
64 | 
65 | #### Template Structure:
66 | ```markdown
67 | # 🚀 ChatLima v[VERSION] - [FEATURE_NAME]
68 | 
69 | ## 🎯 What's New
70 | - List major features added
71 | - Highlight user-facing improvements
72 | - Note any new capabilities
73 | 
74 | ## 🔧 Technical Implementation
75 | - Detail technical changes
76 | - Mention new routes, APIs, or components
77 | - Include performance improvements
78 | 
79 | ## 🛡️ Security & Privacy
80 | - Highlight security enhancements
81 | - Note privacy protections
82 | - Mention any security-related changes
83 | 
84 | ## 📈 Benefits
85 | - Explain user benefits
86 | - Note SEO, performance, or UX improvements
87 | - Highlight business value
88 | 
89 | ## 🔄 Migration Notes
90 | - List any breaking changes (if any)
91 | - Note required configuration changes
92 | - Mention database migrations needed
93 | 
94 | ## 🚀 Deployment
95 | - Deployment instructions
96 | - Environment considerations
97 | - Any special setup requirements
98 | 
99 | ---
100 | 
101 | **Full Changelog**: [v[PREV_VERSION]...v[NEW_VERSION]](https://github.com/username/chatlima/compare/v[PREV_VERSION]...v[NEW_VERSION])
102 | ```
103 | 
104 | #### Save Release Notes
105 | Create a file named `RELEASE_NOTES_v[VERSION].md` in the `releases/` folder for reference.
106 | 
107 | ### 6. Production Deployment
108 | 
109 | #### 🔄 Automatic Deployment (GitHub Integration)
110 | With GitHub integration enabled, Vercel automatically handles deployments:
111 | 
112 | ```bash
113 | # ✅ AUTOMATIC - Normal deployment workflow
114 | # 1. Ensure you're on main branch with merged changes
115 | git checkout main
116 | git pull origin main
117 | 
118 | # 2. Verify everything is ready for production
119 | npm run build  # Test build locally
120 | npm run test   # Run all tests
121 | 
122 | # 3. Push to main triggers automatic production deployment
123 | git push origin main  # This automatically deploys to production via GitHub integration
124 | 
125 | # 4. Monitor deployment
126 | # Check Vercel dashboard for deployment status
127 | # Verify production URL once deployment completes
128 | ```
129 | 
130 | #### 🔧 Manual Deployment (Optional)
131 | Manual deployment is only needed for special cases:
132 | 
133 | ```bash
134 | # When you need to deploy without pushing to git
135 | vercel deploy --prod  # Explicit production deployment
136 | 
137 | # Or for testing local changes before commit
138 | vercel deploy  # Preview deployment
139 | ```
140 | 
141 | #### Production Deployment Checklist:
142 | - [ ] All tests passing
143 | - [ ] Feature thoroughly tested on preview deployments
144 | - [ ] Environment variables configured for production
145 | - [ ] Database migrations completed (if applicable)
146 | - [ ] Monitoring and error tracking enabled
147 | - [ ] GitHub integration properly configured
148 | 
149 | #### Emergency Rollback:
150 | If issues are discovered after production deployment:
151 | ```bash
152 | # Option 1: Rollback via git (triggers auto-deployment)
153 | git checkout main
154 | git reset --hard HEAD~1  # Go back one commit
155 | git push origin main --force  # Auto-deploys previous version
156 | 
157 | # Option 2: Manual rollback (if needed)
158 | vercel deploy --prod  # Deploy specific version manually
159 | ```
160 | 
161 | ### 7. GitHub Release Creation
162 | 1. Go to GitHub repository → Releases → "Create a new release"
163 | 2. Select the version tag created by `npm version`
164 | 3. Copy content from the release notes file
165 | 4. Set release title: "v[VERSION] - [FEATURE_NAME]"
166 | 5. Mark as "Latest release" if it's the newest version
167 | 6. Publish the release
168 | 
169 | ## 📋 Quick Reference Commands
170 | 
171 | ```bash
172 | # Complete release workflow
173 | git checkout main
174 | git pull origin main
175 | git merge feature/[branch-name]
176 | npm version [patch|minor|major]
177 | git push origin main --tags
178 | git branch -d feature/[branch-name]
179 | git push origin --delete feature/[branch-name]
180 | ```
181 | 
182 | ## 🎯 Best Practices
183 | 
184 | ### Version Selection Guidelines:
185 | - **Patch** (0.3.0 → 0.3.1): Bug fixes, small improvements, security patches
186 | - **Minor** (0.3.0 → 0.4.0): New features, significant improvements, new capabilities
187 | - **Major** (0.3.0 → 1.0.0): Breaking changes, major rewrites, API changes
188 | 
189 | ### Release Notes Guidelines:
190 | - Use emojis for visual appeal and categorization
191 | - Focus on user benefits, not just technical details
192 | - Include migration instructions for any breaking changes
193 | - Highlight security and privacy improvements
194 | - Keep technical details accessible to non-developers
195 | - Reference relevant files using [filename](mdc:chatlima/chatlima/chatlima/filename) format
196 | 
197 | ### File References:
198 | - Version information: [package.json](mdc:chatlima/chatlima/chatlima/package.json)
199 | - Previous release notes: Look for existing `RELEASE_NOTES_v*.md` files in the `releases/` folder
200 | - Implementation details: Check [app/](mdc:chatlima/chatlima/chatlima/app) directory for new routes
201 | - Configuration: [next.config.ts](mdc:chatlima/chatlima/chatlima/next.config.ts), [tsconfig.json](mdc:chatlima/chatlima/chatlima/tsconfig.json)
202 | 
203 | ## 🚨 Important Notes
204 | 
205 | - Always test the feature thoroughly before merging
206 | - Ensure the production environment can handle new features
207 | - Keep release notes user-focused while including technical details
208 | - Tag releases consistently for easy tracking
209 | - Delete feature branches after successful merge to keep repository clean
210 | - Use descriptive commit messages for the version bump commits
```

.cursor/rules/jest-testing-standards.mdc
```
1 | ---
2 | globs: *.test.ts,*.test.tsx,*.spec.ts,*.spec.tsx
3 | description: Jest testing standards and best practices for React components
4 | ---
5 | 
6 | # Jest Testing Standards
7 | 
8 | Follow these patterns when creating comprehensive unit tests for React components using Jest and React Testing Library.
9 | 
10 | ## File Structure and Setup
11 | 
12 | ### Essential Imports and References
13 | ```typescript
14 | /// <reference types="@testing-library/jest-dom" />
15 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
16 | import { ComponentName } from '../../components/component-name';
17 | ```
18 | 
19 | ### Mock External Dependencies
20 | Always mock external dependencies at the top of your test file:
21 | 
22 | ```typescript
23 | // Mock localStorage
24 | const localStorageMock = {
25 |   getItem: jest.fn(),
26 |   setItem: jest.fn(),
27 |   removeItem: jest.fn(),
28 |   clear: jest.fn(),
29 | };
30 | Object.defineProperty(window, 'localStorage', {
31 |   value: localStorageMock
32 | });
33 | 
34 | // Mock toast notifications
35 | jest.mock('sonner', () => ({
36 |   toast: {
37 |     success: jest.fn(),
38 |     error: jest.fn(),
39 |   },
40 | }));
41 | 
42 | // Mock UI components with proper prop forwarding
43 | jest.mock('../../components/ui/button', () => ({
44 |   Button: ({ children, onClick, variant, className, ...props }: any) => (
45 |     <button 
46 |       onClick={onClick} 
47 |       className={className} 
48 |       data-variant={variant}
49 |       data-testid={`button-${variant || 'default'}`}
50 |       {...props}
51 |     >
52 |       {children}
53 |     </button>
54 |   ),
55 | }));
56 | ```
57 | 
58 | ## Test Organization
59 | 
60 | ### Use Descriptive Describe Blocks
61 | Organize tests into logical categories:
62 | 
63 | ```typescript
64 | describe('ComponentName', () => {
65 |   // Tests for Basic Rendering and Props
66 |   describe('Basic Rendering and Props', () => {
67 |     test('renders when prop is true', () => {});
68 |     test('does not render when prop is false', () => {});
69 |   });
70 | 
71 |   // Tests for User Interactions  
72 |   describe('User Interactions', () => {
73 |     test('handles click events correctly', () => {});
74 |     test('updates state when input changes', () => {});
75 |   });
76 | 
77 |   // Tests for Error Handling
78 |   describe('Error Handling', () => {
79 |     test('handles API errors gracefully', () => {});
80 |   });
81 | 
82 |   // Tests for Accessibility
83 |   describe('Accessibility', () => {
84 |     test('has proper ARIA attributes', () => {});
85 |     test('is keyboard accessible', () => {});
86 |   });
87 | 
88 |   // Integration Tests
89 |   describe('Integration Tests', () => {
90 |     test('complete user workflow works end-to-end', () => {});
91 |   });
92 | });
93 | ```
94 | 
95 | ## Setup and Cleanup
96 | 
97 | ### Proper beforeEach Setup
98 | Always reset mocks and state between tests:
99 | 
100 | ```typescript
101 | beforeEach(() => {
102 |   jest.clearAllMocks();
103 |   // Reset mocks to default behavior
104 |   localStorageMock.getItem.mockReturnValue(null);
105 |   localStorageMock.setItem.mockImplementation(() => {});
106 |   localStorageMock.removeItem.mockImplementation(() => {});
107 | });
108 | ```
109 | 
110 | ## Testing Patterns
111 | 
112 | ### Test Data-TestIds Not CSS Classes
113 | ```typescript
114 | // Good
115 | expect(screen.getByTestId('dialog')).toBeInTheDocument();
116 | expect(screen.getByTestId('input-email')).toHaveValue('test@example.com');
117 | 
118 | // Avoid relying on CSS classes for testing logic
119 | ```
120 | 
121 | ### Use Descriptive Test Names
122 | ```typescript
123 | // Good
124 | test('saves user preferences to localStorage when save button is clicked', () => {});
125 | test('displays error message when API call fails', () => {});
126 | test('toggles password visibility when eye icon is clicked', () => {});
127 | 
128 | // Avoid vague names
129 | test('it works', () => {});
130 | test('button click', () => {});
131 | ```
132 | 
133 | ### Test User Interactions Properly
134 | ```typescript
135 | // Use proper selectors and interactions
136 | const saveButton = screen.getByRole('button', { name: /save/i });
137 | fireEvent.click(saveButton);
138 | 
139 | // Use waitFor for async operations
140 | await waitFor(() => {
141 |   expect(mockApiCall).toHaveBeenCalledWith(expectedData);
142 | });
143 | ```
144 | 
145 | ### Test Error Scenarios
146 | ```typescript
147 | test('handles localStorage errors when saving', async () => {
148 |   localStorageMock.setItem.mockImplementation(() => {
149 |     throw new Error('localStorage error');
150 |   });
151 |   
152 |   // Trigger the action that should handle the error
153 |   fireEvent.click(screen.getByRole('button', { name: /save/i }));
154 |   
155 |   await waitFor(() => {
156 |     expect(toast.error).toHaveBeenCalledWith('Failed to save data');
157 |   });
158 | });
159 | ```
160 | 
161 | ## Comprehensive Coverage Areas
162 | 
163 | Ensure your tests cover these key areas:
164 | 
165 | 1. **Basic Rendering** - Component renders with different props
166 | 2. **User Interactions** - Clicks, form inputs, keyboard events
167 | 3. **State Management** - Component state updates correctly
168 | 4. **API Integration** - Successful and failed API calls
169 | 5. **Error Handling** - Graceful error handling and user feedback
170 | 6. **Accessibility** - ARIA attributes, keyboard navigation, screen readers
171 | 7. **Responsive Behavior** - CSS classes and responsive functionality
172 | 8. **Integration Workflows** - Complete user journeys from start to finish
173 | 
174 | ## Mock Isolation Best Practices
175 | 
176 | ### Reset Mocks Between Tests
177 | ```typescript
178 | // In beforeEach
179 | localStorageMock.setItem.mockClear();
180 | 
181 | // For specific tests, reset to normal behavior
182 | localStorageMock.setItem.mockImplementation(() => {});
183 | ```
184 | 
185 | ### Mock Components with Proper Props
186 | ```typescript
187 | jest.mock('../../components/ui/input', () => ({
188 |   Input: ({ id, type, value, onChange, placeholder, ...props }: any) => (
189 |     <input
190 |       id={id}
191 |       type={type}
192 |       value={value}
193 |       onChange={onChange}
194 |       placeholder={placeholder}
195 |       data-testid={`input-${id}`}
196 |       {...props}
197 |     />
198 |   ),
199 | }));
200 | ```
201 | 
202 | ## Integration Test Patterns
203 | 
204 | ### Test Complete User Workflows
205 | ```typescript
206 | test('complete workflow: load data, edit, and save', async () => {
207 |   // Setup initial data
208 |   mockApi.getData.mockResolvedValue(initialData);
209 |   
210 |   render(<Component />);
211 |   
212 |   // Wait for data to load
213 |   await waitFor(() => {
214 |     expect(screen.getByDisplayValue('initial value')).toBeInTheDocument();
215 |   });
216 |   
217 |   // User interaction
218 |   fireEvent.change(screen.getByTestId('input-field'), { 
219 |     target: { value: 'updated value' } 
220 |   });
221 |   
222 |   // Save action
223 |   fireEvent.click(screen.getByRole('button', { name: /save/i }));
224 |   
225 |   // Verify results
226 |   await waitFor(() => {
227 |     expect(mockApi.saveData).toHaveBeenCalledWith({
228 |       ...initialData,
229 |       field: 'updated value'
230 |     });
231 |     expect(toast.success).toHaveBeenCalledWith('Data saved successfully');
232 |   });
233 | });
234 | ```
235 | 
236 | ## File Naming and Location
237 | 
238 | - Place test files adjacent to components: `components/__tests__/component-name.test.tsx`
239 | - Use descriptive test file names that match component names
240 | - Include `.test.` or `.spec.` in filename for Jest recognition
241 | - Use same extension as source file (`.tsx` for React components)
242 | 
243 | Reference existing test files like [suggested-prompts.test.tsx](mdc:__tests__/components/suggested-prompts.test.tsx) and [api-key-manager.test.tsx](mdc:__tests__/components/api-key-manager.test.tsx) for comprehensive examples.
```

.cursor/rules/quick-branch-commands.mdc
```
1 | ---
2 | description: 
3 | globs: 
4 | alwaysApply: false
5 | ---
6 | # Quick Branch Commands Reference
7 | 
8 | Quick reference for common feature branch operations in ChatLima.
9 | 
10 | ## 🚀 Create New Feature Branch
11 | ```bash
12 | # One-liner to create and setup a new feature branch
13 | git checkout main && git pull origin main && git checkout -b feature/your-feature-name && git push -u origin feature/your-feature-name
14 | ```
15 | 
16 | ## 📋 Common Branch Types
17 | 
18 | ### Feature Branch
19 | ```bash
20 | git checkout -b feature/new-auth-system
21 | git checkout -b feature/polar-integration
22 | git checkout -b feature/chat-export
23 | ```
24 | 
25 | ### Bug Fix Branch
26 | ```bash
27 | git checkout -b fix/credit-deduction-bug
28 | git checkout -b fix/auth-session-timeout
29 | ```
30 | 
31 | ### Enhancement Branch
32 | ```bash
33 | git checkout -b enhance/mobile-ui
34 | git checkout -b enhance/performance-optimization
35 | ```
36 | 
37 | ## 🔄 Daily Workflow Commands
38 | 
39 | ### Start Working
40 | ```bash
41 | git checkout feature/your-branch
42 | git pull origin main  # sync with main
43 | ```
44 | 
45 | ### Save Progress
46 | ```bash
47 | git add .
48 | git commit -m "feat: implement core functionality"
49 | git push
50 | ```
51 | 
52 | ### End of Day
53 | ```bash
54 | git add .
55 | git commit -m "wip: work in progress on feature"
56 | git push
57 | ```
58 | 
59 | ## 🛠️ Branch Management
60 | 
61 | ### Check Status
62 | ```bash
63 | git status                    # current status
64 | git branch -a                 # all branches
65 | git log main..HEAD --oneline  # commits unique to branch
66 | ```
67 | 
68 | ### Sync with Main
69 | ```bash
70 | git pull origin main          # merge main into current branch
71 | # OR
72 | git rebase main              # rebase current branch onto main
73 | ```
74 | 
75 | ### Clean Up
76 | ```bash
77 | git branch -d feature/old-branch      # delete local branch
78 | git push origin --delete feature/old-branch  # delete remote branch
79 | ```
80 | 
81 | ## 🚀 Vercel Deployment Commands
82 | 
83 | ### ⚠️ CRITICAL SAFETY WARNING
84 | **NEVER run Vercel setup while on feature branches!**
85 | 
86 | ### Safe Testing Workflow
87 | ```bash
88 | # ✅ Setup project (one-time, on main branch)
89 | git checkout main
90 | vercel link  # Setup only, no deployment
91 | 
92 | # ✅ Test feature branch safely
93 | git checkout feature/your-branch
94 | vercel deploy  # Always creates preview deployment
95 | 
96 | # ✅ Production deployment (only when ready)
97 | git checkout main
98 | vercel deploy --prod  # Explicit production deployment
99 | ```
100 | 
101 | ### Emergency Commands
102 | ```bash
103 | # 🚨 If you accidentally deployed feature branch to production
104 | git checkout main
105 | git stash  # if needed
106 | vercel deploy --prod  # Restore safe production
107 | 
108 | # Then create proper preview
109 | git checkout feature/your-branch  
110 | git stash pop  # if needed
111 | vercel deploy  # Preview only
112 | ```
113 | 
114 | ### Deployment Status
115 | ```bash
116 | vercel ls                    # List all deployments
117 | vercel logs --follow        # Monitor deployment logs
118 | vercel inspect [URL]        # Get deployment details
119 | ```
120 | 
121 | ## 📝 Commit Message Templates
122 | 
123 | ```bash
124 | # Feature commits
125 | git commit -m "feat: add user authentication"
126 | git commit -m "feat(api): implement payment endpoint"
127 | 
128 | # Bug fixes
129 | git commit -m "fix: resolve credit deduction issue"
130 | git commit -m "fix(ui): correct mobile navigation"
131 | 
132 | # Enhancements
133 | git commit -m "enhance: improve query performance"
134 | git commit -m "enhance(ux): add loading states"
135 | ```
136 | 
137 | For complete workflow details, see [feature-branch-creation-workflow.mdc](mdc:chatlima/feature-branch-creation-workflow.mdc)
```

.cursor/rules/react-testing-library-patterns.mdc
```
1 | ---
2 | globs: *.test.tsx,*.spec.tsx
3 | description: React Testing Library query patterns and best practices for component testing
4 | ---
5 | 
6 | # React Testing Library Best Practices
7 | 
8 | Follow these patterns when using React Testing Library for component testing to ensure tests are maintainable and user-focused.
9 | 
10 | ## Query Priority and Best Practices
11 | 
12 | ### Use Queries in Order of Priority
13 | 
14 | 1. **Accessible Queries (Preferred)**
15 | ```typescript
16 | // By role (most preferred)
17 | screen.getByRole('button', { name: /save/i })
18 | screen.getByRole('textbox', { name: /email/i })
19 | screen.getByRole('dialog')
20 | 
21 | // By label text
22 | screen.getByLabelText(/password/i)
23 | 
24 | // By placeholder text
25 | screen.getByPlaceholderText(/enter your email/i)
26 | 
27 | // By display text
28 | screen.getByText(/welcome back/i)
29 | ```
30 | 
31 | 2. **Semantic Queries**
32 | ```typescript
33 | // By display value (for form elements)
34 | screen.getByDisplayValue('current value')
35 | 
36 | // By alt text (for images)
37 | screen.getByAltText(/profile picture/i)
38 | ```
39 | 
40 | 3. **Test ID Queries (Last Resort)**
41 | ```typescript
42 | // Only when other queries aren't practical
43 | screen.getByTestId('complex-component')
44 | screen.getByTestId('input-email') // When input doesn't have proper label
45 | ```
46 | 
47 | ## Query Variants
48 | 
49 | ### Use Appropriate Query Variants
50 | 
51 | ```typescript
52 | // get* - Element must exist (throws if not found)
53 | screen.getByRole('button')
54 | 
55 | // query* - Element may not exist (returns null if not found)
56 | screen.queryByRole('button') 
57 | 
58 | // find* - Async element that will appear (returns Promise)
59 | screen.findByRole('button')
60 | 
61 | // *All variants for multiple elements
62 | screen.getAllByRole('listitem')
63 | screen.queryAllByRole('listitem')
64 | screen.findAllByRole('listitem')
65 | ```
66 | 
67 | ## Form Testing Patterns
68 | 
69 | ### Test Forms Like Users Interact With Them
70 | 
71 | ```typescript
72 | test('submits form with valid data', async () => {
73 |   render(<LoginForm onSubmit={mockSubmit} />);
74 |   
75 |   // Find form elements by their labels (accessible)
76 |   const emailInput = screen.getByLabelText(/email/i);
77 |   const passwordInput = screen.getByLabelText(/password/i);
78 |   const submitButton = screen.getByRole('button', { name: /sign in/i });
79 |   
80 |   // Interact like a user would
81 |   fireEvent.change(emailInput, { target: { value: 'user@example.com' } });
82 |   fireEvent.change(passwordInput, { target: { value: 'password123' } });
83 |   fireEvent.click(submitButton);
84 |   
85 |   // Verify the expected outcome
86 |   await waitFor(() => {
87 |     expect(mockSubmit).toHaveBeenCalledWith({
88 |       email: 'user@example.com',
89 |       password: 'password123'
90 |     });
91 |   });
92 | });
93 | ```
94 | 
95 | ## Async Testing Patterns
96 | 
97 | ### Handle Async Operations Properly
98 | 
99 | ```typescript
100 | // Use waitFor for state changes
101 | await waitFor(() => {
102 |   expect(screen.getByText(/success message/i)).toBeInTheDocument();
103 | });
104 | 
105 | // Use findBy for elements that will appear
106 | const errorMessage = await screen.findByText(/error occurred/i);
107 | expect(errorMessage).toBeInTheDocument();
108 | 
109 | // Use waitForElementToBeRemoved for elements that disappear
110 | await waitForElementToBeRemoved(screen.queryByText(/loading/i));
111 | ```
112 | 
113 | ## Event Testing
114 | 
115 | ### Use Proper Event Patterns
116 | 
117 | ```typescript
118 | // Simple click events
119 | fireEvent.click(screen.getByRole('button'));
120 | 
121 | // Form input changes
122 | fireEvent.change(screen.getByLabelText(/email/i), { 
123 |   target: { value: 'new@example.com' } 
124 | });
125 | 
126 | // Keyboard events
127 | fireEvent.keyDown(screen.getByRole('textbox'), { 
128 |   key: 'Enter', 
129 |   code: 'Enter' 
130 | });
131 | 
132 | // Focus events
133 | fireEvent.focus(screen.getByLabelText(/password/i));
134 | fireEvent.blur(screen.getByLabelText(/password/i));
135 | ```
136 | 
137 | ## Accessibility Testing
138 | 
139 | ### Test Accessibility Features
140 | 
141 | ```typescript
142 | test('has proper accessibility attributes', () => {
143 |   render(<Modal open={true} />);
144 |   
145 |   const modal = screen.getByRole('dialog');
146 |   expect(modal).toHaveAttribute('aria-labelledby');
147 |   expect(modal).toHaveAttribute('aria-describedby');
148 |   
149 |   const closeButton = screen.getByRole('button', { name: /close/i });
150 |   expect(closeButton).toHaveAttribute('aria-label', 'Close dialog');
151 | });
152 | 
153 | test('supports keyboard navigation', () => {
154 |   render(<Dropdown />);
155 |   
156 |   const trigger = screen.getByRole('button', { name: /options/i });
157 |   
158 |   // Test keyboard activation
159 |   fireEvent.keyDown(trigger, { key: 'Enter' });
160 |   expect(screen.getByRole('menu')).toBeInTheDocument();
161 |   
162 |   // Test escape key
163 |   fireEvent.keyDown(trigger, { key: 'Escape' });
164 |   expect(screen.queryByRole('menu')).not.toBeInTheDocument();
165 | });
166 | ```
167 | 
168 | ## Component State Testing
169 | 
170 | ### Test Component State Changes
171 | 
172 | ```typescript
173 | test('toggles visibility state correctly', () => {
174 |   render(<PasswordInput />);
175 |   
176 |   const input = screen.getByLabelText(/password/i);
177 |   const toggleButton = screen.getByRole('button', { name: /show password/i });
178 |   
179 |   // Initial state
180 |   expect(input).toHaveAttribute('type', 'password');
181 |   
182 |   // After toggle
183 |   fireEvent.click(toggleButton);
184 |   expect(input).toHaveAttribute('type', 'text');
185 |   expect(toggleButton).toHaveAccessibleName(/hide password/i);
186 |   
187 |   // Toggle back
188 |   fireEvent.click(toggleButton);
189 |   expect(input).toHaveAttribute('type', 'password');
190 |   expect(toggleButton).toHaveAccessibleName(/show password/i);
191 | });
192 | ```
193 | 
194 | ## Error State Testing  
195 | 
196 | ### Test Error Handling and Display
197 | 
198 | ```typescript
199 | test('displays validation errors', async () => {
200 |   render(<ContactForm />);
201 |   
202 |   const emailInput = screen.getByLabelText(/email/i);
203 |   const submitButton = screen.getByRole('button', { name: /submit/i });
204 |   
205 |   // Submit with invalid email
206 |   fireEvent.change(emailInput, { target: { value: 'invalid-email' } });
207 |   fireEvent.click(submitButton);
208 |   
209 |   // Check for error message
210 |   await waitFor(() => {
211 |     expect(screen.getByText(/please enter a valid email/i)).toBeInTheDocument();
212 |   });
213 |   
214 |   // Error should be associated with input
215 |   expect(emailInput).toHaveAttribute('aria-invalid', 'true');
216 |   expect(emailInput).toHaveAttribute('aria-describedby');
217 | });
218 | ```
219 | 
220 | ## Mock Component Integration
221 | 
222 | ### Mock Components While Preserving Testability
223 | 
224 | ```typescript
225 | // Mock complex child components but preserve essential props
226 | jest.mock('../../components/ui/select', () => ({
227 |   Select: ({ children, onValueChange, defaultValue }: any) => (
228 |     <select 
229 |       data-testid="select-mock" 
230 |       onChange={(e) => onValueChange?.(e.target.value)}
231 |       defaultValue={defaultValue}
232 |     >
233 |       {children}
234 |     </select>
235 |   ),
236 |   SelectContent: ({ children }: any) => <div>{children}</div>,
237 |   SelectItem: ({ children, value }: any) => (
238 |     <option value={value}>{children}</option>
239 |   ),
240 | }));
241 | ```
242 | 
243 | ## Custom Render Utilities
244 | 
245 | ### Create Reusable Test Utilities
246 | 
247 | ```typescript
248 | // Custom render with providers
249 | const renderWithProviders = (ui: React.ReactElement, options = {}) => {
250 |   const Wrapper = ({ children }: { children: React.ReactNode }) => (
251 |     <ThemeProvider>
252 |       <AuthProvider>
253 |         {children}
254 |       </AuthProvider>
255 |     </ThemeProvider>
256 |   );
257 |   
258 |   return render(ui, { wrapper: Wrapper, ...options });
259 | };
260 | 
261 | // Use in tests
262 | test('renders with theme context', () => {
263 |   renderWithProviders(<ThemedComponent />);
264 |   expect(screen.getByText(/themed content/i)).toBeInTheDocument();
265 | });
266 | ```
267 | 
268 | ## Common Anti-Patterns to Avoid
269 | 
270 | ### Don't Test Implementation Details
271 | ```typescript
272 | // Bad - testing internal state
273 | expect(component.instance().state.isVisible).toBe(true);
274 | 
275 | // Good - testing user-visible behavior  
276 | expect(screen.getByText(/visible content/i)).toBeInTheDocument();
277 | ```
278 | 
279 | ### Don't Query by CSS Classes or Internal IDs
280 | ```typescript
281 | // Bad
282 | screen.getByClassName('btn-primary')
283 | screen.getBySelector('#internal-id')
284 | 
285 | // Good
286 | screen.getByRole('button', { name: /primary action/i })
287 | ```
288 | 
289 | ### Don't Use Container Queries Unless Necessary
290 | ```typescript
291 | // Bad - when better queries exist
292 | container.querySelector('.error-message')
293 | 
294 | // Good - semantic queries
295 | screen.getByText(/error message/i)
296 | ```
297 | 
298 | Reference the comprehensive test examples in [api-key-manager.test.tsx](mdc:__tests__/components/api-key-manager.test.tsx) for real-world applications of these patterns.
```

.cursor/rules/test-coverage-organization.mdc
```
1 | ---
2 | globs: *.test.ts,*.test.tsx,*.spec.ts,*.spec.tsx
3 | description: Test coverage strategies and organizational patterns for comprehensive testing
4 | ---
5 | 
6 | # Test Coverage and Organization
7 | 
8 | Ensure comprehensive test coverage by following these organizational patterns and coverage strategies.
9 | 
10 | ## Test Coverage Categories
11 | 
12 | ### Essential Coverage Areas (Minimum Requirements)
13 | 
14 | Every component should have tests for these core areas:
15 | 
16 | 1. **Basic Rendering** - Component renders without crashing
17 | 2. **Props Handling** - All props work as expected  
18 | 3. **User Interactions** - All interactive elements function correctly
19 | 4. **Error States** - Component handles errors gracefully
20 | 5. **Accessibility** - Component is accessible to all users
21 | 
22 | ### Advanced Coverage Areas (For Complex Components)
23 | 
24 | Complex components should additionally test:
25 | 
26 | 6. **State Management** - Internal state updates correctly
27 | 7. **API Integration** - External API calls and responses
28 | 8. **Performance** - Component performance characteristics
29 | 9. **Integration Workflows** - Complete user journeys
30 | 10. **Edge Cases** - Boundary conditions and unusual inputs
31 | 
32 | ## Test Organization Patterns
33 | 
34 | ### Hierarchical Describe Structure
35 | 
36 | ```typescript
37 | describe('ComponentName', () => {
38 |   // Setup shared across all tests
39 |   const mockProps = { /* common props */ };
40 |   
41 |   describe('Basic Rendering', () => {
42 |     test('renders with default props', () => {});
43 |     test('renders with custom props', () => {});
44 |     test('does not render when hidden', () => {});
45 |   });
46 |   
47 |   describe('User Interactions', () => {
48 |     test('handles button clicks', () => {});
49 |     test('handles form submissions', () => {});
50 |     test('handles keyboard navigation', () => {});
51 |   });
52 |   
53 |   describe('State Management', () => {
54 |     test('updates state correctly', () => {});
55 |     test('resets state when needed', () => {});
56 |   });
57 |   
58 |   describe('API Integration', () => {
59 |     test('handles successful API calls', () => {});
60 |     test('handles API errors', () => {});
61 |     test('shows loading states', () => {});
62 |   });
63 |   
64 |   describe('Error Handling', () => {
65 |     test('displays error messages', () => {});
66 |     test('recovers from errors', () => {});
67 |     test('logs errors appropriately', () => {});
68 |   });
69 |   
70 |   describe('Accessibility', () => {
71 |     test('has proper ARIA attributes', () => {});
72 |     test('supports keyboard navigation', () => {});
73 |     test('works with screen readers', () => {});
74 |   });
75 |   
76 |   describe('Performance', () => {
77 |     test('renders efficiently', () => {});
78 |     test('handles large datasets', () => {});
79 |   });
80 |   
81 |   describe('Integration Tests', () => {
82 |     test('complete user workflow', () => {});
83 |     test('cross-component interactions', () => {});
84 |   });
85 | });
86 | ```
87 | 
88 | ## Test Naming Conventions
89 | 
90 | ### Descriptive Test Names
91 | 
92 | Follow the pattern: "should [expected behavior] when [condition]"
93 | 
94 | ```typescript
95 | // Good - Descriptive and specific
96 | test('should display success message when form submission succeeds', () => {});
97 | test('should disable submit button when form is invalid', () => {});
98 | test('should clear form fields when reset button is clicked', () => {});
99 | test('should show loading spinner while API request is pending', () => {});
100 | 
101 | // Bad - Vague or implementation-focused
102 | test('it works', () => {});
103 | test('button click', () => {});
104 | test('state update', () => {});
105 | test('renders correctly', () => {});
106 | ```
107 | 
108 | ## Coverage Metrics and Goals
109 | 
110 | ### Aim for These Coverage Targets
111 | 
112 | - **Statements**: 90%+ (Every line of code executed)
113 | - **Branches**: 85%+ (All conditional paths tested)
114 | - **Functions**: 95%+ (All functions called)
115 | - **Lines**: 90%+ (All lines covered)
116 | 
117 | ### Focus on Business Logic Coverage
118 | 
119 | ```typescript
120 | // Ensure all business logic paths are tested
121 | test('calculates discount correctly for premium users', () => {
122 |   // Test the business rule implementation
123 | });
124 | 
125 | test('validates email format according to business rules', () => {
126 |   // Test each validation rule
127 | });
128 | 
129 | test('handles payment processing errors appropriately', () => {
130 |   // Test error handling business logic
131 | });
132 | ```
133 | 
134 | ## Test Data Organization
135 | 
136 | ### Create Reusable Test Data
137 | 
138 | ```typescript
139 | // Test data constants
140 | const TEST_DATA = {
141 |   validUser: {
142 |     id: '1',
143 |     email: 'test@example.com',
144 |     name: 'Test User'
145 |   },
146 |   invalidUser: {
147 |     id: '',
148 |     email: 'invalid-email',
149 |     name: ''
150 |   },
151 |   apiResponse: {
152 |     success: { status: 200, data: { message: 'Success' } },
153 |     error: { status: 500, data: { error: 'Server Error' } }
154 |   }
155 | };
156 | 
157 | // Factory functions for dynamic test data
158 | const createMockUser = (overrides = {}) => ({
159 |   ...TEST_DATA.validUser,
160 |   ...overrides
161 | });
162 | 
163 | const createMockApiResponse = (status: number, data: any) => ({
164 |   status,
165 |   data,
166 |   headers: {},
167 |   config: {}
168 | });
169 | ```
170 | 
171 | ## Test Lifecycle Management
172 | 
173 | ### Proper Setup and Teardown
174 | 
175 | ```typescript
176 | describe('ComponentName', () => {
177 |   let mockApiClient: jest.MockedFunction<any>;
178 |   let mockLocalStorage: jest.MockedFunction<any>;
179 |   
180 |   beforeAll(() => {
181 |     // One-time setup for all tests
182 |     jest.setTimeout(10000);
183 |   });
184 |   
185 |   beforeEach(() => {
186 |     // Reset before each test
187 |     jest.clearAllMocks();
188 |     mockApiClient = jest.fn();
189 |     mockLocalStorage = {
190 |       getItem: jest.fn(),
191 |       setItem: jest.fn(),
192 |       removeItem: jest.fn()
193 |     };
194 |   });
195 |   
196 |   afterEach(() => {
197 |     // Cleanup after each test
198 |     cleanup();
199 |     jest.restoreAllMocks();
200 |   });
201 |   
202 |   afterAll(() => {
203 |     // Final cleanup
204 |     jest.clearAllTimers();
205 |   });
206 | });
207 | ```
208 | 
209 | ## Integration Test Strategies
210 | 
211 | ### Test User Journeys End-to-End
212 | 
213 | ```typescript
214 | describe('Complete User Workflows', () => {
215 |   test('user can register, login, and update profile', async () => {
216 |     // 1. Registration flow
217 |     render(<RegistrationForm />);
218 |     fireEvent.change(screen.getByLabelText(/email/i), { 
219 |       target: { value: 'user@example.com' } 
220 |     });
221 |     fireEvent.change(screen.getByLabelText(/password/i), { 
222 |       target: { value: 'password123' } 
223 |     });
224 |     fireEvent.click(screen.getByRole('button', { name: /register/i }));
225 |     
226 |     await waitFor(() => {
227 |       expect(screen.getByText(/registration successful/i)).toBeInTheDocument();
228 |     });
229 |     
230 |     // 2. Login flow
231 |     fireEvent.click(screen.getByRole('link', { name: /login/i }));
232 |     // ... login steps
233 |     
234 |     // 3. Profile update flow  
235 |     fireEvent.click(screen.getByRole('link', { name: /profile/i }));
236 |     // ... profile update steps
237 |     
238 |     // Verify complete workflow
239 |     expect(mockApiClient).toHaveBeenCalledTimes(3);
240 |     expect(localStorage.setItem).toHaveBeenCalledWith('user-token', expect.any(String));
241 |   });
242 | });
243 | ```
244 | 
245 | ## Edge Case Testing  
246 | 
247 | ### Test Boundary Conditions
248 | 
249 | ```typescript
250 | describe('Edge Cases', () => {
251 |   test('handles empty data gracefully', () => {
252 |     render(<DataTable data={[]} />);
253 |     expect(screen.getByText(/no data available/i)).toBeInTheDocument();
254 |   });
255 |   
256 |   test('handles very large datasets', () => {
257 |     const largeDataset = Array(10000).fill(null).map((_, i) => ({ id: i }));
258 |     render(<DataTable data={largeDataset} />);
259 |     expect(screen.getByText(/showing 1-50 of 10000/i)).toBeInTheDocument();
260 |   });
261 |   
262 |   test('handles network timeout errors', async () => {
263 |     mockApiClient.mockRejectedValue(new Error('Network timeout'));
264 |     render(<ApiDataComponent />);
265 |     
266 |     await waitFor(() => {
267 |       expect(screen.getByText(/connection timeout/i)).toBeInTheDocument();
268 |     });
269 |   });
270 | });
271 | ```
272 | 
273 | ## Performance Testing
274 | 
275 | ### Test Performance Characteristics
276 | 
277 | ```typescript
278 | describe('Performance', () => {
279 |   test('renders large lists efficiently', () => {
280 |     const startTime = performance.now();
281 |     const largeList = Array(1000).fill(null).map((_, i) => ({ id: i, name: `Item ${i}` }));
282 |     
283 |     render(<VirtualizedList items={largeList} />);
284 |     
285 |     const endTime = performance.now();
286 |     expect(endTime - startTime).toBeLessThan(100); // Should render in under 100ms
287 |   });
288 |   
289 |   test('handles rapid state updates', () => {
290 |     render(<SearchInput />);
291 |     const input = screen.getByRole('textbox');
292 |     
293 |     // Simulate rapid typing
294 |     for (let i = 0; i < 10; i++) {
295 |       fireEvent.change(input, { target: { value: `search${i}` } });
296 |     }
297 |     
298 |     // Should handle updates without breaking
299 |     expect(input).toHaveValue('search9');
300 |   });
301 | });
302 | ```
303 | 
304 | ## Test File Organization
305 | 
306 | ### File Structure Best Practices
307 | 
308 | ```
309 | components/
310 | ├── Button/
311 | │   ├── Button.tsx
312 | │   ├── __tests__/
313 | │   │   ├── Button.test.tsx          # Unit tests
314 | │   │   ├── Button.integration.test.tsx # Integration tests
315 | │   │   └── Button.accessibility.test.tsx # A11y tests
316 | │   └── index.ts
317 | ```
318 | 
319 | ### Test File Naming Conventions
320 | 
321 | - `Component.test.tsx` - Standard unit tests
322 | - `Component.integration.test.tsx` - Integration tests
323 | - `Component.accessibility.test.tsx` - Accessibility-focused tests
324 | - `Component.performance.test.tsx` - Performance tests
325 | - `utils.test.ts` - Utility function tests
326 | 
327 | Use these patterns to ensure comprehensive, well-organized test coverage that provides confidence in your codebase. Reference [api-key-manager.test.tsx](mdc:__tests__/components/api-key-manager.test.tsx) for a complete example implementing these patterns.
```

.github/workflows/neon_workflow.yml
```
1 | name: Create/Delete Branch for Pull Request
2 | 
3 | on:
4 |   pull_request:
5 |     types:
6 |       - opened
7 |       - reopened
8 |       - synchronize
9 |       - closed
10 | 
11 | concurrency:
12 |   group: ${{ github.workflow }}-${{ github.ref }}
13 | 
14 | jobs:
15 |   setup:
16 |     name: Setup
17 |     outputs:
18 |       branch: ${{ steps.branch_name.outputs.current_branch }}
19 |     runs-on: ubuntu-latest
20 |     steps:
21 |       - name: Get branch name
22 |         id: branch_name
23 |         uses: tj-actions/branch-names@v8
24 | 
25 |   create_neon_branch:
26 |     name: Create Neon Branch
27 |     needs: setup
28 |     if: |
29 |       github.event_name == 'pull_request' && (
30 |       github.event.action == 'synchronize'
31 |       || github.event.action == 'opened'
32 |       || github.event.action == 'reopened')
33 |     runs-on: ubuntu-latest
34 |     permissions:
35 |       contents: read
36 |       pull-requests: write
37 |     steps:
38 |       - name: Checkout code
39 |         uses: actions/checkout@v4
40 |         
41 |       - name: Setup Node.js
42 |         uses: actions/setup-node@v4
43 |         with:
44 |           node-version: '20'
45 |           
46 |       - name: Setup pnpm
47 |         uses: pnpm/action-setup@v2
48 |         with:
49 |           version: 8
50 |           
51 |       - name: Install dependencies
52 |         run: pnpm install --no-frozen-lockfile
53 |         
54 |       - name: Create Neon Branch
55 |         id: create_neon_branch
56 |         uses: neondatabase/create-branch-action@v5
57 |         with:
58 |           project_id: ${{ vars.NEON_PROJECT_ID }}
59 |           branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
60 |           api_key: ${{ secrets.NEON_API_KEY }}
61 | 
62 |       - name: Push Schema Changes
63 |         run: pnpm db:push
64 |         env:
65 |           DATABASE_URL: "${{ steps.create_neon_branch.outputs.db_url_with_pooler }}"
66 | 
67 |       - name: Post Schema Diff Comment to PR
68 |         uses: neondatabase/schema-diff-action@v1
69 |         with:
70 |           project_id: ${{ vars.NEON_PROJECT_ID }}
71 |           compare_branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
72 |           api_key: ${{ secrets.NEON_API_KEY }}
73 | 
74 |   delete_neon_branch:
75 |     name: Delete Neon Branch
76 |     needs: setup
77 |     if: github.event_name == 'pull_request' && github.event.action == 'closed'
78 |     runs-on: ubuntu-latest
79 |     steps:
80 |       - name: Delete Neon Branch
81 |         uses: neondatabase/delete-branch-action@v3
82 |         with:
83 |           project_id: ${{ vars.NEON_PROJECT_ID }}
84 |           branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
85 |           api_key: ${{ secrets.NEON_API_KEY }}
```

__tests__/components/api-key-manager.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { ApiKeyManager } from '../../components/api-key-manager';
4 | 
5 | // Mock localStorage
6 | const localStorageMock = {
7 |   getItem: jest.fn(),
8 |   setItem: jest.fn(),
9 |   removeItem: jest.fn(),
10 |   clear: jest.fn(),
11 | };
12 | Object.defineProperty(window, 'localStorage', {
13 |   value: localStorageMock
14 | });
15 | 
16 | // Mock toast
17 | jest.mock('sonner', () => ({
18 |   toast: {
19 |     success: jest.fn(),
20 |     error: jest.fn(),
21 |   },
22 | }));
23 | 
24 | // Mock UI components
25 | jest.mock('../../components/ui/dialog', () => ({
26 |   Dialog: ({ children, open }: any) => open ? <div data-testid="dialog">{children}</div> : null,
27 |   DialogContent: ({ children, className }: any) => <div className={className} data-testid="dialog-content">{children}</div>,
28 |   DialogDescription: ({ children, className }: any) => <p className={className} data-testid="dialog-description">{children}</p>,
29 |   DialogFooter: ({ children, className }: any) => <div className={className} data-testid="dialog-footer">{children}</div>,
30 |   DialogHeader: ({ children, className }: any) => <div className={className} data-testid="dialog-header">{children}</div>,
31 |   DialogTitle: ({ children, className }: any) => <h2 className={className} data-testid="dialog-title">{children}</h2>,
32 | }));
33 | 
34 | jest.mock('../../components/ui/button', () => ({
35 |   Button: ({ children, onClick, variant, className, ...props }: any) => (
36 |     <button 
37 |       onClick={onClick} 
38 |       className={className} 
39 |       data-variant={variant}
40 |       data-testid={`button-${variant || 'default'}`}
41 |       {...props}
42 |     >
43 |       {children}
44 |     </button>
45 |   ),
46 | }));
47 | 
48 | jest.mock('../../components/ui/input', () => ({
49 |   Input: ({ id, type, value, onChange, placeholder, className, ...props }: any) => (
50 |     <input
51 |       id={id}
52 |       type={type}
53 |       value={value}
54 |       onChange={onChange}
55 |       placeholder={placeholder}
56 |       className={className}
57 |       data-testid={`input-${id}`}
58 |       {...props}
59 |     />
60 |   ),
61 | }));
62 | 
63 | jest.mock('../../components/ui/label', () => ({
64 |   Label: ({ children, htmlFor, className }: any) => (
65 |     <label htmlFor={htmlFor} className={className} data-testid={`label-${htmlFor}`}>
66 |       {children}
67 |     </label>
68 |   ),
69 | }));
70 | 
71 | // Mock Lucide icons
72 | jest.mock('lucide-react', () => ({
73 |   Key: ({ className }: any) => <div className={className} data-testid="key-icon" />,
74 |   Eye: ({ className }: any) => <div className={className} data-testid="eye-icon" />,
75 |   EyeOff: ({ className }: any) => <div className={className} data-testid="eyeoff-icon" />,
76 | }));
77 | 
78 | import { toast } from 'sonner';
79 | 
80 | describe('ApiKeyManager Component', () => {
81 |   const mockOnOpenChange = jest.fn();
82 | 
83 |   beforeEach(() => {
84 |     jest.clearAllMocks();
85 |     // Reset all localStorage mocks to default behavior
86 |     localStorageMock.getItem.mockReturnValue(null);
87 |     localStorageMock.setItem.mockImplementation(() => {});
88 |     localStorageMock.removeItem.mockImplementation(() => {});
89 |     localStorageMock.clear.mockImplementation(() => {});
90 |   });
91 | 
92 |   // Tests for Dialog Rendering and Props
93 |   describe('Dialog Rendering and Props', () => {
94 |     test('renders dialog when open is true', () => {
95 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
96 |       
97 |       expect(screen.getByTestId('dialog')).toBeInTheDocument();
98 |       expect(screen.getByTestId('dialog-title')).toHaveTextContent('API Key Settings');
99 |     });
100 | 
101 |     test('does not render dialog when open is false', () => {
102 |       render(<ApiKeyManager open={false} onOpenChange={mockOnOpenChange} />);
103 |       
104 |       expect(screen.queryByTestId('dialog')).not.toBeInTheDocument();
105 |     });
106 | 
107 |     test('renders dialog description correctly', () => {
108 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
109 |       
110 |       const description = screen.getByTestId('dialog-description');
111 |       expect(description).toHaveTextContent(
112 |         "Enter your own API keys for different AI providers. Keys are stored securely in your browser's local storage."
113 |       );
114 |     });
115 | 
116 |     test('renders key icon in header', () => {
117 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
118 |       
119 |       expect(screen.getByTestId('key-icon')).toBeInTheDocument();
120 |     });
121 |   });
122 | 
123 |   // Tests for API Key Configuration
124 |   describe('API Key Configuration', () => {
125 |     test('renders all API key inputs with correct labels and placeholders', () => {
126 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
127 |       
128 |       // Check OpenAI
129 |       expect(screen.getByTestId('label-openai')).toHaveTextContent('OpenAI API Key');
130 |       expect(screen.getByTestId('input-openai')).toHaveAttribute('placeholder', 'sk-...');
131 |       
132 |       // Check Anthropic
133 |       expect(screen.getByTestId('label-anthropic')).toHaveTextContent('Anthropic API Key');
134 |       expect(screen.getByTestId('input-anthropic')).toHaveAttribute('placeholder', 'sk-ant-...');
135 |       
136 |       // Check Groq
137 |       expect(screen.getByTestId('label-groq')).toHaveTextContent('Groq API Key');
138 |       expect(screen.getByTestId('input-groq')).toHaveAttribute('placeholder', 'gsk_...');
139 |       
140 |       // Check XAI
141 |       expect(screen.getByTestId('label-xai')).toHaveTextContent('XAI API Key');
142 |       expect(screen.getByTestId('input-xai')).toHaveAttribute('placeholder', 'xai-...');
143 |       
144 |       // Check Openrouter
145 |       expect(screen.getByTestId('label-openrouter')).toHaveTextContent('Openrouter API Key');
146 |       expect(screen.getByTestId('input-openrouter')).toHaveAttribute('placeholder', 'sk-or-...');
147 |       
148 |       // Check Requesty
149 |       expect(screen.getByTestId('label-requesty')).toHaveTextContent('Requesty API Key');
150 |       expect(screen.getByTestId('input-requesty')).toHaveAttribute('placeholder', 'req-...');
151 |     });
152 | 
153 |     test('inputs are initially of type password', () => {
154 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
155 |       
156 |       expect(screen.getByTestId('input-openai')).toHaveAttribute('type', 'password');
157 |       expect(screen.getByTestId('input-anthropic')).toHaveAttribute('type', 'password');
158 |       expect(screen.getByTestId('input-groq')).toHaveAttribute('type', 'password');
159 |       expect(screen.getByTestId('input-xai')).toHaveAttribute('type', 'password');
160 |       expect(screen.getByTestId('input-openrouter')).toHaveAttribute('type', 'password');
161 |       expect(screen.getByTestId('input-requesty')).toHaveAttribute('type', 'password');
162 |     });
163 | 
164 |     test('renders visibility toggle buttons for each input', () => {
165 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
166 |       
167 |       // Should render Eye icons by default (password hidden, click to show)
168 |       const eyeIcons = screen.getAllByTestId('eye-icon');
169 |       expect(eyeIcons).toHaveLength(6); // One for each API key
170 |     });
171 |   });
172 | 
173 |   // Tests for localStorage Integration
174 |   describe('localStorage Integration', () => {
175 |     test('loads existing API keys from localStorage on mount', async () => {
176 |       localStorageMock.getItem.mockImplementation((key) => {
177 |         switch (key) {
178 |           case 'OPENAI_API_KEY': return 'sk-test-openai';
179 |           case 'ANTHROPIC_API_KEY': return 'sk-ant-test';
180 |           default: return null;
181 |         }
182 |       });
183 | 
184 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
185 | 
186 |       await waitFor(() => {
187 |         expect(screen.getByTestId('input-openai')).toHaveValue('sk-test-openai');
188 |         expect(screen.getByTestId('input-anthropic')).toHaveValue('sk-ant-test');
189 |         expect(screen.getByTestId('input-groq')).toHaveValue('');
190 |       });
191 |     });
192 | 
193 |     test('calls localStorage.getItem for all API key storage keys', () => {
194 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
195 | 
196 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('OPENAI_API_KEY');
197 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('ANTHROPIC_API_KEY');
198 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('GROQ_API_KEY');
199 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('XAI_API_KEY');
200 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('OPENROUTER_API_KEY');
201 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('REQUESTY_API_KEY');
202 |     });
203 |   });
204 | 
205 |   // Tests for User Interactions
206 |   describe('User Interactions', () => {
207 |     test('updates input value when user types', () => {
208 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
209 |       
210 |       const openaiInput = screen.getByTestId('input-openai');
211 |       fireEvent.change(openaiInput, { target: { value: 'sk-new-key' } });
212 |       
213 |       expect(openaiInput).toHaveValue('sk-new-key');
214 |     });
215 | 
216 |     test('toggles password visibility when eye button is clicked', () => {
217 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
218 |       
219 |       const openaiInput = screen.getByTestId('input-openai');
220 |       const toggleButtons = screen.getAllByRole('button');
221 |       const eyeToggleButton = toggleButtons.find(button => 
222 |         button.querySelector('[data-testid="eye-icon"]')
223 |       );
224 |       
225 |       expect(openaiInput).toHaveAttribute('type', 'password');
226 |       expect(screen.getAllByTestId('eye-icon')).toHaveLength(6);
227 |       
228 |       fireEvent.click(eyeToggleButton!);
229 |       
230 |       expect(openaiInput).toHaveAttribute('type', 'text');
231 |       expect(screen.getAllByTestId('eyeoff-icon')).toHaveLength(1);
232 |       expect(screen.getAllByTestId('eye-icon')).toHaveLength(5);
233 |     });
234 | 
235 |     test('saves API keys to localStorage when save button is clicked', async () => {
236 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
237 |       
238 |       // Input some keys
239 |       fireEvent.change(screen.getByTestId('input-openai'), { target: { value: 'sk-test-key' } });
240 |       fireEvent.change(screen.getByTestId('input-anthropic'), { target: { value: 'sk-ant-test' } });
241 |       
242 |       // Click save
243 |       const saveButton = screen.getByText('Save Keys');
244 |       fireEvent.click(saveButton);
245 |       
246 |       await waitFor(() => {
247 |         expect(localStorageMock.setItem).toHaveBeenCalledWith('OPENAI_API_KEY', 'sk-test-key');
248 |         expect(localStorageMock.setItem).toHaveBeenCalledWith('ANTHROPIC_API_KEY', 'sk-ant-test');
249 |         expect(toast.success).toHaveBeenCalledWith('API keys saved successfully');
250 |         expect(mockOnOpenChange).toHaveBeenCalledWith(false);
251 |       });
252 |     });
253 | 
254 |     test('removes empty API keys from localStorage when saving', async () => {
255 |       localStorageMock.getItem.mockReturnValue('existing-key');
256 |       
257 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
258 |       
259 |       // Clear the input
260 |       fireEvent.change(screen.getByTestId('input-openai'), { target: { value: '' } });
261 |       
262 |       // Click save
263 |       const saveButton = screen.getByText('Save Keys');
264 |       fireEvent.click(saveButton);
265 |       
266 |       await waitFor(() => {
267 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('OPENAI_API_KEY');
268 |       });
269 |     });
270 | 
271 |     test('trims whitespace when saving API keys', async () => {
272 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
273 |       
274 |       fireEvent.change(screen.getByTestId('input-openai'), { target: { value: '  sk-test-key  ' } });
275 |       
276 |       const saveButton = screen.getByText('Save Keys');
277 |       fireEvent.click(saveButton);
278 |       
279 |       await waitFor(() => {
280 |         expect(localStorageMock.setItem).toHaveBeenCalledWith('OPENAI_API_KEY', 'sk-test-key');
281 |       });
282 |     });
283 | 
284 |     test('clears all API keys when clear button is clicked', async () => {
285 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
286 |       
287 |       const clearButton = screen.getByText('Clear All Keys');
288 |       fireEvent.click(clearButton);
289 |       
290 |       await waitFor(() => {
291 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('OPENAI_API_KEY');
292 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('ANTHROPIC_API_KEY');
293 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('GROQ_API_KEY');
294 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('XAI_API_KEY');
295 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('OPENROUTER_API_KEY');
296 |         expect(localStorageMock.removeItem).toHaveBeenCalledWith('REQUESTY_API_KEY');
297 |         expect(toast.success).toHaveBeenCalledWith('All API keys cleared');
298 |       });
299 |     });
300 | 
301 |     test('closes dialog when cancel button is clicked', () => {
302 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
303 |       
304 |       const cancelButton = screen.getByText('Cancel');
305 |       fireEvent.click(cancelButton);
306 |       
307 |       expect(mockOnOpenChange).toHaveBeenCalledWith(false);
308 |     });
309 |   });
310 | 
311 |   // Tests for Error Handling
312 |   describe('Error Handling', () => {
313 |     test('handles localStorage errors when saving', async () => {
314 |       localStorageMock.setItem.mockImplementation(() => {
315 |         throw new Error('localStorage error');
316 |       });
317 |       
318 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
319 |       
320 |       fireEvent.change(screen.getByTestId('input-openai'), { target: { value: 'sk-test' } });
321 |       
322 |       const saveButton = screen.getByText('Save Keys');
323 |       fireEvent.click(saveButton);
324 |       
325 |       await waitFor(() => {
326 |         expect(toast.error).toHaveBeenCalledWith('Failed to save API keys');
327 |       });
328 |     });
329 | 
330 |     test('handles localStorage errors when clearing', async () => {
331 |       localStorageMock.removeItem.mockImplementation(() => {
332 |         throw new Error('localStorage error');
333 |       });
334 |       
335 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
336 |       
337 |       const clearButton = screen.getByText('Clear All Keys');
338 |       fireEvent.click(clearButton);
339 |       
340 |       await waitFor(() => {
341 |         expect(toast.error).toHaveBeenCalledWith('Failed to clear API keys');
342 |       });
343 |     });
344 |   });
345 | 
346 |   // Tests for Accessibility
347 |   describe('Accessibility', () => {
348 |     test('form inputs have proper labels', () => {
349 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
350 |       
351 |       expect(screen.getByTestId('label-openai')).toHaveAttribute('for', 'openai');
352 |       expect(screen.getByTestId('input-openai')).toHaveAttribute('id', 'openai');
353 |       
354 |       expect(screen.getByTestId('label-anthropic')).toHaveAttribute('for', 'anthropic');
355 |       expect(screen.getByTestId('input-anthropic')).toHaveAttribute('id', 'anthropic');
356 |     });
357 | 
358 |     test('buttons have proper types', () => {
359 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
360 |       
361 |       const toggleButtons = screen.getAllByRole('button');
362 |       const eyeToggleButtons = toggleButtons.filter(button => 
363 |         button.querySelector('[data-testid="eyeoff-icon"]') || 
364 |         button.querySelector('[data-testid="eye-icon"]')
365 |       );
366 |       
367 |       eyeToggleButtons.forEach(button => {
368 |         expect(button).toHaveAttribute('type', 'button');
369 |       });
370 |     });
371 | 
372 |     test('renders proper button variants', () => {
373 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
374 |       
375 |       expect(screen.getByTestId('button-destructive')).toBeInTheDocument(); // Clear All Keys
376 |       expect(screen.getByTestId('button-outline')).toBeInTheDocument(); // Cancel
377 |       expect(screen.getByTestId('button-default')).toBeInTheDocument(); // Save Keys
378 |     });
379 |   });
380 | 
381 |   // Tests for Responsive Design
382 |   describe('Responsive Design', () => {
383 |     test('applies responsive classes to dialog content', () => {
384 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
385 |       
386 |       const dialogContent = screen.getByTestId('dialog-content');
387 |       expect(dialogContent).toHaveClass('max-w-[95vw]', 'sm:max-w-md', 'lg:max-w-[500px]');
388 |     });
389 | 
390 |     test('applies responsive spacing classes', () => {
391 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
392 |       
393 |       const dialogHeader = screen.getByTestId('dialog-header');
394 |       expect(dialogHeader).toHaveClass('space-y-2', 'sm:space-y-3');
395 |       
396 |       const dialogFooter = screen.getByTestId('dialog-footer');
397 |       expect(dialogFooter).toHaveClass('flex-col-reverse', 'sm:flex-row');
398 |     });
399 |   });
400 | 
401 |   // Integration Tests
402 |   describe('Integration Tests', () => {
403 |     test('complete workflow: load, edit, save API keys', async () => {
404 |       // Setup existing key and reset mocks
405 |       localStorageMock.setItem.mockClear();
406 |       localStorageMock.getItem.mockImplementation((key) => 
407 |         key === 'OPENAI_API_KEY' ? 'sk-existing' : null
408 |       );
409 |       
410 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
411 |       
412 |       // Verify existing key loads
413 |       await waitFor(() => {
414 |         expect(screen.getByTestId('input-openai')).toHaveValue('sk-existing');
415 |       });
416 |       
417 |       // Edit key
418 |       fireEvent.change(screen.getByTestId('input-openai'), { target: { value: 'sk-updated' } });
419 |       fireEvent.change(screen.getByTestId('input-anthropic'), { target: { value: 'sk-ant-new' } });
420 |       
421 |       // Save
422 |       const saveButton = screen.getByRole('button', { name: /save keys/i });
423 |       fireEvent.click(saveButton);
424 |       
425 |       await waitFor(() => {
426 |         expect(toast.success).toHaveBeenCalledWith('API keys saved successfully');
427 |         expect(mockOnOpenChange).toHaveBeenCalledWith(false);
428 |       });
429 |       
430 |       // Check that both keys were saved
431 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('OPENAI_API_KEY', 'sk-updated');
432 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('ANTHROPIC_API_KEY', 'sk-ant-new');
433 |     });
434 | 
435 |     test('complete workflow: clear all keys', async () => {
436 |       // Setup existing keys and reset mocks
437 |       localStorageMock.removeItem.mockClear();
438 |       localStorageMock.getItem.mockReturnValue('sk-existing');
439 |       
440 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
441 |       
442 |       // Wait for keys to load
443 |       await waitFor(() => {
444 |         expect(screen.getByTestId('input-openai')).toHaveValue('sk-existing');
445 |       });
446 |       
447 |       // Clear all keys
448 |       const clearButton = screen.getByRole('button', { name: /clear all keys/i });
449 |       fireEvent.click(clearButton);
450 |       
451 |       await waitFor(() => {
452 |         expect(toast.success).toHaveBeenCalledWith('All API keys cleared');
453 |       });
454 |       
455 |       // Verify all localStorage keys were removed
456 |       expect(localStorageMock.removeItem).toHaveBeenCalledWith('OPENAI_API_KEY');
457 |       expect(localStorageMock.removeItem).toHaveBeenCalledWith('ANTHROPIC_API_KEY');
458 |       expect(localStorageMock.removeItem).toHaveBeenCalledWith('GROQ_API_KEY');
459 |       expect(localStorageMock.removeItem).toHaveBeenCalledWith('XAI_API_KEY');
460 |       expect(localStorageMock.removeItem).toHaveBeenCalledWith('OPENROUTER_API_KEY');
461 |       expect(localStorageMock.removeItem).toHaveBeenCalledWith('REQUESTY_API_KEY');
462 |       
463 |       // Verify inputs are cleared in state
464 |       expect(screen.getByTestId('input-openai')).toHaveValue('');
465 |       expect(screen.getByTestId('input-anthropic')).toHaveValue('');
466 |     });
467 | 
468 |     test('visibility toggle works for multiple inputs independently', () => {
469 |       render(<ApiKeyManager open={true} onOpenChange={mockOnOpenChange} />);
470 |       
471 |       const inputs = [
472 |         screen.getByTestId('input-openai'),
473 |         screen.getByTestId('input-anthropic')
474 |       ];
475 |       
476 |       const toggleButtons = screen.getAllByRole('button').filter(button => 
477 |         button.querySelector('[data-testid="eye-icon"]')
478 |       );
479 |       
480 |       // Initially all should be password type
481 |       inputs.forEach(input => {
482 |         expect(input).toHaveAttribute('type', 'password');
483 |       });
484 |       
485 |       // Toggle first input
486 |       fireEvent.click(toggleButtons[0]);
487 |       expect(inputs[0]).toHaveAttribute('type', 'text');
488 |       expect(inputs[1]).toHaveAttribute('type', 'password'); // Should remain password
489 |       
490 |       // Toggle second input
491 |       fireEvent.click(toggleButtons[1]);
492 |       expect(inputs[0]).toHaveAttribute('type', 'text');
493 |       expect(inputs[1]).toHaveAttribute('type', 'text');
494 |     });
495 |   });
496 | });
```

__tests__/components/chat-list.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
3 | import { useRouter, usePathname } from 'next/navigation';
4 | import { ChatList } from '../../components/chat-list';
5 | import { toast } from 'sonner';
6 | 
7 | // Mock Next.js navigation
8 | jest.mock('next/navigation', () => ({
9 |   useRouter: jest.fn(),
10 |   usePathname: jest.fn(),
11 | }));
12 | 
13 | // Mock toast notifications
14 | jest.mock('sonner', () => ({
15 |   toast: {
16 |     error: jest.fn(),
17 |   },
18 | }));
19 | 
20 | // Mock motion components
21 | jest.mock('framer-motion', () => ({
22 |   motion: {
23 |     div: ({ children, ...props }: any) => <div {...props}>{children}</div>,
24 |   },
25 |   AnimatePresence: ({ children }: any) => <div>{children}</div>,
26 | }));
27 | 
28 | // Mock UI components
29 | jest.mock('../../components/ui/sidebar', () => ({
30 |   SidebarGroupContent: ({ children, className }: any) => (
31 |     <div className={className} data-testid="sidebar-group-content">{children}</div>
32 |   ),
33 |   SidebarMenuItem: ({ children, className }: any) => (
34 |     <li className={className} data-testid="sidebar-menu-item">{children}</li>
35 |   ),
36 |   SidebarMenuButton: ({ children, onClick, isActive, className, asChild, ...props }: any) => {
37 |     if (asChild) {
38 |       return <div className={className} data-active={isActive} data-testid="sidebar-menu-button-wrapper" {...props}>{children}</div>;
39 |     }
40 |     return (
41 |       <button 
42 |         onClick={onClick} 
43 |         className={className} 
44 |         data-active={isActive}
45 |         data-testid="sidebar-menu-button"
46 |         {...props}
47 |       >
48 |         {children}
49 |       </button>
50 |     );
51 |   },
52 |   SidebarMenu: ({ children }: any) => <ul data-testid="sidebar-menu">{children}</ul>,
53 | }));
54 | 
55 | jest.mock('../../components/ui/button', () => ({
56 |   Button: ({ children, onClick, variant, size, className, disabled, id, title, ...props }: any) => (
57 |     <button 
58 |       onClick={onClick} 
59 |       className={className}
60 |       disabled={disabled}
61 |       id={id}
62 |       title={title}
63 |       data-variant={variant}
64 |       data-size={size}
65 |       {...props}
66 |     >
67 |       {children}
68 |     </button>
69 |   ),
70 | }));
71 | 
72 | jest.mock('../../components/ui/input', () => ({
73 |   Input: ({ onChange, value, placeholder, type, className, maxLength, onKeyDown, onBlur, ...props }: any) => (
74 |     <input
75 |       type={type}
76 |       value={value}
77 |       onChange={onChange}
78 |       onKeyDown={onKeyDown}
79 |       onBlur={onBlur}
80 |       placeholder={placeholder}
81 |       className={className}
82 |       maxLength={maxLength}
83 |       {...props}
84 |     />
85 |   ),
86 | }));
87 | 
88 | jest.mock('../../components/ui/skeleton', () => ({
89 |   Skeleton: ({ className }: any) => <div className={className} data-testid="skeleton" />,
90 | }));
91 | 
92 | jest.mock('../../components/ui/tooltip', () => ({
93 |   TooltipProvider: ({ children }: any) => <div data-testid="tooltip-provider">{children}</div>,
94 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
95 |   TooltipTrigger: ({ children, asChild }: any) => asChild ? children : <div data-testid="tooltip-trigger">{children}</div>,
96 |   TooltipContent: ({ children }: any) => <div data-testid="tooltip-content" style={{ display: 'none' }}>{children}</div>,
97 | }));
98 | 
99 | jest.mock('next/link', () => {
100 |   return ({ children, href, onClick, className }: any) => (
101 |     <a href={href} onClick={onClick} className={className}>
102 |       {children}
103 |     </a>
104 |   );
105 | });
106 | 
107 | // Mock ChatShareDialog component
108 | jest.mock('../../components/chat-share-dialog', () => ({
109 |   ChatShareDialog: ({ isOpen, onOpenChange, chatId, chatTitle }: any) => 
110 |     isOpen ? (
111 |       <div data-testid="chat-share-dialog">
112 |         <div>Share Dialog for {chatTitle}</div>
113 |         <button onClick={() => onOpenChange(false)}>Close</button>
114 |       </div>
115 |     ) : null,
116 | }));
117 | 
118 | // Mock Lucide icons
119 | jest.mock('lucide-react', () => ({
120 |   MessageSquare: () => <div data-testid="message-square-icon" />,
121 |   PlusCircle: () => <div data-testid="plus-circle-icon" />,
122 |   Trash2: () => <div data-testid="trash-icon" />,
123 |   CheckIcon: () => <div data-testid="check-icon" />,
124 |   XIcon: () => <div data-testid="x-icon" />,
125 |   Loader2: () => <div data-testid="loader-icon" />,
126 |   Pencil: () => <div data-testid="pencil-icon" />,
127 |   Share2: () => <div data-testid="share-icon" />,
128 | }));
129 | 
130 | describe('ChatList', () => {
131 |   const mockRouter = {
132 |     push: jest.fn(),
133 |   };
134 |   const mockUsePathname = usePathname as jest.MockedFunction<typeof usePathname>;
135 |   const mockUseRouter = useRouter as jest.MockedFunction<typeof useRouter>;
136 | 
137 |   const mockProps = {
138 |     chats: [
139 |       {
140 |         id: 'chat-1',
141 |         title: 'First Chat',
142 |         userId: 'user-1',
143 |         createdAt: new Date('2023-01-01'),
144 |         updatedAt: new Date('2023-01-01'),
145 |       },
146 |       {
147 |         id: 'chat-2',
148 |         title: 'Second Chat',
149 |         userId: 'user-1',
150 |         createdAt: new Date('2023-01-02'),
151 |         updatedAt: new Date('2023-01-02'),
152 |       },
153 |       {
154 |         id: 'chat-3',
155 |         title: 'React Development',
156 |         userId: 'user-1',
157 |         createdAt: new Date('2023-01-03'),
158 |         updatedAt: new Date('2023-01-03'),
159 |       },
160 |     ],
161 |     isLoading: false,
162 |     isCollapsed: false,
163 |     isUpdatingChatTitle: false,
164 |     onNewChat: jest.fn(),
165 |     onDeleteChat: jest.fn(),
166 |     onUpdateChatTitle: jest.fn(),
167 |     onNavigateToChat: jest.fn(),
168 |   };
169 | 
170 |   beforeEach(() => {
171 |     jest.clearAllMocks();
172 |     mockUseRouter.mockReturnValue(mockRouter);
173 |     mockUsePathname.mockReturnValue('/');
174 |   });
175 | 
176 |   // Tests for Basic Rendering and Props
177 |   describe('Basic Rendering and Props', () => {
178 |     test('renders with chats when not loading', () => {
179 |       render(<ChatList {...mockProps} />);
180 |       
181 |       // Check that all chat links are present
182 |       const allChatLinks = screen.getAllByRole('link');
183 |       const firstChatLinks = allChatLinks.filter(link => link.getAttribute('href') === '/chat/chat-1');
184 |       const secondChatLinks = allChatLinks.filter(link => link.getAttribute('href') === '/chat/chat-2');
185 |       const reactChatLinks = allChatLinks.filter(link => link.getAttribute('href') === '/chat/chat-3');
186 |       
187 |       expect(firstChatLinks.length).toBeGreaterThan(0);
188 |       expect(secondChatLinks.length).toBeGreaterThan(0);
189 |       expect(reactChatLinks.length).toBeGreaterThan(0);
190 |     });
191 | 
192 |     test('renders loading skeletons when loading', () => {
193 |       render(<ChatList {...mockProps} isLoading={true} />);
194 |       
195 |       const skeletons = screen.getAllByTestId('skeleton');
196 |       expect(skeletons.length).toBeGreaterThan(0);
197 |       expect(screen.queryByText('First Chat')).not.toBeInTheDocument();
198 |     });
199 | 
200 |     test('renders empty state when no chats exist', () => {
201 |       render(<ChatList {...mockProps} chats={[]} />);
202 |       
203 |       expect(screen.getByText('No chats yet. Start a new one!')).toBeInTheDocument();
204 |     });
205 | 
206 |     test('renders search input and new chat button when not collapsed', () => {
207 |       render(<ChatList {...mockProps} />);
208 |       
209 |       expect(screen.getByPlaceholderText('Search chats...')).toBeInTheDocument();
210 |       expect(screen.getByRole('button', { name: /new chat/i })).toBeInTheDocument();
211 |     });
212 | 
213 |     test('does not render search input and new chat button when collapsed', () => {
214 |       render(<ChatList {...mockProps} isCollapsed={true} />);
215 |       
216 |       expect(screen.queryByPlaceholderText('Search chats...')).not.toBeInTheDocument();
217 |       expect(screen.queryByRole('button', { name: /new chat/i })).not.toBeInTheDocument();
218 |     });
219 | 
220 |     test('highlights active chat based on pathname', () => {
221 |       mockUsePathname.mockReturnValue('/chat/chat-1');
222 |       render(<ChatList {...mockProps} />);
223 |       
224 |       // Check for active state on sidebar menu button wrapper
225 |       const activeElements = screen.getAllByTestId('sidebar-menu-button-wrapper').filter(element => 
226 |         element.getAttribute('data-active') === 'true'
227 |       );
228 |       expect(activeElements.length).toBeGreaterThan(0);
229 |     });
230 |   });
231 | 
232 |   // Tests for Search Functionality
233 |   describe('Search Functionality', () => {
234 |     test('filters chats based on search term', () => {
235 |       render(<ChatList {...mockProps} />);
236 |       
237 |       const searchInput = screen.getByPlaceholderText('Search chats...');
238 |       fireEvent.change(searchInput, { target: { value: 'React' } });
239 |       
240 |       // Check that only React Development chat link is present
241 |       const reactChatLinks = screen.getAllByRole('link').filter(link => 
242 |         link.getAttribute('href') === '/chat/chat-3'
243 |       );
244 |       expect(reactChatLinks.length).toBeGreaterThan(0);
245 |       
246 |       const firstChatLinks = screen.getAllByRole('link').filter(link => 
247 |         link.getAttribute('href') === '/chat/chat-1'
248 |       );
249 |       expect(firstChatLinks.length).toBe(0);
250 |       
251 |       const secondChatLinks = screen.getAllByRole('link').filter(link => 
252 |         link.getAttribute('href') === '/chat/chat-2'
253 |       );
254 |       expect(secondChatLinks.length).toBe(0);
255 |     });
256 | 
257 |     test('shows no results message when search yields no matches', () => {
258 |       render(<ChatList {...mockProps} />);
259 |       
260 |       const searchInput = screen.getByPlaceholderText('Search chats...');
261 |       fireEvent.change(searchInput, { target: { value: 'nonexistent' } });
262 |       
263 |       expect(screen.getByText('No results found.')).toBeInTheDocument();
264 |       expect(screen.queryByText('First Chat')).not.toBeInTheDocument();
265 |     });
266 | 
267 |     test('search is case insensitive', () => {
268 |       render(<ChatList {...mockProps} />);
269 |       
270 |       const searchInput = screen.getByPlaceholderText('Search chats...');
271 |       fireEvent.change(searchInput, { target: { value: 'REACT' } });
272 |       
273 |       // Check that React Development chat link is present
274 |       const reactChatLinks = screen.getAllByRole('link').filter(link => 
275 |         link.getAttribute('href') === '/chat/chat-3'
276 |       );
277 |       expect(reactChatLinks.length).toBeGreaterThan(0);
278 |     });
279 | 
280 |     test('clears search results when search term is cleared', () => {
281 |       render(<ChatList {...mockProps} />);
282 |       
283 |       const searchInput = screen.getByPlaceholderText('Search chats...');
284 |       fireEvent.change(searchInput, { target: { value: 'React' } });
285 |       fireEvent.change(searchInput, { target: { value: '' } });
286 |       
287 |       // Check that all chat links are present again
288 |       const allChatLinks = screen.getAllByRole('link');
289 |       const firstChatLinks = allChatLinks.filter(link => link.getAttribute('href') === '/chat/chat-1');
290 |       const secondChatLinks = allChatLinks.filter(link => link.getAttribute('href') === '/chat/chat-2');
291 |       const reactChatLinks = allChatLinks.filter(link => link.getAttribute('href') === '/chat/chat-3');
292 |       
293 |       expect(firstChatLinks.length).toBeGreaterThan(0);
294 |       expect(secondChatLinks.length).toBeGreaterThan(0);
295 |       expect(reactChatLinks.length).toBeGreaterThan(0);
296 |     });
297 |   });
298 | 
299 |   // Tests for User Interactions
300 |   describe('User Interactions', () => {
301 |     test('calls onNewChat when new chat button is clicked', () => {
302 |       render(<ChatList {...mockProps} />);
303 |       
304 |       const newChatButton = screen.getByRole('button', { name: /new chat/i });
305 |       fireEvent.click(newChatButton);
306 |       
307 |       expect(mockProps.onNewChat).toHaveBeenCalledTimes(1);
308 |     });
309 | 
310 |     test('navigates to chat when chat link is clicked', () => {
311 |       render(<ChatList {...mockProps} />);
312 |       
313 |       const chatLinks = screen.getAllByRole('link');
314 |       const firstChatLink = chatLinks.find(link => link.getAttribute('href') === '/chat/chat-1');
315 |       expect(firstChatLink).toHaveAttribute('href', '/chat/chat-1');
316 |     });
317 | 
318 |     test('calls onNavigateToChat when chat is clicked', () => {
319 |       render(<ChatList {...mockProps} />);
320 |       
321 |       const chatLinks = screen.getAllByRole('link');
322 |       const firstChatLink = chatLinks.find(link => link.getAttribute('href') === '/chat/chat-1');
323 |       fireEvent.click(firstChatLink!);
324 |       
325 |       expect(mockProps.onNavigateToChat).toHaveBeenCalledWith('chat-1');
326 |     });
327 | 
328 |     test('calls onDeleteChat when delete button is clicked', () => {
329 |       render(<ChatList {...mockProps} />);
330 |       
331 |       // Find delete button (trash icon)
332 |       const deleteButton = screen.getAllByTestId('trash-icon')[0].closest('button');
333 |       fireEvent.click(deleteButton!);
334 |       
335 |       expect(mockProps.onDeleteChat).toHaveBeenCalledWith('chat-1', expect.any(Object));
336 |     });
337 | 
338 |     test('shows edit and delete buttons on hover when not collapsed', () => {
339 |       render(<ChatList {...mockProps} />);
340 |       
341 |       const editButtons = screen.getAllByTestId('pencil-icon');
342 |       const deleteButtons = screen.getAllByTestId('trash-icon');
343 |       
344 |       expect(editButtons.length).toBeGreaterThan(0);
345 |       expect(deleteButtons.length).toBeGreaterThan(0);
346 |     });
347 |   });
348 | 
349 |   // Tests for Chat Title Editing
350 |   describe('Chat Title Editing', () => {
351 |     test('enters edit mode when edit button is clicked', () => {
352 |       render(<ChatList {...mockProps} />);
353 |       
354 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
355 |       fireEvent.click(editButton!);
356 |       
357 |       const editInput = screen.getByDisplayValue('First Chat');
358 |       expect(editInput).toBeInTheDocument();
359 |       expect(screen.getByTestId('check-icon')).toBeInTheDocument();
360 |       expect(screen.getByTestId('x-icon')).toBeInTheDocument();
361 |     });
362 | 
363 |     test('updates input value when typing in edit mode', () => {
364 |       render(<ChatList {...mockProps} />);
365 |       
366 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
367 |       fireEvent.click(editButton!);
368 |       
369 |       const editInput = screen.getByDisplayValue('First Chat');
370 |       fireEvent.change(editInput, { target: { value: 'Updated Chat Title' } });
371 |       
372 |       expect(editInput).toHaveValue('Updated Chat Title');
373 |     });
374 | 
375 |     test('saves changes when save button is clicked', () => {
376 |       render(<ChatList {...mockProps} />);
377 |       
378 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
379 |       fireEvent.click(editButton!);
380 |       
381 |       const editInput = screen.getByDisplayValue('First Chat');
382 |       fireEvent.change(editInput, { target: { value: 'Updated Title' } });
383 |       
384 |       const saveButton = screen.getByTestId('check-icon').closest('button');
385 |       fireEvent.click(saveButton!);
386 |       
387 |       expect(mockProps.onUpdateChatTitle).toHaveBeenCalledWith(
388 |         { chatId: 'chat-1', title: 'Updated Title' },
389 |         expect.objectContaining({
390 |           onSuccess: expect.any(Function),
391 |           onError: expect.any(Function),
392 |         })
393 |       );
394 |     });
395 | 
396 |     test('cancels edit when cancel button is clicked', () => {
397 |       render(<ChatList {...mockProps} />);
398 |       
399 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
400 |       fireEvent.click(editButton!);
401 |       
402 |       const editInput = screen.getByDisplayValue('First Chat');
403 |       fireEvent.change(editInput, { target: { value: 'Updated Title' } });
404 |       
405 |       const cancelButton = screen.getByTestId('x-icon').closest('button');
406 |       fireEvent.click(cancelButton!);
407 |       
408 |       expect(screen.queryByDisplayValue('Updated Title')).not.toBeInTheDocument();
409 |       // Check that we're back to normal view (not editing mode)
410 |       const chatLinks = screen.getAllByRole('link');
411 |       const firstChatLink = chatLinks.find(link => link.getAttribute('href') === '/chat/chat-1');
412 |       expect(firstChatLink).toBeInTheDocument();
413 |     });
414 | 
415 |     test('saves changes when Enter key is pressed', () => {
416 |       render(<ChatList {...mockProps} />);
417 |       
418 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
419 |       fireEvent.click(editButton!);
420 |       
421 |       const editInput = screen.getByDisplayValue('First Chat');
422 |       fireEvent.change(editInput, { target: { value: 'Updated Title' } });
423 |       fireEvent.keyDown(editInput, { key: 'Enter' });
424 |       
425 |       expect(mockProps.onUpdateChatTitle).toHaveBeenCalledWith(
426 |         { chatId: 'chat-1', title: 'Updated Title' },
427 |         expect.objectContaining({
428 |           onSuccess: expect.any(Function),
429 |           onError: expect.any(Function),
430 |         })
431 |       );
432 |     });
433 | 
434 |     test('cancels edit when Escape key is pressed', () => {
435 |       render(<ChatList {...mockProps} />);
436 |       
437 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
438 |       fireEvent.click(editButton!);
439 |       
440 |       const editInput = screen.getByDisplayValue('First Chat');
441 |       fireEvent.change(editInput, { target: { value: 'Updated Title' } });
442 |       fireEvent.keyDown(editInput, { key: 'Escape' });
443 |       
444 |       expect(screen.queryByDisplayValue('Updated Title')).not.toBeInTheDocument();
445 |       // Check that we're back to normal view (not editing mode)
446 |       const chatLinks = screen.getAllByRole('link');
447 |       const firstChatLink = chatLinks.find(link => link.getAttribute('href') === '/chat/chat-1');
448 |       expect(firstChatLink).toBeInTheDocument();
449 |     });
450 | 
451 |     test('shows loading spinner when updating chat title', () => {
452 |       render(<ChatList {...mockProps} isUpdatingChatTitle={true} />);
453 |       
454 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
455 |       fireEvent.click(editButton!);
456 |       
457 |       // Simulate the editing state with the chat ID being updated
458 |       const component = render(
459 |         <ChatList 
460 |           {...mockProps} 
461 |           isUpdatingChatTitle={true}
462 |         />
463 |       );
464 |       
465 |       // In a real scenario, you'd need to trigger the edit state and then check for the loader
466 |       // This is a simplified test for the loading state
467 |       expect(screen.getAllByTestId('loader-icon').length).toBeGreaterThanOrEqual(0);
468 |     });
469 |   });
470 | 
471 |   // Tests for Error Handling
472 |   describe('Error Handling', () => {
473 |     test('shows error toast when trying to save empty title', () => {
474 |       render(<ChatList {...mockProps} />);
475 |       
476 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
477 |       fireEvent.click(editButton!);
478 |       
479 |       const editInput = screen.getByDisplayValue('First Chat');
480 |       fireEvent.change(editInput, { target: { value: '' } });
481 |       
482 |       const saveButton = screen.getByTestId('check-icon').closest('button');
483 |       fireEvent.click(saveButton!);
484 |       
485 |       expect(toast.error).toHaveBeenCalledWith('Chat title cannot be empty.');
486 |       expect(mockProps.onUpdateChatTitle).not.toHaveBeenCalled();
487 |     });
488 | 
489 |     test('shows error toast when trying to save whitespace-only title', () => {
490 |       render(<ChatList {...mockProps} />);
491 |       
492 |       const editButton = screen.getAllByTestId('pencil-icon')[0].closest('button');
493 |       fireEvent.click(editButton!);
494 |       
495 |       const editInput = screen.getByDisplayValue('First Chat');
496 |       fireEvent.change(editInput, { target: { value: '   ' } });
497 |       
498 |       const saveButton = screen.getByTestId('check-icon').closest('button');
499 |       fireEvent.click(saveButton!);
500 |       
501 |       expect(toast.error).toHaveBeenCalledWith('Chat title cannot be empty.');
502 |       expect(mockProps.onUpdateChatTitle).not.toHaveBeenCalled();
503 |     });
504 | 
505 |     test('handles null chats array gracefully', () => {
506 |       render(<ChatList {...mockProps} chats={null as any} />);
507 |       
508 |       expect(screen.getByText('No chats yet. Start a new one!')).toBeInTheDocument();
509 |     });
510 | 
511 |     test('handles undefined chats array gracefully', () => {
512 |       render(<ChatList {...mockProps} chats={undefined as any} />);
513 |       
514 |       expect(screen.getByText('No chats yet. Start a new one!')).toBeInTheDocument();
515 |     });
516 | 
517 |     test('displays fallback title for chats without title', () => {
518 |       const chatsWithoutTitle = [
519 |         {
[TRUNCATED]
```

__tests__/components/chat-sidebar.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { useRouter, usePathname } from 'next/navigation';
4 | import { ChatSidebar } from '../../components/chat-sidebar';
5 | import { useSession } from '@/lib/auth-client';
6 | import { useChats } from '@/lib/hooks/use-chats';
7 | import { useMCP } from '@/lib/context/mcp-context';
8 | import { useWebSearch } from '@/lib/context/web-search-context';
9 | import { useClientMount } from '@/lib/hooks/use-client-mount';
10 | import { useSidebar } from '@/components/ui/sidebar';
11 | import { useQueryClient } from '@tanstack/react-query';
12 | import { useAuth } from '@/lib/context/auth-context';
13 | 
14 | // Mock external dependencies
15 | jest.mock('next/navigation', () => ({
16 |   useRouter: jest.fn(),
17 |   usePathname: jest.fn(),
18 | }));
19 | 
20 | jest.mock('@/lib/auth-client', () => ({
21 |   useSession: jest.fn(),
22 |   signOut: jest.fn(),
23 | }));
24 | 
25 | jest.mock('@/lib/hooks/use-chats', () => ({
26 |   useChats: jest.fn(),
27 | }));
28 | 
29 | jest.mock('@/lib/context/mcp-context', () => ({
30 |   useMCP: jest.fn(),
31 | }));
32 | 
33 | jest.mock('@/lib/context/web-search-context', () => ({
34 |   useWebSearch: jest.fn(),
35 | }));
36 | 
37 | jest.mock('@/lib/hooks/use-client-mount', () => ({
38 |   useClientMount: jest.fn(),
39 | }));
40 | 
41 | jest.mock('@/lib/context/auth-context', () => ({
42 |   useAuth: jest.fn(),
43 | }));
44 | 
45 | jest.mock('@/components/ui/sidebar', () => ({
46 |   Sidebar: ({ children, className, collapsible }: any) => (
47 |     <div data-testid="sidebar" className={className} data-collapsible={collapsible}>
48 |       {children}
49 |     </div>
50 |   ),
51 |   SidebarContent: ({ children, className }: any) => (
52 |     <div data-testid="sidebar-content" className={className}>
53 |       {children}
54 |     </div>
55 |   ),
56 |   SidebarFooter: ({ children, className }: any) => (
57 |     <div data-testid="sidebar-footer" className={className}>
58 |       {children}
59 |     </div>
60 |   ),
61 |   SidebarHeader: ({ children, className }: any) => (
62 |     <div data-testid="sidebar-header" className={className}>
63 |       {children}
64 |     </div>
65 |   ),
66 |   SidebarGroup: ({ children, className }: any) => (
67 |     <div data-testid="sidebar-group" className={className}>
68 |       {children}
69 |     </div>
70 |   ),
71 |   SidebarGroupContent: ({ children, className }: any) => (
72 |     <div data-testid="sidebar-group-content" className={className}>
73 |       {children}
74 |     </div>
75 |   ),
76 |   SidebarGroupLabel: ({ children, className }: any) => (
77 |     <div data-testid="sidebar-group-label" className={className}>
78 |       {children}
79 |     </div>
80 |   ),
81 |   SidebarMenu: ({ children }: any) => (
82 |     <div data-testid="sidebar-menu">
83 |       {children}
84 |     </div>
85 |   ),
86 |   SidebarMenuItem: ({ children, className }: any) => (
87 |     <div data-testid="sidebar-menu-item" className={className}>
88 |       {children}
89 |     </div>
90 |   ),
91 |   SidebarMenuButton: ({ children, onClick, className, tooltip }: any) => (
92 |     <button 
93 |       data-testid="sidebar-menu-button" 
94 |       onClick={onClick} 
95 |       className={className}
96 |       title={tooltip}
97 |     >
98 |       {children}
99 |     </button>
100 |   ),
101 |   SidebarMenuBadge: ({ children, className }: any) => (
102 |     <span data-testid="sidebar-menu-badge" className={className}>
103 |       {children}
104 |     </span>
105 |   ),
106 |   useSidebar: jest.fn(),
107 | }));
108 | 
109 | jest.mock('@tanstack/react-query', () => ({
110 |   useQueryClient: jest.fn(),
111 | }));
112 | 
113 | jest.mock('sonner', () => ({
114 |   toast: {
115 |     success: jest.fn(),
116 |     error: jest.fn(),
117 |   },
118 | }));
119 | 
120 | // Mock UI components
121 | jest.mock('@/components/ui/separator', () => ({
122 |   Separator: ({ className }: any) => (
123 |     <div data-testid="separator" className={className} />
124 |   ),
125 | }));
126 | 
127 | jest.mock('@/components/ui/button', () => ({
128 |   Button: ({ children, onClick, variant, className, ...props }: any) => (
129 |     <button 
130 |       onClick={onClick} 
131 |       className={className} 
132 |       data-variant={variant}
133 |       data-testid={`button-${variant || 'default'}`}
134 |       {...props}
135 |     >
136 |       {children}
137 |     </button>
138 |   ),
139 | }));
140 | 
141 | jest.mock('@/components/ui/badge', () => ({
142 |   Badge: ({ children, variant, className }: any) => (
143 |     <span 
144 |       data-testid="badge" 
145 |       data-variant={variant}
146 |       className={className}
147 |     >
148 |       {children}
149 |     </span>
150 |   ),
151 | }));
152 | 
153 | jest.mock('@/components/ui/skeleton', () => ({
154 |   Skeleton: ({ className }: any) => (
155 |     <div data-testid="skeleton" className={className} />
156 |   ),
157 | }));
158 | 
159 | jest.mock('@/components/ui/dropdown-menu', () => ({
160 |   DropdownMenu: ({ children }: any) => <div data-testid="dropdown-menu">{children}</div>,
161 |   DropdownMenuContent: ({ children, align, side, sideOffset, className }: any) => (
162 |     <div 
163 |       data-testid="dropdown-menu-content" 
164 |       data-align={align}
165 |       data-side={side}
166 |       data-side-offset={sideOffset}
167 |       className={className}
168 |     >
169 |       {children}
170 |     </div>
171 |   ),
172 |   DropdownMenuGroup: ({ children }: any) => <div data-testid="dropdown-menu-group">{children}</div>,
173 |   DropdownMenuItem: ({ children, onClick, className }: any) => (
174 |     <div 
175 |       data-testid="dropdown-menu-item" 
176 |       onClick={onClick}
177 |       className={className}
178 |       role="menuitem"
179 |     >
180 |       {children}
181 |     </div>
182 |   ),
183 |   DropdownMenuLabel: ({ children, className }: any) => (
184 |     <div data-testid="dropdown-menu-label" className={className}>
185 |       {children}
186 |     </div>
187 |   ),
188 |   DropdownMenuSeparator: () => <div data-testid="dropdown-menu-separator" />,
189 |   DropdownMenuTrigger: ({ children, asChild }: any) => (
190 |     <div data-testid="dropdown-menu-trigger">
191 |       {children}
192 |     </div>
193 |   ),
194 | }));
195 | 
196 | jest.mock('@/components/ui/dialog', () => ({
197 |   Dialog: ({ children, open, onOpenChange }: any) => (
198 |     <div data-testid="dialog" data-open={open}>
199 |       {open && children}
200 |     </div>
201 |   ),
202 |   DialogContent: ({ children, className }: any) => (
203 |     <div data-testid="dialog-content" className={className}>
204 |       {children}
205 |     </div>
206 |   ),
207 |   DialogDescription: ({ children, className }: any) => (
208 |     <div data-testid="dialog-description" className={className}>
209 |       {children}
210 |     </div>
211 |   ),
212 |   DialogFooter: ({ children, className }: any) => (
213 |     <div data-testid="dialog-footer" className={className}>
214 |       {children}
215 |     </div>
216 |   ),
217 |   DialogHeader: ({ children }: any) => (
218 |     <div data-testid="dialog-header">
219 |       {children}
220 |     </div>
221 |   ),
222 |   DialogTitle: ({ children, className }: any) => (
223 |     <div data-testid="dialog-title" className={className}>
224 |       {children}
225 |     </div>
226 |   ),
227 | }));
228 | 
229 | jest.mock('@/components/ui/tooltip', () => ({
230 |   TooltipProvider: ({ children }: any) => <div data-testid="tooltip-provider">{children}</div>,
231 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
232 |   TooltipContent: ({ children, side, sideOffset }: any) => (
233 |     <div data-testid="tooltip-content" data-side={side} data-side-offset={sideOffset}>
234 |       {children}
235 |     </div>
236 |   ),
237 |   TooltipTrigger: ({ children, asChild }: any) => (
238 |     <div data-testid="tooltip-trigger">
239 |       {children}
240 |     </div>
241 |   ),
242 | }));
243 | 
244 | // Mock child components
245 | jest.mock('../../components/mcp-server-manager', () => ({
246 |   MCPServerManager: ({ open, onOpenChange, servers, onServersChange, selectedServers, onSelectedServersChange }: any) => (
247 |     <div 
248 |       data-testid="mcp-server-manager" 
249 |       data-open={open}
250 |     >
251 |       MCP Server Manager
252 |     </div>
253 |   ),
254 | }));
255 | 
256 | jest.mock('../../components/api-key-manager', () => ({
257 |   ApiKeyManager: ({ open, onOpenChange }: any) => (
258 |     <div 
259 |       data-testid="api-key-manager" 
260 |       data-open={open}
261 |     >
262 |       API Key Manager
263 |     </div>
264 |   ),
265 | }));
266 | 
267 | jest.mock('../../components/theme-toggle', () => ({
268 |   ThemeToggle: ({ className, showLabel }: any) => (
269 |     <button 
270 |       data-testid="theme-toggle" 
271 |       className={className}
272 |       data-show-label={showLabel}
273 |     >
274 |       Theme Toggle
275 |     </button>
276 |   ),
277 | }));
278 | 
279 | jest.mock('../../components/provider-health-dashboard', () => ({
280 |   ProviderHealthDashboard: ({ dialogMode, compact, showRefreshButton }: any) => (
281 |     <div 
282 |       data-testid="provider-health-dashboard"
283 |       data-dialog-mode={dialogMode}
284 |       data-compact={compact}
285 |       data-show-refresh-button={showRefreshButton}
286 |     >
287 |       Provider Health Dashboard
288 |     </div>
289 |   ),
290 | }));
291 | 
292 | jest.mock('../../components/auth/SignInButton', () => ({
293 |   SignInButton: ({ isCollapsed }: any) => (
294 |     <button 
295 |       data-testid="sign-in-button"
296 |       data-collapsed={isCollapsed}
297 |     >
298 |       Sign In
299 |     </button>
300 |   ),
301 | }));
302 | 
303 | jest.mock('../../components/auth/UserAccountMenu', () => ({
304 |   UserAccountMenu: () => (
305 |     <div data-testid="user-account-menu">
306 |       User Account Menu
307 |     </div>
308 |   ),
309 | }));
310 | 
311 | jest.mock('../../components/chat-list', () => ({
312 |   ChatList: ({ chats, isLoading, isCollapsed, isUpdatingChatTitle, onNewChat, onDeleteChat, onUpdateChatTitle, onNavigateToChat }: any) => (
313 |     <div 
314 |       data-testid="chat-list"
315 |       data-loading={isLoading}
316 |       data-collapsed={isCollapsed}
317 |       data-updating-title={isUpdatingChatTitle}
318 |     >
319 |       <button data-testid="new-chat-button" onClick={onNewChat}>New Chat</button>
320 |       {chats.map((chat: any) => (
321 |         <div key={chat.id} data-testid={`chat-item-${chat.id}`}>
322 |           <span>{chat.title}</span>
323 |           <button 
324 |             data-testid={`delete-chat-${chat.id}`}
325 |             onClick={(e) => onDeleteChat(chat.id, e)}
326 |           >
327 |             Delete
328 |           </button>
329 |           <button 
330 |             data-testid={`navigate-chat-${chat.id}`}
331 |             onClick={() => onNavigateToChat(chat.id)}
332 |           >
333 |             Navigate
334 |           </button>
335 |         </div>
336 |       ))}
337 |     </div>
338 |   ),
339 | }));
340 | 
341 | // Mock Next.js components
342 | jest.mock('next/image', () => {
343 |   return function MockImage({ src, alt, width, height, className }: any) {
344 |     return (
345 |       <img 
346 |         src={src} 
347 |         alt={alt} 
348 |         width={width} 
349 |         height={height} 
350 |         className={className}
351 |         data-testid="next-image"
352 |       />
353 |     );
354 |   };
355 | });
356 | 
357 | jest.mock('next/link', () => {
358 |   return function MockLink({ href, children, className, target, rel }: any) {
359 |     return (
360 |       <a 
361 |         href={href} 
362 |         className={className}
363 |         target={target}
364 |         rel={rel}
365 |         data-testid="next-link"
366 |       >
367 |         {children}
368 |       </a>
369 |     );
370 |   };
371 | });
372 | 
373 | describe('ChatSidebar', () => {
374 |   const mockRouter = {
375 |     push: jest.fn(),
376 |     replace: jest.fn(),
377 |     back: jest.fn(),
378 |     forward: jest.fn(),
379 |     refresh: jest.fn(),
380 |     prefetch: jest.fn(),
381 |   };
382 | 
383 |   const mockQueryClient = {
384 |     invalidateQueries: jest.fn(),
385 |   };
386 | 
387 |   const defaultMocks = {
388 |     useRouter: mockRouter,
389 |     usePathname: '/',
390 |     useSession: {
391 |       data: null,
392 |       isPending: false,
393 |     },
394 |     useAuth: {
395 |       session: {
396 |         user: {
397 |           id: 'test-user-id',
398 |           name: 'Test User',
399 |           email: 'test@example.com',
400 |           isAnonymous: true,
401 |         },
402 |       },
403 |       isPending: false,
404 |       user: {
405 |         id: 'test-user-id',
406 |         name: 'Test User',
407 |         email: 'test@example.com',
408 |         isAnonymous: true,
409 |         hasSubscription: false,
410 |         messageLimit: 20,
411 |         messageRemaining: 15,
412 |         credits: 100,
413 |         hasCredits: true,
414 |         usedCredits: false,
415 |       },
416 |       status: 'anonymous',
417 |       usageData: {
418 |         limit: 20,
419 |         used: 5,
420 |         remaining: 15,
421 |         credits: 100,
422 |         hasCredits: true,
423 |         usedCredits: false,
424 |         lastFetched: Date.now(),
425 |       },
426 |       error: null,
427 |       signIn: jest.fn(),
428 |       signOut: jest.fn(),
429 |       refetchUsage: jest.fn(),
430 |       refreshMessageUsage: jest.fn(),
431 |       isLoading: false,
432 |       isAuthenticated: false,
433 |       isAnonymous: true,
434 |     },
435 |     useChats: {
436 |       chats: [],
437 |       isLoading: false,
438 |       deleteChat: jest.fn(),
439 |       refreshChats: jest.fn(),
440 |       updateChatTitle: jest.fn(),
441 |       isUpdatingChatTitle: false,
442 |     },
443 |     useMCP: {
444 |       mcpServers: [],
445 |       setMcpServers: jest.fn(),
446 |       selectedMcpServers: [],
447 |       setSelectedMcpServers: jest.fn(),
448 |     },
449 |     useWebSearch: {
450 |       webSearchContextSize: 'medium',
451 |       setWebSearchContextSize: jest.fn(),
452 |       webSearchEnabled: true,
453 |     },
454 |     useClientMount: true,
455 |     useSidebar: {
456 |       state: 'expanded',
457 |       setOpen: jest.fn(),
458 |       openMobile: false,
459 |       setOpenMobile: jest.fn(),
460 |       isMobile: false,
461 |     },
462 |     useQueryClient: mockQueryClient,
463 |   };
464 | 
465 |   // Mock window.location once before all tests
466 |   const mockLocation = {
467 |     href: 'http://localhost/',
468 |     assign: jest.fn(),
469 |     replace: jest.fn(),
470 |     reload: jest.fn(),
471 |   };
472 | 
473 |   beforeAll(() => {
474 |     // Mock window.location once
475 |     delete (window as any).location;
476 |     (window as any).location = mockLocation;
477 |   });
478 | 
479 |   beforeEach(() => {
480 |     jest.clearAllMocks();
481 |     
482 |     // Reset location href
483 |     mockLocation.href = 'http://localhost/';
484 |     mockLocation.assign.mockClear();
485 |     mockLocation.replace.mockClear();
486 |     mockLocation.reload.mockClear();
487 |     
488 |     // Setup default mocks
489 |     (useRouter as jest.Mock).mockReturnValue(defaultMocks.useRouter);
490 |     (usePathname as jest.Mock).mockReturnValue(defaultMocks.usePathname);
491 |     (useSession as jest.Mock).mockReturnValue(defaultMocks.useSession);
492 |     (useAuth as jest.Mock).mockReturnValue(defaultMocks.useAuth);
493 |     (useChats as jest.Mock).mockReturnValue(defaultMocks.useChats);
494 |     (useMCP as jest.Mock).mockReturnValue(defaultMocks.useMCP);
495 |     (useWebSearch as jest.Mock).mockReturnValue(defaultMocks.useWebSearch);
496 |     (useClientMount as jest.Mock).mockReturnValue(defaultMocks.useClientMount);
497 |     (useSidebar as jest.Mock).mockReturnValue(defaultMocks.useSidebar);
498 |     (useQueryClient as jest.Mock).mockReturnValue(defaultMocks.useQueryClient);
499 |   });
500 | 
501 |   describe('Basic Rendering and Loading States', () => {
502 |     test('renders loading skeleton when not mounted', () => {
503 |       (useClientMount as jest.Mock).mockReturnValue(false);
504 |       
505 |       render(<ChatSidebar />);
506 |       
507 |       expect(screen.getByTestId('sidebar')).toBeInTheDocument();
508 |       expect(screen.getAllByTestId('skeleton').length).toBeGreaterThan(0); // Multiple skeletons for loading state
509 |     });
510 | 
511 |     test('renders loading skeleton when session is loading', () => {
512 |       (useAuth as jest.Mock).mockReturnValue({
513 |         ...defaultMocks.useAuth,
514 |         session: null,
515 |         isPending: true,
516 |         user: null,
517 |         status: 'loading',
518 |         isAuthenticated: false,
519 |         isAnonymous: false,
520 |       });
521 |       
522 |       render(<ChatSidebar />);
523 |       
524 |       expect(screen.getAllByTestId('skeleton').length).toBeGreaterThan(0);
525 |     });
526 | 
527 |     test('renders loading skeleton when chats are loading', () => {
528 |       (useChats as jest.Mock).mockReturnValue({
529 |         ...defaultMocks.useChats,
530 |         isLoading: true,
531 |       });
532 |       
533 |       render(<ChatSidebar />);
534 |       
535 |       expect(screen.getAllByTestId('skeleton').length).toBeGreaterThan(0);
536 |     });
537 | 
538 |     test('renders main sidebar when fully loaded', () => {
539 |       render(<ChatSidebar />);
540 |       
541 |       expect(screen.getByTestId('sidebar')).toBeInTheDocument();
542 |       expect(screen.getByTestId('sidebar-header')).toBeInTheDocument();
543 |       expect(screen.getByTestId('sidebar-content')).toBeInTheDocument();
544 |       expect(screen.getByTestId('sidebar-footer')).toBeInTheDocument();
545 |       expect(screen.queryByTestId('skeleton')).not.toBeInTheDocument();
546 |     });
547 | 
548 |     test('displays ChatLima logo and title', () => {
549 |       render(<ChatSidebar />);
550 |       
551 |       const logo = screen.getByTestId('next-image');
552 |       expect(logo).toHaveAttribute('src', '/logo.png');
553 |       expect(logo).toHaveAttribute('alt', 'ChatLima logo');
554 |       
555 |       expect(screen.getByText('ChatLima')).toBeInTheDocument();
556 |     });
557 |   });
558 | 
559 |   describe('Authentication States', () => {
560 |     test('displays sign-in button for anonymous users', () => {
561 |       (useAuth as jest.Mock).mockReturnValue({
562 |         ...defaultMocks.useAuth,
563 |         session: {
564 |           user: {
565 |             id: 'anon-123',
566 |             isAnonymous: true,
567 |           },
568 |         },
569 |         isPending: false,
570 |         user: {
571 |           id: 'anon-123',
572 |           isAnonymous: true,
573 |           hasSubscription: false,
574 |           messageLimit: 10,
575 |           messageRemaining: 5,
576 |           credits: 0,
577 |           hasCredits: false,
578 |           usedCredits: false,
579 |         },
580 |         status: 'anonymous',
581 |         isAuthenticated: false,
582 |         isAnonymous: true,
583 |       });
584 |       
585 |       render(<ChatSidebar />);
586 |       
587 |       expect(screen.getByTestId('sign-in-button')).toBeInTheDocument();
588 |       expect(screen.queryByTestId('user-account-menu')).not.toBeInTheDocument();
589 |     });
590 | 
591 |     test('displays user account menu for authenticated users', () => {
592 |       (useAuth as jest.Mock).mockReturnValue({
593 |         ...defaultMocks.useAuth,
594 |         session: {
595 |           user: {
596 |             id: 'user-123',
597 |             email: 'test@example.com',
598 |             isAnonymous: false,
599 |           },
600 |         },
601 |         isPending: false,
602 |         user: {
603 |           id: 'user-123',
604 |           email: 'test@example.com',
605 |           isAnonymous: false,
606 |           hasSubscription: false,
607 |           messageLimit: 20,
608 |           messageRemaining: 15,
609 |           credits: 100,
610 |           hasCredits: true,
611 |           usedCredits: false,
612 |         },
613 |         status: 'authenticated',
614 |         isAuthenticated: true,
615 |         isAnonymous: false,
616 |       });
617 |       
618 |       render(<ChatSidebar />);
619 |       
620 |       expect(screen.getByTestId('user-account-menu')).toBeInTheDocument();
621 |       expect(screen.queryByTestId('sign-in-button')).not.toBeInTheDocument();
622 |     });
623 | 
624 |     test('displays loading skeleton for authentication state', () => {
625 |       (useAuth as jest.Mock).mockReturnValue({
626 |         ...defaultMocks.useAuth,
627 |         session: null,
628 |         isPending: true,
629 |         user: null,
630 |         status: 'loading',
631 |         isAuthenticated: false,
632 |         isAnonymous: false,
633 |       });
634 |       
635 |       render(<ChatSidebar />);
636 |       
637 |       const footerSkeletons = screen.getAllByTestId('skeleton');
638 |       expect(footerSkeletons.length).toBeGreaterThan(0);
639 |     });
640 |   });
641 | 
642 |   describe('Chat List Integration', () => {
643 |     test('passes correct props to ChatList component', () => {
644 |       const mockChats = [
645 |         { id: '1', title: 'Chat 1' },
646 |         { id: '2', title: 'Chat 2' },
647 |       ];
648 |       
649 |       (useChats as jest.Mock).mockReturnValue({
650 |         ...defaultMocks.useChats,
[TRUNCATED]
```

__tests__/components/chat.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
3 | import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
4 | import { toast } from 'sonner';
5 | 
6 | // Mock fetch globally
7 | global.fetch = jest.fn();
8 | 
9 | // Mock the entire providers file before importing Chat
10 | jest.mock('../../ai/providers', () => ({
11 |   modelID: 'gpt-4',
12 |   languageModels: {},
13 |   openaiClient: jest.fn(() => ({})),
14 |   anthropicClient: jest.fn(() => ({})),
15 |   groqClient: jest.fn(() => ({})),
16 |   xaiClient: jest.fn(() => ({})),
17 |   openrouterClient: jest.fn(() => ({})),
18 |   requestyClient: jest.fn(() => ({})),
19 | }));
20 | 
21 | // Mock chat-store
22 | jest.mock('../../lib/chat-store', () => ({
23 |   convertToUIMessages: jest.fn((messages) => messages),
24 | }));
25 | 
26 | // Mock actions
27 | jest.mock('../../app/actions', () => ({
28 |   saveChat: jest.fn(),
29 |   getChat: jest.fn(),
30 | }));
31 | 
32 | import Chat from '../../components/chat';
33 | 
34 | // Mock external dependencies
35 | jest.mock('sonner', () => ({
36 |   toast: {
37 |     success: jest.fn(),
38 |     error: jest.fn(),
39 |     info: jest.fn(),
40 |     dismiss: jest.fn(),
41 |   },
42 | }));
43 | 
44 | jest.mock('next/navigation', () => ({
45 |   useRouter: jest.fn(() => ({
46 |     push: jest.fn(),
47 |     replace: jest.fn(),
48 |     refresh: jest.fn(),
49 |   })),
50 |   useParams: jest.fn(() => ({ id: undefined })),
51 | }));
52 | 
53 | jest.mock('@ai-sdk/react', () => ({
54 |   useChat: jest.fn(() => ({
55 |     messages: [],
56 |     input: '',
57 |     handleInputChange: jest.fn(),
58 |     handleSubmit: jest.fn(),
59 |     append: jest.fn(),
60 |     status: 'idle',
61 |     stop: jest.fn(),
62 |   })),
63 | }));
64 | 
65 | jest.mock('@/lib/auth-client', () => ({
66 |   useSession: jest.fn(() => ({
67 |     data: null,
68 |     isPending: false,
69 |   })),
70 | }));
71 | 
72 | jest.mock('@/lib/context/model-context', () => ({
73 |   useModel: jest.fn(() => ({
74 |     selectedModel: 'gpt-4',
75 |     setSelectedModel: jest.fn(),
76 |   })),
77 | }));
78 | 
79 | jest.mock('@/lib/context/preset-context', () => ({
80 |   usePresets: jest.fn(() => ({
81 |     activePreset: null,
82 |   })),
83 | }));
84 | 
85 | jest.mock('@/lib/context/mcp-context', () => ({
86 |   useMCP: jest.fn(() => ({
87 |     mcpServersForApi: [],
88 |   })),
89 | }));
90 | 
91 | jest.mock('@/lib/context/web-search-context', () => ({
92 |   useWebSearch: jest.fn(() => ({
93 |     webSearchEnabled: false,
94 |     setWebSearchEnabled: jest.fn(),
95 |     webSearchContextSize: 5,
96 |     setWebSearchContextSize: jest.fn(),
97 |   })),
98 | }));
99 | 
100 | jest.mock('@/lib/context/auth-context', () => ({
101 |   useAuth: jest.fn(() => ({
102 |     session: null,
103 |     isPending: false,
104 |   })),
105 | }));
106 | 
107 | jest.mock('@/hooks/useAuth', () => ({
108 |   useAuth: jest.fn(() => ({
109 |     session: null,
110 |     isPending: false,
111 |   })),
112 | }));
113 | 
114 | jest.mock('@/hooks/useCredits', () => ({
115 |   useCredits: jest.fn(() => ({
116 |     credits: 100,
117 |     isLoading: false,
118 |   })),
119 | }));
120 | 
121 | jest.mock('@/hooks/use-models', () => ({
122 |   useModels: jest.fn(() => ({
123 |     models: [],
124 |     isLoading: false,
125 |   })),
126 | }));
127 | 
128 | jest.mock('@/lib/hooks/use-chats', () => ({
129 |   useChats: jest.fn(() => ({
130 |     chats: [],
131 |     isLoading: false,
132 |   })),
133 | }));
134 | 
135 | // Mock child components
136 | jest.mock('../../components/textarea', () => ({
137 |   Textarea: ({ handleInputChange, input, isLoading, status, stop, images, onImagesChange, ...props }: any) => (
138 |     <div data-testid="textarea-mock">
139 |       <textarea
140 |         data-testid="chat-input"
141 |         value={input}
142 |         onChange={handleInputChange}
143 |         disabled={isLoading}
144 |         {...props}
145 |       />
146 |       {images && images.length > 0 && (
147 |         <div data-testid="selected-images">
148 |           {images.map((img: any, index: number) => (
149 |             <div key={index} data-testid={`image-${index}`}>
150 |               {img.metadata.filename}
151 |             </div>
152 |           ))}
153 |         </div>
154 |       )}
155 |       <button
156 |         data-testid="stop-button"
157 |         onClick={stop}
158 |         disabled={status !== 'streaming'}
159 |       >
160 |         Stop
161 |       </button>
162 |     </div>
163 |   ),
164 | }));
165 | 
166 | jest.mock('../../components/project-overview', () => ({
167 |   ProjectOverview: ({ sendMessage, selectedModel }: any) => (
168 |     <div data-testid="project-overview">
169 |       <h2>Project Overview</h2>
170 |       <p>Selected Model: {selectedModel}</p>
171 |       <button onClick={() => sendMessage('Test message')}>
172 |         Send Test Message
173 |       </button>
174 |     </div>
175 |   ),
176 | }));
177 | 
178 | jest.mock('../../components/messages', () => ({
179 |   Messages: ({ messages, isLoading, status }: any) => (
180 |     <div data-testid="messages">
181 |       <div data-testid="messages-count">{messages.length}</div>
182 |       <div data-testid="loading-status">{isLoading ? 'loading' : 'idle'}</div>
183 |       <div data-testid="stream-status">{status}</div>
184 |       {messages.map((msg: any, index: number) => (
185 |         <div key={index} data-testid={`message-${index}`}>
186 |           <span data-testid={`message-role-${index}`}>{msg.role}</span>
187 |           <span data-testid={`message-content-${index}`}>{msg.content}</span>
188 |           {msg.hasWebSearch && <span data-testid={`message-websearch-${index}`}>Web Search</span>}
189 |         </div>
190 |       ))}
191 |     </div>
192 |   ),
193 | }));
194 | 
195 | jest.mock('../../components/mcp-server-manager', () => ({
196 |   MCPServerManager: () => <div data-testid="mcp-server-manager">MCP Manager</div>,
197 | }));
198 | 
199 | jest.mock('../../components/error-boundary', () => ({
200 |   ErrorBoundary: ({ children }: any) => <div data-testid="error-boundary">{children}</div>,
201 | }));
202 | 
203 | // Mock localStorage
204 | const localStorageMock = {
205 |   getItem: jest.fn(),
206 |   setItem: jest.fn(),
207 |   removeItem: jest.fn(),
208 |   clear: jest.fn(),
209 | };
210 | Object.defineProperty(window, 'localStorage', {
211 |   value: localStorageMock,
212 | });
213 | 
214 | // Mock performance API
215 | Object.defineProperty(window, 'performance', {
216 |   value: {
217 |     now: jest.fn(() => Date.now()),
218 |   },
219 | });
220 | 
221 | describe('Chat Component', () => {
222 |   let queryClient: QueryClient;
223 |   let mockUseChat: jest.MockedFunction<any>;
224 |   let mockUseSession: jest.MockedFunction<any>;
225 |   let mockUseModel: jest.MockedFunction<any>;
226 |   let mockUseRouter: jest.MockedFunction<any>;
227 |   let mockUseParams: jest.MockedFunction<any>;
228 |   let mockUseAuth: jest.MockedFunction<any>;
229 | 
230 |   const renderWithProviders = (ui: React.ReactElement) => {
231 |     return render(
232 |       <QueryClientProvider client={queryClient}>
233 |         {ui}
234 |       </QueryClientProvider>
235 |     );
236 |   };
237 | 
238 |   beforeEach(() => {
239 |     queryClient = new QueryClient({
240 |       defaultOptions: {
241 |         queries: { retry: false },
242 |         mutations: { retry: false },
243 |       },
244 |     });
245 |     
246 |     jest.clearAllMocks();
247 |     localStorageMock.getItem.mockReturnValue(null);
248 |     
249 |     // Setup default mocks
250 |     mockUseChat = require('@ai-sdk/react').useChat;
251 |     mockUseSession = require('@/lib/auth-client').useSession;
252 |     mockUseModel = require('@/lib/context/model-context').useModel;
253 |     mockUseRouter = require('next/navigation').useRouter;
254 |     mockUseParams = require('next/navigation').useParams;
255 |     mockUseAuth = require('@/hooks/useAuth').useAuth;
256 |     
257 |     mockUseChat.mockReturnValue({
258 |       messages: [],
259 |       input: '',
260 |       handleInputChange: jest.fn(),
261 |       handleSubmit: jest.fn(),
262 |       append: jest.fn(),
263 |       status: 'idle',
264 |       stop: jest.fn(),
265 |     });
266 |     
267 |     mockUseSession.mockReturnValue({
268 |       data: null,
269 |       isPending: false,
270 |     });
271 |     
272 |     mockUseAuth.mockReturnValue({
273 |       session: null,
274 |       isPending: false,
275 |     });
276 |     
277 |     mockUseModel.mockReturnValue({
278 |       selectedModel: 'gpt-4',
279 |       setSelectedModel: jest.fn(),
280 |     });
281 |     
282 |     mockUseRouter.mockReturnValue({
283 |       push: jest.fn(),
284 |       replace: jest.fn(),
285 |       refresh: jest.fn(),
286 |     });
287 |     
288 |     mockUseParams.mockReturnValue({ id: undefined });
289 |     
290 |     // Mock fetch to return a successful response
291 |     (global.fetch as jest.Mock).mockResolvedValue({
292 |       ok: true,
293 |       json: () => Promise.resolve({}),
294 |     });
295 |   });
296 | 
297 |   describe('Basic Rendering and Props', () => {
298 |     test('renders without crashing', () => {
299 |       renderWithProviders(<Chat />);
300 |       expect(screen.getByTestId('project-overview')).toBeInTheDocument();
301 |       expect(screen.getByTestId('textarea-mock')).toBeInTheDocument();
302 |     });
303 | 
304 |     test('renders project overview when no messages exist', () => {
305 |       renderWithProviders(<Chat />);
306 |       
307 |       expect(screen.getByTestId('project-overview')).toBeInTheDocument();
308 |       expect(screen.getByText('Project Overview')).toBeInTheDocument();
309 |       expect(screen.getByText('Selected Model: gpt-4')).toBeInTheDocument();
310 |     });
311 | 
312 |     test('renders messages when they exist', () => {
313 |       mockUseChat.mockReturnValue({
314 |         messages: [
315 |           { id: '1', role: 'user', content: 'Hello' },
316 |           { id: '2', role: 'assistant', content: 'Hi there!' },
317 |         ],
318 |         input: '',
319 |         handleInputChange: jest.fn(),
320 |         handleSubmit: jest.fn(),
321 |         append: jest.fn(),
322 |         status: 'idle',
323 |         stop: jest.fn(),
324 |       });
325 | 
326 |       renderWithProviders(<Chat />);
327 |       
328 |       expect(screen.getByTestId('messages')).toBeInTheDocument();
329 |       expect(screen.getByTestId('messages-count')).toHaveTextContent('2');
330 |       expect(screen.queryByTestId('project-overview')).not.toBeInTheDocument();
331 |     });
332 | 
333 |     test('shows loading state correctly', () => {
334 |       mockUseChat.mockReturnValue({
335 |         messages: [{ role: 'user', content: 'Test message' }], // Add a message so Messages component is rendered
336 |         input: '',
337 |         handleInputChange: jest.fn(),
338 |         handleSubmit: jest.fn(),
339 |         append: jest.fn(),
340 |         status: 'streaming',
341 |         stop: jest.fn(),
342 |       });
343 | 
344 |       renderWithProviders(<Chat />);
345 |       
346 |       expect(screen.getByTestId('loading-status')).toHaveTextContent('loading');
347 |     });
348 | 
349 |     test('displays selected model in project overview', () => {
350 |       mockUseModel.mockReturnValue({
351 |         selectedModel: 'claude-3-opus',
352 |         setSelectedModel: jest.fn(),
353 |       });
354 | 
355 |       renderWithProviders(<Chat />);
356 |       
357 |       expect(screen.getByText('Selected Model: claude-3-opus')).toBeInTheDocument();
358 |     });
359 |   });
360 | 
361 |   describe('User Interactions', () => {
362 |     test('handles form submission correctly', async () => {
363 |       const mockHandleSubmit = jest.fn();
364 |       mockUseChat.mockReturnValue({
365 |         messages: [],
366 |         input: 'Test message',
367 |         handleInputChange: jest.fn(),
368 |         handleSubmit: mockHandleSubmit,
369 |         append: jest.fn(),
370 |         status: 'idle',
371 |         stop: jest.fn(),
372 |       });
373 | 
374 |       renderWithProviders(<Chat />);
375 |       
376 |       const form = screen.getByTestId('textarea-mock').closest('form');
377 |       if (form) {
378 |         fireEvent.submit(form);
379 |         expect(mockHandleSubmit).toHaveBeenCalled();
380 |       }
381 |     });
382 | 
383 |     test('prevents form submission when input is empty', () => {
384 |       const mockHandleSubmit = jest.fn();
385 |       mockUseChat.mockReturnValue({
386 |         messages: [],
387 |         input: '',
388 |         handleInputChange: jest.fn(),
389 |         handleSubmit: mockHandleSubmit,
390 |         append: jest.fn(),
391 |         status: 'idle',
392 |         stop: jest.fn(),
393 |       });
394 | 
395 |       renderWithProviders(<Chat />);
396 |       
397 |       const form = screen.getByTestId('textarea-mock').closest('form');
398 |       if (form) {
399 |         fireEvent.submit(form);
400 |         // Should not call handleSubmit for empty input
401 |         expect(mockHandleSubmit).not.toHaveBeenCalled();
402 |       }
403 |     });
404 | 
405 |     test('handles suggested message sending', () => {
406 |       const mockAppend = jest.fn();
407 |       mockUseChat.mockReturnValue({
408 |         messages: [],
409 |         input: '',
410 |         handleInputChange: jest.fn(),
411 |         handleSubmit: jest.fn(),
412 |         append: mockAppend,
413 |         status: 'idle',
414 |         stop: jest.fn(),
415 |       });
416 | 
417 |       renderWithProviders(<Chat />);
418 |       
419 |       const sendButton = screen.getByText('Send Test Message');
420 |       fireEvent.click(sendButton);
421 |       
422 |       expect(mockAppend).toHaveBeenCalledWith({
423 |         role: 'user',
424 |         content: 'Test message',
425 |       });
426 |     });
427 | 
428 |     test('handles stop button click', () => {
429 |       const mockStop = jest.fn();
430 |       mockUseChat.mockReturnValue({
431 |         messages: [],
432 |         input: '',
433 |         handleInputChange: jest.fn(),
434 |         handleSubmit: jest.fn(),
435 |         append: jest.fn(),
436 |         status: 'streaming',
437 |         stop: mockStop,
438 |       });
439 | 
440 |       renderWithProviders(<Chat />);
441 |       
442 |       const stopButton = screen.getByTestId('stop-button');
443 |       fireEvent.click(stopButton);
444 |       
445 |       expect(mockStop).toHaveBeenCalled();
446 |     });
447 |   });
448 | 
449 |   describe('State Management', () => {
450 |     test('updates user ID when session changes', async () => {
451 |       const { rerender } = renderWithProviders(<Chat />);
452 |       
453 |       // Initially no session
454 |       expect(mockUseAuth).toHaveBeenCalled();
455 |       
456 |       // Update session
457 |       mockUseAuth.mockReturnValue({
458 |         session: { user: { id: 'user123' } },
459 |         isPending: false,
460 |       });
461 |       
462 |       rerender(
463 |         <QueryClientProvider client={queryClient}>
464 |           <Chat />
465 |         </QueryClientProvider>
466 |       );
467 |       
468 |       // Component should handle the session change
469 |       await waitFor(() => {
470 |         expect(mockUseAuth).toHaveBeenCalled();
471 |       });
472 |     });
473 | 
474 |     test('generates chat ID for new chats', () => {
475 |       renderWithProviders(<Chat />);
476 |       
477 |       // Should render without errors even without chat ID
478 |       expect(screen.getByTestId('project-overview')).toBeInTheDocument();
479 |     });
480 | 
481 |     test('handles image selection and removal', () => {
482 |       renderWithProviders(<Chat />);
483 |       
484 |       // Initially no images
485 |       expect(screen.queryByTestId('selected-images')).not.toBeInTheDocument();
486 |       
487 |       // This would be tested through the Textarea component integration
488 |       // The actual image handling logic is complex and would require more detailed mocking
489 |     });
490 |   });
491 | 
492 |   describe('Error Handling', () => {
493 |     test('handles chat loading errors gracefully', async () => {
494 |       // Mock a failed query by setting invalid data
495 |       queryClient.setQueryData(['chat', 'test-id'], null);
496 | 
497 |       mockUseParams.mockReturnValue({ id: 'test-id' });
498 | 
499 |       renderWithProviders(<Chat />);
500 |       
501 |       // Should still render the component
502 |       expect(screen.getByTestId('textarea-mock')).toBeInTheDocument();
503 |     });
504 | 
505 |     test('displays error recovery banner when needed', async () => {
506 |       // Skip this test for now as the error recovery banner logic is complex
507 |       // and requires precise timing that's difficult to test
508 |       expect(true).toBe(true);
509 |     });
510 | 
511 |     test('handles authentication errors', async () => {
512 |       const mockOnError = jest.fn();
513 |       mockUseChat.mockReturnValue({
514 |         messages: [],
515 |         input: '',
516 |         handleInputChange: jest.fn(),
517 |         handleSubmit: jest.fn(),
518 |         append: jest.fn(),
519 |         status: 'idle',
520 |         stop: jest.fn(),
521 |         onError: mockOnError,
522 |       });
523 | 
524 |       renderWithProviders(<Chat />);
525 |       
526 |       // Simulate authentication error
527 |       const onError = mockUseChat.mock.calls[0][0].onError;
528 |       if (onError) {
529 |         act(() => {
530 |           onError(new Error(JSON.stringify({
531 |             error: {
532 |               code: 'AUTHENTICATION_REQUIRED',
533 |               message: 'Authentication required',
534 |             }
535 |           })));
536 |         });
537 |       }
538 | 
539 |       await waitFor(() => {
540 |         expect(toast.error).toHaveBeenCalledWith(
541 |           'Authentication required. Please log in to continue.',
542 |           expect.any(Object)
543 |         );
544 |       });
545 |     });
546 | 
547 |     test('handles rate limit errors', async () => {
548 |       renderWithProviders(<Chat />);
549 |       
550 |       const onError = mockUseChat.mock.calls[0][0].onError;
551 |       if (onError) {
552 |         act(() => {
553 |           onError(new Error(JSON.stringify({
554 |             error: {
555 |               code: 'RATE_LIMIT_EXCEEDED',
556 |               message: 'Rate limit exceeded',
557 |             }
558 |           })));
559 |         });
560 |       }
561 | 
562 |       await waitFor(() => {
563 |         expect(toast.error).toHaveBeenCalledWith(
564 |           'Too many requests. Please wait a moment and try again.',
565 |           expect.any(Object)
566 |         );
567 |       });
568 |     });
569 |   });
570 | 
571 |   describe('API Integration', () => {
572 |     test('passes correct parameters to useChat', () => {
573 |       mockUseModel.mockReturnValue({
574 |         selectedModel: 'claude-3-opus',
575 |         setSelectedModel: jest.fn(),
576 |       });
577 | 
578 |       renderWithProviders(<Chat />);
579 |       
580 |       expect(mockUseChat).toHaveBeenCalledWith(
581 |         expect.objectContaining({
582 |           maxSteps: 20,
583 |           body: expect.objectContaining({
584 |             selectedModel: 'claude-3-opus',
585 |             mcpServers: [],
586 |             webSearch: expect.objectContaining({
587 |               enabled: false,
588 |               contextSize: 5,
589 |             }),
590 |             apiKeys: {},
591 |             attachments: [],
592 |           }),
593 |         })
594 |       );
595 |     });
596 | 
597 |     test('includes API keys from localStorage', () => {
598 |       localStorageMock.getItem.mockImplementation((key) => {
599 |         if (key === 'OPENAI_API_KEY') return 'sk-test123';
600 |         if (key === 'ANTHROPIC_API_KEY') return 'sk-ant-test456';
601 |         return null;
602 |       });
603 | 
604 |       renderWithProviders(<Chat />);
605 |       
606 |       expect(mockUseChat).toHaveBeenCalledWith(
607 |         expect.objectContaining({
608 |           body: expect.objectContaining({
609 |             apiKeys: {
610 |               OPENAI_API_KEY: 'sk-test123',
611 |               ANTHROPIC_API_KEY: 'sk-ant-test456',
612 |             },
613 |           }),
614 |         })
615 |       );
616 |     });
617 | 
618 |     test('handles successful message completion', async () => {
619 |       const mockQueryClientInvalidate = jest.spyOn(queryClient, 'invalidateQueries');
620 |       
621 |       renderWithProviders(<Chat />);
622 |       
623 |       const onFinish = mockUseChat.mock.calls[0][0].onFinish;
624 |       if (onFinish) {
625 |         act(() => {
626 |           onFinish({ id: '1', role: 'assistant', content: 'Response' });
627 |         });
628 |       }
629 | 
630 |       await waitFor(() => {
631 |         expect(mockQueryClientInvalidate).toHaveBeenCalledWith({ queryKey: ['chats'] });
632 |       });
633 |     });
634 |   });
635 | 
636 |   describe('Accessibility', () => {
637 |     test('has proper ARIA structure', () => {
638 |       renderWithProviders(<Chat />);
639 |       
640 |       // Main chat container should have proper structure
641 |       const chatContainer = screen.getByTestId('textarea-mock').closest('div');
642 |       expect(chatContainer).toBeInTheDocument();
643 |     });
644 | 
645 |     test('handles keyboard navigation', () => {
646 |       renderWithProviders(<Chat />);
647 |       
648 |       const input = screen.getByTestId('chat-input');
649 |       expect(input).toBeInTheDocument();
650 |       
651 |       // Test keyboard interaction
652 |       fireEvent.keyDown(input, { key: 'Enter' });
653 |       // The actual keyboard handling would be tested in the Textarea component
654 |     });
655 | 
656 |     test('supports screen readers', () => {
657 |       renderWithProviders(<Chat />);
658 |       
659 |       // Check that important elements are accessible
660 |       expect(screen.getByTestId('chat-input')).toBeInTheDocument();
661 |       expect(screen.getByTestId('project-overview')).toBeInTheDocument();
662 |     });
[TRUNCATED]
```

__tests__/components/checkout-button.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent } from '@testing-library/react';
3 | import { CheckoutButton } from '../../components/checkout-button';
4 | 
5 | // Mock the useAuth hook
6 | const mockPush = jest.fn();
7 | const mockUseAuth = jest.fn();
8 | 
9 | jest.mock('../../hooks/useAuth', () => ({
10 |   useAuth: () => mockUseAuth(),
11 | }));
12 | 
13 | // Mock Next.js navigation
14 | jest.mock('next/navigation', () => ({
15 |   useRouter: () => ({
16 |     push: mockPush,
17 |   }),
18 | }));
19 | 
20 | // Mock the Button component
21 | jest.mock('../../components/ui/button', () => ({
22 |   Button: ({ children, onClick, className, ...props }: any) => (
23 |     <button onClick={onClick} className={className} {...props}>
24 |       {children}
25 |     </button>
26 |   ),
27 | }));
28 | 
29 | // Mock lucide-react icons
30 | jest.mock('lucide-react', () => ({
31 |   CreditCard: ({ className }: any) => <div className={className} data-testid="credit-card-icon" />,
32 | }));
33 | 
34 | // Mock window.location to prevent JSDOM navigation errors
35 | const mockLocation = {
36 |   href: '',
37 |   assign: jest.fn(),
38 |   reload: jest.fn(),
39 |   replace: jest.fn(),
40 | };
41 | 
42 | // Store original location for restoration
43 | const originalLocation = window.location;
44 | 
45 | // Set up location mock
46 | beforeAll(() => {
47 |   delete (window as any).location;
48 |   window.location = mockLocation as any;
49 | });
50 | 
51 | // Restore original location after all tests
52 | afterAll(() => {
53 |   if (originalLocation) {
54 |     delete (window as any).location;
55 |     window.location = originalLocation;
56 |   }
57 | });
58 | 
59 | describe('CheckoutButton Component', () => {
60 |   beforeEach(() => {
61 |     jest.clearAllMocks();
62 |     mockLocation.href = '';
63 |   });
64 | 
65 |   describe('Anonymous User', () => {
66 |     beforeEach(() => {
67 |       mockUseAuth.mockReturnValue({
68 |         user: null,
69 |         isAnonymous: true,
70 |         isAuthenticated: false,
71 |       });
72 |     });
73 | 
74 |     it('renders with sign in text for anonymous users', () => {
75 |       render(<CheckoutButton />);
76 |       
77 |       const button = screen.getByRole('button');
78 |       expect(button).toBeInTheDocument();
79 |       expect(button).toHaveTextContent('Sign In to Purchase Credits');
80 |     });
81 | 
82 |     it('displays credit card icon', () => {
83 |       render(<CheckoutButton />);
84 |       
85 |       const icon = screen.getByTestId('credit-card-icon');
86 |       expect(icon).toBeInTheDocument();
87 |       expect(icon).toHaveClass('mr-2 h-4 w-4');
88 |     });
89 | 
90 |     it('has full width styling', () => {
91 |       render(<CheckoutButton />);
92 |       
93 |       const button = screen.getByRole('button');
94 |       expect(button).toHaveClass('w-full');
95 |     });
96 | 
97 |         it('calls router.push when clicked', () => {
98 |       render(<CheckoutButton />);
99 |       
100 |       const button = screen.getByRole('button');
101 |       fireEvent.click(button);
102 |       
103 |       expect(mockPush).toHaveBeenCalledWith('/api/auth/sign-in/google');
104 |     });
105 |   });
106 | 
107 |   describe('Unauthenticated User', () => {
108 |     beforeEach(() => {
109 |       mockUseAuth.mockReturnValue({
110 |         user: null,
111 |         isAnonymous: false,
112 |         isAuthenticated: false,
113 |       });
114 |     });
115 | 
116 |     it('renders with sign in text for unauthenticated users', () => {
117 |       render(<CheckoutButton />);
118 |       
119 |       const button = screen.getByRole('button');
120 |       expect(button).toHaveTextContent('Sign In to Purchase Credits');
121 |     });
122 | 
123 |         it('calls router.push when clicked', () => {
124 |       render(<CheckoutButton />);
125 |       
126 |       const button = screen.getByRole('button');
127 |       fireEvent.click(button);
128 |       
129 |       expect(mockPush).toHaveBeenCalledWith('/api/auth/sign-in/google');
130 |     });
131 |   });
132 | 
133 |   describe('Authenticated User', () => {
134 |     beforeEach(() => {
135 |       mockUseAuth.mockReturnValue({
136 |         user: {
137 |           id: 'user-123',
138 |           name: 'John Doe',
139 |           email: 'john@example.com',
140 |           isAnonymous: false,
141 |         },
142 |         isAnonymous: false,
143 |         isAuthenticated: true,
144 |       });
145 |     });
146 | 
147 |     it('renders with purchase credits text for authenticated users', () => {
148 |       render(<CheckoutButton />);
149 |       
150 |       const button = screen.getByRole('button');
151 |       expect(button).toHaveTextContent('Purchase More Credits');
152 |     });
153 | 
154 |     it('does not call router.push when clicked (uses window.location)', () => {
155 |       render(<CheckoutButton />);
156 |       
157 |       const button = screen.getByRole('button');
158 |       
159 |       // Since window.location.href is difficult to test in JSDOM,
160 |       // we'll just verify that router.push is NOT called for authenticated users
161 |       fireEvent.click(button);
162 |       
163 |       expect(mockPush).not.toHaveBeenCalled();
164 |     });
165 | 
166 |     it('displays credit card icon', () => {
167 |       render(<CheckoutButton />);
168 |       
169 |       const icon = screen.getByTestId('credit-card-icon');
170 |       expect(icon).toBeInTheDocument();
171 |     });
172 |   });
173 | 
174 |   describe('Edge Cases', () => {
175 |     it('handles authenticated user with anonymous flag set to true', () => {
176 |       mockUseAuth.mockReturnValue({
177 |         user: {
178 |           id: 'user-123',
179 |           name: 'Anonymous User',
180 |           isAnonymous: true,
181 |         },
182 |         isAnonymous: true,
183 |         isAuthenticated: true,
184 |       });
185 | 
186 |       render(<CheckoutButton />);
187 |       
188 |       const button = screen.getByRole('button');
189 |       expect(button).toHaveTextContent('Sign In to Purchase Credits');
190 |       
191 |       fireEvent.click(button);
192 |       expect(mockPush).toHaveBeenCalledWith('/api/auth/sign-in/google');
193 |     });
194 | 
195 |     it('handles user object present but not authenticated', () => {
196 |       mockUseAuth.mockReturnValue({
197 |         user: {
198 |           id: 'user-123',
199 |           name: 'John Doe',
200 |         },
201 |         isAnonymous: false,
202 |         isAuthenticated: false,
203 |       });
204 | 
205 |       render(<CheckoutButton />);
206 |       
207 |       const button = screen.getByRole('button');
208 |       expect(button).toHaveTextContent('Sign In to Purchase Credits');
209 |       
210 |       fireEvent.click(button);
211 |       expect(mockPush).toHaveBeenCalledWith('/api/auth/sign-in/google');
212 |     });
213 | 
214 |     it('handles loading state gracefully', () => {
215 |       mockUseAuth.mockReturnValue({
216 |         user: null,
217 |         isAnonymous: false,
218 |         isAuthenticated: false,
219 |       });
220 | 
221 |       render(<CheckoutButton />);
222 |       
223 |       const button = screen.getByRole('button');
224 |       expect(button).toBeInTheDocument();
225 |       expect(button).toHaveTextContent('Sign In to Purchase Credits');
226 |     });
227 |   });
228 | 
229 |   describe('Accessibility', () => {
230 |     it('renders as a proper button element', () => {
231 |       mockUseAuth.mockReturnValue({
232 |         user: null,
233 |         isAnonymous: true,
234 |         isAuthenticated: false,
235 |       });
236 | 
237 |       render(<CheckoutButton />);
238 |       
239 |       const button = screen.getByRole('button');
240 |       expect(button.tagName).toBe('BUTTON');
241 |     });
242 | 
243 |     it('is keyboard accessible', () => {
244 |       mockUseAuth.mockReturnValue({
245 |         user: null,
246 |         isAnonymous: true,
247 |         isAuthenticated: false,
248 |       });
249 | 
250 |       render(<CheckoutButton />);
251 |       
252 |       const button = screen.getByRole('button');
253 |       button.focus();
254 |       expect(document.activeElement).toBe(button);
255 |     });
256 |   });
257 | 
258 |   describe('Component Structure', () => {
259 |     it('renders icon and text in correct order', () => {
260 |       mockUseAuth.mockReturnValue({
261 |         user: null,
262 |         isAnonymous: true,
263 |         isAuthenticated: false,
264 |       });
265 | 
266 |       render(<CheckoutButton />);
267 |       
268 |       const button = screen.getByRole('button');
269 |       const icon = screen.getByTestId('credit-card-icon');
270 |       
271 |       expect(button).toContainElement(icon);
272 |       expect(icon).toHaveClass('mr-2');
273 |     });
274 | 
275 |     it('applies correct CSS classes', () => {
276 |       mockUseAuth.mockReturnValue({
277 |         user: null,
278 |         isAnonymous: true,
279 |         isAuthenticated: false,
280 |       });
281 | 
282 |       render(<CheckoutButton />);
283 |       
284 |       const button = screen.getByRole('button');
285 |       expect(button).toHaveClass('w-full');
286 |     });
287 |   });
288 | });
```

__tests__/components/citation.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent } from '@testing-library/react';
3 | import { Citations } from '../../components/citation';
4 | 
5 | // Mock the motion component
6 | jest.mock('motion/react', () => ({
7 |   motion: {
8 |     div: ({ children, ...props }: any) => <div {...props}>{children}</div>,
9 |   },
10 |   AnimatePresence: ({ children }: any) => <div>{children}</div>,
11 | }));
12 | 
13 | // Mock lucide-react icons
14 | jest.mock('lucide-react', () => ({
15 |   ExternalLinkIcon: ({ size, className }: any) => (
16 |     <svg data-testid="external-link-icon" width={size} height={size} className={className} />
17 |   ),
18 |   ChevronDownIcon: ({ size }: any) => (
19 |     <svg data-testid="chevron-down-icon" width={size} height={size} />
20 |   ),
21 |   ChevronUpIcon: ({ size }: any) => (
22 |     <svg data-testid="chevron-up-icon" width={size} height={size} />
23 |   ),
24 | }));
25 | 
26 | describe('Citations Component', () => {
27 |   const mockCitations = [
28 |     {
29 |       url: 'https://example.com/article1',
30 |       title: 'Example Article 1',
31 |       content: 'This is the content of the first article that provides useful information.',
32 |       startIndex: 0,
33 |       endIndex: 10,
34 |     },
35 |     {
36 |       url: 'https://example.com/article2',
37 |       title: 'Example Article 2',
38 |       content: 'This is the content of the second article with more details.',
39 |       startIndex: 11,
40 |       endIndex: 20,
41 |     },
42 |     {
43 |       url: 'https://example.com/article3',
44 |       title: 'Example Article 3',
45 |       // No content for this citation
46 |       startIndex: 21,
47 |       endIndex: 30,
48 |     },
49 |   ];
50 | 
51 |   const singleCitation = [
52 |     {
53 |       url: 'https://example.com/single',
54 |       title: 'Single Article',
55 |       content: 'Content for single article',
56 |       startIndex: 0,
57 |       endIndex: 5,
58 |     },
59 |   ];
60 | 
61 |   // Tests for Basic Rendering and Props
62 |   describe('Basic Rendering and Props', () => {
63 |     test('renders nothing when citations array is empty', () => {
64 |       const { container } = render(<Citations citations={[]} />);
65 |       expect(container.firstChild).toBeNull();
66 |     });
67 | 
68 |     test('renders nothing when citations is undefined', () => {
69 |       const { container } = render(<Citations citations={undefined as any} />);
70 |       expect(container.firstChild).toBeNull();
71 |     });
72 | 
73 |     test('renders toggle button with correct citation count for single citation', () => {
74 |       render(<Citations citations={singleCitation} />);
75 |       
76 |       expect(screen.getByText('1 citation')).toBeInTheDocument();
77 |       expect(screen.getByTestId('chevron-down-icon')).toBeInTheDocument();
78 |     });
79 | 
80 |     test('renders toggle button with correct citation count for multiple citations', () => {
81 |       render(<Citations citations={mockCitations} />);
82 |       
83 |       expect(screen.getByText('3 citations')).toBeInTheDocument();
84 |       expect(screen.getByTestId('chevron-down-icon')).toBeInTheDocument();
85 |     });
86 | 
87 |     test('renders with proper CSS classes for toggle button', () => {
88 |       render(<Citations citations={mockCitations} />);
89 |       
90 |       const toggleButton = screen.getByRole('button');
91 |       expect(toggleButton).toHaveClass(
92 |         'flex',
93 |         'items-center',
94 |         'gap-1.5',
95 |         'text-xs',
96 |         'text-muted-foreground/70'
97 |       );
98 |     });
99 |   });
100 | 
101 |   // Tests for User Interactions
102 |   describe('User Interactions', () => {
103 |     test('expands citation list when toggle button is clicked', () => {
104 |       render(<Citations citations={mockCitations} />);
105 |       
106 |       const toggleButton = screen.getByRole('button');
107 |       
108 |       // Initially collapsed - citations should not be visible
109 |       expect(screen.queryByText('Example Article 1')).not.toBeInTheDocument();
110 |       
111 |       // Click to expand
112 |       fireEvent.click(toggleButton);
113 |       
114 |       // Citations should now be visible
115 |       expect(screen.getByText('Example Article 1')).toBeInTheDocument();
116 |       expect(screen.getByText('Example Article 2')).toBeInTheDocument();
117 |       expect(screen.getByText('Example Article 3')).toBeInTheDocument();
118 |     });
119 | 
120 |     test('collapses citation list when toggle button is clicked twice', () => {
121 |       render(<Citations citations={mockCitations} />);
122 |       
123 |       const toggleButton = screen.getByRole('button');
124 |       
125 |       // Expand first
126 |       fireEvent.click(toggleButton);
127 |       expect(screen.getByText('Example Article 1')).toBeInTheDocument();
128 |       
129 |       // Collapse again
130 |       fireEvent.click(toggleButton);
131 |       expect(screen.queryByText('Example Article 1')).not.toBeInTheDocument();
132 |     });
133 | 
134 |     test('changes chevron icon when expanding/collapsing', () => {
135 |       render(<Citations citations={mockCitations} />);
136 |       
137 |       const toggleButton = screen.getByRole('button');
138 |       
139 |       // Initially shows down chevron
140 |       expect(screen.getByTestId('chevron-down-icon')).toBeInTheDocument();
141 |       expect(screen.queryByTestId('chevron-up-icon')).not.toBeInTheDocument();
142 |       
143 |       // After clicking, shows up chevron
144 |       fireEvent.click(toggleButton);
145 |       expect(screen.getByTestId('chevron-up-icon')).toBeInTheDocument();
146 |       expect(screen.queryByTestId('chevron-down-icon')).not.toBeInTheDocument();
147 |       
148 |       // After clicking again, shows down chevron
149 |       fireEvent.click(toggleButton);
150 |       expect(screen.getByTestId('chevron-down-icon')).toBeInTheDocument();
151 |       expect(screen.queryByTestId('chevron-up-icon')).not.toBeInTheDocument();
152 |     });
153 | 
154 |     test('citation links are clickable and have proper attributes', () => {
155 |       render(<Citations citations={mockCitations} />);
156 |       
157 |       // Expand to see citations
158 |       fireEvent.click(screen.getByRole('button'));
159 |       
160 |       const firstLink = screen.getByRole('link', { name: /example article 1/i });
161 |       expect(firstLink).toHaveAttribute('href', 'https://example.com/article1');
162 |       expect(firstLink).toHaveAttribute('target', '_blank');
163 |       expect(firstLink).toHaveAttribute('rel', 'noopener noreferrer');
164 |     });
165 |   });
166 | 
167 |   // Tests for Citation Content Display
168 |   describe('Citation Content Display', () => {
169 |     test('displays citation titles as clickable links', () => {
170 |       render(<Citations citations={mockCitations} />);
171 |       
172 |       // Expand citations
173 |       fireEvent.click(screen.getByRole('button'));
174 |       
175 |       expect(screen.getByRole('link', { name: /example article 1/i })).toBeInTheDocument();
176 |       expect(screen.getByRole('link', { name: /example article 2/i })).toBeInTheDocument();
177 |       expect(screen.getByRole('link', { name: /example article 3/i })).toBeInTheDocument();
178 |     });
179 | 
180 |     test('displays citation content when available', () => {
181 |       render(<Citations citations={mockCitations} />);
182 |       
183 |       // Expand citations
184 |       fireEvent.click(screen.getByRole('button'));
185 |       
186 |       expect(screen.getByText('This is the content of the first article that provides useful information.')).toBeInTheDocument();
187 |       expect(screen.getByText('This is the content of the second article with more details.')).toBeInTheDocument();
188 |     });
189 | 
190 |     test('does not display content paragraph when citation has no content', () => {
191 |       render(<Citations citations={mockCitations} />);
192 |       
193 |       // Expand citations
194 |       fireEvent.click(screen.getByRole('button'));
195 |       
196 |       // The third citation has no content, so it shouldn't have a content paragraph
197 |       const citationCards = screen.getAllByRole('link').map(link => link.closest('div'));
198 |       const thirdCard = citationCards[2];
199 |       
200 |       expect(thirdCard?.querySelector('p')).not.toBeInTheDocument();
201 |     });
202 | 
203 |     test('displays external link icons for all citation links', () => {
204 |       render(<Citations citations={mockCitations} />);
205 |       
206 |       // Expand citations
207 |       fireEvent.click(screen.getByRole('button'));
208 |       
209 |       const externalLinkIcons = screen.getAllByTestId('external-link-icon');
210 |       expect(externalLinkIcons).toHaveLength(3);
211 |     });
212 | 
213 |     test('applies proper CSS classes to citation cards', () => {
214 |       render(<Citations citations={singleCitation} />);
215 |       
216 |       // Expand citations
217 |       fireEvent.click(screen.getByRole('button'));
218 |       
219 |       // The citation card is the container div, not the link's parent
220 |       const citationCard = screen.getByRole('link').closest('div')?.parentElement;
221 |       expect(citationCard).toHaveClass(
222 |         'text-sm',
223 |         'border',
224 |         'border-border/30',
225 |         'rounded-lg',
226 |         'p-3',
227 |         'bg-muted/10'
228 |       );
229 |     });
230 |   });
231 | 
232 |   // Tests for Accessibility
233 |   describe('Accessibility', () => {
234 |     test('toggle button is keyboard accessible', () => {
235 |       render(<Citations citations={mockCitations} />);
236 |       
237 |       const toggleButton = screen.getByRole('button');
238 |       
239 |       // Test Enter key
240 |       fireEvent.keyDown(toggleButton, { key: 'Enter', code: 'Enter' });
241 |       // Note: Since we're not testing actual keyboard activation behavior,
242 |       // we just ensure the button exists and is focusable
243 |       expect(toggleButton).toBeInTheDocument();
244 |       expect(toggleButton).not.toHaveAttribute('disabled');
245 |     });
246 | 
247 |     test('citation links have proper accessibility attributes', () => {
248 |       render(<Citations citations={mockCitations} />);
249 |       
250 |       // Expand citations
251 |       fireEvent.click(screen.getByRole('button'));
252 |       
253 |       const links = screen.getAllByRole('link');
254 |       links.forEach(link => {
255 |         expect(link).toHaveAttribute('target', '_blank');
256 |         expect(link).toHaveAttribute('rel', 'noopener noreferrer');
257 |       });
258 |     });
259 | 
260 |     test('toggle button has descriptive text', () => {
261 |       render(<Citations citations={mockCitations} />);
262 |       
263 |       const toggleButton = screen.getByRole('button');
264 |       expect(toggleButton).toHaveTextContent('3 citations');
265 |     });
266 | 
267 |     test('citation content has proper text styling for readability', () => {
268 |       render(<Citations citations={mockCitations} />);
269 |       
270 |       // Expand citations
271 |       fireEvent.click(screen.getByRole('button'));
272 |       
273 |       const contentParagraphs = screen.getAllByText(/this is the content/i);
274 |       contentParagraphs.forEach(paragraph => {
275 |         expect(paragraph).toHaveClass('mt-1.5', 'text-xs', 'text-muted-foreground', 'line-clamp-3');
276 |       });
277 |     });
278 |   });
279 | 
280 |   // Tests for Edge Cases
281 |   describe('Edge Cases', () => {
282 |     test('handles citations with empty titles', () => {
283 |       const citationsWithEmptyTitle = [
284 |         {
285 |           url: 'https://example.com/no-title',
286 |           title: '',
287 |           content: 'Content without title',
288 |           startIndex: 0,
289 |           endIndex: 5,
290 |         },
291 |       ];
292 |       
293 |       render(<Citations citations={citationsWithEmptyTitle} />);
294 |       
295 |       // Expand citations
296 |       fireEvent.click(screen.getByRole('button'));
297 |       
298 |       // Should still render the link even with empty title
299 |       const link = screen.getByRole('link');
300 |       expect(link).toHaveAttribute('href', 'https://example.com/no-title');
301 |     });
302 | 
303 |     test('handles citations with very long content', () => {
304 |       const longContent = 'A'.repeat(500);
305 |       const citationsWithLongContent = [
306 |         {
307 |           url: 'https://example.com/long-content',
308 |           title: 'Long Content Article',
309 |           content: longContent,
310 |           startIndex: 0,
311 |           endIndex: 5,
312 |         },
313 |       ];
314 |       
315 |       render(<Citations citations={citationsWithLongContent} />);
316 |       
317 |       // Expand citations
318 |       fireEvent.click(screen.getByRole('button'));
319 |       
320 |       expect(screen.getByText(longContent)).toBeInTheDocument();
321 |       
322 |       // Should have line-clamp class for truncation
323 |       const contentElement = screen.getByText(longContent);
324 |       expect(contentElement).toHaveClass('line-clamp-3');
325 |     });
326 | 
327 |     test('handles malformed URLs gracefully', () => {
328 |       const citationsWithBadUrl = [
329 |         {
330 |           url: 'not-a-valid-url',
331 |           title: 'Bad URL Article',
332 |           content: 'Content with bad URL',
333 |           startIndex: 0,
334 |           endIndex: 5,
335 |         },
336 |       ];
337 |       
338 |       render(<Citations citations={citationsWithBadUrl} />);
339 |       
340 |       // Expand citations
341 |       fireEvent.click(screen.getByRole('button'));
342 |       
343 |       const link = screen.getByRole('link');
344 |       expect(link).toHaveAttribute('href', 'not-a-valid-url');
345 |       // Browser will handle the invalid URL appropriately
346 |     });
347 |   });
348 | 
349 |   // Integration Tests
350 |   describe('Integration Tests', () => {
351 |     test('complete expand and collapse workflow works correctly', () => {
352 |       render(<Citations citations={mockCitations} />);
353 |       
354 |       const toggleButton = screen.getByRole('button');
355 |       
356 |       // Initial state: collapsed
357 |       expect(screen.queryByText('Example Article 1')).not.toBeInTheDocument();
358 |       expect(screen.getByTestId('chevron-down-icon')).toBeInTheDocument();
359 |       
360 |       // First click: expand
361 |       fireEvent.click(toggleButton);
362 |       expect(screen.getByText('Example Article 1')).toBeInTheDocument();
363 |       expect(screen.getByText('Example Article 2')).toBeInTheDocument();
364 |       expect(screen.getByText('Example Article 3')).toBeInTheDocument();
365 |       expect(screen.getByTestId('chevron-up-icon')).toBeInTheDocument();
366 |       
367 |       // Second click: collapse
368 |       fireEvent.click(toggleButton);
369 |       expect(screen.queryByText('Example Article 1')).not.toBeInTheDocument();
370 |       expect(screen.queryByText('Example Article 2')).not.toBeInTheDocument();
371 |       expect(screen.queryByText('Example Article 3')).not.toBeInTheDocument();
372 |       expect(screen.getByTestId('chevron-down-icon')).toBeInTheDocument();
373 |     });
374 | 
375 |     test('multiple rapid clicks work correctly', () => {
376 |       render(<Citations citations={mockCitations} />);
377 |       
378 |       const toggleButton = screen.getByRole('button');
379 |       
380 |       // Rapid clicks
381 |       fireEvent.click(toggleButton); // expand
382 |       fireEvent.click(toggleButton); // collapse
383 |       fireEvent.click(toggleButton); // expand
384 |       fireEvent.click(toggleButton); // collapse
385 |       fireEvent.click(toggleButton); // expand
386 |       
387 |       // Should end in expanded state
388 |       expect(screen.getByText('Example Article 1')).toBeInTheDocument();
389 |       expect(screen.getByTestId('chevron-up-icon')).toBeInTheDocument();
390 |     });
391 | 
392 |     test('works correctly with single citation', () => {
393 |       render(<Citations citations={singleCitation} />);
394 |       
395 |       // Should show singular form
396 |       expect(screen.getByText('1 citation')).toBeInTheDocument();
397 |       
398 |       // Expand and verify single citation displays
399 |       fireEvent.click(screen.getByRole('button'));
400 |       expect(screen.getByText('Single Article')).toBeInTheDocument();
401 |       expect(screen.getByText('Content for single article')).toBeInTheDocument();
402 |       
403 |       // Should have exactly one citation link
404 |       const links = screen.getAllByRole('link');
405 |       expect(links).toHaveLength(1);
406 |       expect(links[0]).toHaveAttribute('href', 'https://example.com/single');
407 |     });
408 |   });
409 | });
```

__tests__/components/copy-button.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { CopyButton } from '../../components/copy-button';
4 | 
5 | // Mock the useCopy hook
6 | const mockCopy = jest.fn();
7 | const mockCopied = jest.fn();
8 | 
9 | jest.mock('../../lib/hooks/use-copy', () => ({
10 |   useCopy: () => ({
11 |     copied: mockCopied(),
12 |     copy: mockCopy,
13 |   }),
14 | }));
15 | 
16 | // Mock the Button component
17 | jest.mock('../../components/ui/button', () => ({
18 |   Button: ({ children, onClick, variant, size, className, title, ...props }: any) => (
19 |     <button 
20 |       type="button"
21 |       onClick={onClick} 
22 |       className={className}
23 |       title={title}
24 |       data-variant={variant}
25 |       data-size={size}
26 |       data-testid="copy-button"
27 |       {...props}
28 |     >
29 |       {children}
30 |     </button>
31 |   ),
32 | }));
33 | 
34 | // Mock Lucide React icons
35 | jest.mock('lucide-react', () => ({
36 |   CheckIcon: ({ className }: any) => (
37 |     <div data-testid="check-icon" className={className}>✓</div>
38 |   ),
39 |   CopyIcon: ({ className }: any) => (
40 |     <div data-testid="copy-icon" className={className}>📋</div>
41 |   ),
42 | }));
43 | 
44 | // Mock the cn utility
45 | jest.mock('../../lib/utils', () => ({
46 |   cn: (...classes: any[]) => classes.filter(Boolean).join(' '),
47 | }));
48 | 
49 | describe('CopyButton Component', () => {
50 |   const defaultProps = {
51 |     text: 'Hello, World!',
52 |   };
53 | 
54 |   beforeEach(() => {
55 |     jest.clearAllMocks();
56 |     mockCopied.mockReturnValue(false);
57 |     mockCopy.mockImplementation(() => Promise.resolve(true));
58 |   });
59 | 
60 |   describe('Basic Rendering and Props', () => {
61 |     test('renders copy button with default state', () => {
62 |       render(<CopyButton {...defaultProps} />);
63 |       
64 |       const button = screen.getByTestId('copy-button');
65 |       expect(button).toBeInTheDocument();
66 |       expect(button).toHaveAttribute('title', 'Copy to clipboard');
67 |       expect(button).toHaveAttribute('data-variant', 'ghost');
68 |       expect(button).toHaveAttribute('data-size', 'sm');
69 |     });
70 | 
71 |     test('renders with copy icon and text when not copied', () => {
72 |       render(<CopyButton {...defaultProps} />);
73 |       
74 |       expect(screen.getByTestId('copy-icon')).toBeInTheDocument();
75 |       expect(screen.getByText('Copy')).toBeInTheDocument();
76 |       expect(screen.queryByTestId('check-icon')).not.toBeInTheDocument();
77 |       expect(screen.queryByText('Copied!')).not.toBeInTheDocument();
78 |     });
79 | 
80 |     test('renders with check icon and text when copied', () => {
81 |       mockCopied.mockReturnValue(true);
82 |       
83 |       render(<CopyButton {...defaultProps} />);
84 |       
85 |       expect(screen.getByTestId('check-icon')).toBeInTheDocument();
86 |       expect(screen.getByText('Copied!')).toBeInTheDocument();
87 |       expect(screen.queryByTestId('copy-icon')).not.toBeInTheDocument();
88 |       expect(screen.queryByText('Copy')).not.toBeInTheDocument();
89 |     });
90 | 
91 |     test('applies custom className when provided', () => {
92 |       const customClass = 'custom-copy-button';
93 |       render(<CopyButton {...defaultProps} className={customClass} />);
94 |       
95 |       const button = screen.getByTestId('copy-button');
96 |       expect(button).toHaveClass(customClass);
97 |     });
98 | 
99 |     test('applies default CSS classes for responsive behavior', () => {
100 |       render(<CopyButton {...defaultProps} />);
101 |       
102 |       const button = screen.getByTestId('copy-button');
103 |       const expectedClasses = [
104 |         'transition-opacity',
105 |         'opacity-0',
106 |         'group-hover/message:opacity-100',
107 |         'gap-1.5',
108 |         'sm:opacity-0',
109 |         'sm:group-hover/message:opacity-100',
110 |         'opacity-100'
111 |       ];
112 |       
113 |       expectedClasses.forEach(className => {
114 |         expect(button).toHaveClass(className);
115 |       });
116 |     });
117 |   });
118 | 
119 |   describe('User Interactions', () => {
120 |     test('calls copy function with correct text when clicked', () => {
121 |       const testText = 'Test content to copy';
122 |       render(<CopyButton text={testText} />);
123 |       
124 |       const button = screen.getByTestId('copy-button');
125 |       fireEvent.click(button);
126 |       
127 |       expect(mockCopy).toHaveBeenCalledTimes(1);
128 |       expect(mockCopy).toHaveBeenCalledWith(testText);
129 |     });
130 | 
131 |     test('handles multiple clicks correctly', () => {
132 |       render(<CopyButton {...defaultProps} />);
133 |       
134 |       const button = screen.getByTestId('copy-button');
135 |       fireEvent.click(button);
136 |       fireEvent.click(button);
137 |       fireEvent.click(button);
138 |       
139 |       expect(mockCopy).toHaveBeenCalledTimes(3);
140 |       expect(mockCopy).toHaveBeenCalledWith(defaultProps.text);
141 |     });
142 | 
143 |     test('works with empty text', () => {
144 |       render(<CopyButton text="" />);
145 |       
146 |       const button = screen.getByTestId('copy-button');
147 |       fireEvent.click(button);
148 |       
149 |       expect(mockCopy).toHaveBeenCalledWith('');
150 |     });
151 | 
152 |     test('works with multiline text', () => {
153 |       const multilineText = 'Line 1\nLine 2\nLine 3';
154 |       render(<CopyButton text={multilineText} />);
155 |       
156 |       const button = screen.getByTestId('copy-button');
157 |       fireEvent.click(button);
158 |       
159 |       expect(mockCopy).toHaveBeenCalledWith(multilineText);
160 |     });
161 | 
162 |     test('works with special characters', () => {
163 |       const specialText = '!@#$%^&*()_+-={}[]|\\:";\'<>?,./ 🚀 emoji';
164 |       render(<CopyButton text={specialText} />);
165 |       
166 |       const button = screen.getByTestId('copy-button');
167 |       fireEvent.click(button);
168 |       
169 |       expect(mockCopy).toHaveBeenCalledWith(specialText);
170 |     });
171 |   });
172 | 
173 |   describe('State Management', () => {
174 |     test('displays correct state based on copied prop', () => {
175 |       const { rerender } = render(<CopyButton {...defaultProps} />);
176 |       
177 |       // Initial state - not copied
178 |       expect(screen.getByTestId('copy-icon')).toBeInTheDocument();
179 |       expect(screen.getByText('Copy')).toBeInTheDocument();
180 |       
181 |       // Change to copied state
182 |       mockCopied.mockReturnValue(true);
183 |       rerender(<CopyButton {...defaultProps} />);
184 |       
185 |       expect(screen.getByTestId('check-icon')).toBeInTheDocument();
186 |       expect(screen.getByText('Copied!')).toBeInTheDocument();
187 |       
188 |       // Change back to not copied
189 |       mockCopied.mockReturnValue(false);
190 |       rerender(<CopyButton {...defaultProps} />);
191 |       
192 |       expect(screen.getByTestId('copy-icon')).toBeInTheDocument();
193 |       expect(screen.getByText('Copy')).toBeInTheDocument();
194 |     });
195 | 
196 |     test('updates text prop correctly', () => {
197 |       const { rerender } = render(<CopyButton text="Original text" />);
198 |       
199 |       const button = screen.getByTestId('copy-button');
200 |       fireEvent.click(button);
201 |       expect(mockCopy).toHaveBeenCalledWith('Original text');
202 |       
203 |       rerender(<CopyButton text="Updated text" />);
204 |       fireEvent.click(button);
205 |       expect(mockCopy).toHaveBeenCalledWith('Updated text');
206 |     });
207 |   });
208 | 
209 |   describe('Error Handling', () => {
210 |     test('handles copy function errors gracefully', async () => {
211 |       // Mock copy to return false on error (as per the real useCopy implementation)
212 |       mockCopy.mockImplementation(() => Promise.resolve(false));
213 |       
214 |       render(<CopyButton {...defaultProps} />);
215 |       
216 |       const button = screen.getByTestId('copy-button');
217 |       
218 |       // Should not throw an error when copy fails
219 |       expect(() => {
220 |         fireEvent.click(button);
221 |       }).not.toThrow();
222 |       
223 |       expect(mockCopy).toHaveBeenCalledWith(defaultProps.text);
224 |     });
225 | 
226 |     test('continues to work after copy failures', async () => {
227 |       mockCopy
228 |         .mockImplementationOnce(() => Promise.resolve(false)) // First failure
229 |         .mockImplementationOnce(() => Promise.resolve(true)); // Second success
230 |       
231 |       render(<CopyButton {...defaultProps} />);
232 |       
233 |       const button = screen.getByTestId('copy-button');
234 |       
235 |       // First click fails
236 |       fireEvent.click(button);
237 |       expect(mockCopy).toHaveBeenCalledTimes(1);
238 |       
239 |       // Second click succeeds
240 |       fireEvent.click(button);
241 |       expect(mockCopy).toHaveBeenCalledTimes(2);
242 |     });
243 |   });
244 | 
245 |   describe('Accessibility', () => {
246 |     test('has proper title attribute for screen readers', () => {
247 |       render(<CopyButton {...defaultProps} />);
248 |       
249 |       const button = screen.getByTestId('copy-button');
250 |       expect(button).toHaveAttribute('title', 'Copy to clipboard');
251 |     });
252 | 
253 |     test('button is keyboard accessible', () => {
254 |       render(<CopyButton {...defaultProps} />);
255 |       
256 |       const button = screen.getByTestId('copy-button');
257 |       
258 |       // Button should be focusable
259 |       button.focus();
260 |       expect(button).toHaveFocus();
261 |       
262 |       // Button should have proper attributes for accessibility
263 |       expect(button).toHaveAttribute('type', 'button');
264 |     });
265 | 
266 |     test('supports keyboard navigation', () => {
267 |       render(<CopyButton {...defaultProps} />);
268 |       
269 |       const button = screen.getByTestId('copy-button');
270 |       
271 |       // Button should be focusable and tabbable
272 |       expect(button).not.toHaveAttribute('tabindex', '-1');
273 |       
274 |       // Button should be a proper button element
275 |       expect(button.tagName).toBe('BUTTON');
276 |     });
277 | 
278 |     test('has appropriate role as button', () => {
279 |       render(<CopyButton {...defaultProps} />);
280 |       
281 |       const button = screen.getByRole('button');
282 |       expect(button).toBeInTheDocument();
283 |     });
284 |   });
285 | 
286 |   describe('Icon Rendering', () => {
287 |     test('copy icon has correct className', () => {
288 |       render(<CopyButton {...defaultProps} />);
289 |       
290 |       const copyIcon = screen.getByTestId('copy-icon');
291 |       expect(copyIcon).toHaveClass('h-4', 'w-4');
292 |     });
293 | 
294 |     test('check icon has correct className when copied', () => {
295 |       mockCopied.mockReturnValue(true);
296 |       render(<CopyButton {...defaultProps} />);
297 |       
298 |       const checkIcon = screen.getByTestId('check-icon');
299 |       expect(checkIcon).toHaveClass('h-4', 'w-4');
300 |     });
301 |   });
302 | 
303 |   describe('Integration Tests', () => {
304 |     test('complete copy workflow works end-to-end', async () => {
305 |       let copiedState = false;
306 |       mockCopied.mockImplementation(() => copiedState);
307 |       mockCopy.mockImplementation((text: string) => {
308 |         copiedState = true;
309 |         return Promise.resolve(true);
310 |       });
311 |       
312 |       const { rerender } = render(<CopyButton {...defaultProps} />);
313 |       
314 |       // Initial state
315 |       expect(screen.getByTestId('copy-icon')).toBeInTheDocument();
316 |       expect(screen.getByText('Copy')).toBeInTheDocument();
317 |       
318 |       // Click to copy
319 |       const button = screen.getByTestId('copy-button');
320 |       fireEvent.click(button);
321 |       
322 |       // Simulate state change
323 |       rerender(<CopyButton {...defaultProps} />);
324 |       
325 |       // Should show copied state
326 |       expect(screen.getByTestId('check-icon')).toBeInTheDocument();
327 |       expect(screen.getByText('Copied!')).toBeInTheDocument();
328 |       
329 |       expect(mockCopy).toHaveBeenCalledWith(defaultProps.text);
330 |     });
331 | 
332 |     test('handles rapid successive clicks correctly', () => {
333 |       render(<CopyButton {...defaultProps} />);
334 |       
335 |       const button = screen.getByTestId('copy-button');
336 |       
337 |       // Rapid clicks
338 |       fireEvent.click(button);
339 |       fireEvent.click(button);
340 |       fireEvent.click(button);
341 |       
342 |       expect(mockCopy).toHaveBeenCalledTimes(3);
343 |       expect(mockCopy).toHaveBeenCalledWith(defaultProps.text);
344 |     });
345 |   });
346 | });
```

__tests__/components/error-boundary.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import React from 'react';
3 | import { render, screen, fireEvent, waitFor, act } from '@testing-library/react';
4 | import { useRouter } from 'next/navigation';
5 | import { ErrorBoundary, useErrorBoundary } from '../../components/error-boundary';
6 | 
7 | // Mock external dependencies
8 | jest.mock('sonner', () => ({
9 |   toast: {
10 |     success: jest.fn(),
11 |     error: jest.fn(),
12 |   },
13 | }));
14 | 
15 | jest.mock('next/navigation', () => ({
16 |   useRouter: jest.fn(),
17 | }));
18 | 
19 | jest.mock('lucide-react', () => ({
20 |   RefreshCw: ({ className }: any) => <div data-testid="refresh-icon" className={className} />,
21 |   AlertCircle: ({ className }: any) => <div data-testid="alert-icon" className={className} />,
22 |   Home: ({ className }: any) => <div data-testid="home-icon" className={className} />,
23 | }));
24 | 
25 | // Mock clipboard API
26 | Object.assign(navigator, {
27 |   clipboard: {
28 |     writeText: jest.fn(),
29 |   },
30 | });
31 | 
32 | // Mock window.setTimeout and clearTimeout
33 | jest.useFakeTimers();
34 | 
35 | // Test component that throws errors
36 | const ThrowError = ({ shouldThrow, errorMessage }: { shouldThrow: boolean; errorMessage?: string }) => {
37 |   if (shouldThrow) {
38 |     throw new Error(errorMessage || 'Test error');
39 |   }
40 |   return <div>No error</div>;
41 | };
42 | 
43 | // Test component for useErrorBoundary hook
44 | const TestHookComponent = () => {
45 |   const { captureError, resetError } = useErrorBoundary();
46 |   
47 |   return (
48 |     <div>
49 |       <button onClick={() => captureError(new Error('Hook error'))}>
50 |         Trigger Error
51 |       </button>
52 |       <button onClick={resetError}>
53 |         Reset Error
54 |       </button>
55 |       <div>Hook component content</div>
56 |     </div>
57 |   );
58 | };
59 | 
60 | describe('ErrorBoundary', () => {
61 |   const mockPush = jest.fn();
62 |   const { toast } = require('sonner');
63 | 
64 |   beforeEach(() => {
65 |     jest.clearAllMocks();
66 |     jest.clearAllTimers();
67 |     (useRouter as jest.Mock).mockReturnValue({
68 |       push: mockPush,
69 |     });
70 |     
71 |     // Mock navigator.clipboard
72 |     (navigator.clipboard.writeText as jest.Mock).mockResolvedValue(undefined);
73 |     
74 |     // Suppress console.error for error boundary tests
75 |     jest.spyOn(console, 'error').mockImplementation(() => {});
76 |   });
77 | 
78 |   afterEach(() => {
79 |     jest.restoreAllMocks();
80 |     act(() => {
81 |       jest.runOnlyPendingTimers();
82 |     });
83 |   });
84 | 
85 |   describe('Basic Rendering and Props', () => {
86 |     test('renders children when no error occurs', () => {
87 |       render(
88 |         <ErrorBoundary>
89 |           <div>Child component</div>
90 |         </ErrorBoundary>
91 |       );
92 | 
93 |       expect(screen.getByText('Child component')).toBeInTheDocument();
94 |     });
95 | 
96 |     test('renders default error fallback when error occurs', () => {
97 |       render(
98 |         <ErrorBoundary>
99 |           <ThrowError shouldThrow={true} errorMessage="Test error message" />
100 |         </ErrorBoundary>
101 |       );
102 | 
103 |       expect(screen.getByText('Something went wrong')).toBeInTheDocument();
104 |       expect(screen.getByText(/An unexpected error occurred/)).toBeInTheDocument();
105 |       expect(screen.getByRole('button', { name: /try again/i })).toBeInTheDocument();
106 |       expect(screen.getByRole('button', { name: /go to home/i })).toBeInTheDocument();
107 |     });
108 | 
109 |     test('renders custom fallback component when provided', () => {
110 |       const CustomFallback = ({ error, resetError, errorId }: any) => (
111 |         <div>
112 |           <h1>Custom Error: {error.message}</h1>
113 |           <button onClick={resetError}>Custom Reset</button>
114 |           <p>Error ID: {errorId}</p>
115 |         </div>
116 |       );
117 | 
118 |       render(
119 |         <ErrorBoundary fallback={CustomFallback}>
120 |           <ThrowError shouldThrow={true} errorMessage="Custom error" />
121 |         </ErrorBoundary>
122 |       );
123 | 
124 |       expect(screen.getByText('Custom Error: Custom error')).toBeInTheDocument();
125 |       expect(screen.getByRole('button', { name: /custom reset/i })).toBeInTheDocument();
126 |       expect(screen.getByText(/Error ID:/)).toBeInTheDocument();
127 |     });
128 | 
129 |     test('calls onError callback when error occurs', () => {
130 |       const mockOnError = jest.fn();
131 |       
132 |       render(
133 |         <ErrorBoundary onError={mockOnError}>
134 |           <ThrowError shouldThrow={true} errorMessage="Callback test error" />
135 |         </ErrorBoundary>
136 |       );
137 | 
138 |       expect(mockOnError).toHaveBeenCalledWith(
139 |         expect.objectContaining({
140 |           message: 'Callback test error'
141 |         }),
142 |         expect.objectContaining({
143 |           componentStack: expect.any(String)
144 |         })
145 |       );
146 |     });
147 |   });
148 | 
149 |   describe('Error State Management', () => {
150 |     test('generates unique error ID for each error', () => {
151 |       const { rerender } = render(
152 |         <ErrorBoundary>
153 |           <ThrowError shouldThrow={false} />
154 |         </ErrorBoundary>
155 |       );
156 | 
157 |       // First error
158 |       rerender(
159 |         <ErrorBoundary>
160 |           <ThrowError shouldThrow={true} errorMessage="First error" />
161 |         </ErrorBoundary>
162 |       );
163 | 
164 |       const firstErrorId = screen.getByText(/Error ID:/).textContent;
165 | 
166 |       // Reset and trigger second error
167 |       fireEvent.click(screen.getByRole('button', { name: /try again/i }));
168 |       
169 |       rerender(
170 |         <ErrorBoundary>
171 |           <ThrowError shouldThrow={true} errorMessage="Second error" />
172 |         </ErrorBoundary>
173 |       );
174 | 
175 |       const secondErrorId = screen.getByText(/Error ID:/).textContent;
176 |       expect(firstErrorId).not.toEqual(secondErrorId);
177 |     });
178 | 
179 |     test('displays error message in technical details', () => {
180 |       render(
181 |         <ErrorBoundary>
182 |           <ThrowError shouldThrow={true} errorMessage="Detailed error message" />
183 |         </ErrorBoundary>
184 |       );
185 | 
186 |       // Open technical details
187 |       fireEvent.click(screen.getByText('Technical Details'));
188 |       
189 |       expect(screen.getByText('Detailed error message')).toBeInTheDocument();
190 |     });
191 |   });
192 | 
193 |   describe('User Interactions', () => {
194 |     test('resets error state when Try Again button is clicked', async () => {
195 |       render(
196 |         <ErrorBoundary>
197 |           <ThrowError shouldThrow={true} />
198 |         </ErrorBoundary>
199 |       );
200 | 
201 |       expect(screen.getByText('Something went wrong')).toBeInTheDocument();
202 | 
203 |       await act(async () => {
204 |         fireEvent.click(screen.getByRole('button', { name: /try again/i }));
205 |       });
206 | 
207 |       // Wait for toast - this is the main behavior we can test
208 |       await waitFor(() => {
209 |         expect(toast.success).toHaveBeenCalledWith('Interface reset successfully', {
210 |           position: 'top-center',
211 |           duration: 3000
212 |         });
213 |       });
214 | 
215 |       // The error boundary will still show the error state since the component hasn't been remounted
216 |       // This is expected behavior - the resetError mainly shows feedback to the user
217 |       expect(screen.getByText('Something went wrong')).toBeInTheDocument();
218 |     });
219 | 
220 |     test('navigates to home when Go to Home button is clicked', () => {
221 |       render(
222 |         <ErrorBoundary>
223 |           <ThrowError shouldThrow={true} />
224 |         </ErrorBoundary>
225 |       );
226 | 
227 |       fireEvent.click(screen.getByRole('button', { name: /go to home/i }));
228 | 
229 |       expect(mockPush).toHaveBeenCalledWith('/');
230 |     });
231 | 
232 |     test('copies error details to clipboard when copy button is clicked', async () => {
233 |       render(
234 |         <ErrorBoundary>
235 |           <ThrowError shouldThrow={true} errorMessage="Clipboard test error" />
236 |         </ErrorBoundary>
237 |       );
238 | 
239 |       // Open technical details
240 |       fireEvent.click(screen.getByText('Technical Details'));
241 |       
242 |       // Click copy button
243 |       fireEvent.click(screen.getByText('Copy error details'));
244 | 
245 |       await waitFor(() => {
246 |         expect(navigator.clipboard.writeText).toHaveBeenCalledWith(
247 |           expect.stringContaining('"message": "Clipboard test error"')
248 |         );
249 |         expect(toast.success).toHaveBeenCalledWith('Error details copied to clipboard');
250 |       });
251 |     });
252 | 
253 |     test('handles clipboard copy failure gracefully', async () => {
254 |       (navigator.clipboard.writeText as jest.Mock).mockRejectedValue(new Error('Clipboard error'));
255 | 
256 |       render(
257 |         <ErrorBoundary>
258 |           <ThrowError shouldThrow={true} />
259 |         </ErrorBoundary>
260 |       );
261 | 
262 |       // Open technical details and click copy
263 |       fireEvent.click(screen.getByText('Technical Details'));
264 |       fireEvent.click(screen.getByText('Copy error details'));
265 | 
266 |       await waitFor(() => {
267 |         expect(toast.error).toHaveBeenCalledWith('Failed to copy error details');
268 |       });
269 |     });
270 |   });
271 | 
272 |   describe('Auto-Recovery Functionality', () => {
273 |     test('automatically resets error after 5 seconds', async () => {
274 |       render(
275 |         <ErrorBoundary>
276 |           <ThrowError shouldThrow={true} />
277 |         </ErrorBoundary>
278 |       );
279 | 
280 |       expect(screen.getByText('Something went wrong')).toBeInTheDocument();
281 | 
282 |       // Fast-forward 5 seconds
283 |       await act(async () => {
284 |         jest.advanceTimersByTime(5000);
285 |       });
286 | 
287 |       await waitFor(() => {
288 |         expect(toast.success).toHaveBeenCalledWith('Interface reset successfully', {
289 |           position: 'top-center',
290 |           duration: 3000
291 |         });
292 |       });
293 | 
294 |       // The error boundary will still show the error state since the component hasn't been remounted
295 |       // This is expected behavior - the auto-recovery mainly shows feedback to the user
296 |       expect(screen.getByText('Something went wrong')).toBeInTheDocument();
297 |     });
298 | 
299 |     test('clears auto-recovery timeout when component unmounts', () => {
300 |       const { unmount } = render(
301 |         <ErrorBoundary>
302 |           <ThrowError shouldThrow={true} />
303 |         </ErrorBoundary>
304 |       );
305 | 
306 |       // Spy on clearTimeout
307 |       const clearTimeoutSpy = jest.spyOn(window, 'clearTimeout');
308 | 
309 |       unmount();
310 | 
311 |       expect(clearTimeoutSpy).toHaveBeenCalled();
312 |       clearTimeoutSpy.mockRestore();
313 |     });
314 | 
315 |     test('clears auto-recovery timeout when manually reset', () => {
316 |       render(
317 |         <ErrorBoundary>
318 |           <ThrowError shouldThrow={true} />
319 |         </ErrorBoundary>
320 |       );
321 | 
322 |       // Spy on clearTimeout
323 |       const clearTimeoutSpy = jest.spyOn(window, 'clearTimeout');
324 | 
325 |       // Manual reset before auto-recovery
326 |       fireEvent.click(screen.getByRole('button', { name: /try again/i }));
327 | 
328 |       expect(clearTimeoutSpy).toHaveBeenCalled();
329 |       clearTimeoutSpy.mockRestore();
330 |     });
331 |   });
332 | 
333 |   describe('Error Details and Reporting', () => {
334 |     test('includes comprehensive error details in clipboard data', async () => {
335 |       // Mock window.location and navigator.userAgent
336 |       const originalLocation = window.location;
337 |       const originalUserAgent = navigator.userAgent;
338 |       
339 |       delete (window as any).location;
340 |       window.location = { href: 'https://example.com/test-page' } as Location;
341 |       
342 |       Object.defineProperty(navigator, 'userAgent', {
343 |         value: 'Test User Agent',
344 |         configurable: true
345 |       });
346 | 
347 |       render(
348 |         <ErrorBoundary>
349 |           <ThrowError shouldThrow={true} errorMessage="Detailed test error" />
350 |         </ErrorBoundary>
351 |       );
352 | 
353 |       fireEvent.click(screen.getByText('Technical Details'));
354 |       fireEvent.click(screen.getByText('Copy error details'));
355 | 
356 |       await waitFor(() => {
357 |         const clipboardCall = (navigator.clipboard.writeText as jest.Mock).mock.calls[0][0];
358 |         const errorDetails = JSON.parse(clipboardCall);
359 | 
360 |               expect(errorDetails).toMatchObject({
361 |         message: 'Detailed test error',
362 |         stack: expect.any(String),
363 |         errorId: expect.any(String),
364 |         timestamp: expect.any(String),
365 |         userAgent: 'Test User Agent',
366 |         url: expect.stringContaining('localhost') // Accept the default test URL
367 |       });
368 |       });
369 | 
370 |       // Restore original values
371 |       window.location = originalLocation;
372 |       Object.defineProperty(navigator, 'userAgent', {
373 |         value: originalUserAgent,
374 |         configurable: true
375 |       });
376 |     });
377 | 
378 |     test('displays auto-recovery message', () => {
379 |       render(
380 |         <ErrorBoundary>
381 |           <ThrowError shouldThrow={true} />
382 |         </ErrorBoundary>
383 |       );
384 | 
385 |       expect(screen.getByText('Auto-recovery in progress...')).toBeInTheDocument();
386 |     });
387 |   });
388 | 
389 |   describe('Accessibility', () => {
390 |     test('has proper ARIA attributes for error dialog', () => {
391 |       render(
392 |         <ErrorBoundary>
393 |           <ThrowError shouldThrow={true} />
394 |         </ErrorBoundary>
395 |       );
396 | 
397 |       const tryAgainButton = screen.getByRole('button', { name: /try again/i });
398 |       const homeButton = screen.getByRole('button', { name: /go to home/i });
399 | 
400 |       expect(tryAgainButton).toBeInTheDocument();
401 |       expect(homeButton).toBeInTheDocument();
402 |       expect(screen.getByTestId('alert-icon')).toBeInTheDocument();
403 |     });
404 | 
405 |     test('supports keyboard navigation', () => {
406 |       render(
407 |         <ErrorBoundary>
408 |           <ThrowError shouldThrow={true} />
409 |         </ErrorBoundary>
410 |       );
411 | 
412 |       const tryAgainButton = screen.getByRole('button', { name: /try again/i });
413 |       const homeButton = screen.getByRole('button', { name: /go to home/i });
414 | 
415 |       // Buttons should be focusable
416 |       tryAgainButton.focus();
417 |       expect(tryAgainButton).toHaveFocus();
418 | 
419 |       homeButton.focus();
420 |       expect(homeButton).toHaveFocus();
421 |     });
422 | 
423 |     test('technical details section is properly expandable', () => {
424 |       render(
425 |         <ErrorBoundary>
426 |           <ThrowError shouldThrow={true} />
427 |         </ErrorBoundary>
428 |       );
429 | 
430 |       const detailsElement = screen.getByText('Technical Details').closest('details');
431 |       expect(detailsElement).toBeInTheDocument();
432 |       
433 |       // Initially closed
434 |       expect(detailsElement).not.toHaveAttribute('open');
435 |       
436 |       // Click to expand
437 |       fireEvent.click(screen.getByText('Technical Details'));
438 |       expect(detailsElement).toHaveAttribute('open');
439 |     });
440 |   });
441 | });
442 | 
443 | describe('useErrorBoundary Hook', () => {
444 |   beforeEach(() => {
445 |     jest.clearAllMocks();
446 |     // Suppress console.error for hook error tests
447 |     jest.spyOn(console, 'error').mockImplementation(() => {});
448 |   });
449 | 
450 |   afterEach(() => {
451 |     jest.restoreAllMocks();
452 |   });
453 | 
454 |   test('provides captureError and resetError functions', () => {
455 |     render(
456 |       <ErrorBoundary>
457 |         <TestHookComponent />
458 |       </ErrorBoundary>
459 |     );
460 | 
461 |     expect(screen.getByRole('button', { name: /trigger error/i })).toBeInTheDocument();
462 |     expect(screen.getByRole('button', { name: /reset error/i })).toBeInTheDocument();
463 |     expect(screen.getByText('Hook component content')).toBeInTheDocument();
464 |   });
465 | 
466 |   test('throws error when captureError is called', () => {
467 |     render(
468 |       <ErrorBoundary>
469 |         <TestHookComponent />
470 |       </ErrorBoundary>
471 |     );
472 | 
473 |     fireEvent.click(screen.getByRole('button', { name: /trigger error/i }));
474 | 
475 |     // Error boundary should catch the error
476 |     expect(screen.getByText('Something went wrong')).toBeInTheDocument();
477 |     expect(screen.queryByText('Hook component content')).not.toBeInTheDocument();
478 |   });
479 | 
480 |   test('resetError clears the error state', async () => {
481 |     const TestResetComponent = () => {
482 |       const { captureError, resetError } = useErrorBoundary();
483 |       const [hasTriggered, setHasTriggered] = React.useState(false);
484 |       
485 |       const handleTrigger = () => {
486 |         setHasTriggered(true);
487 |         captureError(new Error('Reset test error'));
488 |       };
489 |       
490 |       const handleReset = () => {
491 |         setHasTriggered(false);
492 |         resetError();
493 |       };
494 |       
495 |       return (
496 |         <div>
497 |           <button onClick={handleTrigger}>Trigger Error</button>
498 |           <button onClick={handleReset}>Reset Error</button>
499 |           <div>Reset test content - {hasTriggered ? 'triggered' : 'not triggered'}</div>
500 |         </div>
501 |       );
502 |     };
503 | 
504 |     render(
505 |       <ErrorBoundary>
506 |         <TestResetComponent />
507 |       </ErrorBoundary>
508 |     );
509 | 
510 |     // Trigger error
511 |     fireEvent.click(screen.getByRole('button', { name: /trigger error/i }));
512 |     expect(screen.getByText('Something went wrong')).toBeInTheDocument();
513 | 
514 |     // Reset from error boundary
515 |     fireEvent.click(screen.getByRole('button', { name: /try again/i }));
516 | 
517 |     await waitFor(() => {
518 |       expect(screen.queryByText('Something went wrong')).not.toBeInTheDocument();
519 |     });
520 |   });
521 | });
522 | 
523 | describe('Integration Tests', () => {
524 |   const { toast } = require('sonner');
525 | 
526 |   beforeEach(() => {
527 |     jest.clearAllMocks();
528 |     jest.spyOn(console, 'error').mockImplementation(() => {});
529 |   });
530 | 
531 |   afterEach(() => {
532 |     jest.restoreAllMocks();
533 |   });
534 | 
535 |   test('complete error recovery workflow', async () => {
536 |     const mockOnError = jest.fn();
537 |     
538 |     render(
539 |       <ErrorBoundary onError={mockOnError}>
540 |         <ThrowError shouldThrow={true} errorMessage="Integration test error" />
541 |       </ErrorBoundary>
542 |     );
543 | 
544 |     // 1. Error occurs and is caught
545 |     expect(screen.getByText('Something went wrong')).toBeInTheDocument();
546 |     expect(mockOnError).toHaveBeenCalled();
547 | 
548 |     // 2. User views technical details
549 |     fireEvent.click(screen.getByText('Technical Details'));
550 |     expect(screen.getByText('Integration test error')).toBeInTheDocument();
551 | 
552 |     // 3. User copies error details
553 |     fireEvent.click(screen.getByText('Copy error details'));
554 |     await waitFor(() => {
555 |       expect(navigator.clipboard.writeText).toHaveBeenCalled();
556 |       expect(toast.success).toHaveBeenCalledWith('Error details copied to clipboard');
557 |     });
558 | 
559 |     // 4. User manually resets
560 |     await act(async () => {
561 |       fireEvent.click(screen.getByRole('button', { name: /try again/i }));
562 |     });
563 | 
564 |     await waitFor(() => {
565 |       expect(toast.success).toHaveBeenCalledWith('Interface reset successfully', {
566 |         position: 'top-center',
567 |         duration: 3000
568 |       });
569 |     });
570 | 
571 |     // 5. Error boundary stays in error state (expected behavior)
572 |     expect(screen.getByText('Something went wrong')).toBeInTheDocument();
573 |   });
574 | 
575 |   test('auto-recovery with custom fallback component', async () => {
576 |     const CustomFallback = ({ error, resetError }: any) => (
577 |       <div>
578 |         <h1>Custom Error Handler</h1>
579 |         <p>{error.message}</p>
580 |         <button onClick={resetError}>Custom Recovery</button>
581 |       </div>
582 |     );
583 | 
584 |     render(
585 |       <ErrorBoundary fallback={CustomFallback}>
586 |         <ThrowError shouldThrow={true} errorMessage="Custom fallback test" />
587 |       </ErrorBoundary>
588 |     );
589 | 
590 |     expect(screen.getByText('Custom Error Handler')).toBeInTheDocument();
591 |     expect(screen.getByText('Custom fallback test')).toBeInTheDocument();
592 | 
593 |     // Test custom recovery button
594 |     await act(async () => {
595 |       fireEvent.click(screen.getByRole('button', { name: /custom recovery/i }));
596 |     });
597 | 
598 |     await waitFor(() => {
599 |       expect(toast.success).toHaveBeenCalledWith('Interface reset successfully', {
600 |         position: 'top-center',
601 |         duration: 3000
602 |       });
603 |     });
604 | 
605 |     // Error boundary stays in error state with custom fallback (expected behavior)
606 |     expect(screen.getByText('Custom Error Handler')).toBeInTheDocument();
607 |   });
608 | });
```

__tests__/components/favorite-toggle.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { FavoriteToggle } from '../../components/favorite-toggle';
4 | 
5 | // Mock the model context
6 | const mockToggleFavorite = jest.fn();
7 | jest.mock('../../lib/context/model-context', () => ({
8 |   useModel: () => ({
9 |     toggleFavorite: mockToggleFavorite,
10 |   }),
11 | }));
12 | 
13 | // Mock UI components
14 | jest.mock('../../components/ui/tooltip', () => ({
15 |   TooltipProvider: ({ children, delayDuration }: any) => (
16 |     <div data-testid="tooltip-provider" data-delay={delayDuration}>{children}</div>
17 |   ),
18 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
19 |   TooltipTrigger: ({ children, asChild }: any) => 
20 |     asChild ? children : <div data-testid="tooltip-trigger">{children}</div>,
21 |   TooltipContent: ({ children, side, className }: any) => (
22 |     <div data-testid="tooltip-content" data-side={side} className={className}>
23 |       {children}
24 |     </div>
25 |   ),
26 | }));
27 | 
28 | // Mock Lucide icons
29 | jest.mock('lucide-react', () => ({
30 |   Star: ({ className, ...props }: any) => (
31 |     <div data-testid="star-icon" className={className} {...props} />
32 |   ),
33 | }));
34 | 
35 | // Mock utils
36 | jest.mock('../../lib/utils', () => ({
37 |   cn: (...classes: any[]) => classes.filter(Boolean).join(' '),
38 | }));
39 | 
40 | describe('FavoriteToggle', () => {
41 |   const mockProps = {
42 |     modelId: 'test-model-1',
43 |     isFavorite: false,
44 |     onToggle: jest.fn(),
45 |     disabled: false,
46 |     size: 'md' as const,
47 |     className: 'test-class',
48 |   };
49 | 
50 |   beforeEach(() => {
51 |     jest.clearAllMocks();
52 |     mockToggleFavorite.mockResolvedValue(true);
53 |     // Mock console.error to avoid noise in tests
54 |     jest.spyOn(console, 'error').mockImplementation(() => {});
55 |   });
56 | 
57 |   afterEach(() => {
58 |     jest.restoreAllMocks();
59 |   });
60 | 
61 |   // Tests for Basic Rendering and Props
62 |   describe('Basic Rendering and Props', () => {
63 |     test('renders with default props', () => {
64 |       render(<FavoriteToggle modelId="test-model" isFavorite={false} />);
65 |       
66 |       expect(screen.getByRole('button')).toBeInTheDocument();
67 |       expect(screen.getByTestId('star-icon')).toBeInTheDocument();
68 |       expect(screen.getByTestId('tooltip-provider')).toBeInTheDocument();
69 |     });
70 | 
71 |     test('renders with all props provided', () => {
72 |       render(<FavoriteToggle {...mockProps} />);
73 |       
74 |       const button = screen.getByRole('button');
75 |       expect(button).toBeInTheDocument();
76 |       expect(button).toHaveClass('test-class');
77 |       expect(button).not.toBeDisabled();
78 |     });
79 | 
80 |     test('applies correct size classes for small size', () => {
81 |       render(<FavoriteToggle {...mockProps} size="sm" />);
82 |       
83 |       const starIcon = screen.getByTestId('star-icon');
84 |       expect(starIcon).toHaveClass('h-3 w-3');
85 |       
86 |       const button = screen.getByRole('button');
87 |       expect(button).toHaveClass('p-0.5');
88 |     });
89 | 
90 |     test('applies correct size classes for medium size', () => {
91 |       render(<FavoriteToggle {...mockProps} size="md" />);
92 |       
93 |       const starIcon = screen.getByTestId('star-icon');
94 |       expect(starIcon).toHaveClass('h-4 w-4');
95 |       
96 |       const button = screen.getByRole('button');
97 |       expect(button).toHaveClass('p-1');
98 |     });
99 | 
100 |     test('applies correct size classes for large size', () => {
101 |       render(<FavoriteToggle {...mockProps} size="lg" />);
102 |       
103 |       const starIcon = screen.getByTestId('star-icon');
104 |       expect(starIcon).toHaveClass('h-5 w-5');
105 |       
106 |       const button = screen.getByRole('button');
107 |       expect(button).toHaveClass('p-1.5');
108 |     });
109 | 
110 |     test('shows unfavorited state correctly', () => {
111 |       render(<FavoriteToggle {...mockProps} isFavorite={false} />);
112 |       
113 |       const button = screen.getByRole('button');
114 |       expect(button).toHaveAttribute('aria-label', 'Add to favorites');
115 |       
116 |       const starIcon = screen.getByTestId('star-icon');
117 |       expect(starIcon).toHaveClass('text-muted-foreground hover:text-yellow-500');
118 |       expect(starIcon).not.toHaveClass('fill-yellow-400 text-yellow-500');
119 |     });
120 | 
121 |     test('shows favorited state correctly', () => {
122 |       render(<FavoriteToggle {...mockProps} isFavorite={true} />);
123 |       
124 |       const button = screen.getByRole('button');
125 |       expect(button).toHaveAttribute('aria-label', 'Remove from favorites');
126 |       
127 |       const starIcon = screen.getByTestId('star-icon');
128 |       expect(starIcon).toHaveClass('fill-yellow-400 text-yellow-500 drop-shadow-sm');
129 |     });
130 | 
131 |     test('renders disabled state correctly', () => {
132 |       render(<FavoriteToggle {...mockProps} disabled={true} />);
133 |       
134 |       const button = screen.getByRole('button');
135 |       expect(button).toBeDisabled();
136 |       expect(button).toHaveClass('opacity-50 cursor-not-allowed hover:bg-transparent');
137 |     });
138 | 
139 |     test('applies custom className', () => {
140 |       render(<FavoriteToggle {...mockProps} className="custom-class" />);
141 |       
142 |       const button = screen.getByRole('button');
143 |       expect(button).toHaveClass('custom-class');
144 |     });
145 |   });
146 | 
147 |   // Tests for User Interactions
148 |   describe('User Interactions', () => {
149 |     test('calls toggleFavorite when clicked', async () => {
150 |       render(<FavoriteToggle {...mockProps} />);
151 |       
152 |       const button = screen.getByRole('button');
153 |       fireEvent.click(button);
154 |       
155 |       await waitFor(() => {
156 |         expect(mockToggleFavorite).toHaveBeenCalledWith('test-model-1');
157 |       });
158 |     });
159 | 
160 |     test('calls onToggle callback when toggle succeeds', async () => {
161 |       render(<FavoriteToggle {...mockProps} />);
162 |       
163 |       const button = screen.getByRole('button');
164 |       fireEvent.click(button);
165 |       
166 |       await waitFor(() => {
167 |         expect(mockProps.onToggle).toHaveBeenCalledWith('test-model-1', true);
168 |       });
169 |     });
170 | 
171 |     test('does not call onToggle when toggle fails', async () => {
172 |       mockToggleFavorite.mockResolvedValue(false);
173 |       render(<FavoriteToggle {...mockProps} />);
174 |       
175 |       const button = screen.getByRole('button');
176 |       fireEvent.click(button);
177 |       
178 |       await waitFor(() => {
179 |         expect(mockToggleFavorite).toHaveBeenCalled();
180 |       });
181 |       
182 |       expect(mockProps.onToggle).not.toHaveBeenCalled();
183 |     });
184 | 
185 |     test('does not call toggleFavorite when disabled', () => {
186 |       render(<FavoriteToggle {...mockProps} disabled={true} />);
187 |       
188 |       const button = screen.getByRole('button');
189 |       fireEvent.click(button);
190 |       
191 |       expect(mockToggleFavorite).not.toHaveBeenCalled();
192 |       expect(mockProps.onToggle).not.toHaveBeenCalled();
193 |     });
194 | 
195 |     test('prevents event propagation and default behavior', () => {
196 |       const mockPreventDefault = jest.fn();
197 |       const mockStopPropagation = jest.fn();
198 |       
199 |       render(<FavoriteToggle {...mockProps} />);
200 |       
201 |       const button = screen.getByRole('button');
202 |       
203 |       // Create a proper event object
204 |       const mockEvent = new MouseEvent('click', { bubbles: true, cancelable: true });
205 |       mockEvent.preventDefault = mockPreventDefault;
206 |       mockEvent.stopPropagation = mockStopPropagation;
207 |       
208 |       fireEvent(button, mockEvent);
209 |       
210 |       expect(mockPreventDefault).toHaveBeenCalled();
211 |       expect(mockStopPropagation).toHaveBeenCalled();
212 |     });
213 | 
214 |     test('handles rapid clicks gracefully', async () => {
215 |       render(<FavoriteToggle {...mockProps} />);
216 |       
217 |       const button = screen.getByRole('button');
218 |       
219 |       // Click multiple times rapidly
220 |       fireEvent.click(button);
221 |       fireEvent.click(button);
222 |       fireEvent.click(button);
223 |       
224 |       // Should only call toggleFavorite once due to isToggling state
225 |       await waitFor(() => {
226 |         expect(mockToggleFavorite).toHaveBeenCalledTimes(1);
227 |       });
228 |     });
229 |   });
230 | 
231 |   // Tests for Loading States
232 |   describe('Loading States', () => {
233 |     test('shows loading state during toggle operation', async () => {
234 |       let resolveToggle: (value: boolean) => void;
235 |       const togglePromise = new Promise<boolean>((resolve) => {
236 |         resolveToggle = resolve;
237 |       });
238 |       mockToggleFavorite.mockReturnValue(togglePromise);
239 |       
240 |       render(<FavoriteToggle {...mockProps} />);
241 |       
242 |       const button = screen.getByRole('button');
243 |       fireEvent.click(button);
244 |       
245 |       // Button should be disabled during toggle
246 |       expect(button).toBeDisabled();
247 |       
248 |       const starIcon = screen.getByTestId('star-icon');
249 |       expect(starIcon).toHaveClass('animate-pulse');
250 |       
251 |       // Resolve the promise
252 |       resolveToggle!(true);
253 |       
254 |       await waitFor(() => {
255 |         expect(button).not.toBeDisabled();
256 |         expect(starIcon).not.toHaveClass('animate-pulse');
257 |       });
258 |     });
259 | 
260 |     test('prevents multiple simultaneous toggle operations', async () => {
261 |       let resolveToggle: (value: boolean) => void;
262 |       const togglePromise = new Promise<boolean>((resolve) => {
263 |         resolveToggle = resolve;
264 |       });
265 |       mockToggleFavorite.mockReturnValue(togglePromise);
266 |       
267 |       render(<FavoriteToggle {...mockProps} />);
268 |       
269 |       const button = screen.getByRole('button');
270 |       
271 |       // First click
272 |       fireEvent.click(button);
273 |       expect(mockToggleFavorite).toHaveBeenCalledTimes(1);
274 |       
275 |       // Second click while first is still pending
276 |       fireEvent.click(button);
277 |       expect(mockToggleFavorite).toHaveBeenCalledTimes(1); // Should not increase
278 |       
279 |       // Resolve the promise
280 |       resolveToggle!(true);
281 |       
282 |       await waitFor(() => {
283 |         expect(button).not.toBeDisabled();
284 |       });
285 |     });
286 | 
287 |     test('resets loading state after successful toggle', async () => {
288 |       render(<FavoriteToggle {...mockProps} />);
289 |       
290 |       const button = screen.getByRole('button');
291 |       fireEvent.click(button);
292 |       
293 |       await waitFor(() => {
294 |         expect(button).not.toBeDisabled();
295 |         expect(screen.getByTestId('star-icon')).not.toHaveClass('animate-pulse');
296 |       });
297 |     });
298 | 
299 |     test('resets loading state after failed toggle', async () => {
300 |       mockToggleFavorite.mockRejectedValue(new Error('Toggle failed'));
301 |       render(<FavoriteToggle {...mockProps} />);
302 |       
303 |       const button = screen.getByRole('button');
304 |       fireEvent.click(button);
305 |       
306 |       await waitFor(() => {
307 |         expect(button).not.toBeDisabled();
308 |         expect(screen.getByTestId('star-icon')).not.toHaveClass('animate-pulse');
309 |       });
310 |     });
311 |   });
312 | 
313 |   // Tests for Error Handling
314 |   describe('Error Handling', () => {
315 |     test('handles toggle error gracefully', async () => {
316 |       const consoleError = jest.spyOn(console, 'error').mockImplementation(() => {});
317 |       mockToggleFavorite.mockRejectedValue(new Error('Network error'));
318 |       
319 |       render(<FavoriteToggle {...mockProps} />);
320 |       
321 |       const button = screen.getByRole('button');
322 |       fireEvent.click(button);
323 |       
324 |       await waitFor(() => {
325 |         expect(consoleError).toHaveBeenCalledWith('Error toggling favorite:', expect.any(Error));
326 |       });
327 |       
328 |       // Component should still be functional after error
329 |       expect(button).not.toBeDisabled();
330 |       expect(mockProps.onToggle).not.toHaveBeenCalled();
331 |     });
332 | 
333 |     test('handles missing toggleFavorite function', async () => {
334 |       // Temporarily mock useModel to return undefined toggleFavorite
335 |       const originalUseModel = require('../../lib/context/model-context').useModel;
336 |       require('../../lib/context/model-context').useModel = jest.fn().mockReturnValue({
337 |         toggleFavorite: undefined,
338 |       });
339 |       
340 |       render(<FavoriteToggle {...mockProps} />);
341 |       
342 |       const button = screen.getByRole('button');
343 |       fireEvent.click(button);
344 |       
345 |       // Should not crash and should not call onToggle
346 |       expect(mockProps.onToggle).not.toHaveBeenCalled();
347 |       
348 |       // Restore original mock
349 |       require('../../lib/context/model-context').useModel = originalUseModel;
350 |     });
351 | 
352 |     test('handles null toggleFavorite response', async () => {
353 |       mockToggleFavorite.mockResolvedValue(null);
354 |       render(<FavoriteToggle {...mockProps} />);
355 |       
356 |       const button = screen.getByRole('button');
357 |       fireEvent.click(button);
358 |       
359 |       await waitFor(() => {
360 |         expect(mockToggleFavorite).toHaveBeenCalled();
361 |       });
362 |       
363 |       // Should not call onToggle for falsy response
364 |       expect(mockProps.onToggle).not.toHaveBeenCalled();
365 |     });
366 | 
367 |     test('works without onToggle callback', async () => {
368 |       render(<FavoriteToggle modelId="test-model" isFavorite={false} />);
369 |       
370 |       const button = screen.getByRole('button');
371 |       fireEvent.click(button);
372 |       
373 |       await waitFor(() => {
374 |         expect(mockToggleFavorite).toHaveBeenCalled();
375 |       });
376 |       
377 |       // Wait for the toggle operation to complete
378 |       await waitFor(() => {
379 |         expect(screen.getByRole('button')).not.toBeDisabled();
380 |       });
381 |     });
382 |   });
383 | 
384 |   // Tests for Tooltip Functionality
385 |   describe('Tooltip Functionality', () => {
386 |     test('renders tooltip with correct delay', () => {
387 |       render(<FavoriteToggle {...mockProps} />);
388 |       
389 |       const tooltipProvider = screen.getByTestId('tooltip-provider');
390 |       expect(tooltipProvider).toHaveAttribute('data-delay', '300');
391 |     });
392 | 
393 |     test('shows correct tooltip content for unfavorited state', () => {
394 |       render(<FavoriteToggle {...mockProps} isFavorite={false} />);
395 |       
396 |       const tooltipContent = screen.getByTestId('tooltip-content');
397 |       expect(tooltipContent).toHaveTextContent('Add to favorites');
398 |     });
399 | 
400 |     test('shows correct tooltip content for favorited state', () => {
401 |       render(<FavoriteToggle {...mockProps} isFavorite={true} />);
402 |       
403 |       const tooltipContent = screen.getByTestId('tooltip-content');
404 |       expect(tooltipContent).toHaveTextContent('Remove from favorites');
405 |     });
406 | 
407 |     test('shows loading tooltip content during toggle', async () => {
408 |       let resolveToggle: (value: boolean) => void;
409 |       const togglePromise = new Promise<boolean>((resolve) => {
410 |         resolveToggle = resolve;
411 |       });
412 |       mockToggleFavorite.mockReturnValue(togglePromise);
413 |       
414 |       render(<FavoriteToggle {...mockProps} isFavorite={false} />);
415 |       
416 |       const button = screen.getByRole('button');
417 |       fireEvent.click(button);
418 |       
419 |       const tooltipContent = screen.getByTestId('tooltip-content');
420 |       expect(tooltipContent).toHaveTextContent('Adding to favorites...');
421 |       
422 |       resolveToggle!(true);
423 |       
424 |       await waitFor(() => {
425 |         expect(tooltipContent).toHaveTextContent('Add to favorites');
426 |       });
427 |     });
428 | 
429 |     test('shows correct loading tooltip for removing favorite', async () => {
430 |       let resolveToggle: (value: boolean) => void;
431 |       const togglePromise = new Promise<boolean>((resolve) => {
432 |         resolveToggle = resolve;
433 |       });
434 |       mockToggleFavorite.mockReturnValue(togglePromise);
435 |       
436 |       render(<FavoriteToggle {...mockProps} isFavorite={true} />);
437 |       
438 |       const button = screen.getByRole('button');
439 |       fireEvent.click(button);
440 |       
441 |       const tooltipContent = screen.getByTestId('tooltip-content');
442 |       expect(tooltipContent).toHaveTextContent('Removing from favorites...');
443 |       
444 |       resolveToggle!(true);
445 |       
446 |       await waitFor(() => {
447 |         expect(tooltipContent).toHaveTextContent('Remove from favorites');
448 |       });
449 |     });
450 | 
451 |     test('tooltip content positioned correctly', () => {
452 |       render(<FavoriteToggle {...mockProps} />);
453 |       
454 |       const tooltipContent = screen.getByTestId('tooltip-content');
455 |       expect(tooltipContent).toHaveAttribute('data-side', 'top');
456 |     });
457 |   });
458 | 
459 |   // Tests for Accessibility
460 |   describe('Accessibility', () => {
461 |     test('has proper ARIA label for unfavorited state', () => {
462 |       render(<FavoriteToggle {...mockProps} isFavorite={false} />);
463 |       
464 |       const button = screen.getByRole('button');
465 |       expect(button).toHaveAttribute('aria-label', 'Add to favorites');
466 |     });
467 | 
468 |     test('has proper ARIA label for favorited state', () => {
469 |       render(<FavoriteToggle {...mockProps} isFavorite={true} />);
470 |       
471 |       const button = screen.getByRole('button');
472 |       expect(button).toHaveAttribute('aria-label', 'Remove from favorites');
473 |     });
474 | 
475 |     test('is keyboard accessible', () => {
476 |       render(<FavoriteToggle {...mockProps} />);
477 |       
478 |       const button = screen.getByRole('button');
479 |       expect(button).toBeInTheDocument();
480 |       
481 |       // Button should be focusable
482 |       button.focus();
483 |       expect(document.activeElement).toBe(button);
484 |     });
485 | 
486 |     test('has proper button type', () => {
487 |       render(<FavoriteToggle {...mockProps} />);
488 |       
489 |       const button = screen.getByRole('button');
490 |       expect(button).toHaveAttribute('type', 'button');
491 |     });
492 | 
493 |     test('supports keyboard activation', async () => {
494 |       render(<FavoriteToggle {...mockProps} />);
495 |       
496 |       const button = screen.getByRole('button');
497 |       button.focus();
498 |       
499 |       fireEvent.keyDown(button, { key: 'Enter' });
500 |       fireEvent.keyUp(button, { key: 'Enter' });
501 |       fireEvent.click(button);
502 |       
503 |       await waitFor(() => {
504 |         expect(mockToggleFavorite).toHaveBeenCalled();
505 |       });
506 |     });
507 | 
508 |     test('has proper focus styles', () => {
509 |       render(<FavoriteToggle {...mockProps} />);
510 |       
511 |       const button = screen.getByRole('button');
512 |       expect(button).toHaveClass('focus:outline-none focus:ring-2 focus:ring-primary/30 focus:ring-offset-1');
513 |     });
514 |   });
515 | 
516 |   // Integration Tests
517 |   describe('Integration Tests', () => {
518 |     test('complete toggle workflow: unfavorited to favorited', async () => {
519 |       const onToggle = jest.fn();
520 |       render(<FavoriteToggle {...mockProps} isFavorite={false} onToggle={onToggle} />);
521 |       
522 |       // Initial state
523 |       const button = screen.getByRole('button');
524 |       expect(button).toHaveAttribute('aria-label', 'Add to favorites');
525 |       
526 |       const starIcon = screen.getByTestId('star-icon');
527 |       expect(starIcon).toHaveClass('text-muted-foreground hover:text-yellow-500');
528 |       
529 |       // Click to toggle
530 |       fireEvent.click(button);
531 |       
532 |       // During toggle - loading state
533 |       expect(button).toBeDisabled();
534 |       expect(starIcon).toHaveClass('animate-pulse');
535 |       
536 |       // After toggle completes
537 |       await waitFor(() => {
538 |         expect(mockToggleFavorite).toHaveBeenCalledWith('test-model-1');
539 |         expect(onToggle).toHaveBeenCalledWith('test-model-1', true);
540 |         expect(button).not.toBeDisabled();
541 |         expect(starIcon).not.toHaveClass('animate-pulse');
542 |       });
543 |     });
544 | 
545 |     test('complete toggle workflow: favorited to unfavorited', async () => {
546 |       const onToggle = jest.fn();
547 |       render(<FavoriteToggle {...mockProps} isFavorite={true} onToggle={onToggle} />);
548 |       
549 |       // Initial state
550 |       const button = screen.getByRole('button');
551 |       expect(button).toHaveAttribute('aria-label', 'Remove from favorites');
552 |       
553 |       const starIcon = screen.getByTestId('star-icon');
554 |       expect(starIcon).toHaveClass('fill-yellow-400 text-yellow-500 drop-shadow-sm');
555 |       
556 |       // Click to toggle
557 |       fireEvent.click(button);
558 |       
559 |       // After toggle completes
560 |       await waitFor(() => {
561 |         expect(mockToggleFavorite).toHaveBeenCalledWith('test-model-1');
562 |         expect(onToggle).toHaveBeenCalledWith('test-model-1', false);
563 |       });
564 |     });
565 | 
566 |     test('handles error recovery workflow', async () => {
567 |       const consoleError = jest.spyOn(console, 'error').mockImplementation(() => {});
568 |       mockToggleFavorite.mockRejectedValueOnce(new Error('Network error'));
569 |       
570 |       render(<FavoriteToggle {...mockProps} />);
571 |       
572 |       const button = screen.getByRole('button');
573 |       
574 |       // First click fails
575 |       fireEvent.click(button);
576 |       
577 |       await waitFor(() => {
578 |         expect(consoleError).toHaveBeenCalled();
579 |         expect(button).not.toBeDisabled();
580 |       });
581 |       
582 |       // Second click should work normally
583 |       mockToggleFavorite.mockResolvedValueOnce(true);
584 |       fireEvent.click(button);
585 |       
586 |       await waitFor(() => {
[TRUNCATED]
```

__tests__/components/icons.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen } from '@testing-library/react';
3 | import { VercelIcon, SpinnerIcon, Github, StarButton, XAiIcon } from '../../components/icons';
4 | 
5 | // Mock Next.js Link component
6 | jest.mock('next/link', () => {
7 |   return ({ href, target, rel, className, children }: any) => (
8 |     <a 
9 |       href={href} 
10 |       target={target} 
11 |       rel={rel}
12 |       className={className}
13 |       data-testid="next-link"
14 |     >
15 |       {children}
16 |     </a>
17 |   );
18 | });
19 | 
20 | describe('Icons Component', () => {
21 |   // Tests for VercelIcon
22 |   describe('VercelIcon', () => {
23 |     describe('Basic Rendering and Props', () => {
24 |       test('renders SVG with default size', () => {
25 |         render(<VercelIcon />);
26 |         
27 |         const svg = screen.getByTitle('Vercel Icon').closest('svg');
28 |         expect(svg).toBeInTheDocument();
29 |         expect(svg).toHaveAttribute('height', '17');
30 |         expect(svg).toHaveAttribute('width', '17');
31 |       });
32 | 
33 |       test('renders SVG with custom size', () => {
34 |         render(<VercelIcon size={24} />);
35 |         
36 |         const svg = screen.getByTitle('Vercel Icon').closest('svg');
37 |         expect(svg).toHaveAttribute('height', '24');
38 |         expect(svg).toHaveAttribute('width', '24');
39 |       });
40 | 
41 |       test('has proper SVG attributes', () => {
42 |         render(<VercelIcon />);
43 |         
44 |         const svg = screen.getByTitle('Vercel Icon').closest('svg');
45 |         expect(svg).toHaveAttribute('viewBox', '0 0 16 16');
46 |         expect(svg).toHaveAttribute('stroke-linejoin', 'round');
47 |         // Color style is set via inline style attribute
48 |         expect(svg).toHaveAttribute('style', expect.stringContaining('color: currentcolor'));
49 |       });
50 | 
51 |       test('contains triangle path element', () => {
52 |         render(<VercelIcon />);
53 |         
54 |         const svg = screen.getByTitle('Vercel Icon').closest('svg');
55 |         const path = svg?.querySelector('path');
56 |         expect(path).toBeInTheDocument();
57 |         expect(path).toHaveAttribute('d', 'M8 1L16 15H0L8 1Z');
58 |         expect(path).toHaveAttribute('fill', 'currentColor');
59 |         expect(path).toHaveAttribute('fill-rule', 'evenodd');
60 |         expect(path).toHaveAttribute('clip-rule', 'evenodd');
61 |       });
62 |     });
63 | 
64 |     describe('Accessibility', () => {
65 |       test('has accessible title', () => {
66 |         render(<VercelIcon />);
67 |         
68 |         const title = screen.getByText('Vercel Icon');
69 |         expect(title).toBeInTheDocument();
70 |       });
71 | 
72 |       test('SVG can be found by title', () => {
73 |         render(<VercelIcon />);
74 |         
75 |         const title = screen.getByTitle('Vercel Icon');
76 |         expect(title).toBeInTheDocument();
77 |         const svg = title.closest('svg');
78 |         expect(svg).toBeInTheDocument();
79 |       });
80 |     });
81 |   });
82 | 
83 |   // Tests for SpinnerIcon
84 |   describe('SpinnerIcon', () => {
85 |     describe('Basic Rendering and Props', () => {
86 |       test('renders SVG with default size', () => {
87 |         render(<SpinnerIcon />);
88 |         
89 |         const svg = screen.getByTitle('Spinner Icon').closest('svg');
90 |         expect(svg).toBeInTheDocument();
91 |         expect(svg).toHaveAttribute('height', '16');
92 |         expect(svg).toHaveAttribute('width', '16');
93 |       });
94 | 
95 |       test('renders SVG with custom size', () => {
96 |         render(<SpinnerIcon size={32} />);
97 |         
98 |         const svg = screen.getByTitle('Spinner Icon').closest('svg');
99 |         expect(svg).toHaveAttribute('height', '32');
100 |         expect(svg).toHaveAttribute('width', '32');
101 |       });
102 | 
103 |       test('has proper SVG attributes', () => {
104 |         render(<SpinnerIcon />);
105 |         
106 |         const svg = screen.getByTitle('Spinner Icon').closest('svg');
107 |         expect(svg).toHaveAttribute('viewBox', '0 0 16 16');
108 |         expect(svg).toHaveAttribute('stroke-linejoin', 'round');
109 |         // Color style is set via inline style attribute
110 |         expect(svg).toHaveAttribute('style', expect.stringContaining('color: currentcolor'));
111 |       });
112 | 
113 |       test('contains spinner path elements with varying opacity', () => {
114 |         render(<SpinnerIcon />);
115 |         
116 |         const svg = screen.getByTitle('Spinner Icon').closest('svg');
117 |         const paths = svg?.querySelectorAll('path');
118 |         
119 |         // Should have multiple paths for spinner animation
120 |         expect(paths?.length).toBeGreaterThan(1);
121 |         
122 |         // Check that paths have different opacity values for animation effect
123 |         const opacityValues = Array.from(paths || []).map(path => path.getAttribute('opacity')).filter(Boolean);
124 |         expect(opacityValues.length).toBeGreaterThan(0);
125 |         expect(new Set(opacityValues).size).toBeGreaterThan(1); // Multiple different opacity values
126 |       });
127 | 
128 |       test('contains clipPath definition for proper rendering', () => {
129 |         render(<SpinnerIcon />);
130 |         
131 |         const svg = screen.getByTitle('Spinner Icon').closest('svg');
132 |         const clipPath = svg?.querySelector('clipPath');
133 |         expect(clipPath).toBeInTheDocument();
134 |         expect(clipPath).toHaveAttribute('id', 'clip0_2393_1490');
135 |         
136 |         const rect = clipPath?.querySelector('rect');
137 |         expect(rect).toBeInTheDocument();
138 |         expect(rect).toHaveAttribute('width', '16');
139 |         expect(rect).toHaveAttribute('height', '16');
140 |       });
141 |     });
142 | 
143 |     describe('Accessibility', () => {
144 |       test('has accessible title', () => {
145 |         render(<SpinnerIcon />);
146 |         
147 |         const title = screen.getByText('Spinner Icon');
148 |         expect(title).toBeInTheDocument();
149 |       });
150 | 
151 |       test('SVG can be found by title', () => {
152 |         render(<SpinnerIcon />);
153 |         
154 |         const title = screen.getByTitle('Spinner Icon');
155 |         expect(title).toBeInTheDocument();
156 |         const svg = title.closest('svg');
157 |         expect(svg).toBeInTheDocument();
158 |       });
159 |     });
160 |   });
161 | 
162 |   // Tests for Github
163 |   describe('Github', () => {
164 |     describe('Basic Rendering and Props', () => {
165 |       test('renders SVG with default attributes', () => {
166 |         render(<Github />);
167 |         
168 |         const svg = screen.getByTitle('GitHub Icon').closest('svg');
169 |         expect(svg).toBeInTheDocument();
170 |         expect(svg).toHaveAttribute('width', '1em');
171 |         expect(svg).toHaveAttribute('height', '1em');
172 |         expect(svg).toHaveAttribute('fill', 'currentColor');
173 |       });
174 | 
175 |       test('renders with custom props via spread operator', () => {
176 |         render(<Github className="custom-class" width="24" height="24" />);
177 |         
178 |         const svg = screen.getByTitle('GitHub Icon').closest('svg');
179 |         expect(svg).toHaveClass('custom-class');
180 |         expect(svg).toHaveAttribute('width', '24');
181 |         expect(svg).toHaveAttribute('height', '24');
182 |       });
183 | 
184 |       test('has proper SVG attributes', () => {
185 |         render(<Github />);
186 |         
187 |         const svg = screen.getByTitle('GitHub Icon').closest('svg');
188 |         expect(svg).toHaveAttribute('viewBox', '0 0 256 250');
189 |         expect(svg).toHaveAttribute('xmlns', 'http://www.w3.org/2000/svg');
190 |         expect(svg).toHaveAttribute('preserveAspectRatio', 'xMidYMid');
191 |       });
192 | 
193 |       test('contains GitHub logo path', () => {
194 |         render(<Github />);
195 |         
196 |         const svg = screen.getByTitle('GitHub Icon').closest('svg');
197 |         const path = svg?.querySelector('path');
198 |         expect(path).toBeInTheDocument();
199 |         expect(path).toHaveAttribute('d');
200 |         expect(path?.getAttribute('d')).toContain('M128.001 0C57.317 0');
201 |       });
202 |     });
203 | 
204 |     describe('Accessibility', () => {
205 |       test('has accessible title', () => {
206 |         render(<Github />);
207 |         
208 |         const title = screen.getByText('GitHub Icon');
209 |         expect(title).toBeInTheDocument();
210 |       });
211 | 
212 |       test('SVG can be found by title', () => {
213 |         render(<Github />);
214 |         
215 |         const title = screen.getByTitle('GitHub Icon');
216 |         expect(title).toBeInTheDocument();
217 |         const svg = title.closest('svg');
218 |         expect(svg).toBeInTheDocument();
219 |       });
220 |     });
221 | 
222 |     describe('Props Handling', () => {
223 |       test('forwards all SVG props correctly', () => {
224 |         render(
225 |           <Github 
226 |             data-testid="github-svg"
227 |             role="button"
228 |             aria-label="Custom GitHub Label"
229 |             onClick={() => {}}
230 |           />
231 |         );
232 |         
233 |         const svg = screen.getByTestId('github-svg');
234 |         expect(svg).toHaveAttribute('role', 'button');
235 |         expect(svg).toHaveAttribute('aria-label', 'Custom GitHub Label');
236 |         expect(svg).toHaveProperty('onclick');
237 |       });
238 |     });
239 |   });
240 | 
241 |   // Tests for StarButton
242 |   describe('StarButton', () => {
243 |     describe('Basic Rendering and Props', () => {
244 |       test('renders as a link with correct attributes', () => {
245 |         render(<StarButton />);
246 |         
247 |         const link = screen.getByTestId('next-link');
248 |         expect(link).toBeInTheDocument();
249 |         expect(link).toHaveAttribute('href', 'https://github.com/vercel-labs/ai-sdk-preview-reasoning');
250 |         expect(link).toHaveAttribute('target', '_blank');
251 |         expect(link).toHaveAttribute('rel', 'noopener noreferrer');
252 |       });
253 | 
254 |       test('has proper CSS classes', () => {
255 |         render(<StarButton />);
256 |         
257 |         const link = screen.getByTestId('next-link');
258 |         expect(link).toHaveClass(
259 |           'flex',
260 |           'items-center', 
261 |           'gap-2',
262 |           'text-sm',
263 |           'text-zinc-600',
264 |           'dark:text-zinc-300',
265 |           'hover:text-zinc-700',
266 |           'dark:hover:text-zinc-300'
267 |         );
268 |       });
269 | 
270 |       test('contains GitHub icon', () => {
271 |         render(<StarButton />);
272 |         
273 |         const githubIcon = screen.getByTitle('GitHub Icon').closest('svg');
274 |         expect(githubIcon).toBeInTheDocument();
275 |         expect(githubIcon).toHaveClass('size-4');
276 |       });
277 | 
278 |       test('contains text that is hidden on small screens', () => {
279 |         render(<StarButton />);
280 |         
281 |         const text = screen.getByText('Star on GitHub');
282 |         expect(text).toBeInTheDocument();
283 |         expect(text).toHaveClass('hidden', 'sm:inline');
284 |       });
285 |     });
286 | 
287 |     describe('Accessibility', () => {
288 |       test('link is accessible with proper text content', () => {
289 |         render(<StarButton />);
290 |         
291 |         const link = screen.getByRole('link', { name: /star on github/i });
292 |         expect(link).toBeInTheDocument();
293 |       });
294 | 
295 |       test('opens in new tab with proper security attributes', () => {
296 |         render(<StarButton />);
297 |         
298 |         const link = screen.getByTestId('next-link');
299 |         expect(link).toHaveAttribute('target', '_blank');
300 |         expect(link).toHaveAttribute('rel', 'noopener noreferrer');
301 |       });
302 |     });
303 | 
304 |     describe('Integration', () => {
305 |       test('GitHub icon is properly sized within button', () => {
306 |         render(<StarButton />);
307 |         
308 |         const githubIcon = screen.getByTitle('GitHub Icon').closest('svg');
309 |         expect(githubIcon).toHaveClass('size-4');
310 |       });
311 |     });
312 |   });
313 | 
314 |   // Tests for XAiIcon
315 |   describe('XAiIcon', () => {
316 |     describe('Basic Rendering and Props', () => {
317 |       test('renders SVG with default size', () => {
318 |         render(<XAiIcon />);
319 |         
320 |         const svg = screen.getByTitle('xAI Icon').closest('svg');
321 |         expect(svg).toBeInTheDocument();
322 |         expect(svg).toHaveAttribute('height', '16');
323 |       });
324 | 
325 |       test('renders SVG with custom size', () => {
326 |         render(<XAiIcon size={48} />);
327 |         
328 |         const svg = screen.getByTitle('xAI Icon').closest('svg');
329 |         expect(svg).toHaveAttribute('height', '48');
330 |       });
331 | 
332 |       test('has proper SVG attributes', () => {
333 |         render(<XAiIcon />);
334 |         
335 |         const svg = screen.getByTitle('xAI Icon').closest('svg');
336 |         expect(svg).toHaveAttribute('xmlns', 'http://www.w3.org/2000/svg');
337 |         expect(svg).toHaveAttribute('version', '1.1');
338 |         expect(svg).toHaveAttribute('viewBox', '0 0 438.7 481.4');
339 |       });
340 | 
341 |       test('contains xAI logo path', () => {
342 |         render(<XAiIcon />);
343 |         
344 |         const svg = screen.getByTitle('xAI Icon').closest('svg');
345 |         const path = svg?.querySelector('path');
346 |         expect(path).toBeInTheDocument();
347 |         expect(path).toHaveAttribute('d');
348 |         expect(path?.getAttribute('d')).toContain('M355.5,155.1l8.3,326.4h66.6l8.3-445.2');
349 |       });
350 |     });
351 | 
352 |     describe('Accessibility', () => {
353 |       test('has accessible title', () => {
354 |         render(<XAiIcon />);
355 |         
356 |         const title = screen.getByText('xAI Icon');
357 |         expect(title).toBeInTheDocument();
358 |       });
359 | 
360 |       test('SVG can be found by title', () => {
361 |         render(<XAiIcon />);
362 |         
363 |         const title = screen.getByTitle('xAI Icon');
364 |         expect(title).toBeInTheDocument();
365 |         const svg = title.closest('svg');
366 |         expect(svg).toBeInTheDocument();
367 |       });
368 |     });
369 |   });
370 | 
371 |   // Integration Tests
372 |   describe('Integration Tests', () => {
373 |     test('all icon components render together without conflicts', () => {
374 |       render(
375 |         <div>
376 |           <VercelIcon size={20} />
377 |           <SpinnerIcon size={20} />
378 |           <Github className="test-github" />
379 |           <StarButton />
380 |           <XAiIcon size={20} />
381 |         </div>
382 |       );
383 | 
384 |       expect(screen.getByTitle('Vercel Icon').closest('svg')).toBeInTheDocument();
385 |       expect(screen.getByTitle('Spinner Icon').closest('svg')).toBeInTheDocument();
386 |       expect(screen.getAllByTitle('GitHub Icon')[0].closest('svg')).toBeInTheDocument();
387 |       expect(screen.getByRole('link', { name: /star on github/i })).toBeInTheDocument();
388 |       expect(screen.getByTitle('xAI Icon').closest('svg')).toBeInTheDocument();
389 |     });
390 | 
391 |     test('icons maintain accessibility when used together', () => {
392 |       render(
393 |         <div>
394 |           <VercelIcon />
395 |           <SpinnerIcon />
396 |           <Github />
397 |           <XAiIcon />
398 |         </div>
399 |       );
400 | 
401 |       // All should have unique accessible names
402 |       const vercelTitle = screen.getByTitle('Vercel Icon');
403 |       const spinnerTitle = screen.getByTitle('Spinner Icon');
404 |       const githubTitle = screen.getByTitle('GitHub Icon');
405 |       const xaiTitle = screen.getByTitle('xAI Icon');
406 |       
407 |       expect(vercelTitle).toBeInTheDocument();
408 |       expect(spinnerTitle).toBeInTheDocument();
409 |       expect(githubTitle).toBeInTheDocument();
410 |       expect(xaiTitle).toBeInTheDocument();
411 |       
412 |       // All titles should be unique
413 |       const titleTexts = [vercelTitle, spinnerTitle, githubTitle, xaiTitle].map(t => t.textContent);
414 |       const uniqueTitles = new Set(titleTexts);
415 |       expect(uniqueTitles.size).toBe(4);
416 |     });
417 | 
418 |     test('custom sizes work correctly across all components', () => {
419 |       const customSize = 28;
420 |       render(
421 |         <div>
422 |           <VercelIcon size={customSize} />
423 |           <SpinnerIcon size={customSize} />
424 |           <XAiIcon size={customSize} />
425 |         </div>
426 |       );
427 | 
428 |       const vercelIcon = screen.getByTitle('Vercel Icon').closest('svg');
429 |       const spinnerIcon = screen.getByTitle('Spinner Icon').closest('svg');
430 |       const xaiIcon = screen.getByTitle('xAI Icon').closest('svg');
431 | 
432 |       expect(vercelIcon).toHaveAttribute('height', customSize.toString());
433 |       expect(vercelIcon).toHaveAttribute('width', customSize.toString());
434 |       expect(spinnerIcon).toHaveAttribute('height', customSize.toString());
435 |       expect(spinnerIcon).toHaveAttribute('width', customSize.toString());
436 |       expect(xaiIcon).toHaveAttribute('height', customSize.toString());
437 |     });
438 |   });
439 | 
440 |   // Edge Cases and Error Handling
441 |   describe('Edge Cases', () => {
442 |     test('handles zero size gracefully', () => {
443 |       render(<VercelIcon size={0} />);
444 |       
445 |       const svg = screen.getByTitle('Vercel Icon').closest('svg');
446 |       expect(svg).toHaveAttribute('height', '0');
447 |       expect(svg).toHaveAttribute('width', '0');
448 |     });
449 | 
450 |     test('handles very large size values', () => {
451 |       const largeSize = 9999;
452 |       render(<SpinnerIcon size={largeSize} />);
453 |       
454 |       const svg = screen.getByTitle('Spinner Icon').closest('svg');
455 |       expect(svg).toHaveAttribute('height', largeSize.toString());
456 |       expect(svg).toHaveAttribute('width', largeSize.toString());
457 |     });
458 | 
459 |     test('Github component handles undefined props gracefully', () => {
460 |       render(<Github />);
461 |       
462 |       const svg = screen.getByTitle('GitHub Icon').closest('svg');
463 |       expect(svg).toBeInTheDocument();
464 |       // Should not crash and should render with default props
465 |     });
466 |   });
467 | });
```

__tests__/components/image-modal.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';
3 | import { ImageModal } from '../../components/image-modal';
4 | 
5 | // Clean up after each test
6 | afterEach(() => {
7 |   cleanup();
8 | });
9 | 
10 | // Mock UI components with simpler structure
11 | jest.mock('../../components/ui/dialog', () => ({
12 |   Dialog: ({ children, open }: any) => open ? <div data-testid="dialog">{children}</div> : null,
13 |   DialogContent: ({ children, className }: any) => <div className={className} data-testid="dialog-content">{children}</div>,
14 |   DialogDescription: ({ children, className }: any) => <p className={className} data-testid="dialog-description">{children}</p>,
15 |   DialogFooter: ({ children, className }: any) => <div className={className} data-testid="dialog-footer">{children}</div>,
16 |   DialogHeader: ({ children, className }: any) => <div className={className} data-testid="dialog-header">{children}</div>,
17 |   DialogTitle: ({ children, className }: any) => <h2 className={className} data-testid="dialog-title">{children}</h2>,
18 |   DialogOverlay: ({ className }: any) => <div className={className} data-testid="dialog-overlay" />,
19 |   DialogPortal: ({ children }: any) => <div data-testid="dialog-portal">{children}</div>,
20 | }));
21 | 
22 | jest.mock('../../components/ui/button', () => ({
23 |   Button: ({ children, onClick, variant, size, className, ...props }: any) => (
24 |     <button 
25 |       onClick={onClick} 
26 |       className={className} 
27 |       data-variant={variant}
28 |       data-size={size}
29 |       data-testid={`button-${variant || 'default'}`}
30 |       {...props}
31 |     >
32 |       {children}
33 |     </button>
34 |   ),
35 | }));
36 | 
37 | // Mock Lucide icons
38 | jest.mock('lucide-react', () => ({
39 |   Download: ({ className }: any) => <div className={className} data-testid="download-icon" />,
40 |   X: ({ className }: any) => <div className={className} data-testid="x-icon" />,
41 | }));
42 | 
43 | // Mock utility functions
44 | jest.mock('../../lib/image-utils', () => ({
45 |   formatFileSize: (size: number) => `${(size / 1024).toFixed(1)} KB`,
46 | }));
47 | 
48 | jest.mock('../../lib/utils', () => ({
49 |   cn: (...classes: string[]) => classes.filter(Boolean).join(' '),
50 | }));
51 | 
52 | // Mock Radix Dialog with simpler structure
53 | jest.mock('@radix-ui/react-dialog', () => ({
54 |   Content: ({ children, className, ...props }: any) => (
55 |     <div className={className} data-testid="radix-content" {...props}>
56 |       {children}
57 |     </div>
58 |   ),
59 |   Title: ({ children, asChild }: any) => 
60 |     asChild ? children : <h3 data-testid="radix-title">{children}</h3>,
61 |   Close: ({ children, asChild }: any) => 
62 |     asChild ? children : <button data-testid="radix-close">{children}</button>,
63 | }));
64 | 
65 | describe('ImageModal Component', () => {
66 |   const mockOnClose = jest.fn();
67 |   const defaultProps = {
68 |     isOpen: true,
69 |     onClose: mockOnClose,
70 |     imageUrl: 'https://example.com/test-image.jpg',
71 |   };
72 | 
73 |   beforeEach(() => {
74 |     jest.clearAllMocks();
75 |     
76 |     // Mock document methods for download functionality
77 |     const mockLink = {
78 |       href: '',
79 |       download: '',
80 |       click: jest.fn(),
81 |     };
82 |     document.createElement = jest.fn().mockReturnValue(mockLink);
83 |     document.body.appendChild = jest.fn();
84 |     document.body.removeChild = jest.fn();
85 |   });
86 | 
87 |   // Test the component logic without full rendering
88 |   describe('Component Logic', () => {
89 |     test('handles download functionality correctly', () => {
90 |       const mockLink = {
91 |         href: '',
92 |         download: '',
93 |         click: jest.fn(),
94 |       };
95 |       document.createElement = jest.fn().mockReturnValue(mockLink);
96 | 
97 |       // Test the download logic directly
98 |       const link = document.createElement('a');
99 |       link.href = 'https://example.com/test-image.jpg';
100 |       link.download = 'test-image.jpg';
101 |       document.body.appendChild(link);
102 |       link.click();
103 |       document.body.removeChild(link);
104 | 
105 |       expect(document.createElement).toHaveBeenCalledWith('a');
106 |       expect(mockLink.href).toBe('https://example.com/test-image.jpg');
107 |       expect(mockLink.download).toBe('test-image.jpg');
108 |       expect(mockLink.click).toHaveBeenCalled();
109 |       expect(document.body.appendChild).toHaveBeenCalledWith(mockLink);
110 |       expect(document.body.removeChild).toHaveBeenCalledWith(mockLink);
111 |     });
112 | 
113 |     test('formats filename correctly with different inputs', () => {
114 |       // Test filename logic
115 |       const getDisplayFilename = (filename?: string, metadata?: any) => {
116 |         return filename || metadata?.filename || 'Uploaded image';
117 |       };
118 | 
119 |       expect(getDisplayFilename('custom.jpg')).toBe('custom.jpg');
120 |       expect(getDisplayFilename(undefined, { filename: 'metadata.jpg' })).toBe('metadata.jpg');
121 |       expect(getDisplayFilename(undefined, {})).toBe('Uploaded image');
122 |       expect(getDisplayFilename(undefined, undefined)).toBe('Uploaded image');
123 |     });
124 | 
125 |     test('formats download filename correctly', () => {
126 |       // Test download filename logic
127 |       const getDownloadFilename = (filename?: string, metadata?: any) => {
128 |         return filename || metadata?.filename || 'image';
129 |       };
130 | 
131 |       expect(getDownloadFilename('download.jpg')).toBe('download.jpg');
132 |       expect(getDownloadFilename(undefined, { filename: 'metadata.jpg' })).toBe('metadata.jpg');
133 |       expect(getDownloadFilename(undefined, {})).toBe('image');
134 |       expect(getDownloadFilename(undefined, undefined)).toBe('image');
135 |     });
136 |   });
137 | 
138 |   // Test utility functions
139 |   describe('Utility Functions', () => {
140 |     test('formatFileSize formats bytes correctly', () => {
141 |       const { formatFileSize } = require('../../lib/image-utils');
142 |       
143 |       expect(formatFileSize(1024)).toBe('1.0 KB');
144 |       expect(formatFileSize(2048)).toBe('2.0 KB');
145 |       expect(formatFileSize(512)).toBe('0.5 KB');
146 |     });
147 | 
148 |     test('cn utility combines classes correctly', () => {
149 |       const { cn } = require('../../lib/utils');
150 |       
151 |       expect(cn('class1', 'class2')).toBe('class1 class2');
152 |       expect(cn('class1', undefined, 'class2')).toBe('class1 class2');
153 |       expect(cn('class1', null, 'class2')).toBe('class1 class2');
154 |       expect(cn('class1', '', 'class2')).toBe('class1 class2');
155 |     });
156 |   });
157 | 
158 |   // Test component props and interface
159 |   describe('Component Interface', () => {
160 |     test('accepts correct props structure', () => {
161 |       const props = {
162 |         isOpen: true,
163 |         onClose: jest.fn(),
164 |         imageUrl: 'https://example.com/image.jpg',
165 |         filename: 'test.jpg',
166 |         metadata: {
167 |           filename: 'metadata.jpg',
168 |           size: 1024,
169 |           width: 800,
170 |           height: 600
171 |         },
172 |         detail: 'high'
173 |       };
174 | 
175 |       // Verify the props structure is valid
176 |       expect(props.isOpen).toBe(true);
177 |       expect(typeof props.onClose).toBe('function');
178 |       expect(props.imageUrl).toBe('https://example.com/image.jpg');
179 |       expect(props.filename).toBe('test.jpg');
180 |       expect(props.metadata).toHaveProperty('filename');
181 |       expect(props.metadata).toHaveProperty('size');
182 |       expect(props.metadata).toHaveProperty('width');
183 |       expect(props.metadata).toHaveProperty('height');
184 |       expect(props.detail).toBe('high');
185 |     });
186 | 
187 |     test('handles optional props correctly', () => {
188 |       const minimalProps = {
189 |         isOpen: false,
190 |         onClose: jest.fn(),
191 |         imageUrl: 'https://example.com/image.jpg'
192 |       };
193 | 
194 |       // Verify minimal props work
195 |       expect(minimalProps.isOpen).toBe(false);
196 |       expect(typeof minimalProps.onClose).toBe('function');
197 |       expect(minimalProps.imageUrl).toBe('https://example.com/image.jpg');
198 |       expect(minimalProps).not.toHaveProperty('filename');
199 |       expect(minimalProps).not.toHaveProperty('metadata');
200 |       expect(minimalProps).not.toHaveProperty('detail');
201 |     });
202 |   });
203 | });
```

__tests__/components/image-preview.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent } from '@testing-library/react';
3 | import { ImagePreview, ImagePreviewLoading, ImagePreviewError } from '../../components/image-preview';
4 | import type { ImageAttachment } from '../../lib/types';
5 | 
6 | // Mock formatFileSize utility
7 | jest.mock('../../lib/image-utils', () => ({
8 |   formatFileSize: jest.fn((bytes: number) => {
9 |     if (bytes === 0) return '0 Bytes';
10 |     const k = 1024;
11 |     const sizes = ['Bytes', 'KB', 'MB', 'GB'];
12 |     const i = Math.floor(Math.log(bytes) / Math.log(k));
13 |     return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
14 |   }),
15 | }));
16 | 
17 | // Mock UI components
18 | jest.mock('../../components/ui/button', () => ({
19 |   Button: ({ children, onClick, variant, size, className, 'aria-label': ariaLabel, ...props }: any) => (
20 |     <button 
21 |       onClick={onClick} 
22 |       className={className}
23 |       aria-label={ariaLabel}
24 |       data-variant={variant}
25 |       data-size={size}
26 |       {...props}
27 |     >
28 |       {children}
29 |     </button>
30 |   ),
31 | }));
32 | 
33 | // Mock Lucide icons
34 | jest.mock('lucide-react', () => ({
35 |   X: () => <div data-testid="x-icon" />,
36 | }));
37 | 
38 | describe('ImagePreview', () => {
39 |   const createMockImage = (overrides: Partial<ImageAttachment> = {}): ImageAttachment => ({
40 |     dataUrl: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ',
41 |     metadata: {
42 |       filename: 'test-image.jpg',
43 |       size: 1024000, // 1MB
44 |       mimeType: 'image/jpeg',
45 |       width: 800,
46 |       height: 600,
47 |     },
48 |     detail: 'auto',
49 |     ...overrides,
50 |   });
51 | 
52 |   const mockOnRemove = jest.fn();
53 |   const mockOnReorder = jest.fn();
54 | 
55 |   beforeEach(() => {
56 |     jest.clearAllMocks();
57 |   });
58 | 
59 |   // Tests for Basic Rendering and Props
60 |   describe('Basic Rendering and Props', () => {
61 |     test('renders nothing when images array is empty', () => {
62 |       const { container } = render(
63 |         <ImagePreview images={[]} onRemove={mockOnRemove} />
64 |       );
65 |       
66 |       expect(container.firstChild).toBeNull();
67 |     });
68 | 
69 |     test('renders single image with default props', () => {
70 |       const images = [createMockImage()];
71 |       
72 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
73 |       
74 |       expect(screen.getByAltText('test-image.jpg')).toBeInTheDocument();
75 |       expect(screen.getByText('test-image.jpg')).toBeInTheDocument();
76 |       expect(screen.getByText('1000 KB • 800×600')).toBeInTheDocument();
77 |     });
78 | 
79 |     test('renders multiple images', () => {
80 |       const images = [
81 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'image1.jpg' } }),
82 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'image2.png' } }),
83 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'image3.webp' } }),
84 |       ];
85 |       
86 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
87 |       
88 |       expect(screen.getByAltText('image1.jpg')).toBeInTheDocument();
89 |       expect(screen.getByAltText('image2.png')).toBeInTheDocument();
90 |       expect(screen.getByAltText('image3.webp')).toBeInTheDocument();
91 |     });
92 | 
93 |     test('applies custom className', () => {
94 |       const images = [createMockImage()];
95 |       
96 |       const { container } = render(
97 |         <ImagePreview 
98 |           images={images} 
99 |           onRemove={mockOnRemove} 
100 |           className="custom-class"
101 |         />
102 |       );
103 |       
104 |       expect(container.firstChild).toHaveClass('image-preview-grid', 'custom-class');
105 |     });
106 | 
107 |     test('applies custom maxWidth and maxHeight styles', () => {
108 |       const images = [createMockImage()];
109 |       
110 |       render(
111 |         <ImagePreview 
112 |           images={images} 
113 |           onRemove={mockOnRemove} 
114 |           maxWidth={150}
115 |           maxHeight={150}
116 |         />
117 |       );
118 |       
119 |       const img = screen.getByAltText('test-image.jpg');
120 |       expect(img).toHaveStyle({
121 |         maxWidth: '150px',
122 |         maxHeight: '150px',
123 |       });
124 |     });
125 |   });
126 | 
127 |   // Tests for Image Display and Metadata
128 |   describe('Image Display and Metadata', () => {
129 |     test('displays image with correct src and alt attributes', () => {
130 |       const images = [createMockImage({
131 |         dataUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==',
132 |         metadata: {
133 |           filename: 'pixel.png',
134 |           size: 100,
135 |           mimeType: 'image/png',
136 |           width: 1,
137 |           height: 1,
138 |         }
139 |       })];
140 |       
141 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
142 |       
143 |       const img = screen.getByAltText('pixel.png');
144 |       expect(img).toHaveAttribute('src', images[0].dataUrl);
145 |       expect(img).toHaveClass('w-full', 'h-auto', 'rounded', 'border', 'border-border', 'object-cover');
146 |       expect(img).toHaveAttribute('loading', 'lazy');
147 |     });
148 | 
149 |     test('displays filename with truncation and title attribute', () => {
150 |       const images = [createMockImage({
151 |         metadata: {
152 |           ...createMockImage().metadata,
153 |           filename: 'very-long-filename-that-should-be-truncated.jpg'
154 |         }
155 |       })];
156 |       
157 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
158 |       
159 |       const filenameElement = screen.getByText('very-long-filename-that-should-be-truncated.jpg');
160 |       expect(filenameElement).toHaveAttribute('title', 'very-long-filename-that-should-be-truncated.jpg');
161 |       expect(filenameElement).toHaveClass('truncate');
162 |     });
163 | 
164 |     test('displays file size and dimensions correctly', () => {
165 |       const images = [createMockImage({
166 |         metadata: {
167 |           filename: 'test.jpg',
168 |           size: 2048000, // 2MB
169 |           mimeType: 'image/jpeg',
170 |           width: 1920,
171 |           height: 1080,
172 |         }
173 |       })];
174 |       
175 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
176 |       
177 |       // Use more flexible text matching since the text might be split across elements
178 |       expect(screen.getByText(/1\.95 MB/)).toBeInTheDocument();
179 |       expect(screen.getByText(/1920×1080/)).toBeInTheDocument();
180 |     });
181 | 
182 |     test('displays only file size when dimensions are zero', () => {
183 |       const images = [createMockImage({
184 |         metadata: {
185 |           filename: 'test.jpg',
186 |           size: 500000,
187 |           mimeType: 'image/jpeg',
188 |           width: 0,
189 |           height: 0,
190 |         }
191 |       })];
192 |       
193 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
194 |       
195 |       expect(screen.getByText('488.28 KB')).toBeInTheDocument();
196 |       expect(screen.queryByText('•')).not.toBeInTheDocument();
197 |     });
198 | 
199 |     test('displays only file size when dimensions are negative', () => {
200 |       const images = [createMockImage({
201 |         metadata: {
202 |           filename: 'test.jpg',
203 |           size: 750000,
204 |           mimeType: 'image/jpeg',
205 |           width: -1,
206 |           height: -1,
207 |         }
208 |       })];
209 |       
210 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
211 |       
212 |       expect(screen.getByText('732.42 KB')).toBeInTheDocument();
213 |       expect(screen.queryByText('•')).not.toBeInTheDocument();
214 |     });
215 |   });
216 | 
217 |   // Tests for Detail Level Indicator
218 |   describe('Detail Level Indicator', () => {
219 |     test('shows detail indicator when detail is "low"', () => {
220 |       const images = [createMockImage({ detail: 'low' })];
221 |       
222 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
223 |       
224 |       expect(screen.getByText('low')).toBeInTheDocument();
225 |       expect(screen.getByText('low')).toHaveClass(
226 |         'absolute', 'bottom-1', 'left-1', 'px-1.5', 'py-0.5', 
227 |         'bg-background/80', 'border', 'border-border', 'rounded', 'text-xs'
228 |       );
229 |     });
230 | 
231 |     test('shows detail indicator when detail is "high"', () => {
232 |       const images = [createMockImage({ detail: 'high' })];
233 |       
234 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
235 |       
236 |       expect(screen.getByText('high')).toBeInTheDocument();
237 |     });
238 | 
239 |     test('does not show detail indicator when detail is "auto"', () => {
240 |       const images = [createMockImage({ detail: 'auto' })];
241 |       
242 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
243 |       
244 |       expect(screen.queryByText('auto')).not.toBeInTheDocument();
245 |     });
246 | 
247 |     test('does not show detail indicator when detail is undefined', () => {
248 |       const images = [createMockImage({ detail: undefined })];
249 |       
250 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
251 |       
252 |       const detailIndicators = screen.queryByText(/^(low|high|auto)$/);
253 |       expect(detailIndicators).not.toBeInTheDocument();
254 |     });
255 |   });
256 | 
257 |   // Tests for Remove Button Functionality
258 |   describe('Remove Button Functionality', () => {
259 |     test('renders remove button with correct aria-label', () => {
260 |       const images = [createMockImage()];
261 |       
262 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
263 |       
264 |       const removeButton = screen.getByLabelText('Remove test-image.jpg');
265 |       expect(removeButton).toBeInTheDocument();
266 |       expect(removeButton).toHaveClass('image-preview-remove');
267 |       expect(removeButton).toHaveAttribute('data-variant', 'destructive');
268 |       expect(removeButton).toHaveAttribute('data-size', 'sm');
269 |     });
270 | 
271 |     test('calls onRemove with correct index when remove button is clicked', () => {
272 |       const images = [
273 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'image1.jpg' } }),
274 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'image2.jpg' } }),
275 |       ];
276 |       
277 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
278 |       
279 |       const firstRemoveButton = screen.getByLabelText('Remove image1.jpg');
280 |       const secondRemoveButton = screen.getByLabelText('Remove image2.jpg');
281 |       
282 |       fireEvent.click(firstRemoveButton);
283 |       expect(mockOnRemove).toHaveBeenCalledWith(0);
284 |       
285 |       fireEvent.click(secondRemoveButton);
286 |       expect(mockOnRemove).toHaveBeenCalledWith(1);
287 |       
288 |       expect(mockOnRemove).toHaveBeenCalledTimes(2);
289 |     });
290 | 
291 |     test('remove button contains X icon', () => {
292 |       const images = [createMockImage()];
293 |       
294 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
295 |       
296 |       const removeButton = screen.getByLabelText('Remove test-image.jpg');
297 |       expect(removeButton.querySelector('[data-testid="x-icon"]')).toBeInTheDocument();
298 |     });
299 |   });
300 | 
301 |   // Tests for Edge Cases and Error Handling
302 |   describe('Edge Cases and Error Handling', () => {
303 |     test('handles images with special characters in filename', () => {
304 |       const images = [createMockImage({
305 |         metadata: {
306 |           ...createMockImage().metadata,
307 |           filename: 'image with spaces & special-chars (1).jpg'
308 |         }
309 |       })];
310 |       
311 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
312 |       
313 |       expect(screen.getByAltText('image with spaces & special-chars (1).jpg')).toBeInTheDocument();
314 |       expect(screen.getByLabelText('Remove image with spaces & special-chars (1).jpg')).toBeInTheDocument();
315 |     });
316 | 
317 |     test('handles very large file sizes', () => {
318 |       const images = [createMockImage({
319 |         metadata: {
320 |           ...createMockImage().metadata,
321 |           size: 1073741824 // 1GB
322 |         }
323 |       })];
324 |       
325 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
326 |       
327 |       expect(screen.getByText('1 GB • 800×600')).toBeInTheDocument();
328 |     });
329 | 
330 |     test('handles zero file size', () => {
331 |       const images = [createMockImage({
332 |         metadata: {
333 |           ...createMockImage().metadata,
334 |           size: 0
335 |         }
336 |       })];
337 |       
338 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
339 |       
340 |       expect(screen.getByText('0 Bytes • 800×600')).toBeInTheDocument();
341 |     });
342 | 
343 |     test('handles empty filename', () => {
344 |       const images = [createMockImage({
345 |         metadata: {
346 |           ...createMockImage().metadata,
347 |           filename: ''
348 |         }
349 |       })];
350 |       
351 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
352 |       
353 |       expect(screen.getByAltText('')).toBeInTheDocument();
354 |       // The aria-label will be "Remove " (with trailing space)
355 |       expect(screen.getByRole('button', { name: /Remove\s*$/ })).toBeInTheDocument();
356 |     });
357 | 
358 |     test('generates correct keys for images with same filename', () => {
359 |       const images = [
360 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'duplicate.jpg' } }),
361 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'duplicate.jpg' } }),
362 |       ];
363 |       
364 |       const { container } = render(<ImagePreview images={images} onRemove={mockOnRemove} />);
365 |       
366 |       const imageItems = container.querySelectorAll('.image-preview-item');
367 |       expect(imageItems).toHaveLength(2);
368 |     });
369 |   });
370 | 
371 |   // Tests for Accessibility
372 |   describe('Accessibility', () => {
373 |     test('remove buttons are keyboard accessible', () => {
374 |       const images = [createMockImage()];
375 |       
376 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
377 |       
378 |       const removeButton = screen.getByLabelText('Remove test-image.jpg');
379 |       
380 |       // Button should be focusable
381 |       removeButton.focus();
382 |       expect(document.activeElement).toBe(removeButton);
383 |       
384 |       // Should be clickable via keyboard
385 |       fireEvent.keyDown(removeButton, { key: 'Enter' });
386 |       // Note: Button onClick should be triggered by Enter key in real browser
387 |     });
388 | 
389 |     test('images have proper alt text for screen readers', () => {
390 |       const images = [
391 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'screenshot.png' } }),
392 |         createMockImage({ metadata: { ...createMockImage().metadata, filename: 'photo.jpg' } }),
393 |       ];
394 |       
395 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
396 |       
397 |       expect(screen.getByAltText('screenshot.png')).toBeInTheDocument();
398 |       expect(screen.getByAltText('photo.jpg')).toBeInTheDocument();
399 |     });
400 | 
401 |     test('file info is properly structured for screen readers', () => {
402 |       const images = [createMockImage()];
403 |       
404 |       render(<ImagePreview images={images} onRemove={mockOnRemove} />);
405 |       
406 |       const filenameElement = screen.getByText('test-image.jpg');
407 |       const sizeElement = screen.getByText('1000 KB • 800×600');
408 |       
409 |       expect(filenameElement).toHaveClass('text-xs', 'font-medium');
410 |       expect(sizeElement).toHaveClass('text-xs', 'text-muted-foreground');
411 |     });
412 |   });
413 | });
414 | 
415 | describe('ImagePreviewLoading', () => {
416 |   test('renders single loading placeholder by default', () => {
417 |     const { container } = render(<ImagePreviewLoading />);
418 |     
419 |     expect(container.firstChild).toHaveClass('image-preview-grid');
420 |     
421 |     const loadingItems = container.querySelectorAll('.image-preview-item');
422 |     expect(loadingItems).toHaveLength(1);
423 |     
424 |     const animatedElement = container.querySelector('.animate-pulse');
425 |     expect(animatedElement).toBeInTheDocument();
426 |   });
427 | 
428 |   test('renders multiple loading placeholders when count is specified', () => {
429 |     const { container } = render(<ImagePreviewLoading count={3} />);
430 |     
431 |     const loadingItems = container.querySelectorAll('.image-preview-item');
432 |     expect(loadingItems).toHaveLength(3);
433 |   });
434 | 
435 |   test('applies correct CSS classes for loading animation', () => {
436 |     const { container } = render(<ImagePreviewLoading />);
437 |     
438 |     expect(container.firstChild).toHaveClass('image-preview-grid');
439 |     
440 |     const animatedElement = container.querySelector('.animate-pulse');
441 |     expect(animatedElement).toBeInTheDocument();
442 |   });
443 | 
444 |   test('renders loading placeholders with correct structure', () => {
445 |     const { container } = render(<ImagePreviewLoading count={2} />);
446 |     
447 |     const loadingItems = container.querySelectorAll('.image-preview-item');
448 |     expect(loadingItems).toHaveLength(2);
449 |     
450 |     // Check for skeleton elements
451 |     const imageSkeletons = container.querySelectorAll('.w-full.h-24.bg-muted.rounded.border.border-border');
452 |     const textSkeletons = container.querySelectorAll('.h-3.bg-muted.rounded, .h-2.bg-muted.rounded');
453 |     
454 |     expect(imageSkeletons).toHaveLength(2);
455 |     expect(textSkeletons.length).toBeGreaterThan(0);
456 |   });
457 | });
458 | 
459 | describe('ImagePreviewError', () => {
460 |   const mockOnRetry = jest.fn();
461 | 
462 |   beforeEach(() => {
463 |     jest.clearAllMocks();
464 |   });
465 | 
466 |   test('renders error message', () => {
467 |     render(<ImagePreviewError error="Failed to load image" />);
468 |     
469 |     expect(screen.getByText('Failed to load image')).toBeInTheDocument();
470 |   });
471 | 
472 |   test('applies correct error styling', () => {
473 |     const { container } = render(<ImagePreviewError error="Test error" />);
474 |     
475 |     const errorContainer = container.firstChild;
476 |     expect(errorContainer).toHaveClass(
477 |       'p-3', 'border', 'border-destructive/20', 'bg-destructive/5', 'rounded-md'
478 |     );
479 |     
480 |     const errorText = screen.getByText('Test error');
481 |     expect(errorText).toHaveClass('text-sm', 'text-destructive');
482 |   });
483 | 
484 |   test('renders retry button when onRetry is provided', () => {
485 |     render(<ImagePreviewError error="Network error" onRetry={mockOnRetry} />);
486 |     
487 |     const retryButton = screen.getByRole('button', { name: 'Retry' });
488 |     expect(retryButton).toBeInTheDocument();
489 |     expect(retryButton).toHaveAttribute('data-variant', 'outline');
490 |     expect(retryButton).toHaveAttribute('data-size', 'sm');
491 |   });
492 | 
493 |   test('does not render retry button when onRetry is not provided', () => {
494 |     render(<ImagePreviewError error="Permanent error" />);
495 |     
496 |     expect(screen.queryByRole('button', { name: 'Retry' })).not.toBeInTheDocument();
497 |   });
498 | 
499 |   test('calls onRetry when retry button is clicked', () => {
500 |     render(<ImagePreviewError error="Temporary error" onRetry={mockOnRetry} />);
501 |     
502 |     const retryButton = screen.getByRole('button', { name: 'Retry' });
503 |     fireEvent.click(retryButton);
504 |     
505 |     expect(mockOnRetry).toHaveBeenCalledTimes(1);
506 |   });
507 | 
508 |   test('handles long error messages', () => {
509 |     const longError = 'This is a very long error message that should be displayed properly without breaking the layout or causing any visual issues in the error component.';
510 |     
511 |     render(<ImagePreviewError error={longError} onRetry={mockOnRetry} />);
512 |     
513 |     expect(screen.getByText(longError)).toBeInTheDocument();
514 |   });
515 | 
516 |   test('error component is keyboard accessible', () => {
517 |     render(<ImagePreviewError error="Test error" onRetry={mockOnRetry} />);
518 |     
519 |     const retryButton = screen.getByRole('button', { name: 'Retry' });
520 |     
521 |     retryButton.focus();
522 |     expect(document.activeElement).toBe(retryButton);
523 |   });
524 | });
```

__tests__/components/image-upload.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { ImageUpload, ImageUploadStatus } from '../../components/image-upload';
4 | import type { ImageAttachment } from '../../lib/types';
5 | import { validateImageFile, processImageFile } from '../../lib/image-utils';
6 | 
7 | // Mock image-utils functions
8 | jest.mock('../../lib/image-utils', () => ({
9 |   validateImageFile: jest.fn(),
10 |   processImageFile: jest.fn(),
11 | }));
12 | 
13 | const mockValidateImageFile = validateImageFile as jest.MockedFunction<typeof validateImageFile>;
14 | const mockProcessImageFile = processImageFile as jest.MockedFunction<typeof processImageFile>;
15 | 
16 | // Mock UI components
17 | jest.mock('../../components/ui/button', () => ({
18 |   Button: ({ children, onClick, variant, size, disabled, className, type = 'button', ...props }: any) => (
19 |     <button 
20 |       onClick={onClick} 
21 |       className={className} 
22 |       disabled={disabled}
23 |       type={type}
24 |       data-variant={variant}
25 |       data-size={size}
26 |       data-testid={`button-${variant || 'default'}`}
27 |       {...props}
28 |     >
29 |       {children}
30 |     </button>
31 |   ),
32 | }));
33 | 
34 | jest.mock('../../components/ui/label', () => ({
35 |   Label: ({ children, htmlFor, className }: any) => (
36 |     <label htmlFor={htmlFor} className={className} data-testid={`label-${htmlFor}`}>
37 |       {children}
38 |     </label>
39 |   ),
40 | }));
41 | 
42 | jest.mock('../../components/ui/select', () => ({
43 |   Select: ({ children, value, onValueChange }: any) => (
44 |     <div data-testid="select-container" data-value={value}>
45 |       <button onClick={() => onValueChange?.('high')} data-testid="select-button">
46 |         {value}
47 |       </button>
48 |       {children}
49 |     </div>
50 |   ),
51 |   SelectContent: ({ children }: any) => <div data-testid="select-content">{children}</div>,
52 |   SelectItem: ({ children, value }: any) => (
53 |     <div data-testid={`select-item-${value}`} data-value={value}>
54 |       {children}
55 |     </div>
56 |   ),
57 |   SelectTrigger: ({ children, className, id }: any) => (
58 |     <div className={className} id={id} data-testid="select-trigger">
59 |       {children}
60 |     </div>
61 |   ),
62 |   SelectValue: () => <span data-testid="select-value">Auto</span>,
63 | }));
64 | 
65 | // Mock Lucide icons
66 | jest.mock('lucide-react', () => ({
67 |   ImageIcon: ({ className }: any) => <div className={className} data-testid="image-icon" />,
68 |   Upload: ({ className }: any) => <div className={className} data-testid="upload-icon" />,
69 |   Loader2: ({ className }: any) => <div className={className} data-testid="loader-icon" />,
70 | }));
71 | 
72 | describe('ImageUpload Component', () => {
73 |   const mockOnImageSelect = jest.fn();
74 |   
75 |   // Test data
76 |   const mockFile = new File(['test content'], 'test.jpg', { type: 'image/jpeg' });
77 |   const mockImageAttachment: ImageAttachment = {
78 |     file: mockFile,
79 |     dataUrl: 'data:image/jpeg;base64,testdata',
80 |     metadata: {
81 |       filename: 'test.jpg',
82 |       size: 1024,
83 |       mimeType: 'image/jpeg',
84 |       width: 100,
85 |       height: 100,
86 |     },
87 |     detail: 'auto',
88 |   };
89 | 
90 |   beforeEach(() => {
91 |     jest.clearAllMocks();
92 |     
93 |     // Setup default mock behaviors
94 |     mockValidateImageFile.mockReturnValue({ valid: true });
95 |     mockProcessImageFile.mockResolvedValue({
96 |       dataUrl: 'data:image/jpeg;base64,testdata',
97 |       metadata: mockImageAttachment.metadata,
98 |     });
99 |     
100 |     // Mock console methods to reduce test noise
101 |     jest.spyOn(console, 'log').mockImplementation(() => {});
102 |     jest.spyOn(console, 'warn').mockImplementation(() => {});
103 |     jest.spyOn(console, 'error').mockImplementation(() => {});
104 |   });
105 | 
106 |   afterEach(() => {
107 |     jest.restoreAllMocks();
108 |   });
109 | 
110 |   // Tests for Basic Rendering and Props
111 |   describe('Basic Rendering and Props', () => {
112 |     test('renders with default props', () => {
113 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
114 |       
115 |       expect(screen.getByText('Image Detail:')).toBeInTheDocument();
116 |       expect(screen.getByTestId('select-value')).toBeInTheDocument();
117 |       expect(screen.getByText('Click or drag images to upload')).toBeInTheDocument();
118 |       expect(screen.getByText('Choose Images')).toBeInTheDocument();
119 |     });
120 | 
121 |     test('renders without detail selector when showDetailSelector is false', () => {
122 |       render(
123 |         <ImageUpload 
124 |           onImageSelect={mockOnImageSelect} 
125 |           showDetailSelector={false} 
126 |         />
127 |       );
128 |       
129 |       expect(screen.queryByText('Image Detail:')).not.toBeInTheDocument();
130 |       expect(screen.queryByTestId('select-container')).not.toBeInTheDocument();
131 |     });
132 | 
133 |     test('applies custom className', () => {
134 |       render(
135 |         <ImageUpload 
136 |           onImageSelect={mockOnImageSelect} 
137 |           className="custom-class" 
138 |         />
139 |       );
140 |       
141 |       const container = screen.getByText('Image Detail:').closest('.space-y-3');
142 |       expect(container).toHaveClass('custom-class');
143 |     });
144 | 
145 |     test('renders with custom file limits', () => {
146 |       render(
147 |         <ImageUpload 
148 |           onImageSelect={mockOnImageSelect} 
149 |           maxFiles={3}
150 |           maxSizePerFile={10 * 1024 * 1024} // 10MB
151 |         />
152 |       );
153 |       
154 |       expect(screen.getByText(/Max 3 files • 10MB per file/)).toBeInTheDocument();
155 |     });
156 | 
157 |     test('renders with custom accepted types', () => {
158 |       const customTypes = ['image/jpeg', 'image/png'];
159 |       render(
160 |         <ImageUpload 
161 |           onImageSelect={mockOnImageSelect} 
162 |           acceptedTypes={customTypes}
163 |         />
164 |       );
165 |       
166 |       const fileInput = screen.getByDisplayValue('');
167 |       expect(fileInput).toHaveAttribute('accept', 'image/jpeg,image/png');
168 |     });
169 | 
170 |     test('renders disabled state correctly', () => {
171 |       render(
172 |         <ImageUpload 
173 |           onImageSelect={mockOnImageSelect} 
174 |           disabled={true} 
175 |         />
176 |       );
177 |       
178 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('.image-upload-area');
179 |       expect(uploadArea).toHaveClass('opacity-50', 'cursor-not-allowed');
180 |       
181 |       const chooseButton = screen.getByRole('button', { name: /choose images/i });
182 |       expect(chooseButton).toBeDisabled();
183 |     });
184 |   });
185 | 
186 |   // Tests for Detail Level Selector
187 |   describe('Detail Level Selector', () => {
188 |     test('renders detail selector with default value', () => {
189 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
190 |       
191 |       expect(screen.getByTestId('select-container')).toHaveAttribute('data-value', 'auto');
192 |     });
193 | 
194 |     test('renders detail selector with custom default value', () => {
195 |       render(
196 |         <ImageUpload 
197 |           onImageSelect={mockOnImageSelect} 
198 |           defaultDetail="high" 
199 |         />
200 |       );
201 |       
202 |       expect(screen.getByTestId('select-container')).toHaveAttribute('data-value', 'high');
203 |     });
204 | 
205 |     test('updates detail level when selector changes', () => {
206 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
207 |       
208 |       const selectButton = screen.getByTestId('select-button');
209 |       fireEvent.click(selectButton);
210 |       
211 |       // The mock select component changes value to 'high' when clicked
212 |       expect(screen.getByTestId('select-container')).toHaveAttribute('data-value', 'high');
213 |     });
214 | 
215 |     test('renders help text for detail levels', () => {
216 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
217 |       
218 |       expect(screen.getByText('Image Detail Levels:')).toBeInTheDocument();
219 |       expect(screen.getByText((content, element) => {
220 |         return Boolean(element && element.textContent === '• Auto: AI chooses optimal quality (recommended)');
221 |       })).toBeInTheDocument();
222 |       expect(screen.getByText((content, element) => {
223 |         return Boolean(element && element.textContent === '• Low: Faster processing, good for simple images');
224 |       })).toBeInTheDocument();
225 |       expect(screen.getByText((content, element) => {
226 |         return Boolean(element && element.textContent === '• High: Detailed analysis, better for complex images');
227 |       })).toBeInTheDocument();
228 |     });
229 |   });
230 | 
231 |   // Tests for File Input and Upload Area
232 |   describe('File Input and Upload Area', () => {
233 |     test('renders upload area with proper styling', () => {
234 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
235 |       
236 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('.image-upload-area');
237 |       expect(uploadArea).toHaveClass('image-upload-area');
238 |     });
239 | 
240 |     test('renders file input with correct attributes', () => {
241 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
242 |       
243 |       const fileInput = screen.getByDisplayValue('');
244 |       
245 |       expect(fileInput).toHaveAttribute('type', 'file');
246 |       expect(fileInput).toHaveAttribute('multiple');
247 |       expect(fileInput).toHaveAttribute('accept', 'image/jpeg,image/png,image/webp');
248 |       expect(fileInput).toHaveClass('hidden');
249 |     });
250 | 
251 |     test('triggers file input when upload area is clicked', () => {
252 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
253 |       
254 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
255 |       const clickSpy = jest.spyOn(fileInput, 'click').mockImplementation(() => {});
256 |       
257 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
258 |       fireEvent.click(uploadArea!);
259 |       
260 |       expect(clickSpy).toHaveBeenCalled();
261 |     });
262 | 
263 |     test('triggers file input when choose button is clicked', () => {
264 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
265 |       
266 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
267 |       const clickSpy = jest.spyOn(fileInput, 'click').mockImplementation(() => {});
268 |       
269 |       const chooseButton = screen.getByRole('button', { name: /choose images/i });
270 |       fireEvent.click(chooseButton);
271 |       
272 |       expect(clickSpy).toHaveBeenCalled();
273 |     });
274 | 
275 |     test('does not trigger file input when disabled', () => {
276 |       render(<ImageUpload onImageSelect={mockOnImageSelect} disabled={true} />);
277 |       
278 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
279 |       
280 |       const clickSpy = jest.spyOn(fileInput, 'click').mockImplementation(() => {});
281 |       
282 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
283 |       fireEvent.click(uploadArea!);
284 |       
285 |       expect(clickSpy).not.toHaveBeenCalled();
286 |     });
287 |   });
288 | 
289 |   // Tests for Drag and Drop Functionality
290 |   describe('Drag and Drop Functionality', () => {
291 |     test('updates drag active state on dragenter', () => {
292 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
293 |       
294 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
295 |       
296 |       fireEvent.dragEnter(uploadArea!, {
297 |         dataTransfer: { files: [mockFile] }
298 |       });
299 |       
300 |       expect(screen.getByText('Drop images here')).toBeInTheDocument();
301 |     });
302 | 
303 |     test('updates drag active state on dragover', () => {
304 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
305 |       
306 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
307 |       
308 |       fireEvent.dragOver(uploadArea!, {
309 |         dataTransfer: { files: [mockFile] }
310 |       });
311 |       
312 |       expect(screen.getByText('Drop images here')).toBeInTheDocument();
313 |     });
314 | 
315 |     test('resets drag active state on dragleave', () => {
316 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
317 |       
318 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
319 |       
320 |       // First activate drag
321 |       fireEvent.dragEnter(uploadArea!);
322 |       expect(screen.getByText('Drop images here')).toBeInTheDocument();
323 |       
324 |       // Then leave
325 |       fireEvent.dragLeave(uploadArea!);
326 |       expect(screen.getByText('Click or drag images to upload')).toBeInTheDocument();
327 |     });
328 | 
329 |     test('processes files on drop', async () => {
330 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
331 |       
332 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
333 |       
334 |       fireEvent.drop(uploadArea!, {
335 |         dataTransfer: { files: [mockFile] }
336 |       });
337 |       
338 |       expect(mockValidateImageFile).toHaveBeenCalledWith(mockFile, {
339 |         maxSize: 2 * 1024 * 1024,
340 |         allowedTypes: ['image/jpeg', 'image/png', 'image/webp']
341 |       });
342 |       
343 |       await waitFor(() => {
344 |         expect(mockProcessImageFile).toHaveBeenCalledWith(mockFile);
345 |       });
346 |     });
347 | 
348 |     test('does not process files when disabled', () => {
349 |       render(<ImageUpload onImageSelect={mockOnImageSelect} disabled={true} />);
350 |       
351 |       const uploadArea = screen.getByText('Click or drag images to upload').closest('div');
352 |       
353 |       fireEvent.drop(uploadArea!, {
354 |         dataTransfer: { files: [mockFile] }
355 |       });
356 |       
357 |       expect(mockValidateImageFile).not.toHaveBeenCalled();
358 |       expect(mockProcessImageFile).not.toHaveBeenCalled();
359 |     });
360 |   });
361 | 
362 |   // Tests for File Processing
363 |   describe('File Processing', () => {
364 |     test('processes valid files successfully', async () => {
365 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
366 |       
367 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
368 |       
369 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
370 |       
371 |       await waitFor(() => {
372 |         expect(mockOnImageSelect).toHaveBeenCalledWith([
373 |           expect.objectContaining({
374 |             file: mockFile,
375 |             dataUrl: 'data:image/jpeg;base64,testdata',
376 |             metadata: mockImageAttachment.metadata,
377 |             detail: 'auto'
378 |           })
379 |         ]);
380 |       });
381 |     });
382 | 
383 |     test('shows loading state during processing', async () => {
384 |       // Make processImageFile take some time to resolve
385 |       mockProcessImageFile.mockImplementation(() => 
386 |         new Promise(resolve => setTimeout(() => resolve({
387 |           dataUrl: 'data:image/jpeg;base64,testdata',
388 |           metadata: mockImageAttachment.metadata,
389 |         }), 100))
390 |       );
391 |       
392 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
393 |       
394 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
395 |       
396 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
397 |       
398 |       // Should show loading state
399 |       expect(screen.getByTestId('loader-icon')).toBeInTheDocument();
400 |       expect(screen.getByText('Processing images...')).toBeInTheDocument();
401 |       expect(screen.getByText('Processing...')).toBeInTheDocument(); // Button text
402 |       
403 |       // Wait for processing to complete
404 |       await waitFor(() => {
405 |         expect(mockOnImageSelect).toHaveBeenCalled();
406 |       });
407 |     });
408 | 
409 |     test('handles file validation errors', async () => {
410 |       mockValidateImageFile.mockReturnValue({
411 |         valid: false,
412 |         error: 'File too large'
413 |       });
414 |       
415 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
416 |       
417 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
418 |       
419 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
420 |       
421 |       await waitFor(() => {
422 |         expect(screen.getByText('test.jpg: File too large')).toBeInTheDocument();
423 |       });
424 |       
425 |       expect(mockProcessImageFile).not.toHaveBeenCalled();
426 |       expect(mockOnImageSelect).not.toHaveBeenCalled();
427 |     });
428 | 
429 |     test('handles file processing errors', async () => {
430 |       mockProcessImageFile.mockRejectedValue(new Error('Processing failed'));
431 |       
432 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
433 |       
434 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
435 |       
436 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
437 |       
438 |       await waitFor(() => {
439 |         expect(screen.getByText('test.jpg: Failed to process image')).toBeInTheDocument();
440 |       });
441 |       
442 |       expect(mockOnImageSelect).not.toHaveBeenCalled();
443 |     });
444 | 
445 |     test('limits files to maxFiles', async () => {
446 |       const files = [
447 |         new File(['1'], 'test1.jpg', { type: 'image/jpeg' }),
448 |         new File(['2'], 'test2.jpg', { type: 'image/jpeg' }),
449 |         new File(['3'], 'test3.jpg', { type: 'image/jpeg' }),
450 |       ];
451 |       
452 |       render(<ImageUpload onImageSelect={mockOnImageSelect} maxFiles={2} />);
453 |       
454 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
455 |       
456 |       fireEvent.change(fileInput, { target: { files } });
457 |       
458 |       await waitFor(() => {
459 |         expect(screen.getByText(/Maximum 2 images allowed/)).toBeInTheDocument();
460 |       });
461 |       
462 |       // Should only process first 2 files
463 |       expect(mockProcessImageFile).toHaveBeenCalledTimes(2);
464 |     });
465 | 
466 |     test('resets file input value after processing', async () => {
467 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
468 |       
469 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
470 |       
471 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
472 |       
473 |       await waitFor(() => {
474 |         expect(mockOnImageSelect).toHaveBeenCalled();
475 |       });
476 |       
477 |       expect(fileInput.value).toBe('');
478 |     });
479 | 
480 |     test('uses selected detail level for processed images', async () => {
481 |       render(<ImageUpload onImageSelect={mockOnImageSelect} defaultDetail="high" />);
482 |       
483 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
484 |       
485 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
486 |       
487 |       await waitFor(() => {
488 |         expect(mockOnImageSelect).toHaveBeenCalledWith([
489 |           expect.objectContaining({
490 |             detail: 'high'
491 |           })
492 |         ]);
493 |       });
494 |     });
495 |   });
496 | 
497 |   // Tests for Error Handling
498 |   describe('Error Handling', () => {
499 |     test('displays multiple error messages', async () => {
500 |       const files = [
501 |         new File(['1'], 'test1.jpg', { type: 'image/jpeg' }),
502 |         new File(['2'], 'test2.jpg', { type: 'image/jpeg' }),
503 |       ];
504 |       
505 |       mockValidateImageFile
506 |         .mockReturnValueOnce({ valid: false, error: 'Error 1' })
507 |         .mockReturnValueOnce({ valid: false, error: 'Error 2' });
508 |       
509 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
510 |       
511 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
512 |       
513 |       fireEvent.change(fileInput, { target: { files } });
514 |       
515 |       await waitFor(() => {
516 |         expect(screen.getByText('test1.jpg: Error 1')).toBeInTheDocument();
517 |         expect(screen.getByText('test2.jpg: Error 2')).toBeInTheDocument();
518 |       });
519 |     });
520 | 
521 |     test('clears errors on new upload attempt', async () => {
522 |       // First upload with error
523 |       mockValidateImageFile.mockReturnValueOnce({ valid: false, error: 'Error' });
524 |       
525 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
526 |       
527 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
528 |       
529 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
530 |       
531 |       await waitFor(() => {
532 |         expect(screen.getByText('test.jpg: Error')).toBeInTheDocument();
533 |       });
534 |       
535 |       // Second upload without error
536 |       mockValidateImageFile.mockReturnValue({ valid: true });
537 |       
538 |       fireEvent.change(fileInput, { target: { files: [mockFile] } });
539 |       
540 |       await waitFor(() => {
541 |         expect(screen.queryByText('test.jpg: Error')).not.toBeInTheDocument();
542 |       });
543 |     });
544 | 
545 |     test('handles mixed success and error scenarios', async () => {
546 |       const files = [
547 |         new File(['1'], 'good.jpg', { type: 'image/jpeg' }),
548 |         new File(['2'], 'bad.jpg', { type: 'image/jpeg' }),
549 |       ];
550 |       
551 |       mockValidateImageFile
552 |         .mockReturnValueOnce({ valid: true })
553 |         .mockReturnValueOnce({ valid: false, error: 'Invalid file' });
554 |       
555 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
556 |       
557 |       const fileInput = screen.getByDisplayValue('') as HTMLInputElement;
558 |       
559 |       fireEvent.change(fileInput, { target: { files } });
560 |       
561 |       await waitFor(() => {
562 |         expect(screen.getByText('bad.jpg: Invalid file')).toBeInTheDocument();
563 |         expect(mockOnImageSelect).toHaveBeenCalledWith([
564 |           expect.objectContaining({
565 |             file: files[0]
566 |           })
567 |         ]);
568 |       });
569 |     });
570 |   });
571 | 
572 |   // Tests for Accessibility
573 |   describe('Accessibility', () => {
574 |     test('has proper label association for detail selector', () => {
575 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
576 |       
577 |       const label = screen.getByTestId('label-detail-selector');
578 |       expect(label).toHaveAttribute('for', 'detail-selector');
579 |       
580 |       const selectTrigger = screen.getByTestId('select-trigger');
581 |       expect(selectTrigger).toHaveAttribute('id', 'detail-selector');
582 |     });
583 | 
584 |     test('file input is properly hidden but accessible', () => {
585 |       render(<ImageUpload onImageSelect={mockOnImageSelect} />);
586 |       
[TRUNCATED]
```

__tests__/components/input.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { Input } from '../../components/input';
4 | import type { ImageAttachment } from '@/lib/types';
5 | import type { modelID } from '@/ai/providers';
6 | 
7 | // Mock external dependencies
8 | jest.mock('lucide-react', () => ({
9 |   ArrowUp: ({ className }: any) => <div className={className} data-testid="arrow-up-icon" />,
10 |   ImageIcon: ({ className }: any) => <div className={className} data-testid="image-icon" />,
11 | }));
12 | 
13 | jest.mock('../../components/ui/input', () => ({
14 |   Input: ({ className, value, onChange, placeholder, autoFocus, ...props }: any) => (
15 |     <input
16 |       className={className}
17 |       value={value}
18 |       onChange={onChange}
19 |       placeholder={placeholder}
20 |       {...(autoFocus ? { autoFocus: true } : {})}
21 |       data-testid="text-input"
22 |       {...props}
23 |     />
24 |   ),
25 | }));
26 | 
27 | jest.mock('../../components/ui/button', () => ({
28 |   Button: ({ children, onClick, variant, size, disabled, className, type, ...props }: any) => (
29 |     <button
30 |       onClick={onClick}
31 |       disabled={disabled}
32 |       className={className}
33 |       type={type}
34 |       data-testid={`button-${variant || 'default'}`}
35 |       data-size={size}
36 |       {...props}
37 |     >
38 |       {children}
39 |     </button>
40 |   ),
41 | }));
42 | 
43 | jest.mock('../../components/image-upload', () => ({
44 |   ImageUpload: ({ onImageSelect, maxFiles, disabled, showDetailSelector }: any) => (
45 |     <div 
46 |       data-testid="image-upload"
47 |       data-max-files={maxFiles}
48 |       data-disabled={disabled}
49 |       data-show-detail-selector={showDetailSelector}
50 |     >
51 |       <button 
52 |         onClick={() => onImageSelect([mockImageAttachment])}
53 |         disabled={disabled}
54 |         data-testid="upload-button"
55 |       >
56 |         Upload Image
57 |       </button>
58 |     </div>
59 |   ),
60 | }));
61 | 
62 | jest.mock('../../components/image-preview', () => ({
63 |   ImagePreview: ({ images, onRemove, maxWidth, maxHeight, className }: any) => (
64 |     <div 
65 |       className={className}
66 |       data-testid="image-preview"
67 |       data-max-width={maxWidth}
68 |       data-max-height={maxHeight}
69 |     >
70 |       {images.map((image: any, index: number) => (
71 |         <div key={index} data-testid={`preview-image-${index}`}>
72 |           <button 
73 |             onClick={() => onRemove(index)}
74 |             data-testid={`remove-image-${index}`}
75 |           >
76 |             Remove
77 |           </button>
78 |         </div>
79 |       ))}
80 |     </div>
81 |   ),
82 | }));
83 | 
84 | // Mock useModels hook
85 | const mockUseModels = jest.fn();
86 | jest.mock('@/hooks/use-models', () => ({
87 |   useModels: () => mockUseModels(),
88 | }));
89 | 
90 | // Mock data
91 | const mockImageAttachment: ImageAttachment = {
92 |   dataUrl: 'data:image/jpeg;base64,test-data',
93 |   metadata: {
94 |     filename: 'test.jpg',
95 |     size: 1024,
96 |     mimeType: 'image/jpeg',
97 |     width: 100,
98 |     height: 100,
99 |   },
100 |   detail: 'auto',
101 | };
102 | 
103 | const mockModelWithVision = {
104 |   id: 'gpt-4-vision',
105 |   name: 'GPT-4 Vision',
106 |   vision: true,
107 |   provider: 'OpenAI',
108 |   premium: false,
109 |   capabilities: ['vision'],
110 |   status: 'available',
111 |   lastChecked: new Date(),
112 | };
113 | 
114 | const mockModelWithoutVision = {
115 |   id: 'gpt-3.5-turbo',
116 |   name: 'GPT-3.5 Turbo',
117 |   vision: false,
118 |   provider: 'OpenAI',
119 |   premium: false,
120 |   capabilities: ['text'],
121 |   status: 'available',
122 |   lastChecked: new Date(),
123 | };
124 | 
125 | describe('Input Component', () => {
126 |   const mockHandleInputChange = jest.fn();
127 |   const mockStop = jest.fn();
128 |   const mockOnImagesChange = jest.fn();
129 | 
130 |   const defaultProps = {
131 |     input: '',
132 |     handleInputChange: mockHandleInputChange,
133 |     isLoading: false,
134 |     status: 'idle',
135 |     stop: mockStop,
136 |     selectedModel: 'gpt-4-vision' as modelID,
137 |     images: [],
138 |     onImagesChange: mockOnImagesChange,
139 |     maxImages: 5,
140 |     enableImageUpload: true,
141 |   };
142 | 
143 |   beforeEach(() => {
144 |     jest.clearAllMocks();
145 |     mockUseModels.mockReturnValue({
146 |       models: [mockModelWithVision, mockModelWithoutVision],
147 |       isLoading: false,
148 |       error: null,
149 |     });
150 |   });
151 | 
152 |   // Tests for Basic Rendering and Props
153 |   describe('Basic Rendering and Props', () => {
154 |     test('renders text input with correct placeholder when no images', () => {
155 |       render(<Input {...defaultProps} />);
156 |       
157 |       const textInput = screen.getByTestId('text-input');
158 |       expect(textInput).toBeInTheDocument();
159 |       expect(textInput).toHaveAttribute('placeholder', 'Say something...');
160 |       expect(textInput).toHaveValue('');
161 |     });
162 | 
163 |     test('renders text input with images placeholder when images present', () => {
164 |       render(<Input {...defaultProps} images={[mockImageAttachment]} />);
165 |       
166 |       const textInput = screen.getByTestId('text-input');
167 |       expect(textInput).toHaveAttribute('placeholder', 'Describe these images or ask questions...');
168 |     });
169 | 
170 |     test('renders with custom input value', () => {
171 |       render(<Input {...defaultProps} input="Hello world" />);
172 |       
173 |       const textInput = screen.getByTestId('text-input');
174 |       expect(textInput).toHaveValue('Hello world');
175 |     });
176 | 
177 |     test('text input is present and functional', () => {
178 |       render(<Input {...defaultProps} />);
179 |       
180 |       const textInput = screen.getByTestId('text-input');
181 |       expect(textInput).toBeInTheDocument();
182 |       expect(textInput).toHaveAttribute('placeholder', 'Say something...');
183 |     });
184 | 
185 |     test('renders submit button when not loading', () => {
186 |       render(<Input {...defaultProps} input="test" />);
187 |       
188 |       const buttons = screen.getAllByRole('button');
189 |       const submitButton = buttons.find(button => button.getAttribute('type') === 'submit');
190 |       expect(submitButton).toBeInTheDocument();
191 |       expect(submitButton).toHaveAttribute('type', 'submit');
192 |       expect(screen.getByTestId('arrow-up-icon')).toBeInTheDocument();
193 |     });
194 | 
195 |     test('renders stop button when loading', () => {
196 |       render(<Input {...defaultProps} status="streaming" />);
197 |       
198 |       const buttons = screen.getAllByRole('button');
199 |       const stopButton = buttons.find(button => button.getAttribute('type') === 'button' && button.querySelector('svg'));
200 |       expect(stopButton).toHaveAttribute('type', 'button');
201 |       // Stop button contains SVG spinner, not the ArrowUp icon
202 |       expect(screen.queryByTestId('arrow-up-icon')).not.toBeInTheDocument();
203 |     });
204 |   });
205 | 
206 |   // Tests for Vision Support Detection
207 |   describe('Vision Support Detection', () => {
208 |     test('shows image upload button when model supports vision', () => {
209 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
210 |       
211 |       const imageButton = screen.getByTestId('image-icon');
212 |       expect(imageButton).toBeInTheDocument();
213 |     });
214 | 
215 |     test('hides image upload button when model does not support vision', () => {
216 |       render(<Input {...defaultProps} selectedModel="gpt-3.5-turbo" />);
217 |       
218 |       const imageButton = screen.queryByTestId('image-icon');
219 |       expect(imageButton).not.toBeInTheDocument();
220 |     });
221 | 
222 |     test('hides image upload button when enableImageUpload is false', () => {
223 |       render(<Input {...defaultProps} enableImageUpload={false} />);
224 |       
225 |       const imageButton = screen.queryByTestId('image-icon');
226 |       expect(imageButton).not.toBeInTheDocument();
227 |     });
228 | 
229 |     test('handles missing model gracefully', () => {
230 |       mockUseModels.mockReturnValue({
231 |         models: [],
232 |         isLoading: false,
233 |         error: null,
234 |       });
235 | 
236 |       render(<Input {...defaultProps} selectedModel="unknown-model" />);
237 |       
238 |       const imageButton = screen.queryByTestId('image-icon');
239 |       expect(imageButton).not.toBeInTheDocument();
240 |     });
241 |   });
242 | 
243 |   // Tests for Image Upload Functionality
244 |   describe('Image Upload Functionality', () => {
245 |     test('shows image upload interface when image button is clicked', () => {
246 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
247 |       
248 |       const imageButton = screen.getByTestId('image-icon').closest('button');
249 |       fireEvent.click(imageButton!);
250 |       
251 |       expect(screen.getByTestId('image-upload')).toBeInTheDocument();
252 |     });
253 | 
254 |     test('hides image upload interface when clicking image button again', () => {
255 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
256 |       
257 |       const imageButton = screen.getByTestId('image-icon').closest('button');
258 |       fireEvent.click(imageButton!);
259 |       fireEvent.click(imageButton!);
260 |       
261 |       expect(screen.queryByTestId('image-upload')).not.toBeInTheDocument();
262 |     });
263 | 
264 |     test('passes correct maxFiles to ImageUpload component', () => {
265 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" maxImages={3} images={[mockImageAttachment]} />);
266 |       
267 |       const imageButton = screen.getByTestId('image-icon').closest('button');
268 |       fireEvent.click(imageButton!);
269 |       
270 |       const imageUpload = screen.getByTestId('image-upload');
271 |       expect(imageUpload).toHaveAttribute('data-max-files', '2'); // maxImages - current images
272 |     });
273 | 
274 |     test('disables image upload button when max images reached', () => {
275 |       const maxImages = 2;
276 |       const images = [mockImageAttachment, mockImageAttachment];
277 |       
278 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" maxImages={maxImages} images={images} />);
279 |       
280 |       const imageButton = screen.getByTestId('image-icon').closest('button');
281 |       expect(imageButton).toBeDisabled();
282 |     });
283 | 
284 |     test('handles image selection from upload component', () => {
285 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
286 |       
287 |       const imageButton = screen.getByTestId('image-icon').closest('button');
288 |       fireEvent.click(imageButton!);
289 |       
290 |       const uploadButton = screen.getByTestId('upload-button');
291 |       fireEvent.click(uploadButton);
292 |       
293 |       expect(mockOnImagesChange).toHaveBeenCalledWith([mockImageAttachment]);
294 |     });
295 | 
296 |     test('appends new images to existing images array', () => {
297 |       const existingImages = [mockImageAttachment];
298 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" images={existingImages} />);
299 |       
300 |       const imageButton = screen.getByTestId('image-icon').closest('button');
301 |       fireEvent.click(imageButton!);
302 |       
303 |       const uploadButton = screen.getByTestId('upload-button');
304 |       fireEvent.click(uploadButton);
305 |       
306 |       expect(mockOnImagesChange).toHaveBeenCalledWith([mockImageAttachment, mockImageAttachment]);
307 |     });
308 | 
309 |     test('hides upload interface after image selection', () => {
310 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
311 |       
312 |       const imageButton = screen.getByTestId('image-icon').closest('button');
313 |       fireEvent.click(imageButton!);
314 |       
315 |       const uploadButton = screen.getByTestId('upload-button');
316 |       fireEvent.click(uploadButton);
317 |       
318 |       expect(screen.queryByTestId('image-upload')).not.toBeInTheDocument();
319 |     });
320 |   });
321 | 
322 |   // Tests for Image Preview Functionality
323 |   describe('Image Preview Functionality', () => {
324 |     test('shows image preview when images are present', () => {
325 |       render(<Input {...defaultProps} images={[mockImageAttachment]} />);
326 |       
327 |       expect(screen.getByTestId('image-preview')).toBeInTheDocument();
328 |       expect(screen.getByTestId('preview-image-0')).toBeInTheDocument();
329 |     });
330 | 
331 |     test('displays correct image count', () => {
332 |       const images = [mockImageAttachment, mockImageAttachment];
333 |       render(<Input {...defaultProps} images={images} maxImages={5} />);
334 |       
335 |       expect(screen.getByText('2/5 images • Click images to remove')).toBeInTheDocument();
336 |     });
337 | 
338 |     test('passes correct props to ImagePreview component', () => {
339 |       render(<Input {...defaultProps} images={[mockImageAttachment]} />);
340 |       
341 |       const imagePreview = screen.getByTestId('image-preview');
342 |       expect(imagePreview).toHaveAttribute('data-max-width', '120');
343 |       expect(imagePreview).toHaveAttribute('data-max-height', '120');
344 |     });
345 | 
346 |     test('handles image removal', () => {
347 |       const images = [mockImageAttachment, mockImageAttachment];
348 |       render(<Input {...defaultProps} images={images} />);
349 |       
350 |       const removeButton = screen.getByTestId('remove-image-1');
351 |       fireEvent.click(removeButton);
352 |       
353 |       expect(mockOnImagesChange).toHaveBeenCalledWith([mockImageAttachment]);
354 |     });
355 | 
356 |     test('hides image preview when no images', () => {
357 |       render(<Input {...defaultProps} images={[]} />);
358 |       
359 |       expect(screen.queryByTestId('image-preview')).not.toBeInTheDocument();
360 |     });
361 |   });
362 | 
363 |   // Tests for User Interactions
364 |   describe('User Interactions', () => {
365 |     test('calls handleInputChange when text input changes', () => {
366 |       render(<Input {...defaultProps} />);
367 |       
368 |       const textInput = screen.getByTestId('text-input');
369 |       fireEvent.change(textInput, { target: { value: 'Hello' } });
370 |       
371 |       expect(mockHandleInputChange).toHaveBeenCalled();
372 |       expect(mockHandleInputChange).toHaveBeenCalledTimes(1);
373 |     });
374 | 
375 |     test('calls stop function when stop button is clicked', () => {
376 |       render(<Input {...defaultProps} status="streaming" />);
377 |       
378 |       const buttons = screen.getAllByRole('button');
379 |       const stopButton = buttons.find(button => button.getAttribute('type') === 'button' && button.querySelector('svg'));
380 |       fireEvent.click(stopButton!);
381 |       
382 |       expect(mockStop).toHaveBeenCalled();
383 |     });
384 | 
385 |     test('submit button is enabled when input has text', () => {
386 |       render(<Input {...defaultProps} input="test" />);
387 |       
388 |       const buttons = screen.getAllByRole('button');
389 |       const submitButton = buttons.find(button => button.getAttribute('type') === 'submit');
390 |       expect(submitButton).not.toBeDisabled();
391 |     });
392 | 
393 |     test('submit button is enabled when images are present', () => {
394 |       render(<Input {...defaultProps} input="" images={[mockImageAttachment]} />);
395 |       
396 |       const buttons = screen.getAllByRole('button');
397 |       const submitButton = buttons.find(button => button.getAttribute('type') === 'submit');
398 |       expect(submitButton).not.toBeDisabled();
399 |     });
400 | 
401 |     test('submit button is disabled when no input and no images', () => {
402 |       render(<Input {...defaultProps} input="" images={[]} />);
403 |       
404 |       const buttons = screen.getAllByRole('button');
405 |       const submitButton = buttons.find(button => button.getAttribute('type') === 'submit');
406 |       expect(submitButton).toBeDisabled();
407 |     });
408 | 
409 |     test('submit button is disabled when loading', () => {
410 |       render(<Input {...defaultProps} input="test" isLoading={true} />);
411 |       
412 |       const buttons = screen.getAllByRole('button');
413 |       const submitButton = buttons.find(button => button.getAttribute('type') === 'submit');
414 |       expect(submitButton).toBeDisabled();
415 |     });
416 |   });
417 | 
418 |   // Tests for Loading States
419 |   describe('Loading States', () => {
420 |     test('shows stop button with spinner when status is streaming', () => {
421 |       render(<Input {...defaultProps} status="streaming" />);
422 |       
423 |       const buttons = screen.getAllByRole('button');
424 |       const stopButton = buttons.find(button => button.getAttribute('type') === 'button' && button.querySelector('svg'));
425 |       
426 |       expect(stopButton).toBeInTheDocument();
427 |       expect(stopButton).toHaveAttribute('type', 'button');
428 |       
429 |       // Should contain spinner SVG
430 |       const svg = stopButton!.querySelector('svg');
431 |       expect(svg).toBeInTheDocument();
432 |     });
433 | 
434 |     test('shows stop button with spinner when status is submitted', () => {
435 |       render(<Input {...defaultProps} status="submitted" />);
436 |       
437 |       const buttons = screen.getAllByRole('button');
438 |       const stopButton = buttons.find(button => button.getAttribute('type') === 'button' && button.querySelector('svg'));
439 |       
440 |       expect(stopButton).toBeInTheDocument();
441 |       expect(stopButton).toHaveAttribute('type', 'button');
442 |     });
443 | 
444 |     test('disables image upload when loading', () => {
445 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" isLoading={true} />);
446 |       
447 |       const imageButton = screen.getByTestId('image-icon').closest('button');
448 |       expect(imageButton).toBeDisabled();
449 |     });
450 |   });
451 | 
452 |   // Tests for Accessibility
453 |   describe('Accessibility', () => {
454 |     test('submit button has proper type attribute', () => {
455 |       render(<Input {...defaultProps} input="test" />);
456 |       
457 |       const buttons = screen.getAllByRole('button');
458 |       const submitButton = buttons.find(button => button.getAttribute('type') === 'submit');
459 |       expect(submitButton).toHaveAttribute('type', 'submit');
460 |     });
461 | 
462 |     test('stop button has proper type attribute', () => {
463 |       render(<Input {...defaultProps} status="streaming" />);
464 |       
465 |       const buttons = screen.getAllByRole('button');
466 |       const stopButton = buttons.find(button => button.getAttribute('type') === 'button' && button.querySelector('svg'));
467 |       expect(stopButton).toHaveAttribute('type', 'button');
468 |     });
469 | 
470 |     test('image upload button has proper type attribute', () => {
471 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
472 |       
473 |       const imageButton = screen.getByTestId('image-icon').closest('button');
474 |       expect(imageButton).toHaveAttribute('type', 'button');
475 |     });
476 | 
477 |     test('text input is properly configured', () => {
478 |       render(<Input {...defaultProps} />);
479 |       
480 |       const textInput = screen.getByTestId('text-input');
481 |       expect(textInput).toBeInTheDocument();
482 |       expect(textInput.tagName.toLowerCase()).toBe('input');
483 |     });
484 |   });
485 | 
486 |   // Tests for Edge Cases and Error Handling
487 |   describe('Edge Cases and Error Handling', () => {
488 |     test('handles undefined onImagesChange gracefully', () => {
489 |       render(<Input {...defaultProps} onImagesChange={undefined} selectedModel="gpt-4-vision" />);
490 |       
491 |       const imageButton = screen.getByTestId('image-icon').closest('button');
492 |       fireEvent.click(imageButton!);
493 |       
494 |       const uploadButton = screen.getByTestId('upload-button');
495 |       expect(() => fireEvent.click(uploadButton)).not.toThrow();
496 |     });
497 | 
498 |     test('handles image removal with undefined onImagesChange', () => {
499 |       render(<Input {...defaultProps} onImagesChange={undefined} images={[mockImageAttachment]} />);
500 |       
501 |       const removeButton = screen.getByTestId('remove-image-0');
502 |       expect(() => fireEvent.click(removeButton)).not.toThrow();
503 |     });
504 | 
505 |     test('handles useModels hook returning empty models array', () => {
506 |       mockUseModels.mockReturnValue({
507 |         models: [],
508 |         isLoading: false,
509 |         error: null,
510 |       });
511 | 
512 |       render(<Input {...defaultProps} selectedModel="unknown-model" />);
513 |       
514 |       expect(screen.queryByTestId('image-icon')).not.toBeInTheDocument();
515 |     });
516 | 
517 |     test('handles useModels hook error state', () => {
518 |       mockUseModels.mockReturnValue({
519 |         models: [],
520 |         isLoading: false,
521 |         error: new Error('Failed to load models'),
522 |       });
523 | 
524 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
525 |       
526 |       expect(screen.queryByTestId('image-icon')).not.toBeInTheDocument();
527 |     });
528 | 
529 |     test('handles loading state from useModels', () => {
530 |       mockUseModels.mockReturnValue({
531 |         models: [],
532 |         isLoading: true,
533 |         error: null,
534 |       });
535 | 
536 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
537 |       
538 |       // Component should render without crashing during loading
539 |       expect(screen.getByTestId('text-input')).toBeInTheDocument();
540 |     });
541 |   });
542 | 
543 |   // Integration Tests
544 |   describe('Integration Tests', () => {
545 |     test('complete image workflow: upload, preview, and remove', async () => {
546 |       render(<Input {...defaultProps} selectedModel="gpt-4-vision" />);
547 |       
548 |       // Open image upload
549 |       const imageButton = screen.getByTestId('image-icon').closest('button');
550 |       fireEvent.click(imageButton!);
551 |       
552 |       // Upload image
553 |       const uploadButton = screen.getByTestId('upload-button');
554 |       fireEvent.click(uploadButton);
555 |       
556 |       expect(mockOnImagesChange).toHaveBeenCalledWith([mockImageAttachment]);
557 |       
[TRUNCATED]
```

__tests__/components/ios-install-prompt.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor, cleanup, act } from '@testing-library/react';
3 | import { IOSInstallPrompt } from '../../components/ios-install-prompt';
4 | 
5 | // Mock localStorage
6 | const localStorageMock = {
7 |   getItem: jest.fn(),
8 |   setItem: jest.fn(),
9 |   removeItem: jest.fn(),
10 |   clear: jest.fn(),
11 | };
12 | Object.defineProperty(window, 'localStorage', {
13 |   value: localStorageMock
14 | });
15 | 
16 | // Mock UI components with proper prop forwarding
17 | jest.mock('../../components/ui/button', () => ({
18 |   Button: ({ children, onClick, variant, size, className, ...props }: any) => (
19 |     <button 
20 |       onClick={onClick} 
21 |       className={className} 
22 |       data-variant={variant}
23 |       data-size={size}
24 |       data-testid={`button-${variant || 'default'}`}
25 |       {...props}
26 |     >
27 |       {children}
28 |     </button>
29 |   ),
30 | }));
31 | 
32 | jest.mock('../../components/ui/card', () => ({
33 |   Card: ({ children, className }: any) => (
34 |     <div className={className} data-testid="card">
35 |       {children}
36 |     </div>
37 |   ),
38 |   CardContent: ({ children, className }: any) => (
39 |     <div className={className} data-testid="card-content">
40 |       {children}
41 |     </div>
42 |   ),
43 | }));
44 | 
45 | // Mock Lucide React icons
46 | jest.mock('lucide-react', () => ({
47 |   X: () => <span data-testid="x-icon">X</span>,
48 |   Share: () => <span data-testid="share-icon">Share</span>,
49 |   Plus: () => <span data-testid="plus-icon">Plus</span>,
50 | }));
51 | 
52 | describe('IOSInstallPrompt', () => {
53 |   const mockOnDismiss = jest.fn();
54 |   
55 |   // Test data
56 |   const TEST_DATA = {
57 |     userAgents: {
58 |       iosSafari: 'Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1',
59 |       iosSafariIPad: 'Mozilla/5.0 (iPad; CPU OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Mobile/15E148 Safari/604.1',
60 |       androidChrome: 'Mozilla/5.0 (Linux; Android 11; SM-G991B) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.120 Mobile Safari/537.36',
61 |       desktopChrome: 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.120 Safari/537.36',
62 |     },
63 |     localStorage: {
64 |       dismissed: 'true',
65 |       permanent: 'permanent',
66 |       null: null,
67 |     }
68 |   };
69 | 
70 |   beforeEach(() => {
71 |     jest.clearAllMocks();
72 |     jest.useFakeTimers();
73 |     
74 |     // Reset mocks to default behavior
75 |     localStorageMock.getItem.mockReturnValue(null);
76 |     localStorageMock.setItem.mockImplementation(() => {});
77 |     localStorageMock.removeItem.mockImplementation(() => {});
78 | 
79 |     // Mock window.matchMedia for standalone mode detection
80 |     Object.defineProperty(window, 'matchMedia', {
81 |       writable: true,
82 |       value: jest.fn().mockImplementation(query => ({
83 |         matches: false,
84 |         media: query,
85 |         onchange: null,
86 |         addListener: jest.fn(), // deprecated
87 |         removeListener: jest.fn(), // deprecated
88 |         addEventListener: jest.fn(),
89 |         removeEventListener: jest.fn(),
90 |         dispatchEvent: jest.fn(),
91 |       })),
92 |     });
93 | 
94 |     // Reset navigator.standalone
95 |     Object.defineProperty(window.navigator, 'standalone', {
96 |       writable: true,
97 |       value: false,
98 |     });
99 | 
100 |     mockOnDismiss.mockClear();
101 |   });
102 | 
103 |   afterEach(() => {
104 |     cleanup();
105 |     jest.runOnlyPendingTimers();
106 |     jest.useRealTimers();
107 |   });
108 | 
109 |   describe('Basic Rendering and Props', () => {
110 |     test('renders when all conditions are met (iOS, not standalone, not dismissed)', async () => {
111 |       // Mock iOS user agent
112 |       Object.defineProperty(navigator, 'userAgent', {
113 |         writable: true,
114 |         value: TEST_DATA.userAgents.iosSafari
115 |       });
116 | 
117 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
118 | 
119 |       // Fast-forward past the 3-second delay
120 |       act(() => {
121 |         act(() => {
122 |         jest.advanceTimersByTime(3000);
123 |       });
124 |       });
125 | 
126 |       await waitFor(() => {
127 |         expect(screen.getByTestId('card')).toBeInTheDocument();
128 |         expect(screen.getByRole('heading', { name: 'Add to Home Screen' })).toBeInTheDocument();
129 |         expect(screen.getByText('Quick access to ChatLima')).toBeInTheDocument();
130 |       });
131 |     });
132 | 
133 |     test('does not render on non-iOS devices', async () => {
134 |       // Mock Android user agent
135 |       Object.defineProperty(navigator, 'userAgent', {
136 |         writable: true,
137 |         value: TEST_DATA.userAgents.androidChrome
138 |       });
139 | 
140 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
141 |       
142 |       act(() => {
143 |         act(() => {
144 |         jest.advanceTimersByTime(3000);
145 |       });
146 |       });
147 | 
148 |       await waitFor(() => {
149 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
150 |       });
151 |     });
152 | 
153 |     test('does not render when in standalone mode', async () => {
154 |       // Mock iOS user agent
155 |       Object.defineProperty(navigator, 'userAgent', {
156 |         writable: true,
157 |         value: TEST_DATA.userAgents.iosSafari
158 |       });
159 | 
160 |       // Mock standalone mode
161 |       window.matchMedia = jest.fn().mockImplementation(query => ({
162 |         matches: query === '(display-mode: standalone)',
163 |         media: query,
164 |         onchange: null,
165 |         addListener: jest.fn(),
166 |         removeListener: jest.fn(),
167 |         addEventListener: jest.fn(),
168 |         removeEventListener: jest.fn(),
169 |         dispatchEvent: jest.fn(),
170 |       }));
171 | 
172 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
173 |       
174 |       act(() => {
175 |         act(() => {
176 |         jest.advanceTimersByTime(3000);
177 |       });
178 |       });
179 | 
180 |       await waitFor(() => {
181 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
182 |       });
183 |     });
184 | 
185 |     test('does not render when previously dismissed', async () => {
186 |       // Mock iOS user agent
187 |       Object.defineProperty(navigator, 'userAgent', {
188 |         writable: true,
189 |         value: TEST_DATA.userAgents.iosSafari
190 |       });
191 | 
192 |       // Mock dismissed state in localStorage
193 |       localStorageMock.getItem.mockReturnValue(TEST_DATA.localStorage.dismissed);
194 | 
195 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
196 |       
197 |       act(() => {
198 |         act(() => {
199 |         jest.advanceTimersByTime(3000);
200 |       });
201 |       });
202 | 
203 |       await waitFor(() => {
204 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
205 |       });
206 |     });
207 | 
208 |     test('renders without onDismiss prop', async () => {
209 |       // Mock iOS user agent
210 |       Object.defineProperty(navigator, 'userAgent', {
211 |         writable: true,
212 |         value: TEST_DATA.userAgents.iosSafari
213 |       });
214 | 
215 |       render(<IOSInstallPrompt />);
216 | 
217 |       act(() => {
218 |         act(() => {
219 |         jest.advanceTimersByTime(3000);
220 |       });
221 |       });
222 | 
223 |       await waitFor(() => {
224 |         expect(screen.getByTestId('card')).toBeInTheDocument();
225 |       });
226 |     });
227 |   });
228 | 
229 |   describe('Device Detection', () => {
230 |     test('detects iPhone devices correctly', async () => {
231 |       Object.defineProperty(navigator, 'userAgent', {
232 |         writable: true,
233 |         value: TEST_DATA.userAgents.iosSafari
234 |       });
235 | 
236 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
237 |       act(() => {
238 |         jest.advanceTimersByTime(3000);
239 |       });
240 | 
241 |       await waitFor(() => {
242 |         expect(screen.getByTestId('card')).toBeInTheDocument();
243 |       });
244 |     });
245 | 
246 |     test('detects iPad devices correctly', async () => {
247 |       Object.defineProperty(navigator, 'userAgent', {
248 |         writable: true,
249 |         value: TEST_DATA.userAgents.iosSafariIPad
250 |       });
251 | 
252 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
253 |       act(() => {
254 |         jest.advanceTimersByTime(3000);
255 |       });
256 | 
257 |       await waitFor(() => {
258 |         expect(screen.getByTestId('card')).toBeInTheDocument();
259 |       });
260 |     });
261 | 
262 |     test('detects standalone mode via navigator.standalone', async () => {
263 |       Object.defineProperty(navigator, 'userAgent', {
264 |         writable: true,
265 |         value: TEST_DATA.userAgents.iosSafari
266 |       });
267 | 
268 |       // Mock navigator.standalone
269 |       Object.defineProperty(window.navigator, 'standalone', {
270 |         writable: true,
271 |         value: true,
272 |       });
273 | 
274 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
275 |       act(() => {
276 |         jest.advanceTimersByTime(3000);
277 |       });
278 | 
279 |       await waitFor(() => {
280 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
281 |       });
282 |     });
283 | 
284 |     test('does not render on desktop browsers', async () => {
285 |       Object.defineProperty(navigator, 'userAgent', {
286 |         writable: true,
287 |         value: TEST_DATA.userAgents.desktopChrome
288 |       });
289 | 
290 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
291 |       act(() => {
292 |         jest.advanceTimersByTime(3000);
293 |       });
294 | 
295 |       await waitFor(() => {
296 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
297 |       });
298 |     });
299 |   });
300 | 
301 |   describe('LocalStorage Interaction', () => {
302 |     test('checks localStorage for previous dismissal on mount', () => {
303 |       Object.defineProperty(navigator, 'userAgent', {
304 |         writable: true,
305 |         value: TEST_DATA.userAgents.iosSafari
306 |       });
307 | 
308 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
309 | 
310 |       expect(localStorageMock.getItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed');
311 |     });
312 | 
313 |     test('does not render when localStorage shows permanent dismissal', async () => {
314 |       Object.defineProperty(navigator, 'userAgent', {
315 |         writable: true,
316 |         value: TEST_DATA.userAgents.iosSafari
317 |       });
318 | 
319 |       localStorageMock.getItem.mockReturnValue(TEST_DATA.localStorage.permanent);
320 | 
321 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
322 |       act(() => {
323 |         jest.advanceTimersByTime(3000);
324 |       });
325 | 
326 |       await waitFor(() => {
327 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
328 |       });
329 |     });
330 | 
331 |     test('saves temporary dismissal to localStorage when "Got it" is clicked', async () => {
332 |       Object.defineProperty(navigator, 'userAgent', {
333 |         writable: true,
334 |         value: TEST_DATA.userAgents.iosSafari
335 |       });
336 | 
337 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
338 |       act(() => {
339 |         jest.advanceTimersByTime(3000);
340 |       });
341 | 
342 |       await waitFor(() => {
343 |         expect(screen.getByTestId('card')).toBeInTheDocument();
344 |       });
345 | 
346 |       const gotItButton = screen.getByRole('button', { name: /got it/i });
347 |       fireEvent.click(gotItButton);
348 | 
349 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'true');
350 |     });
351 | 
352 |     test('saves permanent dismissal to localStorage when "Don\'t show again" is clicked', async () => {
353 |       Object.defineProperty(navigator, 'userAgent', {
354 |         writable: true,
355 |         value: TEST_DATA.userAgents.iosSafari
356 |       });
357 | 
358 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
359 |       act(() => {
360 |         jest.advanceTimersByTime(3000);
361 |       });
362 | 
363 |       await waitFor(() => {
364 |         expect(screen.getByTestId('card')).toBeInTheDocument();
365 |       });
366 | 
367 |       const neverShowButton = screen.getByRole('button', { name: /don't show again/i });
368 |       fireEvent.click(neverShowButton);
369 | 
370 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'permanent');
371 |     });
372 |   });
373 | 
374 |   describe('Timer-based Visibility', () => {
375 |     test('shows prompt after 3-second delay', async () => {
376 |       Object.defineProperty(navigator, 'userAgent', {
377 |         writable: true,
378 |         value: TEST_DATA.userAgents.iosSafari
379 |       });
380 | 
381 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
382 | 
383 |       // Should not be visible immediately
384 |       expect(screen.queryByTestId('card')).not.toBeInTheDocument();
385 | 
386 |       // Fast-forward 2 seconds - should still not be visible
387 |       act(() => {
388 |         jest.advanceTimersByTime(2000);
389 |       });
390 |       expect(screen.queryByTestId('card')).not.toBeInTheDocument();
391 | 
392 |       // Fast-forward to 3 seconds - should now be visible
393 |       act(() => {
394 |         jest.advanceTimersByTime(1000);
395 |       });
396 | 
397 |       await waitFor(() => {
398 |         expect(screen.getByTestId('card')).toBeInTheDocument();
399 |       });
400 |     });
401 | 
402 |     test('cleans up timer on unmount', () => {
403 |       Object.defineProperty(navigator, 'userAgent', {
404 |         writable: true,
405 |         value: TEST_DATA.userAgents.iosSafari
406 |       });
407 | 
408 |       const { unmount } = render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
409 | 
410 |       // Unmount before timer completes
411 |       unmount();
412 | 
413 |       // Fast-forward past the timer
414 |       act(() => {
415 |         jest.advanceTimersByTime(3000);
416 |       });
417 | 
418 |       // Should not cause any issues or memory leaks
419 |       expect(screen.queryByTestId('card')).not.toBeInTheDocument();
420 |     });
421 |   });
422 | 
423 |   describe('User Interactions', () => {
424 |     beforeEach(async () => {
425 |       Object.defineProperty(navigator, 'userAgent', {
426 |         writable: true,
427 |         value: TEST_DATA.userAgents.iosSafari
428 |       });
429 | 
430 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
431 |       act(() => {
432 |         jest.advanceTimersByTime(3000);
433 |       });
434 | 
435 |       await waitFor(() => {
436 |         expect(screen.getByTestId('card')).toBeInTheDocument();
437 |       });
438 |     });
439 | 
440 |     test('handles dismiss button click correctly', () => {
441 |       const dismissButton = screen.getByTestId('button-ghost');
442 |       fireEvent.click(dismissButton);
443 | 
444 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'true');
445 |       expect(mockOnDismiss).toHaveBeenCalledTimes(1);
446 |     });
447 | 
448 |     test('handles "Got it" button click correctly', () => {
449 |       const gotItButton = screen.getByRole('button', { name: /got it/i });
450 |       fireEvent.click(gotItButton);
451 | 
452 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'true');
453 |       expect(mockOnDismiss).toHaveBeenCalledTimes(1);
454 |     });
455 | 
456 |     test('handles "Don\'t show again" button click correctly', () => {
457 |       const neverShowButton = screen.getByRole('button', { name: /don't show again/i });
458 |       fireEvent.click(neverShowButton);
459 | 
460 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'permanent');
461 |       expect(mockOnDismiss).toHaveBeenCalledTimes(1);
462 |     });
463 | 
464 |     test('hides prompt when dismiss buttons are clicked', async () => {
465 |       const gotItButton = screen.getByRole('button', { name: /got it/i });
466 |       fireEvent.click(gotItButton);
467 | 
468 |       await waitFor(() => {
469 |         expect(screen.queryByTestId('card')).not.toBeInTheDocument();
470 |       });
471 |     });
472 | 
473 |     test('does not call onDismiss when not provided', async () => {
474 |       // Re-render without onDismiss prop
475 |       cleanup();
476 |       render(<IOSInstallPrompt />);
477 |       act(() => {
478 |         jest.advanceTimersByTime(3000);
479 |       });
480 | 
481 |       await waitFor(() => {
482 |         expect(screen.getByTestId('card')).toBeInTheDocument();
483 |       });
484 | 
485 |       const gotItButton = screen.getByRole('button', { name: /got it/i });
486 |       fireEvent.click(gotItButton);
487 | 
488 |       // Should not throw error
489 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'true');
490 |     });
491 |   });
492 | 
493 |   describe('Error Handling', () => {
494 |     test('throws error when localStorage.getItem fails during initialization', async () => {
495 |       Object.defineProperty(navigator, 'userAgent', {
496 |         writable: true,
497 |         value: TEST_DATA.userAgents.iosSafari
498 |       });
499 | 
500 |       localStorageMock.getItem.mockImplementation(() => {
501 |         throw new Error('localStorage error');
502 |       });
503 | 
504 |       // Component should throw error during initialization
505 |       expect(() => {
506 |         render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
507 |       }).toThrow('localStorage error');
508 |     });
509 | 
510 |     test('attempts to save to localStorage when dismiss buttons are clicked', async () => {
511 |       Object.defineProperty(navigator, 'userAgent', {
512 |         writable: true,
513 |         value: TEST_DATA.userAgents.iosSafari
514 |       });
515 | 
516 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
517 |       act(() => {
518 |         jest.advanceTimersByTime(3000);
519 |       });
520 | 
521 |       await waitFor(() => {
522 |         expect(screen.getByTestId('card')).toBeInTheDocument();
523 |       });
524 | 
525 |       const gotItButton = screen.getByRole('button', { name: /got it/i });
526 |       const neverShowButton = screen.getByRole('button', { name: /don't show again/i });
527 |       
528 |       // Test "Got it" button
529 |       fireEvent.click(gotItButton);
530 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'true');
531 |       
532 |       // Reset mock for next test
533 |       localStorageMock.setItem.mockClear();
534 |       
535 |       // Re-render to test "Never show again" button
536 |       cleanup();
537 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
538 |       act(() => {
539 |         jest.advanceTimersByTime(3000);
540 |       });
541 | 
542 |       await waitFor(() => {
543 |         expect(screen.getByTestId('card')).toBeInTheDocument();
544 |       });
545 | 
546 |       const neverShowButtonSecond = screen.getByRole('button', { name: /don't show again/i });
547 |       fireEvent.click(neverShowButtonSecond);
548 |       expect(localStorageMock.setItem).toHaveBeenCalledWith('chatlima-ios-install-dismissed', 'permanent');
549 |     });
550 |   });
551 | 
552 |   describe('Accessibility', () => {
553 |     beforeEach(async () => {
554 |       Object.defineProperty(navigator, 'userAgent', {
555 |         writable: true,
556 |         value: TEST_DATA.userAgents.iosSafari
557 |       });
558 | 
559 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
560 |       act(() => {
561 |         jest.advanceTimersByTime(3000);
562 |       });
563 | 
564 |       await waitFor(() => {
565 |         expect(screen.getByTestId('card')).toBeInTheDocument();
566 |       });
567 |     });
568 | 
569 |     test('has proper heading structure', () => {
570 |       expect(screen.getByRole('heading', { name: 'Add to Home Screen' })).toBeInTheDocument();
571 |       expect(screen.getByText('Quick access to ChatLima')).toBeInTheDocument();
572 |     });
573 | 
574 |     test('has accessible buttons with proper labels', () => {
575 |       expect(screen.getByRole('button', { name: /got it/i })).toBeInTheDocument();
576 |       expect(screen.getByRole('button', { name: /don't show again/i })).toBeInTheDocument();
577 |       
578 |       // Dismiss button should be accessible (X icon)
579 |       const dismissButton = screen.getByTestId('button-ghost');
580 |       expect(dismissButton).toBeInTheDocument();
581 |     });
582 | 
583 |     test('has proper visual hierarchy with icons', () => {
584 |       expect(screen.getByTestId('share-icon')).toBeInTheDocument();
585 |       expect(screen.getByTestId('plus-icon')).toBeInTheDocument();
586 |       expect(screen.getByTestId('x-icon')).toBeInTheDocument();
587 |     });
588 | 
589 |     test('provides clear instructions for users', () => {
590 |       expect(screen.getByText(/tap the/i)).toBeInTheDocument();
591 |       expect(screen.getByText(/share button below/i)).toBeInTheDocument();
592 |       expect(screen.getByText(/select/i)).toBeInTheDocument();
593 |       // Check for the instruction text specifically (inside the step 2 div)
594 |       expect(screen.getAllByText(/add to home screen/i)).toHaveLength(2); // One in heading, one in instructions
595 |     });
596 |   });
597 | 
598 |   describe('Integration Tests', () => {
599 |     test('complete user workflow: show prompt, interact, and dismiss', async () => {
600 |       // Setup: iOS device, not standalone, not dismissed
601 |       Object.defineProperty(navigator, 'userAgent', {
602 |         writable: true,
603 |         value: TEST_DATA.userAgents.iosSafari
604 |       });
605 | 
606 |       render(<IOSInstallPrompt onDismiss={mockOnDismiss} />);
607 | 
608 |       // 1. Prompt should not be visible initially
609 |       expect(screen.queryByTestId('card')).not.toBeInTheDocument();
610 | 
611 |       // 2. Wait for delay - prompt should appear
612 |       act(() => {
613 |         jest.advanceTimersByTime(3000);
614 |       });
615 |       await waitFor(() => {
616 |         expect(screen.getByTestId('card')).toBeInTheDocument();
617 |       });
618 | 
[TRUNCATED]
```

__tests__/components/markdown.components.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen } from '@testing-library/react';
3 | import React from 'react';
4 | 
5 | // Mock Next.js Link component
6 | jest.mock('next/link', () => ({
7 |   __esModule: true,
8 |   default: ({ children, href, ...props }: any) => (
9 |     <a href={href} {...props} data-testid="next-link">
10 |       {children}
11 |     </a>
12 |   ),
13 | }));
14 | 
15 | // Import the component to access its internal components object
16 | // We'll test the individual component functions directly
17 | describe('Markdown Custom Components', () => {
18 | 
19 |   beforeEach(() => {
20 |     jest.clearAllMocks();
21 |   });
22 | 
23 |   describe('Code Components', () => {
24 |     test('renders pre element with correct styling', () => {
25 |       const PreComponent = ({ children }: any) => (
26 |         <pre className="overflow-x-auto max-w-full rounded-lg bg-zinc-100 dark:bg-zinc-800/50 black:bg-zinc-800/50 p-2.5 my-1.5 text-sm whitespace-pre-wrap break-words">
27 |           {children}
28 |         </pre>
29 |       );
30 | 
31 |       render(<PreComponent>Test code block</PreComponent>);
32 |       
33 |       const preElement = screen.getByText('Test code block');
34 |       expect(preElement).toHaveClass(
35 |         'overflow-x-auto', 
36 |         'max-w-full', 
37 |         'rounded-lg', 
38 |         'bg-zinc-100', 
39 |         'dark:bg-zinc-800/50', 
40 |         'black:bg-zinc-800/50',
41 |         'p-2.5',
42 |         'my-1.5',
43 |         'text-sm',
44 |         'whitespace-pre-wrap',
45 |         'break-words'
46 |       );
47 |       expect(preElement).toHaveTextContent('Test code block');
48 |     });
49 | 
50 |     test('renders inline code with correct styling', () => {
51 |       const CodeComponent = ({ children, className }: any) => {
52 |         const match = /language-(\w+)/.exec(className || '');
53 |         const isInline = !match && !className;
54 | 
55 |         if (isInline) {
56 |           return (
57 |             <code className="px-1 py-0.5 rounded-md bg-zinc-100 dark:bg-zinc-800/50 black:bg-zinc-800/50 text-zinc-700 dark:text-zinc-300 black:text-zinc-300 text-[0.9em] font-mono">
58 |               {children}
59 |             </code>
60 |           );
61 |         }
62 |         return <code className="block font-mono text-sm whitespace-pre-wrap break-words max-w-full">{children}</code>;
63 |       };
64 | 
65 |       render(<CodeComponent>inline code</CodeComponent>);
66 |       
67 |       const codeElement = screen.getByText('inline code');
68 |       expect(codeElement).toHaveClass(
69 |         'px-1',
70 |         'py-0.5',
71 |         'rounded-md',
72 |         'bg-zinc-100',
73 |         'dark:bg-zinc-800/50',
74 |         'black:bg-zinc-800/50',
75 |         'text-zinc-700',
76 |         'dark:text-zinc-300',
77 |         'black:text-zinc-300',
78 |         'text-[0.9em]',
79 |         'font-mono'
80 |       );
81 |     });
82 | 
83 |     test('renders block code with correct styling', () => {
84 |       const CodeComponent = ({ children, className }: any) => {
85 |         const match = /language-(\w+)/.exec(className || '');
86 |         const isInline = !match && !className;
87 | 
88 |         if (isInline) {
89 |           return <code className="px-1 py-0.5 rounded-md bg-zinc-100 dark:bg-zinc-800/50 black:bg-zinc-800/50 text-zinc-700 dark:text-zinc-300 black:text-zinc-300 text-[0.9em] font-mono">{children}</code>;
90 |         }
91 |         return (
92 |           <code className="block font-mono text-sm whitespace-pre-wrap break-words max-w-full">
93 |             {children}
94 |           </code>
95 |         );
96 |       };
97 | 
98 |       render(<CodeComponent className="language-javascript">console.log('test');</CodeComponent>);
99 |       
100 |       const codeElement = screen.getByText("console.log('test');");
101 |       expect(codeElement).toHaveClass(
102 |         'block',
103 |         'font-mono',
104 |         'text-sm',
105 |         'whitespace-pre-wrap',
106 |         'break-words',
107 |         'max-w-full'
108 |       );
109 |     });
110 |   });
111 | 
112 |   describe('List Components', () => {
113 |     test('renders ordered list with correct styling', () => {
114 |       const OlComponent = ({ children }: any) => (
115 |         <ol className="list-decimal list-outside ml-6 pl-2 space-y-0.5 my-1.5">
116 |           {children}
117 |         </ol>
118 |       );
119 | 
120 |       render(<OlComponent><li>Item 1</li><li>Item 2</li></OlComponent>);
121 |       
122 |       const olElement = screen.getByRole('list');
123 |       expect(olElement).toHaveClass(
124 |         'list-decimal',
125 |         'list-outside',
126 |         'ml-6',
127 |         'pl-2',
128 |         'space-y-0.5',
129 |         'my-1.5'
130 |       );
131 |     });
132 | 
133 |     test('renders unordered list with correct styling', () => {
134 |       const UlComponent = ({ children }: any) => (
135 |         <ul className="list-disc list-outside ml-6 pl-2 space-y-0.5 my-1.5">
136 |           {children}
137 |         </ul>
138 |       );
139 | 
140 |       render(<UlComponent><li>Item 1</li><li>Item 2</li></UlComponent>);
141 |       
142 |       const ulElement = screen.getByRole('list');
143 |       expect(ulElement).toHaveClass(
144 |         'list-disc',
145 |         'list-outside',
146 |         'ml-6',
147 |         'pl-2',
148 |         'space-y-0.5',
149 |         'my-1.5'
150 |       );
151 |     });
152 | 
153 |     test('renders list item with correct styling', () => {
154 |       const LiComponent = ({ children }: any) => (
155 |         <li className="leading-normal">{children}</li>
156 |       );
157 | 
158 |       render(<ul><LiComponent>Test item</LiComponent></ul>);
159 |       
160 |       const liElement = screen.getByRole('listitem');
161 |       expect(liElement).toHaveClass('leading-normal');
162 |       expect(liElement).toHaveTextContent('Test item');
163 |     });
164 |   });
165 | 
166 |   describe('Typography Components', () => {
167 |     test('renders paragraph with correct styling', () => {
168 |       const PComponent = ({ children }: any) => (
169 |         <p className="leading-relaxed my-1">{children}</p>
170 |       );
171 | 
172 |       render(<PComponent>Test paragraph</PComponent>);
173 |       
174 |       const pElement = screen.getByText('Test paragraph');
175 |       expect(pElement).toHaveClass('leading-relaxed', 'my-1');
176 |     });
177 | 
178 |     test('renders strong text with correct styling', () => {
179 |       const StrongComponent = ({ children }: any) => (
180 |         <strong className="font-semibold">{children}</strong>
181 |       );
182 | 
183 |       render(<StrongComponent>Bold text</StrongComponent>);
184 |       
185 |       const strongElement = screen.getByText('Bold text');
186 |       expect(strongElement).toHaveClass('font-semibold');
187 |     });
188 | 
189 |     test('renders emphasis with correct styling', () => {
190 |       const EmComponent = ({ children }: any) => (
191 |         <em className="italic">{children}</em>
192 |       );
193 | 
194 |       render(<EmComponent>Italic text</EmComponent>);
195 |       
196 |       const emElement = screen.getByText('Italic text');
197 |       expect(emElement).toHaveClass('italic');
198 |     });
199 | 
200 |     test('renders blockquote with correct styling', () => {
201 |       const BlockquoteComponent = ({ children }: any) => (
202 |         <blockquote className="border-l-2 border-zinc-200 dark:border-zinc-700 black:border-zinc-700 pl-3 my-1.5 italic text-zinc-600 dark:text-zinc-400 black:text-zinc-400">
203 |           {children}
204 |         </blockquote>
205 |       );
206 | 
207 |       render(<BlockquoteComponent>Quote text</BlockquoteComponent>);
208 |       
209 |       const blockquoteElement = screen.getByText('Quote text');
210 |       expect(blockquoteElement).toHaveClass(
211 |         'border-l-2',
212 |         'border-zinc-200',
213 |         'dark:border-zinc-700',
214 |         'black:border-zinc-700',
215 |         'pl-3',
216 |         'my-1.5',
217 |         'italic',
218 |         'text-zinc-600',
219 |         'dark:text-zinc-400',
220 |         'black:text-zinc-400'
221 |       );
222 |     });
223 |   });
224 | 
225 |   describe('Heading Components', () => {
226 |     test('renders h1 with correct styling and cyberpunk theme support', () => {
227 |       const H1Component = ({ children }: any) => (
228 |         <h1 className="text-2xl font-semibold mt-3 mb-1.5 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100">
229 |           {children}
230 |         </h1>
231 |       );
232 | 
233 |       render(<H1Component>Main Heading</H1Component>);
234 |       
235 |       const h1Element = screen.getByRole('heading', { level: 1 });
236 |       expect(h1Element).toHaveClass(
237 |         'text-2xl',
238 |         'font-semibold',
239 |         'mt-3',
240 |         'mb-1.5',
241 |         'text-zinc-900',
242 |         'dark:text-zinc-100',
243 |         'black:text-zinc-100',
244 |         'cyberpunk:text-zinc-100'
245 |       );
246 |     });
247 | 
248 |     test('renders h2 with correct styling', () => {
249 |       const H2Component = ({ children }: any) => (
250 |         <h2 className="text-xl font-semibold mt-2.5 mb-1.5 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100">
251 |           {children}
252 |         </h2>
253 |       );
254 | 
255 |       render(<H2Component>Section Heading</H2Component>);
256 |       
257 |       const h2Element = screen.getByRole('heading', { level: 2 });
258 |       expect(h2Element).toHaveClass(
259 |         'text-xl',
260 |         'font-semibold',
261 |         'mt-2.5',
262 |         'mb-1.5',
263 |         'text-zinc-900',
264 |         'dark:text-zinc-100',
265 |         'black:text-zinc-100',
266 |         'cyberpunk:text-zinc-100'
267 |       );
268 |     });
269 | 
270 |     test('renders h3 through h6 with correct styling', () => {
271 |       const HeadingComponents = {
272 |         H3: ({ children }: any) => (
273 |           <h3 className="text-lg font-semibold mt-2 mb-1 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100">
274 |             {children}
275 |           </h3>
276 |         ),
277 |         H4: ({ children }: any) => (
278 |           <h4 className="text-base font-semibold mt-2 mb-1 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100">
279 |             {children}
280 |           </h4>
281 |         ),
282 |         H5: ({ children }: any) => (
283 |           <h5 className="text-sm font-semibold mt-2 mb-1 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100">
284 |             {children}
285 |           </h5>
286 |         ),
287 |         H6: ({ children }: any) => (
288 |           <h6 className="text-xs font-semibold mt-2 mb-0.5 text-zinc-900 dark:text-zinc-100 black:text-zinc-100 cyberpunk:text-zinc-100">
289 |             {children}
290 |           </h6>
291 |         ),
292 |       };
293 | 
294 |       const headingTests = [
295 |         { Component: HeadingComponents.H3, level: 3, sizeClass: 'text-lg', text: 'H3 Heading' },
296 |         { Component: HeadingComponents.H4, level: 4, sizeClass: 'text-base', text: 'H4 Heading' },
297 |         { Component: HeadingComponents.H5, level: 5, sizeClass: 'text-sm', text: 'H5 Heading' },
298 |         { Component: HeadingComponents.H6, level: 6, sizeClass: 'text-xs', text: 'H6 Heading' },
299 |       ];
300 | 
301 |       headingTests.forEach(({ Component, level, sizeClass, text }) => {
302 |         const { unmount } = render(<Component>{text}</Component>);
303 |         
304 |         const headingElement = screen.getByRole('heading', { level });
305 |         expect(headingElement).toHaveClass(
306 |           sizeClass,
307 |           'font-semibold',
308 |           'mt-2',
309 |           level === 6 ? 'mb-0.5' : 'mb-1',
310 |           'text-zinc-900',
311 |           'dark:text-zinc-100',
312 |           'black:text-zinc-100',
313 |           'cyberpunk:text-zinc-100'
314 |         );
315 |         
316 |         unmount();
317 |       });
318 |     });
319 |   });
320 | 
321 |   describe('Link Components', () => {
322 |     // Note: We can't fully test the Link component behavior without importing the actual markdown component
323 |     // But we can test the logic for internal vs external links
324 |     test('identifies internal links correctly', () => {
325 |       const isInternal = (href: string) => Boolean(href && (href.startsWith("/") || href.startsWith("#")));
326 |       
327 |       expect(isInternal("/internal-page")).toBe(true);
328 |       expect(isInternal("#section")).toBe(true);  
329 |       expect(isInternal("https://external.com")).toBe(false);
330 |       expect(isInternal("http://external.com")).toBe(false);
331 |       expect(isInternal("mailto:test@example.com")).toBe(false);
332 |       expect(isInternal("")).toBe(false);
333 |     });
334 | 
335 |     test('renders external link with correct attributes', () => {
336 |       const ExternalLinkComponent = ({ href, children }: any) => (
337 |         <a
338 |           href={href}
339 |           target="_blank"
340 |           rel="noopener noreferrer"
341 |           className="text-blue-500 hover:underline hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 black:text-blue-400 black:hover:text-blue-300 transition-colors"
342 |         >
343 |           {children}
344 |         </a>
345 |       );
346 | 
347 |       render(<ExternalLinkComponent href="https://example.com">External Link</ExternalLinkComponent>);
348 |       
349 |       const linkElement = screen.getByRole('link');
350 |       expect(linkElement).toHaveAttribute('href', 'https://example.com');
351 |       expect(linkElement).toHaveAttribute('target', '_blank');
352 |       expect(linkElement).toHaveAttribute('rel', 'noopener noreferrer');
353 |       expect(linkElement).toHaveClass(
354 |         'text-blue-500',
355 |         'hover:underline',
356 |         'hover:text-blue-600',
357 |         'dark:text-blue-400',
358 |         'dark:hover:text-blue-300',
359 |         'black:text-blue-400',
360 |         'black:hover:text-blue-300',
361 |         'transition-colors'
362 |       );
363 |     });
364 |   });
365 | 
366 |   describe('Table Components', () => {
367 |     test('renders table with wrapper and correct styling', () => {
368 |       const TableComponent = ({ children }: any) => (
369 |         <div className="my-1.5 overflow-x-auto">
370 |           <table className="min-w-full divide-y divide-zinc-200 dark:divide-zinc-700 black:divide-zinc-700">
371 |             {children}
372 |           </table>
373 |         </div>
374 |       );
375 | 
376 |       render(
377 |         <TableComponent>
378 |           <tbody>
379 |             <tr><td>Cell</td></tr>
380 |           </tbody>
381 |         </TableComponent>
382 |       );
383 |       
384 |       const wrapperDiv = screen.getByRole('table').parentElement;
385 |       expect(wrapperDiv).toHaveClass('my-1.5', 'overflow-x-auto');
386 |       
387 |       const tableElement = screen.getByRole('table');
388 |       expect(tableElement).toHaveClass(
389 |         'min-w-full',
390 |         'divide-y',
391 |         'divide-zinc-200',
392 |         'dark:divide-zinc-700',
393 |         'black:divide-zinc-700'
394 |       );
395 |     });
396 | 
397 |     test('renders thead with correct styling', () => {
398 |       const TheadComponent = ({ children }: any) => (
399 |         <thead className="bg-zinc-50 dark:bg-zinc-800/50 black:bg-zinc-800/50">
400 |           {children}
401 |         </thead>
402 |       );
403 | 
404 |       render(
405 |         <table>
406 |           <TheadComponent>
407 |             <tr><th>Header</th></tr>
408 |           </TheadComponent>
409 |         </table>
410 |       );
411 |       
412 |       const theadElement = screen.getByRole('columnheader').parentElement?.parentElement;
413 |       expect(theadElement).toHaveClass(
414 |         'bg-zinc-50',
415 |         'dark:bg-zinc-800/50',
416 |         'black:bg-zinc-800/50'
417 |       );
418 |     });
419 | 
420 |     test('renders tbody with correct styling', () => {
421 |       const TbodyComponent = ({ children }: any) => (
422 |         <tbody className="divide-y divide-zinc-200 dark:divide-zinc-700 black:divide-zinc-700 bg-white dark:bg-transparent black:bg-transparent">
423 |           {children}
424 |         </tbody>
425 |       );
426 | 
427 |       render(
428 |         <table>
429 |           <TbodyComponent>
430 |             <tr><td>Cell</td></tr>
431 |           </TbodyComponent>
432 |         </table>
433 |       );
434 |       
435 |       const tbodyElement = screen.getByRole('cell').parentElement?.parentElement;
436 |       expect(tbodyElement).toHaveClass(
437 |         'divide-y',
438 |         'divide-zinc-200',
439 |         'dark:divide-zinc-700',
440 |         'black:divide-zinc-700',
441 |         'bg-white',
442 |         'dark:bg-transparent',
443 |         'black:bg-transparent'
444 |       );
445 |     });
446 | 
447 |     test('renders tr with hover effects', () => {
448 |       const TrComponent = ({ children }: any) => (
449 |         <tr className="transition-colors hover:bg-zinc-50 dark:hover:bg-zinc-800/30 black:hover:bg-zinc-800/30">
450 |           {children}
451 |         </tr>
452 |       );
453 | 
454 |       render(
455 |         <table>
456 |           <tbody>
457 |             <TrComponent><td>Cell</td></TrComponent>
458 |           </tbody>
459 |         </table>
460 |       );
461 |       
462 |       const trElement = screen.getByRole('cell').parentElement;
463 |       expect(trElement).toHaveClass(
464 |         'transition-colors',
465 |         'hover:bg-zinc-50',
466 |         'dark:hover:bg-zinc-800/30',
467 |         'black:hover:bg-zinc-800/30'
468 |       );
469 |     });
470 | 
471 |     test('renders th with correct styling', () => {
472 |       const ThComponent = ({ children }: any) => (
473 |         <th className="px-3 py-1.5 text-left text-xs font-medium text-zinc-500 dark:text-zinc-400 black:text-zinc-400 uppercase tracking-wider">
474 |           {children}
475 |         </th>
476 |       );
477 | 
478 |       render(
479 |         <table>
480 |           <thead>
481 |             <tr><ThComponent>Header</ThComponent></tr>
482 |           </thead>
483 |         </table>
484 |       );
485 |       
486 |       const thElement = screen.getByRole('columnheader');
487 |       expect(thElement).toHaveClass(
488 |         'px-3',
489 |         'py-1.5',
490 |         'text-left',
491 |         'text-xs',
492 |         'font-medium',
493 |         'text-zinc-500',
494 |         'dark:text-zinc-400',
495 |         'black:text-zinc-400',
496 |         'uppercase',
497 |         'tracking-wider'
498 |       );
499 |     });
500 | 
501 |     test('renders td with correct styling', () => {
502 |       const TdComponent = ({ children }: any) => (
503 |         <td className="px-3 py-1.5 text-sm">{children}</td>
504 |       );
505 | 
506 |       render(
507 |         <table>
508 |           <tbody>
509 |             <tr><TdComponent>Cell content</TdComponent></tr>
510 |           </tbody>
511 |         </table>
512 |       );
513 |       
514 |       const tdElement = screen.getByRole('cell');
515 |       expect(tdElement).toHaveClass('px-3', 'py-1.5', 'text-sm');
516 |     });
517 |   });
518 | 
519 |   describe('Miscellaneous Components', () => {
520 |     test('renders hr with correct styling', () => {
521 |       const HrComponent = () => (
522 |         <hr className="my-1.5 border-zinc-200 dark:border-zinc-700 black:border-zinc-700" />
523 |       );
524 | 
525 |       render(<HrComponent />);
526 |       
527 |       const hrElement = screen.getByRole('separator');
528 |       expect(hrElement).toHaveClass(
529 |         'my-1.5',
530 |         'border-zinc-200',
531 |         'dark:border-zinc-700',
532 |         'black:border-zinc-700'
533 |       );
534 |     });
535 |   });
536 | 
537 |   describe('Theme Support', () => {
538 |     test('all components include dark, black, and cyberpunk theme classes', () => {
539 |       // Test a representative component (h1) to verify theme support
540 |       const H1Component = ({ children }: any) => (
[TRUNCATED]
```

__tests__/components/markdown.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen } from '@testing-library/react';
3 | import { Markdown } from '../../components/markdown';
4 | 
5 | // Mock Next.js Link component
6 | jest.mock('next/link', () => ({
7 |   __esModule: true,
8 |   default: ({ children, href, ...props }: any) => (
9 |     <a href={href} {...props} data-testid="next-link">
10 |       {children}
11 |     </a>
12 |   ),
13 | }));
14 | 
15 | // Mock KaTeX CSS import
16 | jest.mock('katex/dist/katex.min.css', () => ({}));
17 | 
18 | // Mock react-markdown and plugins
19 | jest.mock('react-markdown', () => ({
20 |   __esModule: true,
21 |   default: ({ children, components, remarkPlugins, rehypePlugins }: any) => (
22 |     <div data-testid="react-markdown" data-remark-plugins={remarkPlugins?.length} data-rehype-plugins={rehypePlugins?.length}>
23 |       {/* Simulate how ReactMarkdown would render the content with custom components */}
24 |       <div data-testid="markdown-content">{children}</div>
25 |     </div>
26 |   ),
27 | }));
28 | 
29 | jest.mock('remark-gfm', () => ({
30 |   __esModule: true,
31 |   default: 'remark-gfm-plugin',
32 | }));
33 | 
34 | jest.mock('remark-math', () => ({
35 |   __esModule: true,
36 |   default: 'remark-math-plugin',
37 | }));
38 | 
39 | jest.mock('rehype-katex', () => ({
40 |   __esModule: true,
41 |   default: 'rehype-katex-plugin',
42 | }));
43 | 
44 | describe('Markdown', () => {
45 |   const mockMarkdownContent = `
46 | # Test Heading
47 | This is a **bold** text with *italic* and \`inline code\`.
48 | 
49 | ## Lists
50 | - Item 1
51 | - Item 2
52 | 
53 | 1. Numbered item 1
54 | 2. Numbered item 2
55 | 
56 | > This is a blockquote
57 | 
58 | [External link](https://example.com)
59 | [Internal link](/internal)
60 | 
61 | \`\`\`javascript
62 | console.log('code block');
63 | \`\`\`
64 | 
65 | | Header 1 | Header 2 |
66 | |----------|----------|
67 | | Cell 1   | Cell 2   |
68 |   `.trim();
69 | 
70 |   beforeEach(() => {
71 |     jest.clearAllMocks();
72 |   });
73 | 
74 |   describe('Basic Rendering', () => {
75 |     test('renders markdown content correctly', () => {
76 |       render(<Markdown>{mockMarkdownContent}</Markdown>);
77 |       
78 |       expect(screen.getByTestId('react-markdown')).toBeInTheDocument();
79 |       expect(screen.getByTestId('markdown-content')).toBeInTheDocument();
80 |     });
81 | 
82 |     test('renders with empty content', () => {
83 |       render(<Markdown>{''}</Markdown>);
84 |       
85 |       expect(screen.getByTestId('react-markdown')).toBeInTheDocument();
86 |       expect(screen.getByTestId('markdown-content')).toHaveTextContent('');
87 |     });
88 | 
89 |     test('applies overflow-x-auto wrapper class', () => {
90 |       const { container } = render(<Markdown>Test content</Markdown>);
91 |       
92 |       const wrapper = container.firstChild as HTMLElement;
93 |       expect(wrapper).toHaveClass('overflow-x-auto', 'max-w-full');
94 |     });
95 |   });
96 | 
97 |   describe('Plugin Configuration', () => {
98 |     test('configures remark and rehype plugins correctly', () => {
99 |       render(<Markdown>Test content</Markdown>);
100 |       
101 |       const markdownElement = screen.getByTestId('react-markdown');
102 |       expect(markdownElement).toHaveAttribute('data-remark-plugins', '2'); // remarkGfm + remarkMath
103 |       expect(markdownElement).toHaveAttribute('data-rehype-plugins', '1'); // rehypeKatex
104 |     });
105 |   });
106 | 
107 |   describe('Math Delimiter Preprocessing', () => {
108 |     test('converts inline math delimiters \\(...\\) to $...
</current_codebase>
, () => {
109 |       const mathContent = 'Inline math: \\(x^2 + y^2 = z^2\\)';
110 |       render(<Markdown>{mathContent}</Markdown>);
111 |       
112 |       const content = screen.getByTestId('markdown-content');
113 |       expect(content).toHaveTextContent('Inline math: $x^2 + y^2 = z^2
</current_codebase>
);
114 |     });
115 | 
116 |     test('converts block math delimiters \\[...\\] to $...$', () => {
117 |       const mathContent = 'Block math: \\[\\frac{a}{b} = c\\]';
118 |       render(<Markdown>{mathContent}</Markdown>);
119 |       
120 |       const content = screen.getByTestId('markdown-content');
121 |       expect(content).toHaveTextContent('Block math: $\\frac{a}{b} = c$');
122 |     });
123 | 
124 |     test('handles multiple math expressions', () => {
125 |       const mathContent = 'First: \\(a + b\\) and block: \\[c = d\\] and another inline: \\(e - f\\)';
126 |       render(<Markdown>{mathContent}</Markdown>);
127 |       
128 |       const content = screen.getByTestId('markdown-content');
129 |       expect(content).toHaveTextContent('First: $a + b$ and block: $c = d$ and another inline: $e - f
</current_codebase>
);
130 |     });
131 | 
132 |     test('handles math with whitespace and newlines', () => {
133 |       const mathContent = `Block math with newlines:
134 | \\[
135 |   \\sum_{i=1}^{n} x_i = \\frac{n(n+1)}{2}
136 | \\]`;
137 |       render(<Markdown>{mathContent}</Markdown>);
138 |       
139 |       const content = screen.getByTestId('markdown-content');
140 |       expect(content.textContent).toContain('$');
141 |       expect(content.textContent).toContain('\\sum_{i=1}^{n} x_i = \\frac{n(n+1)}{2}');
142 |     });
143 | 
144 |     test('does not modify regular parentheses and brackets', () => {
145 |       const regularContent = 'Regular (parentheses) and [brackets] should not change.';
146 |       render(<Markdown>{regularContent}</Markdown>);
147 |       
148 |       const content = screen.getByTestId('markdown-content');
149 |       expect(content).toHaveTextContent('Regular (parentheses) and [brackets] should not change.');
150 |     });
151 | 
152 |     test('handles empty values in math preprocessing', () => {
153 |       // Test empty string
154 |       const { unmount } = render(<Markdown>{''}</Markdown>);
155 |       expect(screen.getByTestId('markdown-content')).toHaveTextContent('');
156 |       unmount();
157 |     });
158 | 
159 |     test('handles whitespace-only content in math preprocessing', () => {
160 |       // Test whitespace-only string (ReactMarkdown may trim this, so just ensure no crash)
161 |       expect(() => {
162 |         render(<Markdown>{'   '}</Markdown>);
163 |       }).not.toThrow();
164 |       
165 |       expect(screen.getByTestId('markdown-content')).toBeInTheDocument();
166 |     });
167 |   });
168 | 
169 |   describe('Memoization', () => {
170 |     test('memoizes component and prevents unnecessary re-renders', () => {
171 |       const { rerender } = render(<Markdown>Test content</Markdown>);
172 |       const firstRender = screen.getByTestId('react-markdown');
173 |       
174 |       // Re-render with same content
175 |       rerender(<Markdown>Test content</Markdown>);
176 |       const secondRender = screen.getByTestId('react-markdown');
177 |       
178 |       // Component should be memoized (same reference)
179 |       expect(firstRender).toBe(secondRender);
180 |     });
181 | 
182 |     test('re-renders when content changes', () => {
183 |       const { rerender } = render(<Markdown>Original content</Markdown>);
184 |       expect(screen.getByTestId('markdown-content')).toHaveTextContent('Original content');
185 |       
186 |       rerender(<Markdown>Updated content</Markdown>);
187 |       expect(screen.getByTestId('markdown-content')).toHaveTextContent('Updated content');
188 |     });
189 |   });
190 | 
191 |   describe('Error Handling', () => {
192 |     test('handles malformed markdown gracefully', () => {
193 |       const malformedMarkdown = '# Heading with [broken link](';
194 |       
195 |       expect(() => {
196 |         render(<Markdown>{malformedMarkdown}</Markdown>);
197 |       }).not.toThrow();
198 |       
199 |       expect(screen.getByTestId('react-markdown')).toBeInTheDocument();
200 |     });
201 | 
202 |     test('handles null or undefined content gracefully', () => {
203 |       // Test with empty string
204 |       expect(() => {
205 |         render(<Markdown>{''}</Markdown>);
206 |       }).not.toThrow();
207 |       
208 |       // Test component handles empty/falsy values
209 |       const { container } = render(<Markdown>{''}</Markdown>);
210 |       expect(container.firstChild).toBeInTheDocument();
211 |       
212 |       // Test with null (after fixing preprocessMathDelimiters)
213 |       expect(() => {
214 |         render(<Markdown>{null as any}</Markdown>);
215 |       }).not.toThrow();
216 |     });
217 | 
218 |     test('handles very long content', () => {
219 |       const longContent = 'a'.repeat(10000);
220 |       
221 |       expect(() => {
222 |         render(<Markdown>{longContent}</Markdown>);
223 |       }).not.toThrow();
224 |       
225 |       expect(screen.getByTestId('markdown-content')).toHaveTextContent(longContent);
226 |     });
227 |   });
228 | 
229 |   describe('Accessibility', () => {
230 |     test('maintains semantic HTML structure', () => {
231 |       const { container } = render(<Markdown>Test content</Markdown>);
232 |       
233 |       // Should have proper div wrapper
234 |       const wrapper = container.firstChild as HTMLElement;
235 |       expect(wrapper.tagName).toBe('DIV');
236 |       expect(wrapper).toHaveClass('overflow-x-auto', 'max-w-full');
237 |     });
238 | 
239 |     test('allows custom components to maintain accessibility', () => {
240 |       // The component configuration should allow ReactMarkdown to render
241 |       // semantic HTML elements that maintain accessibility
242 |       render(<Markdown># Heading\nParagraph text</Markdown>);
243 |       
244 |       expect(screen.getByTestId('react-markdown')).toBeInTheDocument();
245 |     });
246 |   });
247 | 
248 |   describe('Performance', () => {
249 |     test('renders efficiently with large content', () => {
250 |       const startTime = performance.now();
251 |       
252 |       const largeContent = Array(100).fill(0).map((_, i) => 
253 |         `## Section ${i}\n\nThis is paragraph ${i} with **bold** and *italic* text.\n\n`
254 |       ).join('');
255 |       
256 |       render(<Markdown>{largeContent}</Markdown>);
257 |       
258 |       const endTime = performance.now();
259 |       const renderTime = endTime - startTime;
260 |       
261 |       // Should render reasonably quickly (less than 100ms for large content)
262 |       expect(renderTime).toBeLessThan(100);
263 |       expect(screen.getByTestId('react-markdown')).toBeInTheDocument();
264 |     });
265 |   });
266 | 
267 |   describe('Edge Cases', () => {
268 |     test('handles content with only whitespace', () => {
269 |       render(<Markdown>   \n\n   \t   </Markdown>);
270 |       
271 |       expect(screen.getByTestId('react-markdown')).toBeInTheDocument();
272 |     });
273 | 
274 |     test('handles mixed math and markdown content', () => {
275 |       const mixedContent = `
276 | # Math Examples
277 | 
278 | Inline math: \\(x = 2\\) in a sentence.
279 | 
280 | Block math:
281 | \\[
282 |   E = mc^2
283 | \\]
284 | 
285 | - List item with math: \\(a + b = c\\)
286 | - Another item
287 | 
288 | | Formula | Result |
289 | |---------|--------|
290 | | \\(2 + 2\\) | 4 |
291 |       `.trim();
292 |       
293 |       render(<Markdown>{mixedContent}</Markdown>);
294 |       
295 |       const content = screen.getByTestId('markdown-content');
296 |       expect(content.textContent).toContain('$x = 2
</current_codebase>
);
297 |       expect(content.textContent).toContain('$\n  E = mc^2\n$');
298 |       expect(content.textContent).toContain('$a + b = c
</current_codebase>
);
299 |       expect(content.textContent).toContain('$2 + 2
</current_codebase>
);
300 |     });
301 | 
302 |     test('handles special characters and Unicode', () => {
303 |       const unicodeContent = '# Test with émojis 🚀 and spëcial châractërs';
304 |       
305 |       render(<Markdown>{unicodeContent}</Markdown>);
306 |       
307 |       expect(screen.getByTestId('markdown-content')).toHaveTextContent(unicodeContent);
308 |     });
309 | 
310 |     test('handles nested math expressions', () => {
311 |       const nestedMath = 'Formula: \\(\\frac{\\sqrt{a + b}}{c - d}\\) and block: \\[\\sum_{i=1}^{n} \\frac{x_i}{y_i}\\]';
312 |       
313 |       render(<Markdown>{nestedMath}</Markdown>);
314 |       
315 |       const content = screen.getByTestId('markdown-content');
316 |       expect(content.textContent).toContain('$\\frac{\\sqrt{a + b}}{c - d}
</current_codebase>
);
317 |       expect(content.textContent).toContain('$\\sum_{i=1}^{n} \\frac{x_i}{y_i}$');
318 |     });
319 |   });
320 | 
321 |   describe('Integration Tests', () => {
322 |     test('complete markdown workflow with all features', () => {
323 |       const completeMarkdown = `
324 | # Complete Markdown Test
325 | 
326 | This tests **all** features *together*.
327 | 
328 | ## Math Section
329 | Inline: \\(x^2 + y^2 = z^2\\)
330 | 
331 | Block:
332 | \\[
333 |   \\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}
334 | \\]
335 | 
336 | ## Lists and Code
337 | - Item with \`inline code\`
338 | - Item with math: \\(a = b + c\\)
339 | 
340 | 1. Numbered item
341 | 2. Another numbered item
342 | 
343 | \`\`\`javascript
344 | function test() {
345 |   return "Hello World";
346 | }
347 | \`\`\`
348 | 
349 | ## Links and Quotes
350 | [External](https://example.com) and [Internal](/test)
351 | 
352 | > This is a blockquote with \\(inline math\\)
353 | 
354 | ## Table
355 | | Feature | Status |
356 | |---------|--------|
357 | | Math    | \\(\\checkmark\\) |
358 | | Code    | \`working\` |
359 | 
360 | ---
361 | 
362 | Final paragraph.
363 |       `.trim();
364 |       
365 |       render(<Markdown>{completeMarkdown}</Markdown>);
366 |       
367 |       const content = screen.getByTestId('markdown-content');
368 |       
369 |       // Verify math processing
370 |       expect(content.textContent).toContain('$x^2 + y^2 = z^2
</current_codebase>
);
371 |       expect(content.textContent).toContain('$\n  \\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}\n$');
372 |       expect(content.textContent).toContain('$a = b + c
</current_codebase>
);
373 |       expect(content.textContent).toContain('$inline math
</current_codebase>
);
374 |       expect(content.textContent).toContain('$\\checkmark
</current_codebase>
);
375 |       
376 |       // Verify all content sections are present
377 |       expect(content.textContent).toContain('Complete Markdown Test');
378 |       expect(content.textContent).toContain('Math Section');
379 |       expect(content.textContent).toContain('Lists and Code');
380 |       expect(content.textContent).toContain('Links and Quotes');
381 |       expect(content.textContent).toContain('Final paragraph');
382 |     });
383 |   });
384 | });
```

__tests__/components/mcp-server-manager.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { MCPServerManager } from '../../components/mcp-server-manager';
4 | import { MCPServer } from '@/lib/context/mcp-context';
5 | 
6 | // Mock crypto.randomUUID
7 | Object.defineProperty(global, 'crypto', {
8 |   value: {
9 |     randomUUID: jest.fn(() => 'test-uuid-123')
10 |   }
11 | });
12 | 
13 | // Mock URL constructor for connection testing
14 | global.URL = jest.fn().mockImplementation((url: string) => ({
15 |   href: url,
16 |   origin: 'https://example.com',
17 |   pathname: '/path'
18 | })) as any;
19 | 
20 | // Mock toast notifications
21 | jest.mock('sonner', () => ({
22 |   toast: {
23 |     success: jest.fn(),
24 |     error: jest.fn(),
25 |   },
26 | }));
27 | 
28 | // Mock UI components
29 | jest.mock('../../components/ui/dialog', () => ({
30 |   Dialog: ({ children, open }: any) => open ? <div data-testid="dialog">{children}</div> : null,
31 |   DialogContent: ({ children, className }: any) => <div className={className} data-testid="dialog-content">{children}</div>,
32 |   DialogDescription: ({ children, className }: any) => <p className={className} data-testid="dialog-description">{children}</p>,
33 |   DialogHeader: ({ children, className }: any) => <div className={className} data-testid="dialog-header">{children}</div>,
34 |   DialogTitle: ({ children, className }: any) => <h2 className={className} data-testid="dialog-title">{children}</h2>,
35 | }));
36 | 
37 | jest.mock('../../components/ui/button', () => ({
38 |   Button: ({ children, onClick, variant, size, disabled, className, ...props }: any) => (
39 |     <button 
40 |       onClick={onClick} 
41 |       disabled={disabled}
42 |       className={className} 
43 |       data-variant={variant}
44 |       data-size={size}
45 |       data-testid={`button-${variant || 'default'}`}
46 |       {...props}
47 |     >
48 |       {children}
49 |     </button>
50 |   ),
51 | }));
52 | 
53 | jest.mock('../../components/ui/input', () => ({
54 |   Input: ({ id, type, value, onChange, placeholder, className, onKeyDown, ...props }: any) => (
55 |     <input
56 |       id={id}
57 |       type={type}
58 |       value={value}
59 |       onChange={onChange}
60 |       onKeyDown={onKeyDown}
61 |       placeholder={placeholder}
62 |       className={className}
63 |       data-testid={`input-${id}`}
64 |       {...props}
65 |     />
66 |   ),
67 | }));
68 | 
69 | jest.mock('../../components/ui/label', () => ({
70 |   Label: ({ children, htmlFor, className }: any) => (
71 |     <label htmlFor={htmlFor} className={className} data-testid={`label-${htmlFor}`}>
72 |       {children}
73 |     </label>
74 |   ),
75 | }));
76 | 
77 | jest.mock('../../components/ui/accordion', () => ({
78 |   Accordion: ({ children, type, collapsible }: any) => <div data-testid="accordion">{children}</div>,
79 |   AccordionContent: ({ children }: any) => <div data-testid="accordion-content">{children}</div>,
80 |   AccordionItem: ({ children, value }: any) => <div data-testid={`accordion-item-${value}`}>{children}</div>,
81 |   AccordionTrigger: ({ children, className }: any) => (
82 |     <button className={className} data-testid="accordion-trigger">
83 |       {children}
84 |     </button>
85 |   ),
86 | }));
87 | 
88 | // Mock Lucide icons
89 | jest.mock('lucide-react', () => ({
90 |   PlusCircle: ({ className }: any) => <div className={className} data-testid="plus-circle-icon" />,
91 |   ServerIcon: ({ className }: any) => <div className={className} data-testid="server-icon" />,
92 |   X: ({ className }: any) => <div className={className} data-testid="x-icon" />,
93 |   Terminal: ({ className }: any) => <div className={className} data-testid="terminal-icon" />,
94 |   Globe: ({ className }: any) => <div className={className} data-testid="globe-icon" />,
95 |   ExternalLink: ({ className }: any) => <div className={className} data-testid="external-link-icon" />,
96 |   Trash2: ({ className }: any) => <div className={className} data-testid="trash2-icon" />,
97 |   CheckCircle: ({ className }: any) => <div className={className} data-testid="check-circle-icon" />,
98 |   Plus: ({ className }: any) => <div className={className} data-testid="plus-icon" />,
99 |   Cog: ({ className }: any) => <div className={className} data-testid="cog-icon" />,
100 |   Edit2: ({ className }: any) => <div className={className} data-testid="edit2-icon" />,
101 |   Eye: ({ className }: any) => <div className={className} data-testid="eye-icon" />,
102 |   EyeOff: ({ className }: any) => <div className={className} data-testid="eyeoff-icon" />,
103 |   Check: ({ className }: any) => <div className={className} data-testid="check-icon" />,
104 |   AlertCircle: ({ className }: any) => <div className={className} data-testid="alert-circle-icon" />,
105 |   Wifi: ({ className }: any) => <div className={className} data-testid="wifi-icon" />,
106 | }));
107 | 
108 | import { toast } from 'sonner';
109 | 
110 | describe('MCPServerManager Component', () => {
111 |   const mockServers: MCPServer[] = [
112 |     {
113 |       id: 'server-1',
114 |       name: 'Test SSE Server',
115 |       title: 'Test SSE Server',
116 |       url: 'https://example.com/sse',
117 |       type: 'sse',
118 |       env: [{ key: 'API_KEY', value: 'secret123' }],
119 |       headers: [{ key: 'Authorization', value: 'Bearer token123' }]
120 |     },
121 |     {
122 |       id: 'server-2',
123 |       name: 'Test Stdio Server',
124 |       title: 'Test Stdio Server',
125 |       url: '',
126 |       type: 'stdio',
127 |       command: 'node',
128 |       args: ['server.js', '--port', '3001'],
129 |       env: []
130 |     }
131 |   ];
132 | 
133 |   const mockProps = {
134 |     servers: [],
135 |     onServersChange: jest.fn(),
136 |     selectedServers: [],
137 |     onSelectedServersChange: jest.fn(),
138 |     open: true,
139 |     onOpenChange: jest.fn()
140 |   };
141 | 
142 |   beforeEach(() => {
143 |     jest.clearAllMocks();
144 |     // Reset URL mock
145 |     (global.URL as unknown as jest.Mock).mockClear();
146 |   });
147 | 
148 |   // Tests for Basic Rendering and Props
149 |   describe('Basic Rendering and Props', () => {
150 |     test('renders dialog when open is true', () => {
151 |       render(<MCPServerManager {...mockProps} />);
152 |       
153 |       expect(screen.getByTestId('dialog')).toBeInTheDocument();
154 |       expect(screen.getByTestId('dialog-title')).toHaveTextContent('MCP Server Configuration');
155 |     });
156 | 
157 |     test('does not render dialog when open is false', () => {
158 |       render(<MCPServerManager {...mockProps} open={false} />);
159 |       
160 |       expect(screen.queryByTestId('dialog')).not.toBeInTheDocument();
161 |     });
162 | 
163 |     test('renders dialog description correctly', () => {
164 |       render(<MCPServerManager {...mockProps} />);
165 |       
166 |       const description = screen.getByTestId('dialog-description');
167 |       expect(description).toHaveTextContent(
168 |         'Connect to Model Context Protocol servers to access additional AI tools.'
169 |       );
170 |     });
171 | 
172 |     test('displays active server count when servers are selected', () => {
173 |       render(<MCPServerManager {...mockProps} selectedServers={['server-1']} />);
174 |       
175 |       expect(screen.getByText('1 server currently active')).toBeInTheDocument();
176 |     });
177 | 
178 |     test('displays active servers count with plural when multiple servers selected', () => {
179 |       render(<MCPServerManager {...mockProps} selectedServers={['server-1', 'server-2']} />);
180 |       
181 |       expect(screen.getByText('2 servers currently active')).toBeInTheDocument();
182 |     });
183 |   });
184 | 
185 |   // Tests for Server List View
186 |   describe('Server List View', () => {
187 |     test('renders empty state when no servers exist', () => {
188 |       render(<MCPServerManager {...mockProps} />);
189 |       
190 |       expect(screen.getByText('No MCP Servers Added')).toBeInTheDocument();
191 |       expect(screen.getByText('Add your first MCP server to access additional AI tools')).toBeInTheDocument();
192 |       expect(screen.getAllByTestId('server-icon')).toHaveLength(2); // One in header, one in empty state
193 |     });
194 | 
195 |     test('renders server list when servers exist', () => {
196 |       render(<MCPServerManager {...mockProps} servers={mockServers} />);
197 |       
198 |       expect(screen.getByText('Available Servers')).toBeInTheDocument();
199 |       expect(screen.getByText('Test SSE Server')).toBeInTheDocument();
200 |       expect(screen.getByText('Test Stdio Server')).toBeInTheDocument();
201 |     });
202 | 
203 |     test('displays SSE server details correctly', () => {
204 |       render(<MCPServerManager {...mockProps} servers={[mockServers[0]]} />);
205 |       
206 |       expect(screen.getByText('Test SSE Server')).toBeInTheDocument();
207 |       expect(screen.getByText('https://example.com/sse')).toBeInTheDocument();
208 |       expect(screen.getByText('SSE')).toBeInTheDocument();
209 |       expect(screen.getByTestId('globe-icon')).toBeInTheDocument();
210 |     });
211 | 
212 |     test('displays stdio server details correctly', () => {
213 |       render(<MCPServerManager {...mockProps} servers={[mockServers[1]]} />);
214 |       
215 |       expect(screen.getByText('Test Stdio Server')).toBeInTheDocument();
216 |       expect(screen.getByText('node server.js --port 3001')).toBeInTheDocument();
217 |       expect(screen.getByText('STDIO')).toBeInTheDocument();
218 |       expect(screen.getByTestId('terminal-icon')).toBeInTheDocument();
219 |     });
220 | 
221 |     test('shows advanced configuration indicator when env vars or headers exist', () => {
222 |       render(<MCPServerManager {...mockProps} servers={[mockServers[0]]} />);
223 |       
224 |       expect(screen.getByTestId('cog-icon')).toBeInTheDocument();
225 |     });
226 | 
227 |     test('shows active state for selected servers', () => {
228 |       render(<MCPServerManager {...mockProps} servers={mockServers} selectedServers={['server-1']} />);
229 |       
230 |       const activeButton = screen.getByText('Active');
231 |       expect(activeButton).toBeInTheDocument();
232 |       expect(screen.getByTestId('check-circle-icon')).toBeInTheDocument();
233 |     });
234 | 
235 |     test('shows enable button for unselected servers', () => {
236 |       render(<MCPServerManager {...mockProps} servers={mockServers} selectedServers={[]} />);
237 |       
238 |       const enableButtons = screen.getAllByText('Enable Server');
239 |       expect(enableButtons).toHaveLength(2);
240 |     });
241 |   });
242 | 
243 |   // Tests for Server Management
244 |   describe('Server Management', () => {
245 |     test('toggles server selection when enable button is clicked', () => {
246 |       const mockOnSelectedServersChange = jest.fn();
247 |       render(<MCPServerManager 
248 |         {...mockProps} 
249 |         servers={mockServers} 
250 |         onSelectedServersChange={mockOnSelectedServersChange}
251 |       />);
252 |       
253 |       const enableButton = screen.getAllByText('Enable Server')[0];
254 |       fireEvent.click(enableButton);
255 |       
256 |       expect(mockOnSelectedServersChange).toHaveBeenCalledWith(['server-1']);
257 |       expect(toast.success).toHaveBeenCalledWith('Enabled MCP server: Test SSE Server');
258 |     });
259 | 
260 |     test('disables server when active server button is clicked', () => {
261 |       const mockOnSelectedServersChange = jest.fn();
262 |       render(<MCPServerManager 
263 |         {...mockProps} 
264 |         servers={mockServers} 
265 |         selectedServers={['server-1']}
266 |         onSelectedServersChange={mockOnSelectedServersChange}
267 |       />);
268 |       
269 |       const activeButton = screen.getByText('Active');
270 |       fireEvent.click(activeButton);
271 |       
272 |       expect(mockOnSelectedServersChange).toHaveBeenCalledWith([]);
273 |       expect(toast.success).toHaveBeenCalledWith('Disabled MCP server: Test SSE Server');
274 |     });
275 | 
276 |     test('removes server when delete button is clicked', () => {
277 |       const mockOnServersChange = jest.fn();
278 |       const mockOnSelectedServersChange = jest.fn();
279 |       render(<MCPServerManager 
280 |         {...mockProps} 
281 |         servers={mockServers}
282 |         selectedServers={['server-1']}
283 |         onServersChange={mockOnServersChange}
284 |         onSelectedServersChange={mockOnSelectedServersChange}
285 |       />);
286 |       
287 |       const deleteButtons = screen.getAllByTestId('trash2-icon');
288 |       fireEvent.click(deleteButtons[0].closest('button')!);
289 |       
290 |       expect(mockOnServersChange).toHaveBeenCalledWith([mockServers[1]]);
291 |       expect(mockOnSelectedServersChange).toHaveBeenCalledWith([]);
292 |       expect(toast.success).toHaveBeenCalledWith('Server removed');
293 |     });
294 | 
295 |     test('disables all servers when disable all button is clicked', () => {
296 |       const mockOnSelectedServersChange = jest.fn();
297 |       const mockOnOpenChange = jest.fn();
298 |       render(<MCPServerManager 
299 |         {...mockProps} 
300 |         servers={mockServers}
301 |         selectedServers={['server-1', 'server-2']}
302 |         onSelectedServersChange={mockOnSelectedServersChange}
303 |         onOpenChange={mockOnOpenChange}
304 |       />);
305 |       
306 |       const disableAllButton = screen.getByText('Disable All');
307 |       fireEvent.click(disableAllButton);
308 |       
309 |       expect(mockOnSelectedServersChange).toHaveBeenCalledWith([]);
310 |       expect(toast.success).toHaveBeenCalledWith('All MCP servers disabled');
311 |       expect(mockOnOpenChange).toHaveBeenCalledWith(false);
312 |     });
313 | 
314 |     test('disable all button is disabled when no servers are selected', () => {
315 |       render(<MCPServerManager 
316 |         {...mockProps} 
317 |         servers={mockServers}
318 |         selectedServers={[]}
319 |       />);
320 |       
321 |       const disableAllButton = screen.getByText('Disable All');
322 |       expect(disableAllButton).toBeDisabled();
323 |     });
324 |   });
325 | 
326 |   // Tests for Add Server Form
327 |   describe('Add Server Form', () => {
328 |     beforeEach(() => {
329 |       render(<MCPServerManager {...mockProps} />);
330 |       const addServerButton = screen.getByText('Add Server');
331 |       fireEvent.click(addServerButton);
332 |     });
333 | 
334 |     test('shows add server form when add server button is clicked', () => {
335 |       expect(screen.getByText('Add New MCP Server')).toBeInTheDocument();
336 |       expect(screen.getByTestId('input-name')).toBeInTheDocument();
337 |       expect(screen.getByTestId('input-title')).toBeInTheDocument();
338 |     });
339 | 
340 |     test('renders transport type selection buttons', () => {
341 |       expect(screen.getByText('SSE')).toBeInTheDocument();
342 |       expect(screen.getByText('stdio')).toBeInTheDocument();
343 |       expect(screen.getByText('Streamable HTTP')).toBeInTheDocument();
344 |     });
345 | 
346 |     test('shows URL field for SSE transport type by default', () => {
347 |       expect(screen.getByTestId('input-url')).toBeInTheDocument();
348 |       expect(screen.getByPlaceholderText('https://mcp.example.com/token/sse')).toBeInTheDocument();
349 |     });
350 | 
351 |     test('shows command and args fields when stdio transport is selected', () => {
352 |       const stdioButton = screen.getByText('stdio').closest('button')!;
353 |       fireEvent.click(stdioButton);
354 |       
355 |       expect(screen.getByTestId('input-command')).toBeInTheDocument();
356 |       expect(screen.getByTestId('input-args')).toBeInTheDocument();
357 |       expect(screen.queryByTestId('input-url')).not.toBeInTheDocument();
358 |     });
359 | 
360 |     test('shows URL field for streamable-http transport type', () => {
361 |       const httpButton = screen.getByText('Streamable HTTP').closest('button')!;
362 |       fireEvent.click(httpButton);
363 |       
364 |       expect(screen.getByTestId('input-url')).toBeInTheDocument();
365 |       expect(screen.getByPlaceholderText('https://mcp.example.com/token/mcp')).toBeInTheDocument();
366 |     });
367 | 
368 |     test('updates form values when user types', () => {
369 |       const nameInput = screen.getByTestId('input-name');
370 |       const titleInput = screen.getByTestId('input-title');
371 |       const urlInput = screen.getByTestId('input-url');
372 |       
373 |       fireEvent.change(nameInput, { target: { value: 'New Server' } });
374 |       fireEvent.change(titleInput, { target: { value: 'New Server Title' } });
375 |       fireEvent.change(urlInput, { target: { value: 'https://newserver.com' } });
376 |       
377 |       expect(nameInput).toHaveValue('New Server');
378 |       expect(titleInput).toHaveValue('New Server Title');
379 |       expect(urlInput).toHaveValue('https://newserver.com');
380 |     });
381 | 
382 |     test('handles args input as space-separated string', () => {
383 |       const stdioButton = screen.getByText('stdio').closest('button')!;
384 |       fireEvent.click(stdioButton);
385 |       
386 |       const argsInput = screen.getByTestId('input-args');
387 |       fireEvent.change(argsInput, { target: { value: 'server.js --port 3001' } });
388 |       
389 |       expect(argsInput).toHaveValue('server.js --port 3001');
390 |     });
391 | 
392 |     test('handles args input as JSON array', () => {
393 |       const stdioButton = screen.getByText('stdio').closest('button')!;
394 |       fireEvent.click(stdioButton);
395 |       
396 |       const argsInput = screen.getByTestId('input-args');
397 |       fireEvent.change(argsInput, { target: { value: '["server.js", "--port", "3001"]' } });
398 |       
399 |       // The component should process the JSON and display it as space-separated
400 |       expect(argsInput).toHaveValue('server.js --port 3001');
401 |     });
402 |   });
403 | 
404 |   // Tests for Form Validation
405 |   describe('Form Validation', () => {
406 |     beforeEach(() => {
407 |       render(<MCPServerManager {...mockProps} />);
408 |       const addServerButton = screen.getByText('Add Server');
409 |       fireEvent.click(addServerButton);
410 |     });
411 | 
412 |     test('disables submit button when server name is not provided', () => {
413 |       // The submit button should be disabled when no name is provided
414 |       const submitButton = screen.getByRole('button', { name: /add server/i });
415 |       expect(submitButton).toBeDisabled();
416 |     });
417 | 
418 |     test('disables submit button when SSE server URL is not provided', () => {
419 |       const nameInput = screen.getByTestId('input-name');
420 |       fireEvent.change(nameInput, { target: { value: 'Test Server' } });
421 |       
422 |       // Even with a name, the button should still be disabled because URL is required for SSE
423 |       const submitButton = screen.getByRole('button', { name: /add server/i });
424 |       expect(submitButton).toBeDisabled();
425 |     });
426 | 
427 |     test('disables submit button when streamable-http server URL is not provided', () => {
428 |       const httpButton = screen.getByText('Streamable HTTP').closest('button')!;
429 |       fireEvent.click(httpButton);
430 |       
431 |       const nameInput = screen.getByTestId('input-name');
432 |       fireEvent.change(nameInput, { target: { value: 'Test Server' } });
433 |       
434 |       // Button should be disabled because URL is required for Streamable HTTP
435 |       const submitButton = screen.getByRole('button', { name: /add server/i });
436 |       expect(submitButton).toBeDisabled();
437 |     });
438 | 
439 |     test('disables submit button when stdio server command is not provided', () => {
440 |       const stdioButton = screen.getByText('stdio').closest('button')!;
441 |       fireEvent.click(stdioButton);
442 |       
443 |       const nameInput = screen.getByTestId('input-name');
444 |       fireEvent.change(nameInput, { target: { value: 'Test Server' } });
445 |       
446 |       // Button should be disabled because command is required for stdio
447 |       const submitButton = screen.getByRole('button', { name: /add server/i });
448 |       expect(submitButton).toBeDisabled();
449 |     });
450 | 
451 |     test('disables submit button when stdio server args are not provided', () => {
452 |       const stdioButton = screen.getByText('stdio').closest('button')!;
453 |       fireEvent.click(stdioButton);
454 |       
455 |       const nameInput = screen.getByTestId('input-name');
456 |       const commandInput = screen.getByTestId('input-command');
457 |       fireEvent.change(nameInput, { target: { value: 'Test Server' } });
458 |       fireEvent.change(commandInput, { target: { value: 'node' } });
459 |       
460 |       // Button should be disabled because args are required for stdio
461 |       const submitButton = screen.getByRole('button', { name: /add server/i });
462 |       expect(submitButton).toBeDisabled();
463 |     });
464 | 
465 |     test('enables submit button when all required SSE fields are provided', () => {
466 |       const nameInput = screen.getByTestId('input-name');
467 |       const urlInput = screen.getByTestId('input-url');
468 |       
469 |       fireEvent.change(nameInput, { target: { value: 'Test Server' } });
470 |       fireEvent.change(urlInput, { target: { value: 'https://example.com/sse' } });
471 |       
472 |       const submitButton = screen.getByRole('button', { name: /add server/i });
473 |       expect(submitButton).not.toBeDisabled();
474 |     });
475 | 
476 |     test('enables submit button when all required stdio fields are provided', () => {
477 |       const stdioButton = screen.getByText('stdio').closest('button')!;
478 |       fireEvent.click(stdioButton);
479 |       
480 |       const nameInput = screen.getByTestId('input-name');
481 |       const commandInput = screen.getByTestId('input-command');
482 |       const argsInput = screen.getByTestId('input-args');
483 |       
484 |       fireEvent.change(nameInput, { target: { value: 'Test Server' } });
485 |       fireEvent.change(commandInput, { target: { value: 'node' } });
486 |       fireEvent.change(argsInput, { target: { value: 'server.js' } });
487 |       
488 |       const submitButton = screen.getByRole('button', { name: /add server/i });
489 |       expect(submitButton).not.toBeDisabled();
490 |     });
491 |   });
492 | 
493 |   // Tests for Environment Variables
494 |   describe('Environment Variables', () => {
495 |     beforeEach(() => {
496 |       render(<MCPServerManager {...mockProps} />);
497 |       const addServerButton = screen.getByText('Add Server');
498 |       fireEvent.click(addServerButton);
[TRUNCATED]
```

__tests__/components/message.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { Message, ReasoningMessagePart } from '../../components/message';
4 | import type { Message as TMessage } from 'ai';
5 | 
6 | // Mock external dependencies
7 | jest.mock('../../components/markdown', () => ({
8 |   Markdown: ({ children }: { children: string }) => (
9 |     <div data-testid="markdown">{children}</div>
10 |   ),
11 | }));
12 | 
13 | jest.mock('../../components/copy-button', () => ({
14 |   CopyButton: ({ text, className, ...props }: any) => (
15 |     <button 
16 |       data-testid="copy-button" 
17 |       className={className}
18 |       data-text={text}
19 |       {...props}
20 |     >
21 |       Copy
22 |     </button>
23 |   ),
24 | }));
25 | 
26 | jest.mock('../../components/citation', () => ({
27 |   Citations: ({ citations }: any) => (
28 |     <div data-testid="citations">
29 |       {citations.map((citation: any, i: number) => (
30 |         <span key={i} data-testid={`citation-${i}`}>
31 |           {citation.title}
32 |         </span>
33 |       ))}
34 |     </div>
35 |   ),
36 | }));
37 | 
38 | jest.mock('../../components/tool-invocation', () => ({
39 |   ToolInvocation: ({ toolName, state, args, result, isLatestMessage, status }: any) => (
40 |     <div 
41 |       data-testid="tool-invocation"
42 |       data-tool-name={toolName}
43 |       data-state={state}
44 |       data-is-latest={isLatestMessage}
45 |       data-status={status}
46 |     >
47 |       Tool: {toolName} ({state})
48 |     </div>
49 |   ),
50 | }));
51 | 
52 | jest.mock('../../components/web-search-suggestion', () => ({
53 |   WebSearchSuggestion: ({ messageId, hasWebSearchResults }: any) => (
54 |     <div 
55 |       data-testid="web-search-suggestion"
56 |       data-message-id={messageId}
57 |       data-has-results={hasWebSearchResults}
58 |     >
59 |       Web Search Suggestion
60 |     </div>
61 |   ),
62 | }));
63 | 
64 | jest.mock('../../components/image-modal', () => ({
65 |   ImageModal: ({ isOpen, onClose, imageUrl, metadata, detail }: any) => (
66 |     <div 
67 |       data-testid="image-modal"
68 |       data-is-open={isOpen}
69 |       data-image-url={imageUrl}
70 |       onClick={onClose}
71 |     >
72 |       Image Modal
73 |       {metadata && <div data-testid="modal-metadata">{metadata.filename}</div>}
74 |       {detail && <div data-testid="modal-detail">{detail}</div>}
75 |     </div>
76 |   ),
77 | }));
78 | 
79 | jest.mock('../../components/icons', () => ({
80 |   SpinnerIcon: () => <div data-testid="spinner-icon">Spinner</div>,
81 | }));
82 | 
83 | jest.mock('lucide-react', () => ({
84 |   ChevronDownIcon: ({ className }: any) => <div className={className} data-testid="chevron-down">↓</div>,
85 |   ChevronUpIcon: ({ className }: any) => <div className={className} data-testid="chevron-up">↑</div>,
86 |   LightbulbIcon: ({ className }: any) => <div className={className} data-testid="lightbulb">💡</div>,
87 |   BrainIcon: ({ className }: any) => <div className={className} data-testid="brain">🧠</div>,
88 | }));
89 | 
90 | jest.mock('motion/react', () => ({
91 |   motion: {
92 |     div: ({ children, className, initial, animate, exit, transition, ...props }: any) => (
93 |       <div className={className} {...props}>
94 |         {children}
95 |       </div>
96 |     ),
97 |   },
98 |   AnimatePresence: ({ children }: { children: React.ReactNode }) => <>{children}</>,
99 | }));
100 | 
101 | jest.mock('@/lib/image-utils', () => ({
102 |   formatFileSize: (size: number) => `${(size / 1024).toFixed(1)}KB`,
103 | }));
104 | 
105 | describe('Message', () => {
106 |   // Test data
107 |   const baseMessage: TMessage = {
108 |     id: 'test-message-1',
109 |     role: 'assistant',
110 |     content: 'Test message content',
111 |     createdAt: new Date(),
112 |   };
113 | 
114 |   const textPart = {
115 |     type: 'text' as const,
116 |     text: 'Hello world',
117 |   };
118 | 
119 |   const textPartWithCitations = {
120 |     type: 'text' as const,
121 |     text: 'Hello with citations',
122 |     citations: [
123 |       { title: 'Source 1', url: 'https://example.com/1' },
124 |       { title: 'Source 2', url: 'https://example.com/2' },
125 |     ],
126 |   };
127 | 
128 |   const toolInvocationPart = {
129 |     type: 'tool-invocation' as const,
130 |     toolInvocation: {
131 |       toolName: 'web_search',
132 |       state: 'result',
133 |       args: { query: 'test query' },
134 |       result: { results: [] },
135 |     },
136 |   };
137 | 
138 |   const imagePart = {
139 |     type: 'image_url' as const,
140 |     image_url: {
141 |       url: 'data:image/png;base64,test-image-data',
142 |       detail: 'high',
143 |     },
144 |     metadata: {
145 |       filename: 'test-image.png',
146 |       size: 2048,
147 |       width: 100,
148 |       height: 100,
149 |     },
150 |   };
151 | 
152 |   const reasoningPart = {
153 |     type: 'reasoning' as const,
154 |     details: [
155 |       { type: 'text' as const, text: 'First thought process' },
156 |       { type: 'text' as const, text: 'Second thought process' },
157 |     ],
158 |   };
159 | 
160 |   beforeEach(() => {
161 |     jest.clearAllMocks();
162 |   });
163 | 
164 |   describe('Basic Rendering and Props', () => {
165 |     test('renders assistant message with text content', () => {
166 |       const message = {
167 |         ...baseMessage,
168 |         parts: [textPart],
169 |       };
170 | 
171 |       render(
172 |         <Message 
173 |           message={message}
174 |           isLoading={false}
175 |           status="ready"
176 |           isLatestMessage={false}
177 |         />
178 |       );
179 | 
180 |       expect(screen.getByTestId('markdown')).toBeInTheDocument();
181 |       expect(screen.getByTestId('markdown')).toHaveTextContent('Hello world');
182 |       expect(screen.getByTestId('copy-button')).toBeInTheDocument();
183 |     });
184 | 
185 |     test('renders user message with different styling', () => {
186 |       const message = {
187 |         ...baseMessage,
188 |         role: 'user' as const,
189 |         parts: [textPart],
190 |       };
191 | 
192 |       render(
193 |         <Message 
194 |           message={message}
195 |           isLoading={false}
196 |           status="ready"
197 |           isLatestMessage={false}
198 |         />
199 |       );
200 | 
201 |       const messageElement = screen.getByTestId('markdown').closest('[data-role="user"]');
202 |       expect(messageElement).toBeInTheDocument();
203 |     });
204 | 
205 |     test('renders without parts array', () => {
206 |       const message = {
207 |         ...baseMessage,
208 |         parts: undefined,
209 |       };
210 | 
211 |       render(
212 |         <Message 
213 |           message={message}
214 |           isLoading={false}
215 |           status="ready"
216 |           isLatestMessage={false}
217 |         />
218 |       );
219 | 
220 |       expect(screen.queryByTestId('markdown')).not.toBeInTheDocument();
221 |     });
222 | 
223 |     test('renders with empty parts array', () => {
224 |       const message = {
225 |         ...baseMessage,
226 |         parts: [],
227 |       };
228 | 
229 |       render(
230 |         <Message 
231 |           message={message}
232 |           isLoading={false}
233 |           status="ready"
234 |           isLatestMessage={false}
235 |         />
236 |       );
237 | 
238 |       expect(screen.queryByTestId('markdown')).not.toBeInTheDocument();
239 |     });
240 | 
241 |     test('handles different message statuses', () => {
242 |       const message = {
243 |         ...baseMessage,
244 |         parts: [textPart],
245 |       };
246 | 
247 |       const { rerender } = render(
248 |         <Message 
249 |           message={message}
250 |           isLoading={false}
251 |           status="streaming"
252 |           isLatestMessage={true}
253 |         />
254 |       );
255 | 
256 |       // Copy button should not show when streaming latest message
257 |       expect(screen.queryByTestId('copy-button')).not.toBeInTheDocument();
258 | 
259 |       rerender(
260 |         <Message 
261 |           message={message}
262 |           isLoading={false}
263 |           status="ready"
264 |           isLatestMessage={true}
265 |         />
266 |       );
267 | 
268 |       // Copy button should show when ready
269 |       expect(screen.getByTestId('copy-button')).toBeInTheDocument();
270 |     });
271 |   });
272 | 
273 |   describe('Message Parts Rendering', () => {
274 |     test('renders text parts with citations', () => {
275 |       const message = {
276 |         ...baseMessage,
277 |         parts: [textPartWithCitations],
278 |       };
279 | 
280 |       render(
281 |         <Message 
282 |           message={message}
283 |           isLoading={false}
284 |           status="ready"
285 |           isLatestMessage={false}
286 |         />
287 |       );
288 | 
289 |       expect(screen.getByTestId('markdown')).toHaveTextContent('Hello with citations');
290 |       expect(screen.getByTestId('citations')).toBeInTheDocument();
291 |       expect(screen.getByTestId('citation-0')).toHaveTextContent('Source 1');
292 |       expect(screen.getByTestId('citation-1')).toHaveTextContent('Source 2');
293 |     });
294 | 
295 |     test('renders tool invocation parts', () => {
296 |       const message = {
297 |         ...baseMessage,
298 |         parts: [toolInvocationPart],
299 |       };
300 | 
301 |       render(
302 |         <Message 
303 |           message={message}
304 |           isLoading={false}
305 |           status="ready"
306 |           isLatestMessage={false}
307 |         />
308 |       );
309 | 
310 |       const toolInvocation = screen.getByTestId('tool-invocation');
311 |       expect(toolInvocation).toBeInTheDocument();
312 |       expect(toolInvocation).toHaveAttribute('data-tool-name', 'web_search');
313 |       expect(toolInvocation).toHaveAttribute('data-state', 'result');
314 |       expect(toolInvocation).toHaveTextContent('Tool: web_search (result)');
315 |     });
316 | 
317 |     test('renders image parts with metadata', () => {
318 |       const message = {
319 |         ...baseMessage,
320 |         parts: [imagePart],
321 |       };
322 | 
323 |       render(
324 |         <Message 
325 |           message={message}
326 |           isLoading={false}
327 |           status="ready"
328 |           isLatestMessage={false}
329 |         />
330 |       );
331 | 
332 |       const image = screen.getByRole('img');
333 |       expect(image).toBeInTheDocument();
334 |       expect(image).toHaveAttribute('src', 'data:image/png;base64,test-image-data');
335 |       expect(image).toHaveAttribute('alt', 'test-image.png');
336 | 
337 |       // Check metadata display - target the specific metadata div
338 |       const metadataElement = screen.getByText((content, element) => {
339 |         return element?.classList?.contains('text-xs') && 
340 |                element?.textContent?.includes('test-image.png') || false;
341 |       });
342 |       expect(metadataElement).toBeInTheDocument();
343 |       expect(metadataElement.textContent).toContain('test-image.png');
344 |       expect(metadataElement.textContent).toContain('2.0KB');
345 |       expect(metadataElement.textContent).toContain('100×100');
346 |       expect(metadataElement.textContent).toContain('high quality');
347 |     });
348 | 
349 |     test('renders reasoning parts when not actively reasoning', () => {
350 |       const message = {
351 |         ...baseMessage,
352 |         parts: [reasoningPart],
353 |       };
354 | 
355 |       render(
356 |         <Message 
357 |           message={message}
358 |           isLoading={false}
359 |           status="ready"
360 |           isLatestMessage={false}
361 |         />
362 |       );
363 | 
364 |       expect(screen.getByRole('button', { name: /reasoning/i })).toBeInTheDocument();
365 |       expect(screen.getByText(/click to view/i)).toBeInTheDocument();
366 |       expect(screen.getByTestId('chevron-up')).toBeInTheDocument();
367 |     });
368 | 
369 |     test('renders multiple parts in correct order', () => {
370 |       const message = {
371 |         ...baseMessage,
372 |         parts: [textPart, toolInvocationPart, reasoningPart],
373 |       };
374 | 
375 |       render(
376 |         <Message 
377 |           message={message}
378 |           isLoading={false}
379 |           status="ready"
380 |           isLatestMessage={false}
381 |         />
382 |       );
383 | 
384 |       expect(screen.getByTestId('markdown')).toBeInTheDocument();
385 |       expect(screen.getByTestId('tool-invocation')).toBeInTheDocument();
386 |       expect(screen.getByRole('button', { name: /reasoning/i })).toBeInTheDocument();
387 |     });
388 |   });
389 | 
390 |   describe('User Interactions', () => {
391 |     test('copy button copies message text', () => {
392 |       const message = {
393 |         ...baseMessage,
394 |         parts: [textPart, { type: 'text' as const, text: 'Second part' }],
395 |       };
396 | 
397 |       render(
398 |         <Message 
399 |           message={message}
400 |           isLoading={false}
401 |           status="ready"
402 |           isLatestMessage={false}
403 |         />
404 |       );
405 | 
406 |       const copyButton = screen.getByTestId('copy-button');
407 |       expect(copyButton).toHaveAttribute('data-text', 'Hello world\n\nSecond part');
408 |     });
409 | 
410 |     test('image click opens modal', () => {
411 |       const message = {
412 |         ...baseMessage,
413 |         parts: [imagePart],
414 |       };
415 | 
416 |       render(
417 |         <Message 
418 |           message={message}
419 |           isLoading={false}
420 |           status="ready"
421 |           isLatestMessage={false}
422 |         />
423 |       );
424 | 
425 |       const image = screen.getByRole('img');
426 |       fireEvent.click(image);
427 | 
428 |       const modal = screen.getByTestId('image-modal');
429 |       expect(modal).toBeInTheDocument();
430 |       expect(modal).toHaveAttribute('data-is-open', 'true');
431 |       expect(modal).toHaveAttribute('data-image-url', 'data:image/png;base64,test-image-data');
432 |       expect(screen.getByTestId('modal-metadata')).toHaveTextContent('test-image.png');
433 |       expect(screen.getByTestId('modal-detail')).toHaveTextContent('high');
434 |     });
435 | 
436 |     test('image modal can be closed', () => {
437 |       const message = {
438 |         ...baseMessage,
439 |         parts: [imagePart],
440 |       };
441 | 
442 |       render(
443 |         <Message 
444 |           message={message}
445 |           isLoading={false}
446 |           status="ready"
447 |           isLatestMessage={false}
448 |         />
449 |       );
450 | 
451 |       // Open modal
452 |       fireEvent.click(screen.getByRole('img'));
453 |       expect(screen.getByTestId('image-modal')).toBeInTheDocument();
454 | 
455 |       // Close modal
456 |       fireEvent.click(screen.getByTestId('image-modal'));
457 |       expect(screen.queryByTestId('image-modal')).not.toBeInTheDocument();
458 |     });
459 | 
460 |     test('copy button appears in correct position for user messages', () => {
461 |       const message = {
462 |         ...baseMessage,
463 |         role: 'user' as const,
464 |         parts: [textPart],
465 |       };
466 | 
467 |       render(
468 |         <Message 
469 |           message={message}
470 |           isLoading={false}
471 |           status="ready"
472 |           isLatestMessage={false}
473 |         />
474 |       );
475 | 
476 |       const copyButton = screen.getByTestId('copy-button');
477 |       expect(copyButton).toBeInTheDocument();
478 |       expect(copyButton).toHaveClass('ml-auto');
479 |     });
480 |   });
481 | 
482 |   describe('Web Search Integration', () => {
483 |     test('displays web search suggestion when message has web search results', () => {
484 |       const message = {
485 |         ...baseMessage,
486 |         hasWebSearch: true,
487 |         parts: [textPart],
488 |       };
489 | 
490 |       render(
491 |         <Message 
492 |           message={message}
493 |           isLoading={false}
494 |           status="ready"
495 |           isLatestMessage={false}
496 |         />
497 |       );
498 | 
499 |       const webSearchSuggestion = screen.getByTestId('web-search-suggestion');
500 |       expect(webSearchSuggestion).toBeInTheDocument();
501 |       expect(webSearchSuggestion).toHaveAttribute('data-message-id', 'test-message-1');
502 |       expect(webSearchSuggestion).toHaveAttribute('data-has-results', 'true');
503 |     });
504 | 
505 |     test('detects web search results from tool invocation', () => {
506 |       const message = {
507 |         ...baseMessage,
508 |         parts: [toolInvocationPart],
509 |       };
510 | 
511 |       render(
512 |         <Message 
513 |           message={message}
514 |           isLoading={false}
515 |           status="ready"
516 |           isLatestMessage={false}
517 |         />
518 |       );
519 | 
520 |       expect(screen.getByTestId('web-search-suggestion')).toBeInTheDocument();
521 |     });
522 | 
523 |     test('detects web search results from citations', () => {
524 |       const message = {
525 |         ...baseMessage,
526 |         parts: [textPartWithCitations],
527 |       };
528 | 
529 |       render(
530 |         <Message 
531 |           message={message}
532 |           isLoading={false}
533 |           status="ready"
534 |           isLatestMessage={false}
535 |         />
536 |       );
537 | 
538 |       expect(screen.getByTestId('web-search-suggestion')).toBeInTheDocument();
539 |     });
540 | 
541 |     test('does not show web search suggestion when streaming', () => {
542 |       const message = {
543 |         ...baseMessage,
544 |         hasWebSearch: true,
545 |         parts: [textPart],
546 |       };
547 | 
548 |       render(
549 |         <Message 
550 |           message={message}
551 |           isLoading={false}
552 |           status="streaming"
553 |           isLatestMessage={true}
554 |         />
555 |       );
556 | 
557 |       expect(screen.queryByTestId('web-search-suggestion')).not.toBeInTheDocument();
558 |     });
559 | 
560 |     test('does not show web search suggestion for user messages', () => {
561 |       const message = {
562 |         ...baseMessage,
563 |         role: 'user' as const,
564 |         hasWebSearch: true,
565 |         parts: [textPart],
566 |       };
567 | 
568 |       render(
569 |         <Message 
570 |           message={message}
571 |           isLoading={false}
572 |           status="ready"
573 |           isLatestMessage={false}
574 |         />
575 |       );
576 | 
577 |       expect(screen.queryByTestId('web-search-suggestion')).not.toBeInTheDocument();
578 |     });
579 |   });
580 | 
581 |   describe('Copy Button Visibility Logic', () => {
582 |     test('shows copy button for assistant messages when not streaming', () => {
583 |       const message = {
584 |         ...baseMessage,
585 |         role: 'assistant' as const,
586 |         parts: [textPart],
587 |       };
588 | 
589 |       render(
590 |         <Message 
591 |           message={message}
592 |           isLoading={false}
593 |           status="ready"
594 |           isLatestMessage={false}
595 |         />
596 |       );
597 | 
598 |       expect(screen.getByTestId('copy-button')).toBeInTheDocument();
599 |     });
600 | 
601 |     test('shows copy button for user messages when not streaming', () => {
602 |       const message = {
603 |         ...baseMessage,
604 |         role: 'user' as const,
605 |         parts: [textPart],
606 |       };
607 | 
608 |       render(
609 |         <Message 
610 |           message={message}
611 |           isLoading={false}
612 |           status="ready"
613 |           isLatestMessage={false}
614 |         />
615 |       );
616 | 
617 |       expect(screen.getByTestId('copy-button')).toBeInTheDocument();
618 |     });
619 | 
620 |     test('hides copy button when streaming latest message', () => {
621 |       const message = {
622 |         ...baseMessage,
623 |         parts: [textPart],
624 |       };
625 | 
626 |       render(
627 |         <Message 
628 |           message={message}
629 |           isLoading={false}
630 |           status="streaming"
631 |           isLatestMessage={true}
632 |         />
633 |       );
634 | 
635 |       expect(screen.queryByTestId('copy-button')).not.toBeInTheDocument();
636 |     });
637 | 
638 |     test('shows copy button when streaming non-latest message', () => {
639 |       const message = {
640 |         ...baseMessage,
641 |         parts: [textPart],
642 |       };
643 | 
644 |       render(
645 |         <Message 
646 |           message={message}
647 |           isLoading={false}
648 |           status="streaming"
649 |           isLatestMessage={false}
650 |         />
651 |       );
652 | 
653 |       expect(screen.getByTestId('copy-button')).toBeInTheDocument();
654 |     });
655 |   });
656 | 
657 |   describe('Error Handling', () => {
658 |     test('handles missing image metadata gracefully', () => {
659 |       const imagePartWithoutMetadata = {
660 |         type: 'image_url' as const,
661 |         image_url: {
662 |           url: 'data:image/png;base64,test-image-data',
663 |         },
664 |       };
665 | 
666 |       const message = {
667 |         ...baseMessage,
668 |         parts: [imagePartWithoutMetadata],
669 |       };
670 | 
671 |       render(
672 |         <Message 
673 |           message={message}
674 |           isLoading={false}
675 |           status="ready"
676 |           isLatestMessage={false}
677 |         />
678 |       );
679 | 
680 |       const image = screen.getByRole('img');
681 |       expect(image).toBeInTheDocument();
682 |       expect(image).toHaveAttribute('alt', 'Uploaded image');
683 |     });
684 | 
685 |     test('handles unknown part types gracefully', () => {
686 |       const unknownPart = {
687 |         type: 'unknown' as any,
688 |         data: 'some data',
689 |       };
690 | 
691 |       const message = {
692 |         ...baseMessage,
693 |         parts: [textPart, unknownPart],
694 |       };
695 | 
696 |       render(
697 |         <Message 
698 |           message={message}
699 |           isLoading={false}
700 |           status="ready"
701 |           isLatestMessage={false}
702 |         />
703 |       );
704 | 
705 |       // Should still render the text part
[TRUNCATED]
```

__tests__/components/messages.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen } from '@testing-library/react';
3 | import { Messages } from '../../components/messages';
4 | import type { Message as TMessage } from 'ai';
5 | 
6 | // Mock the useScrollToBottom hook
7 | const mockContainerRef = { current: null };
8 | const mockEndRef = { current: null };
9 | jest.mock('../../lib/hooks/use-scroll-to-bottom', () => ({
10 |   useScrollToBottom: jest.fn(() => [mockContainerRef, mockEndRef]),
11 | }));
12 | 
13 | // Mock the Message component
14 | jest.mock('../../components/message', () => ({
15 |   Message: ({ message, isLatestMessage, isLoading, status }: any) => (
16 |     <div 
17 |       data-testid={`message-${message.id}`}
18 |       data-is-latest={isLatestMessage.toString()}
19 |       data-is-loading={isLoading.toString()}
20 |       data-status={status}
21 |     >
22 |       <div data-testid="message-content">{message.content}</div>
23 |       {message.hasWebSearch && <div data-testid="web-search-indicator">Web Search</div>}
24 |     </div>
25 |   ),
26 | }));
27 | 
28 | describe('Messages Component', () => {
29 |   const mockMessages: (TMessage & { hasWebSearch?: boolean })[] = [
30 |     {
31 |       id: '1',
32 |       role: 'user',
33 |       content: 'Hello, how are you?',
34 |     },
35 |     {
36 |       id: '2',
37 |       role: 'assistant',
38 |       content: 'I am doing well, thank you!',
39 |     },
40 |     {
41 |       id: '3',
42 |       role: 'user',
43 |       content: 'Can you search for information about React?',
44 |       hasWebSearch: true,
45 |     },
46 |   ];
47 | 
48 |   const defaultProps = {
49 |     messages: mockMessages,
50 |     isLoading: false,
51 |     status: 'ready' as const,
52 |   };
53 | 
54 |   beforeEach(() => {
55 |     jest.clearAllMocks();
56 |   });
57 | 
58 |   describe('Basic Rendering', () => {
59 |     test('renders without crashing', () => {
60 |       const { container } = render(<Messages {...defaultProps} />);
61 |       const scrollContainer = container.querySelector('.h-full.overflow-y-auto.no-scrollbar');
62 |       expect(scrollContainer).toBeInTheDocument();
63 |     });
64 | 
65 |     test('renders with empty messages array', () => {
66 |       const { container } = render(<Messages {...defaultProps} messages={[]} />);
67 |       const scrollContainer = container.querySelector('.h-full.overflow-y-auto.no-scrollbar');
68 |       expect(scrollContainer).toBeInTheDocument();
69 |       expect(screen.queryByTestId('message-content')).not.toBeInTheDocument();
70 |     });
71 | 
72 |     test('applies correct CSS classes to container', () => {
73 |       const { container } = render(<Messages {...defaultProps} />);
74 |       const scrollContainer = container.firstChild as HTMLElement;
75 |       expect(scrollContainer).toHaveClass('h-full', 'overflow-y-auto', 'no-scrollbar');
76 |     });
77 | 
78 |     test('applies correct CSS classes to inner container', () => {
79 |       const { container } = render(<Messages {...defaultProps} />);
80 |       const innerContainer = container.querySelector('.max-w-lg');
81 |       expect(innerContainer).toHaveClass('max-w-lg', 'sm:max-w-3xl', 'mx-auto', 'py-4');
82 |     });
83 | 
84 |     test('renders scroll-to-bottom element', () => {
85 |       const { container } = render(<Messages {...defaultProps} />);
86 |       const scrollElement = container.querySelector('.h-1');
87 |       expect(scrollElement).toBeInTheDocument();
88 |       expect(scrollElement).toHaveClass('h-1');
89 |     });
90 |   });
91 | 
92 |   describe('Messages Rendering', () => {
93 |     test('renders all messages in the messages array', () => {
94 |       render(<Messages {...defaultProps} />);
95 |       
96 |       expect(screen.getByTestId('message-1')).toBeInTheDocument();
97 |       expect(screen.getByTestId('message-2')).toBeInTheDocument();
98 |       expect(screen.getByTestId('message-3')).toBeInTheDocument();
99 |     });
100 | 
101 |     test('passes correct content to each Message component', () => {
102 |       render(<Messages {...defaultProps} />);
103 |       
104 |       expect(screen.getByText('Hello, how are you?')).toBeInTheDocument();
105 |       expect(screen.getByText('I am doing well, thank you!')).toBeInTheDocument();
106 |       expect(screen.getByText('Can you search for information about React?')).toBeInTheDocument();
107 |     });
108 | 
109 |     test('identifies the latest message correctly', () => {
110 |       render(<Messages {...defaultProps} />);
111 |       
112 |       expect(screen.getByTestId('message-1')).toHaveAttribute('data-is-latest', 'false');
113 |       expect(screen.getByTestId('message-2')).toHaveAttribute('data-is-latest', 'false');
114 |       expect(screen.getByTestId('message-3')).toHaveAttribute('data-is-latest', 'true');
115 |     });
116 | 
117 |     test('handles messages with web search correctly', () => {
118 |       render(<Messages {...defaultProps} />);
119 |       
120 |       expect(screen.getByTestId('web-search-indicator')).toBeInTheDocument();
121 |       expect(screen.getByText('Web Search')).toBeInTheDocument();
122 |     });
123 | 
124 |     test('handles messages without web search correctly', () => {
125 |       const messagesWithoutWebSearch = [
126 |         {
127 |           id: '1',
128 |           role: 'user' as const,
129 |           content: 'Simple message',
130 |         },
131 |       ];
132 |       
133 |       render(<Messages {...defaultProps} messages={messagesWithoutWebSearch} />);
134 |       
135 |       expect(screen.queryByTestId('web-search-indicator')).not.toBeInTheDocument();
136 |     });
137 |   });
138 | 
139 |   describe('Props Handling', () => {
140 |     test('passes isLoading prop to Message components', () => {
141 |       render(<Messages {...defaultProps} isLoading={true} />);
142 |       
143 |       const messages = screen.getAllByTestId(/^message-[0-9]+$/);
144 |       messages.forEach(message => {
145 |         expect(message).toHaveAttribute('data-is-loading', 'true');
146 |       });
147 |     });
148 | 
149 |     test('passes status prop to Message components', () => {
150 |       const statuses: Array<'error' | 'submitted' | 'streaming' | 'ready'> = [
151 |         'error',
152 |         'submitted', 
153 |         'streaming',
154 |         'ready'
155 |       ];
156 | 
157 |       statuses.forEach(status => {
158 |         const { unmount } = render(<Messages {...defaultProps} status={status} />);
159 |         
160 |         const messages = screen.getAllByTestId(/^message-[0-9]+$/);
161 |         messages.forEach(message => {
162 |           expect(message).toHaveAttribute('data-status', status);
163 |         });
164 |         
165 |         unmount();
166 |       });
167 |     });
168 | 
169 |     test('handles single message correctly', () => {
170 |       const singleMessage = [mockMessages[0]];
171 |       render(<Messages {...defaultProps} messages={singleMessage} />);
172 |       
173 |       expect(screen.getByTestId('message-1')).toBeInTheDocument();
174 |       expect(screen.getByTestId('message-1')).toHaveAttribute('data-is-latest', 'true');
175 |       expect(screen.queryByTestId('message-2')).not.toBeInTheDocument();
176 |     });
177 |   });
178 | 
179 |   describe('State Combinations', () => {
180 |     test('handles loading state with empty messages', () => {
181 |       const { container } = render(<Messages {...defaultProps} messages={[]} isLoading={true} />);
182 |       
183 |       const scrollContainer = container.querySelector('.h-full.overflow-y-auto.no-scrollbar');
184 |       expect(scrollContainer).toBeInTheDocument();
185 |       expect(screen.queryByTestId('message-content')).not.toBeInTheDocument();
186 |     });
187 | 
188 |     test('handles error status with messages', () => {
189 |       render(<Messages {...defaultProps} status="error" />);
190 |       
191 |       const messages = screen.getAllByTestId(/^message-[0-9]+$/);
192 |       messages.forEach(message => {
193 |         expect(message).toHaveAttribute('data-status', 'error');
194 |       });
195 |     });
196 | 
197 |     test('handles streaming status with loading', () => {
198 |       render(<Messages {...defaultProps} status="streaming" isLoading={true} />);
199 |       
200 |       const messages = screen.getAllByTestId(/^message-[0-9]+$/);
201 |       messages.forEach(message => {
202 |         expect(message).toHaveAttribute('data-status', 'streaming');
203 |         expect(message).toHaveAttribute('data-is-loading', 'true');
204 |       });
205 |     });
206 |   });
207 | 
208 |   describe('Hook Integration', () => {
209 |     test('calls useScrollToBottom hook', () => {
210 |       const { useScrollToBottom } = require('../../lib/hooks/use-scroll-to-bottom');
211 |       render(<Messages {...defaultProps} />);
212 |       
213 |       expect(useScrollToBottom).toHaveBeenCalledTimes(1);
214 |     });
215 | 
216 |     test('uses refs from useScrollToBottom hook', () => {
217 |       const { container } = render(<Messages {...defaultProps} />);
218 |       
219 |       // The hook should return refs that get attached to elements
220 |       const scrollContainer = container.firstChild as HTMLElement;
221 |       const scrollElement = container.querySelector('.h-1') as HTMLElement;
222 |       
223 |       expect(scrollContainer).toBeInTheDocument();
224 |       expect(scrollElement).toBeInTheDocument();
225 |     });
226 |   });
227 | 
228 |   describe('Edge Cases', () => {
229 |     test('handles messages with undefined hasWebSearch property', () => {
230 |       const messagesWithUndefinedWebSearch = [
231 |         {
232 |           id: '1',
233 |           role: 'user' as const,
234 |           content: 'Message without explicit webSearch property',
235 |           // hasWebSearch is undefined
236 |         },
237 |       ];
238 |       
239 |       render(<Messages {...defaultProps} messages={messagesWithUndefinedWebSearch} />);
240 |       
241 |       expect(screen.getByTestId('message-1')).toBeInTheDocument();
242 |       expect(screen.queryByTestId('web-search-indicator')).not.toBeInTheDocument();
243 |     });
244 | 
245 |     test('handles very long messages array', () => {
246 |       const longMessagesList = Array(100).fill(null).map((_, index) => ({
247 |         id: `msg-${index}`,
248 |         role: (index % 2 === 0 ? 'user' : 'assistant') as const,
249 |         content: `Message number ${index}`,
250 |       }));
251 |       
252 |       render(<Messages {...defaultProps} messages={longMessagesList} />);
253 |       
254 |       // Should render all messages
255 |       expect(screen.getAllByTestId(/^message-msg-[0-9]+$/)).toHaveLength(100);
256 |       
257 |       // Last message should be marked as latest
258 |       expect(screen.getByTestId('message-msg-99')).toHaveAttribute('data-is-latest', 'true');
259 |     });
260 | 
261 |     test('handles messages with special characters in content', () => {
262 |       const specialCharMessages = [
263 |         {
264 |           id: '1',
265 |           role: 'user' as const,
266 |           content: 'Special chars: @#$%^&*()_+{}|:"<>?[];,./`~',
267 |         },
268 |       ];
269 |       
270 |       render(<Messages {...defaultProps} messages={specialCharMessages} />);
271 |       
272 |       expect(screen.getByText('Special chars: @#$%^&*()_+{}|:"<>?[];,./`~')).toBeInTheDocument();
273 |     });
274 | 
275 |     test('preserves message order', () => {
276 |       render(<Messages {...defaultProps} />);
277 |       
278 |       const messageElements = screen.getAllByTestId(/^message-[0-9]+$/);
279 |       expect(messageElements[0]).toHaveAttribute('data-testid', 'message-1');
280 |       expect(messageElements[1]).toHaveAttribute('data-testid', 'message-2');
281 |       expect(messageElements[2]).toHaveAttribute('data-testid', 'message-3');
282 |     });
283 |   });
284 | 
285 |   describe('Accessibility', () => {
286 |     test('container has proper semantic structure', () => {
287 |       const { container } = render(<Messages {...defaultProps} />);
288 |       const scrollContainer = container.firstChild as HTMLElement;
289 |       
290 |       // Should be a generic container (div)
291 |       expect(scrollContainer.tagName).toBe('DIV');
292 |     });
293 | 
294 |     test('maintains focus management with scroll container', () => {
295 |       const { container } = render(<Messages {...defaultProps} />);
296 |       const scrollContainer = container.firstChild as HTMLElement;
297 |       
298 |       // Should have overflow settings for keyboard navigation
299 |       expect(scrollContainer).toHaveClass('overflow-y-auto');
300 |     });
301 | 
302 |     test('provides scrollable region for screen readers', () => {
303 |       const { container } = render(<Messages {...defaultProps} />);
304 |       const scrollContainer = container.firstChild as HTMLElement;
305 |       
306 |       // Container should be focusable for screen readers to navigate scrollable content
307 |       expect(scrollContainer).toHaveClass('overflow-y-auto');
308 |     });
309 |   });
310 | 
311 |   describe('Integration Tests', () => {
312 |     test('complete message rendering workflow', () => {
313 |       // Start with no messages
314 |       const { rerender } = render(<Messages {...defaultProps} messages={[]} isLoading={true} status="streaming" />);
315 |       
316 |       expect(screen.queryByTestId('message-content')).not.toBeInTheDocument();
317 |       
318 |       // Add first message
319 |       const firstMessage = [{
320 |         id: '1',
321 |         role: 'user' as const,
322 |         content: 'Initial message',
323 |       }];
324 |       
325 |       rerender(<Messages {...defaultProps} messages={firstMessage} isLoading={true} status="streaming" />);
326 |       
327 |       expect(screen.getByTestId('message-1')).toBeInTheDocument();
328 |       expect(screen.getByText('Initial message')).toBeInTheDocument();
329 |       expect(screen.getByTestId('message-1')).toHaveAttribute('data-is-latest', 'true');
330 |       
331 |       // Add response message
332 |       const withResponse = [
333 |         ...firstMessage,
334 |         {
335 |           id: '2',
336 |           role: 'assistant' as const,
337 |           content: 'Assistant response',
338 |         }
339 |       ];
340 |       
341 |       rerender(<Messages {...defaultProps} messages={withResponse} isLoading={false} status="ready" />);
342 |       
343 |       expect(screen.getByTestId('message-1')).toHaveAttribute('data-is-latest', 'false');
344 |       expect(screen.getByTestId('message-2')).toHaveAttribute('data-is-latest', 'true');
345 |       expect(screen.getByTestId('message-2')).toHaveAttribute('data-is-loading', 'false');
346 |       expect(screen.getByTestId('message-2')).toHaveAttribute('data-status', 'ready');
347 |     });
348 |   });
349 | });
```

__tests__/components/model-picker.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { ModelPicker } from '../../components/model-picker';
4 | import { ModelInfo } from '@/lib/types/models';
5 | 
6 | // Mock external dependencies that cause ES module issues
7 | jest.mock('better-auth/react', () => ({
8 |   createAuthClient: jest.fn(() => ({
9 |     signIn: jest.fn(),
10 |     signOut: jest.fn(),
11 |     useSession: jest.fn(),
12 |   })),
13 | }));
14 | 
15 | jest.mock('better-auth/client/plugins', () => ({
16 |   anonymousClient: jest.fn(),
17 | }));
18 | 
19 | jest.mock('nanostores', () => ({
20 |   atom: jest.fn(),
21 | }));
22 | 
23 | // Mock scrollIntoView which is not available in JSDOM
24 | Object.defineProperty(Element.prototype, 'scrollIntoView', {
25 |   value: jest.fn(),
26 |   writable: true,
27 | });
28 | 
29 | jest.mock('@/lib/context/model-context');
30 | jest.mock('@/hooks/useCredits');
31 | jest.mock('@/hooks/useAuth');
32 | 
33 | // Mock UI components with proper prop forwarding
34 | jest.mock('../../components/ui/popover', () => ({
35 |   Popover: ({ children, open, onOpenChange }: any) => (
36 |     <div data-testid="popover" data-open={open}>
37 |       <div onClick={() => onOpenChange?.(!open)}>
38 |         {children}
39 |       </div>
40 |     </div>
41 |   ),
42 |   PopoverContent: ({ children, className, align, onMouseLeave }: any) => (
43 |     <div 
44 |       data-testid="popover-content" 
45 |       className={className}
46 |       data-align={align}
47 |       onMouseLeave={onMouseLeave}
48 |     >
49 |       {children}
50 |     </div>
51 |   ),
52 |   PopoverTrigger: ({ children, asChild }: any) => (
53 |     <div data-testid="popover-trigger">{children}</div>
54 |   ),
55 | }));
56 | 
57 | jest.mock('../../components/ui/tooltip', () => ({
58 |   TooltipProvider: ({ children }: any) => <div data-testid="tooltip-provider">{children}</div>,
59 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
60 |   TooltipTrigger: ({ children, asChild }: any) => (
61 |     <div data-testid="tooltip-trigger">{children}</div>
62 |   ),
63 |   TooltipContent: ({ children, side, className }: any) => (
64 |     <div data-testid="tooltip-content" data-side={side} className={className}>
65 |       {children}
66 |     </div>
67 |   ),
68 | }));
69 | 
70 | jest.mock('../../components/ui/input', () => ({
71 |   Input: ({ id, type, value, onChange, onKeyDown, placeholder, className, ...props }: any) => (
72 |     <input
73 |       id={id}
74 |       type={type}
75 |       value={value}
76 |       onChange={onChange}
77 |       onKeyDown={onKeyDown}
78 |       placeholder={placeholder}
79 |       className={className}
80 |       data-testid={`input-${type || 'text'}`}
81 |       {...props}
82 |     />
83 |   ),
84 | }));
85 | 
86 | jest.mock('../../components/ui/button', () => ({
87 |   Button: ({ children, onClick, variant, size, className, disabled, title, role, ...props }: any) => (
88 |     <button
89 |       onClick={onClick}
90 |       className={className}
91 |       disabled={disabled}
92 |       title={title}
93 |       role={role}
94 |       data-variant={variant}
95 |       data-size={size}
96 |       data-testid={`button-${variant || 'default'}`}
97 |       {...props}
98 |     >
99 |       {children}
100 |     </button>
101 |   ),
102 | }));
103 | 
104 | jest.mock('../../components/favorite-toggle', () => ({
105 |   FavoriteToggle: ({ modelId, isFavorite, size, disabled, className }: any) => (
106 |     <button
107 |       data-testid={`favorite-toggle-${modelId}`}
108 |       data-favorite={isFavorite}
109 |       data-size={size}
110 |       disabled={disabled}
111 |       className={className}
112 |     >
113 |       ⭐
114 |     </button>
115 |   ),
116 | }));
117 | 
118 | describe('ModelPicker', () => {
119 |   // Mock data
120 |   const mockModels: ModelInfo[] = [
121 |     {
122 |       id: 'gpt-4',
123 |       name: 'GPT-4',
124 |       provider: 'OpenAI',
125 |       capabilities: ['reasoning', 'coding'],
126 |       premium: false,
127 |       vision: false,
128 |       contextMax: 8192,
129 |       pricing: { input: 0.00003, output: 0.00006 },
130 |       description: 'Advanced reasoning model',
131 |       apiVersion: 'v1',
132 |       isFavorite: false,
133 |     },
134 |     {
135 |       id: 'claude-3-opus',
136 |       name: 'Claude 3 Opus',
137 |       provider: 'Anthropic',
138 |       capabilities: ['reasoning', 'vision', 'creative'],
139 |       premium: true,
140 |       vision: true,
141 |       contextMax: 200000,
142 |       pricing: { input: 0.000015, output: 0.000075 },
143 |       description: 'Most capable Claude model',
144 |       apiVersion: 'v1',
145 |       isFavorite: true,
146 |     },
147 |     {
148 |       id: 'grok-2',
149 |       name: 'Grok 2',
150 |       provider: 'xAI',
151 |       capabilities: ['fast', 'creative'],
152 |       premium: false,
153 |       vision: false,
154 |       contextMax: 32768,
155 |       pricing: { input: 0.000002, output: 0.000010 },
156 |       description: 'Fast and creative model',
157 |       apiVersion: 'v1',
158 |       isFavorite: true,
159 |     },
160 |   ];
161 | 
162 |   const defaultProps = {
163 |     selectedModel: 'gpt-4',
164 |     setSelectedModel: jest.fn(),
165 |     onModelSelected: jest.fn(),
166 |     disabled: false,
167 |   };
168 | 
169 |   // Mock hook implementations
170 |   const mockUseModel = {
171 |     availableModels: mockModels,
172 |     isLoading: false,
173 |     isRefreshing: false,
174 |     error: null,
175 |     refresh: jest.fn(),
176 |     favorites: ['claude-3-opus', 'grok-2'],
177 |     favoriteCount: 2,
178 |   };
179 | 
180 |   const mockUseCredits = {
181 |     canAccessPremiumModels: jest.fn(() => true),
182 |     loading: false,
183 |   };
184 | 
185 |   const mockUseAuth = {
186 |     user: { id: 'user-123', email: 'test@example.com' },
187 |   };
188 | 
189 |   beforeEach(() => {
190 |     jest.clearAllMocks();
191 |     
192 |     // Reset mock implementations
193 |     require('@/lib/context/model-context').useModel.mockReturnValue(mockUseModel);
194 |     require('@/hooks/useCredits').useCredits.mockReturnValue(mockUseCredits);
195 |     require('@/hooks/useAuth').useAuth.mockReturnValue(mockUseAuth);
196 |   });
197 | 
198 |   describe('Basic Rendering and Props', () => {
199 |     test('renders with default props', () => {
200 |       render(<ModelPicker {...defaultProps} />);
201 |       
202 |       expect(screen.getByRole('combobox')).toBeInTheDocument();
203 |       const gpt4Elements = screen.getAllByText('GPT-4');
204 |       expect(gpt4Elements[0]).toBeInTheDocument();
205 |     });
206 | 
207 |     test('displays selected model name and provider icon', () => {
208 |       render(<ModelPicker {...defaultProps} />);
209 |       
210 |       const button = screen.getByRole('combobox');
211 |       expect(button).toHaveTextContent('GPT-4');
212 |       expect(button).toHaveAttribute('aria-expanded', 'false');
213 |     });
214 | 
215 |     test('shows disabled state when disabled prop is true', () => {
216 |       render(<ModelPicker {...defaultProps} disabled={true} />);
217 |       
218 |       const button = screen.getByRole('combobox');
219 |       expect(button).toBeDisabled();
220 |     });
221 | 
222 |     test('displays appropriate tooltip when disabled with preset name', () => {
223 |       render(
224 |         <ModelPicker 
225 |           {...defaultProps} 
226 |           disabled={true} 
227 |           activePresetName="Custom Preset"
228 |         />
229 |       );
230 |       
231 |       const tooltipContent = screen.getByTestId('tooltip-content');
232 |       expect(tooltipContent).toHaveTextContent('Model is controlled by "Custom Preset" preset');
233 |     });
234 | 
235 |     test('displays premium model warning when user lacks credits', () => {
236 |       mockUseCredits.canAccessPremiumModels.mockReturnValue(false);
237 |       
238 |       render(<ModelPicker {...defaultProps} selectedModel="claude-3-opus" />);
239 |       
240 |       const tooltipContents = screen.getAllByTestId('tooltip-content');
241 |       const premiumWarning = tooltipContents.find(tooltip => 
242 |         tooltip.textContent?.includes('This model requires premium access')
243 |       );
244 |       expect(premiumWarning).toBeInTheDocument();
245 |     });
246 |   });
247 | 
248 |   describe('Loading and Error States', () => {
249 |     test('displays loading state when models are loading', () => {
250 |       require('@/lib/context/model-context').useModel.mockReturnValue({
251 |         ...mockUseModel,
252 |         isLoading: true,
253 |       });
254 |       
255 |       render(<ModelPicker {...defaultProps} />);
256 |       
257 |       expect(screen.getByText('Loading models...')).toBeInTheDocument();
258 |       expect(screen.getByRole('button')).toBeDisabled();
259 |     });
260 | 
261 |     test('displays error state when models fail to load', () => {
262 |       require('@/lib/context/model-context').useModel.mockReturnValue({
263 |         ...mockUseModel,
264 |         error: 'Failed to load models',
265 |         availableModels: [],
266 |       });
267 |       
268 |       render(<ModelPicker {...defaultProps} />);
269 |       
270 |       expect(screen.getByText('Error loading models')).toBeInTheDocument();
271 |     });
272 | 
273 |     test('handles refresh when in error state', async () => {
274 |       const mockRefresh = jest.fn();
275 |       require('@/lib/context/model-context').useModel.mockReturnValue({
276 |         ...mockUseModel,
277 |         error: 'Failed to load models',
278 |         refresh: mockRefresh,
279 |         availableModels: [],
280 |       });
281 |       
282 |       render(<ModelPicker {...defaultProps} />);
283 |       
284 |       const errorButton = screen.getByText('Error loading models');
285 |       fireEvent.click(errorButton);
286 |       
287 |       expect(mockRefresh).toHaveBeenCalled();
288 |     });
289 | 
290 |     test('shows refreshing state during model refresh', () => {
291 |       require('@/lib/context/model-context').useModel.mockReturnValue({
292 |         ...mockUseModel,
293 |         isRefreshing: true,
294 |       });
295 |       
296 |       render(<ModelPicker {...defaultProps} />);
297 |       
298 |       fireEvent.click(screen.getByRole('combobox'));
299 |       
300 |       expect(screen.getByTitle('Refreshing models...')).toBeInTheDocument();
301 |     });
302 |   });
303 | 
304 |   describe('User Interactions', () => {
305 |     test('opens popover when button is clicked', () => {
306 |       render(<ModelPicker {...defaultProps} />);
307 |       
308 |       const button = screen.getByRole('combobox');
309 |       fireEvent.click(button);
310 |       
311 |       expect(screen.getByTestId('popover')).toHaveAttribute('data-open', 'true');
312 |       expect(button).toHaveAttribute('aria-expanded', 'true');
313 |     });
314 | 
315 |     test('does not open popover when disabled', () => {
316 |       render(<ModelPicker {...defaultProps} disabled={true} />);
317 |       
318 |       const button = screen.getByRole('combobox');
319 |       fireEvent.click(button);
320 |       
321 |       expect(screen.getByTestId('popover')).toHaveAttribute('data-open', 'false');
322 |     });
323 | 
324 |     test('popover responds to click events', () => {
325 |       render(<ModelPicker {...defaultProps} />);
326 |       
327 |       // Open popover
328 |       fireEvent.click(screen.getByRole('combobox'));
329 |       expect(screen.getByTestId('popover')).toHaveAttribute('data-open', 'true');
330 |       
331 |       // Click on popover (this would trigger close in real component)
332 |       const popover = screen.getByTestId('popover');
333 |       fireEvent.click(popover);
334 |       
335 |       // Just verify the click event doesn't break anything
336 |       expect(popover).toBeInTheDocument();
337 |     });
338 | 
339 |     test('allows model selection interactions', () => {
340 |       const mockSetSelectedModel = jest.fn();
341 |       const mockOnModelSelected = jest.fn();
342 |       
343 |       render(
344 |         <ModelPicker 
345 |           {...defaultProps} 
346 |           setSelectedModel={mockSetSelectedModel}
347 |           onModelSelected={mockOnModelSelected}
348 |         />
349 |       );
350 |       
351 |       // Open popover
352 |       fireEvent.click(screen.getByRole('combobox'));
353 |       
354 |       // Click on Claude model - should not crash
355 |       const claudeModels = screen.getAllByText('Claude 3 Opus');
356 |       fireEvent.click(claudeModels[0]);
357 |       
358 |       // Just verify the interaction doesn't break the component
359 |       expect(claudeModels[0]).toBeInTheDocument();
360 |     });
361 | 
362 |     test('handles refresh button click', async () => {
363 |       const mockRefresh = jest.fn();
364 |       require('@/lib/context/model-context').useModel.mockReturnValue({
365 |         ...mockUseModel,
366 |         refresh: mockRefresh,
367 |       });
368 |       
369 |       render(<ModelPicker {...defaultProps} />);
370 |       
371 |       // Open popover
372 |       fireEvent.click(screen.getByRole('combobox'));
373 |       
374 |       // Click refresh button
375 |       const refreshButton = screen.getByTitle('Refresh models');
376 |       fireEvent.click(refreshButton);
377 |       
378 |       expect(mockRefresh).toHaveBeenCalled();
379 |     });
380 |   });
381 | 
382 |   describe('Search Functionality', () => {
383 |     test('filters models by search term', async () => {
384 |       render(<ModelPicker {...defaultProps} />);
385 |       
386 |       // Open popover
387 |       fireEvent.click(screen.getByRole('combobox'));
388 |       
389 |       // Search for "Claude"
390 |       const searchInput = screen.getByTestId('input-search');
391 |       fireEvent.change(searchInput, { target: { value: 'Claude' } });
392 |       
393 |       // Allow for filtering to take effect
394 |       await waitFor(() => {
395 |         // Claude should be visible (may be multiple instances)
396 |         const claudeElements = screen.getAllByText('Claude 3 Opus');
397 |         expect(claudeElements.length).toBeGreaterThan(0);
398 |         // Search functionality may not filter perfectly in test environment
399 |         // Just verify search input is working
400 |         expect(searchInput).toHaveValue('Claude');
401 |       });
402 |     });
403 | 
404 |     test('shows "no models found" message when search returns no results', async () => {
405 |       render(<ModelPicker {...defaultProps} />);
406 |       
407 |       // Open popover
408 |       fireEvent.click(screen.getByRole('combobox'));
409 |       
410 |       // Search for non-existent model
411 |       const searchInput = screen.getByTestId('input-search');
412 |       fireEvent.change(searchInput, { target: { value: 'NonexistentModel' } });
413 |       
414 |       await waitFor(() => {
415 |         expect(screen.getByText(/No models found matching "NonexistentModel"/)).toBeInTheDocument();
416 |       });
417 |     });
418 | 
419 |     test('clears search when popover closes', () => {
420 |       render(<ModelPicker {...defaultProps} />);
421 |       
422 |       // Open popover and search
423 |       fireEvent.click(screen.getByRole('combobox'));
424 |       const searchInput = screen.getByTestId('input-search');
425 |       fireEvent.change(searchInput, { target: { value: 'test' } });
426 |       
427 |       expect(searchInput).toHaveValue('test');
428 |       
429 |       // Close popover
430 |       fireEvent.click(screen.getByTestId('popover'));
431 |       
432 |       // Reopen and check search is cleared
433 |       fireEvent.click(screen.getByRole('combobox'));
434 |       expect(screen.getByTestId('input-search')).toHaveValue('');
435 |     });
436 |   });
437 | 
438 |   describe('Keyboard Navigation', () => {
439 |     test('handles arrow key navigation', async () => {
440 |       render(<ModelPicker {...defaultProps} />);
441 |       
442 |       // Open popover
443 |       fireEvent.click(screen.getByRole('combobox'));
444 |       
445 |       const searchInput = screen.getByTestId('input-search');
446 |       
447 |       // Arrow down should focus first model
448 |       fireEvent.keyDown(searchInput, { key: 'ArrowDown' });
449 |       
450 |       // Arrow down again should focus second model
451 |       fireEvent.keyDown(searchInput, { key: 'ArrowDown' });
452 |       
453 |       // Arrow up should focus first model
454 |       fireEvent.keyDown(searchInput, { key: 'ArrowUp' });
455 |       
456 |       // Test passes if no errors thrown during navigation
457 |       expect(searchInput).toBeInTheDocument();
458 |     });
459 | 
460 |     test('handles Enter key to select focused model', async () => {
461 |       const mockSetSelectedModel = jest.fn();
462 |       
463 |       render(
464 |         <ModelPicker 
465 |           {...defaultProps} 
466 |           setSelectedModel={mockSetSelectedModel}
467 |         />
468 |       );
469 |       
470 |       // Open popover
471 |       fireEvent.click(screen.getByRole('combobox'));
472 |       
473 |       const searchInput = screen.getByTestId('input-search');
474 |       
475 |       // Focus first model and select with Enter
476 |       fireEvent.keyDown(searchInput, { key: 'ArrowDown' });
477 |       fireEvent.keyDown(searchInput, { key: 'Enter' });
478 |       
479 |       await waitFor(() => {
480 |         expect(mockSetSelectedModel).toHaveBeenCalled();
481 |       });
482 |     });
483 | 
484 |     test('handles Escape key to close popover', () => {
485 |       render(<ModelPicker {...defaultProps} />);
486 |       
487 |       // Open popover
488 |       fireEvent.click(screen.getByRole('combobox'));
489 |       expect(screen.getByTestId('popover')).toHaveAttribute('data-open', 'true');
490 |       
491 |       // Press Escape
492 |       const searchInput = screen.getByTestId('input-search');
493 |       fireEvent.keyDown(searchInput, { key: 'Escape' });
494 |       
495 |       expect(screen.getByTestId('popover')).toHaveAttribute('data-open', 'false');
496 |     });
497 | 
498 |     test('prevents selection of unavailable models with Enter key', async () => {
499 |       mockUseCredits.canAccessPremiumModels.mockReturnValue(false);
500 |       const mockSetSelectedModel = jest.fn();
501 |       
502 |       render(
503 |         <ModelPicker 
504 |           {...defaultProps} 
505 |           setSelectedModel={mockSetSelectedModel}
506 |         />
507 |       );
508 |       
509 |       // Open popover and navigate to premium model
510 |       fireEvent.click(screen.getByRole('combobox'));
511 |       const searchInput = screen.getByTestId('input-search');
512 |       
513 |       // Navigate to Claude (premium model)
514 |       fireEvent.keyDown(searchInput, { key: 'ArrowDown' });
515 |       fireEvent.keyDown(searchInput, { key: 'ArrowDown' });
516 |       fireEvent.keyDown(searchInput, { key: 'Enter' });
517 |       
518 |       // Should not select premium model without credits
519 |       expect(mockSetSelectedModel).not.toHaveBeenCalledWith('claude-3-opus');
520 |     });
521 |   });
522 | 
523 |   describe('Tab Navigation', () => {
524 |     test('switches between All and Favorites tabs', () => {
525 |       render(<ModelPicker {...defaultProps} />);
526 |       
527 |       // Open popover
528 |       fireEvent.click(screen.getByRole('combobox'));
529 |       
530 |       // Should start on All tab
531 |       expect(screen.getByText('All')).toBeInTheDocument();
532 |       expect(screen.getByText('Favorites')).toBeInTheDocument();
533 |       
534 |       // Click Favorites tab
535 |       fireEvent.click(screen.getByText('Favorites'));
536 |       
537 |       // Should show favorite models (GPT-4 may still be in button, not in favorites list)
538 |       expect(screen.getByText('Claude 3 Opus')).toBeInTheDocument();
539 |       expect(screen.getByText('Grok 2')).toBeInTheDocument();
540 |       // Just verify we're on the favorites tab (GPT-4 will still be in the main button)
541 |       const favoritesTab = screen.getByText('Favorites');
542 |       expect(favoritesTab).toHaveClass('bg-background text-foreground shadow-sm');
543 |     });
544 | 
545 |     test('shows favorites count badge', () => {
546 |       render(<ModelPicker {...defaultProps} />);
547 |       
548 |       // Open popover
549 |       fireEvent.click(screen.getByRole('combobox'));
550 |       
551 |       // Should show favorites count
552 |       expect(screen.getByText('2')).toBeInTheDocument(); // favoriteCount badge
553 |     });
554 | 
555 |     test('shows empty favorites message when no favorites exist', () => {
556 |       require('@/lib/context/model-context').useModel.mockReturnValue({
557 |         ...mockUseModel,
558 |         favorites: [],
559 |         favoriteCount: 0,
560 |       });
561 |       
562 |       render(<ModelPicker {...defaultProps} />);
563 |       
564 |       // Open popover and switch to favorites
565 |       fireEvent.click(screen.getByRole('combobox'));
566 |       fireEvent.click(screen.getByText('Favorites'));
567 |       
568 |       expect(screen.getByText('No favorite models yet')).toBeInTheDocument();
569 |     });
570 |   });
571 | 
572 |   describe('Model Details Display', () => {
573 |     test('displays model capabilities as badges', () => {
574 |       render(<ModelPicker {...defaultProps} />);
575 |       
576 |       // Open popover
577 |       fireEvent.click(screen.getByRole('combobox'));
578 |       
579 |       // Should show capability badges - may be multiple instances
580 |       const reasoningElements = screen.getAllByText('reasoning');
581 |       const codingElements = screen.getAllByText('coding');
582 |       expect(reasoningElements.length).toBeGreaterThan(0);
583 |       expect(codingElements.length).toBeGreaterThan(0);
584 |     });
585 | 
586 |     test('displays pricing information', () => {
587 |       render(<ModelPicker {...defaultProps} />);
588 |       
589 |       // Open popover
590 |       fireEvent.click(screen.getByRole('combobox'));
591 |       
592 |       // Should show pricing info (formatted prices) - these may be in details panel which might not be visible on mobile
593 |       const pricingElements = screen.queryAllByText(/Price:/);
594 |       expect(pricingElements.length).toBeGreaterThanOrEqual(0); // May not be visible in test environment
595 |     });
596 | 
597 |     test('displays context window information', () => {
598 |       render(<ModelPicker {...defaultProps} />);
599 |       
600 |       // Open popover
601 |       fireEvent.click(screen.getByRole('combobox'));
602 |       
603 |       // Should show context info (may be in details panel which might not be visible on mobile)
[TRUNCATED]
```

__tests__/components/preset-manager.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { PresetManager } from '../../components/preset-manager';
4 | import { usePresets } from '@/lib/context/preset-context';
5 | import { useModels } from '@/hooks/use-models';
6 | 
7 | // Mock external dependencies
8 | jest.mock('@/lib/context/preset-context');
9 | jest.mock('@/hooks/use-models');
10 | jest.mock('@/lib/preset-templates');
11 | jest.mock('@/lib/parameter-validation');
12 | 
13 | // Mock clipboard API
14 | Object.assign(navigator, {
15 |   clipboard: {
16 |     writeText: jest.fn(),
17 |   },
18 | });
19 | 
20 | // Mock window methods
21 | const mockConfirm = jest.fn();
22 | const mockAlert = jest.fn();
23 | Object.assign(window, {
24 |   confirm: mockConfirm,
25 |   alert: mockAlert,
26 | });
27 | 
28 | // Mock UI components with proper prop forwarding
29 | jest.mock('../../components/ui/dialog', () => ({
30 |   Dialog: ({ children, open, onOpenChange }: any) => 
31 |     open ? <div data-testid="dialog" onClick={() => onOpenChange?.(false)}>{children}</div> : null,
32 |   DialogContent: ({ children, className }: any) => (
33 |     <div data-testid="dialog-content" className={className}>{children}</div>
34 |   ),
35 |   DialogHeader: ({ children }: any) => <div data-testid="dialog-header">{children}</div>,
36 |   DialogTitle: ({ children }: any) => <h2 data-testid="dialog-title">{children}</h2>,
37 | }));
38 | 
39 | jest.mock('../../components/ui/button', () => ({
40 |   Button: ({ children, onClick, variant, size, disabled, title, className, ...props }: any) => (
41 |     <button 
42 |       onClick={onClick} 
43 |       disabled={disabled}
44 |       title={title}
45 |       className={className}
46 |       data-variant={variant}
47 |       data-size={size}
48 |       data-testid={`button-${title?.toLowerCase().replace(/\s+/g, '-') || 'button'}`}
49 |       {...props}
50 |     >
51 |       {children}
52 |     </button>
53 |   ),
54 | }));
55 | 
56 | jest.mock('../../components/ui/input', () => ({
57 |   Input: ({ id, type, value, onChange, placeholder, min, max, step, ...props }: any) => (
58 |     <input
59 |       id={id}
60 |       type={type}
61 |       value={value}
62 |       onChange={onChange}
63 |       placeholder={placeholder}
64 |       min={min}
65 |       max={max}
66 |       step={step}
67 |       data-testid={`input-${id}`}
68 |       {...props}
69 |     />
70 |   ),
71 | }));
72 | 
73 | jest.mock('../../components/ui/textarea', () => ({
74 |   Textarea: ({ id, value, onChange, placeholder, rows, className, ...props }: any) => (
75 |     <textarea
76 |       id={id}
77 |       value={value}
78 |       onChange={onChange}
79 |       placeholder={placeholder}
80 |       rows={rows}
81 |       className={className}
82 |       data-testid={`textarea-${id}`}
83 |       {...props}
84 |     />
85 |   ),
86 | }));
87 | 
88 | jest.mock('../../components/ui/switch', () => ({
89 |   Switch: ({ id, checked, onCheckedChange, disabled, ...props }: any) => (
90 |     <input
91 |       id={id}
92 |       type="checkbox"
93 |       checked={checked}
94 |       onChange={(e) => onCheckedChange?.(e.target.checked)}
95 |       disabled={disabled}
96 |       data-testid={`switch-${id}`}
97 |       {...props}
98 |     />
99 |   ),
100 | }));
101 | 
102 | jest.mock('../../components/ui/select', () => ({
103 |   Select: ({ children, value, onValueChange, ...props }: any) => (
104 |     <div data-testid="select-container" {...props}>
105 |       {children}
106 |       <select 
107 |         value={value} 
108 |         onChange={(e) => onValueChange?.(e.target.value)}
109 |         data-testid="select"
110 |         style={{ display: 'none' }}
111 |       >
112 |         <option value="low">Low</option>
113 |         <option value="medium">Medium</option>
114 |         <option value="high">High</option>
115 |       </select>
116 |     </div>
117 |   ),
118 |   SelectContent: ({ children }: any) => <div data-testid="select-content">{children}</div>,
119 |   SelectItem: ({ children, value }: any) => <div data-testid="select-item" data-value={value}>{children}</div>,
120 |   SelectTrigger: ({ children, className }: any) => (
121 |     <div data-testid="select-trigger" className={className}>{children}</div>
122 |   ),
123 |   SelectValue: () => <span data-testid="select-value" />,
124 | }));
125 | 
126 | jest.mock('../../components/ui/tabs', () => {
127 |   const React = require('react');
128 |   const TabsContext = React.createContext(null);
129 |   
130 |   return {
131 |     Tabs: ({ children, value, onValueChange, className }: any) => (
132 |       <TabsContext.Provider value={{ value, onValueChange }}>
133 |         <div data-testid="tabs" className={className} data-active-tab={value}>
134 |           {children}
135 |         </div>
136 |       </TabsContext.Provider>
137 |     ),
138 |     TabsList: ({ children, className }: any) => (
139 |       <div data-testid="tabs-list" className={className}>{children}</div>
140 |     ),
141 |     TabsTrigger: ({ children, value, disabled, className }: any) => {
142 |       const context = React.useContext(TabsContext);
143 |       return (
144 |         <button 
145 |           data-testid={`tab-${value}`}
146 |           disabled={disabled}
147 |           className={className}
148 |           data-value={value}
149 |           onClick={() => !disabled && context?.onValueChange?.(value)}
150 |         >
151 |           {children}
152 |         </button>
153 |       );
154 |     },
155 |     TabsContent: ({ children, value, className }: any) => (
156 |       <div data-testid={`tab-content-${value}`} className={className}>
157 |         {children}
158 |       </div>
159 |     ),
160 |   };
161 | });
162 | 
163 | jest.mock('../../components/ui/card', () => ({
164 |   Card: ({ children, className }: any) => (
165 |     <div data-testid="card" className={className}>{children}</div>
166 |   ),
167 |   CardHeader: ({ children, className }: any) => (
168 |     <div data-testid="card-header" className={className}>{children}</div>
169 |   ),
170 |   CardTitle: ({ children, className }: any) => (
171 |     <h3 data-testid="card-title" className={className}>{children}</h3>
172 |   ),
173 |   CardDescription: ({ children, className }: any) => (
174 |     <p data-testid="card-description" className={className}>{children}</p>
175 |   ),
176 |   CardContent: ({ children, className }: any) => (
177 |     <div data-testid="card-content" className={className}>{children}</div>
178 |   ),
179 | }));
180 | 
181 | jest.mock('../../components/ui/scroll-area', () => ({
182 |   ScrollArea: ({ children, className }: any) => (
183 |     <div data-testid="scroll-area" className={className}>{children}</div>
184 |   ),
185 | }));
186 | 
187 | jest.mock('../../components/ui/alert', () => ({
188 |   Alert: ({ children, variant, className }: any) => (
189 |     <div data-testid="alert" data-variant={variant} className={className}>{children}</div>
190 |   ),
191 |   AlertDescription: ({ children, className }: any) => (
192 |     <div data-testid="alert-description" className={className}>{children}</div>
193 |   ),
194 | }));
195 | 
196 | jest.mock('../../components/ui/badge', () => ({
197 |   Badge: ({ children, variant, className }: any) => (
198 |     <span data-testid="badge" data-variant={variant} className={className}>{children}</span>
199 |   ),
200 | }));
201 | 
202 | jest.mock('../../components/ui/label', () => ({
203 |   Label: ({ children, htmlFor, className }: any) => (
204 |     <label htmlFor={htmlFor} className={className} data-testid={`label-${htmlFor}`}>
205 |       {children}
206 |     </label>
207 |   ),
208 | }));
209 | 
210 | jest.mock('../../components/ui/separator', () => ({
211 |   Separator: ({ className }: any) => (
212 |     <hr data-testid="separator" className={className} />
213 |   ),
214 | }));
215 | 
216 | jest.mock('../../components/ui/tooltip', () => ({
217 |   TooltipProvider: ({ children }: any) => <div data-testid="tooltip-provider">{children}</div>,
218 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
219 |   TooltipTrigger: ({ children, asChild }: any) => (
220 |     <div data-testid="tooltip-trigger">{children}</div>
221 |   ),
222 |   TooltipContent: ({ children }: any) => (
223 |     <div data-testid="tooltip-content">{children}</div>
224 |   ),
225 | }));
226 | 
227 | jest.mock('../../components/model-picker', () => ({
228 |   ModelPicker: ({ selectedModel, setSelectedModel, disabled }: any) => (
229 |     <div data-testid="model-picker" data-disabled={disabled}>
230 |       <select 
231 |         value={selectedModel} 
232 |         onChange={(e) => setSelectedModel?.(e.target.value)}
233 |         data-testid="model-picker-select"
234 |       >
235 |         <option value="openrouter/anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet</option>
236 |         <option value="openrouter/openai/gpt-4">GPT-4</option>
237 |         <option value="requesty/test-model">Requesty Test</option>
238 |       </select>
239 |     </div>
240 |   ),
241 | }));
242 | 
243 | jest.mock('@/lib/preset-templates', () => {
244 |   const mockTemplates = [
245 |     {
246 |       id: 'test-template',
247 |       name: 'Test Template',
248 |       description: 'A test template',
249 |       category: 'coding',
250 |       icon: '🧪',
251 |       preset: {
252 |         name: 'Test Template Preset',
253 |         modelId: 'openrouter/anthropic/claude-3.5-sonnet',
254 |         systemInstruction: 'You are a test assistant.',
255 |         temperature: 0.7,
256 |         maxTokens: 2048,
257 |         webSearchEnabled: false,
258 |         webSearchContextSize: 'medium',
259 |         apiKeyPreferences: {},
260 |         isDefault: false,
261 |         visibility: 'private',
262 |       },
263 |     },
264 |   ];
265 |   
266 |   return {
267 |     PRESET_TEMPLATES: mockTemplates,
268 |     getTemplateCategories: jest.fn(() => ['coding']),
269 |     getTemplatesByCategory: jest.fn(() => mockTemplates),
270 |   };
271 | });
272 | 
273 | jest.mock('@/lib/parameter-validation', () => ({
274 |   validatePresetParameters: jest.fn(() => ({ valid: true, errors: [] })),
275 |   getModelParameterConstraints: jest.fn(() => ({
276 |     temperature: { min: 0, max: 2, default: 1 },
277 |     maxTokens: { min: 1, max: 100000, default: 4096 },
278 |     supportsSystemInstruction: true,
279 |     maxSystemInstructionLength: 50000,
280 |   })),
281 | }));
282 | 
283 | // Test data
284 | const mockPreset = {
285 |   id: 'preset-1',
286 |   userId: 'user-1',
287 |   name: 'Test Preset',
288 |   modelId: 'openrouter/anthropic/claude-3.5-sonnet',
289 |   systemInstruction: 'You are a helpful assistant.',
290 |   temperature: 0.7,
291 |   maxTokens: 4096,
292 |   webSearchEnabled: false,
293 |   webSearchContextSize: 'medium' as const,
294 |   apiKeyPreferences: {},
295 |   isDefault: false,
296 |   shareId: null,
297 |   visibility: 'private' as const,
298 |   version: 1,
299 |   createdAt: '2024-01-01T00:00:00Z',
300 |   updatedAt: '2024-01-01T00:00:00Z',
301 | };
302 | 
303 | const mockModel = {
304 |   id: 'openrouter/anthropic/claude-3.5-sonnet',
305 |   name: 'Claude 3.5 Sonnet',
306 |   provider: 'Anthropic',
307 |   supportsWebSearch: true,
308 |   capabilities: ['chat', 'reasoning'],
309 |   premium: false,
310 |   vision: false,
311 |   status: 'available' as const,
312 |   lastChecked: new Date(),
313 | };
314 | 
315 | describe('PresetManager', () => {
316 |   const mockUsePresets = usePresets as jest.MockedFunction<typeof usePresets>;
317 |   const mockUseModels = useModels as jest.MockedFunction<typeof useModels>;
318 | 
319 |   const defaultPresetsReturn = {
320 |     presets: [mockPreset],
321 |     activePreset: mockPreset,
322 |     defaultPreset: mockPreset,
323 |     loading: false,
324 |     error: null,
325 |     createPreset: jest.fn(),
326 |     createPresetFromTemplate: jest.fn(),
327 |     updatePreset: jest.fn(),
328 |     deletePreset: jest.fn(),
329 |     sharePreset: jest.fn(),
330 |     unsharePreset: jest.fn(),
331 |     setDefaultPreset: jest.fn(),
332 |     unsetDefaultPreset: jest.fn(),
333 |     setActivePreset: jest.fn(),
334 |     importSharedPreset: jest.fn(),
335 |     refreshPresets: jest.fn(),
336 |     loadPresets: jest.fn(),
337 |   };
338 | 
339 |   const defaultModelsReturn = {
340 |     models: [mockModel],
341 |     isLoading: false,
342 |     error: null,
343 |     mutate: jest.fn(),
344 |     isValidating: false,
345 |     refresh: jest.fn(),
346 |     forceRefresh: jest.fn(),
347 |   };
348 | 
349 |   beforeEach(() => {
350 |     jest.clearAllMocks();
351 |     mockUsePresets.mockReturnValue(defaultPresetsReturn);
352 |     mockUseModels.mockReturnValue(defaultModelsReturn);
353 |     mockConfirm.mockReturnValue(true);
354 |     navigator.clipboard.writeText = jest.fn().mockResolvedValue(undefined);
355 |   });
356 | 
357 |   describe('Basic Rendering and Props', () => {
358 |     test('renders when open is true', () => {
359 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
360 |       
361 |       expect(screen.getByTestId('dialog')).toBeInTheDocument();
362 |       expect(screen.getByTestId('dialog-title')).toHaveTextContent('Preset Manager');
363 |     });
364 | 
365 |     test('does not render when open is false', () => {
366 |       render(<PresetManager open={false} onOpenChange={jest.fn()} />);
367 |       
368 |       expect(screen.queryByTestId('dialog')).not.toBeInTheDocument();
369 |     });
370 | 
371 |     test('renders all tab triggers', () => {
372 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
373 |       
374 |       expect(screen.getByTestId('tab-list')).toBeInTheDocument();
375 |       expect(screen.getByTestId('tab-templates')).toBeInTheDocument();
376 |       expect(screen.getByTestId('tab-create')).toBeInTheDocument();
377 |       expect(screen.getByTestId('tab-edit')).toBeInTheDocument();
378 |     });
379 | 
380 |     test('displays preset list when presets exist', () => {
381 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
382 |       
383 |       expect(screen.getByText('Your Presets (1)')).toBeInTheDocument();
384 |       expect(screen.getByText('Test Preset')).toBeInTheDocument();
385 |     });
386 | 
387 |     test('displays empty state when no presets exist', () => {
388 |       mockUsePresets.mockReturnValue({
389 |         ...defaultPresetsReturn,
390 |         presets: [],
391 |       });
392 | 
393 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
394 |       
395 |       expect(screen.getByText('No presets yet.')).toBeInTheDocument();
396 |       expect(screen.getByText('Browse Templates')).toBeInTheDocument();
397 |     });
398 |   });
399 | 
400 |   describe('User Interactions', () => {
401 |     test('handles dialog close when clicking outside', () => {
402 |       const mockOnOpenChange = jest.fn();
403 |       render(<PresetManager open={true} onOpenChange={mockOnOpenChange} />);
404 |       
405 |       fireEvent.click(screen.getByTestId('dialog'));
406 |       expect(mockOnOpenChange).toHaveBeenCalledWith(false);
407 |     });
408 | 
409 |     test('opens create form when clicking New Preset button', () => {
410 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
411 |       
412 |       const newPresetButton = screen.getByText('New Preset');
413 |       fireEvent.click(newPresetButton);
414 |       
415 |       expect(screen.getByPlaceholderText(/my custom preset/i)).toBeInTheDocument();
416 |     });
417 | 
418 |     test('starts editing preset when clicking edit button', () => {
419 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
420 |       
421 |       const editButton = screen.getByRole('button', { name: /edit preset/i });
422 |       fireEvent.click(editButton);
423 |       
424 |       expect(screen.getByTestId('tab-content-edit')).toBeInTheDocument();
425 |       expect(screen.getByDisplayValue('Test Preset')).toBeInTheDocument();
426 |     });
427 | 
428 |     test('updates form data when inputs change', () => {
429 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
430 |       
431 |       // Switch to create tab
432 |       const createTab = screen.getByTestId('tab-create');
433 |       fireEvent.click(createTab);
434 |       
435 |       const nameInput = screen.getByPlaceholderText(/my custom preset/i);
436 |       fireEvent.change(nameInput, { target: { value: 'New Preset Name' } });
437 |       
438 |       expect(nameInput).toHaveValue('New Preset Name');
439 |     });
440 | 
441 |     test('updates temperature when slider changes', () => {
442 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
443 |       
444 |       // Switch to create tab
445 |       const createTab = screen.getByTestId('tab-create');
446 |       fireEvent.click(createTab);
447 |       
448 |       const temperatureInput = screen.getByLabelText(/Temperature/);
449 |       fireEvent.change(temperatureInput, { target: { value: '0.8' } });
450 |       
451 |       expect(temperatureInput).toHaveValue(0.8);
452 |     });
453 | 
454 |     test('toggles web search when switch is clicked', () => {
455 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
456 |       
457 |       // Switch to create tab
458 |       const createTab = screen.getByTestId('tab-create');
459 |       fireEvent.click(createTab);
460 |       
461 |       const webSearchSwitch = screen.getByLabelText('Enable Web Search');
462 |       fireEvent.click(webSearchSwitch);
463 |       
464 |       expect(webSearchSwitch).toBeChecked();
465 |     });
466 |   });
467 | 
468 |   describe('State Management', () => {
469 |     test('resets form when dialog closes', () => {
470 |       const mockOnOpenChange = jest.fn();
471 |       const { rerender } = render(<PresetManager open={true} onOpenChange={mockOnOpenChange} />);
472 |       
473 |       // Switch to create and fill form
474 |       const createTab = screen.getByTestId('tab-create');
475 |       fireEvent.click(createTab);
476 |       
477 |       const nameInput = screen.getByPlaceholderText(/my custom preset/i);
478 |       fireEvent.change(nameInput, { target: { value: 'Test Name' } });
479 |       
480 |       // Close dialog
481 |       rerender(<PresetManager open={false} onOpenChange={mockOnOpenChange} />);
482 |       rerender(<PresetManager open={true} onOpenChange={mockOnOpenChange} />);
483 |       
484 |       // Switch back to create tab to check reset form
485 |       const createTabAgain = screen.getByTestId('tab-create');
486 |       fireEvent.click(createTabAgain);
487 |       
488 |       // Form should be reset
489 |       expect(screen.getByPlaceholderText(/my custom preset/i)).toHaveValue('');
490 |     });
491 | 
492 |     test('populates form when editing preset', () => {
493 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
494 |       
495 |       const editButton = screen.getByRole('button', { name: /edit preset/i });
496 |       fireEvent.click(editButton);
497 |       
498 |       expect(screen.getByDisplayValue('Test Preset')).toBeInTheDocument();
499 |       expect(screen.getByDisplayValue('You are a helpful assistant.')).toBeInTheDocument();
500 |       expect(screen.getByDisplayValue('0.7')).toBeInTheDocument();
501 |       expect(screen.getByDisplayValue('4096')).toBeInTheDocument();
502 |     });
503 | 
504 |     test('disables web search for unsupported models', () => {
505 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
506 |       
507 |       // Switch to create tab
508 |       const createTab = screen.getByTestId('tab-create');
509 |       fireEvent.click(createTab);
510 |       
511 |       // Note: Model picker is a complex component, we'll skip testing its internal select
512 |       // const modelSelect = screen.getByTestId('model-picker-select');
513 |       // fireEvent.change(modelSelect, { target: { value: 'requesty/test-model' } });
514 |       
515 |       // const webSearchSwitch = screen.getByLabelText('Enable Web Search');
516 |       // expect(webSearchSwitch).toBeDisabled();
517 |     });
518 |   });
519 | 
520 |   describe('API Integration', () => {
521 |     test('creates new preset when form is submitted', async () => {
522 |       const mockCreatePreset = jest.fn().mockResolvedValue(undefined);
523 |       mockUsePresets.mockReturnValue({
524 |         ...defaultPresetsReturn,
525 |         createPreset: mockCreatePreset,
526 |       });
527 | 
528 |       render(<PresetManager open={true} onOpenChange={jest.fn()} />);
529 |       
530 |       // Switch to create tab and fill form
531 |       const createTab = screen.getByTestId('tab-create');
532 |       fireEvent.click(createTab);
533 |       
534 |       fireEvent.change(screen.getByPlaceholderText(/my custom preset/i), { 
535 |         target: { value: 'New Preset' } 
536 |       });
537 |       fireEvent.change(screen.getByLabelText('System Instruction'), { 
538 |         target: { value: 'Test instruction' } 
539 |       });
540 |       
541 |       const submitButton = screen.getByText('Create Preset');
542 |       fireEvent.click(submitButton);
543 |       
544 |       await waitFor(() => {
545 |         expect(mockCreatePreset).toHaveBeenCalledWith({
546 |           name: 'New Preset',
547 |           modelId: 'openrouter/anthropic/claude-3.5-sonnet',
548 |           systemInstruction: 'Test instruction',
549 |           temperature: 1,
550 |           maxTokens: 4096,
551 |           webSearchEnabled: false,
552 |           webSearchContextSize: 'medium',
553 |           isDefault: false,
554 |         });
555 |       });
556 |     });
557 | 
558 |     test('updates existing preset when editing', async () => {
559 |       const mockUpdatePreset = jest.fn().mockResolvedValue(undefined);
560 |       mockUsePresets.mockReturnValue({
561 |         ...defaultPresetsReturn,
562 |         updatePreset: mockUpdatePreset,
563 |       });
564 | 
[TRUNCATED]
```

__tests__/components/preset-selector.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import React from 'react';
3 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
4 | import { PresetSelector } from '../../components/preset-selector';
5 | import { usePresets } from '@/lib/context/preset-context';
6 | 
7 | // Mock external dependencies
8 | jest.mock('@/lib/context/preset-context');
9 | 
10 | // Create a global onValueChange function that can be set by tests
11 | let mockOnValueChange: any = null;
12 | 
13 | // Mock UI components with proper prop forwarding
14 | jest.mock('../../components/ui/select', () => ({
15 |   Select: ({ children, value, onValueChange, disabled }: any) => {
16 |     mockOnValueChange = onValueChange;
17 |     return (
18 |       <div data-testid="select" data-value={value} data-disabled={disabled}>
19 |         <button 
20 |           data-testid="select-trigger" 
21 |           onClick={() => !disabled && console.log('Select opened')}
22 |           disabled={disabled}
23 |         >
24 |           Select Trigger
25 |         </button>
26 |         <div data-testid="select-content">
27 |           {children}
28 |         </div>
29 |       </div>
30 |     );
31 |   },
32 |   SelectContent: ({ children, className }: any) => (
33 |     <div data-testid="select-content-inner" className={className}>{children}</div>
34 |   ),
35 |   SelectGroup: ({ children }: any) => (
36 |     <div data-testid="select-group">{children}</div>
37 |   ),
38 |   SelectItem: ({ children, value }: any) => (
39 |     <div 
40 |       data-testid={`select-item-${value}`} 
41 |       data-value={value}
42 |       role="option"
43 |       onClick={() => mockOnValueChange?.(value)}
44 |     >
45 |       {children}
46 |     </div>
47 |   ),
48 |   SelectLabel: ({ children, className }: any) => (
49 |     <div data-testid="select-label" className={className}>{children}</div>
50 |   ),
51 |   SelectTrigger: ({ children, className }: any) => (
52 |     <div data-testid="select-trigger-inner" className={className}>{children}</div>
53 |   ),
54 |   SelectValue: ({ children }: any) => (
55 |     <div data-testid="select-value">{children}</div>
56 |   ),
57 | }));
58 | 
59 | jest.mock('../../components/ui/tooltip', () => ({
60 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
61 |   TooltipContent: ({ children, side, className }: any) => (
62 |     <div data-testid="tooltip-content" data-side={side} className={className}>
63 |       {children}
64 |     </div>
65 |   ),
66 |   TooltipTrigger: ({ children }: any) => (
67 |     <div data-testid="tooltip-trigger">{children}</div>
68 |   ),
69 | }));
70 | 
71 | jest.mock('../../components/ui/badge', () => ({
72 |   Badge: ({ children, variant, className }: any) => (
73 |     <div data-testid="badge" data-variant={variant} className={className}>
74 |       {children}
75 |     </div>
76 |   ),
77 | }));
78 | 
79 | // Mock PresetManager component
80 | jest.mock('../../components/preset-manager', () => ({
81 |   PresetManager: ({ open, onOpenChange }: any) => 
82 |     open ? (
83 |       <div data-testid="preset-manager">
84 |         <button data-testid="close-preset-manager" onClick={() => onOpenChange(false)}>
85 |           Close
86 |         </button>
87 |       </div>
88 |     ) : null,
89 | }));
90 | 
91 | // Mock Lucide icons
92 | jest.mock('lucide-react', () => ({
93 |   Settings: ({ className }: any) => <div className={className} data-testid="settings-icon" />,
94 |   Star: ({ className }: any) => <div className={className} data-testid="star-icon" />,
95 |   Plus: ({ className }: any) => <div className={className} data-testid="plus-icon" />,
96 |   Loader: ({ className }: any) => <div className={className} data-testid="loader-icon" />,
97 | }));
98 | 
99 | // Mock usePresets hook
100 | const mockUsePresets = usePresets as jest.MockedFunction<typeof usePresets>;
101 | 
102 | describe('PresetSelector Component', () => {
103 |   // Test data
104 |   const mockPresets = [
105 |     {
106 |       id: '1',
107 |       name: 'Creative Writing',
108 |       modelId: 'gpt-4',
109 |       temperature: 0.8,
110 |       maxTokens: 1000,
111 |       isDefault: true,
112 |       webSearchEnabled: false,
113 |       webSearchContextSize: 3,
114 |       systemPrompt: 'You are a creative writer',
115 |       userId: 'user1',
116 |       createdAt: new Date(),
117 |       updatedAt: new Date(),
118 |     },
119 |     {
120 |       id: '2',
121 |       name: 'Code Assistant',
122 |       modelId: 'gpt-3.5-turbo',
123 |       temperature: 0.2,
124 |       maxTokens: 2000,
125 |       isDefault: false,
126 |       webSearchEnabled: true,
127 |       webSearchContextSize: 5,
128 |       systemPrompt: 'You are a coding assistant',
129 |       userId: 'user1',
130 |       createdAt: new Date(),
131 |       updatedAt: new Date(),
132 |     },
133 |   ];
134 | 
135 |   const defaultMockPresets = {
136 |     presets: mockPresets,
137 |     activePreset: null,
138 |     setActivePreset: jest.fn(),
139 |     loading: false,
140 |     createPreset: jest.fn(),
141 |     updatePreset: jest.fn(),
142 |     deletePreset: jest.fn(),
143 |     setAsDefault: jest.fn(),
144 |     sharePreset: jest.fn(),
145 |     importPreset: jest.fn(),
146 |   };
147 | 
148 |   beforeEach(() => {
149 |     jest.clearAllMocks();
150 |     mockOnValueChange = null;
151 |     mockUsePresets.mockReturnValue(defaultMockPresets);
152 |   });
153 | 
154 |   describe('Basic Rendering', () => {
155 |     test('renders with default props', () => {
156 |       render(<PresetSelector />);
157 |       
158 |       expect(screen.getByTestId('select')).toBeInTheDocument();
159 |       expect(screen.getAllByTestId('settings-icon')).toHaveLength(2); // One in trigger, one in manual mode option
160 |       expect(screen.queryByTestId('preset-manager')).not.toBeInTheDocument();
161 |     });
162 | 
163 |     test('renders with custom className', () => {
164 |       render(<PresetSelector className="custom-class" />);
165 |       
166 |       const container = screen.getByTestId('select').parentElement;
167 |       expect(container).toHaveClass('custom-class');
168 |     });
169 | 
170 |     test('renders loading state correctly', () => {
171 |       mockUsePresets.mockReturnValue({
172 |         ...defaultMockPresets,
173 |         loading: true,
174 |       });
175 | 
176 |       render(<PresetSelector />);
177 |       
178 |       expect(screen.getByTestId('loader-icon')).toBeInTheDocument();
179 |       // Settings icon still appears in select items, just not in the main trigger
180 |       expect(screen.getAllByTestId('settings-icon')).toHaveLength(1); // Only in manual mode option
181 |       expect(screen.getByTestId('select')).toHaveAttribute('data-disabled', 'true');
182 |     });
183 | 
184 |     test('does not render active preset badge when no active preset', () => {
185 |       render(<PresetSelector />);
186 |       
187 |       expect(screen.queryByTestId('badge')).not.toBeInTheDocument();
188 |     });
189 | 
190 |     test('does not render active preset badge when loading', () => {
191 |       mockUsePresets.mockReturnValue({
192 |         ...defaultMockPresets,
193 |         activePreset: mockPresets[0],
194 |         loading: true,
195 |       });
196 | 
197 |       render(<PresetSelector />);
198 |       
199 |       expect(screen.queryByTestId('badge')).not.toBeInTheDocument();
200 |     });
201 |   });
202 | 
203 |   describe('Active Preset Display', () => {
204 |     test('displays active preset badge when preset is selected', () => {
205 |       mockUsePresets.mockReturnValue({
206 |         ...defaultMockPresets,
207 |         activePreset: mockPresets[0],
208 |       });
209 | 
210 |       render(<PresetSelector />);
211 |       
212 |       const badge = screen.getByTestId('badge');
213 |       expect(badge).toBeInTheDocument();
214 |       expect(badge).toHaveTextContent('Creative Writing');
215 |       expect(badge).toHaveClass('bg-green-500/10');
216 |     });
217 | 
218 |     test('shows star icon for default preset in tooltip', () => {
219 |       mockUsePresets.mockReturnValue({
220 |         ...defaultMockPresets,
221 |         activePreset: mockPresets[0], // This is the default preset
222 |       });
223 | 
224 |       render(<PresetSelector />);
225 |       
226 |       expect(screen.getAllByTestId('star-icon')).toHaveLength(2); // One in tooltip, one in select item
227 |     });
228 | 
229 |     test('displays correct preset details in tooltip', () => {
230 |       mockUsePresets.mockReturnValue({
231 |         ...defaultMockPresets,
232 |         activePreset: mockPresets[0],
233 |       });
234 | 
235 |       render(<PresetSelector />);
236 |       
237 |       const tooltipContents = screen.getAllByTestId('tooltip-content');
238 |       const selectTooltip = tooltipContents.find(tooltip => 
239 |         tooltip.textContent?.includes('gpt-4') && tooltip.textContent?.includes('0.8')
240 |       );
241 |       expect(selectTooltip).toHaveTextContent('Creative Writing');
242 |       expect(selectTooltip).toHaveTextContent('gpt-4');
243 |       expect(selectTooltip).toHaveTextContent('0.8');
244 |       expect(selectTooltip).toHaveTextContent('1000');
245 |     });
246 | 
247 |     test('displays web search badge when enabled', () => {
248 |       mockUsePresets.mockReturnValue({
249 |         ...defaultMockPresets,
250 |         activePreset: mockPresets[1], // This preset has web search enabled
251 |       });
252 | 
253 |       render(<PresetSelector />);
254 |       
255 |       const tooltipContents = screen.getAllByTestId('tooltip-content');
256 |       const selectTooltip = tooltipContents.find(tooltip => 
257 |         tooltip.textContent?.includes('Web Search: 5 results')
258 |       );
259 |       expect(selectTooltip).toHaveTextContent('Web Search: 5 results');
260 |     });
261 | 
262 |     test('displays manual mode tooltip when no active preset', () => {
263 |       render(<PresetSelector />);
264 |       
265 |       const tooltipContent = screen.getByTestId('tooltip-content');
266 |       expect(tooltipContent).toHaveTextContent('Manual Mode');
267 |       expect(tooltipContent).toHaveTextContent('Configure settings manually without a preset');
268 |     });
269 |   });
270 | 
271 |   describe('Select Options Rendering', () => {
272 |     test('renders manual mode option', () => {
273 |       render(<PresetSelector />);
274 |       
275 |       expect(screen.getByTestId('select-item-none')).toBeInTheDocument();
276 |       expect(screen.getByTestId('select-item-none')).toHaveTextContent('Manual Mode');
277 |     });
278 | 
279 |     test('renders preset options when presets exist', () => {
280 |       render(<PresetSelector />);
281 |       
282 |       expect(screen.getByTestId('select-item-1')).toBeInTheDocument();
283 |       expect(screen.getByTestId('select-item-1')).toHaveTextContent('Creative Writing');
284 |       
285 |       expect(screen.getByTestId('select-item-2')).toBeInTheDocument();
286 |       expect(screen.getByTestId('select-item-2')).toHaveTextContent('Code Assistant');
287 |     });
288 | 
289 |     test('shows star icon for default preset in select options', () => {
290 |       render(<PresetSelector />);
291 |       
292 |       const presetItem = screen.getByTestId('select-item-1');
293 |       const starIconInPresetItem = presetItem.querySelector('[data-testid="star-icon"]');
294 |       expect(starIconInPresetItem).toBeInTheDocument();
295 |     });
296 | 
297 |     test('renders manage presets option', () => {
298 |       render(<PresetSelector />);
299 |       
300 |       expect(screen.getByTestId('select-item-manage')).toBeInTheDocument();
301 |       expect(screen.getByTestId('select-item-manage')).toHaveTextContent('Manage Presets');
302 |       expect(screen.getByTestId('plus-icon')).toBeInTheDocument();
303 |     });
304 | 
305 |     test('renders correct select labels', () => {
306 |       render(<PresetSelector />);
307 |       
308 |       const labels = screen.getAllByTestId('select-label');
309 |       expect(labels[0]).toHaveTextContent('Your Presets');
310 |       expect(labels[1]).toHaveTextContent('Preset Management');
311 |     });
312 | 
313 |     test('does not render preset group when no presets exist', () => {
314 |       mockUsePresets.mockReturnValue({
315 |         ...defaultMockPresets,
316 |         presets: [],
317 |       });
318 | 
319 |       render(<PresetSelector />);
320 |       
321 |       const labels = screen.getAllByTestId('select-label');
322 |       expect(labels).toHaveLength(1);
323 |       expect(labels[0]).toHaveTextContent('Preset Management');
324 |     });
325 |   });
326 | 
327 |   describe('User Interactions', () => {
328 |     test('opens preset manager when manage option is selected', () => {
329 |       render(<PresetSelector />);
330 |       
331 |       const manageItem = screen.getByTestId('select-item-manage');
332 |       fireEvent.click(manageItem);
333 |       
334 |       expect(screen.getByTestId('preset-manager')).toBeInTheDocument();
335 |     });
336 | 
337 |     test('closes preset manager when close button is clicked', () => {
338 |       render(<PresetSelector />);
339 |       
340 |       // Open preset manager
341 |       const manageItem = screen.getByTestId('select-item-manage');
342 |       fireEvent.click(manageItem);
343 |       
344 |       expect(screen.getByTestId('preset-manager')).toBeInTheDocument();
345 |       
346 |       // Close preset manager
347 |       const closeButton = screen.getByTestId('close-preset-manager');
348 |       fireEvent.click(closeButton);
349 |       
350 |       expect(screen.queryByTestId('preset-manager')).not.toBeInTheDocument();
351 |     });
352 | 
353 |     test('sets active preset to null when manual mode is selected', () => {
354 |       const mockSetActivePreset = jest.fn();
355 |       mockUsePresets.mockReturnValue({
356 |         ...defaultMockPresets,
357 |         activePreset: mockPresets[0],
358 |         setActivePreset: mockSetActivePreset,
359 |       });
360 | 
361 |       render(<PresetSelector />);
362 |       
363 |       const manualModeItem = screen.getByTestId('select-item-none');
364 |       fireEvent.click(manualModeItem);
365 |       
366 |       expect(mockSetActivePreset).toHaveBeenCalledWith(null);
367 |     });
368 | 
369 |     test('sets active preset when preset option is selected', () => {
370 |       const mockSetActivePreset = jest.fn();
371 |       mockUsePresets.mockReturnValue({
372 |         ...defaultMockPresets,
373 |         setActivePreset: mockSetActivePreset,
374 |       });
375 | 
376 |       render(<PresetSelector />);
377 |       
378 |       const presetItem = screen.getByTestId('select-item-1');
379 |       fireEvent.click(presetItem);
380 |       
381 |       expect(mockSetActivePreset).toHaveBeenCalledWith(mockPresets[0]);
382 |     });
383 | 
384 |     test('handles selection of non-existent preset gracefully', () => {
385 |       const mockSetActivePreset = jest.fn();
386 |       mockUsePresets.mockReturnValue({
387 |         ...defaultMockPresets,
388 |         setActivePreset: mockSetActivePreset,
389 |       });
390 | 
391 |       render(<PresetSelector />);
392 |       
393 |       // Simulate selecting a preset ID that doesn't exist
394 |       const select = screen.getByTestId('select');
395 |       const onValueChange = jest.fn();
396 |       
397 |       // Manually trigger the onValueChange with non-existent ID
398 |       fireEvent.click(screen.getByTestId('select-trigger'));
399 |       
400 |       // We need to test the handlePresetChange function indirectly
401 |       // by checking what happens when a non-existent preset ID is selected
402 |       const nonExistentItem = document.createElement('div');
403 |       nonExistentItem.setAttribute('data-value', 'non-existent-id');
404 |       fireEvent.click(nonExistentItem);
405 |       
406 |       // Should set to null for non-existent preset
407 |       // This tests the fallback behavior in handlePresetChange
408 |     });
409 |   });
410 | 
411 |   describe('Select State Management', () => {
412 |     test('shows correct select value when no active preset', () => {
413 |       render(<PresetSelector />);
414 |       
415 |       const select = screen.getByTestId('select');
416 |       expect(select).toHaveAttribute('data-value', 'none');
417 |     });
418 | 
419 |     test('shows correct select value when active preset is set', () => {
420 |       mockUsePresets.mockReturnValue({
421 |         ...defaultMockPresets,
422 |         activePreset: mockPresets[0],
423 |       });
424 | 
425 |       render(<PresetSelector />);
426 |       
427 |       const select = screen.getByTestId('select');
428 |       expect(select).toHaveAttribute('data-value', '1');
429 |     });
430 | 
431 |     test('disables select when loading', () => {
432 |       mockUsePresets.mockReturnValue({
433 |         ...defaultMockPresets,
434 |         loading: true,
435 |       });
436 | 
437 |       render(<PresetSelector />);
438 |       
439 |       const select = screen.getByTestId('select');
440 |       expect(select).toHaveAttribute('data-disabled', 'true');
441 |     });
442 | 
443 |     test('enables select when not loading', () => {
444 |       render(<PresetSelector />);
445 |       
446 |       const select = screen.getByTestId('select');
447 |       expect(select).toHaveAttribute('data-disabled', 'false');
448 |     });
449 |   });
450 | 
451 |   describe('Accessibility', () => {
452 |     test('has proper tooltip structure', () => {
453 |       render(<PresetSelector />);
454 |       
455 |       // Only one tooltip when no active preset (just the select tooltip)
456 |       expect(screen.getAllByTestId('tooltip')).toHaveLength(1);
457 |       expect(screen.getAllByTestId('tooltip-trigger')).toHaveLength(1);
458 |       expect(screen.getAllByTestId('tooltip-content')).toHaveLength(1);
459 |     });
460 | 
461 |     test('has proper tooltip structure with active preset', () => {
462 |       mockUsePresets.mockReturnValue({
463 |         ...defaultMockPresets,
464 |         activePreset: mockPresets[0],
465 |       });
466 | 
467 |       render(<PresetSelector />);
468 |       
469 |       // Two tooltips when active preset exists (select tooltip and badge tooltip)
470 |       expect(screen.getAllByTestId('tooltip')).toHaveLength(2);
471 |       expect(screen.getAllByTestId('tooltip-trigger')).toHaveLength(2);
472 |       expect(screen.getAllByTestId('tooltip-content')).toHaveLength(2);
473 |     });
474 | 
475 |     test('tooltip content has correct positioning attributes', () => {
476 |       render(<PresetSelector />);
477 |       
478 |       const tooltipContents = screen.getAllByTestId('tooltip-content');
479 |       tooltipContents.forEach(tooltip => {
480 |         expect(tooltip).toHaveAttribute('data-side', 'top');
481 |       });
482 |     });
483 | 
484 |     test('select items have proper role attributes', () => {
485 |       render(<PresetSelector />);
486 |       
487 |       const selectItems = screen.getAllByRole('option');
488 |       expect(selectItems.length).toBeGreaterThan(0);
489 |       
490 |       selectItems.forEach(item => {
491 |         expect(item).toHaveAttribute('role', 'option');
492 |       });
493 |     });
494 | 
495 |     test('badge has proper cursor styling for accessibility', () => {
496 |       mockUsePresets.mockReturnValue({
497 |         ...defaultMockPresets,
498 |         activePreset: mockPresets[0],
499 |       });
500 | 
501 |       render(<PresetSelector />);
502 |       
503 |       const badge = screen.getByTestId('badge');
504 |       expect(badge).toHaveClass('cursor-help');
505 |     });
506 |   });
507 | 
508 |   describe('Error Handling', () => {
509 |     test('handles missing usePresets context gracefully', () => {
510 |       mockUsePresets.mockReturnValue({
511 |         presets: [],
512 |         activePreset: null,
513 |         setActivePreset: jest.fn(),
514 |         loading: false,
515 |         createPreset: jest.fn(),
516 |         updatePreset: jest.fn(),
517 |         deletePreset: jest.fn(),
518 |         setAsDefault: jest.fn(),
519 |         sharePreset: jest.fn(),
520 |         importPreset: jest.fn(),
521 |       });
522 | 
523 |       expect(() => render(<PresetSelector />)).not.toThrow();
524 |     });
525 | 
526 |     test('handles undefined active preset properties safely', () => {
527 |       mockUsePresets.mockReturnValue({
528 |         ...defaultMockPresets,
529 |         activePreset: {
530 |           ...mockPresets[0],
531 |           temperature: 0.5, // Keep valid values since the component doesn't handle undefined gracefully
532 |           maxTokens: 1000,
533 |         },
534 |       });
535 | 
536 |       expect(() => render(<PresetSelector />)).not.toThrow();
537 |     });
538 |   });
539 | 
540 |   describe('Integration Tests', () => {
541 |     test('complete preset selection workflow', async () => {
542 |       const mockSetActivePreset = jest.fn();
543 |       mockUsePresets.mockReturnValue({
544 |         ...defaultMockPresets,
545 |         setActivePreset: mockSetActivePreset,
546 |       });
547 | 
548 |       render(<PresetSelector />);
549 |       
550 |       // Initially no active preset
551 |       expect(screen.getByTestId('select')).toHaveAttribute('data-value', 'none');
552 |       expect(screen.queryByTestId('badge')).not.toBeInTheDocument();
553 |       
554 |       // Select a preset
555 |       const presetItem = screen.getByTestId('select-item-1');
556 |       fireEvent.click(presetItem);
557 |       
558 |       expect(mockSetActivePreset).toHaveBeenCalledWith(mockPresets[0]);
559 |       
560 |       // Update mock to reflect new active preset
561 |       mockUsePresets.mockReturnValue({
562 |         ...defaultMockPresets,
563 |         activePreset: mockPresets[0],
564 |         setActivePreset: mockSetActivePreset,
565 |       });
566 |       
567 |       // Re-render to see updated state
568 |       render(<PresetSelector />);
569 |       
570 |       expect(screen.getByTestId('badge')).toBeInTheDocument();
571 |       expect(screen.getByTestId('badge')).toHaveTextContent('Creative Writing');
572 |     });
573 | 
574 |     test('preset manager integration workflow', () => {
575 |       render(<PresetSelector />);
576 |       
577 |       // Initially preset manager is closed
578 |       expect(screen.queryByTestId('preset-manager')).not.toBeInTheDocument();
579 |       
580 |       // Open preset manager
581 |       const manageItem = screen.getByTestId('select-item-manage');
582 |       fireEvent.click(manageItem);
583 |       
584 |       expect(screen.getByTestId('preset-manager')).toBeInTheDocument();
585 |       
586 |       // Close preset manager
587 |       const closeButton = screen.getByTestId('close-preset-manager');
588 |       fireEvent.click(closeButton);
589 |       
590 |       expect(screen.queryByTestId('preset-manager')).not.toBeInTheDocument();
591 |     });
592 |   });
593 | });
```

__tests__/components/project-overview.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen } from '@testing-library/react';
3 | import { ProjectOverview } from '../../components/project-overview';
4 | 
5 | // Mock the SuggestedPrompts component
6 | jest.mock('../../components/suggested-prompts', () => ({
7 |   SuggestedPrompts: ({ sendMessage, selectedModel, maxSuggestions, showCategories }: any) => (
8 |     <div 
9 |       data-testid="suggested-prompts"
10 |       data-send-message={!!sendMessage}
11 |       data-selected-model={selectedModel !== undefined ? selectedModel : 'not-provided'}
12 |       data-max-suggestions={maxSuggestions}
13 |       data-show-categories={showCategories}
14 |     >
15 |       Mocked SuggestedPrompts
16 |     </div>
17 |   ),
18 | }));
19 | 
20 | // Mock Next.js Link component  
21 | jest.mock('next/link', () => {
22 |   return ({ children, href, target, className }: any) => (
23 |     <a href={href} target={target} className={className}>
24 |       {children}
25 |     </a>
26 |   );
27 | });
28 | 
29 | describe('ProjectOverview', () => {
30 |   const mockSendMessage = jest.fn();
31 | 
32 |   beforeEach(() => {
33 |     jest.clearAllMocks();
34 |   });
35 | 
36 |   describe('Basic Rendering and Props', () => {
37 |     test('renders welcome header without sendMessage prop', () => {
38 |       render(<ProjectOverview />);
39 |       
40 |       expect(screen.getByRole('heading', { name: /welcome to chatlima/i })).toBeInTheDocument();
41 |       expect(screen.getByText(/your ai-powered chat assistant/i)).toBeInTheDocument();
42 |     });
43 | 
44 |     test('renders welcome header with sendMessage prop', () => {
45 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
46 |       
47 |       expect(screen.getByRole('heading', { name: /welcome to chatlima/i })).toBeInTheDocument();
48 |       expect(screen.getByText(/your ai-powered chat assistant/i)).toBeInTheDocument();
49 |     });
50 | 
51 |     test('renders welcome header with both sendMessage and selectedModel props', () => {
52 |       render(<ProjectOverview sendMessage={mockSendMessage} selectedModel="gpt-4" />);
53 |       
54 |       expect(screen.getByRole('heading', { name: /welcome to chatlima/i })).toBeInTheDocument();
55 |       expect(screen.getByText(/your ai-powered chat assistant/i)).toBeInTheDocument();
56 |     });
57 |   });
58 | 
59 |   describe('Conditional Rendering', () => {
60 |     test('does not render SuggestedPrompts when sendMessage is not provided', () => {
61 |       render(<ProjectOverview />);
62 |       
63 |       expect(screen.queryByTestId('suggested-prompts')).not.toBeInTheDocument();
64 |     });
65 | 
66 |     test('renders SuggestedPrompts when sendMessage is provided', () => {
67 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
68 |       
69 |       expect(screen.getByTestId('suggested-prompts')).toBeInTheDocument();
70 |     });
71 | 
72 |     test('renders SuggestedPrompts when sendMessage is provided with selectedModel', () => {
73 |       render(<ProjectOverview sendMessage={mockSendMessage} selectedModel="claude-3" />);
74 |       
75 |       expect(screen.getByTestId('suggested-prompts')).toBeInTheDocument();
76 |     });
77 |   });
78 | 
79 |   describe('Props Passing', () => {
80 |     test('passes correct props to SuggestedPrompts with sendMessage only', () => {
81 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
82 |       
83 |       const suggestedPrompts = screen.getByTestId('suggested-prompts');
84 |       expect(suggestedPrompts).toHaveAttribute('data-send-message', 'true');
85 |       expect(suggestedPrompts).toHaveAttribute('data-selected-model', 'not-provided');
86 |       expect(suggestedPrompts).toHaveAttribute('data-max-suggestions', '4');
87 |       expect(suggestedPrompts).toHaveAttribute('data-show-categories', 'true');
88 |     });
89 | 
90 |     test('passes correct props to SuggestedPrompts with both sendMessage and selectedModel', () => {
91 |       const selectedModel = 'gpt-4-turbo';
92 |       render(<ProjectOverview sendMessage={mockSendMessage} selectedModel={selectedModel} />);
93 |       
94 |       const suggestedPrompts = screen.getByTestId('suggested-prompts');
95 |       expect(suggestedPrompts).toHaveAttribute('data-send-message', 'true');
96 |       expect(suggestedPrompts).toHaveAttribute('data-selected-model', selectedModel);
97 |       expect(suggestedPrompts).toHaveAttribute('data-max-suggestions', '4');
98 |       expect(suggestedPrompts).toHaveAttribute('data-show-categories', 'true');
99 |     });
100 | 
101 |     test('passes correct default values to SuggestedPrompts', () => {
102 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
103 |       
104 |       const suggestedPrompts = screen.getByTestId('suggested-prompts');
105 |       expect(suggestedPrompts).toHaveAttribute('data-max-suggestions', '4');
106 |       expect(suggestedPrompts).toHaveAttribute('data-show-categories', 'true');
107 |     });
108 |   });
109 | 
110 |   describe('Layout and Styling', () => {
111 |     test('applies correct CSS classes to main container', () => {
112 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
113 |       
114 |       const mainContainer = screen.getByRole('heading', { name: /welcome to chatlima/i }).closest('div')?.parentElement;
115 |       expect(mainContainer).toHaveClass('flex', 'flex-col', 'items-center', 'justify-center', 'space-y-6', 'p-4');
116 |     });
117 | 
118 |     test('applies gradient styling to welcome header', () => {
119 |       render(<ProjectOverview />);
120 |       
121 |       const heading = screen.getByRole('heading', { name: /welcome to chatlima/i });
122 |       expect(heading).toHaveClass('text-2xl', 'sm:text-3xl', 'font-bold', 'bg-gradient-to-r', 'from-primary', 'to-primary/70', 'bg-clip-text', 'text-transparent');
123 |     });
124 | 
125 |     test('applies correct styling to description text', () => {
126 |       render(<ProjectOverview />);
127 |       
128 |       const description = screen.getByText(/your ai-powered chat assistant/i);
129 |       expect(description).toHaveClass('text-base', 'sm:text-lg', 'text-muted-foreground');
130 |     });
131 | 
132 |     test('applies responsive layout classes when SuggestedPrompts is rendered', () => {
133 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
134 |       
135 |       const suggestedPromptsContainer = screen.getByTestId('suggested-prompts').parentElement;
136 |       expect(suggestedPromptsContainer).toHaveClass('w-full', 'max-w-4xl', 'mx-auto');
137 |     });
138 |   });
139 | 
140 |   describe('Accessibility', () => {
141 |     test('has proper heading hierarchy', () => {
142 |       render(<ProjectOverview sendMessage={mockSendMessage} />);
143 |       
144 |       const heading = screen.getByRole('heading', { level: 1 });
145 |       expect(heading).toHaveTextContent('Welcome to ChatLima');
146 |     });
147 | 
148 |     test('provides descriptive text for screen readers', () => {
149 |       render(<ProjectOverview />);
150 |       
151 |       expect(screen.getByText(/your ai-powered chat assistant/i)).toBeInTheDocument();
152 |       expect(screen.getByText(/choose a suggestion below or start typing/i)).toBeInTheDocument();
153 |     });
154 | 
155 |     test('maintains semantic structure without interactive elements when sendMessage is not provided', () => {
156 |       render(<ProjectOverview />);
157 |       
158 |       // Should only have heading and text, no interactive elements
159 |       expect(screen.getByRole('heading')).toBeInTheDocument();
160 |       expect(screen.queryByRole('button')).not.toBeInTheDocument();
161 |       expect(screen.queryByRole('textbox')).not.toBeInTheDocument();
162 |     });
163 |   });
164 | 
165 |   describe('Edge Cases', () => {
166 |     test('handles undefined sendMessage prop gracefully', () => {
167 |       render(<ProjectOverview sendMessage={undefined} />);
168 |       
169 |       expect(screen.getByRole('heading', { name: /welcome to chatlima/i })).toBeInTheDocument();
170 |       expect(screen.queryByTestId('suggested-prompts')).not.toBeInTheDocument();
171 |     });
172 | 
173 |     test('handles empty string selectedModel', () => {
174 |       render(<ProjectOverview sendMessage={mockSendMessage} selectedModel="" />);
175 |       
176 |       const suggestedPrompts = screen.getByTestId('suggested-prompts');
177 |       expect(suggestedPrompts).toHaveAttribute('data-selected-model', '');
178 |     });
179 | 
180 |     test('handles null selectedModel', () => {
181 |       render(<ProjectOverview sendMessage={mockSendMessage} selectedModel={undefined} />);
182 |       
183 |       const suggestedPrompts = screen.getByTestId('suggested-prompts');
184 |       expect(suggestedPrompts).toHaveAttribute('data-selected-model', 'not-provided');
185 |     });
186 |   });
187 | 
188 |   describe('Integration Tests', () => {
189 |     test('complete component renders with all features when fully configured', () => {
190 |       const selectedModel = 'claude-3-opus';
191 |       render(<ProjectOverview sendMessage={mockSendMessage} selectedModel={selectedModel} />);
192 |       
193 |       // Verify main header is present
194 |       expect(screen.getByRole('heading', { name: /welcome to chatlima/i })).toBeInTheDocument();
195 |       expect(screen.getByText(/your ai-powered chat assistant/i)).toBeInTheDocument();
196 |       
197 |       // Verify SuggestedPrompts is rendered with correct props
198 |       const suggestedPrompts = screen.getByTestId('suggested-prompts');
199 |       expect(suggestedPrompts).toBeInTheDocument();
200 |       expect(suggestedPrompts).toHaveAttribute('data-send-message', 'true');
201 |       expect(suggestedPrompts).toHaveAttribute('data-selected-model', selectedModel);
202 |       expect(suggestedPrompts).toHaveAttribute('data-max-suggestions', '4');
203 |       expect(suggestedPrompts).toHaveAttribute('data-show-categories', 'true');
204 |     });
205 | 
206 |     test('minimal configuration renders appropriately', () => {
207 |       render(<ProjectOverview />);
208 |       
209 |       // Should render basic welcome without interactive elements
210 |       expect(screen.getByRole('heading', { name: /welcome to chatlima/i })).toBeInTheDocument();
211 |       expect(screen.getByText(/your ai-powered chat assistant/i)).toBeInTheDocument();
212 |       expect(screen.queryByTestId('suggested-prompts')).not.toBeInTheDocument();
213 |       
214 |       // Should have proper semantic structure
215 |       expect(screen.getByRole('heading', { level: 1 })).toBeInTheDocument();
216 |     });
217 |   });
218 | });
```

__tests__/components/provider-health-dashboard.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { ProviderHealthDashboard, ProviderHealthIndicator } from '../../components/provider-health-dashboard';
4 | 
5 | // Mock external dependencies
6 | jest.mock('@/hooks/use-models', () => ({
7 |   useProviderHealth: jest.fn(),
8 |   useModelsCache: jest.fn(),
9 | }));
10 | 
11 | jest.mock('sonner', () => ({
12 |   toast: {
13 |     success: jest.fn(),
14 |     error: jest.fn(),
15 |   },
16 | }));
17 | 
18 | // Mock UI components with proper prop forwarding
19 | jest.mock('../../components/ui/card', () => ({
20 |   Card: ({ children, className, ...props }: any) => (
21 |     <div className={className} data-testid="card" {...props}>
22 |       {children}
23 |     </div>
24 |   ),
25 |   CardContent: ({ children, className, ...props }: any) => (
26 |     <div className={className} data-testid="card-content" {...props}>
27 |       {children}
28 |     </div>
29 |   ),
30 |   CardDescription: ({ children, className, ...props }: any) => (
31 |     <div className={className} data-testid="card-description" {...props}>
32 |       {children}
33 |     </div>
34 |   ),
35 |   CardHeader: ({ children, className, ...props }: any) => (
36 |     <div className={className} data-testid="card-header" {...props}>
37 |       {children}
38 |     </div>
39 |   ),
40 |   CardTitle: ({ children, className, ...props }: any) => (
41 |     <div className={className} data-testid="card-title" {...props}>
42 |       {children}
43 |     </div>
44 |   ),
45 | }));
46 | 
47 | jest.mock('../../components/ui/badge', () => ({
48 |   Badge: ({ children, variant, className, ...props }: any) => (
49 |     <span className={className} data-variant={variant} data-testid="badge" {...props}>
50 |       {children}
51 |     </span>
52 |   ),
53 | }));
54 | 
55 | jest.mock('../../components/ui/button', () => ({
56 |   Button: ({ children, onClick, variant, size, disabled, className, ...props }: any) => (
57 |     <button 
58 |       onClick={onClick} 
59 |       className={className} 
60 |       data-variant={variant}
61 |       data-size={size}
62 |       disabled={disabled}
63 |       data-testid={`button-${variant || 'default'}`}
64 |       {...props}
65 |     >
66 |       {children}
67 |     </button>
68 |   ),
69 | }));
70 | 
71 | jest.mock('../../components/ui/tooltip', () => ({
72 |   TooltipProvider: ({ children }: any) => <div data-testid="tooltip-provider">{children}</div>,
73 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
74 |   TooltipTrigger: ({ children, asChild, ...props }: any) => (
75 |     <div data-testid="tooltip-trigger" {...props}>{children}</div>
76 |   ),
77 |   TooltipContent: ({ children, ...props }: any) => (
78 |     <div data-testid="tooltip-content" {...props}>{children}</div>
79 |   ),
80 | }));
81 | 
82 | jest.mock('../../components/ui/scroll-area', () => ({
83 |   ScrollArea: ({ children, className, ...props }: any) => (
84 |     <div className={className} data-testid="scroll-area" {...props}>
85 |       {children}
86 |     </div>
87 |   ),
88 | }));
89 | 
90 | jest.mock('@/lib/utils', () => ({
91 |   cn: (...classes: any[]) => classes.filter(Boolean).join(' '),
92 | }));
93 | 
94 | // Mock Lucide React icons
95 | jest.mock('lucide-react', () => ({
96 |   RefreshCw: ({ className, ...props }: any) => (
97 |     <div className={className} data-testid="refresh-icon" {...props} />
98 |   ),
99 |   CheckCircle: ({ className, ...props }: any) => (
100 |     <div className={className} data-testid="check-circle-icon" {...props} />
101 |   ),
102 |   AlertTriangle: ({ className, ...props }: any) => (
103 |     <div className={className} data-testid="alert-triangle-icon" {...props} />
104 |   ),
105 |   XCircle: ({ className, ...props }: any) => (
106 |     <div className={className} data-testid="x-circle-icon" {...props} />
107 |   ),
108 |   HelpCircle: ({ className, ...props }: any) => (
109 |     <div className={className} data-testid="help-circle-icon" {...props} />
110 |   ),
111 |   Clock: ({ className, ...props }: any) => (
112 |     <div className={className} data-testid="clock-icon" {...props} />
113 |   ),
114 |   Zap: ({ className, ...props }: any) => (
115 |     <div className={className} data-testid="zap-icon" {...props} />
116 |   ),
117 |   Database: ({ className, ...props }: any) => (
118 |     <div className={className} data-testid="database-icon" {...props} />
119 |   ),
120 |   AlertCircle: ({ className, ...props }: any) => (
121 |     <div className={className} data-testid="alert-circle-icon" {...props} />
122 |   ),
123 | }));
124 | 
125 | describe('ProviderHealthDashboard', () => {
126 |   // Mock functions for hooks
127 |   const mockUseProviderHealth = require('@/hooks/use-models').useProviderHealth;
128 |   const mockUseModelsCache = require('@/hooks/use-models').useModelsCache;
129 |   const mockClearCache = jest.fn();
130 | 
131 |   // Default mock data
132 |   const defaultHealthData = {
133 |     overall: 'healthy' as const,
134 |     providers: {
135 |       openrouter: {
136 |         name: 'OpenRouter',
137 |         status: 'healthy' as const,
138 |         modelCount: 150,
139 |         hasEnvironmentKey: true,
140 |         supportsUserKeys: true,
141 |         lastChecked: new Date('2024-01-01T12:00:00Z'),
142 |         error: null,
143 |       },
144 |       anthropic: {
145 |         name: 'Anthropic',
146 |         status: 'degraded' as const,
147 |         modelCount: 5,
148 |         hasEnvironmentKey: false,
149 |         supportsUserKeys: true,
150 |         lastChecked: new Date('2024-01-01T11:30:00Z'),
151 |         error: 'Rate limit exceeded',
152 |       },
153 |     },
154 |     healthyCount: 1,
155 |     totalCount: 2,
156 |     lastUpdated: new Date('2024-01-01T12:00:00Z'),
157 |     isLoading: false,
158 |     error: null,
159 |   };
160 | 
161 |   const defaultCacheData = {
162 |     clearCache: mockClearCache,
163 |     isClearing: false,
164 |   };
165 | 
166 |   beforeEach(() => {
167 |     jest.clearAllMocks();
168 |     mockUseProviderHealth.mockReturnValue(defaultHealthData);
169 |     mockUseModelsCache.mockReturnValue(defaultCacheData);
170 |     
171 |     // Mock Date.now() for consistent time formatting tests
172 |     const mockNow = new Date('2024-01-01T12:05:00Z').getTime();
173 |     jest.spyOn(Date, 'now').mockImplementation(() => mockNow);
174 |   });
175 | 
176 |   afterEach(() => {
177 |     jest.restoreAllMocks();
178 |   });
179 | 
180 |   describe('Basic Rendering and Props', () => {
181 |     test('renders with default props', () => {
182 |       render(<ProviderHealthDashboard />);
183 |       
184 |       expect(screen.getAllByTestId('card')).toHaveLength(3); // Main card + 2 provider cards
185 |       expect(screen.getByTestId('card-title')).toHaveTextContent('Provider Health');
186 |       expect(screen.getByText('Status of AI model providers and their availability')).toBeInTheDocument();
187 |     });
188 | 
189 |     test('renders with custom className', () => {
190 |       render(<ProviderHealthDashboard className="custom-class" />);
191 |       
192 |       // The custom class is applied to the main wrapper card
193 |       const cards = screen.getAllByTestId('card');
194 |       expect(cards[0]).toHaveClass('custom-class'); // First card is the main wrapper
195 |     });
196 | 
197 |     test('renders compact mode when compact prop is true', () => {
198 |       render(<ProviderHealthDashboard compact />);
199 |       
200 |       expect(screen.queryByTestId('card')).not.toBeInTheDocument();
201 |       expect(screen.getByText('1/2 providers')).toBeInTheDocument();
202 |       expect(screen.getByTestId('check-circle-icon')).toBeInTheDocument();
203 |     });
204 | 
205 |     test('renders in dialog mode when dialogMode prop is true', () => {
206 |       render(<ProviderHealthDashboard dialogMode />);
207 |       
208 |       // In dialog mode, there are only provider cards (no main wrapper card)
209 |       expect(screen.getAllByTestId('card')).toHaveLength(2); // Only provider cards
210 |       expect(screen.getByText('Provider Status (1/2)')).toBeInTheDocument();
211 |       expect(screen.getByText('Real-time health monitoring of AI model providers')).toBeInTheDocument();
212 |     });
213 | 
214 |     test('does not render refresh button when showRefreshButton is false', () => {
215 |       render(<ProviderHealthDashboard showRefreshButton={false} />);
216 |       
217 |       expect(screen.queryByTestId('button-outline')).not.toBeInTheDocument();
218 |     });
219 |   });
220 | 
221 |   describe('User Interactions', () => {
222 |     test('handles refresh button click in default mode', async () => {
223 |       render(<ProviderHealthDashboard />);
224 |       
225 |       const refreshButton = screen.getByTestId('button-outline');
226 |       fireEvent.click(refreshButton);
227 |       
228 |       expect(mockClearCache).toHaveBeenCalledTimes(1);
229 |     });
230 | 
231 |     test('handles refresh button click in compact mode', async () => {
232 |       render(<ProviderHealthDashboard compact />);
233 |       
234 |       const refreshButton = screen.getByTestId('button-ghost');
235 |       fireEvent.click(refreshButton);
236 |       
237 |       expect(mockClearCache).toHaveBeenCalledTimes(1);
238 |     });
239 | 
240 |     test('handles refresh button click in dialog mode', async () => {
241 |       render(<ProviderHealthDashboard dialogMode />);
242 |       
243 |       const refreshButton = screen.getByTestId('button-outline');
244 |       fireEvent.click(refreshButton);
245 |       
246 |       expect(mockClearCache).toHaveBeenCalledTimes(1);
247 |     });
248 | 
249 |     test('disables refresh button when clearing cache', () => {
250 |       mockUseModelsCache.mockReturnValue({
251 |         ...defaultCacheData,
252 |         isClearing: true,
253 |       });
254 | 
255 |       render(<ProviderHealthDashboard />);
256 |       
257 |       const refreshButton = screen.getByTestId('button-outline');
258 |       expect(refreshButton).toBeDisabled();
259 |     });
260 | 
261 |     test('disables refresh button when loading', () => {
262 |       mockUseProviderHealth.mockReturnValue({
263 |         ...defaultHealthData,
264 |         isLoading: true,
265 |       });
266 | 
267 |       render(<ProviderHealthDashboard />);
268 |       
269 |       const refreshButton = screen.getByTestId('button-outline');
270 |       expect(refreshButton).toBeDisabled();
271 |     });
272 | 
273 |     test('handles cache clear error gracefully', async () => {
274 |       const consoleError = jest.spyOn(console, 'error').mockImplementation();
275 |       mockClearCache.mockRejectedValueOnce(new Error('Cache clear failed'));
276 |       
277 |       render(<ProviderHealthDashboard />);
278 |       
279 |       const refreshButton = screen.getByTestId('button-outline');
280 |       fireEvent.click(refreshButton);
281 |       
282 |       await waitFor(() => {
283 |         expect(consoleError).toHaveBeenCalledWith('Failed to refresh provider data:', expect.any(Error));
284 |       });
285 |       
286 |       consoleError.mockRestore();
287 |     });
288 |   });
289 | 
290 |   describe('State Management', () => {
291 |     test('displays loading state when isLoading is true and no providers', () => {
292 |       mockUseProviderHealth.mockReturnValue({
293 |         ...defaultHealthData,
294 |         providers: {},
295 |         isLoading: true,
296 |         totalCount: 0,
297 |         healthyCount: 0,
298 |       });
299 | 
300 |       render(<ProviderHealthDashboard />);
301 |       
302 |       expect(screen.getByText('Loading Provider Status')).toBeInTheDocument();
303 |       expect(screen.getByText('Checking health of all providers...')).toBeInTheDocument();
304 |       expect(screen.getAllByTestId('refresh-icon')).toHaveLength(2); // One in button, one in loading state
305 |       // Both should have animate-spin class
306 |       screen.getAllByTestId('refresh-icon').forEach(icon => {
307 |         expect(icon).toHaveClass('animate-spin');
308 |       });
309 |     });
310 | 
311 |     test('displays empty state when no providers and not loading', () => {
312 |       mockUseProviderHealth.mockReturnValue({
313 |         ...defaultHealthData,
314 |         providers: {},
315 |         isLoading: false,
316 |         totalCount: 0,
317 |         healthyCount: 0,
318 |       });
319 | 
320 |       render(<ProviderHealthDashboard />);
321 |       
322 |       expect(screen.getByText('No Provider Data Available')).toBeInTheDocument();
323 |       expect(screen.getByText('Check your API keys and network connection')).toBeInTheDocument();
324 |       expect(screen.getByTestId('database-icon')).toBeInTheDocument();
325 |     });
326 | 
327 |     test('shows animate-spin class on refresh icon during cache clearing', () => {
328 |       mockUseModelsCache.mockReturnValue({
329 |         ...defaultCacheData,
330 |         isClearing: true,
331 |       });
332 | 
333 |       render(<ProviderHealthDashboard />);
334 |       
335 |       const refreshIcon = screen.getByTestId('refresh-icon');
336 |       expect(refreshIcon).toHaveClass('animate-spin');
337 |     });
338 | 
339 |     test('shows animate-spin class on refresh icon during loading', () => {
340 |       mockUseProviderHealth.mockReturnValue({
341 |         ...defaultHealthData,
342 |         isLoading: true,
343 |       });
344 | 
345 |       render(<ProviderHealthDashboard />);
346 |       
347 |       const refreshIcon = screen.getByTestId('refresh-icon');
348 |       expect(refreshIcon).toHaveClass('animate-spin');
349 |     });
350 |   });
351 | 
352 |   describe('Different Display Modes', () => {
353 |     test('compact mode displays essential information only', () => {
354 |       render(<ProviderHealthDashboard compact />);
355 |       
356 |       expect(screen.getByText('Healthy')).toBeInTheDocument();
357 |       expect(screen.getByText('1/2 providers')).toBeInTheDocument();
358 |       expect(screen.queryByText('Provider Health')).not.toBeInTheDocument();
359 |       expect(screen.queryByTestId('card-header')).not.toBeInTheDocument();
360 |     });
361 | 
362 |     test('dialog mode shows header without card wrapper', () => {
363 |       render(<ProviderHealthDashboard dialogMode />);
364 |       
365 |       expect(screen.getByText('Provider Status (1/2)')).toBeInTheDocument();
366 |       expect(screen.getByText('Real-time health monitoring of AI model providers')).toBeInTheDocument();
367 |       expect(screen.queryByTestId('card-title')).not.toBeInTheDocument();
368 |     });
369 | 
370 |     test('default mode shows full card layout', () => {
371 |       render(<ProviderHealthDashboard />);
372 |       
373 |       expect(screen.getAllByTestId('card')).toHaveLength(3); // Main card + 2 provider cards
374 |       expect(screen.getAllByTestId('card-header')).toHaveLength(3); // Main header + 2 provider headers
375 |       expect(screen.getAllByTestId('card-content')).toHaveLength(3); // Main content + 2 provider contents
376 |       expect(screen.getByTestId('card-title')).toHaveTextContent('Provider Health');
377 |     });
378 |   });
379 | 
380 |   describe('Data Display and Formatting', () => {
381 |     test('displays provider cards with correct information', () => {
382 |       render(<ProviderHealthDashboard />);
383 |       
384 |       expect(screen.getAllByText('OpenRouter')).toHaveLength(2); // Name + badge
385 |       expect(screen.getAllByText('Anthropic')).toHaveLength(2); // Name + badge
386 |       expect(screen.getByText('150')).toBeInTheDocument(); // Model count
387 |       expect(screen.getByText('5')).toBeInTheDocument(); // Model count
388 |     });
389 | 
390 |     test('displays correct health indicators for each provider', () => {
391 |       render(<ProviderHealthDashboard />);
392 |       
393 |       expect(screen.getAllByTestId('check-circle-icon')).toHaveLength(2); // Overall + provider healthy status
394 |       expect(screen.getByTestId('alert-triangle-icon')).toBeInTheDocument(); // Degraded status
395 |     });
396 | 
397 |     test('displays provider badges with correct styling', () => {
398 |       render(<ProviderHealthDashboard />);
399 |       
400 |       // Check that badges are present for both providers
401 |       expect(screen.getAllByTestId('badge')).toHaveLength(5); // 2 model counts + 3 API key badges (ENV + 2 User)
402 |     });
403 | 
404 |     test('displays API key information correctly', () => {
405 |       render(<ProviderHealthDashboard />);
406 |       
407 |       expect(screen.getByText('ENV')).toBeInTheDocument();
408 |       expect(screen.getAllByText('User')).toHaveLength(2);
409 |     });
410 | 
411 |     test('displays error messages when provider has errors', () => {
412 |       render(<ProviderHealthDashboard />);
413 |       
414 |       expect(screen.getByText('Rate limit exceeded')).toBeInTheDocument();
415 |       expect(screen.getByTestId('alert-circle-icon')).toBeInTheDocument();
416 |     });
417 | 
418 |     test('formats time correctly', () => {
419 |       render(<ProviderHealthDashboard />);
420 |       
421 |       // The formatTime function in the component handles relative time formatting
422 |       // Check for the specific formatted date output
423 |       expect(screen.getAllByText('1/1/2024')).toHaveLength(3); // lastUpdated + 2 provider lastChecked
424 |     });
425 | 
426 |     test('displays overall status correctly', () => {
427 |       render(<ProviderHealthDashboard />);
428 |       
429 |       expect(screen.getByText('Overall Status')).toBeInTheDocument();
430 |       expect(screen.getByText('1 of 2 providers operational')).toBeInTheDocument();
431 |     });
432 |   });
433 | 
434 |   describe('Error Handling', () => {
435 |     test('displays error state when hook returns error', () => {
436 |       mockUseProviderHealth.mockReturnValue({
437 |         ...defaultHealthData,
438 |         error: new Error('Failed to fetch provider data'),
439 |       });
440 | 
441 |       render(<ProviderHealthDashboard />);
442 |       
443 |       expect(screen.getByText('Failed to load provider health')).toBeInTheDocument();
444 |       expect(screen.getByTestId('alert-circle-icon')).toBeInTheDocument();
445 |       expect(screen.getByText('Retry')).toBeInTheDocument();
446 |     });
447 | 
448 |     test('handles invalid health status gracefully', () => {
449 |       mockUseProviderHealth.mockReturnValue({
450 |         ...defaultHealthData,
451 |         overall: 'invalid-status' as any,
452 |         providers: {
453 |           test: {
454 |             ...defaultHealthData.providers.openrouter,
455 |             status: 'invalid-status' as any,
456 |           },
457 |         },
458 |       });
459 | 
460 |       render(<ProviderHealthDashboard />);
461 |       
462 |       // Should default to 'unknown' status
463 |       expect(screen.getAllByTestId('help-circle-icon')).toHaveLength(2); // Overall + provider status
464 |       expect(screen.getAllByText('Unknown')).toHaveLength(2);
465 |     });
466 | 
467 |     test('retry button works in error state', () => {
468 |       mockUseProviderHealth.mockReturnValue({
469 |         ...defaultHealthData,
470 |         error: new Error('Failed to fetch provider data'),
471 |       });
472 | 
473 |       render(<ProviderHealthDashboard />);
474 |       
475 |       const retryButton = screen.getByText('Retry');
476 |       fireEvent.click(retryButton);
477 |       
478 |       expect(mockClearCache).toHaveBeenCalledTimes(1);
479 |     });
480 |   });
481 | 
482 |   describe('Accessibility', () => {
483 |     test('has proper tooltip content for refresh button', () => {
484 |       render(<ProviderHealthDashboard />);
485 |       
486 |       expect(screen.getByText('Force refresh all provider data')).toBeInTheDocument();
487 |     });
488 | 
489 |     test('compact mode has tooltip for refresh button', () => {
490 |       render(<ProviderHealthDashboard compact />);
491 |       
492 |       expect(screen.getByText('Refresh provider data')).toBeInTheDocument();
493 |     });
494 | 
495 |     test('displays appropriate ARIA attributes through components', () => {
496 |       render(<ProviderHealthDashboard />);
497 |       
498 |       const refreshButton = screen.getByTestId('button-outline');
499 |       expect(refreshButton).not.toBeDisabled();
500 |     });
501 | 
502 |     test('error messages are properly displayed for screen readers', () => {
503 |       render(<ProviderHealthDashboard />);
504 |       
505 |       const errorText = screen.getByText('Rate limit exceeded');
506 |       expect(errorText).toHaveAttribute('title', 'Rate limit exceeded');
507 |     });
508 |   });
509 | 
510 |   describe('Integration Tests', () => {
511 |     test('complete workflow: load data, show providers, refresh data', async () => {
512 |       render(<ProviderHealthDashboard />);
513 |       
514 |       // Initial data is loaded
515 |       expect(screen.getAllByText('OpenRouter')).toHaveLength(2); // Name + badge
516 |       expect(screen.getAllByText('Anthropic')).toHaveLength(2); // Name + badge
517 |       expect(screen.getByText('1 of 2 providers operational')).toBeInTheDocument();
518 |       
519 |       // User clicks refresh
520 |       const refreshButton = screen.getByTestId('button-outline');
521 |       fireEvent.click(refreshButton);
522 |       
523 |       // Cache clear is called
524 |       expect(mockClearCache).toHaveBeenCalledTimes(1);
525 |     });
526 | 
527 |     test('handles mode switching correctly', () => {
528 |       const { rerender } = render(<ProviderHealthDashboard />);
529 |       
530 |       // Full mode
531 |       expect(screen.getByTestId('card-title')).toBeInTheDocument();
532 |       
533 |       // Switch to compact mode
534 |       rerender(<ProviderHealthDashboard compact />);
535 |       expect(screen.queryByTestId('card-title')).not.toBeInTheDocument();
536 |       expect(screen.getByText('1/2 providers')).toBeInTheDocument();
537 |       
538 |       // Switch to dialog mode
539 |       rerender(<ProviderHealthDashboard dialogMode />);
540 |       expect(screen.getByText('Provider Status (1/2)')).toBeInTheDocument();
541 |     });
542 |   });
543 | 
544 |   describe('Edge Cases', () => {
545 |     test('handles empty providers object', () => {
546 |       mockUseProviderHealth.mockReturnValue({
547 |         ...defaultHealthData,
548 |         providers: {},
549 |         totalCount: 0,
550 |         healthyCount: 0,
551 |       });
552 | 
553 |       render(<ProviderHealthDashboard />);
554 |       
555 |       expect(screen.getByText('No Provider Data Available')).toBeInTheDocument();
556 |     });
557 | 
558 |     test('handles missing lastUpdated', () => {
559 |       mockUseProviderHealth.mockReturnValue({
560 |         ...defaultHealthData,
561 |         lastUpdated: null,
562 |       });
563 | 
564 |       render(<ProviderHealthDashboard />);
565 |       
566 |       expect(screen.queryByTestId('clock-icon')).not.toBeInTheDocument();
567 |     });
568 | 
569 |     test('handles providers without errors', () => {
570 |       const providersWithoutErrors = {
571 |         openrouter: {
572 |           ...defaultHealthData.providers.openrouter,
[TRUNCATED]
```

__tests__/components/suggested-prompts.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';
3 | import { SuggestedPrompts, SuggestedAction } from '../../components/suggested-prompts';
4 | 
5 | // Mock the motion components
6 | jest.mock('motion/react', () => ({
7 |   motion: {
8 |     div: ({ children, initial, animate, exit, transition, ...props }: any) => (
9 |       <div {...props}>{children}</div>
10 |     ),
11 |   },
12 |   AnimatePresence: ({ children }: any) => <>{children}</>,
13 | }));
14 | 
15 | // Mock UI components with proper prop forwarding
16 | jest.mock('../../components/ui/button', () => ({
17 |   Button: ({ children, onClick, onKeyDown, variant, size, className, disabled, ...props }: any) => (
18 |     <button 
19 |       onClick={onClick} 
20 |       onKeyDown={onKeyDown} 
21 |       className={className}
22 |       disabled={disabled}
23 |       data-variant={variant}
24 |       data-size={size}
25 |       data-testid={`button-${variant || 'default'}`}
26 |       {...props}
27 |     >
28 |       {children}
29 |     </button>
30 |   ),
31 | }));
32 | 
33 | jest.mock('../../components/ui/badge', () => ({
34 |   Badge: ({ children, variant, className, ...props }: any) => (
35 |     <span 
36 |       className={className} 
37 |       data-variant={variant}
38 |       data-testid="category-badge"
39 |       {...props}
40 |     >
41 |       {children}
42 |     </span>
43 |   ),
44 | }));
45 | 
46 | jest.mock('../../components/ui/input', () => ({
47 |   Input: ({ type, placeholder, value, onChange, className, ...props }: any) => (
48 |     <input
49 |       type={type}
50 |       placeholder={placeholder}
51 |       value={value}
52 |       onChange={onChange}
53 |       className={className}
54 |       data-testid="search-input"
55 |       {...props}
56 |     />
57 |   ),
58 | }));
59 | 
60 | // Mock the utility functions
61 | jest.mock('../../lib/suggested-prompts-utils', () => ({
62 |   getContextualSuggestions: jest.fn(),
63 |   getCategoryColor: jest.fn(() => 'bg-blue-100 text-blue-800'),
64 | }));
65 | 
66 | describe('SuggestedPrompts Component', () => {
67 |   const mockSendMessage = jest.fn();
68 |   const mockGetContextualSuggestions = require('../../lib/suggested-prompts-utils').getContextualSuggestions as jest.MockedFunction<any>;
69 |   const mockGetCategoryColor = require('../../lib/suggested-prompts-utils').getCategoryColor as jest.MockedFunction<any>;
70 |   
71 |   const customSuggestions: SuggestedAction[] = [
72 |     {
73 |       title: "Debug code",
74 |       label: "and explain the issue",
75 |       action: "Debug this code and explain what's wrong",
76 |       category: "coding",
77 |       icon: <div>Code Icon</div>
78 |     },
79 |     {
80 |       title: "Write tests",
81 |       label: "for this function",
82 |       action: "Write comprehensive tests for this function",
83 |       category: "testing",
84 |       icon: <div>Test Icon</div>
85 |     },
86 |     {
87 |       title: "Explain concept",
88 |       label: "in simple terms",
89 |       action: "Explain this concept in simple terms",
90 |       category: "learning",
91 |       icon: <div>Learn Icon</div>
92 |     },
93 |     {
94 |       title: "Optimize performance",
95 |       label: "of this code",
96 |       action: "Optimize the performance of this code",
97 |       category: "optimization",
98 |       icon: <div>Speed Icon</div>
99 |     },
100 |     {
101 |       title: "Create documentation",
102 |       label: "with examples",
103 |       action: "Create documentation with examples",
104 |       category: "documentation",
105 |       icon: <div>Doc Icon</div>
106 |     },
107 |     {
108 |       title: "Brainstorm ideas",
109 |       label: "for new features",
110 |       action: "Brainstorm ideas for new features",
111 |       category: "creative",
112 |       icon: <div>Creative Icon</div>
113 |     },
114 |   ];
115 | 
116 |   beforeEach(() => {
117 |     jest.clearAllMocks();
118 |     mockGetContextualSuggestions.mockReturnValue(customSuggestions);
119 |     mockGetCategoryColor.mockReturnValue('bg-blue-100 text-blue-800');
120 |   });
121 | 
122 |   afterEach(() => {
123 |     cleanup();
124 |   });
125 | 
126 |   // Tests for Basic Rendering and Props
127 |   describe('Basic Rendering and Props', () => {
128 |     test('renders with default suggestions when no suggestions provided', () => {
129 |       render(<SuggestedPrompts sendMessage={mockSendMessage} />);
130 |       
131 |       // When no selectedModel is provided, component uses getContextualSuggestions with undefined model
132 |       expect(mockGetContextualSuggestions).toHaveBeenCalledWith(undefined);
133 |       expect(screen.getByTestId('suggested-actions')).toBeInTheDocument();
134 |       expect(screen.getByTestId('search-input')).toBeInTheDocument();
135 |     });
136 | 
137 |     test('renders with custom suggestions when provided', () => {
138 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
139 |       
140 |       expect(screen.getByText('Debug code')).toBeInTheDocument();
141 |       expect(screen.getByText('and explain the issue')).toBeInTheDocument();
142 |       expect(screen.getByText('Write tests')).toBeInTheDocument();
143 |       expect(screen.getByText('for this function')).toBeInTheDocument();
144 |     });
145 | 
146 |     test('limits suggestions based on maxSuggestions prop', () => {
147 |       render(
148 |         <SuggestedPrompts 
149 |           sendMessage={mockSendMessage} 
150 |           suggestions={customSuggestions} 
151 |           maxSuggestions={2} 
152 |         />
153 |       );
154 |       
155 |       const buttons = screen.getAllByRole('button').filter(btn => 
156 |         btn.getAttribute('aria-label')?.includes('Send message:')
157 |       );
158 |       expect(buttons).toHaveLength(2);
159 |       expect(screen.getByText('Debug code')).toBeInTheDocument();
160 |       expect(screen.getByText('Write tests')).toBeInTheDocument();
161 |       expect(screen.queryByText('Explain concept')).not.toBeInTheDocument();
162 |     });
163 | 
164 |     test('uses default maxSuggestions of 4 when not provided', () => {
165 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
166 |       
167 |       const buttons = screen.getAllByRole('button').filter(btn => 
168 |         btn.getAttribute('aria-label')?.includes('Send message:')
169 |       );
170 |       expect(buttons).toHaveLength(4);
171 |     });
172 | 
173 |     test('renders with contextual suggestions based on selectedModel', () => {
174 |       render(
175 |         <SuggestedPrompts 
176 |           sendMessage={mockSendMessage} 
177 |           selectedModel="gpt-4" 
178 |         />
179 |       );
180 |       
181 |       expect(mockGetContextualSuggestions).toHaveBeenCalledWith('gpt-4');
182 |     });
183 | 
184 |     test('shows model context hint when selectedModel is provided', () => {
185 |       render(
186 |         <SuggestedPrompts 
187 |           sendMessage={mockSendMessage} 
188 |           selectedModel="claude-3-opus" 
189 |         />
190 |       );
191 |       
192 |       expect(screen.getByText(/Suggestions optimized for claude-3-opus/i)).toBeInTheDocument();
193 |     });
194 |   });
195 | 
196 |   // Tests for Search Functionality  
197 |   describe('Search Functionality', () => {
198 |     test('renders search input with proper attributes', () => {
199 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
200 |       
201 |       const searchInput = screen.getByTestId('search-input');
202 |       expect(searchInput).toHaveAttribute('type', 'text');
203 |       expect(searchInput).toHaveAttribute('placeholder', 'Search suggestions...');
204 |     });
205 | 
206 |     test('filters suggestions based on search query', () => {
207 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
208 |       
209 |       const searchInput = screen.getByTestId('search-input');
210 |       fireEvent.change(searchInput, { target: { value: 'debug' } });
211 |       
212 |       expect(screen.getByText('Debug code')).toBeInTheDocument();
213 |       expect(screen.queryByText('Write tests')).not.toBeInTheDocument();
214 |       expect(screen.queryByText('Explain concept')).not.toBeInTheDocument();
215 |     });
216 | 
217 |     test('shows clear search button when search query is present', () => {
218 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
219 |       
220 |       const searchInput = screen.getByTestId('search-input');
221 |       fireEvent.change(searchInput, { target: { value: 'test' } });
222 |       
223 |       const clearButton = screen.getByRole('button', { name: 'Clear search' });
224 |       expect(clearButton).toBeInTheDocument();
225 |     });
226 | 
227 |     test('clears search when clear button is clicked', () => {
228 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
229 |       
230 |       const searchInput = screen.getByTestId('search-input');
231 |       fireEvent.change(searchInput, { target: { value: 'test' } });
232 |       
233 |       const clearButton = screen.getByRole('button', { name: 'Clear search' });
234 |       fireEvent.click(clearButton);
235 |       
236 |       expect(searchInput).toHaveValue('');
237 |     });
238 | 
239 |     test('shows empty state when no suggestions match search', () => {
240 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
241 |       
242 |       const searchInput = screen.getByTestId('search-input');
243 |       fireEvent.change(searchInput, { target: { value: 'nonexistent' } });
244 |       
245 |       expect(screen.getByText(/No suggestions found matching your criteria/i)).toBeInTheDocument();
246 |       expect(screen.getByText(/Try adjusting your search or selecting a different category/i)).toBeInTheDocument();
247 |     });
248 | 
249 |     test('searches across title, label, action, and category fields', () => {
250 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
251 |       
252 |       const searchInput = screen.getByTestId('search-input');
253 |       
254 |       // Search by category
255 |       fireEvent.change(searchInput, { target: { value: 'coding' } });
256 |       expect(screen.getByText('Debug code')).toBeInTheDocument();
257 |       
258 |       // Search by label
259 |       fireEvent.change(searchInput, { target: { value: 'performance' } });
260 |       expect(screen.getByText('Optimize performance')).toBeInTheDocument();
261 |       
262 |       // Search by action text
263 |       fireEvent.change(searchInput, { target: { value: 'comprehensive' } });
264 |       expect(screen.getByText('Write tests')).toBeInTheDocument();
265 |     });
266 |   });
267 | 
268 |   // Tests for Category Filtering
269 |   describe('Category Filtering', () => {
270 |     test('renders category filter buttons when showCategories is true', () => {
271 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} showCategories={true} />);
272 |       
273 |       expect(screen.getByRole('button', { name: /All/i })).toBeInTheDocument();
274 |       expect(screen.getByRole('button', { name: /coding/i })).toBeInTheDocument();
275 |       expect(screen.getByRole('button', { name: /testing/i })).toBeInTheDocument();
276 |     });
277 | 
278 |     test('does not render category filters when showCategories is false', () => {
279 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} showCategories={false} />);
280 |       
281 |       expect(screen.queryByRole('button', { name: /All/i })).not.toBeInTheDocument();
282 |       expect(screen.queryByRole('button', { name: /coding/i })).not.toBeInTheDocument();
283 |     });
284 | 
285 |     test('filters suggestions by selected category', () => {
286 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
287 |       
288 |       const codingButton = screen.getByRole('button', { name: /coding/i });
289 |       fireEvent.click(codingButton);
290 |       
291 |       expect(screen.getByText('Debug code')).toBeInTheDocument();
292 |       expect(screen.queryByText('Write tests')).not.toBeInTheDocument();
293 |       expect(screen.queryByText('Explain concept')).not.toBeInTheDocument();
294 |     });
295 | 
296 |     test('shows all suggestions when "All" category is selected', () => {
297 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
298 |       
299 |       // First select a specific category
300 |       const codingButton = screen.getByRole('button', { name: /coding/i });
301 |       fireEvent.click(codingButton);
302 |       
303 |       // Then click "All" to show all suggestions
304 |       const allButton = screen.getByRole('button', { name: /All/i });
305 |       fireEvent.click(allButton);
306 |       
307 |       expect(screen.getByText('Debug code')).toBeInTheDocument();
308 |       expect(screen.getByText('Write tests')).toBeInTheDocument();
309 |       expect(screen.getByText('Explain concept')).toBeInTheDocument();
310 |     });
311 | 
312 |     test('renders category badges when showCategories is true', () => {
313 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} showCategories={true} />);
314 |       
315 |       const badges = screen.getAllByTestId('category-badge');
316 |       expect(badges.length).toBeGreaterThan(0);
317 |       expect(mockGetCategoryColor).toHaveBeenCalled();
318 |     });
319 |   });
320 | 
321 |   // Tests for Show More/Show Less Functionality
322 |   describe('Show More/Show Less Functionality', () => {
323 |     test('shows "Show More" button when there are more suggestions than maxSuggestions', () => {
324 |       render(
325 |         <SuggestedPrompts 
326 |           sendMessage={mockSendMessage} 
327 |           suggestions={customSuggestions} 
328 |           maxSuggestions={3} 
329 |         />
330 |       );
331 |       
332 |       expect(screen.getByRole('button', { name: /Show More \(3 more\)/i })).toBeInTheDocument();
333 |     });
334 | 
335 |     test('does not show "Show More" button when suggestions are within limit', () => {
336 |       render(
337 |         <SuggestedPrompts 
338 |           sendMessage={mockSendMessage} 
339 |           suggestions={customSuggestions.slice(0, 2)} 
340 |           maxSuggestions={4} 
341 |         />
342 |       );
343 |       
344 |       expect(screen.queryByRole('button', { name: /Show More/i })).not.toBeInTheDocument();
345 |     });
346 | 
347 |     test('expands suggestions when "Show More" is clicked', () => {
348 |       render(
349 |         <SuggestedPrompts 
350 |           sendMessage={mockSendMessage} 
351 |           suggestions={customSuggestions} 
352 |           maxSuggestions={3} 
353 |         />
354 |       );
355 |       
356 |       const showMoreButton = screen.getByRole('button', { name: /Show More/i });
357 |       fireEvent.click(showMoreButton);
358 |       
359 |       const suggestionButtons = screen.getAllByRole('button').filter(btn => 
360 |         btn.getAttribute('aria-label')?.includes('Send message:')
361 |       );
362 |       expect(suggestionButtons).toHaveLength(6); // Shows double the maxSuggestions
363 |     });
364 | 
365 |     test('changes to "Show Less" after expanding', () => {
366 |       render(
367 |         <SuggestedPrompts 
368 |           sendMessage={mockSendMessage} 
369 |           suggestions={customSuggestions} 
370 |           maxSuggestions={3} 
371 |         />
372 |       );
373 |       
374 |       const showMoreButton = screen.getByRole('button', { name: /Show More/i });
375 |       fireEvent.click(showMoreButton);
376 |       
377 |       expect(screen.getByRole('button', { name: /Show Less/i })).toBeInTheDocument();
378 |     });
379 | 
380 |     test('hides "Show More" button when search is active', () => {
381 |       render(
382 |         <SuggestedPrompts 
383 |           sendMessage={mockSendMessage} 
384 |           suggestions={customSuggestions} 
385 |           maxSuggestions={3} 
386 |         />
387 |       );
388 |       
389 |       // First confirm the button exists
390 |       expect(screen.getByRole('button', { name: /Show More/i })).toBeInTheDocument();
391 |       
392 |       // Search for something
393 |       const searchInput = screen.getByTestId('search-input');
394 |       fireEvent.change(searchInput, { target: { value: 'debug' } });
395 |       
396 |       // Show More button should be hidden
397 |       expect(screen.queryByRole('button', { name: /Show More/i })).not.toBeInTheDocument();
398 |     });
399 |   });
400 | 
401 |   // Tests for User Interactions
402 |   describe('User Interactions', () => {
403 |     test('calls sendMessage when suggestion button is clicked', () => {
404 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
405 |       
406 |       const debugButton = screen.getByRole('button', { name: /Send message: Debug this code and explain what's wrong/i });
407 |       fireEvent.click(debugButton);
408 |       
409 |       expect(mockSendMessage).toHaveBeenCalledWith("Debug this code and explain what's wrong");
410 |     });
411 | 
412 |     test('handles keyboard navigation with Enter key', () => {
413 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
414 |       
415 |       const firstButton = screen.getAllByRole('button').find(btn => 
416 |         btn.getAttribute('aria-label')?.includes('Send message:')
417 |       )!;
418 |       
419 |       fireEvent.keyDown(firstButton, { key: 'Enter' });
420 |       expect(mockSendMessage).toHaveBeenCalledWith("Debug this code and explain what's wrong");
421 |     });
422 | 
423 |     test('handles keyboard navigation with Space key', () => {
424 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
425 |       
426 |       const firstButton = screen.getAllByRole('button').find(btn => 
427 |         btn.getAttribute('aria-label')?.includes('Send message:')
428 |       )!;
429 |       
430 |       fireEvent.keyDown(firstButton, { key: ' ' });
431 |       expect(mockSendMessage).toHaveBeenCalledWith("Debug this code and explain what's wrong");
432 |     });
433 | 
434 |     test('disables buttons during animation state', async () => {
435 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
436 |       
437 |       const firstButton = screen.getAllByRole('button').find(btn => 
438 |         btn.getAttribute('aria-label')?.includes('Send message:')
439 |       )!;
440 |       
441 |       fireEvent.click(firstButton);
442 |       
443 |       // Button should be disabled during animation
444 |       expect(firstButton).toBeDisabled();
445 |       
446 |       // Wait for animation to complete
447 |       await waitFor(() => {
448 |         expect(firstButton).not.toBeDisabled();
449 |       }, { timeout: 500 });
450 |     });
451 |   });
452 | 
453 |   // Tests for Accessibility
454 |   describe('Accessibility', () => {
455 |     test('has proper ARIA attributes on container', () => {
456 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
457 |       
458 |       const container = screen.getByTestId('suggested-actions');
459 |       expect(container).toHaveAttribute('role', 'group');
460 |       expect(container).toHaveAttribute('aria-label', 'Suggested prompts');
461 |     });
462 | 
463 |     test('suggestion buttons have proper ARIA labels', () => {
464 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
465 |       
466 |       const buttons = screen.getAllByRole('button').filter(btn => 
467 |         btn.getAttribute('aria-label')?.includes('Send message:')
468 |       );
469 |       
470 |       expect(buttons[0]).toHaveAttribute('aria-label', 'Send message: Debug this code and explain what\'s wrong');
471 |       expect(buttons[1]).toHaveAttribute('aria-label', 'Send message: Write comprehensive tests for this function');
472 |     });
473 | 
474 |     test('buttons have proper role and tabindex attributes', () => {
475 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
476 |       
477 |       const buttons = screen.getAllByRole('button').filter(btn => 
478 |         btn.getAttribute('aria-label')?.includes('Send message:')
479 |       );
480 |       
481 |       buttons.forEach(button => {
482 |         expect(button).toHaveAttribute('role', 'button');
483 |         expect(button).toHaveAttribute('tabIndex', '0');
484 |       });
485 |     });
486 | 
487 |     test('clear search button has proper accessibility label', () => {
488 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={customSuggestions} />);
489 |       
490 |       const searchInput = screen.getByTestId('search-input');
491 |       fireEvent.change(searchInput, { target: { value: 'test' } });
492 |       
493 |       const clearButton = screen.getByRole('button', { name: 'Clear search' });
494 |       expect(clearButton).toHaveAttribute('aria-label', 'Clear search');
495 |     });
496 |   });
497 | 
498 |   // Tests for Error Handling
499 |   describe('Error Handling', () => {
500 |     test('handles empty suggestions array gracefully', () => {
501 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={[]} />);
502 |       
503 |       expect(screen.getByText(/No suggestions found matching your criteria/i)).toBeInTheDocument();
504 |     });
505 | 
506 |     test('handles missing icon gracefully', () => {
507 |       const suggestionsWithoutIcon = [
508 |         {
509 |           title: "Test suggestion",
510 |           label: "without icon",
511 |           action: "Test action",
512 |           category: "test"
513 |         }
514 |       ];
515 |       
516 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={suggestionsWithoutIcon} />);
517 |       
518 |       expect(screen.getByText('Test suggestion')).toBeInTheDocument();
519 |     });
520 | 
521 |     test('handles missing category gracefully', () => {
522 |       const suggestionsWithoutCategory = [
523 |         {
524 |           title: "Test suggestion",
525 |           label: "without category",
526 |           action: "Test action"
527 |         }
528 |       ];
529 |       
530 |       render(<SuggestedPrompts sendMessage={mockSendMessage} suggestions={suggestionsWithoutCategory} />);
531 |       
532 |       expect(screen.getByText('Test suggestion')).toBeInTheDocument();
533 |     });
534 |   });
535 | 
536 |   // Tests for Performance
537 |   describe('Performance', () => {
538 |     test('efficiently handles large datasets', () => {
539 |       const largeSuggestions = Array(100).fill(null).map((_, i) => ({
540 |         title: `Title ${i}`,
541 |         label: `Label ${i}`,
542 |         action: `Action ${i}`,
543 |         category: 'test'
544 |       }));
545 |       
546 |       render(
547 |         <SuggestedPrompts 
548 |           sendMessage={mockSendMessage} 
549 |           suggestions={largeSuggestions} 
550 |           maxSuggestions={5} 
551 |         />
552 |       );
553 |       
554 |       const buttons = screen.getAllByRole('button').filter(btn => 
555 |         btn.getAttribute('aria-label')?.includes('Send message:')
556 |       );
557 |       expect(buttons).toHaveLength(5);
558 |     });
559 | 
560 |     test('component memoization prevents unnecessary re-renders', () => {
561 |       const { rerender } = render(
562 |         <SuggestedPrompts 
563 |           sendMessage={mockSendMessage} 
564 |           suggestions={customSuggestions} 
565 |           maxSuggestions={4} 
566 |         />
567 |       );
568 |       
569 |       // Re-render with same props should not cause issues
570 |       rerender(
[TRUNCATED]
```

__tests__/components/textarea.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { Textarea } from '../../components/textarea';
4 | import type { modelID } from '@/ai/providers';
5 | import type { ImageAttachment } from '@/lib/types';
6 | 
7 | // Mock external dependencies
8 | const mockSetWebSearchEnabled = jest.fn();
9 | const mockSetSelectedModel = jest.fn();
10 | const mockHandleInputChange = jest.fn();
11 | const mockStop = jest.fn();
12 | const mockOnImagesChange = jest.fn();
13 | 
14 | // Mock context hooks with proper hoisting
15 | jest.mock('@/lib/context/web-search-context', () => ({
16 |   useWebSearch: jest.fn(() => ({
17 |     webSearchEnabled: false,
18 |     setWebSearchEnabled: jest.fn(),
19 |   })),
20 | }));
21 | 
22 | jest.mock('@/lib/context/preset-context', () => ({
23 |   usePresets: jest.fn(() => ({
24 |     activePreset: null,
25 |   })),
26 | }));
27 | 
28 | jest.mock('@/hooks/useAuth', () => ({
29 |   useAuth: jest.fn(() => ({
30 |     user: {
31 |       credits: 100,
32 |       hasCredits: true,
33 |       isAnonymous: false,
34 |     },
35 |   })),
36 | }));
37 | 
38 | jest.mock('@/hooks/use-mobile', () => ({
39 |   useIsMobile: jest.fn(() => false),
40 | }));
41 | 
42 | jest.mock('@/hooks/use-models', () => ({
43 |   useModels: () => ({
44 |     models: [
45 |       { id: 'openrouter/test-model', vision: true },
46 |       { id: 'claude-3-haiku', vision: false },
47 |     ],
48 |   }),
49 | }));
50 | 
51 | jest.mock('@/lib/hooks/use-client-mount', () => ({
52 |   useClientMount: () => true,
53 | }));
54 | 
55 | // Mock UI components
56 | jest.mock('../../components/ui/textarea', () => ({
57 |   Textarea: ({ children, ...props }: any) => (
58 |     <textarea data-testid="textarea" {...props}>
59 |       {children}
60 |     </textarea>
61 |   ),
62 | }));
63 | 
64 | jest.mock('../../components/ui/tooltip', () => ({
65 |   Tooltip: ({ children }: any) => <div data-testid="tooltip">{children}</div>,
66 |   TooltipTrigger: ({ children }: any) => <div data-testid="tooltip-trigger">{children}</div>,
67 |   TooltipContent: ({ children }: any) => <div data-testid="tooltip-content">{children}</div>,
68 | }));
69 | 
70 | jest.mock('../../components/ui/button', () => ({
71 |   Button: ({ children, onClick, disabled, type, variant, size, className, ...props }: any) => (
72 |     <button
73 |       onClick={onClick}
74 |       disabled={disabled}
75 |       type={type}
76 |       className={className}
77 |       data-variant={variant}
78 |       data-size={size}
79 |       data-testid={`button-${variant || 'default'}`}
80 |       {...props}
81 |     >
82 |       {children}
83 |     </button>
84 |   ),
85 | }));
86 | 
87 | jest.mock('../../components/model-picker', () => ({
88 |   ModelPicker: ({ selectedModel, setSelectedModel, onModelSelected, disabled }: any) => (
89 |     <select
90 |       data-testid="model-picker"
91 |       value={selectedModel}
92 |       onChange={(e) => setSelectedModel(e.target.value)}
93 |       onBlur={onModelSelected}
94 |       disabled={disabled}
95 |     >
96 |       <option value="openrouter/test-model">Test Model</option>
97 |       <option value="claude-3-haiku">Claude Haiku</option>
98 |     </select>
99 |   ),
100 | }));
101 | 
102 | jest.mock('../../components/preset-selector', () => ({
103 |   PresetSelector: ({ className }: any) => (
104 |     <div data-testid="preset-selector" className={className}>
105 |       Preset Selector
106 |     </div>
107 |   ),
108 | }));
109 | 
110 | jest.mock('../../components/image-upload', () => ({
111 |   ImageUpload: ({ onImageSelect, maxFiles, disabled, showDetailSelector }: any) => (
112 |     <div data-testid="image-upload">
113 |       <button
114 |         data-testid="image-upload-button"
115 |         onClick={() => onImageSelect([{ id: '1', url: 'test.jpg' }])}
116 |         disabled={disabled}
117 |       >
118 |         Upload Images (max: {maxFiles})
119 |       </button>
120 |     </div>
121 |   ),
122 | }));
123 | 
124 | jest.mock('../../components/image-preview', () => ({
125 |   ImagePreview: ({ images, onRemove, maxWidth, maxHeight, className }: any) => (
126 |     <div data-testid="image-preview" className={className}>
127 |       {images.map((image: any, index: number) => (
128 |         <div key={image.id} data-testid={`image-${index}`}>
129 |           <img src={image.url} alt="preview" width={maxWidth} height={maxHeight} />
130 |           <button
131 |             data-testid={`remove-image-${index}`}
132 |             onClick={() => onRemove(index)}
133 |           >
134 |             Remove
135 |           </button>
136 |         </div>
137 |       ))}
138 |     </div>
139 |   ),
140 | }));
141 | 
142 | // Mock text processing utilities
143 | jest.mock('@/lib/text-utils', () => ({
144 |   processTextInput: jest.fn((text, options = {}) => ({
145 |     processedText: text,
146 |     isCode: text.includes('function') || text.includes('console.log'),
147 |     confidence: text.includes('function') ? 85 : 20,
148 |     language: text.includes('function') ? 'javascript' : null,
149 |     wasWrapped: options.autoWrapCode && text.includes('function'),
150 |     reasons: ['function keyword detected'],
151 |   })),
152 |   processKeyboardInput: jest.fn((key, text, cursor, language) => ({
153 |     shouldPreventDefault: false,
154 |     newText: text,
155 |     newCursorPosition: cursor,
156 |   })),
157 |   expandCodeSnippet: jest.fn((word, language) => {
158 |     if (word === 'fn' && language === 'javascript') {
159 |       return 'function ${1:name}() {\n  ${2:// body}\n}';
160 |     }
161 |     return null;
162 |   }),
163 |   cleanupCodeStructure: jest.fn((text) => text),
164 | }));
165 | 
166 | // Mock constants
167 | jest.mock('@/lib/tokenCounter', () => ({
168 |   WEB_SEARCH_COST: 5,
169 | }));
170 | 
171 | describe('Textarea', () => {
172 |   const defaultProps = {
173 |     input: '',
174 |     handleInputChange: mockHandleInputChange,
175 |     isLoading: false,
176 |     status: 'idle',
177 |     stop: mockStop,
178 |     selectedModel: 'openrouter/test-model' as modelID,
179 |     setSelectedModel: mockSetSelectedModel,
180 |     images: [],
181 |     onImagesChange: mockOnImagesChange,
182 |   };
183 | 
184 |   beforeEach(() => {
185 |     jest.clearAllMocks();
186 |     
187 |     // Reset all mocks to default state
188 |     const { useWebSearch } = require('@/lib/context/web-search-context');
189 |     const { usePresets } = require('@/lib/context/preset-context');
190 |     const { useAuth } = require('@/hooks/useAuth');
191 |     const { useIsMobile } = require('@/hooks/use-mobile');
192 |     
193 |     useWebSearch.mockReturnValue({
194 |       webSearchEnabled: false,
195 |       setWebSearchEnabled: mockSetWebSearchEnabled,
196 |     });
197 |     
198 |     usePresets.mockReturnValue({
199 |       activePreset: null,
200 |     });
201 |     
202 |     useAuth.mockReturnValue({
203 |       user: {
204 |         credits: 100,
205 |         hasCredits: true,
206 |         isAnonymous: false,
207 |       },
208 |     });
209 |     
210 |     useIsMobile.mockReturnValue(false);
211 |   });
212 | 
213 |   describe('Basic Rendering and Props', () => {
214 |     test('renders with default props', () => {
215 |       render(<Textarea {...defaultProps} />);
216 |       
217 |       expect(screen.getByTestId('textarea')).toBeInTheDocument();
218 |       expect(screen.getByTestId('preset-selector')).toBeInTheDocument();
219 |       expect(screen.getByTestId('model-picker')).toBeInTheDocument();
220 |       expect(screen.getByRole('button', { name: /send/i })).toBeInTheDocument();
221 |     });
222 | 
223 |     test('renders with custom input value', () => {
224 |       render(<Textarea {...defaultProps} input="Hello world" />);
225 |       
226 |       const textarea = screen.getByTestId('textarea');
227 |       expect(textarea).toHaveValue('Hello world');
228 |     });
229 | 
230 |     test('changes placeholder when images are present', () => {
231 |       const images: ImageAttachment[] = [{ id: '1', url: 'test.jpg', detail: 'auto' }];
232 |       render(<Textarea {...defaultProps} images={images} />);
233 |       
234 |       const textarea = screen.getByTestId('textarea');
235 |       expect(textarea).toHaveAttribute('placeholder', 'Describe these images or ask questions...');
236 |     });
237 | 
238 |     test('disables submit button when input is empty and no images', () => {
239 |       render(<Textarea {...defaultProps} input="" />);
240 |       
241 |       const submitButton = screen.getByRole('button', { name: /send/i });
242 |       expect(submitButton).toBeDisabled();
243 |     });
244 | 
245 |     test('enables submit button when input has content', () => {
246 |       render(<Textarea {...defaultProps} input="test message" />);
247 |       
248 |       const submitButton = screen.getByRole('button', { name: /send/i });
249 |       expect(submitButton).not.toBeDisabled();
250 |     });
251 | 
252 |     test('enables submit button when images are present', () => {
253 |       const images: ImageAttachment[] = [{ id: '1', url: 'test.jpg', detail: 'auto' }];
254 |       render(<Textarea {...defaultProps} images={images} />);
255 |       
256 |       const submitButton = screen.getByRole('button', { name: /send/i });
257 |       expect(submitButton).not.toBeDisabled();
258 |     });
259 |   });
260 | 
261 |   describe('User Interactions', () => {
262 |     test('calls handleInputChange when text is entered', () => {
263 |       render(<Textarea {...defaultProps} />);
264 |       
265 |       const textarea = screen.getByTestId('textarea');
266 |       fireEvent.change(textarea, { target: { value: 'new text' } });
267 |       
268 |       expect(mockHandleInputChange).toHaveBeenCalled();
269 |       // The enhanced handler calls the original handler, verify the call happened
270 |       expect(mockHandleInputChange.mock.calls.length).toBeGreaterThan(0);
271 |     });
272 | 
273 |     test('handles Enter key submission when not loading', () => {
274 |       const formSubmitSpy = jest.fn();
275 |       const TestForm = () => (
276 |         <form onSubmit={formSubmitSpy} data-testid="test-form">
277 |           <Textarea {...defaultProps} input="test message" />
278 |         </form>
279 |       );
280 |       
281 |       render(<TestForm />);
282 |       
283 |       const textarea = screen.getByTestId('textarea');
284 |       fireEvent.keyDown(textarea, { key: 'Enter', shiftKey: false });
285 |       
286 |       expect(formSubmitSpy).toHaveBeenCalled();
287 |     });
288 | 
289 |     test('does not submit on Shift+Enter', () => {
290 |       const formSubmitSpy = jest.fn();
291 |       const TestForm = () => (
292 |         <form onSubmit={formSubmitSpy} data-testid="test-form">
293 |           <Textarea {...defaultProps} input="test message" />
294 |         </form>
295 |       );
296 |       
297 |       render(<TestForm />);
298 |       
299 |       const textarea = screen.getByTestId('textarea');
300 |       fireEvent.keyDown(textarea, { key: 'Enter', shiftKey: true });
301 |       
302 |       expect(formSubmitSpy).not.toHaveBeenCalled();
303 |     });
304 | 
305 |     test('calls stop function when stop button is clicked', () => {
306 |       render(<Textarea {...defaultProps} status="streaming" />);
307 |       
308 |       const stopButton = screen.getByRole('button', { name: /stop/i });
309 |       fireEvent.click(stopButton);
310 |       
311 |       expect(mockStop).toHaveBeenCalled();
312 |     });
313 | 
314 |     test('shows stop button when streaming', () => {
315 |       render(<Textarea {...defaultProps} status="streaming" />);
316 |       
317 |       expect(screen.getByRole('button', { name: /stop/i })).toBeInTheDocument();
318 |       expect(screen.queryByRole('button', { name: /send/i })).not.toBeInTheDocument();
319 |     });
320 |   });
321 | 
322 |   describe('Image Handling', () => {
323 |     test('shows image upload button for vision-enabled models', () => {
324 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
325 |       
326 |       expect(screen.getByTestId('button-ghost')).toBeInTheDocument();
327 |     });
328 | 
329 |     test('does not show image upload button for non-vision models', () => {
330 |       render(<Textarea {...defaultProps} selectedModel="claude-3-haiku" />);
331 |       
332 |       expect(screen.queryByTestId('button-ghost')).not.toBeInTheDocument();
333 |     });
334 | 
335 |     test('toggles image upload interface when button is clicked', () => {
336 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
337 |       
338 |       const uploadButton = screen.getByTestId('button-ghost');
339 |       fireEvent.click(uploadButton);
340 |       
341 |       expect(screen.getByTestId('image-upload')).toBeInTheDocument();
342 |     });
343 | 
344 |     test('displays image preview when images are present', () => {
345 |       const images: ImageAttachment[] = [
346 |         { id: '1', url: 'test1.jpg', detail: 'auto' },
347 |         { id: '2', url: 'test2.jpg', detail: 'auto' }
348 |       ];
349 |       render(<Textarea {...defaultProps} images={images} />);
350 |       
351 |       expect(screen.getByTestId('image-preview')).toBeInTheDocument();
352 |       expect(screen.getByTestId('image-0')).toBeInTheDocument();
353 |       expect(screen.getByTestId('image-1')).toBeInTheDocument();
354 |       expect(screen.getByText('2/5 images • Click images to remove')).toBeInTheDocument();
355 |     });
356 | 
357 |     test('handles image selection', () => {
358 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
359 |       
360 |       const uploadButton = screen.getByTestId('button-ghost');
361 |       fireEvent.click(uploadButton);
362 |       
363 |       const selectButton = screen.getByTestId('image-upload-button');
364 |       fireEvent.click(selectButton);
365 |       
366 |       expect(mockOnImagesChange).toHaveBeenCalledWith([{ id: '1', url: 'test.jpg' }]);
367 |     });
368 | 
369 |     test('handles image removal', () => {
370 |       const images: ImageAttachment[] = [
371 |         { id: '1', url: 'test.jpg', detail: 'auto' }
372 |       ];
373 |       render(<Textarea {...defaultProps} images={images} />);
374 |       
375 |       const removeButton = screen.getByTestId('remove-image-0');
376 |       fireEvent.click(removeButton);
377 |       
378 |       expect(mockOnImagesChange).toHaveBeenCalledWith([]);
379 |     });
380 | 
381 |     test('disables image upload when at maximum limit', () => {
382 |       const images: ImageAttachment[] = Array(5).fill(null).map((_, i) => ({
383 |         id: `${i}`,
384 |         url: `test${i}.jpg`,
385 |         detail: 'auto' as const
386 |       }));
387 |       
388 |       render(<Textarea {...defaultProps} images={images} selectedModel="openrouter/test-model" />);
389 |       
390 |       const uploadButton = screen.getByTestId('button-ghost');
391 |       expect(uploadButton).toBeDisabled();
392 |     });
393 |   });
394 | 
395 |   describe('Web Search Integration', () => {
396 |     test('shows web search toggle for OpenRouter models', () => {
397 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
398 |       
399 |       expect(screen.getByLabelText(/web search/i)).toBeInTheDocument();
400 |     });
401 | 
402 |     test('does not show web search toggle for non-OpenRouter models', () => {
403 |       render(<Textarea {...defaultProps} selectedModel="claude-3-haiku" />);
404 |       
405 |       expect(screen.queryByLabelText(/web search/i)).not.toBeInTheDocument();
406 |     });
407 | 
408 |     test('toggles web search when button is clicked', () => {
409 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
410 |       
411 |       const webSearchButton = screen.getByLabelText(/web search/i);
412 |       fireEvent.click(webSearchButton);
413 |       
414 |       expect(mockSetWebSearchEnabled).toHaveBeenCalledWith(true);
415 |     });
416 | 
417 |     test('shows cost warning when web search is enabled with input', () => {
418 |       // Mock web search enabled
419 |       const { useWebSearch } = require('@/lib/context/web-search-context');
420 |       useWebSearch.mockReturnValue({
421 |         webSearchEnabled: true,
422 |         setWebSearchEnabled: mockSetWebSearchEnabled,
423 |       });
424 |       
425 |       render(<Textarea {...defaultProps} input="test query" selectedModel="openrouter/test-model" />);
426 |       
427 |       expect(screen.getByText('6 credits')).toBeInTheDocument();
428 |     });
429 |   });
430 | 
431 |   describe('Code Mode Detection', () => {
432 |     test('processes code input with text utilities', () => {
433 |       render(<Textarea {...defaultProps} />);
434 |       
435 |       const textarea = screen.getByTestId('textarea');
436 |       const codeInput = 'function test() { console.log("hello"); }';
437 |       
438 |       fireEvent.change(textarea, { target: { value: codeInput } });
439 |       
440 |       // Verify the enhanced input change handler was called
441 |       expect(mockHandleInputChange).toHaveBeenCalled();
442 |     });
443 | 
444 |     test('handles long code input for detection', () => {
445 |       render(<Textarea {...defaultProps} />);
446 |       
447 |       const textarea = screen.getByTestId('textarea');
448 |       // Create input longer than 50 characters to trigger detection
449 |       const longCodeInput = 'function test() { console.log("hello world from a long function"); }';
450 |       
451 |       fireEvent.change(textarea, { target: { value: longCodeInput } });
452 |       
453 |       expect(mockHandleInputChange).toHaveBeenCalled();
454 |     });
455 | 
456 |     test('handles paste with code auto-wrapping', () => {
457 |       render(<Textarea {...defaultProps} />);
458 |       
459 |       const textarea = screen.getByTestId('textarea');
460 |       const codeText = 'function test() { console.log("hello"); }';
461 |       
462 |       // Mock processTextInput to return wrapped code
463 |       const mockProcessTextInput = jest.mocked(require('@/lib/text-utils').processTextInput);
464 |       mockProcessTextInput.mockReturnValue({
465 |         processedText: '```javascript\n' + codeText + '\n```',
466 |         isCode: true,
467 |         confidence: 90,
468 |         language: 'javascript',
469 |         wasWrapped: true,
470 |         reasons: ['function keyword detected'],
471 |       });
472 |       
473 |       fireEvent.paste(textarea, {
474 |         clipboardData: {
475 |           getData: () => codeText,
476 |         },
477 |       });
478 |       
479 |       expect(mockHandleInputChange).toHaveBeenCalledWith(
480 |         expect.objectContaining({
481 |           target: expect.objectContaining({
482 |             value: '```javascript\n' + codeText + '\n```'
483 |           })
484 |         })
485 |       );
486 |     });
487 |   });
488 | 
489 |   describe('Error Handling', () => {
490 |     test('handles missing onImagesChange gracefully', () => {
491 |       const { onImagesChange, ...propsWithoutImageHandler } = defaultProps;
492 |       render(<Textarea {...propsWithoutImageHandler} selectedModel="openrouter/test-model" />);
493 |       
494 |       const uploadButton = screen.getByTestId('button-ghost');
495 |       fireEvent.click(uploadButton);
496 |       
497 |       const selectButton = screen.getByTestId('image-upload-button');
498 |       
499 |       // Should not throw error
500 |       expect(() => fireEvent.click(selectButton)).not.toThrow();
501 |     });
502 | 
503 |     test('handles invalid clipboard data in paste handler', () => {
504 |       render(<Textarea {...defaultProps} />);
505 |       
506 |       const textarea = screen.getByTestId('textarea');
507 |       
508 |       // Test with empty clipboard data
509 |       fireEvent.paste(textarea, {
510 |         clipboardData: {
511 |           getData: () => '',
512 |         },
513 |       });
514 |       
515 |       // Should not call handleInputChange for empty paste
516 |       expect(mockHandleInputChange).not.toHaveBeenCalled();
517 |     });
518 |   });
519 | 
520 |   describe('Accessibility', () => {
521 |     test('has proper ARIA attributes', () => {
522 |       render(<Textarea {...defaultProps} />);
523 |       
524 |       const textarea = screen.getByTestId('textarea');
525 |       expect(textarea).toHaveAttribute('placeholder');
526 |       
527 |       const submitButton = screen.getByRole('button', { name: /send/i });
528 |       expect(submitButton).toHaveAttribute('type');
529 |     });
530 | 
531 |     test('supports keyboard navigation', () => {
532 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
533 |       
534 |       const textarea = screen.getByTestId('textarea');
535 |       const uploadButton = screen.getByTestId('button-ghost');
536 |       
537 |       // Test tab navigation
538 |       textarea.focus();
539 |       expect(textarea).toHaveFocus();
540 |       
541 |       fireEvent.keyDown(textarea, { key: 'Tab' });
542 |       // Note: Actual focus management would require more complex setup
543 |     });
544 | 
545 |     test('provides meaningful labels for interactive elements', () => {
546 |       render(<Textarea {...defaultProps} selectedModel="openrouter/test-model" />);
547 |       
548 |       expect(screen.getByLabelText(/web search/i)).toBeInTheDocument();
549 |       expect(screen.getByRole('button', { name: /send/i })).toBeInTheDocument();
550 |     });
551 |   });
552 | 
553 |   describe('Code Enhancement Features', () => {
554 |     test('handles Ctrl+K for manual code wrapping', () => {
555 |       render(<Textarea {...defaultProps} input="console.log('test')" />);
556 |       
557 |       const textarea = screen.getByTestId('textarea');
558 |       
559 |       // Mock processTextInput to return wrapped code
560 |       const mockProcessTextInput = jest.mocked(require('@/lib/text-utils').processTextInput);
561 |       mockProcessTextInput.mockReturnValue({
562 |         processedText: '```javascript\nconsole.log(\'test\')\n```',
563 |         isCode: true,
564 |         confidence: 85,
565 |         language: 'javascript',
566 |         wasWrapped: true,
567 |         reasons: ['function keyword detected'],
568 |       });
569 |       
570 |       fireEvent.keyDown(textarea, { key: 'k', ctrlKey: true });
571 |       
572 |       expect(mockHandleInputChange).toHaveBeenCalledWith(
573 |         expect.objectContaining({
574 |           target: expect.objectContaining({
575 |             value: '```javascript\nconsole.log(\'test\')\n```'
576 |           })
577 |         })
578 |       );
579 |     });
580 | 
[TRUNCATED]
```

__tests__/components/theme-provider.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen } from '@testing-library/react';
3 | import { ThemeProvider } from '../../components/theme-provider';
4 | 
5 | // Mock next-themes
6 | jest.mock('next-themes', () => ({
7 |   ThemeProvider: jest.fn(({ children }) => (
8 |     <div data-testid="next-themes-provider">
9 |       {children}
10 |     </div>
11 |   )),
12 | }));
13 | 
14 | // Get the mocked function for testing
15 | const { ThemeProvider: MockedNextThemesProvider } = jest.requireMock('next-themes');
16 | 
17 | describe('ThemeProvider', () => {
18 |   beforeEach(() => {
19 |     jest.clearAllMocks();
20 |   });
21 | 
22 |   describe('Basic Rendering and Props', () => {
23 |     test('renders children correctly', () => {
24 |       render(
25 |         <ThemeProvider>
26 |           <div data-testid="child-component">Test Child</div>
27 |         </ThemeProvider>
28 |       );
29 | 
30 |       expect(screen.getByTestId('child-component')).toBeInTheDocument();
31 |       expect(screen.getByText('Test Child')).toBeInTheDocument();
32 |     });
33 | 
34 |     test('renders with multiple children', () => {
35 |       render(
36 |         <ThemeProvider>
37 |           <div data-testid="child-1">First Child</div>
38 |           <div data-testid="child-2">Second Child</div>
39 |         </ThemeProvider>
40 |       );
41 | 
42 |       expect(screen.getByTestId('child-1')).toBeInTheDocument();
43 |       expect(screen.getByTestId('child-2')).toBeInTheDocument();
44 |       expect(screen.getByText('First Child')).toBeInTheDocument();
45 |       expect(screen.getByText('Second Child')).toBeInTheDocument();
46 |     });
47 | 
48 |     test('renders without children', () => {
49 |       render(<ThemeProvider />);
50 |       
51 |       expect(screen.getByTestId('next-themes-provider')).toBeInTheDocument();
52 |     });
53 |   });
54 | 
55 |   describe('Props Handling', () => {
56 |     test('passes all props to NextThemesProvider', () => {
57 |       const testProps = {
58 |         attribute: 'class',
59 |         defaultTheme: 'system',
60 |         enableSystem: true,
61 |         storageKey: 'custom-theme',
62 |         themes: ['light', 'dark', 'system'],
63 |         value: { light: 'light-theme', dark: 'dark-theme' },
64 |       };
65 | 
66 |       render(
67 |         <ThemeProvider {...testProps}>
68 |           <div>Test Child</div>
69 |         </ThemeProvider>
70 |       );
71 | 
72 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
73 |       expect(mockCall).toMatchObject(testProps);
74 |       expect(mockCall.children).toBeDefined();
75 |     });
76 | 
77 |     test('passes custom theme configuration', () => {
78 |       const customConfig = {
79 |         attribute: 'data-theme',
80 |         defaultTheme: 'dark',
81 |         enableSystem: false,
82 |         disableTransitionOnChange: true,
83 |       };
84 | 
85 |       render(
86 |         <ThemeProvider {...customConfig}>
87 |           <div>Test Child</div>
88 |         </ThemeProvider>
89 |       );
90 | 
91 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
92 |       expect(mockCall).toMatchObject(customConfig);
93 |       expect(mockCall.children).toBeDefined();
94 |     });
95 | 
96 |     test('handles empty props object', () => {
97 |       render(
98 |         <ThemeProvider>
99 |           <div>Test Child</div>
100 |         </ThemeProvider>
101 |       );
102 | 
103 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
104 |       expect(mockCall.children).toBeDefined();
105 |       expect(MockedNextThemesProvider).toHaveBeenCalledTimes(1);
106 |     });
107 |   });
108 | 
109 |   describe('Provider Integration', () => {
110 |     test('wraps children with NextThemesProvider', () => {
111 |       render(
112 |         <ThemeProvider defaultTheme="dark">
113 |           <div data-testid="nested-child">Nested Content</div>
114 |         </ThemeProvider>
115 |       );
116 | 
117 |       const provider = screen.getByTestId('next-themes-provider');
118 |       const child = screen.getByTestId('nested-child');
119 |       
120 |       expect(provider).toBeInTheDocument();
121 |       expect(child).toBeInTheDocument();
122 |       expect(provider).toContainElement(child);
123 |     });
124 | 
125 |     test('maintains provider hierarchy with nested providers', () => {
126 |       render(
127 |         <ThemeProvider defaultTheme="light">
128 |           <div data-testid="outer-content">
129 |             <ThemeProvider defaultTheme="dark">
130 |               <div data-testid="inner-content">Inner Content</div>
131 |             </ThemeProvider>
132 |           </div>
133 |         </ThemeProvider>
134 |       );
135 | 
136 |       expect(screen.getByTestId('outer-content')).toBeInTheDocument();
137 |       expect(screen.getByTestId('inner-content')).toBeInTheDocument();
138 |       expect(MockedNextThemesProvider).toHaveBeenCalledTimes(2);
139 |     });
140 |   });
141 | 
142 |   describe('Theme Configuration', () => {
143 |     test('handles standard theme options', () => {
144 |       const themeConfig = {
145 |         themes: ['light', 'dark', 'auto'],
146 |         defaultTheme: 'auto',
147 |         enableSystem: true,
148 |         attribute: 'class',
149 |       };
150 | 
151 |       render(
152 |         <ThemeProvider {...themeConfig}>
153 |           <div>Theme Consumer</div>
154 |         </ThemeProvider>
155 |       );
156 | 
157 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
158 |       expect(mockCall).toMatchObject(themeConfig);
159 |       expect(mockCall.children).toBeDefined();
160 |     });
161 | 
162 |     test('handles custom theme values mapping', () => {
163 |       const customThemes = {
164 |         themes: ['light', 'dark', 'cyberpunk'],
165 |         value: {
166 |           light: 'theme-light',
167 |           dark: 'theme-dark', 
168 |           cyberpunk: 'theme-cyberpunk',
169 |         },
170 |       };
171 | 
172 |       render(
173 |         <ThemeProvider {...customThemes}>
174 |           <div>Custom Theme Consumer</div>
175 |         </ThemeProvider>
176 |       );
177 | 
178 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
179 |       expect(mockCall).toMatchObject(customThemes);
180 |       expect(mockCall.children).toBeDefined();
181 |     });
182 |   });
183 | 
184 |   describe('Error Handling', () => {
185 |     test('handles undefined children gracefully', () => {
186 |       render(<ThemeProvider>{undefined}</ThemeProvider>);
187 |       
188 |       expect(screen.getByTestId('next-themes-provider')).toBeInTheDocument();
189 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
190 |       expect(mockCall.children).toBeUndefined();
191 |     });
192 | 
193 |     test('handles null children gracefully', () => {
194 |       render(<ThemeProvider>{null}</ThemeProvider>);
195 |       
196 |       expect(screen.getByTestId('next-themes-provider')).toBeInTheDocument();
197 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
198 |       expect(mockCall.children).toBeNull();
199 |     });
200 | 
201 |     test('handles boolean children gracefully', () => {
202 |       render(
203 |         <ThemeProvider>
204 |           {true && <div data-testid="conditional-child">Conditional</div>}
205 |           {false && <div data-testid="hidden-child">Hidden</div>}
206 |         </ThemeProvider>
207 |       );
208 |       
209 |       expect(screen.getByTestId('conditional-child')).toBeInTheDocument();
210 |       expect(screen.queryByTestId('hidden-child')).not.toBeInTheDocument();
211 |     });
212 |   });
213 | 
214 |   describe('Accessibility', () => {
215 |     test('does not interfere with child accessibility attributes', () => {
216 |       render(
217 |         <ThemeProvider>
218 |           <button 
219 |             aria-label="Theme toggle button"
220 |             data-testid="accessible-button"
221 |           >
222 |             Toggle Theme
223 |           </button>
224 |         </ThemeProvider>
225 |       );
226 | 
227 |       const button = screen.getByTestId('accessible-button');
228 |       expect(button).toHaveAttribute('aria-label', 'Theme toggle button');
229 |       expect(button).toHaveAccessibleName('Theme toggle button');
230 |     });
231 | 
232 |     test('preserves child component roles and semantics', () => {
233 |       render(
234 |         <ThemeProvider>
235 |           <main role="main" data-testid="main-content">
236 |             <h1>Page Title</h1>
237 |             <nav role="navigation" data-testid="navigation">
238 |               <ul role="list">
239 |                 <li role="listitem">Nav Item</li>
240 |               </ul>
241 |             </nav>
242 |           </main>
243 |         </ThemeProvider>
244 |       );
245 | 
246 |       expect(screen.getByRole('main')).toHaveAttribute('role', 'main');
247 |       expect(screen.getByRole('navigation')).toHaveAttribute('role', 'navigation');
248 |       expect(screen.getByRole('list')).toHaveAttribute('role', 'list');
249 |       expect(screen.getByRole('listitem')).toHaveAttribute('role', 'listitem');
250 |     });
251 |   });
252 | 
253 |   describe('Integration Tests', () => {
254 |     test('provides theme context to deeply nested components', () => {
255 |       const DeepChild = () => (
256 |         <div data-testid="deep-child">Deep nested component</div>
257 |       );
258 | 
259 |       const MiddleComponent = () => (
260 |         <div data-testid="middle-component">
261 |           <DeepChild />
262 |         </div>
263 |       );
264 | 
265 |       render(
266 |         <ThemeProvider defaultTheme="dark" enableSystem={false}>
267 |           <div data-testid="top-level">
268 |             <MiddleComponent />
269 |           </div>
270 |         </ThemeProvider>
271 |       );
272 | 
273 |       expect(screen.getByTestId('top-level')).toBeInTheDocument();
274 |       expect(screen.getByTestId('middle-component')).toBeInTheDocument();
275 |       expect(screen.getByTestId('deep-child')).toBeInTheDocument();
276 |       
277 |       const mockCall = MockedNextThemesProvider.mock.calls[0][0];
278 |       expect(mockCall.defaultTheme).toBe('dark');
279 |       expect(mockCall.enableSystem).toBe(false);
280 |       expect(mockCall.children).toBeDefined();
281 |     });
282 | 
283 |     test('works with React fragments and conditional rendering', () => {
284 |       const showContent = true;
285 |       
286 |       render(
287 |         <ThemeProvider themes={['light', 'dark']}>
288 |           <>
289 |             {showContent && (
290 |               <div data-testid="fragment-content">
291 |                 Fragment Content
292 |               </div>
293 |             )}
294 |             <div data-testid="always-visible">Always Visible</div>
295 |           </>
296 |         </ThemeProvider>
297 |       );
298 | 
299 |       expect(screen.getByTestId('fragment-content')).toBeInTheDocument();
300 |       expect(screen.getByTestId('always-visible')).toBeInTheDocument();
301 |     });
302 |   });
303 | });
```

__tests__/components/theme-toggle.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { ThemeToggle } from '../../components/theme-toggle';
4 | 
5 | // Mock next-themes
6 | const mockSetTheme = jest.fn();
7 | const mockUseTheme = {
8 |   setTheme: mockSetTheme,
9 |   theme: 'dark',
10 |   resolvedTheme: 'dark',
11 | };
12 | 
13 | jest.mock('next-themes', () => ({
14 |   useTheme: () => mockUseTheme,
15 | }));
16 | 
17 | // Mock UI components
18 | jest.mock('../../components/ui/button', () => ({
19 |   Button: ({ children, onClick, variant, size, className, ...props }: any) => (
20 |     <button 
21 |       onClick={onClick} 
22 |       className={className} 
23 |       data-variant={variant}
24 |       data-size={size}
25 |       data-testid={`button-${variant || 'default'}`}
26 |       {...props}
27 |     >
28 |       {children}
29 |     </button>
30 |   ),
31 | }));
32 | 
33 | jest.mock('../../components/ui/dropdown-menu', () => ({
34 |   DropdownMenu: ({ children }: any) => <div data-testid="dropdown-menu">{children}</div>,
35 |   DropdownMenuContent: ({ children, align, className }: any) => (
36 |     <div data-testid="dropdown-content" data-align={align} className={className}>
37 |       {children}
38 |     </div>
39 |   ),
40 |   DropdownMenuTrigger: ({ children, asChild }: any) => (
41 |     <div data-testid="dropdown-trigger" data-as-child={asChild}>
42 |       {children}
43 |     </div>
44 |   ),
45 |   DropdownMenuItem: ({ children, onSelect, className }: any) => (
46 |     <div 
47 |       data-testid="dropdown-item" 
48 |       className={className}
49 |       onClick={onSelect}
50 |       role="menuitem"
51 |     >
52 |       {children}
53 |     </div>
54 |   ),
55 | }));
56 | 
57 | // Mock Lucide icons
58 | jest.mock('lucide-react', () => ({
59 |   CircleDashed: ({ className }: any) => <div className={className} data-testid="circle-dashed-icon" />,
60 |   Flame: ({ className }: any) => <div className={className} data-testid="flame-icon" />,
61 |   Sun: ({ className }: any) => <div className={className} data-testid="sun-icon" />,
62 |   TerminalSquare: ({ className }: any) => <div className={className} data-testid="terminal-square-icon" />,
63 |   CassetteTape: ({ className }: any) => <div className={className} data-testid="cassette-tape-icon" />,
64 |   Leaf: ({ className }: any) => <div className={className} data-testid="leaf-icon" />,
65 | }));
66 | 
67 | // Mock utils
68 | jest.mock('@/lib/utils', () => ({
69 |   cn: (...classes: any[]) => classes.filter(Boolean).join(' '),
70 | }));
71 | 
72 | describe('ThemeToggle', () => {
73 |   beforeEach(() => {
74 |     jest.clearAllMocks();
75 |     mockUseTheme.theme = 'dark';
76 |     mockUseTheme.resolvedTheme = 'dark';
77 |   });
78 | 
79 |   describe('Basic Rendering and Props', () => {
80 |     test('renders with default props', () => {
81 |       render(<ThemeToggle />);
82 |       
83 |       expect(screen.getByTestId('dropdown-menu')).toBeInTheDocument();
84 |       expect(screen.getByTestId('dropdown-trigger')).toBeInTheDocument();
85 |       expect(screen.getByTestId('dropdown-content')).toBeInTheDocument();
86 |       expect(screen.getByTestId('button-ghost')).toBeInTheDocument();
87 |     });
88 | 
89 |     test('renders with custom className', () => {
90 |       render(<ThemeToggle className="custom-class" />);
91 |       
92 |       const button = screen.getByTestId('button-ghost');
93 |       expect(button).toHaveClass('custom-class');
94 |     });
95 | 
96 |     test('renders with custom trigger', () => {
97 |       const customTrigger = <button data-testid="custom-trigger">Custom</button>;
98 |       render(<ThemeToggle trigger={customTrigger} />);
99 |       
100 |       expect(screen.getByTestId('custom-trigger')).toBeInTheDocument();
101 |       expect(screen.getByText('Custom')).toBeInTheDocument();
102 |     });
103 | 
104 |     test('renders with showLabel and labelText', () => {
105 |       render(<ThemeToggle showLabel={true} labelText="Theme" />);
106 |       
107 |       expect(screen.getByText('Theme')).toBeInTheDocument();
108 |     });
109 | 
110 |     test('renders with showLabel and custom labelText element', () => {
111 |       render(<ThemeToggle showLabel={true} labelText={<span data-testid="custom-label">Custom Label</span>} />);
112 |       
113 |       expect(screen.getByTestId('custom-label')).toBeInTheDocument();
114 |       expect(screen.getByText('Custom Label')).toBeInTheDocument();
115 |     });
116 | 
117 |     test('has screen reader text for accessibility', () => {
118 |       render(<ThemeToggle />);
119 |       
120 |       expect(screen.getByText('Toggle theme')).toBeInTheDocument();
121 |       expect(screen.getByText('Toggle theme')).toHaveClass('sr-only');
122 |     });
123 |   });
124 | 
125 |   describe('Theme Icon Display', () => {
126 |     test('displays flame icon for dark theme in trigger', () => {
127 |       mockUseTheme.theme = 'dark';
128 |       mockUseTheme.resolvedTheme = 'dark';
129 |       
130 |       render(<ThemeToggle />);
131 |       
132 |       const triggerButton = screen.getByTestId('button-ghost');
133 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
134 |     });
135 | 
136 |     test('displays sun icon for light theme in trigger', () => {
137 |       mockUseTheme.theme = 'light';
138 |       mockUseTheme.resolvedTheme = 'light';
139 |       
140 |       render(<ThemeToggle />);
141 |       
142 |       const triggerButton = screen.getByTestId('button-ghost');
143 |       expect(triggerButton.querySelector('[data-testid="sun-icon"]')).toBeInTheDocument();
144 |     });
145 | 
146 |     test('displays circle-dashed icon for black theme in trigger', () => {
147 |       mockUseTheme.theme = 'black';
148 |       mockUseTheme.resolvedTheme = 'black';
149 |       
150 |       render(<ThemeToggle />);
151 |       
152 |       const triggerButton = screen.getByTestId('button-ghost');
153 |       expect(triggerButton.querySelector('[data-testid="circle-dashed-icon"]')).toBeInTheDocument();
154 |     });
155 | 
156 |     test('displays sun icon for sunset theme in trigger', () => {
157 |       mockUseTheme.theme = 'sunset';
158 |       mockUseTheme.resolvedTheme = 'sunset';
159 |       
160 |       render(<ThemeToggle />);
161 |       
162 |       const triggerButton = screen.getByTestId('button-ghost');
163 |       expect(triggerButton.querySelector('[data-testid="sun-icon"]')).toBeInTheDocument();
164 |     });
165 | 
166 |     test('displays terminal-square icon for cyberpunk theme in trigger', () => {
167 |       mockUseTheme.theme = 'cyberpunk';
168 |       mockUseTheme.resolvedTheme = 'cyberpunk';
169 |       
170 |       render(<ThemeToggle />);
171 |       
172 |       const triggerButton = screen.getByTestId('button-ghost');
173 |       expect(triggerButton.querySelector('[data-testid="terminal-square-icon"]')).toBeInTheDocument();
174 |     });
175 | 
176 |     test('displays cassette-tape icon for retro theme in trigger', () => {
177 |       mockUseTheme.theme = 'retro';
178 |       mockUseTheme.resolvedTheme = 'retro';
179 |       
180 |       render(<ThemeToggle />);
181 |       
182 |       const triggerButton = screen.getByTestId('button-ghost');
183 |       expect(triggerButton.querySelector('[data-testid="cassette-tape-icon"]')).toBeInTheDocument();
184 |     });
185 | 
186 |     test('displays leaf icon for nature theme in trigger', () => {
187 |       mockUseTheme.theme = 'nature';
188 |       mockUseTheme.resolvedTheme = 'nature';
189 |       
190 |       render(<ThemeToggle />);
191 |       
192 |       const triggerButton = screen.getByTestId('button-ghost');
193 |       expect(triggerButton.querySelector('[data-testid="leaf-icon"]')).toBeInTheDocument();
194 |     });
195 | 
196 |     test('displays flame icon as fallback for unknown theme in trigger', () => {
197 |       mockUseTheme.theme = 'unknown';
198 |       mockUseTheme.resolvedTheme = 'unknown';
199 |       
200 |       render(<ThemeToggle />);
201 |       
202 |       const triggerButton = screen.getByTestId('button-ghost');
203 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
204 |     });
205 |   });
206 | 
207 |   describe('Theme Logic with System Theme', () => {
208 |     test('uses resolvedTheme when theme is system', () => {
209 |       mockUseTheme.theme = 'system';
210 |       mockUseTheme.resolvedTheme = 'light';
211 |       
212 |       render(<ThemeToggle />);
213 |       
214 |       const triggerButton = screen.getByTestId('button-ghost');
215 |       expect(triggerButton.querySelector('[data-testid="sun-icon"]')).toBeInTheDocument();
216 |     });
217 | 
218 |     test('uses resolvedTheme when theme is undefined', () => {
219 |       mockUseTheme.theme = undefined;
220 |       mockUseTheme.resolvedTheme = 'dark';
221 |       
222 |       render(<ThemeToggle />);
223 |       
224 |       const triggerButton = screen.getByTestId('button-ghost');
225 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
226 |     });
227 | 
228 |     test('prioritizes explicit theme over resolvedTheme', () => {
229 |       mockUseTheme.theme = 'light';
230 |       mockUseTheme.resolvedTheme = 'dark';
231 |       
232 |       render(<ThemeToggle />);
233 |       
234 |       const triggerButton = screen.getByTestId('button-ghost');
235 |       expect(triggerButton.querySelector('[data-testid="sun-icon"]')).toBeInTheDocument();
236 |     });
237 |   });
238 | 
239 |   describe('User Interactions', () => {
240 |     test('calls setTheme with dark when dark option is selected', () => {
241 |       render(<ThemeToggle />);
242 |       
243 |       const darkOption = screen.getAllByTestId('dropdown-item')[0];
244 |       fireEvent.click(darkOption);
245 |       
246 |       expect(mockSetTheme).toHaveBeenCalledWith('dark');
247 |     });
248 | 
249 |     test('calls setTheme with light when light option is selected', () => {
250 |       render(<ThemeToggle />);
251 |       
252 |       const lightOption = screen.getAllByTestId('dropdown-item')[1];
253 |       fireEvent.click(lightOption);
254 |       
255 |       expect(mockSetTheme).toHaveBeenCalledWith('light');
256 |     });
257 | 
258 |     test('calls setTheme with black when black option is selected', () => {
259 |       render(<ThemeToggle />);
260 |       
261 |       const blackOption = screen.getAllByTestId('dropdown-item')[2];
262 |       fireEvent.click(blackOption);
263 |       
264 |       expect(mockSetTheme).toHaveBeenCalledWith('black');
265 |     });
266 | 
267 |     test('calls setTheme with sunset when sunset option is selected', () => {
268 |       render(<ThemeToggle />);
269 |       
270 |       const sunsetOption = screen.getAllByTestId('dropdown-item')[3];
271 |       fireEvent.click(sunsetOption);
272 |       
273 |       expect(mockSetTheme).toHaveBeenCalledWith('sunset');
274 |     });
275 | 
276 |     test('calls setTheme with cyberpunk when cyberpunk option is selected', () => {
277 |       render(<ThemeToggle />);
278 |       
279 |       const cyberpunkOption = screen.getAllByTestId('dropdown-item')[4];
280 |       fireEvent.click(cyberpunkOption);
281 |       
282 |       expect(mockSetTheme).toHaveBeenCalledWith('cyberpunk');
283 |     });
284 | 
285 |     test('calls setTheme with retro when retro option is selected', () => {
286 |       render(<ThemeToggle />);
287 |       
288 |       const retroOption = screen.getAllByTestId('dropdown-item')[5];
289 |       fireEvent.click(retroOption);
290 |       
291 |       expect(mockSetTheme).toHaveBeenCalledWith('retro');
292 |     });
293 | 
294 |     test('calls setTheme with nature when nature option is selected', () => {
295 |       render(<ThemeToggle />);
296 |       
297 |       const natureOption = screen.getAllByTestId('dropdown-item')[6];
298 |       fireEvent.click(natureOption);
299 |       
300 |       expect(mockSetTheme).toHaveBeenCalledWith('nature');
301 |     });
302 | 
303 |     test('handles multiple theme changes', () => {
304 |       render(<ThemeToggle />);
305 |       
306 |       const lightOption = screen.getAllByTestId('dropdown-item')[1];
307 |       const darkOption = screen.getAllByTestId('dropdown-item')[0];
308 |       
309 |       fireEvent.click(lightOption);
310 |       fireEvent.click(darkOption);
311 |       
312 |       expect(mockSetTheme).toHaveBeenCalledTimes(2);
313 |       expect(mockSetTheme).toHaveBeenNthCalledWith(1, 'light');
314 |       expect(mockSetTheme).toHaveBeenNthCalledWith(2, 'dark');
315 |     });
316 |   });
317 | 
318 |   describe('Dropdown Menu Content', () => {
319 |     test('displays all theme options with correct labels', () => {
320 |       render(<ThemeToggle />);
321 |       
322 |       expect(screen.getByText('Dark')).toBeInTheDocument();
323 |       expect(screen.getByText('Light')).toBeInTheDocument();
324 |       expect(screen.getByText('Black')).toBeInTheDocument();
325 |       expect(screen.getByText('Sunset')).toBeInTheDocument();
326 |       expect(screen.getByText('Cyberpunk')).toBeInTheDocument();
327 |       expect(screen.getByText('Retro')).toBeInTheDocument();
328 |       expect(screen.getByText('Nature')).toBeInTheDocument();
329 |     });
330 | 
331 |     test('displays all theme options with correct icons', () => {
332 |       render(<ThemeToggle />);
333 |       
334 |       // Check that each theme option has its icon in the dropdown menu
335 |       const dropdownContent = screen.getByTestId('dropdown-content');
336 |       
337 |       // Verify each theme option icon exists in dropdown
338 |       expect(dropdownContent.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument(); // Dark theme
339 |       expect(dropdownContent.querySelectorAll('[data-testid="sun-icon"]')).toHaveLength(2); // Light and Sunset themes
340 |       expect(dropdownContent.querySelector('[data-testid="circle-dashed-icon"]')).toBeInTheDocument(); // Black theme
341 |       expect(dropdownContent.querySelector('[data-testid="terminal-square-icon"]')).toBeInTheDocument(); // Cyberpunk theme
342 |       expect(dropdownContent.querySelector('[data-testid="cassette-tape-icon"]')).toBeInTheDocument(); // Retro theme
343 |       expect(dropdownContent.querySelector('[data-testid="leaf-icon"]')).toBeInTheDocument(); // Nature theme
344 |     });
345 | 
346 |     test('dropdown content has correct alignment', () => {
347 |       render(<ThemeToggle />);
348 |       
349 |       const dropdownContent = screen.getByTestId('dropdown-content');
350 |       expect(dropdownContent).toHaveAttribute('data-align', 'end');
351 |     });
352 |   });
353 | 
354 |   describe('Accessibility', () => {
355 |     test('dropdown items have proper role', () => {
356 |       render(<ThemeToggle />);
357 |       
358 |       const menuItems = screen.getAllByRole('menuitem');
359 |       expect(menuItems).toHaveLength(7); // 7 theme options
360 |     });
361 | 
362 |     test('has accessible screen reader text', () => {
363 |       render(<ThemeToggle />);
364 |       
365 |       const srText = screen.getByText('Toggle theme');
366 |       expect(srText).toHaveClass('sr-only');
367 |     });
368 | 
369 |     test('button has proper attributes when using default trigger', () => {
370 |       render(<ThemeToggle />);
371 |       
372 |       const button = screen.getByTestId('button-ghost');
373 |       expect(button).toHaveAttribute('data-variant', 'ghost');
374 |       expect(button).toHaveAttribute('data-size', 'icon');
375 |     });
376 | 
377 |     test('maintains accessibility with custom trigger', () => {
378 |       const customTrigger = (
379 |         <button aria-label="Select theme" data-testid="custom-trigger">
380 |           Theme
381 |         </button>
382 |       );
383 |       render(<ThemeToggle trigger={customTrigger} />);
384 |       
385 |       const trigger = screen.getByTestId('custom-trigger');
386 |       expect(trigger).toHaveAttribute('aria-label', 'Select theme');
387 |     });
388 |   });
389 | 
390 |   describe('Edge Cases', () => {
391 |     test('handles null resolvedTheme gracefully', () => {
392 |       mockUseTheme.theme = 'system';
393 |       mockUseTheme.resolvedTheme = null;
394 |       
395 |       render(<ThemeToggle />);
396 |       
397 |       // Should fallback to flame icon
398 |       const triggerButton = screen.getByTestId('button-ghost');
399 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
400 |     });
401 | 
402 |     test('handles undefined theme and resolvedTheme gracefully', () => {
403 |       mockUseTheme.theme = undefined;
404 |       mockUseTheme.resolvedTheme = undefined;
405 |       
406 |       render(<ThemeToggle />);
407 |       
408 |       // Should fallback to flame icon
409 |       const triggerButton = screen.getByTestId('button-ghost');
410 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
411 |     });
412 | 
413 |     test('handles empty string theme gracefully', () => {
414 |       mockUseTheme.theme = '';
415 |       mockUseTheme.resolvedTheme = '';
416 |       
417 |       render(<ThemeToggle />);
418 |       
419 |       // Should fallback to flame icon
420 |       const triggerButton = screen.getByTestId('button-ghost');
421 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
422 |     });
423 | 
424 |     test('forwards additional props to button', () => {
425 |       render(<ThemeToggle data-custom="test" id="theme-toggle" />);
426 |       
427 |       const button = screen.getByTestId('button-ghost');
428 |       expect(button).toHaveAttribute('data-custom', 'test');
429 |       expect(button).toHaveAttribute('id', 'theme-toggle');
430 |     });
431 |   });
432 | 
433 |   describe('Component Variants', () => {
434 |     test('renders correctly with showLabel but no labelText', () => {
435 |       render(<ThemeToggle showLabel={true} />);
436 |       
437 |       // Should render default button since labelText is not provided
438 |       expect(screen.getByTestId('button-ghost')).toBeInTheDocument();
439 |     });
440 | 
441 |     test('renders correctly with labelText but showLabel false', () => {
442 |       render(<ThemeToggle showLabel={false} labelText="Theme" />);
443 |       
444 |       // Should render default button since showLabel is false
445 |       expect(screen.getByTestId('button-ghost')).toBeInTheDocument();
446 |       expect(screen.queryByText('Theme')).not.toBeInTheDocument();
447 |     });
448 | 
449 |     test('renders with showLabel and labelText and applies custom className', () => {
450 |       render(<ThemeToggle showLabel={true} labelText="Theme" className="custom-class" />);
451 |       
452 |       // When showLabel and labelText are provided, the component should render the text
453 |       expect(screen.getByText('Theme')).toBeInTheDocument();
454 |       
455 |       // Should not render the default button when using showLabel and labelText
456 |       expect(screen.queryByTestId('button-ghost')).not.toBeInTheDocument();
457 |       
458 |       // The component should still render the dropdown functionality
459 |       expect(screen.getByTestId('dropdown-menu')).toBeInTheDocument();
460 |       expect(screen.getByTestId('dropdown-trigger')).toBeInTheDocument();
461 |       
462 |       // Should include an icon alongside the label in the trigger area
463 |       const dropdownTrigger = screen.getByTestId('dropdown-trigger');
464 |       expect(dropdownTrigger.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
465 |     });
466 |   });
467 | 
468 |   describe('Integration Tests', () => {
469 |     test('complete theme change workflow', async () => {
470 |       // Start with dark theme
471 |       mockUseTheme.theme = 'dark';
472 |       mockUseTheme.resolvedTheme = 'dark';
473 |       
474 |       const { rerender } = render(<ThemeToggle />);
475 |       
476 |       // Verify initial state - flame icon in trigger
477 |       const triggerButton = screen.getByTestId('button-ghost');
478 |       expect(triggerButton.querySelector('[data-testid="flame-icon"]')).toBeInTheDocument();
479 |       
480 |       // Change to light theme
481 |       const lightOption = screen.getAllByTestId('dropdown-item')[1];
482 |       fireEvent.click(lightOption);
483 |       
484 |       expect(mockSetTheme).toHaveBeenCalledWith('light');
485 |       
486 |       // Test that the theme would change by simulating theme update
487 |       mockUseTheme.theme = 'light';
488 |       mockUseTheme.resolvedTheme = 'light';
489 |       
490 |       // Re-render to see the change (in real app, this would happen automatically)
491 |       rerender(<ThemeToggle />);
492 |       
493 |       const updatedTriggerButton = screen.getByTestId('button-ghost');
494 |       expect(updatedTriggerButton.querySelector('[data-testid="sun-icon"]')).toBeInTheDocument();
495 |     });
496 | 
497 |     test('works with all theme options in sequence', () => {
498 |       render(<ThemeToggle />);
499 |       
500 |       const themes = ['dark', 'light', 'black', 'sunset', 'cyberpunk', 'retro', 'nature'];
501 |       const dropdownItems = screen.getAllByTestId('dropdown-item');
502 |       
503 |       themes.forEach((theme, index) => {
504 |         fireEvent.click(dropdownItems[index]);
505 |         expect(mockSetTheme).toHaveBeenCalledWith(theme);
506 |       });
507 |       
508 |       expect(mockSetTheme).toHaveBeenCalledTimes(7);
509 |     });
510 |   });
511 | });
```

__tests__/components/tool-invocation.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor } from '@testing-library/react';
3 | import { ToolInvocation } from '../../components/tool-invocation';
4 | 
5 | // Mock framer-motion to avoid animation complexity in tests
6 | jest.mock('motion/react', () => ({
7 |   motion: {
8 |     div: ({ children, className, ...props }: any) => (
9 |       <div className={className} {...props}>
10 |         {children}
11 |       </div>
12 |     ),
13 |   },
14 |   AnimatePresence: ({ children }: any) => <>{children}</>,
15 | }));
16 | 
17 | // Mock lucide-react icons
18 | jest.mock('lucide-react', () => ({
19 |   ChevronDownIcon: ({ className }: any) => (
20 |     <div className={className} data-testid="chevron-down" />
21 |   ),
22 |   ChevronUpIcon: ({ className }: any) => (
23 |     <div className={className} data-testid="chevron-up" />
24 |   ),
25 |   Loader2: ({ className }: any) => (
26 |     <div className={className} data-testid="loader" />
27 |   ),
28 |   CheckCircle2: ({ className, size }: any) => (
29 |     <div className={className} data-testid="check-circle" data-size={size} />
30 |   ),
31 |   TerminalSquare: ({ className }: any) => (
32 |     <div className={className} data-testid="terminal-icon" />
33 |   ),
34 |   Code: ({ className }: any) => (
35 |     <div className={className} data-testid="code-icon" />
36 |   ),
37 |   ArrowRight: ({ className }: any) => (
38 |     <div className={className} data-testid="arrow-right" />
39 |   ),
40 |   Circle: ({ className }: any) => (
41 |     <div className={className} data-testid="circle" />
42 |   ),
43 | }));
44 | 
45 | describe('ToolInvocation', () => {
46 |   const defaultProps = {
47 |     toolName: 'test-tool',
48 |     state: 'call',
49 |     args: { param1: 'value1', param2: 'value2' },
50 |     result: { output: 'test result', status: 'success' },
51 |     isLatestMessage: false,
52 |     status: 'ready',
53 |   };
54 | 
55 |   beforeEach(() => {
56 |     jest.clearAllMocks();
57 |   });
58 | 
59 |   describe('Basic Rendering and Props', () => {
60 |     test('renders with default props', () => {
61 |       render(<ToolInvocation {...defaultProps} />);
62 |       
63 |       expect(screen.getByText('test-tool')).toBeInTheDocument();
64 |       expect(screen.getByTestId('terminal-icon')).toBeInTheDocument();
65 |       expect(screen.getByTestId('chevron-down')).toBeInTheDocument();
66 |     });
67 | 
68 |     test('displays tool name correctly', () => {
69 |       render(<ToolInvocation {...defaultProps} toolName="custom-tool" />);
70 |       
71 |       expect(screen.getByText('custom-tool')).toBeInTheDocument();
72 |     });
73 | 
74 |     test('renders collapsed by default', () => {
75 |       render(<ToolInvocation {...defaultProps} />);
76 |       
77 |       expect(screen.getByTestId('chevron-down')).toBeInTheDocument();
78 |       expect(screen.queryByText('Arguments')).not.toBeInTheDocument();
79 |       expect(screen.queryByText('Result')).not.toBeInTheDocument();
80 |     });
81 | 
82 |     test('does not render arguments section when args is null', () => {
83 |       render(<ToolInvocation {...defaultProps} args={null} />);
84 |       
85 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
86 |       fireEvent.click(clickableArea!);
87 |       expect(screen.queryByText('Arguments')).not.toBeInTheDocument();
88 |     });
89 | 
90 |     test('does not render result section when result is null', () => {
91 |       render(<ToolInvocation {...defaultProps} result={null} />);
92 |       
93 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
94 |       fireEvent.click(clickableArea!);
95 |       expect(screen.queryByText('Result')).not.toBeInTheDocument();
96 |     });
97 |   });
98 | 
99 |   describe('User Interactions', () => {
100 |     test('expands when clicked', () => {
101 |       render(<ToolInvocation {...defaultProps} />);
102 |       
103 |       const expandButton = screen.getByTestId('chevron-down').closest('div');
104 |       fireEvent.click(expandButton);
105 |       
106 |       expect(screen.getByTestId('chevron-up')).toBeInTheDocument();
107 |       expect(screen.getByText('Arguments')).toBeInTheDocument();
108 |       expect(screen.getByText('Result')).toBeInTheDocument();
109 |     });
110 | 
111 |     test('collapses when clicked again', () => {
112 |       render(<ToolInvocation {...defaultProps} />);
113 |       
114 |       const expandButton = screen.getByTestId('chevron-down').closest('div');
115 |       
116 |       // Expand
117 |       fireEvent.click(expandButton);
118 |       expect(screen.getByTestId('chevron-up')).toBeInTheDocument();
119 |       
120 |       // Collapse
121 |       const collapseButton = screen.getByTestId('chevron-up').closest('div');
122 |       fireEvent.click(collapseButton);
123 |       expect(screen.getByTestId('chevron-down')).toBeInTheDocument();
124 |     });
125 | 
126 |     test('toggles expansion state correctly', () => {
127 |       render(<ToolInvocation {...defaultProps} />);
128 |       
129 |       const expandButton = screen.getByTestId('chevron-down').closest('div');
130 |       
131 |       // Initially collapsed
132 |       expect(screen.queryByText('Arguments')).not.toBeInTheDocument();
133 |       
134 |       // Expand
135 |       fireEvent.click(expandButton);
136 |       expect(screen.getByText('Arguments')).toBeInTheDocument();
137 |       
138 |       // Collapse
139 |       const collapseButton = screen.getByTestId('chevron-up').closest('div');
140 |       fireEvent.click(collapseButton);
141 |       expect(screen.queryByText('Arguments')).not.toBeInTheDocument();
142 |     });
143 |   });
144 | 
145 |   describe('State Management - Call State', () => {
146 |     test('displays "Waiting" status for call state when not latest message', () => {
147 |       render(
148 |         <ToolInvocation 
149 |           {...defaultProps} 
150 |           state="call" 
151 |           isLatestMessage={false} 
152 |           status="ready" 
153 |         />
154 |       );
155 |       
156 |       expect(screen.getByText('Waiting')).toBeInTheDocument();
157 |       expect(screen.getByTestId('circle')).toBeInTheDocument();
158 |     });
159 | 
160 |     test('displays "Running" status for call state when latest message and not ready', () => {
161 |       render(
162 |         <ToolInvocation 
163 |           {...defaultProps} 
164 |           state="call" 
165 |           isLatestMessage={true} 
166 |           status="processing" 
167 |         />
168 |       );
169 |       
170 |       expect(screen.getByText('Running')).toBeInTheDocument();
171 |       expect(screen.getByTestId('loader')).toBeInTheDocument();
172 |     });
173 | 
174 |     test('displays "Waiting" status for call state when latest message and ready', () => {
175 |       render(
176 |         <ToolInvocation 
177 |           {...defaultProps} 
178 |           state="call" 
179 |           isLatestMessage={true} 
180 |           status="ready" 
181 |         />
182 |       );
183 |       
184 |       expect(screen.getByText('Waiting')).toBeInTheDocument();
185 |       expect(screen.getByTestId('circle')).toBeInTheDocument();
186 |     });
187 |   });
188 | 
189 |   describe('State Management - Result State', () => {
190 |     test('displays "Completed" status for result state', () => {
191 |       render(<ToolInvocation {...defaultProps} state="result" />);
192 |       
193 |       expect(screen.getByText('Completed')).toBeInTheDocument();
194 |       expect(screen.getByTestId('check-circle')).toBeInTheDocument();
195 |     });
196 | 
197 |     test('shows check circle icon for completed state', () => {
198 |       render(<ToolInvocation {...defaultProps} state="result" />);
199 |       
200 |       const checkIcon = screen.getByTestId('check-circle');
201 |       expect(checkIcon).toBeInTheDocument();
202 |       expect(checkIcon).toHaveAttribute('data-size', '14');
203 |     });
204 |   });
205 | 
206 |   describe('Content Formatting', () => {
207 |     test('formats JSON objects correctly', () => {
208 |       const complexArgs = {
209 |         nested: { key: 'value' },
210 |         array: [1, 2, 3],
211 |         string: 'test'
212 |       };
213 |       
214 |       render(<ToolInvocation {...defaultProps} args={complexArgs} />);
215 |       
216 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
217 |       fireEvent.click(clickableArea!);
218 |       
219 |       const pre = screen.getByText((content, element) => {
220 |         return element?.tagName.toLowerCase() === 'pre' && 
221 |                content.includes('"nested"') &&
222 |                content.includes('"key": "value"');
223 |       });
224 |       
225 |       expect(pre).toBeInTheDocument();
226 |     });
227 | 
228 |     test('handles string content correctly', () => {
229 |       render(<ToolInvocation {...defaultProps} args="simple string" />);
230 |       
231 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
232 |       fireEvent.click(clickableArea!);
233 |       expect(screen.getByText('simple string')).toBeInTheDocument();
234 |     });
235 | 
236 |     test('handles JSON string content correctly', () => {
237 |       const jsonString = '{"key": "value", "number": 42}';
238 |       render(<ToolInvocation {...defaultProps} args={jsonString} />);
239 |       
240 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
241 |       fireEvent.click(clickableArea!);
242 |       
243 |       const formattedContent = screen.getByText((content, element) => {
244 |         return element?.tagName.toLowerCase() === 'pre' && 
245 |                content.includes('"key": "value"') &&
246 |                content.includes('"number": 42');
247 |       });
248 |       
249 |       expect(formattedContent).toBeInTheDocument();
250 |     });
251 | 
252 |     test('handles invalid JSON string gracefully', () => {
253 |       const invalidJson = '{"key": value}'; // Invalid JSON
254 |       render(<ToolInvocation {...defaultProps} args={invalidJson} />);
255 |       
256 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
257 |       fireEvent.click(clickableArea!);
258 |       expect(screen.getByText(invalidJson)).toBeInTheDocument();
259 |     });
260 | 
261 |     test('handles non-serializable content gracefully', () => {
262 |       const circularObj = { a: 1 };
263 |       circularObj.self = circularObj; // Create circular reference
264 |       
265 |       render(<ToolInvocation {...defaultProps} args={circularObj} />);
266 |       
267 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
268 |       fireEvent.click(clickableArea!);
269 |       // Should not crash and display some string representation
270 |       expect(screen.getByText('Arguments')).toBeInTheDocument();
271 |     });
272 | 
273 |     test('formats both args and result when expanded', () => {
274 |       render(<ToolInvocation {...defaultProps} />);
275 |       
276 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
277 |       fireEvent.click(clickableArea!);
278 |       
279 |       expect(screen.getByText('Arguments')).toBeInTheDocument();
280 |       expect(screen.getByText('Result')).toBeInTheDocument();
281 |       expect(screen.getByTestId('code-icon')).toBeInTheDocument();
282 |       expect(screen.getAllByTestId('arrow-right')).toHaveLength(2);
283 |     });
284 |   });
285 | 
286 |   describe('Visual States and Styling', () => {
287 |     test('applies correct CSS classes for call state with loading', () => {
288 |       render(
289 |         <ToolInvocation 
290 |           {...defaultProps} 
291 |           state="call" 
292 |           isLatestMessage={true} 
293 |           status="processing" 
294 |         />
295 |       );
296 |       
297 |       const runningText = screen.getByText('Running');
298 |       expect(runningText).toHaveClass('text-primary');
299 |     });
300 | 
301 |     test('applies correct CSS classes for call state without loading', () => {
302 |       render(
303 |         <ToolInvocation 
304 |           {...defaultProps} 
305 |           state="call" 
306 |           isLatestMessage={false} 
307 |           status="ready" 
308 |         />
309 |       );
310 |       
311 |       const waitingText = screen.getByText('Waiting');
312 |       expect(waitingText).toHaveClass('text-muted-foreground');
313 |     });
314 | 
315 |     test('applies correct CSS classes for result state', () => {
316 |       render(<ToolInvocation {...defaultProps} state="result" />);
317 |       
318 |       const completedText = screen.getByText('Completed');
319 |       expect(completedText).toHaveClass('text-primary');
320 |     });
321 | 
322 |     test('shows spinner animation for loading state', () => {
323 |       render(
324 |         <ToolInvocation 
325 |           {...defaultProps} 
326 |           state="call" 
327 |           isLatestMessage={true} 
328 |           status="processing" 
329 |         />
330 |       );
331 |       
332 |       const loader = screen.getByTestId('loader');
333 |       expect(loader).toHaveClass('animate-spin');
334 |     });
335 |   });
336 | 
337 |   describe('Accessibility', () => {
338 |     test('has clickable expand/collapse functionality', () => {
339 |       render(<ToolInvocation {...defaultProps} />);
340 |       
341 |       // Find the clickable div by its classes
342 |       const clickableElement = document.querySelector('.cursor-pointer');
343 |       expect(clickableElement).toBeInTheDocument();
344 |       expect(clickableElement).toHaveClass('cursor-pointer');
345 |     });
346 | 
347 |     test('is keyboard accessible', () => {
348 |       render(<ToolInvocation {...defaultProps} />);
349 |       
350 |       const expandButton = screen.getByTestId('chevron-down').closest('div')?.parentElement?.parentElement;
351 |       expandButton?.focus();
352 |       
353 |       fireEvent.keyDown(expandButton!, { key: 'Enter' });
354 |       // Note: The component doesn't actually handle keyboard events, 
355 |       // but we test that it doesn't crash
356 |       expect(expandButton).toBeInTheDocument();
357 |     });
358 | 
359 |     test('provides visual feedback on hover', () => {
360 |       render(<ToolInvocation {...defaultProps} />);
361 |       
362 |       // Find the element with hover classes
363 |       const hoverElement = document.querySelector('.hover\\:bg-muted\\/20');
364 |       expect(hoverElement).toBeInTheDocument();
365 |       expect(hoverElement).toHaveClass('hover:bg-muted/20');
366 |     });
367 | 
368 |     test('has proper semantic structure', () => {
369 |       render(<ToolInvocation {...defaultProps} />);
370 |       
371 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
372 |       fireEvent.click(clickableArea!);
373 |       
374 |       // Check for proper heading structure
375 |       expect(screen.getByText('Arguments')).toBeInTheDocument();
376 |       expect(screen.getByText('Result')).toBeInTheDocument();
377 |       
378 |       // Check for code elements (pre tags)
379 |       const preElements = document.querySelectorAll('pre');
380 |       expect(preElements.length).toBeGreaterThan(0);
381 |     });
382 |   });
383 | 
384 |   describe('Edge Cases', () => {
385 |     test('handles empty args object', () => {
386 |       render(<ToolInvocation {...defaultProps} args={{}} />);
387 |       
388 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
389 |       fireEvent.click(clickableArea!);
390 |       expect(screen.getByText('Arguments')).toBeInTheDocument();
391 |       expect(screen.getByText('{}')).toBeInTheDocument();
392 |     });
393 | 
394 |     test('handles empty result object', () => {
395 |       render(<ToolInvocation {...defaultProps} result={{}} />);
396 |       
397 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
398 |       fireEvent.click(clickableArea!);
399 |       expect(screen.getByText('Result')).toBeInTheDocument();
400 |       expect(screen.getByText('{}')).toBeInTheDocument();
401 |     });
402 | 
403 |     test('handles undefined values gracefully', () => {
404 |       render(
405 |         <ToolInvocation 
406 |           {...defaultProps} 
407 |           args={undefined} 
408 |           result={undefined} 
409 |         />
410 |       );
411 |       
412 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
413 |       fireEvent.click(clickableArea!);
414 |       expect(screen.queryByText('Arguments')).not.toBeInTheDocument();
415 |       expect(screen.queryByText('Result')).not.toBeInTheDocument();
416 |     });
417 | 
418 |     test('handles very long tool names', () => {
419 |       const longToolName = 'very-long-tool-name-that-might-overflow-the-container';
420 |       
421 |       render(<ToolInvocation {...defaultProps} toolName={longToolName} />);
422 |       
423 |       expect(screen.getByText(longToolName)).toBeInTheDocument();
424 |     });
425 | 
426 |     test('handles large result data', () => {
427 |       const largeResult = {
428 |         data: Array(100).fill(0).map((_, i) => ({ id: i, value: `item-${i}` }))
429 |       };
430 |       
431 |       render(<ToolInvocation {...defaultProps} result={largeResult} />);
432 |       
433 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
434 |       fireEvent.click(clickableArea!);
435 |       expect(screen.getByText('Result')).toBeInTheDocument();
436 |       
437 |       // Should have scrollable container for large content
438 |       const preElement = screen.getByText((content, element) => {
439 |         return element?.tagName.toLowerCase() === 'pre' && 
440 |                content.includes('"id": 0');
441 |       });
442 |       expect(preElement).toHaveClass('max-h-[300px]');
443 |       expect(preElement).toHaveClass('overflow-y-auto');
444 |     });
445 |   });
446 | 
447 |   describe('Integration Tests', () => {
448 |     test('complete expansion workflow with mixed content types', async () => {
449 |       const complexProps = {
450 |         ...defaultProps,
451 |         toolName: 'complex-tool',
452 |         state: 'result',
453 |         args: { 
454 |           stringParam: 'test',
455 |           objectParam: { nested: true },
456 |           arrayParam: [1, 2, 3]
457 |         },
458 |         result: '{"success": true, "data": [{"id": 1}, {"id": 2}]}',
459 |         isLatestMessage: true,
460 |         status: 'completed'
461 |       };
462 |       
463 |       render(<ToolInvocation {...complexProps} />);
464 |       
465 |       // Initial state
466 |       expect(screen.getByText('complex-tool')).toBeInTheDocument();
467 |       expect(screen.getByText('Completed')).toBeInTheDocument();
468 |       expect(screen.getByTestId('check-circle')).toBeInTheDocument();
469 |       
470 |       // Expand
471 |       const clickableArea = screen.getByTestId('chevron-down').closest('div')?.parentElement;
472 |       fireEvent.click(clickableArea!);
473 |       
474 |       await waitFor(() => {
475 |         expect(screen.getByText('Arguments')).toBeInTheDocument();
476 |         expect(screen.getByText('Result')).toBeInTheDocument();
477 |       });
478 |       
479 |       // Verify content formatting
480 |       expect(screen.getByText((content, element) => {
481 |         return element?.tagName.toLowerCase() === 'pre' && 
482 |                content.includes('"stringParam": "test"');
483 |       })).toBeInTheDocument();
484 |       
485 |       expect(screen.getByText((content, element) => {
486 |         return element?.tagName.toLowerCase() === 'pre' && 
487 |                content.includes('"success": true');
488 |       })).toBeInTheDocument();
489 |       
490 |       // Collapse
491 |       const collapseButton = screen.getByTestId('chevron-up').closest('div')?.parentElement;
492 |       fireEvent.click(collapseButton!);
493 |       expect(screen.queryByText('Arguments')).not.toBeInTheDocument();
494 |     });
495 | 
496 |     test('state transitions work correctly', () => {
497 |       const { rerender } = render(
498 |         <ToolInvocation 
499 |           {...defaultProps} 
500 |           state="call" 
501 |           isLatestMessage={true} 
502 |           status="processing" 
503 |         />
504 |       );
505 |       
506 |       // Initial loading state
507 |       expect(screen.getByText('Running')).toBeInTheDocument();
508 |       expect(screen.getByTestId('loader')).toBeInTheDocument();
509 |       
510 |       // Complete the tool
511 |       rerender(
512 |         <ToolInvocation 
513 |           {...defaultProps} 
514 |           state="result" 
515 |           isLatestMessage={false} 
516 |           status="completed" 
517 |         />
518 |       );
519 |       
520 |       expect(screen.getByText('Completed')).toBeInTheDocument();
521 |       expect(screen.getByTestId('check-circle')).toBeInTheDocument();
522 |     });
523 |   });
524 | });
```

__tests__/components/top-nav.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent } from '@testing-library/react';
3 | import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
4 | import { TopNav } from '../../components/top-nav';
5 | 
6 | // Mock Next.js navigation
7 | jest.mock('next/navigation', () => ({
8 |   useParams: jest.fn(() => ({ id: undefined })),
9 | }));
10 | 
11 | // Mock Next.js Link component
12 | jest.mock('next/link', () => ({
13 |   __esModule: true,
14 |   default: ({ children, href, className, ...props }: any) => (
15 |     <a href={href} className={className} {...props}>
16 |       {children}
17 |     </a>
18 |   ),
19 | }));
20 | 
21 | // Mock Lucide React icons
22 | jest.mock('lucide-react', () => ({
23 |   PlusCircle: ({ className }: { className?: string }) => (
24 |     <svg data-testid="plus-circle-icon" className={className} />
25 |   ),
26 |   Menu: ({ className }: { className?: string }) => (
27 |     <svg data-testid="menu-icon" className={className} />
28 |   ),
29 |   Share: ({ className }: { className?: string }) => (
30 |     <svg data-testid="share-icon" className={className} />
31 |   ),
32 | }));
33 | 
34 | // Mock UI components with proper prop forwarding
35 | jest.mock('../../components/ui/button', () => ({
36 |   Button: ({ 
37 |     children, 
38 |     onClick, 
39 |     variant, 
40 |     size, 
41 |     className, 
42 |     title, 
43 |     'aria-label': ariaLabel,
44 |     ...props 
45 |   }: any) => (
46 |     <button 
47 |       onClick={onClick} 
48 |       className={className} 
49 |       title={title}
50 |       aria-label={ariaLabel}
51 |       data-variant={variant}
52 |       data-size={size}
53 |       data-testid="new-chat-button"
54 |       {...props}
55 |     >
56 |       {children}
57 |     </button>
58 |   ),
59 | }));
60 | 
61 | jest.mock('../../components/ui/sidebar', () => ({
62 |   SidebarTrigger: ({ children }: { children: React.ReactNode }) => (
63 |     <div data-testid="sidebar-trigger">
64 |       {children}
65 |     </div>
66 |   ),
67 | }));
68 | 
69 | // Mock ChatShareDialog component
70 | jest.mock('../../components/chat-share-dialog', () => ({
71 |   ChatShareDialog: ({ isOpen, onOpenChange, chatId, chatTitle }: any) => 
72 |     isOpen ? (
73 |       <div data-testid="chat-share-dialog">
74 |         <div data-testid="dialog-chat-id">{chatId}</div>
75 |         <div data-testid="dialog-chat-title">{chatTitle}</div>
76 |         <button onClick={() => onOpenChange(false)}>Close</button>
77 |       </div>
78 |     ) : null,
79 | }));
80 | 
81 | // Mock toast
82 | jest.mock('sonner', () => ({
83 |   toast: {
84 |     info: jest.fn(),
85 |   },
86 | }));
87 | 
88 | // Mock fetch globally
89 | global.fetch = jest.fn();
90 | 
91 | // Mock window.location (simplified since we're not testing navigation)
92 | const originalLocation = window.location;
93 | 
94 | // Simplified mock that prevents JSDOM navigation errors
95 | const mockLocation = {
96 |   href: '',
97 |   assign: jest.fn(),
98 |   reload: jest.fn(),
99 |   replace: jest.fn(),
100 |   pathname: '/',
101 |   search: '',
102 |   hash: '',
103 |   host: 'localhost',
104 |   hostname: 'localhost',
105 |   origin: 'http://localhost',
106 |   port: '',
107 |   protocol: 'http:',
108 | };
109 | 
110 | // Set up location mock to prevent navigation errors
111 | beforeAll(() => {
112 |   delete (window as any).location;
113 |   window.location = mockLocation as any;
114 | });
115 | 
116 | // Restore original location after all tests
117 | afterAll(() => {
118 |   if (originalLocation) {
119 |     delete (window as any).location;
120 |     window.location = originalLocation;
121 |   }
122 | });
123 | 
124 | describe('TopNav', () => {
125 |   let queryClient: QueryClient;
126 |   let mockUseParams: jest.MockedFunction<any>;
127 | 
128 |   const renderWithProviders = (ui: React.ReactElement) => {
129 |     return render(
130 |       <QueryClientProvider client={queryClient}>
131 |         {ui}
132 |       </QueryClientProvider>
133 |     );
134 |   };
135 | 
136 |   beforeEach(() => {
137 |     queryClient = new QueryClient({
138 |       defaultOptions: {
139 |         queries: { retry: false },
140 |         mutations: { retry: false },
141 |       },
142 |     });
143 |     
144 |     jest.clearAllMocks();
145 |     mockLocation.href = '';
146 |     
147 |     // Setup useParams mock
148 |     mockUseParams = require('next/navigation').useParams;
149 |     mockUseParams.mockReturnValue({ id: undefined });
150 |     
151 |     // Mock fetch to return a successful response
152 |     (global.fetch as jest.Mock).mockResolvedValue({
153 |       ok: true,
154 |       json: () => Promise.resolve({ title: 'Test Chat' }),
155 |     });
156 |   });
157 | 
158 |   describe('Basic Rendering and Props', () => {
159 |     test('renders navigation bar with correct structure', () => {
160 |       renderWithProviders(<TopNav />);
161 |       
162 |       const nav = screen.getByRole('navigation');
163 |       expect(nav).toBeInTheDocument();
164 |       expect(nav).toHaveClass('sticky', 'top-0', 'z-50');
165 |     });
166 | 
167 |     test('renders ChatLima title', () => {
168 |       renderWithProviders(<TopNav />);
169 |       
170 |       const title = screen.getByRole('heading', { level: 1 });
171 |       expect(title).toBeInTheDocument();
172 |       expect(title).toHaveTextContent('ChatLima');
173 |       expect(title).toHaveClass('text-3xl', 'font-semibold');
174 |     });
175 | 
176 |     test('renders sidebar trigger with menu icon', () => {
177 |       renderWithProviders(<TopNav />);
178 |       
179 |       const sidebarTrigger = screen.getByTestId('sidebar-trigger');
180 |       expect(sidebarTrigger).toBeInTheDocument();
181 |       
182 |       const menuButton = screen.getByRole('button', { name: /open sidebar/i });
183 |       expect(menuButton).toBeInTheDocument();
184 |       expect(menuButton).toHaveAttribute('aria-label', 'Open sidebar');
185 |       
186 |       const menuIcon = screen.getByTestId('menu-icon');
187 |       expect(menuIcon).toBeInTheDocument();
188 |       expect(menuIcon).toHaveClass('h-4', 'w-4');
189 |     });
190 | 
191 |     test('renders new chat button with correct attributes', () => {
192 |       renderWithProviders(<TopNav />);
193 |       
194 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
195 |       expect(newChatButton).toBeInTheDocument();
196 |       expect(newChatButton).toHaveAttribute('aria-label', 'Start new chat');
197 |       expect(newChatButton).toHaveAttribute('title', 'New Chat');
198 |       expect(newChatButton).toHaveAttribute('data-variant', 'ghost');
199 |       expect(newChatButton).toHaveAttribute('data-size', 'icon');
200 |       
201 |       const plusIcon = screen.getByTestId('plus-circle-icon');
202 |       expect(plusIcon).toBeInTheDocument();
203 |       expect(plusIcon).toHaveClass('h-4', 'w-4');
204 |     });
205 | 
206 |     test('applies correct CSS classes to navigation elements', () => {
207 |       renderWithProviders(<TopNav />);
208 |       
209 |       const nav = screen.getByRole('navigation');
210 |       expect(nav).toHaveClass(
211 |         'sticky',
212 |         'top-0', 
213 |         'z-50',
214 |         'bg-background/95',
215 |         'backdrop-blur-md',
216 |         'border-b',
217 |         'border-border/40',
218 |         'px-4',
219 |         'py-4',
220 |         'h-[72px]',
221 |         'flex',
222 |         'items-center',
223 |         'justify-between'
224 |       );
225 |     });
226 |   });
227 | 
228 |   describe('User Interactions', () => {
229 |     test('new chat button is clickable and does not crash', () => {
230 |       renderWithProviders(<TopNav />);
231 |       
232 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
233 |       
234 |       // Should not crash when clicked (navigation is handled by window.location.href)
235 |       expect(() => fireEvent.click(newChatButton)).not.toThrow();
236 |     });
237 | 
238 |     test('handles multiple clicks on new chat button without crashing', () => {
239 |       renderWithProviders(<TopNav />);
240 |       
241 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
242 |       
243 |       // Should handle multiple clicks without issues
244 |       expect(() => {
245 |         fireEvent.click(newChatButton);
246 |         fireEvent.click(newChatButton);
247 |         fireEvent.click(newChatButton);
248 |       }).not.toThrow();
249 |     });
250 | 
251 |     test('sidebar trigger button is clickable', () => {
252 |       renderWithProviders(<TopNav />);
253 |       
254 |       const menuButton = screen.getByRole('button', { name: /open sidebar/i });
255 |       
256 |       // Should not throw error when clicked
257 |       expect(() => fireEvent.click(menuButton)).not.toThrow();
258 |     });
259 |   });
260 | 
261 |   describe('Accessibility', () => {
262 |     test('has proper ARIA attributes for navigation', () => {
263 |       renderWithProviders(<TopNav />);
264 |       
265 |       const nav = screen.getByRole('navigation');
266 |       expect(nav).toBeInTheDocument();
267 |     });
268 | 
269 |     test('sidebar trigger has accessible name and role', () => {
270 |       renderWithProviders(<TopNav />);
271 |       
272 |       const menuButton = screen.getByRole('button', { name: /open sidebar/i });
273 |       expect(menuButton).toHaveAttribute('aria-label', 'Open sidebar');
274 |     });
275 | 
276 |     test('new chat button has accessible name and role', () => {
277 |       renderWithProviders(<TopNav />);
278 |       
279 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
280 |       expect(newChatButton).toHaveAttribute('aria-label', 'Start new chat');
281 |       expect(newChatButton).toHaveAttribute('title', 'New Chat');
282 |     });
283 | 
284 |     test('supports keyboard navigation', () => {
285 |       renderWithProviders(<TopNav />);
286 |       
287 |       const menuButton = screen.getByRole('button', { name: /open sidebar/i });
288 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
289 |       
290 |       // Both buttons should be focusable
291 |       menuButton.focus();
292 |       expect(menuButton).toHaveFocus();
293 |       
294 |       newChatButton.focus();
295 |       expect(newChatButton).toHaveFocus();
296 |     });
297 | 
298 |     test('has proper heading hierarchy', () => {
299 |       renderWithProviders(<TopNav />);
300 |       
301 |       const heading = screen.getByRole('heading', { level: 1 });
302 |       expect(heading).toBeInTheDocument();
303 |       expect(heading).toHaveTextContent('ChatLima');
304 |     });
305 |   });
306 | 
307 |   describe('Component Structure', () => {
308 |     test('maintains correct layout structure', () => {
309 |       renderWithProviders(<TopNav />);
310 |       
311 |       const nav = screen.getByRole('navigation');
312 |       const sidebarTrigger = screen.getByTestId('sidebar-trigger');
313 |       const title = screen.getByRole('heading', { level: 1 });
314 |       const newChatButton = screen.getByTestId('new-chat-button');
315 |       
316 |       // All main elements should be present
317 |       expect(nav).toContainElement(sidebarTrigger);
318 |       expect(nav).toContainElement(title);
319 |       expect(nav).toContainElement(newChatButton);
320 |     });
321 | 
322 |     test('renders icons with correct dimensions', () => {
323 |       renderWithProviders(<TopNav />);
324 |       
325 |       const menuIcon = screen.getByTestId('menu-icon');
326 |       const plusIcon = screen.getByTestId('plus-circle-icon');
327 |       
328 |       expect(menuIcon).toHaveClass('h-4', 'w-4');
329 |       expect(plusIcon).toHaveClass('h-4', 'w-4');
330 |     });
331 |   });
332 | 
333 |   describe('Error Handling', () => {
334 |     test('handles navigation errors gracefully', () => {
335 |       renderWithProviders(<TopNav />);
336 |       
337 |       // Mock location.href to throw an error when set
338 |       const originalHref = mockLocation.href;
339 |       Object.defineProperty(mockLocation, 'href', {
340 |         get: () => originalHref,
341 |         set: () => {
342 |           throw new Error('Navigation error');
343 |         },
344 |         configurable: true,
345 |       });
346 |       
347 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
348 |       
349 |       // Should not crash the component when navigation fails
350 |       expect(() => fireEvent.click(newChatButton)).not.toThrow();
351 |       
352 |       // Restore original behavior
353 |       Object.defineProperty(mockLocation, 'href', {
354 |         value: '',
355 |         writable: true,
356 |         configurable: true,
357 |       });
358 |     });
359 |   });
360 | 
361 |   describe('Integration Tests', () => {
362 |     test('complete navigation workflow', () => {
363 |       renderWithProviders(<TopNav />);
364 |       
365 |       // User sees the navigation bar
366 |       expect(screen.getByRole('navigation')).toBeInTheDocument();
367 |       expect(screen.getByText('ChatLima')).toBeInTheDocument();
368 |       
369 |       // User can interact with sidebar trigger
370 |       const menuButton = screen.getByRole('button', { name: /open sidebar/i });
371 |       expect(menuButton).toBeEnabled();
372 |       
373 |       // User can start a new chat (navigation is handled by window.location.href)
374 |       const newChatButton = screen.getByRole('button', { name: /start new chat/i });
375 |       expect(() => fireEvent.click(newChatButton)).not.toThrow();
376 |       
377 |       // All interactive elements are accessible and functional
378 |       expect(menuButton).toBeInTheDocument();
379 |       expect(newChatButton).toBeInTheDocument();
380 |     });
381 |   });
382 | });
```

__tests__/components/web-search-suggestion.test.tsx
```
1 | /// <reference types="@testing-library/jest-dom" />
2 | import { render, screen, fireEvent, waitFor, cleanup } from '@testing-library/react';
3 | import { WebSearchSuggestion } from '../../components/web-search-suggestion';
4 | 
5 | // Mock framer-motion components
6 | jest.mock('motion/react', () => ({
7 |   motion: {
8 |     div: ({ children, initial, animate, exit, transition, ...props }: any) => (
9 |       <div {...props}>{children}</div>
10 |     ),
11 |   },
12 |   AnimatePresence: ({ children }: any) => <>{children}</>,
13 | }));
14 | 
15 | // Mock lucide-react icons
16 | jest.mock('lucide-react', () => ({
17 |   X: ({ className, ...props }: any) => (
18 |     <div data-testid="x-icon" className={className} {...props}>X</div>
19 |   ),
20 |   Lightbulb: ({ className, ...props }: any) => (
21 |     <div data-testid="lightbulb-icon" className={className} {...props}>Lightbulb</div>
22 |   ),
23 |   Globe: ({ className, ...props }: any) => (
24 |     <div data-testid="globe-icon" className={className} {...props}>Globe</div>
25 |   ),
26 | }));
27 | 
28 | // Mock web search context
29 | const mockSetWebSearchEnabled = jest.fn();
30 | jest.mock('@/lib/context/web-search-context', () => ({
31 |   useWebSearch: jest.fn(() => ({
32 |     webSearchEnabled: true,
33 |     setWebSearchEnabled: mockSetWebSearchEnabled,
34 |   })),
35 | }));
36 | 
37 | // Mock token counter
38 | jest.mock('@/lib/tokenCounter', () => ({
39 |   WEB_SEARCH_COST: 25,
40 | }));
41 | 
42 | // Mock client mount hook
43 | jest.mock('@/lib/hooks/use-client-mount', () => ({
44 |   useClientMount: jest.fn(() => true),
45 | }));
46 | 
47 | describe('WebSearchSuggestion', () => {
48 |   const defaultProps = {
49 |     messageId: 'test-message-id',
50 |     hasWebSearchResults: true,
51 |   };
52 | 
53 |   beforeEach(() => {
54 |     jest.clearAllMocks();
55 |     const { useClientMount } = jest.requireMock('@/lib/hooks/use-client-mount');
56 |     useClientMount.mockReturnValue(true);
57 |     // Reset the mock to return default values
58 |     const { useWebSearch } = jest.requireMock('@/lib/context/web-search-context');
59 |     useWebSearch.mockReturnValue({
60 |       webSearchEnabled: true,
61 |       setWebSearchEnabled: mockSetWebSearchEnabled,
62 |     });
63 |   });
64 | 
65 |   afterEach(() => {
66 |     cleanup();
67 |   });
68 | 
69 |   describe('Basic Rendering and Props', () => {
70 |     test('renders suggestion when web search is enabled and has results', () => {
71 |       render(<WebSearchSuggestion {...defaultProps} />);
72 |       
73 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
74 |       expect(screen.getByText(/Follow-up questions about these results don't need web search/)).toBeInTheDocument();
75 |       expect(screen.getByText(/save 25 credits per message/)).toBeInTheDocument();
76 |     });
77 | 
78 |     test('does not render when component is not mounted', () => {
79 |       const { useClientMount } = jest.requireMock('@/lib/hooks/use-client-mount');
80 |       useClientMount.mockReturnValue(false);
81 |       
82 |       render(<WebSearchSuggestion {...defaultProps} />);
83 |       
84 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
85 |     });
86 | 
87 |     test('does not render when web search is disabled', () => {
88 |       const { useWebSearch } = jest.requireMock('@/lib/context/web-search-context');
89 |       useWebSearch.mockReturnValue({
90 |         webSearchEnabled: false,
91 |         setWebSearchEnabled: mockSetWebSearchEnabled,
92 |       });
93 |       
94 |       render(<WebSearchSuggestion {...defaultProps} />);
95 |       
96 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
97 |     });
98 | 
99 |     test('does not render when hasWebSearchResults is false', () => {
100 |       render(<WebSearchSuggestion {...defaultProps} hasWebSearchResults={false} />);
101 |       
102 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
103 |     });
104 | 
105 |     test('does not render when hasWebSearchResults is undefined', () => {
106 |       render(<WebSearchSuggestion messageId="test-id" />);
107 |       
108 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
109 |     });
110 | 
111 |     test('renders all required UI elements', () => {
112 |       render(<WebSearchSuggestion {...defaultProps} />);
113 |       
114 |       expect(screen.getByTestId('lightbulb-icon')).toBeInTheDocument();
115 |       expect(screen.getByTestId('globe-icon')).toBeInTheDocument();
116 |       expect(screen.getByTestId('x-icon')).toBeInTheDocument();
117 |       expect(screen.getByRole('button', { name: /disable web search/i })).toBeInTheDocument();
118 |       expect(screen.getByRole('button', { name: /keep enabled/i })).toBeInTheDocument();
119 |       expect(screen.getByRole('button', { name: /dismiss suggestion/i })).toBeInTheDocument();
120 |     });
121 |   });
122 | 
123 |   describe('User Interactions', () => {
124 |     test('calls setWebSearchEnabled(false) when disable web search button is clicked', () => {
125 |       render(<WebSearchSuggestion {...defaultProps} />);
126 |       
127 |       const disableButton = screen.getByRole('button', { name: /disable web search/i });
128 |       fireEvent.click(disableButton);
129 |       
130 |       expect(mockSetWebSearchEnabled).toHaveBeenCalledWith(false);
131 |     });
132 | 
133 |     test('hides suggestion after disable web search button is clicked', () => {
134 |       render(<WebSearchSuggestion {...defaultProps} />);
135 |       
136 |       const disableButton = screen.getByRole('button', { name: /disable web search/i });
137 |       fireEvent.click(disableButton);
138 |       
139 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
140 |     });
141 | 
142 |     test('hides suggestion when keep enabled button is clicked', () => {
143 |       render(<WebSearchSuggestion {...defaultProps} />);
144 |       
145 |       const keepEnabledButton = screen.getByRole('button', { name: /keep enabled/i });
146 |       fireEvent.click(keepEnabledButton);
147 |       
148 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
149 |     });
150 | 
151 |     test('hides suggestion when dismiss button (X) is clicked', () => {
152 |       render(<WebSearchSuggestion {...defaultProps} />);
153 |       
154 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
155 |       fireEvent.click(dismissButton);
156 |       
157 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
158 |     });
159 | 
160 |     test('does not call setWebSearchEnabled when keep enabled button is clicked', () => {
161 |       render(<WebSearchSuggestion {...defaultProps} />);
162 |       
163 |       const keepEnabledButton = screen.getByRole('button', { name: /keep enabled/i });
164 |       fireEvent.click(keepEnabledButton);
165 |       
166 |       expect(mockSetWebSearchEnabled).not.toHaveBeenCalled();
167 |     });
168 | 
169 |     test('does not call setWebSearchEnabled when dismiss button (X) is clicked', () => {
170 |       render(<WebSearchSuggestion {...defaultProps} />);
171 |       
172 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
173 |       fireEvent.click(dismissButton);
174 |       
175 |       expect(mockSetWebSearchEnabled).not.toHaveBeenCalled();
176 |     });
177 |   });
178 | 
179 |   describe('State Management', () => {
180 |     test('stays hidden after being dismissed even when props change', () => {
181 |       const { rerender } = render(<WebSearchSuggestion {...defaultProps} />);
182 |       
183 |       // Dismiss the suggestion
184 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
185 |       fireEvent.click(dismissButton);
186 |       
187 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
188 |       
189 |       // Re-render with different messageId
190 |       rerender(<WebSearchSuggestion messageId="different-id" hasWebSearchResults={true} />);
191 |       
192 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
193 |     });
194 | 
195 |     test('stays hidden with new messageId after being dismissed', () => {
196 |       const { rerender } = render(<WebSearchSuggestion {...defaultProps} />);
197 |       
198 |       // Dismiss the suggestion
199 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
200 |       fireEvent.click(dismissButton);
201 |       
202 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
203 |       
204 |       // Re-render with different messageId - should still be dismissed
205 |       rerender(<WebSearchSuggestion messageId="different-id" hasWebSearchResults={true} />);
206 |       
207 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
208 |     });
209 | 
210 |     test('resets dismissed state when web search is disabled and re-enabled', async () => {
211 |       // Mock changing webSearchEnabled state
212 |       const { useWebSearch } = jest.requireMock('@/lib/context/web-search-context');
213 |       
214 |       const { rerender } = render(<WebSearchSuggestion {...defaultProps} />);
215 |       
216 |       // Dismiss the suggestion
217 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
218 |       fireEvent.click(dismissButton);
219 |       
220 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
221 |       
222 |       // Simulate web search being disabled
223 |       useWebSearch.mockReturnValue({
224 |         webSearchEnabled: false,
225 |         setWebSearchEnabled: mockSetWebSearchEnabled,
226 |       });
227 |       
228 |       rerender(<WebSearchSuggestion {...defaultProps} />);
229 |       
230 |       // Simulate web search being re-enabled
231 |       useWebSearch.mockReturnValue({
232 |         webSearchEnabled: true,
233 |         setWebSearchEnabled: mockSetWebSearchEnabled,
234 |       });
235 |       
236 |       rerender(<WebSearchSuggestion {...defaultProps} />);
237 |       
238 |       // Suggestion should appear again
239 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
240 |     });
241 |   });
242 | 
243 |   describe('Context Integration', () => {
244 |     test('responds to webSearchEnabled context changes', () => {
245 |       const { useWebSearch } = jest.requireMock('@/lib/context/web-search-context');
246 |       
247 |       // Start with web search enabled
248 |       useWebSearch.mockReturnValue({
249 |         webSearchEnabled: true,
250 |         setWebSearchEnabled: mockSetWebSearchEnabled,
251 |       });
252 |       
253 |       const { rerender } = render(<WebSearchSuggestion {...defaultProps} />);
254 |       
255 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
256 |       
257 |       // Disable web search
258 |       useWebSearch.mockReturnValue({
259 |         webSearchEnabled: false,
260 |         setWebSearchEnabled: mockSetWebSearchEnabled,
261 |       });
262 |       
263 |       rerender(<WebSearchSuggestion {...defaultProps} />);
264 |       
265 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
266 |     });
267 | 
268 |     test('uses setWebSearchEnabled from context correctly', () => {
269 |       render(<WebSearchSuggestion {...defaultProps} />);
270 |       
271 |       const disableButton = screen.getByRole('button', { name: /disable web search/i });
272 |       fireEvent.click(disableButton);
273 |       
274 |       expect(mockSetWebSearchEnabled).toHaveBeenCalledTimes(1);
275 |       expect(mockSetWebSearchEnabled).toHaveBeenCalledWith(false);
276 |     });
277 |   });
278 | 
279 |   describe('Accessibility', () => {
280 |     test('has proper ARIA label for dismiss button', () => {
281 |       render(<WebSearchSuggestion {...defaultProps} />);
282 |       
283 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
284 |       expect(dismissButton).toHaveAttribute('aria-label', 'Dismiss suggestion');
285 |     });
286 | 
287 |     test('all interactive elements are keyboard accessible', () => {
288 |       render(<WebSearchSuggestion {...defaultProps} />);
289 |       
290 |       const disableButton = screen.getByRole('button', { name: /disable web search/i });
291 |       const keepEnabledButton = screen.getByRole('button', { name: /keep enabled/i });
292 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
293 |       
294 |       expect(disableButton).toBeInTheDocument();
295 |       expect(keepEnabledButton).toBeInTheDocument();
296 |       expect(dismissButton).toBeInTheDocument();
297 |       
298 |       // All buttons should be focusable
299 |       disableButton.focus();
300 |       expect(disableButton).toHaveFocus();
301 |       
302 |       keepEnabledButton.focus();
303 |       expect(keepEnabledButton).toHaveFocus();
304 |       
305 |       dismissButton.focus();  
306 |       expect(dismissButton).toHaveFocus();
307 |     });
308 | 
309 |     test('has proper semantic structure', () => {
310 |       render(<WebSearchSuggestion {...defaultProps} />);
311 |       
312 |       // Check for headings and structure
313 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
314 |       expect(screen.getByText(/Follow-up questions about these results/)).toBeInTheDocument();
315 |       
316 |       // Check for icon elements
317 |       expect(screen.getByTestId('lightbulb-icon')).toBeInTheDocument();
318 |       expect(screen.getByTestId('globe-icon')).toBeInTheDocument();
319 |     });
320 |   });
321 | 
322 |   describe('Web Search Cost Display', () => {
323 |     test('displays correct web search cost', () => {
324 |       render(<WebSearchSuggestion {...defaultProps} />);
325 |       
326 |       expect(screen.getByText(/save 25 credits per message/)).toBeInTheDocument();
327 |     });
328 | 
329 |     test('updates cost display when WEB_SEARCH_COST changes', () => {
330 |       // Mock different cost
331 |       jest.mocked(require('@/lib/tokenCounter')).WEB_SEARCH_COST = 50;
332 |       
333 |       render(<WebSearchSuggestion {...defaultProps} />);
334 |       
335 |       expect(screen.getByText(/save 50 credits per message/)).toBeInTheDocument();
336 |     });
337 |   });
338 | 
339 |   describe('Error Handling', () => {
340 |     test('handles missing messageId gracefully', () => {
341 |       render(<WebSearchSuggestion messageId="" hasWebSearchResults={true} />);
342 |       
343 |       // Should still render if other conditions are met
344 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
345 |     });
346 | 
347 |     test('handles context errors gracefully', () => {
348 |       // Mock context throwing error
349 |       const { useWebSearch } = jest.requireMock('@/lib/context/web-search-context');
350 |       useWebSearch.mockImplementation(() => {
351 |         throw new Error('Context error');
352 |       });
353 |       
354 |       expect(() => render(<WebSearchSuggestion {...defaultProps} />)).toThrow('Context error');
355 |     });
356 | 
357 |     test('handles useClientMount returning false', () => {
358 |       const { useClientMount } = jest.requireMock('@/lib/hooks/use-client-mount');
359 |       useClientMount.mockReturnValue(false);
360 |       
361 |       render(<WebSearchSuggestion {...defaultProps} />);
362 |       
363 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
364 |     });
365 |   });
366 | 
367 |   describe('Integration Tests', () => {
368 |     test('complete user workflow: view suggestion, dismiss, and re-enable', async () => {
369 |       const { useWebSearch } = jest.requireMock('@/lib/context/web-search-context');
370 |       
371 |       const { rerender } = render(<WebSearchSuggestion {...defaultProps} />);
372 |       
373 |       // 1. User sees suggestion
374 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
375 |       
376 |       // 2. User dismisses suggestion
377 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
378 |       fireEvent.click(dismissButton);
379 |       
380 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
381 |       
382 |       // 3. Simulate web search being disabled (resets dismissed state)
383 |       useWebSearch.mockReturnValue({
384 |         webSearchEnabled: false,
385 |         setWebSearchEnabled: mockSetWebSearchEnabled,
386 |       });
387 |       
388 |       rerender(<WebSearchSuggestion {...defaultProps} />);
389 |       
390 |       // 4. Re-enable web search - suggestion should appear again
391 |       useWebSearch.mockReturnValue({
392 |         webSearchEnabled: true,
393 |         setWebSearchEnabled: mockSetWebSearchEnabled,
394 |       });
395 |       
396 |       rerender(<WebSearchSuggestion {...defaultProps} />);
397 |       
398 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
399 |     });
400 | 
401 |     test('complete user workflow: disable web search feature', () => {
402 |       render(<WebSearchSuggestion {...defaultProps} />);
403 |       
404 |       // 1. User sees suggestion
405 |       expect(screen.getByText('Save credits on follow-up questions')).toBeInTheDocument();
406 |       
407 |       // 2. User clicks disable web search
408 |       const disableButton = screen.getByRole('button', { name: /disable web search/i });
409 |       fireEvent.click(disableButton);
410 |       
411 |       // 3. Web search should be disabled and suggestion hidden
412 |       expect(mockSetWebSearchEnabled).toHaveBeenCalledWith(false);
413 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
414 |     });
415 | 
416 |     test('multiple message workflow: suggestion stays dismissed across messages', () => {
417 |       const { rerender } = render(<WebSearchSuggestion {...defaultProps} />);
418 |       
419 |       // 1. Dismiss first message suggestion
420 |       const dismissButton = screen.getByRole('button', { name: /dismiss suggestion/i });
421 |       fireEvent.click(dismissButton);
422 |       
423 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
424 |       
425 |       // 2. New message with different ID should still be dismissed
426 |       rerender(<WebSearchSuggestion messageId="new-message-id" hasWebSearchResults={true} />);
427 |       
428 |       expect(screen.queryByText('Save credits on follow-up questions')).not.toBeInTheDocument();
429 |     });
430 |   });
431 | });
```

app/privacy/page.tsx
```
1 | export const metadata = {
2 |   title: 'Privacy Policy - ChatLima',
3 |   description: 'Privacy Policy for using the ChatLima platform',
4 | };
5 | 
6 | export default function PrivacyPage() {
7 |   return (
8 |     <div className="h-full overflow-y-auto">
9 |       <div className="min-h-screen bg-gray-50">
10 |         <div className="container mx-auto px-4 py-12 max-w-4xl">
11 |           <div className="bg-white rounded-lg shadow-sm p-8 md:p-12">
12 |             <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Privacy Policy</h1>
13 |             
14 |             <p className="text-gray-600 mb-8 italic">
15 |               Last updated: {new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' })}
16 |             </p>
17 | 
18 |             <div className="space-y-8">
19 |               <section>
20 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Introduction</h2>
21 |                 <p className="text-gray-700 leading-relaxed">
22 |                   Welcome to ChatLima (&ldquo;we,&rdquo; &ldquo;our,&rdquo; or &ldquo;us&rdquo;). 
23 |                   This Privacy Policy explains how we collect, use, and protect your information when you use our website 
24 |                   (https://chatlima.com) and services, including our AI-powered chat platform, APIs, and related features.
25 |                 </p>
26 |               </section>
27 | 
28 |               <section>
29 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Contact Information</h2>
30 |                 <p className="text-gray-700 mb-4">
31 |                   If you have any questions about this Privacy Policy, please contact us at:
32 |                 </p>
33 |                 <div className="bg-gray-50 p-4 rounded-lg">
34 |                   <ul className="space-y-2">
35 |                     <li className="flex items-center space-x-2">
36 |                       <span className="text-gray-600">Email:</span>
37 |                       <a href="mailto:getchatlima@gmail.com" className="text-blue-600 hover:text-blue-800">getchatlima@gmail.com</a>
38 |                     </li>
39 |                     <li className="flex items-center space-x-2">
40 |                       <span className="text-gray-600">Website:</span>
41 |                       <a href="https://chatlima.com" className="text-blue-600 hover:text-blue-800">https://chatlima.com</a>
42 |                     </li>
43 |                   </ul>
44 |                 </div>
45 |               </section>
46 | 
47 |               <section>
48 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Information We Collect</h2>
49 |                 
50 |                 <div className="space-y-6">
51 |                   <div>
52 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">Personal Information</h3>
53 |                     <p className="text-gray-700 mb-3">
54 |                       We may collect personal information that you voluntarily provide to us, including but not limited to:
55 |                     </p>
56 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
57 |                       <li>Name and email address (for registered users)</li>
58 |                       <li>Google OAuth account information (when using Google sign-in)</li>
59 |                       <li>Billing and payment information (for premium features)</li>
60 |                       <li>API keys you choose to provide for third-party services</li>
61 |                       <li>Account credentials and preferences</li>
62 |                     </ul>
63 |                   </div>
64 | 
65 |                   <div>
66 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">Chat Content and Usage Data</h3>
67 |                     <p className="text-gray-700 mb-3">
68 |                       When you use our AI chat services, we collect:
69 |                     </p>
70 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
71 |                       <li>Chat messages and conversations</li>
72 |                       <li>AI model responses and generated content</li>
73 |                       <li>Uploaded images and files (processed for AI analysis)</li>
74 |                       <li>Model preferences and settings</li>
75 |                       <li>Usage patterns and feature interactions</li>
76 |                     </ul>
77 |                   </div>
78 | 
79 |                   <div>
80 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">Technical and Usage Data</h3>
81 |                     <p className="text-gray-700 mb-3">
82 |                       We automatically collect technical data when you visit our website, including:
83 |                     </p>
84 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
85 |                       <li>IP address and device information</li>
86 |                       <li>Browser type and version</li>
87 |                       <li>Pages visited and time spent</li>
88 |                       <li>Error logs and performance metrics</li>
89 |                       <li>Interaction with our services and features</li>
90 |                     </ul>
91 |                   </div>
92 |                 </div>
93 |               </section>
94 | 
95 |               <section>
96 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">How We Use Your Information</h2>
97 |                 <p className="text-gray-700 mb-4">
98 |                   We use the information we collect to:
99 |                 </p>
100 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
101 |                   <li>Provide and improve our AI chat services</li>
102 |                   <li>Process your requests and generate AI responses</li>
103 |                   <li>Manage your account and billing</li>
104 |                   <li>Analyze usage patterns to enhance our platform</li>
105 |                   <li>Ensure security and prevent abuse</li>
106 |                   <li>Communicate with you about our services</li>
107 |                   <li>Comply with legal obligations</li>
108 |                 </ul>
109 |               </section>
110 | 
111 |               <section>
112 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Third-Party Services</h2>
113 |                 <p className="text-gray-700 mb-4">
114 |                   Our platform integrates with third-party services that may collect and process your data 
115 |                   according to their own privacy policies:
116 |                 </p>
117 |                 <div className="bg-gray-50 p-4 rounded-lg">
118 |                   <ul className="space-y-3">
119 |                     <li>
120 |                       <span className="font-medium">AI Providers:</span>
121 |                       <span className="text-gray-700"> OpenRouter, Requesty, OpenAI, Anthropic, Google, and other AI model providers for chat functionality</span>
122 |                     </li>
123 |                     <li>
124 |                       <span className="font-medium">Authentication:</span>
125 |                       <span className="text-gray-700"> Google OAuth for user authentication</span>
126 |                     </li>
127 |                     <li>
128 |                       <span className="font-medium">Billing:</span>
129 |                       <span className="text-gray-700"> Polar for payment processing and subscription management</span>
130 |                     </li>
131 |                     <li>
132 |                       <span className="font-medium">Database:</span>
133 |                       <span className="text-gray-700"> Neon for data storage and management</span>
134 |                     </li>
135 |                     <li>
136 |                       <span className="font-medium">MCP Servers:</span>
137 |                       <span className="text-gray-700"> Various MCP (Model Context Protocol) servers for extended functionality</span>
138 |                     </li>
139 |                   </ul>
140 |                 </div>
141 |               </section>
142 | 
143 |               <section>
144 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Data Security</h2>
145 |                 <p className="text-gray-700 mb-4">
146 |                   We implement appropriate security measures to protect your personal information and chat content:
147 |                 </p>
148 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
149 |                   <li>Encryption of data in transit and at rest</li>
150 |                   <li>Secure authentication and session management</li>
151 |                   <li>Regular security audits and monitoring</li>
152 |                   <li>Access controls and data protection measures</li>
153 |                   <li>Client-side processing for sensitive operations like image handling</li>
154 |                 </ul>
155 |                 <p className="text-gray-700 mt-4">
156 |                   However, no method of transmission over the Internet or electronic storage is 100% secure. 
157 |                   We cannot guarantee absolute security of your data.
158 |                 </p>
159 |               </section>
160 | 
161 |               <section>
162 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Data Retention</h2>
163 |                 <p className="text-gray-700 mb-4">
164 |                   We retain your information for as long as necessary to provide our services:
165 |                 </p>
166 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
167 |                   <li>Chat content is retained while your account is active</li>
168 |                   <li>Account information is kept for billing and service purposes</li>
169 |                   <li>Usage data may be retained for analytics and improvement</li>
170 |                   <li>Data may be deleted upon account closure or upon request</li>
171 |                 </ul>
172 |               </section>
173 | 
174 |               <section>
175 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Your Rights and Choices</h2>
176 |                 <p className="text-gray-700 mb-4">
177 |                   You have certain rights regarding your personal information:
178 |                 </p>
179 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
180 |                   <li>Access and review your personal data</li>
181 |                   <li>Request correction of inaccurate information</li>
182 |                   <li>Request deletion of your data (subject to legal requirements)</li>
183 |                   <li>Opt out of certain data processing activities</li>
184 |                   <li>Export your chat data and account information</li>
185 |                   <li>Control your privacy settings and preferences</li>
186 |                 </ul>
187 |               </section>
188 | 
189 |               <section>
190 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Anonymous Usage</h2>
191 |                 <p className="text-gray-700">
192 |                   We support anonymous usage of our platform with limited functionality. 
193 |                   Anonymous users are subject to usage limits and may have restricted access to certain features. 
194 |                   We still collect minimal technical data necessary for service operation and security.
195 |                 </p>
196 |               </section>
197 | 
198 |               <section>
199 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Children&apos;s Privacy</h2>
200 |                 <p className="text-gray-700">
201 |                   Our services are not intended for children under 13 years of age. 
202 |                   We do not knowingly collect personal information from children under 13. 
203 |                   If you are a parent or guardian and believe your child has provided us with personal information, 
204 |                   please contact us immediately.
205 |                 </p>
206 |               </section>
207 | 
208 |               <section>
209 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Changes to This Policy</h2>
210 |                 <p className="text-gray-700">
211 |                   We may update this Privacy Policy from time to time. We will notify you of any material changes 
212 |                   by posting the new policy on this page and updating the &ldquo;Last updated&rdquo; date. 
213 |                   Your continued use of our services after such changes constitutes acceptance of the updated policy.
214 |                 </p>
215 |               </section>
216 | 
217 |               <section>
218 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Your Acceptance</h2>
219 |                 <p className="text-gray-700">
220 |                   By using our website and services, you signify your acceptance of this Privacy Policy. 
221 |                   If you do not agree to this policy, please do not use our services.
222 |                 </p>
223 |               </section>
224 | 
225 |               <section>
226 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">Contact Us</h2>
227 |                 <div className="bg-gray-50 p-6 rounded-lg">
228 |                   <p className="text-gray-700 mb-4">
229 |                     If you have any questions about this Privacy Policy or our data practices, please contact us at:
230 |                   </p>
231 |                   <ul className="space-y-2">
232 |                     <li className="flex items-center space-x-2">
233 |                       <span className="text-gray-600">Email:</span>
234 |                       <a href="mailto:getchatlima@gmail.com" className="text-blue-600 hover:text-blue-800">getchatlima@gmail.com</a>
235 |                     </li>
236 |                     <li className="flex items-center space-x-2">
237 |                       <span className="text-gray-600">Website:</span>
238 |                       <a href="https://chatlima.com" className="text-blue-600 hover:text-blue-800">https://chatlima.com</a>
239 |                     </li>
240 |                   </ul>
241 |                 </div>
242 |               </section>
243 |             </div>
244 |           </div>
245 |         </div>
246 |       </div>
247 |     </div>
248 |   );
249 | } 
```

app/robots.txt/route.ts
```
1 | import { NextRequest, NextResponse } from 'next/server'
2 | 
3 | export async function GET(request: NextRequest) {
4 |     const host = request.headers.get('host')
5 |     const protocol = request.headers.get('x-forwarded-proto') || 'https'
6 |     const baseUrl = `${protocol}://${host}`
7 | 
8 |     // Check if we're in production (chatlima.com)
9 |     const isProduction = host?.includes('chatlima.com')
10 | 
11 |     let robotsContent: string
12 | 
13 |     if (isProduction) {
14 |         // Production robots.txt - allow crawling with restrictions
15 |         robotsContent = `User-agent: *
16 | Allow: /
17 | Disallow: /api/
18 | Disallow: /chat/
19 | Disallow: /checkout/
20 | Disallow: /auth/
21 | Crawl-delay: 1
22 | 
23 | # Protect user privacy - no crawling of chat content
24 | User-agent: *
25 | Disallow: /chat/*
26 | 
27 | # Allow access to public pages
28 | Allow: /$
29 | Allow: /docs
30 | Allow: /docs/*
31 | 
32 | Sitemap: https://www.chatlima.com/sitemap.xml`
33 |     } else {
34 |         // Development/staging - disallow all crawling
35 |         robotsContent = `User-agent: *
36 | Disallow: /
37 | 
38 | # Development environment - no crawling allowed`
39 |     }
40 | 
41 |     return new NextResponse(robotsContent, {
42 |         headers: {
43 |             'Content-Type': 'text/plain',
44 |             'Cache-Control': 'public, max-age=3600', // Cache for 1 hour
45 |         },
46 |     })
47 | } 
```

app/sitemap.xml/route.ts
```
1 | import { NextRequest, NextResponse } from 'next/server'
2 | 
3 | export async function GET(request: NextRequest) {
4 |     const host = request.headers.get('host')
5 |     const protocol = request.headers.get('x-forwarded-proto') || 'https'
6 |     const baseUrl = `${protocol}://${host}`
7 | 
8 |     // Only generate sitemap for production
9 |     const isProduction = host?.includes('chatlima.com')
10 | 
11 |     if (!isProduction) {
12 |         return new NextResponse('Sitemap not available in development', {
13 |             status: 404,
14 |             headers: { 'Content-Type': 'text/plain' }
15 |         })
16 |     }
17 | 
18 |     const currentDate = new Date().toISOString()
19 | 
20 |     // Define static pages to include in sitemap
21 |     const staticPages = [
22 |         {
23 |             url: '/',
24 |             lastmod: currentDate,
25 |             changefreq: 'daily',
26 |             priority: '1.0'
27 |         }
28 |         // Future pages can be added here:
29 |         // {
30 |         //     url: '/about',
31 |         //     lastmod: currentDate,
32 |         //     changefreq: 'monthly',
33 |         //     priority: '0.8'
34 |         // },
35 |         // {
36 |         //     url: '/pricing',
37 |         //     lastmod: currentDate,
38 |         //     changefreq: 'weekly',
39 |         //     priority: '0.9'
40 |         // }
41 |     ]
42 | 
43 |     const urlEntries = staticPages.map(page => `    <url>
44 |         <loc>${baseUrl}${page.url}</loc>
45 |         <lastmod>${page.lastmod}</lastmod>
46 |         <changefreq>${page.changefreq}</changefreq>
47 |         <priority>${page.priority}</priority>
48 |     </url>`).join('\n')
49 | 
50 |     const sitemapXml = `<?xml version="1.0" encoding="UTF-8"?>
51 | <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
52 | ${urlEntries}
53 | </urlset>`
54 | 
55 |     return new NextResponse(sitemapXml, {
56 |         headers: {
57 |             'Content-Type': 'application/xml',
58 |             'Cache-Control': 'public, max-age=86400', // Cache for 24 hours
59 |         },
60 |     })
61 | } 
```

app/terms/page.tsx
```
1 | export const metadata = {
2 |   title: 'Terms of Service - ChatLima',
3 |   description: 'Terms of Service for using the ChatLima platform',
4 | };
5 | 
6 | export default function TermsPage() {
7 |   return (
8 |     <div className="h-full overflow-y-auto">
9 |       <div className="min-h-screen bg-gray-50">
10 |         <div className="container mx-auto px-4 py-12 max-w-4xl">
11 |           <div className="bg-white rounded-lg shadow-sm p-8 md:p-12">
12 |             <h1 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Terms of Service</h1>
13 | 
14 |             <p className="text-gray-600 mb-8 italic">
15 |               Last Updated: {new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' })}
16 |             </p>
17 | 
18 |             <div className="space-y-8">
19 |               <section>
20 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">1. Introduction</h2>
21 |                 <p className="text-gray-700 leading-relaxed">
22 |                   Welcome to ChatLima (“we,” “our,” or “us”). By accessing or using our website (https://chatlima.com) and
23 |                   services, including any AI-powered chat experiences, APIs, or related features (collectively, the “Platform”),
24 |                   you agree to be bound by these Terms of Service (“Terms”). Please read these Terms carefully before using the Platform.
25 |                 </p>
26 |               </section>
27 | 
28 |               <section>
29 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">2. Definitions</h2>
30 |                 <ul className="space-y-2 text-gray-700">
31 |                   <li className="flex items-baseline space-x-2">
32 |                     <span className="font-medium">“Platform”</span>
33 |                     <span>refers to the ChatLima website, applications, APIs, and all related services.</span>
34 |                   </li>
35 |                   <li className="flex items-baseline space-x-2">
36 |                     <span className="font-medium">“Content”</span>
37 |                     <span>refers to prompts, messages, files, outputs generated by the Platform, and any other material available through the Platform.</span>
38 |                   </li>
39 |                   <li className="flex items-baseline space-x-2">
40 |                     <span className="font-medium">“User”</span>
41 |                     <span>refers to any individual or entity who accesses or uses the Platform.</span>
42 |                   </li>
43 |                   <li className="flex items-baseline space-x-2">
44 |                     <span className="font-medium">“User Content”</span>
45 |                     <span>refers to content submitted, uploaded, or provided by Users (e.g., prompts, files).</span>
46 |                   </li>
47 |                   <li className="flex items-baseline space-x-2">
48 |                     <span className="font-medium">“AI Output”</span>
49 |                     <span>refers to content generated by the Platform’s AI models in response to User inputs.</span>
50 |                   </li>
51 |                 </ul>
52 |               </section>
53 | 
54 |               <section>
55 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">3. Account Registration</h2>
56 |                 <div className="space-y-6">
57 |                   <div>
58 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">3.1 Account Requirements</h3>
59 |                     <p className="text-gray-700 mb-3">To use certain features, you must create an account by providing:</p>
60 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
61 |                       <li>Valid email address</li>
62 |                       <li>Full name or organization name</li>
63 |                       <li>Billing details (for paid features)</li>
64 |                       <li>Any other information reasonably required to provide the services</li>
65 |                     </ul>
66 |                   </div>
67 |                   <div>
68 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">3.2 Account Responsibilities</h3>
69 |                     <p className="text-gray-700 mb-3">You agree to:</p>
70 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
71 |                       <li>Provide accurate, current, and complete information</li>
72 |                       <li>Maintain the security of your credentials</li>
73 |                       <li>Accept responsibility for all activity under your account</li>
74 |                       <li>Promptly notify us of any unauthorized access or security incident</li>
75 |                     </ul>
76 |                   </div>
77 |                   <div>
78 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">3.3 Eligibility</h3>
79 |                     <p className="text-gray-700">
80 |                       You must be at least 13 years old, or the minimum age required in your jurisdiction, to use the Platform.
81 |                       If you are under the age of majority, you may only use the Platform under the supervision of a parent or legal guardian who agrees to these Terms.
82 |                     </p>
83 |                   </div>
84 |                 </div>
85 |               </section>
86 | 
87 |               <section>
88 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">4. Use of the Platform and Content</h2>
89 |                 <div className="space-y-6">
90 |                   <div>
91 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">4.1 User Content</h3>
92 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
93 |                       <li>You retain ownership of your User Content.</li>
94 |                       <li>You grant us a worldwide, non-exclusive, royalty-free license to use, host, store, reproduce, and display your User Content solely as necessary to operate, maintain, and improve the Platform.</li>
95 |                       <li>You represent and warrant that you have all rights necessary to submit your User Content and that it does not infringe the rights of any third party or violate applicable law.</li>
96 |                     </ul>
97 |                   </div>
98 |                   <div>
99 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">4.2 AI Output</h3>
100 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
101 |                       <li>AI Output may be inaccurate, incomplete, or reflect biases. You are responsible for independently verifying the accuracy and appropriateness of any AI Output before relying on it.</li>
102 |                       <li>Subject to applicable law, and to the extent permitted by model and data provider terms, you may use AI Output for your permitted purposes. Do not imply endorsement or factual accuracy without verification.</li>
103 |                       <li>You must not use AI Output to create, distribute, or facilitate harmful, illegal, or deceptive content, including but not limited to malware, fraud, or violations of privacy or intellectual property rights.</li>
104 |                     </ul>
105 |                   </div>
106 |                   <div>
107 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">4.3 Acceptable Use</h3>
108 |                     <p className="text-gray-700 mb-3">You agree not to:</p>
109 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
110 |                       <li>Use the Platform in violation of any applicable law or regulation</li>
111 |                       <li>Submit or generate content that is illegal, harmful, or exploits minors</li>
112 |                       <li>Infringe intellectual property or privacy rights</li>
113 |                       <li>Reverse engineer, attempt to extract model weights, or misuse APIs</li>
114 |                       <li>Bypass usage limits, rate limits, or security controls</li>
115 |                       <li>Use the Platform for autonomous weapons, surveillance targeting individuals, or other high-risk uses without appropriate safeguards</li>
116 |                     </ul>
117 |                   </div>
118 |                 </div>
119 |               </section>
120 | 
121 |               <section>
122 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">5. Plans, Credits, Payments and Refunds</h2>
123 |                 <div className="space-y-6">
124 |                   <div>
125 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">5.1 Pricing and Credits</h3>
126 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
127 |                       <li>Prices and credit costs are listed on the Platform and may change at any time.</li>
128 |                       <li>Taxes and fees may apply based on your location.</li>
129 |                       <li>Usage may consume credits or incur charges per request or per feature.</li>
130 |                     </ul>
131 |                   </div>
132 |                   <div>
133 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">5.2 Billing</h3>
134 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
135 |                       <li>By providing a payment method, you authorize us (and our processors) to charge applicable fees.</li>
136 |                       <li>Subscriptions renew automatically until canceled, where applicable.</li>
137 |                       <li>You are responsible for maintaining accurate billing information.</li>
138 |                     </ul>
139 |                   </div>
140 |                   <div>
141 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">5.3 Refund Policy</h3>
142 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
143 |                       <li>Unless required by law or expressly stated otherwise, purchases are non-refundable. If we publish a specific refund window for certain purchases, that policy will govern those purchases.</li>
144 |                       <li>We may refuse refunds in cases of abuse, excessive chargebacks, or violation of these Terms.</li>
145 |                     </ul>
146 |                   </div>
147 |                 </div>
148 |               </section>
149 | 
150 |               <section>
151 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">6. Third-Party Services</h2>
152 |                 <p className="text-gray-700">
153 |                   The Platform may use or integrate with third-party services (e.g., model providers, payment processors).
154 |                   Your use of such services may be subject to the third parties’ terms and privacy policies. We are not responsible for third-party services, content, or practices.
155 |                 </p>
156 |               </section>
157 | 
158 |               <section>
159 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">7. Termination</h2>
160 |                 <p className="text-gray-700 mb-3">
161 |                   We may suspend or terminate your access to the Platform at any time, with or without notice, including if you violate these Terms, engage in abusive or fraudulent activity, create security risks, or if we discontinue the Platform. You may stop using the Platform at any time. Upon termination, your right to access the Platform will cease, but certain provisions will survive as noted below.
162 |                 </p>
163 |               </section>
164 | 
165 |               <section>
166 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">8. Intellectual Property</h2>
167 |                 <div className="space-y-6">
168 |                   <div>
169 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">8.1 Platform IP</h3>
170 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
171 |                       <li>The Platform and its underlying technology, software, interfaces, and designs are owned by us or our licensors and are protected by intellectual property laws.</li>
172 |                       <li>Except for the rights expressly granted in these Terms, no rights are transferred to you, and all rights are reserved.</li>
173 |                     </ul>
174 |                   </div>
175 |                   <div>
176 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">8.2 Feedback</h3>
177 |                     <p className="text-gray-700">
178 |                       If you provide feedback, ideas, or suggestions, you grant us a worldwide, perpetual, irrevocable, royalty-free license to use and exploit that feedback without restriction or compensation.
179 |                     </p>
180 |                   </div>
181 |                 </div>
182 |               </section>
183 | 
184 |               <section>
185 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">9. Privacy</h2>
186 |                 <p className="text-gray-700">
187 |                   Our collection and use of personal information is described in our Privacy Policy. By using the Platform, you consent to our data practices as described there. Do not submit personal or sensitive information that you do not want processed by AI systems.
188 |                 </p>
189 |               </section>
190 | 
191 |               <section>
192 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">10. Disclaimer of Warranties</h2>
193 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
194 |                   <li>The Platform is provided “as is” and “as available”.</li>
195 |                   <li>We disclaim all warranties, express or implied, including warranties of merchantability, fitness for a particular purpose, and non-infringement.</li>
196 |                   <li>We do not warrant that the Platform will be error-free, uninterrupted, secure, or that AI Output will be accurate or reliable.</li>
197 |                 </ul>
198 |               </section>
199 | 
200 |               <section>
201 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">11. Limitation of Liability</h2>
202 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
203 |                   <li>To the maximum extent permitted by law, we are not liable for indirect, incidental, special, consequential, or punitive damages, or any loss of profits, data, use, or goodwill.</li>
204 |                   <li>Our total liability for any claims arising out of or relating to the Platform will not exceed the amounts paid by you to us in the twelve (12) months preceding the event giving rise to liability.</li>
205 |                   <li>We are not responsible for User Content, AI Output, or third-party services, and you are solely responsible for your use of the Platform and reliance on AI Output.</li>
206 |                 </ul>
207 |               </section>
208 | 
209 |               <section>
210 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">12. Indemnification</h2>
211 |                 <p className="text-gray-700">
212 |                   You agree to defend, indemnify, and hold harmless ChatLima and its affiliates, officers, employees, and agents from and against any claims, liabilities, damages, losses, and expenses (including reasonable legal fees) arising from or related to your use of the Platform, your User Content, or your violation of these Terms or applicable law.
213 |                 </p>
214 |               </section>
215 | 
216 |               <section>
217 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">13. Governing Law and Dispute Resolution</h2>
218 |                 <div className="space-y-6">
219 |                   <div>
220 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">13.1 Governing Law</h3>
221 |                     <p className="text-gray-700">
222 |                       These Terms are governed by the laws of Queensland, Australia, without regard to conflict of laws principles.
223 |                     </p>
224 |                   </div>
225 |                   <div>
226 |                     <h3 className="text-xl font-medium text-gray-900 mb-3">13.2 Dispute Process</h3>
227 |                     <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
228 |                       <li>Parties will first attempt to resolve disputes informally within 30 days.</li>
229 |                       <li>Subject to applicable law, disputes will be brought exclusively in the courts of Queensland, Australia, and the parties consent to personal jurisdiction there.</li>
230 |                       <li>The prevailing party may recover reasonable legal fees and costs.</li>
231 |                     </ul>
232 |                   </div>
233 |                 </div>
234 |               </section>
235 | 
236 |               <section>
237 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">14. Changes to Terms</h2>
238 |                 <p className="text-gray-700 mb-3">We may modify these Terms at any time by:</p>
239 |                 <ul className="list-disc list-inside space-y-1 text-gray-700 ml-4">
240 |                   <li>Posting updated Terms on the Platform</li>
241 |                   <li>Notifying users of material changes when appropriate</li>
242 |                   <li>Continued use after changes constitutes acceptance</li>
243 |                 </ul>
244 |               </section>
245 | 
246 |               <section>
247 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">15. Contact Information</h2>
248 |                 <div className="bg-gray-50 p-6 rounded-lg">
249 |                   <p className="text-gray-700 mb-4">For questions about these Terms, contact us at:</p>
250 |                   <ul className="space-y-2">
251 |                     <li className="flex items-center space-x-2">
252 |                       <span className="text-gray-600">Email:</span>
253 |                       <a href="mailto:getchatlima@gmail.com" className="text-blue-600 hover:text-blue-800">getchatlima@gmail.com</a>
254 |                     </li>
255 |                     <li className="flex items-center space-x-2">
256 |                       <span className="text-gray-600">Website:</span>
257 |                       <a href="https://chatlima.com" className="text-blue-600 hover:text-blue-800">https://chatlima.com</a>
258 |                     </li>
259 |                   </ul>
260 |                 </div>
261 |               </section>
262 | 
263 |               <section>
264 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">16. Severability</h2>
265 |                 <p className="text-gray-700">
266 |                   If any provision of these Terms is found to be unenforceable, the remaining provisions will remain in full force and effect.
267 |                 </p>
268 |               </section>
269 | 
270 |               <section>
271 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-4">17. Entire Agreement</h2>
272 |                 <p className="text-gray-700">
273 |                   These Terms constitute the entire agreement between you and ChatLima regarding your use of the Platform and supersede any prior agreements on this subject.
274 |                 </p>
275 |               </section>
276 | 
277 |               <section>
278 |                 <h2 className="text-2xl font-semibold text-gray-900 mb-2">18. Region-Specific Disclosures</h2>
279 |                 <p className="text-gray-700">
280 |                   If required by local law, additional terms may apply and will be provided or referenced on the Platform.
281 |                 </p>
282 |               </section>
283 |             </div>
284 |           </div>
285 |         </div>
286 |       </div>
287 |     </div>
288 |   );
289 | }
```

components/auth/AnonymousAuth.tsx
```
1 | "use client";
2 | 
3 | import { useEffect, useState, useRef } from 'react';
4 | import { useAuth, signIn } from '@/hooks/useAuth';
5 | 
6 | export function AnonymousAuth() {
7 |   const { session, isPending } = useAuth();
8 |   const [error, setError] = useState<string | null>(null);
9 |   const [isAttemptingSignIn, setIsAttemptingSignIn] = useState(false);
10 |   const attemptedRef = useRef(false);
11 | 
12 |   useEffect(() => {
13 |     // Prevent multiple simultaneous sign-in attempts
14 |     if (isAttemptingSignIn || attemptedRef.current) {
15 |       return;
16 |     }
17 | 
18 |     // Only try to sign in anonymously if:
19 |     // 1. We're not already signing in
20 |     // 2. Session is not pending (loading)
21 |     // 3. There's no active session
22 |     // 4. We haven't already attempted to sign in
23 |     if (!isPending && !session) {
24 |       const attemptSignIn = async () => {
25 |         setIsAttemptingSignIn(true);
26 |         attemptedRef.current = true;
27 |         
28 |         console.log("Attempting anonymous sign-in (simplified logic)...");
29 |         try {
30 |           // Try the standard way first
31 |           const { data, error } = await signIn.anonymous();
32 |           console.log("Standard anonymous sign-in initiated/checked.");
33 |           if (error) {
34 |             setError("Failed to sign in anonymously. Please try again.");
35 |           } else if (data?.user) {
36 |             // @ts-expect-error TODO: Fix this type error
37 |             if (window.rudderanalytics) {
38 |               // @ts-expect-error TODO: Fix this type error
39 |               window.rudderanalytics.identify(data.user.id, { // Use optional chaining
40 |                 isAnonymous: true,
41 |               });
42 |             }
43 |           }
44 |         } catch (error: any) {
45 |           // Ignore the specific error for already being signed in anonymously
46 |           if (error?.message?.includes('ANONYMOUS_USERS_CANNOT_SIGN_IN_AGAIN') || error?.message?.includes('already signed in anonymously')) {
47 |             console.log("Already signed in anonymously or attempt blocked by backend.");
48 |           } else {
49 |             console.error("Standard anonymous sign-in failed:", error);
50 |             // No fallback - rely solely on the standard method
51 |           }
52 |         } finally {
53 |           setIsAttemptingSignIn(false);
54 |         }
55 |       };
56 | 
57 |       attemptSignIn();
58 |     }
59 |   }, [session, isPending, isAttemptingSignIn]);
60 | 
61 |   // This component doesn't render anything - it just handles the authentication logic
62 |   return null;
63 | } 
```

components/auth/SignInButton.tsx
```
1 | "use client";
2 | 
3 | import { signIn } from "@/lib/auth-client";
4 | import { Button } from "@/components/ui/button";
5 | import { LogIn } from "lucide-react";
6 | import { cn } from "@/lib/utils";
7 | 
8 | interface SignInButtonProps {
9 |   isCollapsed?: boolean;
10 | }
11 | 
12 | export function SignInButton({ isCollapsed }: SignInButtonProps) {
13 |   const handleSignIn = async () => {
14 |     try {
15 |       await signIn.social({
16 |         provider: "google",
17 |       });
18 |     } catch (error) {
19 |       console.error("Sign-in error:", error);
20 |     }
21 |   };
22 | 
23 |   return (
24 |     <Button 
25 |       onClick={handleSignIn}
26 |       className={cn(
27 |         "bg-green-600 hover:bg-green-700 text-white font-semibold flex items-center justify-center gap-2 transition-colors duration-200 ease-in-out shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50",
28 |         isCollapsed ? "w-auto h-auto p-2 aspect-square rounded-lg" : "w-full py-2 px-4 rounded-lg"
29 |       )}
30 |       title={isCollapsed ? "Sign in with Google" : undefined}
31 |     >
32 |       <LogIn className={cn("shrink-0", isCollapsed ? "h-5 w-5" : "h-4 w-4")} />
33 |       {!isCollapsed && <span>Sign in with Google</span>}
34 |     </Button>
35 |   );
36 | } 
```

components/auth/UserAccountMenu.tsx
```
1 | "use client";
2 | 
3 | import { useAuth, signOut } from "@/hooks/useAuth";
4 | import { Button } from "@/components/ui/button";
5 | import { 
6 |   DropdownMenu, 
7 |   DropdownMenuContent, 
8 |   DropdownMenuItem, 
9 |   DropdownMenuLabel, 
10 |   DropdownMenuSeparator, 
11 |   DropdownMenuTrigger 
12 | } from "@/components/ui/dropdown-menu";
13 | import { LogOut, User, Settings, LayoutDashboard } from "lucide-react";
14 | import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
15 | import { CheckoutButton } from "@/components/checkout-button";
16 | 
17 | export function UserAccountMenu() {
18 |   const { session } = useAuth();
19 | 
20 |   if (!session?.user) return null;
21 | 
22 |   const handleSignOut = async () => {
23 |     try {
24 |       await signOut({});
25 |     } catch (error) {
26 |       console.error("Sign-out error:", error);
27 |     }
28 |   };
29 | 
30 |   const userInitials = session.user.name
31 |     ? session.user.name
32 |         .split(' ')
33 |         .map((name: string) => name[0])
34 |         .join('')
35 |         .toUpperCase()
36 |     : session.user.email?.[0]?.toUpperCase() || 'U';
37 | 
38 |   return (
39 |     <DropdownMenu>
40 |       <DropdownMenuTrigger asChild>
41 |         <Button variant="ghost" className="relative h-8 w-8 rounded-full">
42 |           <Avatar className="h-8 w-8">
43 |             <AvatarImage 
44 |               src={session.user.image || ''} 
45 |               alt={session.user.name || 'User'} 
46 |             />
47 |             <AvatarFallback>{userInitials}</AvatarFallback>
48 |           </Avatar>
49 |         </Button>
50 |       </DropdownMenuTrigger>
51 |       <DropdownMenuContent className="w-56" align="end" forceMount>
52 |         <DropdownMenuLabel className="font-normal">
53 |           <div className="flex flex-col space-y-1">
54 |             <p className="text-sm font-medium leading-none">{session.user.name}</p>
55 |             <p className="text-xs leading-none text-muted-foreground">
56 |               {session.user.email}
57 |             </p>
58 |           </div>
59 |         </DropdownMenuLabel>
60 |         <DropdownMenuSeparator />
61 |         
62 |         <div className="p-2">
63 |           <CheckoutButton />
64 |         </div>
65 |         
66 |         <DropdownMenuSeparator />
67 |         <DropdownMenuItem asChild>
68 |           <a href="/api/portal" target="_blank" rel="noopener noreferrer">
69 |             <LayoutDashboard className="mr-2 h-4 w-4" />
70 |             <span>Customer Portal</span>
71 |           </a>
72 |         </DropdownMenuItem>
73 |         <DropdownMenuSeparator />
74 |         <DropdownMenuItem onClick={handleSignOut}>
75 |           <LogOut className="mr-2 h-4 w-4" />
76 |           <span>Log out</span>
77 |         </DropdownMenuItem>
78 |       </DropdownMenuContent>
79 |     </DropdownMenu>
80 |   );
81 | } 
```

components/ui/BuildInfo.tsx
```
1 | export default function BuildInfo() {
2 |   const commit = process.env.NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA || process.env.VERCEL_GIT_COMMIT_SHA || 'unknown';
3 |     const url = process.env.NEXT_PUBLIC_VERCEL_URL || process.env.VERCEL_URL || 'unknown';
4 | 
5 |   return (
6 |     <div style={{ fontSize: 12, color: '#888', textAlign: 'center', padding: '8px 0' }}>
7 |       <span>Commit: {commit} | URL: {url}</span>
8 |     </div>
9 |   );
10 | } 
```

components/ui/accordion.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as AccordionPrimitive from "@radix-ui/react-accordion"
5 | import { ChevronDownIcon } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | 
9 | function Accordion({
10 |   ...props
11 | }: React.ComponentProps<typeof AccordionPrimitive.Root>) {
12 |   return <AccordionPrimitive.Root data-slot="accordion" {...props} />
13 | }
14 | 
15 | function AccordionItem({
16 |   className,
17 |   ...props
18 | }: React.ComponentProps<typeof AccordionPrimitive.Item>) {
19 |   return (
20 |     <AccordionPrimitive.Item
21 |       data-slot="accordion-item"
22 |       className={cn("mb-1", className)}
23 |       {...props}
24 |     />
25 |   )
26 | }
27 | 
28 | function AccordionTrigger({
29 |   className,
30 |   children,
31 |   ...props
32 | }: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
33 |   return (
34 |     <AccordionPrimitive.Header className="flex">
35 |       <AccordionPrimitive.Trigger
36 |         data-slot="accordion-trigger"
37 |         className={cn(
38 |           "focus-visible:ring-ring/30 flex flex-1 items-center justify-between py-3 text-left text-sm font-medium transition-all outline-none focus-visible:ring-2 rounded-md disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
39 |           className
40 |         )}
41 |         {...props}
42 |       >
43 |         {children}
44 |         <ChevronDownIcon className="text-muted-foreground/70 size-3.5 shrink-0 transition-transform duration-200" />
45 |       </AccordionPrimitive.Trigger>
46 |     </AccordionPrimitive.Header>
47 |   )
48 | }
49 | 
50 | function AccordionContent({
51 |   className,
52 |   children,
53 |   ...props
54 | }: React.ComponentProps<typeof AccordionPrimitive.Content>) {
55 |   return (
56 |     <AccordionPrimitive.Content
57 |       data-slot="accordion-content"
58 |       className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
59 |       {...props}
60 |     >
61 |       <div className={cn("py-2 pl-1", className)}>{children}</div>
62 |     </AccordionPrimitive.Content>
63 |   )
64 | }
65 | 
66 | export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
```

components/ui/alert.tsx
```
1 | import * as React from "react"
2 | import { cva, type VariantProps } from "class-variance-authority"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const alertVariants = cva(
7 |   "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",
8 |   {
9 |     variants: {
10 |       variant: {
11 |         default: "bg-background text-foreground",
12 |         destructive:
13 |           "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
14 |       },
15 |     },
16 |     defaultVariants: {
17 |       variant: "default",
18 |     },
19 |   }
20 | )
21 | 
22 | const Alert = React.forwardRef<
23 |   HTMLDivElement,
24 |   React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
25 | >(({ className, variant, ...props }, ref) => (
26 |   <div
27 |     ref={ref}
28 |     role="alert"
29 |     className={cn(alertVariants({ variant }), className)}
30 |     {...props}
31 |   />
32 | ))
33 | Alert.displayName = "Alert"
34 | 
35 | const AlertTitle = React.forwardRef<
36 |   HTMLParagraphElement,
37 |   React.HTMLAttributes<HTMLHeadingElement>
38 | >(({ className, ...props }, ref) => (
39 |   <h5
40 |     ref={ref}
41 |     className={cn("mb-1 font-medium leading-none tracking-tight", className)}
42 |     {...props}
43 |   />
44 | ))
45 | AlertTitle.displayName = "AlertTitle"
46 | 
47 | const AlertDescription = React.forwardRef<
48 |   HTMLParagraphElement,
49 |   React.HTMLAttributes<HTMLParagraphElement>
50 | >(({ className, ...props }, ref) => (
51 |   <div
52 |     ref={ref}
53 |     className={cn("text-sm [&_p]:leading-relaxed", className)}
54 |     {...props}
55 |   />
56 | ))
57 | AlertDescription.displayName = "AlertDescription"
58 | 
59 | export { Alert, AlertTitle, AlertDescription } 
```

components/ui/avatar.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as AvatarPrimitive from "@radix-ui/react-avatar"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function Avatar({
9 |   className,
10 |   ...props
11 | }: React.ComponentProps<typeof AvatarPrimitive.Root>) {
12 |   return (
13 |     <AvatarPrimitive.Root
14 |       data-slot="avatar"
15 |       className={cn(
16 |         "relative flex size-8 shrink-0 overflow-hidden rounded-full",
17 |         className
18 |       )}
19 |       {...props}
20 |     />
21 |   )
22 | }
23 | 
24 | function AvatarImage({
25 |   className,
26 |   ...props
27 | }: React.ComponentProps<typeof AvatarPrimitive.Image>) {
28 |   return (
29 |     <AvatarPrimitive.Image
30 |       data-slot="avatar-image"
31 |       className={cn("aspect-square size-full", className)}
32 |       {...props}
33 |     />
34 |   )
35 | }
36 | 
37 | function AvatarFallback({
38 |   className,
39 |   ...props
40 | }: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
41 |   return (
42 |     <AvatarPrimitive.Fallback
43 |       data-slot="avatar-fallback"
44 |       className={cn(
45 |         "bg-muted flex size-full items-center justify-center rounded-full",
46 |         className
47 |       )}
48 |       {...props}
49 |     />
50 |   )
51 | }
52 | 
53 | export { Avatar, AvatarImage, AvatarFallback }
```

components/ui/badge.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const badgeVariants = cva(
8 |   "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
9 |   {
10 |     variants: {
11 |       variant: {
12 |         default:
13 |           "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
14 |         secondary:
15 |           "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
16 |         destructive:
17 |           "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
18 |         outline:
19 |           "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
20 |       },
21 |     },
22 |     defaultVariants: {
23 |       variant: "default",
24 |     },
25 |   }
26 | )
27 | 
28 | function Badge({
29 |   className,
30 |   variant,
31 |   asChild = false,
32 |   ...props
33 | }: React.ComponentProps<"span"> &
34 |   VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
35 |   const Comp = asChild ? Slot : "span"
36 | 
37 |   return (
38 |     <Comp
39 |       data-slot="badge"
40 |       className={cn(badgeVariants({ variant }), className)}
41 |       {...props}
42 |     />
43 |   )
44 | }
45 | 
46 | export { Badge, badgeVariants }
```

components/ui/button.tsx
```
1 | import * as React from "react"
2 | import { Slot } from "@radix-ui/react-slot"
3 | import { cva, type VariantProps } from "class-variance-authority"
4 | 
5 | import { cn } from "@/lib/utils"
6 | 
7 | const buttonVariants = cva(
8 |   "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
9 |   {
10 |     variants: {
11 |       variant: {
12 |         default:
13 |           "bg-primary text-primary-foreground shadow-xs hover:bg-primary/90",
14 |         destructive:
15 |           "bg-destructive text-white shadow-xs hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
16 |         outline:
17 |           "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
18 |         secondary:
19 |           "bg-secondary text-secondary-foreground shadow-xs hover:bg-secondary/80",
20 |         ghost:
21 |           "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
22 |         link: "text-primary underline-offset-4 hover:underline",
23 |       },
24 |       size: {
25 |         default: "h-9 px-4 py-2 has-[>svg]:px-3",
26 |         sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
27 |         lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
28 |         icon: "size-9",
29 |       },
30 |     },
31 |     defaultVariants: {
32 |       variant: "default",
33 |       size: "default",
34 |     },
35 |   }
36 | )
37 | 
38 | function Button({
39 |   className,
40 |   variant,
41 |   size,
42 |   asChild = false,
43 |   ...props
44 | }: React.ComponentProps<"button"> &
45 |   VariantProps<typeof buttonVariants> & {
46 |     asChild?: boolean
47 |   }) {
48 |   const Comp = asChild ? Slot : "button"
49 | 
50 |   return (
51 |     <Comp
52 |       data-slot="button"
53 |       className={cn(buttonVariants({ variant, size, className }))}
54 |       {...props}
55 |     />
56 |   )
57 | }
58 | 
59 | export { Button, buttonVariants }
```

components/ui/card.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | const Card = React.forwardRef<
6 |   HTMLDivElement,
7 |   React.HTMLAttributes<HTMLDivElement>
8 | >(({ className, ...props }, ref) => (
9 |   <div
10 |     ref={ref}
11 |     className={cn(
12 |       "rounded-lg border bg-card text-card-foreground shadow-sm",
13 |       className
14 |     )}
15 |     {...props}
16 |   />
17 | ))
18 | Card.displayName = "Card"
19 | 
20 | const CardHeader = React.forwardRef<
21 |   HTMLDivElement,
22 |   React.HTMLAttributes<HTMLDivElement>
23 | >(({ className, ...props }, ref) => (
24 |   <div
25 |     ref={ref}
26 |     className={cn("flex flex-col space-y-1.5 p-6", className)}
27 |     {...props}
28 |   />
29 | ))
30 | CardHeader.displayName = "CardHeader"
31 | 
32 | const CardTitle = React.forwardRef<
33 |   HTMLParagraphElement,
34 |   React.HTMLAttributes<HTMLHeadingElement>
35 | >(({ className, ...props }, ref) => (
36 |   <h3
37 |     ref={ref}
38 |     className={cn(
39 |       "text-2xl font-semibold leading-none tracking-tight",
40 |       className
41 |     )}
42 |     {...props}
43 |   />
44 | ))
45 | CardTitle.displayName = "CardTitle"
46 | 
47 | const CardDescription = React.forwardRef<
48 |   HTMLParagraphElement,
49 |   React.HTMLAttributes<HTMLParagraphElement>
50 | >(({ className, ...props }, ref) => (
51 |   <p
52 |     ref={ref}
53 |     className={cn("text-sm text-muted-foreground", className)}
54 |     {...props}
55 |   />
56 | ))
57 | CardDescription.displayName = "CardDescription"
58 | 
59 | const CardContent = React.forwardRef<
60 |   HTMLDivElement,
61 |   React.HTMLAttributes<HTMLDivElement>
62 | >(({ className, ...props }, ref) => (
63 |   <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
64 | ))
65 | CardContent.displayName = "CardContent"
66 | 
67 | const CardFooter = React.forwardRef<
68 |   HTMLDivElement,
69 |   React.HTMLAttributes<HTMLDivElement>
70 | >(({ className, ...props }, ref) => (
71 |   <div
72 |     ref={ref}
73 |     className={cn("flex items-center p-6 pt-0", className)}
74 |     {...props}
75 |   />
76 | ))
77 | CardFooter.displayName = "CardFooter"
78 | 
79 | export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent } 
```

components/ui/checkbox.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import { cn } from "@/lib/utils"
5 | 
6 | interface CheckboxProps {
7 |   id?: string;
8 |   checked?: boolean;
9 |   onCheckedChange?: (checked: boolean) => void;
10 |   className?: string;
11 |   disabled?: boolean;
12 | }
13 | 
14 | const Checkbox = React.forwardRef<HTMLInputElement, CheckboxProps>(
15 |   ({ className, checked, onCheckedChange, ...props }, ref) => {
16 |     return (
17 |       <input
18 |         type="checkbox"
19 |         ref={ref}
20 |         checked={checked}
21 |         onChange={(e) => onCheckedChange?.(e.target.checked)}
22 |         className={cn(
23 |           "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 accent-primary",
24 |           className
25 |         )}
26 |         {...props}
27 |       />
28 |     )
29 |   }
30 | )
31 | Checkbox.displayName = "Checkbox"
32 | 
33 | export { Checkbox }
```

components/ui/custom-sidebar-trigger.tsx
```
1 | "use client";
2 | 
3 | import * as React from "react";
4 | import { Menu } from "lucide-react";
5 | import { cn } from "@/lib/utils";
6 | import { useSidebar } from "@/components/ui/sidebar";
7 | 
8 | interface CustomSidebarTriggerProps {
9 |   variant: "collapsed" | "expanded";
10 |   className?: string;
11 | }
12 | 
13 | export function CustomSidebarTrigger({ variant, className }: CustomSidebarTriggerProps) {
14 |   const { toggleSidebar } = useSidebar();
15 | 
16 |   if (variant === "collapsed") {
17 |     return (
18 |       <button
19 |         onClick={toggleSidebar}
20 |         className={cn(
21 |           "flex items-center justify-center h-9 w-9",
22 |           "bg-muted hover:bg-accent rounded-md transition-colors",
23 |           "focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2",
24 |           className
25 |         )}
26 |         aria-label="Expand sidebar"
27 |         title="Expand sidebar"
28 |       >
29 |         <Menu className="h-4 w-4" />
30 |       </button>
31 |     );
32 |   }
33 | 
34 |   return (
35 |     <button
36 |       onClick={toggleSidebar}
37 |       className={cn(
38 |         "flex items-center justify-center p-2",
39 |         "hover:bg-accent/50 rounded-md",
40 |         "transition-all duration-300 ease-in-out",
41 |         "opacity-70 hover:opacity-100",
42 |         "focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2",
43 |         className
44 |       )}
45 |       aria-label="Collapse sidebar"
46 |       title="Collapse sidebar"
47 |     >
48 |       <Menu className="h-4 w-4 text-foreground/60 hover:text-foreground/90 transition-colors" />
49 |     </button>
50 |   );
51 | }
```

components/ui/dialog.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as DialogPrimitive from "@radix-ui/react-dialog"
5 | import { XIcon } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | 
9 | function Dialog({
10 |   ...props
11 | }: React.ComponentProps<typeof DialogPrimitive.Root>) {
12 |   return <DialogPrimitive.Root data-slot="dialog" {...props} />
13 | }
14 | 
15 | function DialogTrigger({
16 |   ...props
17 | }: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
18 |   return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
19 | }
20 | 
21 | function DialogPortal({
22 |   ...props
23 | }: React.ComponentProps<typeof DialogPrimitive.Portal>) {
24 |   return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
25 | }
26 | 
27 | function DialogClose({
28 |   ...props
29 | }: React.ComponentProps<typeof DialogPrimitive.Close>) {
30 |   return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
31 | }
32 | 
33 | function DialogOverlay({
34 |   className,
35 |   ...props
36 | }: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
37 |   return (
38 |     <DialogPrimitive.Overlay
39 |       data-slot="dialog-overlay"
40 |       className={cn(
41 |         "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
42 |         className
43 |       )}
44 |       {...props}
45 |     />
46 |   )
47 | }
48 | 
49 | function DialogContent({
50 |   className,
51 |   children,
52 |   ...props
53 | }: React.ComponentProps<typeof DialogPrimitive.Content>) {
54 |   return (
55 |     <DialogPortal data-slot="dialog-portal">
56 |       <DialogOverlay />
57 |       <DialogPrimitive.Content
58 |         data-slot="dialog-content"
59 |         className={cn(
60 |           "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
61 |           className
62 |         )}
63 |         {...props}
64 |       >
65 |         {children}
66 |         <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
67 |           <XIcon />
68 |           <span className="sr-only">Close</span>
69 |         </DialogPrimitive.Close>
70 |       </DialogPrimitive.Content>
71 |     </DialogPortal>
72 |   )
73 | }
74 | 
75 | function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
76 |   return (
77 |     <div
78 |       data-slot="dialog-header"
79 |       className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
80 |       {...props}
81 |     />
82 |   )
83 | }
84 | 
85 | function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
86 |   return (
87 |     <div
88 |       data-slot="dialog-footer"
89 |       className={cn(
90 |         "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
91 |         className
92 |       )}
93 |       {...props}
94 |     />
95 |   )
96 | }
97 | 
98 | function DialogTitle({
99 |   className,
100 |   ...props
101 | }: React.ComponentProps<typeof DialogPrimitive.Title>) {
102 |   return (
103 |     <DialogPrimitive.Title
104 |       data-slot="dialog-title"
105 |       className={cn("text-lg leading-none font-semibold", className)}
106 |       {...props}
107 |     />
108 |   )
109 | }
110 | 
111 | function DialogDescription({
112 |   className,
113 |   ...props
114 | }: React.ComponentProps<typeof DialogPrimitive.Description>) {
115 |   return (
116 |     <DialogPrimitive.Description
117 |       data-slot="dialog-description"
118 |       className={cn("text-muted-foreground text-sm", className)}
119 |       {...props}
120 |     />
121 |   )
122 | }
123 | 
124 | export {
125 |   Dialog,
126 |   DialogClose,
127 |   DialogContent,
128 |   DialogDescription,
129 |   DialogFooter,
130 |   DialogHeader,
131 |   DialogOverlay,
132 |   DialogPortal,
133 |   DialogTitle,
134 |   DialogTrigger,
135 | }
```

components/ui/dropdown-menu.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
5 | import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | 
9 | function DropdownMenu({
10 |   ...props
11 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
12 |   return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
13 | }
14 | 
15 | function DropdownMenuPortal({
16 |   ...props
17 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
18 |   return (
19 |     <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
20 |   )
21 | }
22 | 
23 | function DropdownMenuTrigger({
24 |   ...props
25 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
26 |   return (
27 |     <DropdownMenuPrimitive.Trigger
28 |       data-slot="dropdown-menu-trigger"
29 |       {...props}
30 |     />
31 |   )
32 | }
33 | 
34 | function DropdownMenuContent({
35 |   className,
36 |   sideOffset = 4,
37 |   ...props
38 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
39 |   return (
40 |     <DropdownMenuPrimitive.Portal>
41 |       <DropdownMenuPrimitive.Content
42 |         data-slot="dropdown-menu-content"
43 |         sideOffset={sideOffset}
44 |         className={cn(
45 |           "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
46 |           className
47 |         )}
48 |         {...props}
49 |       />
50 |     </DropdownMenuPrimitive.Portal>
51 |   )
52 | }
53 | 
54 | function DropdownMenuGroup({
55 |   ...props
56 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
57 |   return (
58 |     <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
59 |   )
60 | }
61 | 
62 | function DropdownMenuItem({
63 |   className,
64 |   inset,
65 |   variant = "default",
66 |   ...props
67 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
68 |   inset?: boolean
69 |   variant?: "default" | "destructive"
70 | }) {
71 |   return (
72 |     <DropdownMenuPrimitive.Item
73 |       data-slot="dropdown-menu-item"
74 |       data-inset={inset}
75 |       data-variant={variant}
76 |       className={cn(
77 |         "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
78 |         className
79 |       )}
80 |       {...props}
81 |     />
82 |   )
83 | }
84 | 
85 | function DropdownMenuCheckboxItem({
86 |   className,
87 |   children,
88 |   checked,
89 |   ...props
90 | }: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
91 |   return (
92 |     <DropdownMenuPrimitive.CheckboxItem
93 |       data-slot="dropdown-menu-checkbox-item"
94 |       className={cn(
95 |         "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
96 |         className
97 |       )}
98 |       checked={checked}
99 |       {...props}
100 |     >
101 |       <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
102 |         <DropdownMenuPrimitive.ItemIndicator>
103 |           <CheckIcon className="size-4" />
104 |         </DropdownMenuPrimitive.ItemIndicator>
105 |       </span>
106 |       {children}
107 |     </DropdownMenuPrimitive.CheckboxItem>
108 |   )
109 | }
110 | 
111 | function DropdownMenuRadioGroup({
112 |   ...props
113 | }: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
114 |   return (
115 |     <DropdownMenuPrimitive.RadioGroup
116 |       data-slot="dropdown-menu-radio-group"
117 |       {...props}
118 |     />
119 |   )
120 | }
121 | 
122 | function DropdownMenuRadioItem({
123 |   className,
124 |   children,
125 |   ...props
126 | }: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
127 |   return (
128 |     <DropdownMenuPrimitive.RadioItem
129 |       data-slot="dropdown-menu-radio-item"
130 |       className={cn(
131 |         "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
132 |         className
133 |       )}
134 |       {...props}
135 |     >
136 |       <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
137 |         <DropdownMenuPrimitive.ItemIndicator>
138 |           <CircleIcon className="size-2 fill-current" />
139 |         </DropdownMenuPrimitive.ItemIndicator>
140 |       </span>
141 |       {children}
142 |     </DropdownMenuPrimitive.RadioItem>
143 |   )
144 | }
145 | 
146 | function DropdownMenuLabel({
147 |   className,
148 |   inset,
149 |   ...props
150 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
151 |   inset?: boolean
152 | }) {
153 |   return (
154 |     <DropdownMenuPrimitive.Label
155 |       data-slot="dropdown-menu-label"
156 |       data-inset={inset}
157 |       className={cn(
158 |         "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
159 |         className
160 |       )}
161 |       {...props}
162 |     />
163 |   )
164 | }
165 | 
166 | function DropdownMenuSeparator({
167 |   className,
168 |   ...props
169 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
170 |   return (
171 |     <DropdownMenuPrimitive.Separator
172 |       data-slot="dropdown-menu-separator"
173 |       className={cn("bg-border -mx-1 my-1 h-px", className)}
174 |       {...props}
175 |     />
176 |   )
177 | }
178 | 
179 | function DropdownMenuShortcut({
180 |   className,
181 |   ...props
182 | }: React.ComponentProps<"span">) {
183 |   return (
184 |     <span
185 |       data-slot="dropdown-menu-shortcut"
186 |       className={cn(
187 |         "text-muted-foreground ml-auto text-xs tracking-widest",
188 |         className
189 |       )}
190 |       {...props}
191 |     />
192 |   )
193 | }
194 | 
195 | function DropdownMenuSub({
196 |   ...props
197 | }: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
198 |   return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
199 | }
200 | 
201 | function DropdownMenuSubTrigger({
202 |   className,
203 |   inset,
204 |   children,
205 |   ...props
206 | }: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
207 |   inset?: boolean
208 | }) {
209 |   return (
210 |     <DropdownMenuPrimitive.SubTrigger
211 |       data-slot="dropdown-menu-sub-trigger"
212 |       data-inset={inset}
213 |       className={cn(
214 |         "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
215 |         className
216 |       )}
217 |       {...props}
218 |     >
219 |       {children}
220 |       <ChevronRightIcon className="ml-auto size-4" />
221 |     </DropdownMenuPrimitive.SubTrigger>
222 |   )
223 | }
224 | 
225 | function DropdownMenuSubContent({
226 |   className,
227 |   ...props
228 | }: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
229 |   return (
230 |     <DropdownMenuPrimitive.SubContent
231 |       data-slot="dropdown-menu-sub-content"
232 |       className={cn(
233 |         "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
234 |         className
235 |       )}
236 |       {...props}
237 |     />
238 |   )
239 | }
240 | 
241 | export {
242 |   DropdownMenu,
243 |   DropdownMenuPortal,
244 |   DropdownMenuTrigger,
245 |   DropdownMenuContent,
246 |   DropdownMenuGroup,
247 |   DropdownMenuLabel,
248 |   DropdownMenuItem,
249 |   DropdownMenuCheckboxItem,
250 |   DropdownMenuRadioGroup,
251 |   DropdownMenuRadioItem,
252 |   DropdownMenuSeparator,
253 |   DropdownMenuShortcut,
254 |   DropdownMenuSub,
255 |   DropdownMenuSubTrigger,
256 |   DropdownMenuSubContent,
257 | }
```

components/ui/input.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | function Input({ className, type, ...props }: React.ComponentProps<"input">) {
6 |   return (
7 |     <input
8 |       type={type}
9 |       data-slot="input"
10 |       className={cn(
11 |         "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
12 |         "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
13 |         "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
14 |         className
15 |       )}
16 |       {...props}
17 |     />
18 |   )
19 | }
20 | 
21 | export { Input }
```

components/ui/label.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as LabelPrimitive from "@radix-ui/react-label"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function Label({
9 |   className,
10 |   ...props
11 | }: React.ComponentProps<typeof LabelPrimitive.Root>) {
12 |   return (
13 |     <LabelPrimitive.Root
14 |       data-slot="label"
15 |       className={cn(
16 |         "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
17 |         className
18 |       )}
19 |       {...props}
20 |     />
21 |   )
22 | }
23 | 
24 | export { Label }
```

components/ui/popover.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as PopoverPrimitive from "@radix-ui/react-popover"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function Popover({
9 |   ...props
10 | }: React.ComponentProps<typeof PopoverPrimitive.Root>) {
11 |   return <PopoverPrimitive.Root data-slot="popover" {...props} />
12 | }
13 | 
14 | function PopoverTrigger({
15 |   ...props
16 | }: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
17 |   return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />
18 | }
19 | 
20 | function PopoverContent({
21 |   className,
22 |   align = "center",
23 |   sideOffset = 4,
24 |   ...props
25 | }: React.ComponentProps<typeof PopoverPrimitive.Content>) {
26 |   return (
27 |     <PopoverPrimitive.Portal>
28 |       <PopoverPrimitive.Content
29 |         data-slot="popover-content"
30 |         align={align}
31 |         sideOffset={sideOffset}
32 |         className={cn(
33 |           "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
34 |           className
35 |         )}
36 |         {...props}
37 |       />
38 |     </PopoverPrimitive.Portal>
39 |   )
40 | }
41 | 
42 | function PopoverAnchor({
43 |   ...props
44 | }: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
45 |   return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />
46 | }
47 | 
48 | export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }
```

components/ui/scroll-area.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function ScrollArea({
9 |   className,
10 |   children,
11 |   ...props
12 | }: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
13 |   return (
14 |     <ScrollAreaPrimitive.Root
15 |       data-slot="scroll-area"
16 |       className={cn("relative", className)}
17 |       {...props}
18 |     >
19 |       <ScrollAreaPrimitive.Viewport
20 |         data-slot="scroll-area-viewport"
21 |         className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
22 |       >
23 |         {children}
24 |       </ScrollAreaPrimitive.Viewport>
25 |       <ScrollBar />
26 |       <ScrollAreaPrimitive.Corner />
27 |     </ScrollAreaPrimitive.Root>
28 |   )
29 | }
30 | 
31 | function ScrollBar({
32 |   className,
33 |   orientation = "vertical",
34 |   ...props
35 | }: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
36 |   return (
37 |     <ScrollAreaPrimitive.ScrollAreaScrollbar
38 |       data-slot="scroll-area-scrollbar"
39 |       orientation={orientation}
40 |       className={cn(
41 |         "flex touch-none p-px transition-colors select-none",
42 |         orientation === "vertical" &&
43 |           "h-full w-2.5 border-l border-l-transparent",
44 |         orientation === "horizontal" &&
45 |           "h-2.5 flex-col border-t border-t-transparent",
46 |         className
47 |       )}
48 |       {...props}
49 |     >
50 |       <ScrollAreaPrimitive.ScrollAreaThumb
51 |         data-slot="scroll-area-thumb"
52 |         className="bg-border relative flex-1 rounded-full"
53 |       />
54 |     </ScrollAreaPrimitive.ScrollAreaScrollbar>
55 |   )
56 | }
57 | 
58 | export { ScrollArea, ScrollBar }
```

components/ui/select.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as SelectPrimitive from "@radix-ui/react-select"
5 | import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | 
9 | function Select({
10 |   ...props
11 | }: React.ComponentProps<typeof SelectPrimitive.Root>) {
12 |   return <SelectPrimitive.Root data-slot="select" {...props} />
13 | }
14 | 
15 | function SelectGroup({
16 |   ...props
17 | }: React.ComponentProps<typeof SelectPrimitive.Group>) {
18 |   return <SelectPrimitive.Group data-slot="select-group" {...props} />
19 | }
20 | 
21 | function SelectValue({
22 |   ...props
23 | }: React.ComponentProps<typeof SelectPrimitive.Value>) {
24 |   return <SelectPrimitive.Value data-slot="select-value" {...props} />
25 | }
26 | 
27 | function SelectTrigger({
28 |   className,
29 |   children,
30 |   ...props
31 | }: React.ComponentProps<typeof SelectPrimitive.Trigger>) {
32 |   return (
33 |     <SelectPrimitive.Trigger
34 |       data-slot="select-trigger"
35 |       className={cn(
36 |         "text-muted-foreground data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive flex h-9 w-fit items-center justify-between gap-2 rounded-md bg-transparent px-3 py-2 text-sm whitespace-nowrap transition-[color,box-shadow] outline-none hover:bg-secondary data-[state=open]:bg-secondary disabled:cursor-not-allowed disabled:opacity-50 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
37 |         className
38 |       )}
39 |       {...props}
40 |     >
41 |       {children}
42 |       <SelectPrimitive.Icon asChild>
43 |         <ChevronDownIcon className="size-4 opacity-50" />
44 |       </SelectPrimitive.Icon>
45 |     </SelectPrimitive.Trigger>
46 |   )
47 | }
48 | 
49 | function SelectContent({
50 |   className,
51 |   children,
52 |   position = "popper",
53 |   ...props
54 | }: React.ComponentProps<typeof SelectPrimitive.Content>) {
55 |   return (
56 |     <SelectPrimitive.Portal>
57 |       <SelectPrimitive.Content
58 |         data-slot="select-content"
59 |         className={cn(
60 |           "bg-secondary text-secondary-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
61 |           position === "popper" &&
62 |             "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
63 |           className
64 |         )}
65 |         position={position}
66 |         {...props}
67 |       >
68 |         <SelectScrollUpButton />
69 |         <SelectPrimitive.Viewport
70 |           className={cn(
71 |             "p-1",
72 |             position === "popper" &&
73 |               "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
74 |           )}
75 |         >
76 |           {children}
77 |         </SelectPrimitive.Viewport>
78 |         <SelectScrollDownButton />
79 |       </SelectPrimitive.Content>
80 |     </SelectPrimitive.Portal>
81 |   )
82 | }
83 | 
84 | function SelectLabel({
85 |   className,
86 |   ...props
87 | }: React.ComponentProps<typeof SelectPrimitive.Label>) {
88 |   return (
89 |     <SelectPrimitive.Label
90 |       data-slot="select-label"
91 |       className={cn("px-2 py-1.5 text-sm font-medium", className)}
92 |       {...props}
93 |     />
94 |   )
95 | }
96 | 
97 | function SelectItem({
98 |   className,
99 |   children,
100 |   ...props
101 | }: React.ComponentProps<typeof SelectPrimitive.Item>) {
102 |   return (
103 |     <SelectPrimitive.Item
104 |       data-slot="select-item"
105 |       className={cn(
106 |         "focus:bg-accent focus:text-accent-foreground hover:bg-accent hover:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
107 |         className
108 |       )}
109 |       {...props}
110 |     >
111 |       <span className="absolute right-2 flex size-3.5 items-center justify-center">
112 |         <SelectPrimitive.ItemIndicator>
113 |           <CheckIcon className="size-4" />
114 |         </SelectPrimitive.ItemIndicator>
115 |       </span>
116 |       <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
117 |     </SelectPrimitive.Item>
118 |   )
119 | }
120 | 
121 | function SelectSeparator({
122 |   className,
123 |   ...props
124 | }: React.ComponentProps<typeof SelectPrimitive.Separator>) {
125 |   return (
126 |     <SelectPrimitive.Separator
127 |       data-slot="select-separator"
128 |       className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
129 |       {...props}
130 |     />
131 |   )
132 | }
133 | 
134 | function SelectScrollUpButton({
135 |   className,
136 |   ...props
137 | }: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
138 |   return (
139 |     <SelectPrimitive.ScrollUpButton
140 |       data-slot="select-scroll-up-button"
141 |       className={cn(
142 |         "flex cursor-default items-center justify-center py-1",
143 |         className
144 |       )}
145 |       {...props}
146 |     >
147 |       <ChevronUpIcon className="size-4" />
148 |     </SelectPrimitive.ScrollUpButton>
149 |   )
150 | }
151 | 
152 | function SelectScrollDownButton({
153 |   className,
154 |   ...props
155 | }: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
156 |   return (
157 |     <SelectPrimitive.ScrollDownButton
158 |       data-slot="select-scroll-down-button"
159 |       className={cn(
160 |         "flex cursor-default items-center justify-center py-1",
161 |         className
162 |       )}
163 |       {...props}
164 |     >
165 |       <ChevronDownIcon className="size-4" />
166 |     </SelectPrimitive.ScrollDownButton>
167 |   )
168 | }
169 | 
170 | export {
171 |   Select,
172 |   SelectContent,
173 |   SelectGroup,
174 |   SelectItem,
175 |   SelectLabel,
176 |   SelectScrollDownButton,
177 |   SelectScrollUpButton,
178 |   SelectSeparator,
179 |   SelectTrigger,
180 |   SelectValue,
181 | }
```

components/ui/separator.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as SeparatorPrimitive from "@radix-ui/react-separator"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function Separator({
9 |   className,
10 |   orientation = "horizontal",
11 |   decorative = true,
12 |   ...props
13 | }: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
14 |   return (
15 |     <SeparatorPrimitive.Root
16 |       data-slot="separator-root"
17 |       decorative={decorative}
18 |       orientation={orientation}
19 |       className={cn(
20 |         "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
21 |         className
22 |       )}
23 |       {...props}
24 |     />
25 |   )
26 | }
27 | 
28 | export { Separator }
```

components/ui/sheet.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as SheetPrimitive from "@radix-ui/react-dialog"
5 | import { XIcon } from "lucide-react"
6 | 
7 | import { cn } from "@/lib/utils"
8 | 
9 | function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
10 |   return <SheetPrimitive.Root data-slot="sheet" {...props} />
11 | }
12 | 
13 | function SheetTrigger({
14 |   ...props
15 | }: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
16 |   return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
17 | }
18 | 
19 | function SheetClose({
20 |   ...props
21 | }: React.ComponentProps<typeof SheetPrimitive.Close>) {
22 |   return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
23 | }
24 | 
25 | function SheetPortal({
26 |   ...props
27 | }: React.ComponentProps<typeof SheetPrimitive.Portal>) {
28 |   return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
29 | }
30 | 
31 | function SheetOverlay({
32 |   className,
33 |   ...props
34 | }: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
35 |   return (
36 |     <SheetPrimitive.Overlay
37 |       data-slot="sheet-overlay"
38 |       className={cn(
39 |         "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
40 |         className
41 |       )}
42 |       {...props}
43 |     />
44 |   )
45 | }
46 | 
47 | function SheetContent({
48 |   className,
49 |   children,
50 |   side = "right",
51 |   ...props
52 | }: React.ComponentProps<typeof SheetPrimitive.Content> & {
53 |   side?: "top" | "right" | "bottom" | "left"
54 | }) {
55 |   return (
56 |     <SheetPortal>
57 |       <SheetOverlay />
58 |       <SheetPrimitive.Content
59 |         data-slot="sheet-content"
60 |         className={cn(
61 |           "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
62 |           side === "right" &&
63 |             "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
64 |           side === "left" &&
65 |             "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
66 |           side === "top" &&
67 |             "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
68 |           side === "bottom" &&
69 |             "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
70 |           className
71 |         )}
72 |         {...props}
73 |       >
74 |         {children}
75 |         <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
76 |           <XIcon className="size-4" />
77 |           <span className="sr-only">Close</span>
78 |         </SheetPrimitive.Close>
79 |       </SheetPrimitive.Content>
80 |     </SheetPortal>
81 |   )
82 | }
83 | 
84 | function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
85 |   return (
86 |     <div
87 |       data-slot="sheet-header"
88 |       className={cn("flex flex-col gap-1.5 p-4", className)}
89 |       {...props}
90 |     />
91 |   )
92 | }
93 | 
94 | function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
95 |   return (
96 |     <div
97 |       data-slot="sheet-footer"
98 |       className={cn("mt-auto flex flex-col gap-2 p-4", className)}
99 |       {...props}
100 |     />
101 |   )
102 | }
103 | 
104 | function SheetTitle({
105 |   className,
106 |   ...props
107 | }: React.ComponentProps<typeof SheetPrimitive.Title>) {
108 |   return (
109 |     <SheetPrimitive.Title
110 |       data-slot="sheet-title"
111 |       className={cn("text-foreground font-semibold", className)}
112 |       {...props}
113 |     />
114 |   )
115 | }
116 | 
117 | function SheetDescription({
118 |   className,
119 |   ...props
120 | }: React.ComponentProps<typeof SheetPrimitive.Description>) {
121 |   return (
122 |     <SheetPrimitive.Description
123 |       data-slot="sheet-description"
124 |       className={cn("text-muted-foreground text-sm", className)}
125 |       {...props}
126 |     />
127 |   )
128 | }
129 | 
130 | export {
131 |   Sheet,
132 |   SheetTrigger,
133 |   SheetClose,
134 |   SheetContent,
135 |   SheetHeader,
136 |   SheetFooter,
137 |   SheetTitle,
138 |   SheetDescription,
139 | }
```

components/ui/sidebar.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import { Slot } from "@radix-ui/react-slot"
5 | import { VariantProps, cva } from "class-variance-authority"
6 | import { Menu } from "lucide-react"
7 | 
8 | import { useIsMobile } from "@/hooks/use-mobile"
9 | import { cn } from "@/lib/utils"
10 | import { Button } from "@/components/ui/button"
11 | import { Input } from "@/components/ui/input"
12 | import { Separator } from "@/components/ui/separator"
13 | import {
14 |   Sheet,
15 |   SheetContent,
16 |   SheetDescription,
17 |   SheetHeader,
18 |   SheetTitle,
19 | } from "@/components/ui/sheet"
20 | import { Skeleton } from "@/components/ui/skeleton"
21 | import {
22 |   Tooltip,
23 |   TooltipContent,
24 |   TooltipProvider,
25 |   TooltipTrigger,
26 | } from "@/components/ui/tooltip"
27 | 
28 | const SIDEBAR_COOKIE_NAME = "sidebar_state"
29 | const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7
30 | const SIDEBAR_WIDTH = "16rem"
31 | const SIDEBAR_WIDTH_MOBILE = "18rem"
32 | const SIDEBAR_WIDTH_ICON = "3rem"
33 | const SIDEBAR_KEYBOARD_SHORTCUT = "b"
34 | 
35 | type SidebarContextProps = {
36 |   state: "expanded" | "collapsed"
37 |   open: boolean
38 |   setOpen: (open: boolean) => void
39 |   openMobile: boolean
40 |   setOpenMobile: (open: boolean) => void
41 |   isMobile: boolean
42 |   toggleSidebar: () => void
43 | }
44 | 
45 | const SidebarContext = React.createContext<SidebarContextProps | null>(null)
46 | 
47 | function useSidebar() {
48 |   const context = React.useContext(SidebarContext)
49 |   if (!context) {
50 |     throw new Error("useSidebar must be used within a SidebarProvider.")
51 |   }
52 | 
53 |   return context
54 | }
55 | 
56 | function SidebarProvider({
57 |   defaultOpen = true,
58 |   open: openProp,
59 |   onOpenChange: setOpenProp,
60 |   className,
61 |   style,
62 |   children,
63 |   ...props
64 | }: React.ComponentProps<"div"> & {
65 |   defaultOpen?: boolean
66 |   open?: boolean
67 |   onOpenChange?: (open: boolean) => void
68 | }) {
69 |   const isMobile = useIsMobile()
70 |   const [openMobile, setOpenMobile] = React.useState(false)
71 | 
72 |   // This is the internal state of the sidebar.
73 |   // We use openProp and setOpenProp for control from outside the component.
74 |   const [_open, _setOpen] = React.useState(defaultOpen)
75 |   const open = openProp ?? _open
76 |   const setOpen = React.useCallback(
77 |     (value: boolean | ((value: boolean) => boolean)) => {
78 |       const openState = typeof value === "function" ? value(open) : value
79 |       if (setOpenProp) {
80 |         setOpenProp(openState)
81 |       } else {
82 |         _setOpen(openState)
83 |       }
84 | 
85 |       // This sets the cookie to keep the sidebar state.
86 |       document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`
87 |     },
88 |     [setOpenProp, open]
89 |   )
90 | 
91 |   // Helper to toggle the sidebar.
92 |   const toggleSidebar = React.useCallback(() => {
93 |     return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)
94 |   }, [isMobile, setOpen, setOpenMobile])
95 | 
96 |   // Adds a keyboard shortcut to toggle the sidebar.
97 |   React.useEffect(() => {
98 |     const handleKeyDown = (event: KeyboardEvent) => {
99 |       if (
100 |         event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
101 |         (event.metaKey || event.ctrlKey)
102 |       ) {
103 |         event.preventDefault()
104 |         toggleSidebar()
105 |       }
106 |     }
107 | 
108 |     window.addEventListener("keydown", handleKeyDown)
109 |     return () => window.removeEventListener("keydown", handleKeyDown)
110 |   }, [toggleSidebar])
111 | 
112 |   // We add a state so that we can do data-state="expanded" or "collapsed".
113 |   // This makes it easier to style the sidebar with Tailwind classes.
114 |   const state = open ? "expanded" : "collapsed"
115 | 
116 |   const contextValue = React.useMemo<SidebarContextProps>(
117 |     () => ({
118 |       state,
119 |       open,
120 |       setOpen,
121 |       isMobile,
122 |       openMobile,
123 |       setOpenMobile,
124 |       toggleSidebar,
125 |     }),
126 |     [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]
127 |   )
128 | 
129 |   return (
130 |     <SidebarContext.Provider value={contextValue}>
131 |       <TooltipProvider delayDuration={0}>
132 |         <div
133 |           data-slot="sidebar-wrapper"
134 |           style={
135 |             {
136 |               "--sidebar-width": SIDEBAR_WIDTH,
137 |               "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
138 |               ...style,
139 |             } as React.CSSProperties
140 |           }
141 |           className={cn(
142 |             "group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",
143 |             className
144 |           )}
145 |           {...props}
146 |         >
147 |           {children}
148 |         </div>
149 |       </TooltipProvider>
150 |     </SidebarContext.Provider>
151 |   )
152 | }
153 | 
154 | function Sidebar({
155 |   side = "left",
156 |   variant = "sidebar",
157 |   collapsible = "offcanvas",
158 |   className,
159 |   children,
160 |   ...props
161 | }: React.ComponentProps<"div"> & {
162 |   side?: "left" | "right"
163 |   variant?: "sidebar" | "floating" | "inset"
164 |   collapsible?: "offcanvas" | "icon" | "none"
165 | }) {
166 |   const { isMobile, state, openMobile, setOpenMobile } = useSidebar()
167 | 
168 |   if (collapsible === "none") {
169 |     return (
170 |       <div
171 |         data-slot="sidebar"
172 |         className={cn(
173 |           "bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col",
174 |           className
175 |         )}
176 |         {...props}
177 |       >
178 |         {children}
179 |       </div>
180 |     )
181 |   }
182 | 
183 |   if (isMobile) {
184 |     return (
185 |       <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
186 |         <SheetContent
187 |           data-sidebar="sidebar"
188 |           data-slot="sidebar"
189 |           data-mobile="true"
190 |           className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
191 |           style={
192 |             {
193 |               "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
194 |             } as React.CSSProperties
195 |           }
196 |           side={side}
197 |         >
198 |           <SheetHeader className="sr-only">
199 |             <SheetTitle>Sidebar</SheetTitle>
200 |             <SheetDescription>Displays the mobile sidebar.</SheetDescription>
201 |           </SheetHeader>
202 |           <div className="flex h-full w-full flex-col">{children}</div>
203 |         </SheetContent>
204 |       </Sheet>
205 |     )
206 |   }
207 | 
208 |   return (
209 |     <div
210 |       className="group peer text-sidebar-foreground hidden md:block"
211 |       data-state={state}
212 |       data-collapsible={state === "collapsed" ? collapsible : ""}
213 |       data-variant={variant}
214 |       data-side={side}
215 |       data-slot="sidebar"
216 |     >
217 |       {/* This is what handles the sidebar gap on desktop */}
218 |       <div
219 |         data-slot="sidebar-gap"
220 |         className={cn(
221 |           "relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear",
222 |           "group-data-[collapsible=offcanvas]:w-0",
223 |           "group-data-[side=right]:rotate-180",
224 |           variant === "floating" || variant === "inset"
225 |             ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]"
226 |             : "group-data-[collapsible=icon]:w-(--sidebar-width-icon)"
227 |         )}
228 |       />
229 |       <div
230 |         data-slot="sidebar-container"
231 |         className={cn(
232 |           "fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex",
233 |           side === "left"
234 |             ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
235 |             : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
236 |           // Adjust the padding for floating and inset variants.
237 |           variant === "floating" || variant === "inset"
238 |             ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]"
239 |             : "group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l",
240 |           className
241 |         )}
242 |         {...props}
243 |       >
244 |         <div
245 |           data-sidebar="sidebar"
246 |           data-slot="sidebar-inner"
247 |           className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
248 |         >
249 |           {children}
250 |         </div>
251 |       </div>
252 |     </div>
253 |   )
254 | }
255 | 
256 | function SidebarTrigger({
257 |   className,
258 |   onClick,
259 |   ...props
260 | }: React.ComponentProps<typeof Button>) {
261 |   const { toggleSidebar } = useSidebar()
262 | 
263 |   return (
264 |     <Button
265 |       data-sidebar="trigger"
266 |       data-slot="sidebar-trigger"
267 |       variant="ghost"
268 |       size="icon"
269 |       className={cn("size-7", className)}
270 |       onClick={(event) => {
271 |         onClick?.(event)
272 |         toggleSidebar()
273 |       }}
274 |       {...props}
275 |     >
276 |       <Menu />
277 |       <span className="sr-only">Toggle Sidebar</span>
278 |     </Button>
279 |   )
280 | }
281 | 
282 | function SidebarRail({ className, ...props }: React.ComponentProps<"button">) {
283 |   const { toggleSidebar } = useSidebar()
284 | 
285 |   return (
286 |     <button
287 |       data-sidebar="rail"
288 |       data-slot="sidebar-rail"
289 |       aria-label="Toggle Sidebar"
290 |       tabIndex={-1}
291 |       onClick={toggleSidebar}
292 |       title="Toggle Sidebar"
293 |       className={cn(
294 |         "hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex",
295 |         "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
296 |         "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
297 |         "hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full",
298 |         "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
299 |         "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
300 |         className
301 |       )}
302 |       {...props}
303 |     />
304 |   )
305 | }
306 | 
307 | function SidebarInset({ className, ...props }: React.ComponentProps<"main">) {
308 |   return (
309 |     <main
310 |       data-slot="sidebar-inset"
311 |       className={cn(
312 |         "bg-background relative flex w-full flex-1 flex-col",
313 |         "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2",
314 |         className
315 |       )}
316 |       {...props}
317 |     />
318 |   )
319 | }
320 | 
321 | function SidebarInput({
322 |   className,
323 |   ...props
324 | }: React.ComponentProps<typeof Input>) {
325 |   return (
326 |     <Input
327 |       data-slot="sidebar-input"
328 |       data-sidebar="input"
329 |       className={cn("bg-background h-8 w-full shadow-none", className)}
330 |       {...props}
331 |     />
332 |   )
333 | }
334 | 
335 | function SidebarHeader({ className, ...props }: React.ComponentProps<"div">) {
336 |   return (
337 |     <div
338 |       data-slot="sidebar-header"
339 |       data-sidebar="header"
340 |       className={cn("flex flex-col gap-2 p-2", className)}
341 |       {...props}
342 |     />
343 |   )
344 | }
345 | 
346 | function SidebarFooter({ className, ...props }: React.ComponentProps<"div">) {
347 |   return (
348 |     <div
349 |       data-slot="sidebar-footer"
350 |       data-sidebar="footer"
351 |       className={cn("flex flex-col gap-2 p-2", className)}
352 |       {...props}
353 |     />
354 |   )
355 | }
356 | 
357 | function SidebarSeparator({
358 |   className,
359 |   ...props
360 | }: React.ComponentProps<typeof Separator>) {
361 |   return (
362 |     <Separator
363 |       data-slot="sidebar-separator"
364 |       data-sidebar="separator"
365 |       className={cn("bg-sidebar-border mx-2 w-auto", className)}
366 |       {...props}
367 |     />
368 |   )
369 | }
370 | 
371 | function SidebarContent({ className, ...props }: React.ComponentProps<"div">) {
372 |   return (
373 |     <div
374 |       data-slot="sidebar-content"
375 |       data-sidebar="content"
376 |       className={cn(
377 |         "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
378 |         className
379 |       )}
380 |       {...props}
381 |     />
382 |   )
383 | }
384 | 
385 | function SidebarGroup({ className, ...props }: React.ComponentProps<"div">) {
386 |   return (
387 |     <div
388 |       data-slot="sidebar-group"
389 |       data-sidebar="group"
390 |       className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
391 |       {...props}
392 |     />
393 |   )
394 | }
395 | 
396 | function SidebarGroupLabel({
397 |   className,
398 |   asChild = false,
399 |   ...props
400 | }: React.ComponentProps<"div"> & { asChild?: boolean }) {
401 |   const Comp = asChild ? Slot : "div"
402 | 
403 |   return (
404 |     <Comp
405 |       data-slot="sidebar-group-label"
406 |       data-sidebar="group-label"
407 |       className={cn(
408 |         "text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
409 |         "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
410 |         className
411 |       )}
412 |       {...props}
413 |     />
414 |   )
415 | }
416 | 
417 | function SidebarGroupAction({
418 |   className,
419 |   asChild = false,
420 |   ...props
421 | }: React.ComponentProps<"button"> & { asChild?: boolean }) {
422 |   const Comp = asChild ? Slot : "button"
423 | 
424 |   return (
425 |     <Comp
426 |       data-slot="sidebar-group-action"
427 |       data-sidebar="group-action"
428 |       className={cn(
429 |         "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
430 |         // Increases the hit area of the button on mobile.
431 |         "after:absolute after:-inset-2 md:after:hidden",
432 |         "group-data-[collapsible=icon]:hidden",
433 |         className
434 |       )}
435 |       {...props}
436 |     />
437 |   )
438 | }
439 | 
440 | function SidebarGroupContent({
441 |   className,
442 |   ...props
443 | }: React.ComponentProps<"div">) {
444 |   return (
445 |     <div
446 |       data-slot="sidebar-group-content"
447 |       data-sidebar="group-content"
448 |       className={cn("w-full text-sm", className)}
449 |       {...props}
450 |     />
451 |   )
452 | }
453 | 
454 | function SidebarMenu({ className, ...props }: React.ComponentProps<"ul">) {
455 |   return (
456 |     <ul
457 |       data-slot="sidebar-menu"
458 |       data-sidebar="menu"
459 |       className={cn("flex w-full min-w-0 flex-col gap-1", className)}
460 |       {...props}
461 |     />
462 |   )
463 | }
464 | 
465 | function SidebarMenuItem({ className, ...props }: React.ComponentProps<"li">) {
466 |   return (
467 |     <li
468 |       data-slot="sidebar-menu-item"
469 |       data-sidebar="menu-item"
470 |       className={cn("group/menu-item relative", className)}
471 |       {...props}
472 |     />
473 |   )
474 | }
475 | 
476 | const sidebarMenuButtonVariants = cva(
477 |   "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
478 |   {
479 |     variants: {
480 |       variant: {
481 |         default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
482 |         outline:
483 |           "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
484 |       },
485 |       size: {
486 |         default: "h-8 text-sm",
487 |         sm: "h-7 text-xs",
488 |         lg: "h-12 text-sm group-data-[collapsible=icon]:p-0!",
489 |       },
490 |     },
491 |     defaultVariants: {
492 |       variant: "default",
493 |       size: "default",
494 |     },
495 |   }
496 | )
497 | 
498 | function SidebarMenuButton({
499 |   asChild = false,
500 |   isActive = false,
501 |   variant = "default",
502 |   size = "default",
503 |   tooltip,
504 |   className,
505 |   ...props
506 | }: React.ComponentProps<"button"> & {
507 |   asChild?: boolean
508 |   isActive?: boolean
509 |   tooltip?: string | React.ComponentProps<typeof TooltipContent>
510 | } & VariantProps<typeof sidebarMenuButtonVariants>) {
511 |   const Comp = asChild ? Slot : "button"
512 |   const { isMobile, state } = useSidebar()
513 | 
514 |   const button = (
515 |     <Comp
516 |       data-slot="sidebar-menu-button"
517 |       data-sidebar="menu-button"
518 |       data-size={size}
519 |       data-active={isActive}
520 |       className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
521 |       {...props}
522 |     />
523 |   )
524 | 
525 |   if (!tooltip) {
526 |     return button
527 |   }
528 | 
529 |   if (typeof tooltip === "string") {
530 |     tooltip = {
531 |       children: tooltip,
532 |     }
533 |   }
534 | 
535 |   return (
536 |     <Tooltip>
537 |       <TooltipTrigger asChild>{button}</TooltipTrigger>
538 |       <TooltipContent
539 |         side="right"
540 |         align="center"
541 |         hidden={state !== "collapsed" || isMobile}
542 |         {...tooltip}
543 |       />
544 |     </Tooltip>
545 |   )
546 | }
547 | 
548 | function SidebarMenuAction({
549 |   className,
550 |   asChild = false,
551 |   showOnHover = false,
552 |   ...props
553 | }: React.ComponentProps<"button"> & {
554 |   asChild?: boolean
555 |   showOnHover?: boolean
556 | }) {
557 |   const Comp = asChild ? Slot : "button"
558 | 
559 |   return (
560 |     <Comp
561 |       data-slot="sidebar-menu-action"
562 |       data-sidebar="menu-action"
563 |       className={cn(
564 |         "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
565 |         // Increases the hit area of the button on mobile.
[TRUNCATED]
```

components/ui/skeleton.tsx
```
1 | import { cn } from "@/lib/utils"
2 | 
3 | function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
4 |   return (
5 |     <div
6 |       data-slot="skeleton"
7 |       className={cn("bg-accent animate-pulse rounded-md", className)}
8 |       {...props}
9 |     />
10 |   )
11 | }
12 | 
13 | export { Skeleton }
```

components/ui/sonner.tsx
```
1 | "use client"
2 | 
3 | import { useTheme } from "next-themes"
4 | import { Toaster as Sonner, ToasterProps } from "sonner"
5 | 
6 | const Toaster = ({ ...props }: ToasterProps) => {
7 |   const { theme = "system" } = useTheme()
8 | 
9 |   return (
10 |     <Sonner
11 |       theme={theme as ToasterProps["theme"]}
12 |       className="toaster group"
13 |       style={
14 |         {
15 |           "--normal-bg": "var(--popover)",
16 |           "--normal-text": "var(--popover-foreground)",
17 |           "--normal-border": "var(--border)",
18 |         } as React.CSSProperties
19 |       }
20 |       {...props}
21 |     />
22 |   )
23 | }
24 | 
25 | export { Toaster }
```

components/ui/switch.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as SwitchPrimitive from "@radix-ui/react-switch"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function Switch({
9 |   className,
10 |   ...props
11 | }: React.ComponentProps<typeof SwitchPrimitive.Root>) {
12 |   return (
13 |     <SwitchPrimitive.Root
14 |       data-slot="switch"
15 |       style={{ width: '48px', height: '24px' }}
16 |       className={cn(
17 |         "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-6 w-12 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
18 |         className
19 |       )}
20 |       {...props}
21 |     >
22 |       <SwitchPrimitive.Thumb
23 |         data-slot="switch-thumb"
24 |         style={{ width: '20px', height: '20px' }}
25 |         className={cn(
26 |           "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block h-5 w-5 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-6 data-[state=unchecked]:translate-x-1 shadow-sm"
27 |         )}
28 |       />
29 |     </SwitchPrimitive.Root>
30 |   )
31 | }
32 | 
33 | export { Switch }
```

components/ui/tabs.tsx
```
1 | import * as React from "react"
2 | import * as TabsPrimitive from "@radix-ui/react-tabs"
3 | 
4 | import { cn } from "@/lib/utils"
5 | 
6 | const Tabs = TabsPrimitive.Root
7 | 
8 | const TabsList = React.forwardRef<
9 |   React.ElementRef<typeof TabsPrimitive.List>,
10 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
11 | >(({ className, ...props }, ref) => (
12 |   <TabsPrimitive.List
13 |     ref={ref}
14 |     className={cn(
15 |       "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",
16 |       className
17 |     )}
18 |     {...props}
19 |   />
20 | ))
21 | TabsList.displayName = TabsPrimitive.List.displayName
22 | 
23 | const TabsTrigger = React.forwardRef<
24 |   React.ElementRef<typeof TabsPrimitive.Trigger>,
25 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
26 | >(({ className, ...props }, ref) => (
27 |   <TabsPrimitive.Trigger
28 |     ref={ref}
29 |     className={cn(
30 |       "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",
31 |       className
32 |     )}
33 |     {...props}
34 |   />
35 | ))
36 | TabsTrigger.displayName = TabsPrimitive.Trigger.displayName
37 | 
38 | const TabsContent = React.forwardRef<
39 |   React.ElementRef<typeof TabsPrimitive.Content>,
40 |   React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
41 | >(({ className, ...props }, ref) => (
42 |   <TabsPrimitive.Content
43 |     ref={ref}
44 |     className={cn(
45 |       "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
46 |       className
47 |     )}
48 |     {...props}
49 |   />
50 | ))
51 | TabsContent.displayName = TabsPrimitive.Content.displayName
52 | 
53 | export { Tabs, TabsList, TabsTrigger, TabsContent } 
```

components/ui/text-morph.tsx
```
1 | 'use client';
2 | import { cn } from '@/lib/utils';
3 | import { AnimatePresence, motion, Transition, Variants } from 'framer-motion';
4 | import { useMemo, useId } from 'react';
5 | 
6 | export type TextMorphProps = {
7 |   children: string;
8 |   as?: React.ElementType;
9 |   className?: string;
10 |   style?: React.CSSProperties;
11 |   variants?: Variants;
12 |   transition?: Transition;
13 | };
14 | 
15 | export function TextMorph({
16 |   children,
17 |   as: Component = 'p',
18 |   className,
19 |   style,
20 |   variants,
21 |   transition,
22 | }: TextMorphProps) {
23 |   const uniqueId = useId();
24 | 
25 |   const characters = useMemo(() => {
26 |     const charCounts: Record<string, number> = {};
27 | 
28 |     return children.split('').map((char) => {
29 |       const lowerChar = char.toLowerCase();
30 |       charCounts[lowerChar] = (charCounts[lowerChar] || 0) + 1;
31 | 
32 |       return {
33 |         id: `${uniqueId}-${lowerChar}${charCounts[lowerChar]}`,
34 |         label: char === ' ' ? '\u00A0' : char,
35 |       };
36 |     });
37 |   }, [children, uniqueId]);
38 | 
39 |   const defaultVariants: Variants = {
40 |     initial: { opacity: 0 },
41 |     animate: { opacity: 1 },
42 |     exit: { opacity: 0 },
43 |   };
44 | 
45 |   const defaultTransition: Transition = {
46 |     type: 'spring',
47 |     stiffness: 280,
48 |     damping: 18,
49 |     mass: 0.3,
50 |   };
51 | 
52 |   return (
53 |     <Component className={cn(className)} aria-label={children} style={style}>
54 |       <AnimatePresence mode='popLayout' initial={false}>
55 |         {characters.map((character) => (
56 |           <motion.span
57 |             key={character.id}
58 |             layoutId={character.id}
59 |             className='inline-block'
60 |             aria-hidden='true'
61 |             initial='initial'
62 |             animate='animate'
63 |             exit='exit'
64 |             variants={variants || defaultVariants}
65 |             transition={transition || defaultTransition}
66 |           >
67 |             {character.label}
68 |           </motion.span>
69 |         ))}
70 |       </AnimatePresence>
71 |     </Component>
72 |   );
73 | }
```

components/ui/textarea.tsx
```
1 | import * as React from "react"
2 | 
3 | import { cn } from "@/lib/utils"
4 | 
5 | function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
6 |   return (
7 |     <textarea
8 |       data-slot="textarea"
9 |       className={cn(
10 |         "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
11 |         // Enhanced text handling for code and special characters
12 |         "text-rendering-optimizelegibility antialiased font-feature-settings-normal",
13 |         className
14 |       )}
15 |       {...props}
16 |     />
17 |   )
18 | }
19 | 
20 | export { Textarea }
```

components/ui/tooltip.tsx
```
1 | "use client"
2 | 
3 | import * as React from "react"
4 | import * as TooltipPrimitive from "@radix-ui/react-tooltip"
5 | 
6 | import { cn } from "@/lib/utils"
7 | 
8 | function TooltipProvider({
9 |   delayDuration = 0,
10 |   ...props
11 | }: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
12 |   return (
13 |     <TooltipPrimitive.Provider
14 |       data-slot="tooltip-provider"
15 |       delayDuration={delayDuration}
16 |       {...props}
17 |     />
18 |   )
19 | }
20 | 
21 | function Tooltip({
22 |   ...props
23 | }: React.ComponentProps<typeof TooltipPrimitive.Root>) {
24 |   return (
25 |     <TooltipProvider>
26 |       <TooltipPrimitive.Root data-slot="tooltip" {...props} />
27 |     </TooltipProvider>
28 |   )
29 | }
30 | 
31 | function TooltipTrigger({
32 |   ...props
33 | }: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
34 |   return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />
35 | }
36 | 
37 | function TooltipContent({
38 |   className,
39 |   sideOffset = 0,
40 |   children,
41 |   ...props
42 | }: React.ComponentProps<typeof TooltipPrimitive.Content>) {
43 |   return (
44 |     <TooltipPrimitive.Portal>
45 |       <TooltipPrimitive.Content
46 |         data-slot="tooltip-content"
47 |         sideOffset={sideOffset}
48 |         className={cn(
49 |           "bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",
50 |           className
51 |         )}
52 |         {...props}
53 |       >
54 |         {children}
55 |         <TooltipPrimitive.Arrow className="bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
56 |       </TooltipPrimitive.Content>
57 |     </TooltipPrimitive.Portal>
58 |   )
59 | }
60 | 
61 | export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }
```

drizzle/meta/0001_snapshot.json
```
1 | {
2 |   "id": "c25dbd1f-846e-4ca4-b2f3-d24f70977d6f",
3 |   "prevId": "70cfd958-05b3-4673-81b2-be05beb0a237",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.chats": {
8 |       "name": "chats",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "user_id": {
18 |           "name": "user_id",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": false
22 |         },
23 |         "title": {
24 |           "name": "title",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true,
28 |           "default": "'New Chat'"
29 |         },
30 |         "created_at": {
31 |           "name": "created_at",
32 |           "type": "timestamp",
33 |           "primaryKey": false,
34 |           "notNull": true,
35 |           "default": "now()"
36 |         },
37 |         "updated_at": {
38 |           "name": "updated_at",
39 |           "type": "timestamp",
40 |           "primaryKey": false,
41 |           "notNull": true,
42 |           "default": "now()"
43 |         }
44 |       },
45 |       "indexes": {},
46 |       "foreignKeys": {
47 |         "chats_user_id_users_id_fk": {
48 |           "name": "chats_user_id_users_id_fk",
49 |           "tableFrom": "chats",
50 |           "tableTo": "users",
51 |           "columnsFrom": [
52 |             "user_id"
53 |           ],
54 |           "columnsTo": [
55 |             "id"
56 |           ],
57 |           "onDelete": "cascade",
58 |           "onUpdate": "no action"
59 |         }
60 |       },
61 |       "compositePrimaryKeys": {},
62 |       "uniqueConstraints": {},
63 |       "policies": {},
64 |       "checkConstraints": {},
65 |       "isRLSEnabled": false
66 |     },
67 |     "public.messages": {
68 |       "name": "messages",
69 |       "schema": "",
70 |       "columns": {
71 |         "id": {
72 |           "name": "id",
73 |           "type": "text",
74 |           "primaryKey": true,
75 |           "notNull": true
76 |         },
77 |         "chat_id": {
78 |           "name": "chat_id",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": true
82 |         },
83 |         "content": {
84 |           "name": "content",
85 |           "type": "text",
86 |           "primaryKey": false,
87 |           "notNull": true
88 |         },
89 |         "role": {
90 |           "name": "role",
91 |           "type": "text",
92 |           "primaryKey": false,
93 |           "notNull": true
94 |         },
95 |         "created_at": {
96 |           "name": "created_at",
97 |           "type": "timestamp",
98 |           "primaryKey": false,
99 |           "notNull": true,
100 |           "default": "now()"
101 |         }
102 |       },
103 |       "indexes": {},
104 |       "foreignKeys": {
105 |         "messages_chat_id_chats_id_fk": {
106 |           "name": "messages_chat_id_chats_id_fk",
107 |           "tableFrom": "messages",
108 |           "tableTo": "chats",
109 |           "columnsFrom": [
110 |             "chat_id"
111 |           ],
112 |           "columnsTo": [
113 |             "id"
114 |           ],
115 |           "onDelete": "cascade",
116 |           "onUpdate": "no action"
117 |         }
118 |       },
119 |       "compositePrimaryKeys": {},
120 |       "uniqueConstraints": {},
121 |       "policies": {},
122 |       "checkConstraints": {},
123 |       "isRLSEnabled": false
124 |     },
125 |     "public.users": {
126 |       "name": "users",
127 |       "schema": "",
128 |       "columns": {
129 |         "id": {
130 |           "name": "id",
131 |           "type": "text",
132 |           "primaryKey": true,
133 |           "notNull": true
134 |         },
135 |         "client_id": {
136 |           "name": "client_id",
137 |           "type": "text",
138 |           "primaryKey": false,
139 |           "notNull": true
140 |         },
141 |         "created_at": {
142 |           "name": "created_at",
143 |           "type": "timestamp",
144 |           "primaryKey": false,
145 |           "notNull": true,
146 |           "default": "now()"
147 |         },
148 |         "updated_at": {
149 |           "name": "updated_at",
150 |           "type": "timestamp",
151 |           "primaryKey": false,
152 |           "notNull": true,
153 |           "default": "now()"
154 |         }
155 |       },
156 |       "indexes": {},
157 |       "foreignKeys": {},
158 |       "compositePrimaryKeys": {},
159 |       "uniqueConstraints": {
160 |         "users_client_id_unique": {
161 |           "name": "users_client_id_unique",
162 |           "nullsNotDistinct": false,
163 |           "columns": [
164 |             "client_id"
165 |           ]
166 |         }
167 |       },
168 |       "policies": {},
169 |       "checkConstraints": {},
170 |       "isRLSEnabled": false
171 |     }
172 |   },
173 |   "enums": {},
174 |   "schemas": {},
175 |   "sequences": {},
176 |   "roles": {},
177 |   "policies": {},
178 |   "views": {},
179 |   "_meta": {
180 |     "columns": {},
181 |     "schemas": {},
182 |     "tables": {}
183 |   }
184 | }
```

drizzle/meta/0002_snapshot.json
```
1 | {
2 |   "id": "9ea87331-4108-40dd-8ac1-32fb1d2f1149",
3 |   "prevId": "c25dbd1f-846e-4ca4-b2f3-d24f70977d6f",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.chats": {
8 |       "name": "chats",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "user_id": {
18 |           "name": "user_id",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "title": {
24 |           "name": "title",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true,
28 |           "default": "'New Chat'"
29 |         },
30 |         "created_at": {
31 |           "name": "created_at",
32 |           "type": "timestamp",
33 |           "primaryKey": false,
34 |           "notNull": true,
35 |           "default": "now()"
36 |         },
37 |         "updated_at": {
38 |           "name": "updated_at",
39 |           "type": "timestamp",
40 |           "primaryKey": false,
41 |           "notNull": true,
42 |           "default": "now()"
43 |         }
44 |       },
45 |       "indexes": {},
46 |       "foreignKeys": {},
47 |       "compositePrimaryKeys": {},
48 |       "uniqueConstraints": {},
49 |       "policies": {},
50 |       "checkConstraints": {},
51 |       "isRLSEnabled": false
52 |     },
53 |     "public.messages": {
54 |       "name": "messages",
55 |       "schema": "",
56 |       "columns": {
57 |         "id": {
58 |           "name": "id",
59 |           "type": "text",
60 |           "primaryKey": true,
61 |           "notNull": true
62 |         },
63 |         "chat_id": {
64 |           "name": "chat_id",
65 |           "type": "text",
66 |           "primaryKey": false,
67 |           "notNull": true
68 |         },
69 |         "content": {
70 |           "name": "content",
71 |           "type": "text",
72 |           "primaryKey": false,
73 |           "notNull": true
74 |         },
75 |         "role": {
76 |           "name": "role",
77 |           "type": "text",
78 |           "primaryKey": false,
79 |           "notNull": true
80 |         },
81 |         "created_at": {
82 |           "name": "created_at",
83 |           "type": "timestamp",
84 |           "primaryKey": false,
85 |           "notNull": true,
86 |           "default": "now()"
87 |         },
88 |         "reasoning": {
89 |           "name": "reasoning",
90 |           "type": "text",
91 |           "primaryKey": false,
92 |           "notNull": false
93 |         },
94 |         "tool_calls": {
95 |           "name": "tool_calls",
96 |           "type": "json",
97 |           "primaryKey": false,
98 |           "notNull": false
99 |         },
100 |         "tool_results": {
101 |           "name": "tool_results",
102 |           "type": "json",
103 |           "primaryKey": false,
104 |           "notNull": false
105 |         },
106 |         "has_tool_use": {
107 |           "name": "has_tool_use",
108 |           "type": "boolean",
109 |           "primaryKey": false,
110 |           "notNull": false,
111 |           "default": false
112 |         }
113 |       },
114 |       "indexes": {},
115 |       "foreignKeys": {
116 |         "messages_chat_id_chats_id_fk": {
117 |           "name": "messages_chat_id_chats_id_fk",
118 |           "tableFrom": "messages",
119 |           "tableTo": "chats",
120 |           "columnsFrom": [
121 |             "chat_id"
122 |           ],
123 |           "columnsTo": [
124 |             "id"
125 |           ],
126 |           "onDelete": "cascade",
127 |           "onUpdate": "no action"
128 |         }
129 |       },
130 |       "compositePrimaryKeys": {},
131 |       "uniqueConstraints": {},
132 |       "policies": {},
133 |       "checkConstraints": {},
134 |       "isRLSEnabled": false
135 |     },
136 |     "public.steps": {
137 |       "name": "steps",
138 |       "schema": "",
139 |       "columns": {
140 |         "id": {
141 |           "name": "id",
142 |           "type": "text",
143 |           "primaryKey": true,
144 |           "notNull": true
145 |         },
146 |         "message_id": {
147 |           "name": "message_id",
148 |           "type": "text",
149 |           "primaryKey": false,
150 |           "notNull": true
151 |         },
152 |         "step_type": {
153 |           "name": "step_type",
154 |           "type": "text",
155 |           "primaryKey": false,
156 |           "notNull": true
157 |         },
158 |         "text": {
159 |           "name": "text",
160 |           "type": "text",
161 |           "primaryKey": false,
162 |           "notNull": false
163 |         },
164 |         "reasoning": {
165 |           "name": "reasoning",
166 |           "type": "text",
167 |           "primaryKey": false,
168 |           "notNull": false
169 |         },
170 |         "finish_reason": {
171 |           "name": "finish_reason",
172 |           "type": "text",
173 |           "primaryKey": false,
174 |           "notNull": false
175 |         },
176 |         "created_at": {
177 |           "name": "created_at",
178 |           "type": "timestamp",
179 |           "primaryKey": false,
180 |           "notNull": true,
181 |           "default": "now()"
182 |         },
183 |         "tool_calls": {
184 |           "name": "tool_calls",
185 |           "type": "json",
186 |           "primaryKey": false,
187 |           "notNull": false
188 |         },
189 |         "tool_results": {
190 |           "name": "tool_results",
191 |           "type": "json",
192 |           "primaryKey": false,
193 |           "notNull": false
194 |         }
195 |       },
196 |       "indexes": {},
197 |       "foreignKeys": {
198 |         "steps_message_id_messages_id_fk": {
199 |           "name": "steps_message_id_messages_id_fk",
200 |           "tableFrom": "steps",
201 |           "tableTo": "messages",
202 |           "columnsFrom": [
203 |             "message_id"
204 |           ],
205 |           "columnsTo": [
206 |             "id"
207 |           ],
208 |           "onDelete": "cascade",
209 |           "onUpdate": "no action"
210 |         }
211 |       },
212 |       "compositePrimaryKeys": {},
213 |       "uniqueConstraints": {},
214 |       "policies": {},
215 |       "checkConstraints": {},
216 |       "isRLSEnabled": false
217 |     }
218 |   },
219 |   "enums": {},
220 |   "schemas": {},
221 |   "sequences": {},
222 |   "roles": {},
223 |   "policies": {},
224 |   "views": {},
225 |   "_meta": {
226 |     "columns": {},
227 |     "schemas": {},
228 |     "tables": {}
229 |   }
230 | }
```

drizzle/meta/0003_snapshot.json
```
1 | {
2 |   "id": "4d2bf069-17f7-4848-a16e-ce008e47d268",
3 |   "prevId": "9ea87331-4108-40dd-8ac1-32fb1d2f1149",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.chats": {
8 |       "name": "chats",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "user_id": {
18 |           "name": "user_id",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "title": {
24 |           "name": "title",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true,
28 |           "default": "'New Chat'"
29 |         },
30 |         "created_at": {
31 |           "name": "created_at",
32 |           "type": "timestamp",
33 |           "primaryKey": false,
34 |           "notNull": true,
35 |           "default": "now()"
36 |         },
37 |         "updated_at": {
38 |           "name": "updated_at",
39 |           "type": "timestamp",
40 |           "primaryKey": false,
41 |           "notNull": true,
42 |           "default": "now()"
43 |         }
44 |       },
45 |       "indexes": {},
46 |       "foreignKeys": {},
47 |       "compositePrimaryKeys": {},
48 |       "uniqueConstraints": {},
49 |       "policies": {},
50 |       "checkConstraints": {},
51 |       "isRLSEnabled": false
52 |     },
53 |     "public.messages": {
54 |       "name": "messages",
55 |       "schema": "",
56 |       "columns": {
57 |         "id": {
58 |           "name": "id",
59 |           "type": "text",
60 |           "primaryKey": true,
61 |           "notNull": true
62 |         },
63 |         "chat_id": {
64 |           "name": "chat_id",
65 |           "type": "text",
66 |           "primaryKey": false,
67 |           "notNull": true
68 |         },
69 |         "content": {
70 |           "name": "content",
71 |           "type": "text",
72 |           "primaryKey": false,
73 |           "notNull": true
74 |         },
75 |         "role": {
76 |           "name": "role",
77 |           "type": "text",
78 |           "primaryKey": false,
79 |           "notNull": true
80 |         },
81 |         "created_at": {
82 |           "name": "created_at",
83 |           "type": "timestamp",
84 |           "primaryKey": false,
85 |           "notNull": true,
86 |           "default": "now()"
87 |         },
88 |         "reasoning": {
89 |           "name": "reasoning",
90 |           "type": "text",
91 |           "primaryKey": false,
92 |           "notNull": false
93 |         },
94 |         "tool_calls": {
95 |           "name": "tool_calls",
96 |           "type": "jsonb",
97 |           "primaryKey": false,
98 |           "notNull": false
99 |         },
100 |         "tool_results": {
101 |           "name": "tool_results",
102 |           "type": "jsonb",
103 |           "primaryKey": false,
104 |           "notNull": false
105 |         },
106 |         "step_type": {
107 |           "name": "step_type",
108 |           "type": "text",
109 |           "primaryKey": false,
110 |           "notNull": false
111 |         },
112 |         "finish_reason": {
113 |           "name": "finish_reason",
114 |           "type": "text",
115 |           "primaryKey": false,
116 |           "notNull": false
117 |         }
118 |       },
119 |       "indexes": {},
120 |       "foreignKeys": {
121 |         "messages_chat_id_chats_id_fk": {
122 |           "name": "messages_chat_id_chats_id_fk",
123 |           "tableFrom": "messages",
124 |           "tableTo": "chats",
125 |           "columnsFrom": [
126 |             "chat_id"
127 |           ],
128 |           "columnsTo": [
129 |             "id"
130 |           ],
131 |           "onDelete": "cascade",
132 |           "onUpdate": "no action"
133 |         }
134 |       },
135 |       "compositePrimaryKeys": {},
136 |       "uniqueConstraints": {},
137 |       "policies": {},
138 |       "checkConstraints": {},
139 |       "isRLSEnabled": false
140 |     }
141 |   },
142 |   "enums": {},
143 |   "schemas": {},
144 |   "sequences": {},
145 |   "roles": {},
146 |   "policies": {},
147 |   "views": {},
148 |   "_meta": {
149 |     "columns": {},
150 |     "schemas": {},
151 |     "tables": {}
152 |   }
153 | }
```

drizzle/meta/0004_snapshot.json
```
1 | {
2 |   "id": "6369cdc2-8254-4270-a54d-6765b2b04c1a",
3 |   "prevId": "4d2bf069-17f7-4848-a16e-ce008e47d268",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.chats": {
8 |       "name": "chats",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "user_id": {
18 |           "name": "user_id",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "title": {
24 |           "name": "title",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true,
28 |           "default": "'New Chat'"
29 |         },
30 |         "created_at": {
31 |           "name": "created_at",
32 |           "type": "timestamp",
33 |           "primaryKey": false,
34 |           "notNull": true,
35 |           "default": "now()"
36 |         },
37 |         "updated_at": {
38 |           "name": "updated_at",
39 |           "type": "timestamp",
40 |           "primaryKey": false,
41 |           "notNull": true,
42 |           "default": "now()"
43 |         }
44 |       },
45 |       "indexes": {},
46 |       "foreignKeys": {},
47 |       "compositePrimaryKeys": {},
48 |       "uniqueConstraints": {},
49 |       "policies": {},
50 |       "checkConstraints": {},
51 |       "isRLSEnabled": false
52 |     },
53 |     "public.messages": {
54 |       "name": "messages",
55 |       "schema": "",
56 |       "columns": {
57 |         "id": {
58 |           "name": "id",
59 |           "type": "text",
60 |           "primaryKey": true,
61 |           "notNull": true
62 |         },
63 |         "chat_id": {
64 |           "name": "chat_id",
65 |           "type": "text",
66 |           "primaryKey": false,
67 |           "notNull": true
68 |         },
69 |         "content": {
70 |           "name": "content",
71 |           "type": "text",
72 |           "primaryKey": false,
73 |           "notNull": true
74 |         },
75 |         "role": {
76 |           "name": "role",
77 |           "type": "text",
78 |           "primaryKey": false,
79 |           "notNull": true
80 |         },
81 |         "created_at": {
82 |           "name": "created_at",
83 |           "type": "timestamp",
84 |           "primaryKey": false,
85 |           "notNull": true,
86 |           "default": "now()"
87 |         }
88 |       },
89 |       "indexes": {},
90 |       "foreignKeys": {
91 |         "messages_chat_id_chats_id_fk": {
92 |           "name": "messages_chat_id_chats_id_fk",
93 |           "tableFrom": "messages",
94 |           "tableTo": "chats",
95 |           "columnsFrom": [
96 |             "chat_id"
97 |           ],
98 |           "columnsTo": [
99 |             "id"
100 |           ],
101 |           "onDelete": "cascade",
102 |           "onUpdate": "no action"
103 |         }
104 |       },
105 |       "compositePrimaryKeys": {},
106 |       "uniqueConstraints": {},
107 |       "policies": {},
108 |       "checkConstraints": {},
109 |       "isRLSEnabled": false
110 |     }
111 |   },
112 |   "enums": {},
113 |   "schemas": {},
114 |   "sequences": {},
115 |   "roles": {},
116 |   "policies": {},
117 |   "views": {},
118 |   "_meta": {
119 |     "columns": {},
120 |     "schemas": {},
121 |     "tables": {}
122 |   }
123 | }
```

drizzle/meta/0005_snapshot.json
```
1 | {
2 |   "id": "938dd39c-9206-4289-a8ce-f2a81656b4fe",
3 |   "prevId": "6369cdc2-8254-4270-a54d-6765b2b04c1a",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.chats": {
8 |       "name": "chats",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "user_id": {
18 |           "name": "user_id",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "title": {
24 |           "name": "title",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true,
28 |           "default": "'New Chat'"
29 |         },
30 |         "created_at": {
31 |           "name": "created_at",
32 |           "type": "timestamp",
33 |           "primaryKey": false,
34 |           "notNull": true,
35 |           "default": "now()"
36 |         },
37 |         "updated_at": {
38 |           "name": "updated_at",
39 |           "type": "timestamp",
40 |           "primaryKey": false,
41 |           "notNull": true,
42 |           "default": "now()"
43 |         }
44 |       },
45 |       "indexes": {},
46 |       "foreignKeys": {},
47 |       "compositePrimaryKeys": {},
48 |       "uniqueConstraints": {},
49 |       "policies": {},
50 |       "checkConstraints": {},
51 |       "isRLSEnabled": false
52 |     },
53 |     "public.messages": {
54 |       "name": "messages",
55 |       "schema": "",
56 |       "columns": {
57 |         "id": {
58 |           "name": "id",
59 |           "type": "text",
60 |           "primaryKey": true,
61 |           "notNull": true
62 |         },
63 |         "chat_id": {
64 |           "name": "chat_id",
65 |           "type": "text",
66 |           "primaryKey": false,
67 |           "notNull": true
68 |         },
69 |         "parts": {
70 |           "name": "parts",
71 |           "type": "json",
72 |           "primaryKey": false,
73 |           "notNull": true
74 |         },
75 |         "role": {
76 |           "name": "role",
77 |           "type": "text",
78 |           "primaryKey": false,
79 |           "notNull": true
80 |         },
81 |         "created_at": {
82 |           "name": "created_at",
83 |           "type": "timestamp",
84 |           "primaryKey": false,
85 |           "notNull": true,
86 |           "default": "now()"
87 |         }
88 |       },
89 |       "indexes": {},
90 |       "foreignKeys": {
91 |         "messages_chat_id_chats_id_fk": {
92 |           "name": "messages_chat_id_chats_id_fk",
93 |           "tableFrom": "messages",
94 |           "tableTo": "chats",
95 |           "columnsFrom": [
96 |             "chat_id"
97 |           ],
98 |           "columnsTo": [
99 |             "id"
100 |           ],
101 |           "onDelete": "cascade",
102 |           "onUpdate": "no action"
103 |         }
104 |       },
105 |       "compositePrimaryKeys": {},
106 |       "uniqueConstraints": {},
107 |       "policies": {},
108 |       "checkConstraints": {},
109 |       "isRLSEnabled": false
110 |     }
111 |   },
112 |   "enums": {},
113 |   "schemas": {},
114 |   "sequences": {},
115 |   "roles": {},
116 |   "policies": {},
117 |   "views": {},
118 |   "_meta": {
119 |     "columns": {},
120 |     "schemas": {},
121 |     "tables": {}
122 |   }
123 | }
```

drizzle/meta/0007_snapshot.json
```
1 | {
2 |   "id": "9087da5d-3025-460b-97e6-0b0ad3fd23ea",
3 |   "prevId": "4de2adbb-fa3b-460b-869b-a98b906c9f77",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "userId": {
12 |           "name": "userId",
13 |           "type": "text",
14 |           "primaryKey": false,
15 |           "notNull": true
16 |         },
17 |         "providerId": {
18 |           "name": "providerId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "accountId": {
24 |           "name": "accountId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "providerType": {
30 |           "name": "providerType",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "access_token": {
36 |           "name": "access_token",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "refresh_token": {
42 |           "name": "refresh_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "expires_at": {
48 |           "name": "expires_at",
49 |           "type": "integer",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "token_type": {
54 |           "name": "token_type",
55 |           "type": "text",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "scope": {
60 |           "name": "scope",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "id_token": {
66 |           "name": "id_token",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "session_state": {
72 |           "name": "session_state",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "createdAt": {
78 |           "name": "createdAt",
79 |           "type": "timestamp",
80 |           "primaryKey": false,
81 |           "notNull": true,
82 |           "default": "now()"
83 |         },
84 |         "updatedAt": {
85 |           "name": "updatedAt",
86 |           "type": "timestamp",
87 |           "primaryKey": false,
88 |           "notNull": true,
89 |           "default": "now()"
90 |         }
91 |       },
92 |       "indexes": {},
93 |       "foreignKeys": {
94 |         "account_userId_user_id_fk": {
95 |           "name": "account_userId_user_id_fk",
96 |           "tableFrom": "account",
97 |           "tableTo": "user",
98 |           "columnsFrom": [
99 |             "userId"
100 |           ],
101 |           "columnsTo": [
102 |             "id"
103 |           ],
104 |           "onDelete": "cascade",
105 |           "onUpdate": "no action"
106 |         }
107 |       },
108 |       "compositePrimaryKeys": {
109 |         "account_providerId_accountId_pk": {
110 |           "name": "account_providerId_accountId_pk",
111 |           "columns": [
112 |             "providerId",
113 |             "accountId"
114 |           ]
115 |         }
116 |       },
117 |       "uniqueConstraints": {},
118 |       "policies": {},
119 |       "checkConstraints": {},
120 |       "isRLSEnabled": false
121 |     },
122 |     "public.chats": {
123 |       "name": "chats",
124 |       "schema": "",
125 |       "columns": {
126 |         "id": {
127 |           "name": "id",
128 |           "type": "text",
129 |           "primaryKey": true,
130 |           "notNull": true
131 |         },
132 |         "user_id": {
133 |           "name": "user_id",
134 |           "type": "text",
135 |           "primaryKey": false,
136 |           "notNull": true
137 |         },
138 |         "title": {
139 |           "name": "title",
140 |           "type": "text",
141 |           "primaryKey": false,
142 |           "notNull": true,
143 |           "default": "'New Chat'"
144 |         },
145 |         "created_at": {
146 |           "name": "created_at",
147 |           "type": "timestamp",
148 |           "primaryKey": false,
149 |           "notNull": true,
150 |           "default": "now()"
151 |         },
152 |         "updated_at": {
153 |           "name": "updated_at",
154 |           "type": "timestamp",
155 |           "primaryKey": false,
156 |           "notNull": true,
157 |           "default": "now()"
158 |         }
159 |       },
160 |       "indexes": {},
161 |       "foreignKeys": {},
162 |       "compositePrimaryKeys": {},
163 |       "uniqueConstraints": {},
164 |       "policies": {},
165 |       "checkConstraints": {},
166 |       "isRLSEnabled": false
167 |     },
168 |     "public.messages": {
169 |       "name": "messages",
170 |       "schema": "",
171 |       "columns": {
172 |         "id": {
173 |           "name": "id",
174 |           "type": "text",
175 |           "primaryKey": true,
176 |           "notNull": true
177 |         },
178 |         "chat_id": {
179 |           "name": "chat_id",
180 |           "type": "text",
181 |           "primaryKey": false,
182 |           "notNull": true
183 |         },
184 |         "role": {
185 |           "name": "role",
186 |           "type": "text",
187 |           "primaryKey": false,
188 |           "notNull": true
189 |         },
190 |         "parts": {
191 |           "name": "parts",
192 |           "type": "json",
193 |           "primaryKey": false,
194 |           "notNull": true
195 |         },
196 |         "created_at": {
197 |           "name": "created_at",
198 |           "type": "timestamp",
199 |           "primaryKey": false,
200 |           "notNull": true,
201 |           "default": "now()"
202 |         }
203 |       },
204 |       "indexes": {},
205 |       "foreignKeys": {
206 |         "messages_chat_id_chats_id_fk": {
207 |           "name": "messages_chat_id_chats_id_fk",
208 |           "tableFrom": "messages",
209 |           "tableTo": "chats",
210 |           "columnsFrom": [
211 |             "chat_id"
212 |           ],
213 |           "columnsTo": [
214 |             "id"
215 |           ],
216 |           "onDelete": "cascade",
217 |           "onUpdate": "no action"
218 |         }
219 |       },
220 |       "compositePrimaryKeys": {},
221 |       "uniqueConstraints": {},
222 |       "policies": {},
223 |       "checkConstraints": {},
224 |       "isRLSEnabled": false
225 |     },
226 |     "public.session": {
227 |       "name": "session",
228 |       "schema": "",
229 |       "columns": {
230 |         "id": {
231 |           "name": "id",
232 |           "type": "text",
233 |           "primaryKey": true,
234 |           "notNull": true
235 |         },
236 |         "sessionToken": {
237 |           "name": "sessionToken",
238 |           "type": "text",
239 |           "primaryKey": false,
240 |           "notNull": true
241 |         },
242 |         "userId": {
243 |           "name": "userId",
244 |           "type": "text",
245 |           "primaryKey": false,
246 |           "notNull": true
247 |         },
248 |         "expires": {
249 |           "name": "expires",
250 |           "type": "timestamp",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "ipAddress": {
255 |           "name": "ipAddress",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "userAgent": {
261 |           "name": "userAgent",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": false
265 |         },
266 |         "createdAt": {
267 |           "name": "createdAt",
268 |           "type": "timestamp",
269 |           "primaryKey": false,
270 |           "notNull": true,
271 |           "default": "now()"
272 |         },
273 |         "updatedAt": {
274 |           "name": "updatedAt",
275 |           "type": "timestamp",
276 |           "primaryKey": false,
277 |           "notNull": true,
278 |           "default": "now()"
279 |         }
280 |       },
281 |       "indexes": {},
282 |       "foreignKeys": {
283 |         "session_userId_user_id_fk": {
284 |           "name": "session_userId_user_id_fk",
285 |           "tableFrom": "session",
286 |           "tableTo": "user",
287 |           "columnsFrom": [
288 |             "userId"
289 |           ],
290 |           "columnsTo": [
291 |             "id"
292 |           ],
293 |           "onDelete": "cascade",
294 |           "onUpdate": "no action"
295 |         }
296 |       },
297 |       "compositePrimaryKeys": {},
298 |       "uniqueConstraints": {
299 |         "session_sessionToken_unique": {
300 |           "name": "session_sessionToken_unique",
301 |           "nullsNotDistinct": false,
302 |           "columns": [
303 |             "sessionToken"
304 |           ]
305 |         }
306 |       },
307 |       "policies": {},
308 |       "checkConstraints": {},
309 |       "isRLSEnabled": false
310 |     },
311 |     "public.user": {
312 |       "name": "user",
313 |       "schema": "",
314 |       "columns": {
315 |         "id": {
316 |           "name": "id",
317 |           "type": "text",
318 |           "primaryKey": true,
319 |           "notNull": true
320 |         },
321 |         "name": {
322 |           "name": "name",
323 |           "type": "text",
324 |           "primaryKey": false,
325 |           "notNull": false
326 |         },
327 |         "email": {
328 |           "name": "email",
329 |           "type": "text",
330 |           "primaryKey": false,
331 |           "notNull": true
332 |         },
333 |         "emailVerified": {
334 |           "name": "emailVerified",
335 |           "type": "timestamp",
336 |           "primaryKey": false,
337 |           "notNull": false
338 |         },
339 |         "image": {
340 |           "name": "image",
341 |           "type": "text",
342 |           "primaryKey": false,
343 |           "notNull": false
344 |         },
345 |         "createdAt": {
346 |           "name": "createdAt",
347 |           "type": "timestamp",
348 |           "primaryKey": false,
349 |           "notNull": true,
350 |           "default": "now()"
351 |         },
352 |         "updatedAt": {
353 |           "name": "updatedAt",
354 |           "type": "timestamp",
355 |           "primaryKey": false,
356 |           "notNull": true,
357 |           "default": "now()"
358 |         }
359 |       },
360 |       "indexes": {},
361 |       "foreignKeys": {},
362 |       "compositePrimaryKeys": {},
363 |       "uniqueConstraints": {
364 |         "user_email_unique": {
365 |           "name": "user_email_unique",
366 |           "nullsNotDistinct": false,
367 |           "columns": [
368 |             "email"
369 |           ]
370 |         }
371 |       },
372 |       "policies": {},
373 |       "checkConstraints": {},
374 |       "isRLSEnabled": false
375 |     },
376 |     "public.verification": {
377 |       "name": "verification",
378 |       "schema": "",
379 |       "columns": {
380 |         "id": {
381 |           "name": "id",
382 |           "type": "text",
383 |           "primaryKey": true,
384 |           "notNull": true
385 |         },
386 |         "identifier": {
387 |           "name": "identifier",
388 |           "type": "text",
389 |           "primaryKey": false,
390 |           "notNull": true
391 |         },
392 |         "value": {
393 |           "name": "value",
394 |           "type": "text",
395 |           "primaryKey": false,
396 |           "notNull": true
397 |         },
398 |         "expiresAt": {
399 |           "name": "expiresAt",
400 |           "type": "timestamp",
401 |           "primaryKey": false,
402 |           "notNull": true
403 |         },
404 |         "createdAt": {
405 |           "name": "createdAt",
406 |           "type": "timestamp",
407 |           "primaryKey": false,
408 |           "notNull": true,
409 |           "default": "now()"
410 |         },
411 |         "updatedAt": {
412 |           "name": "updatedAt",
413 |           "type": "timestamp",
414 |           "primaryKey": false,
415 |           "notNull": true,
416 |           "default": "now()"
417 |         }
418 |       },
419 |       "indexes": {},
420 |       "foreignKeys": {},
421 |       "compositePrimaryKeys": {},
422 |       "uniqueConstraints": {},
423 |       "policies": {},
424 |       "checkConstraints": {},
425 |       "isRLSEnabled": false
426 |     }
427 |   },
428 |   "enums": {},
429 |   "schemas": {},
430 |   "sequences": {},
431 |   "roles": {},
432 |   "policies": {},
433 |   "views": {},
434 |   "_meta": {
435 |     "columns": {},
436 |     "schemas": {},
437 |     "tables": {}
438 |   }
439 | }
```

drizzle/meta/0008_snapshot.json
```
1 | {
2 |   "id": "f788fcaf-9e85-4b3d-af1f-2fd486b7755a",
3 |   "prevId": "9087da5d-3025-460b-97e6-0b0ad3fd23ea",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "userId": {
12 |           "name": "userId",
13 |           "type": "text",
14 |           "primaryKey": false,
15 |           "notNull": true
16 |         },
17 |         "providerId": {
18 |           "name": "providerId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "accountId": {
24 |           "name": "accountId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "providerType": {
30 |           "name": "providerType",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "access_token": {
36 |           "name": "access_token",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "refresh_token": {
42 |           "name": "refresh_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "expires_at": {
48 |           "name": "expires_at",
49 |           "type": "timestamp",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "token_type": {
54 |           "name": "token_type",
55 |           "type": "text",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "scope": {
60 |           "name": "scope",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "id_token": {
66 |           "name": "id_token",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "session_state": {
72 |           "name": "session_state",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "createdAt": {
78 |           "name": "createdAt",
79 |           "type": "timestamp",
80 |           "primaryKey": false,
81 |           "notNull": true,
82 |           "default": "now()"
83 |         },
84 |         "updatedAt": {
85 |           "name": "updatedAt",
86 |           "type": "timestamp",
87 |           "primaryKey": false,
88 |           "notNull": true,
89 |           "default": "now()"
90 |         }
91 |       },
92 |       "indexes": {},
93 |       "foreignKeys": {
94 |         "account_userId_user_id_fk": {
95 |           "name": "account_userId_user_id_fk",
96 |           "tableFrom": "account",
97 |           "tableTo": "user",
98 |           "columnsFrom": [
99 |             "userId"
100 |           ],
101 |           "columnsTo": [
102 |             "id"
103 |           ],
104 |           "onDelete": "cascade",
105 |           "onUpdate": "no action"
106 |         }
107 |       },
108 |       "compositePrimaryKeys": {
109 |         "account_providerId_accountId_pk": {
110 |           "name": "account_providerId_accountId_pk",
111 |           "columns": [
112 |             "providerId",
113 |             "accountId"
114 |           ]
115 |         }
116 |       },
117 |       "uniqueConstraints": {},
118 |       "policies": {},
119 |       "checkConstraints": {},
120 |       "isRLSEnabled": false
121 |     },
122 |     "public.chats": {
123 |       "name": "chats",
124 |       "schema": "",
125 |       "columns": {
126 |         "id": {
127 |           "name": "id",
128 |           "type": "text",
129 |           "primaryKey": true,
130 |           "notNull": true
131 |         },
132 |         "user_id": {
133 |           "name": "user_id",
134 |           "type": "text",
135 |           "primaryKey": false,
136 |           "notNull": true
137 |         },
138 |         "title": {
139 |           "name": "title",
140 |           "type": "text",
141 |           "primaryKey": false,
142 |           "notNull": true,
143 |           "default": "'New Chat'"
144 |         },
145 |         "created_at": {
146 |           "name": "created_at",
147 |           "type": "timestamp",
148 |           "primaryKey": false,
149 |           "notNull": true,
150 |           "default": "now()"
151 |         },
152 |         "updated_at": {
153 |           "name": "updated_at",
154 |           "type": "timestamp",
155 |           "primaryKey": false,
156 |           "notNull": true,
157 |           "default": "now()"
158 |         }
159 |       },
160 |       "indexes": {},
161 |       "foreignKeys": {},
162 |       "compositePrimaryKeys": {},
163 |       "uniqueConstraints": {},
164 |       "policies": {},
165 |       "checkConstraints": {},
166 |       "isRLSEnabled": false
167 |     },
168 |     "public.messages": {
169 |       "name": "messages",
170 |       "schema": "",
171 |       "columns": {
172 |         "id": {
173 |           "name": "id",
174 |           "type": "text",
175 |           "primaryKey": true,
176 |           "notNull": true
177 |         },
178 |         "chat_id": {
179 |           "name": "chat_id",
180 |           "type": "text",
181 |           "primaryKey": false,
182 |           "notNull": true
183 |         },
184 |         "role": {
185 |           "name": "role",
186 |           "type": "text",
187 |           "primaryKey": false,
188 |           "notNull": true
189 |         },
190 |         "parts": {
191 |           "name": "parts",
192 |           "type": "json",
193 |           "primaryKey": false,
194 |           "notNull": true
195 |         },
196 |         "created_at": {
197 |           "name": "created_at",
198 |           "type": "timestamp",
199 |           "primaryKey": false,
200 |           "notNull": true,
201 |           "default": "now()"
202 |         }
203 |       },
204 |       "indexes": {},
205 |       "foreignKeys": {
206 |         "messages_chat_id_chats_id_fk": {
207 |           "name": "messages_chat_id_chats_id_fk",
208 |           "tableFrom": "messages",
209 |           "tableTo": "chats",
210 |           "columnsFrom": [
211 |             "chat_id"
212 |           ],
213 |           "columnsTo": [
214 |             "id"
215 |           ],
216 |           "onDelete": "cascade",
217 |           "onUpdate": "no action"
218 |         }
219 |       },
220 |       "compositePrimaryKeys": {},
221 |       "uniqueConstraints": {},
222 |       "policies": {},
223 |       "checkConstraints": {},
224 |       "isRLSEnabled": false
225 |     },
226 |     "public.session": {
227 |       "name": "session",
228 |       "schema": "",
229 |       "columns": {
230 |         "id": {
231 |           "name": "id",
232 |           "type": "text",
233 |           "primaryKey": true,
234 |           "notNull": true
235 |         },
236 |         "sessionToken": {
237 |           "name": "sessionToken",
238 |           "type": "text",
239 |           "primaryKey": false,
240 |           "notNull": true
241 |         },
242 |         "userId": {
243 |           "name": "userId",
244 |           "type": "text",
245 |           "primaryKey": false,
246 |           "notNull": true
247 |         },
248 |         "expires": {
249 |           "name": "expires",
250 |           "type": "timestamp",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "ipAddress": {
255 |           "name": "ipAddress",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "userAgent": {
261 |           "name": "userAgent",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": false
265 |         },
266 |         "createdAt": {
267 |           "name": "createdAt",
268 |           "type": "timestamp",
269 |           "primaryKey": false,
270 |           "notNull": true,
271 |           "default": "now()"
272 |         },
273 |         "updatedAt": {
274 |           "name": "updatedAt",
275 |           "type": "timestamp",
276 |           "primaryKey": false,
277 |           "notNull": true,
278 |           "default": "now()"
279 |         }
280 |       },
281 |       "indexes": {},
282 |       "foreignKeys": {
283 |         "session_userId_user_id_fk": {
284 |           "name": "session_userId_user_id_fk",
285 |           "tableFrom": "session",
286 |           "tableTo": "user",
287 |           "columnsFrom": [
288 |             "userId"
289 |           ],
290 |           "columnsTo": [
291 |             "id"
292 |           ],
293 |           "onDelete": "cascade",
294 |           "onUpdate": "no action"
295 |         }
296 |       },
297 |       "compositePrimaryKeys": {},
298 |       "uniqueConstraints": {
299 |         "session_sessionToken_unique": {
300 |           "name": "session_sessionToken_unique",
301 |           "nullsNotDistinct": false,
302 |           "columns": [
303 |             "sessionToken"
304 |           ]
305 |         }
306 |       },
307 |       "policies": {},
308 |       "checkConstraints": {},
309 |       "isRLSEnabled": false
310 |     },
311 |     "public.user": {
312 |       "name": "user",
313 |       "schema": "",
314 |       "columns": {
315 |         "id": {
316 |           "name": "id",
317 |           "type": "text",
318 |           "primaryKey": true,
319 |           "notNull": true
320 |         },
321 |         "name": {
322 |           "name": "name",
323 |           "type": "text",
324 |           "primaryKey": false,
325 |           "notNull": false
326 |         },
327 |         "email": {
328 |           "name": "email",
329 |           "type": "text",
330 |           "primaryKey": false,
331 |           "notNull": true
332 |         },
333 |         "emailVerified": {
334 |           "name": "emailVerified",
335 |           "type": "timestamp",
336 |           "primaryKey": false,
337 |           "notNull": false
338 |         },
339 |         "image": {
340 |           "name": "image",
341 |           "type": "text",
342 |           "primaryKey": false,
343 |           "notNull": false
344 |         },
345 |         "createdAt": {
346 |           "name": "createdAt",
347 |           "type": "timestamp",
348 |           "primaryKey": false,
349 |           "notNull": true,
350 |           "default": "now()"
351 |         },
352 |         "updatedAt": {
353 |           "name": "updatedAt",
354 |           "type": "timestamp",
355 |           "primaryKey": false,
356 |           "notNull": true,
357 |           "default": "now()"
358 |         }
359 |       },
360 |       "indexes": {},
361 |       "foreignKeys": {},
362 |       "compositePrimaryKeys": {},
363 |       "uniqueConstraints": {
364 |         "user_email_unique": {
365 |           "name": "user_email_unique",
366 |           "nullsNotDistinct": false,
367 |           "columns": [
368 |             "email"
369 |           ]
370 |         }
371 |       },
372 |       "policies": {},
373 |       "checkConstraints": {},
374 |       "isRLSEnabled": false
375 |     },
376 |     "public.verification": {
377 |       "name": "verification",
378 |       "schema": "",
379 |       "columns": {
380 |         "id": {
381 |           "name": "id",
382 |           "type": "text",
383 |           "primaryKey": true,
384 |           "notNull": true
385 |         },
386 |         "identifier": {
387 |           "name": "identifier",
388 |           "type": "text",
389 |           "primaryKey": false,
390 |           "notNull": true
391 |         },
392 |         "value": {
393 |           "name": "value",
394 |           "type": "text",
395 |           "primaryKey": false,
396 |           "notNull": true
397 |         },
398 |         "expiresAt": {
399 |           "name": "expiresAt",
400 |           "type": "timestamp",
401 |           "primaryKey": false,
402 |           "notNull": true
403 |         },
404 |         "createdAt": {
405 |           "name": "createdAt",
406 |           "type": "timestamp",
407 |           "primaryKey": false,
408 |           "notNull": true,
409 |           "default": "now()"
410 |         },
411 |         "updatedAt": {
412 |           "name": "updatedAt",
413 |           "type": "timestamp",
414 |           "primaryKey": false,
415 |           "notNull": true,
416 |           "default": "now()"
417 |         }
418 |       },
419 |       "indexes": {},
420 |       "foreignKeys": {},
421 |       "compositePrimaryKeys": {},
422 |       "uniqueConstraints": {},
423 |       "policies": {},
424 |       "checkConstraints": {},
425 |       "isRLSEnabled": false
426 |     }
427 |   },
428 |   "enums": {},
429 |   "schemas": {},
430 |   "sequences": {},
431 |   "roles": {},
432 |   "policies": {},
433 |   "views": {},
434 |   "_meta": {
435 |     "columns": {},
436 |     "schemas": {},
437 |     "tables": {}
438 |   }
439 | }
```

drizzle/meta/0009_snapshot.json
```
1 | {
2 |   "id": "d5e332a3-33c2-458b-9413-fb800ae031fb",
3 |   "prevId": "f788fcaf-9e85-4b3d-af1f-2fd486b7755a",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "userId": {
12 |           "name": "userId",
13 |           "type": "text",
14 |           "primaryKey": false,
15 |           "notNull": true
16 |         },
17 |         "providerId": {
18 |           "name": "providerId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "accountId": {
24 |           "name": "accountId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "providerType": {
30 |           "name": "providerType",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "access_token": {
36 |           "name": "access_token",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "refresh_token": {
42 |           "name": "refresh_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "expires_at": {
48 |           "name": "expires_at",
49 |           "type": "timestamp",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "token_type": {
54 |           "name": "token_type",
55 |           "type": "text",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "scope": {
60 |           "name": "scope",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "id_token": {
66 |           "name": "id_token",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "session_state": {
72 |           "name": "session_state",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "createdAt": {
78 |           "name": "createdAt",
79 |           "type": "timestamp",
80 |           "primaryKey": false,
81 |           "notNull": true,
82 |           "default": "now()"
83 |         },
84 |         "updatedAt": {
85 |           "name": "updatedAt",
86 |           "type": "timestamp",
87 |           "primaryKey": false,
88 |           "notNull": true,
89 |           "default": "now()"
90 |         }
91 |       },
92 |       "indexes": {},
93 |       "foreignKeys": {
94 |         "account_userId_user_id_fk": {
95 |           "name": "account_userId_user_id_fk",
96 |           "tableFrom": "account",
97 |           "tableTo": "user",
98 |           "columnsFrom": [
99 |             "userId"
100 |           ],
101 |           "columnsTo": [
102 |             "id"
103 |           ],
104 |           "onDelete": "cascade",
105 |           "onUpdate": "no action"
106 |         }
107 |       },
108 |       "compositePrimaryKeys": {
109 |         "account_providerId_accountId_pk": {
110 |           "name": "account_providerId_accountId_pk",
111 |           "columns": [
112 |             "providerId",
113 |             "accountId"
114 |           ]
115 |         }
116 |       },
117 |       "uniqueConstraints": {},
118 |       "policies": {},
119 |       "checkConstraints": {},
120 |       "isRLSEnabled": false
121 |     },
122 |     "public.chats": {
123 |       "name": "chats",
124 |       "schema": "",
125 |       "columns": {
126 |         "id": {
127 |           "name": "id",
128 |           "type": "text",
129 |           "primaryKey": true,
130 |           "notNull": true
131 |         },
132 |         "user_id": {
133 |           "name": "user_id",
134 |           "type": "text",
135 |           "primaryKey": false,
136 |           "notNull": true
137 |         },
138 |         "title": {
139 |           "name": "title",
140 |           "type": "text",
141 |           "primaryKey": false,
142 |           "notNull": true,
143 |           "default": "'New Chat'"
144 |         },
145 |         "created_at": {
146 |           "name": "created_at",
147 |           "type": "timestamp",
148 |           "primaryKey": false,
149 |           "notNull": true,
150 |           "default": "now()"
151 |         },
152 |         "updated_at": {
153 |           "name": "updated_at",
154 |           "type": "timestamp",
155 |           "primaryKey": false,
156 |           "notNull": true,
157 |           "default": "now()"
158 |         }
159 |       },
160 |       "indexes": {},
161 |       "foreignKeys": {},
162 |       "compositePrimaryKeys": {},
163 |       "uniqueConstraints": {},
164 |       "policies": {},
165 |       "checkConstraints": {},
166 |       "isRLSEnabled": false
167 |     },
168 |     "public.messages": {
169 |       "name": "messages",
170 |       "schema": "",
171 |       "columns": {
172 |         "id": {
173 |           "name": "id",
174 |           "type": "text",
175 |           "primaryKey": true,
176 |           "notNull": true
177 |         },
178 |         "chat_id": {
179 |           "name": "chat_id",
180 |           "type": "text",
181 |           "primaryKey": false,
182 |           "notNull": true
183 |         },
184 |         "role": {
185 |           "name": "role",
186 |           "type": "text",
187 |           "primaryKey": false,
188 |           "notNull": true
189 |         },
190 |         "parts": {
191 |           "name": "parts",
192 |           "type": "json",
193 |           "primaryKey": false,
194 |           "notNull": true
195 |         },
196 |         "created_at": {
197 |           "name": "created_at",
198 |           "type": "timestamp",
199 |           "primaryKey": false,
200 |           "notNull": true,
201 |           "default": "now()"
202 |         }
203 |       },
204 |       "indexes": {},
205 |       "foreignKeys": {
206 |         "messages_chat_id_chats_id_fk": {
207 |           "name": "messages_chat_id_chats_id_fk",
208 |           "tableFrom": "messages",
209 |           "tableTo": "chats",
210 |           "columnsFrom": [
211 |             "chat_id"
212 |           ],
213 |           "columnsTo": [
214 |             "id"
215 |           ],
216 |           "onDelete": "cascade",
217 |           "onUpdate": "no action"
218 |         }
219 |       },
220 |       "compositePrimaryKeys": {},
221 |       "uniqueConstraints": {},
222 |       "policies": {},
223 |       "checkConstraints": {},
224 |       "isRLSEnabled": false
225 |     },
226 |     "public.session": {
227 |       "name": "session",
228 |       "schema": "",
229 |       "columns": {
230 |         "id": {
231 |           "name": "id",
232 |           "type": "text",
233 |           "primaryKey": true,
234 |           "notNull": true
235 |         },
236 |         "sessionToken": {
237 |           "name": "sessionToken",
238 |           "type": "text",
239 |           "primaryKey": false,
240 |           "notNull": true
241 |         },
242 |         "userId": {
243 |           "name": "userId",
244 |           "type": "text",
245 |           "primaryKey": false,
246 |           "notNull": true
247 |         },
248 |         "expires": {
249 |           "name": "expires",
250 |           "type": "timestamp",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "ipAddress": {
255 |           "name": "ipAddress",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "userAgent": {
261 |           "name": "userAgent",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": false
265 |         },
266 |         "createdAt": {
267 |           "name": "createdAt",
268 |           "type": "timestamp",
269 |           "primaryKey": false,
270 |           "notNull": true,
271 |           "default": "now()"
272 |         },
273 |         "updatedAt": {
274 |           "name": "updatedAt",
275 |           "type": "timestamp",
276 |           "primaryKey": false,
277 |           "notNull": true,
278 |           "default": "now()"
279 |         }
280 |       },
281 |       "indexes": {},
282 |       "foreignKeys": {
283 |         "session_userId_user_id_fk": {
284 |           "name": "session_userId_user_id_fk",
285 |           "tableFrom": "session",
286 |           "tableTo": "user",
287 |           "columnsFrom": [
288 |             "userId"
289 |           ],
290 |           "columnsTo": [
291 |             "id"
292 |           ],
293 |           "onDelete": "cascade",
294 |           "onUpdate": "no action"
295 |         }
296 |       },
297 |       "compositePrimaryKeys": {},
298 |       "uniqueConstraints": {
299 |         "session_sessionToken_unique": {
300 |           "name": "session_sessionToken_unique",
301 |           "nullsNotDistinct": false,
302 |           "columns": [
303 |             "sessionToken"
304 |           ]
305 |         }
306 |       },
307 |       "policies": {},
308 |       "checkConstraints": {},
309 |       "isRLSEnabled": false
310 |     },
311 |     "public.user": {
312 |       "name": "user",
313 |       "schema": "",
314 |       "columns": {
315 |         "id": {
316 |           "name": "id",
317 |           "type": "text",
318 |           "primaryKey": true,
319 |           "notNull": true
320 |         },
321 |         "name": {
322 |           "name": "name",
323 |           "type": "text",
324 |           "primaryKey": false,
325 |           "notNull": false
326 |         },
327 |         "email": {
328 |           "name": "email",
329 |           "type": "text",
330 |           "primaryKey": false,
331 |           "notNull": true
332 |         },
333 |         "emailVerified": {
334 |           "name": "emailVerified",
335 |           "type": "boolean",
336 |           "primaryKey": false,
337 |           "notNull": false
338 |         },
339 |         "image": {
340 |           "name": "image",
341 |           "type": "text",
342 |           "primaryKey": false,
343 |           "notNull": false
344 |         },
345 |         "createdAt": {
346 |           "name": "createdAt",
347 |           "type": "timestamp",
348 |           "primaryKey": false,
349 |           "notNull": true,
350 |           "default": "now()"
351 |         },
352 |         "updatedAt": {
353 |           "name": "updatedAt",
354 |           "type": "timestamp",
355 |           "primaryKey": false,
356 |           "notNull": true,
357 |           "default": "now()"
358 |         }
359 |       },
360 |       "indexes": {},
361 |       "foreignKeys": {},
362 |       "compositePrimaryKeys": {},
363 |       "uniqueConstraints": {
364 |         "user_email_unique": {
365 |           "name": "user_email_unique",
366 |           "nullsNotDistinct": false,
367 |           "columns": [
368 |             "email"
369 |           ]
370 |         }
371 |       },
372 |       "policies": {},
373 |       "checkConstraints": {},
374 |       "isRLSEnabled": false
375 |     },
376 |     "public.verification": {
377 |       "name": "verification",
378 |       "schema": "",
379 |       "columns": {
380 |         "id": {
381 |           "name": "id",
382 |           "type": "text",
383 |           "primaryKey": true,
384 |           "notNull": true
385 |         },
386 |         "identifier": {
387 |           "name": "identifier",
388 |           "type": "text",
389 |           "primaryKey": false,
390 |           "notNull": true
391 |         },
392 |         "value": {
393 |           "name": "value",
394 |           "type": "text",
395 |           "primaryKey": false,
396 |           "notNull": true
397 |         },
398 |         "expiresAt": {
399 |           "name": "expiresAt",
400 |           "type": "timestamp",
401 |           "primaryKey": false,
402 |           "notNull": true
403 |         },
404 |         "createdAt": {
405 |           "name": "createdAt",
406 |           "type": "timestamp",
407 |           "primaryKey": false,
408 |           "notNull": true,
409 |           "default": "now()"
410 |         },
411 |         "updatedAt": {
412 |           "name": "updatedAt",
413 |           "type": "timestamp",
414 |           "primaryKey": false,
415 |           "notNull": true,
416 |           "default": "now()"
417 |         }
418 |       },
419 |       "indexes": {},
420 |       "foreignKeys": {},
421 |       "compositePrimaryKeys": {},
422 |       "uniqueConstraints": {},
423 |       "policies": {},
424 |       "checkConstraints": {},
425 |       "isRLSEnabled": false
426 |     }
427 |   },
428 |   "enums": {},
429 |   "schemas": {},
430 |   "sequences": {},
431 |   "roles": {},
432 |   "policies": {},
433 |   "views": {},
434 |   "_meta": {
435 |     "columns": {},
436 |     "schemas": {},
437 |     "tables": {}
438 |   }
439 | }
```

drizzle/meta/0010_snapshot.json
```
1 | {
2 |   "id": "fdd5cf50-77dd-4cd6-ad47-24c0efb4c8e4",
3 |   "prevId": "d5e332a3-33c2-458b-9413-fb800ae031fb",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "userId": {
12 |           "name": "userId",
13 |           "type": "text",
14 |           "primaryKey": false,
15 |           "notNull": true
16 |         },
17 |         "providerId": {
18 |           "name": "providerId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "accountId": {
24 |           "name": "accountId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "providerType": {
30 |           "name": "providerType",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "access_token": {
36 |           "name": "access_token",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "refresh_token": {
42 |           "name": "refresh_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "access_token_expires_at": {
48 |           "name": "access_token_expires_at",
49 |           "type": "integer",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "token_type": {
54 |           "name": "token_type",
55 |           "type": "text",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "scope": {
60 |           "name": "scope",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "id_token": {
66 |           "name": "id_token",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "session_state": {
72 |           "name": "session_state",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "createdAt": {
78 |           "name": "createdAt",
79 |           "type": "timestamp",
80 |           "primaryKey": false,
81 |           "notNull": true,
82 |           "default": "now()"
83 |         },
84 |         "updatedAt": {
85 |           "name": "updatedAt",
86 |           "type": "timestamp",
87 |           "primaryKey": false,
88 |           "notNull": true,
89 |           "default": "now()"
90 |         }
91 |       },
92 |       "indexes": {},
93 |       "foreignKeys": {
94 |         "account_userId_user_id_fk": {
95 |           "name": "account_userId_user_id_fk",
96 |           "tableFrom": "account",
97 |           "tableTo": "user",
98 |           "columnsFrom": [
99 |             "userId"
100 |           ],
101 |           "columnsTo": [
102 |             "id"
103 |           ],
104 |           "onDelete": "cascade",
105 |           "onUpdate": "no action"
106 |         }
107 |       },
108 |       "compositePrimaryKeys": {
109 |         "account_providerId_accountId_pk": {
110 |           "name": "account_providerId_accountId_pk",
111 |           "columns": [
112 |             "providerId",
113 |             "accountId"
114 |           ]
115 |         }
116 |       },
117 |       "uniqueConstraints": {},
118 |       "policies": {},
119 |       "checkConstraints": {},
120 |       "isRLSEnabled": false
121 |     },
122 |     "public.chats": {
123 |       "name": "chats",
124 |       "schema": "",
125 |       "columns": {
126 |         "id": {
127 |           "name": "id",
128 |           "type": "text",
129 |           "primaryKey": true,
130 |           "notNull": true
131 |         },
132 |         "user_id": {
133 |           "name": "user_id",
134 |           "type": "text",
135 |           "primaryKey": false,
136 |           "notNull": true
137 |         },
138 |         "title": {
139 |           "name": "title",
140 |           "type": "text",
141 |           "primaryKey": false,
142 |           "notNull": true,
143 |           "default": "'New Chat'"
144 |         },
145 |         "created_at": {
146 |           "name": "created_at",
147 |           "type": "timestamp",
148 |           "primaryKey": false,
149 |           "notNull": true,
150 |           "default": "now()"
151 |         },
152 |         "updated_at": {
153 |           "name": "updated_at",
154 |           "type": "timestamp",
155 |           "primaryKey": false,
156 |           "notNull": true,
157 |           "default": "now()"
158 |         }
159 |       },
160 |       "indexes": {},
161 |       "foreignKeys": {},
162 |       "compositePrimaryKeys": {},
163 |       "uniqueConstraints": {},
164 |       "policies": {},
165 |       "checkConstraints": {},
166 |       "isRLSEnabled": false
167 |     },
168 |     "public.messages": {
169 |       "name": "messages",
170 |       "schema": "",
171 |       "columns": {
172 |         "id": {
173 |           "name": "id",
174 |           "type": "text",
175 |           "primaryKey": true,
176 |           "notNull": true
177 |         },
178 |         "chat_id": {
179 |           "name": "chat_id",
180 |           "type": "text",
181 |           "primaryKey": false,
182 |           "notNull": true
183 |         },
184 |         "role": {
185 |           "name": "role",
186 |           "type": "text",
187 |           "primaryKey": false,
188 |           "notNull": true
189 |         },
190 |         "parts": {
191 |           "name": "parts",
192 |           "type": "json",
193 |           "primaryKey": false,
194 |           "notNull": true
195 |         },
196 |         "created_at": {
197 |           "name": "created_at",
198 |           "type": "timestamp",
199 |           "primaryKey": false,
200 |           "notNull": true,
201 |           "default": "now()"
202 |         }
203 |       },
204 |       "indexes": {},
205 |       "foreignKeys": {
206 |         "messages_chat_id_chats_id_fk": {
207 |           "name": "messages_chat_id_chats_id_fk",
208 |           "tableFrom": "messages",
209 |           "tableTo": "chats",
210 |           "columnsFrom": [
211 |             "chat_id"
212 |           ],
213 |           "columnsTo": [
214 |             "id"
215 |           ],
216 |           "onDelete": "cascade",
217 |           "onUpdate": "no action"
218 |         }
219 |       },
220 |       "compositePrimaryKeys": {},
221 |       "uniqueConstraints": {},
222 |       "policies": {},
223 |       "checkConstraints": {},
224 |       "isRLSEnabled": false
225 |     },
226 |     "public.session": {
227 |       "name": "session",
228 |       "schema": "",
229 |       "columns": {
230 |         "id": {
231 |           "name": "id",
232 |           "type": "text",
233 |           "primaryKey": true,
234 |           "notNull": true
235 |         },
236 |         "sessionToken": {
237 |           "name": "sessionToken",
238 |           "type": "text",
239 |           "primaryKey": false,
240 |           "notNull": true
241 |         },
242 |         "userId": {
243 |           "name": "userId",
244 |           "type": "text",
245 |           "primaryKey": false,
246 |           "notNull": true
247 |         },
248 |         "expires": {
249 |           "name": "expires",
250 |           "type": "timestamp",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "ipAddress": {
255 |           "name": "ipAddress",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "userAgent": {
261 |           "name": "userAgent",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": false
265 |         },
266 |         "createdAt": {
267 |           "name": "createdAt",
268 |           "type": "timestamp",
269 |           "primaryKey": false,
270 |           "notNull": true,
271 |           "default": "now()"
272 |         },
273 |         "updatedAt": {
274 |           "name": "updatedAt",
275 |           "type": "timestamp",
276 |           "primaryKey": false,
277 |           "notNull": true,
278 |           "default": "now()"
279 |         }
280 |       },
281 |       "indexes": {},
282 |       "foreignKeys": {
283 |         "session_userId_user_id_fk": {
284 |           "name": "session_userId_user_id_fk",
285 |           "tableFrom": "session",
286 |           "tableTo": "user",
287 |           "columnsFrom": [
288 |             "userId"
289 |           ],
290 |           "columnsTo": [
291 |             "id"
292 |           ],
293 |           "onDelete": "cascade",
294 |           "onUpdate": "no action"
295 |         }
296 |       },
297 |       "compositePrimaryKeys": {},
298 |       "uniqueConstraints": {
299 |         "session_sessionToken_unique": {
300 |           "name": "session_sessionToken_unique",
301 |           "nullsNotDistinct": false,
302 |           "columns": [
303 |             "sessionToken"
304 |           ]
305 |         }
306 |       },
307 |       "policies": {},
308 |       "checkConstraints": {},
309 |       "isRLSEnabled": false
310 |     },
311 |     "public.user": {
312 |       "name": "user",
313 |       "schema": "",
314 |       "columns": {
315 |         "id": {
316 |           "name": "id",
317 |           "type": "text",
318 |           "primaryKey": true,
319 |           "notNull": true
320 |         },
321 |         "name": {
322 |           "name": "name",
323 |           "type": "text",
324 |           "primaryKey": false,
325 |           "notNull": false
326 |         },
327 |         "email": {
328 |           "name": "email",
329 |           "type": "text",
330 |           "primaryKey": false,
331 |           "notNull": true
332 |         },
333 |         "emailVerified": {
334 |           "name": "emailVerified",
335 |           "type": "boolean",
336 |           "primaryKey": false,
337 |           "notNull": false
338 |         },
339 |         "image": {
340 |           "name": "image",
341 |           "type": "text",
342 |           "primaryKey": false,
343 |           "notNull": false
344 |         },
345 |         "createdAt": {
346 |           "name": "createdAt",
347 |           "type": "timestamp",
348 |           "primaryKey": false,
349 |           "notNull": true,
350 |           "default": "now()"
351 |         },
352 |         "updatedAt": {
353 |           "name": "updatedAt",
354 |           "type": "timestamp",
355 |           "primaryKey": false,
356 |           "notNull": true,
357 |           "default": "now()"
358 |         }
359 |       },
360 |       "indexes": {},
361 |       "foreignKeys": {},
362 |       "compositePrimaryKeys": {},
363 |       "uniqueConstraints": {
364 |         "user_email_unique": {
365 |           "name": "user_email_unique",
366 |           "nullsNotDistinct": false,
367 |           "columns": [
368 |             "email"
369 |           ]
370 |         }
371 |       },
372 |       "policies": {},
373 |       "checkConstraints": {},
374 |       "isRLSEnabled": false
375 |     },
376 |     "public.verification": {
377 |       "name": "verification",
378 |       "schema": "",
379 |       "columns": {
380 |         "id": {
381 |           "name": "id",
382 |           "type": "text",
383 |           "primaryKey": true,
384 |           "notNull": true
385 |         },
386 |         "identifier": {
387 |           "name": "identifier",
388 |           "type": "text",
389 |           "primaryKey": false,
390 |           "notNull": true
391 |         },
392 |         "value": {
393 |           "name": "value",
394 |           "type": "text",
395 |           "primaryKey": false,
396 |           "notNull": true
397 |         },
398 |         "expiresAt": {
399 |           "name": "expiresAt",
400 |           "type": "timestamp",
401 |           "primaryKey": false,
402 |           "notNull": true
403 |         },
404 |         "createdAt": {
405 |           "name": "createdAt",
406 |           "type": "timestamp",
407 |           "primaryKey": false,
408 |           "notNull": true,
409 |           "default": "now()"
410 |         },
411 |         "updatedAt": {
412 |           "name": "updatedAt",
413 |           "type": "timestamp",
414 |           "primaryKey": false,
415 |           "notNull": true,
416 |           "default": "now()"
417 |         }
418 |       },
419 |       "indexes": {},
420 |       "foreignKeys": {},
421 |       "compositePrimaryKeys": {},
422 |       "uniqueConstraints": {},
423 |       "policies": {},
424 |       "checkConstraints": {},
425 |       "isRLSEnabled": false
426 |     }
427 |   },
428 |   "enums": {},
429 |   "schemas": {},
430 |   "sequences": {},
431 |   "roles": {},
432 |   "policies": {},
433 |   "views": {},
434 |   "_meta": {
435 |     "columns": {},
436 |     "schemas": {},
437 |     "tables": {}
438 |   }
439 | }
```

drizzle/meta/0011_snapshot.json
```
1 | {
2 |   "id": "4ef58c27-a246-4ea7-ba8e-331168d0d555",
3 |   "prevId": "fdd5cf50-77dd-4cd6-ad47-24c0efb4c8e4",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": true
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "integer",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "created_at": {
195 |           "name": "created_at",
196 |           "type": "timestamp",
197 |           "primaryKey": false,
198 |           "notNull": true,
199 |           "default": "now()"
200 |         }
201 |       },
202 |       "indexes": {},
203 |       "foreignKeys": {
204 |         "messages_chat_id_chats_id_fk": {
205 |           "name": "messages_chat_id_chats_id_fk",
206 |           "tableFrom": "messages",
207 |           "tableTo": "chats",
208 |           "columnsFrom": [
209 |             "chat_id"
210 |           ],
211 |           "columnsTo": [
212 |             "id"
213 |           ],
214 |           "onDelete": "cascade",
215 |           "onUpdate": "no action"
216 |         }
217 |       },
218 |       "compositePrimaryKeys": {},
219 |       "uniqueConstraints": {},
220 |       "policies": {},
221 |       "checkConstraints": {},
222 |       "isRLSEnabled": false
223 |     },
224 |     "public.session": {
225 |       "name": "session",
226 |       "schema": "",
227 |       "columns": {
228 |         "id": {
229 |           "name": "id",
230 |           "type": "text",
231 |           "primaryKey": true,
232 |           "notNull": true
233 |         },
234 |         "sessionToken": {
235 |           "name": "sessionToken",
236 |           "type": "text",
237 |           "primaryKey": false,
238 |           "notNull": true
239 |         },
240 |         "userId": {
241 |           "name": "userId",
242 |           "type": "text",
243 |           "primaryKey": false,
244 |           "notNull": true
245 |         },
246 |         "expires": {
247 |           "name": "expires",
248 |           "type": "timestamp",
249 |           "primaryKey": false,
250 |           "notNull": true
251 |         },
252 |         "ipAddress": {
253 |           "name": "ipAddress",
254 |           "type": "text",
255 |           "primaryKey": false,
256 |           "notNull": false
257 |         },
258 |         "userAgent": {
259 |           "name": "userAgent",
260 |           "type": "text",
261 |           "primaryKey": false,
262 |           "notNull": false
263 |         },
264 |         "createdAt": {
265 |           "name": "createdAt",
266 |           "type": "timestamp",
267 |           "primaryKey": false,
268 |           "notNull": true,
269 |           "default": "now()"
270 |         },
271 |         "updatedAt": {
272 |           "name": "updatedAt",
273 |           "type": "timestamp",
274 |           "primaryKey": false,
275 |           "notNull": true,
276 |           "default": "now()"
277 |         }
278 |       },
279 |       "indexes": {},
280 |       "foreignKeys": {
281 |         "session_userId_user_id_fk": {
282 |           "name": "session_userId_user_id_fk",
283 |           "tableFrom": "session",
284 |           "tableTo": "user",
285 |           "columnsFrom": [
286 |             "userId"
287 |           ],
288 |           "columnsTo": [
289 |             "id"
290 |           ],
291 |           "onDelete": "cascade",
292 |           "onUpdate": "no action"
293 |         }
294 |       },
295 |       "compositePrimaryKeys": {},
296 |       "uniqueConstraints": {
297 |         "session_sessionToken_unique": {
298 |           "name": "session_sessionToken_unique",
299 |           "nullsNotDistinct": false,
300 |           "columns": [
301 |             "sessionToken"
302 |           ]
303 |         }
304 |       },
305 |       "policies": {},
306 |       "checkConstraints": {},
307 |       "isRLSEnabled": false
308 |     },
309 |     "public.user": {
310 |       "name": "user",
311 |       "schema": "",
312 |       "columns": {
313 |         "id": {
314 |           "name": "id",
315 |           "type": "text",
316 |           "primaryKey": true,
317 |           "notNull": true
318 |         },
319 |         "name": {
320 |           "name": "name",
321 |           "type": "text",
322 |           "primaryKey": false,
323 |           "notNull": false
324 |         },
325 |         "email": {
326 |           "name": "email",
327 |           "type": "text",
328 |           "primaryKey": false,
329 |           "notNull": true
330 |         },
331 |         "emailVerified": {
332 |           "name": "emailVerified",
333 |           "type": "boolean",
334 |           "primaryKey": false,
335 |           "notNull": false
336 |         },
337 |         "image": {
338 |           "name": "image",
339 |           "type": "text",
340 |           "primaryKey": false,
341 |           "notNull": false
342 |         },
343 |         "createdAt": {
344 |           "name": "createdAt",
345 |           "type": "timestamp",
346 |           "primaryKey": false,
347 |           "notNull": true,
348 |           "default": "now()"
349 |         },
350 |         "updatedAt": {
351 |           "name": "updatedAt",
352 |           "type": "timestamp",
353 |           "primaryKey": false,
354 |           "notNull": true,
355 |           "default": "now()"
356 |         }
357 |       },
358 |       "indexes": {},
359 |       "foreignKeys": {},
360 |       "compositePrimaryKeys": {},
361 |       "uniqueConstraints": {
362 |         "user_email_unique": {
363 |           "name": "user_email_unique",
364 |           "nullsNotDistinct": false,
365 |           "columns": [
366 |             "email"
367 |           ]
368 |         }
369 |       },
370 |       "policies": {},
371 |       "checkConstraints": {},
372 |       "isRLSEnabled": false
373 |     },
374 |     "public.verification": {
375 |       "name": "verification",
376 |       "schema": "",
377 |       "columns": {
378 |         "id": {
379 |           "name": "id",
380 |           "type": "text",
381 |           "primaryKey": true,
382 |           "notNull": true
383 |         },
384 |         "identifier": {
385 |           "name": "identifier",
386 |           "type": "text",
387 |           "primaryKey": false,
388 |           "notNull": true
389 |         },
390 |         "value": {
391 |           "name": "value",
392 |           "type": "text",
393 |           "primaryKey": false,
394 |           "notNull": true
395 |         },
396 |         "expiresAt": {
397 |           "name": "expiresAt",
398 |           "type": "timestamp",
399 |           "primaryKey": false,
400 |           "notNull": true
401 |         },
402 |         "createdAt": {
403 |           "name": "createdAt",
404 |           "type": "timestamp",
405 |           "primaryKey": false,
406 |           "notNull": true,
407 |           "default": "now()"
408 |         },
409 |         "updatedAt": {
410 |           "name": "updatedAt",
411 |           "type": "timestamp",
412 |           "primaryKey": false,
413 |           "notNull": true,
414 |           "default": "now()"
415 |         }
416 |       },
417 |       "indexes": {},
418 |       "foreignKeys": {},
419 |       "compositePrimaryKeys": {},
420 |       "uniqueConstraints": {},
421 |       "policies": {},
422 |       "checkConstraints": {},
423 |       "isRLSEnabled": false
424 |     }
425 |   },
426 |   "enums": {},
427 |   "schemas": {},
428 |   "sequences": {},
429 |   "roles": {},
430 |   "policies": {},
431 |   "views": {},
432 |   "_meta": {
433 |     "columns": {},
434 |     "schemas": {},
435 |     "tables": {}
436 |   }
437 | }
```

drizzle/meta/0012_snapshot.json
```
1 | {
2 |   "id": "6350274c-a300-465c-9e77-b7b8f0ea0621",
3 |   "prevId": "4ef58c27-a246-4ea7-ba8e-331168d0d555",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": true
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "created_at": {
195 |           "name": "created_at",
196 |           "type": "timestamp",
197 |           "primaryKey": false,
198 |           "notNull": true,
199 |           "default": "now()"
200 |         }
201 |       },
202 |       "indexes": {},
203 |       "foreignKeys": {
204 |         "messages_chat_id_chats_id_fk": {
205 |           "name": "messages_chat_id_chats_id_fk",
206 |           "tableFrom": "messages",
207 |           "tableTo": "chats",
208 |           "columnsFrom": [
209 |             "chat_id"
210 |           ],
211 |           "columnsTo": [
212 |             "id"
213 |           ],
214 |           "onDelete": "cascade",
215 |           "onUpdate": "no action"
216 |         }
217 |       },
218 |       "compositePrimaryKeys": {},
219 |       "uniqueConstraints": {},
220 |       "policies": {},
221 |       "checkConstraints": {},
222 |       "isRLSEnabled": false
223 |     },
224 |     "public.session": {
225 |       "name": "session",
226 |       "schema": "",
227 |       "columns": {
228 |         "id": {
229 |           "name": "id",
230 |           "type": "text",
231 |           "primaryKey": true,
232 |           "notNull": true
233 |         },
234 |         "sessionToken": {
235 |           "name": "sessionToken",
236 |           "type": "text",
237 |           "primaryKey": false,
238 |           "notNull": true
239 |         },
240 |         "userId": {
241 |           "name": "userId",
242 |           "type": "text",
243 |           "primaryKey": false,
244 |           "notNull": true
245 |         },
246 |         "expires": {
247 |           "name": "expires",
248 |           "type": "timestamp",
249 |           "primaryKey": false,
250 |           "notNull": true
251 |         },
252 |         "ipAddress": {
253 |           "name": "ipAddress",
254 |           "type": "text",
255 |           "primaryKey": false,
256 |           "notNull": false
257 |         },
258 |         "userAgent": {
259 |           "name": "userAgent",
260 |           "type": "text",
261 |           "primaryKey": false,
262 |           "notNull": false
263 |         },
264 |         "createdAt": {
265 |           "name": "createdAt",
266 |           "type": "timestamp",
267 |           "primaryKey": false,
268 |           "notNull": true,
269 |           "default": "now()"
270 |         },
271 |         "updatedAt": {
272 |           "name": "updatedAt",
273 |           "type": "timestamp",
274 |           "primaryKey": false,
275 |           "notNull": true,
276 |           "default": "now()"
277 |         }
278 |       },
279 |       "indexes": {},
280 |       "foreignKeys": {
281 |         "session_userId_user_id_fk": {
282 |           "name": "session_userId_user_id_fk",
283 |           "tableFrom": "session",
284 |           "tableTo": "user",
285 |           "columnsFrom": [
286 |             "userId"
287 |           ],
288 |           "columnsTo": [
289 |             "id"
290 |           ],
291 |           "onDelete": "cascade",
292 |           "onUpdate": "no action"
293 |         }
294 |       },
295 |       "compositePrimaryKeys": {},
296 |       "uniqueConstraints": {
297 |         "session_sessionToken_unique": {
298 |           "name": "session_sessionToken_unique",
299 |           "nullsNotDistinct": false,
300 |           "columns": [
301 |             "sessionToken"
302 |           ]
303 |         }
304 |       },
305 |       "policies": {},
306 |       "checkConstraints": {},
307 |       "isRLSEnabled": false
308 |     },
309 |     "public.user": {
310 |       "name": "user",
311 |       "schema": "",
312 |       "columns": {
313 |         "id": {
314 |           "name": "id",
315 |           "type": "text",
316 |           "primaryKey": true,
317 |           "notNull": true
318 |         },
319 |         "name": {
320 |           "name": "name",
321 |           "type": "text",
322 |           "primaryKey": false,
323 |           "notNull": false
324 |         },
325 |         "email": {
326 |           "name": "email",
327 |           "type": "text",
328 |           "primaryKey": false,
329 |           "notNull": true
330 |         },
331 |         "emailVerified": {
332 |           "name": "emailVerified",
333 |           "type": "boolean",
334 |           "primaryKey": false,
335 |           "notNull": false
336 |         },
337 |         "image": {
338 |           "name": "image",
339 |           "type": "text",
340 |           "primaryKey": false,
341 |           "notNull": false
342 |         },
343 |         "createdAt": {
344 |           "name": "createdAt",
345 |           "type": "timestamp",
346 |           "primaryKey": false,
347 |           "notNull": true,
348 |           "default": "now()"
349 |         },
350 |         "updatedAt": {
351 |           "name": "updatedAt",
352 |           "type": "timestamp",
353 |           "primaryKey": false,
354 |           "notNull": true,
355 |           "default": "now()"
356 |         }
357 |       },
358 |       "indexes": {},
359 |       "foreignKeys": {},
360 |       "compositePrimaryKeys": {},
361 |       "uniqueConstraints": {
362 |         "user_email_unique": {
363 |           "name": "user_email_unique",
364 |           "nullsNotDistinct": false,
365 |           "columns": [
366 |             "email"
367 |           ]
368 |         }
369 |       },
370 |       "policies": {},
371 |       "checkConstraints": {},
372 |       "isRLSEnabled": false
373 |     },
374 |     "public.verification": {
375 |       "name": "verification",
376 |       "schema": "",
377 |       "columns": {
378 |         "id": {
379 |           "name": "id",
380 |           "type": "text",
381 |           "primaryKey": true,
382 |           "notNull": true
383 |         },
384 |         "identifier": {
385 |           "name": "identifier",
386 |           "type": "text",
387 |           "primaryKey": false,
388 |           "notNull": true
389 |         },
390 |         "value": {
391 |           "name": "value",
392 |           "type": "text",
393 |           "primaryKey": false,
394 |           "notNull": true
395 |         },
396 |         "expiresAt": {
397 |           "name": "expiresAt",
398 |           "type": "timestamp",
399 |           "primaryKey": false,
400 |           "notNull": true
401 |         },
402 |         "createdAt": {
403 |           "name": "createdAt",
404 |           "type": "timestamp",
405 |           "primaryKey": false,
406 |           "notNull": true,
407 |           "default": "now()"
408 |         },
409 |         "updatedAt": {
410 |           "name": "updatedAt",
411 |           "type": "timestamp",
412 |           "primaryKey": false,
413 |           "notNull": true,
414 |           "default": "now()"
415 |         }
416 |       },
417 |       "indexes": {},
418 |       "foreignKeys": {},
419 |       "compositePrimaryKeys": {},
420 |       "uniqueConstraints": {},
421 |       "policies": {},
422 |       "checkConstraints": {},
423 |       "isRLSEnabled": false
424 |     }
425 |   },
426 |   "enums": {},
427 |   "schemas": {},
428 |   "sequences": {},
429 |   "roles": {},
430 |   "policies": {},
431 |   "views": {},
432 |   "_meta": {
433 |     "columns": {},
434 |     "schemas": {},
435 |     "tables": {}
436 |   }
437 | }
```

drizzle/meta/0013_snapshot.json
```
1 | {
2 |   "id": "4ef24ae6-b05a-4092-b1cb-82965b233c4e",
3 |   "prevId": "6350274c-a300-465c-9e77-b7b8f0ea0621",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "created_at": {
195 |           "name": "created_at",
196 |           "type": "timestamp",
197 |           "primaryKey": false,
198 |           "notNull": true,
199 |           "default": "now()"
200 |         }
201 |       },
202 |       "indexes": {},
203 |       "foreignKeys": {
204 |         "messages_chat_id_chats_id_fk": {
205 |           "name": "messages_chat_id_chats_id_fk",
206 |           "tableFrom": "messages",
207 |           "tableTo": "chats",
208 |           "columnsFrom": [
209 |             "chat_id"
210 |           ],
211 |           "columnsTo": [
212 |             "id"
213 |           ],
214 |           "onDelete": "cascade",
215 |           "onUpdate": "no action"
216 |         }
217 |       },
218 |       "compositePrimaryKeys": {},
219 |       "uniqueConstraints": {},
220 |       "policies": {},
221 |       "checkConstraints": {},
222 |       "isRLSEnabled": false
223 |     },
224 |     "public.session": {
225 |       "name": "session",
226 |       "schema": "",
227 |       "columns": {
228 |         "id": {
229 |           "name": "id",
230 |           "type": "text",
231 |           "primaryKey": true,
232 |           "notNull": true
233 |         },
234 |         "sessionToken": {
235 |           "name": "sessionToken",
236 |           "type": "text",
237 |           "primaryKey": false,
238 |           "notNull": true
239 |         },
240 |         "userId": {
241 |           "name": "userId",
242 |           "type": "text",
243 |           "primaryKey": false,
244 |           "notNull": true
245 |         },
246 |         "expires": {
247 |           "name": "expires",
248 |           "type": "timestamp",
249 |           "primaryKey": false,
250 |           "notNull": true
251 |         },
252 |         "ipAddress": {
253 |           "name": "ipAddress",
254 |           "type": "text",
255 |           "primaryKey": false,
256 |           "notNull": false
257 |         },
258 |         "userAgent": {
259 |           "name": "userAgent",
260 |           "type": "text",
261 |           "primaryKey": false,
262 |           "notNull": false
263 |         },
264 |         "createdAt": {
265 |           "name": "createdAt",
266 |           "type": "timestamp",
267 |           "primaryKey": false,
268 |           "notNull": true,
269 |           "default": "now()"
270 |         },
271 |         "updatedAt": {
272 |           "name": "updatedAt",
273 |           "type": "timestamp",
274 |           "primaryKey": false,
275 |           "notNull": true,
276 |           "default": "now()"
277 |         }
278 |       },
279 |       "indexes": {},
280 |       "foreignKeys": {
281 |         "session_userId_user_id_fk": {
282 |           "name": "session_userId_user_id_fk",
283 |           "tableFrom": "session",
284 |           "tableTo": "user",
285 |           "columnsFrom": [
286 |             "userId"
287 |           ],
288 |           "columnsTo": [
289 |             "id"
290 |           ],
291 |           "onDelete": "cascade",
292 |           "onUpdate": "no action"
293 |         }
294 |       },
295 |       "compositePrimaryKeys": {},
296 |       "uniqueConstraints": {
297 |         "session_sessionToken_unique": {
298 |           "name": "session_sessionToken_unique",
299 |           "nullsNotDistinct": false,
300 |           "columns": [
301 |             "sessionToken"
302 |           ]
303 |         }
304 |       },
305 |       "policies": {},
306 |       "checkConstraints": {},
307 |       "isRLSEnabled": false
308 |     },
309 |     "public.user": {
310 |       "name": "user",
311 |       "schema": "",
312 |       "columns": {
313 |         "id": {
314 |           "name": "id",
315 |           "type": "text",
316 |           "primaryKey": true,
317 |           "notNull": true
318 |         },
319 |         "name": {
320 |           "name": "name",
321 |           "type": "text",
322 |           "primaryKey": false,
323 |           "notNull": false
324 |         },
325 |         "email": {
326 |           "name": "email",
327 |           "type": "text",
328 |           "primaryKey": false,
329 |           "notNull": true
330 |         },
331 |         "emailVerified": {
332 |           "name": "emailVerified",
333 |           "type": "boolean",
334 |           "primaryKey": false,
335 |           "notNull": false
336 |         },
337 |         "image": {
338 |           "name": "image",
339 |           "type": "text",
340 |           "primaryKey": false,
341 |           "notNull": false
342 |         },
343 |         "createdAt": {
344 |           "name": "createdAt",
345 |           "type": "timestamp",
346 |           "primaryKey": false,
347 |           "notNull": true,
348 |           "default": "now()"
349 |         },
350 |         "updatedAt": {
351 |           "name": "updatedAt",
352 |           "type": "timestamp",
353 |           "primaryKey": false,
354 |           "notNull": true,
355 |           "default": "now()"
356 |         }
357 |       },
358 |       "indexes": {},
359 |       "foreignKeys": {},
360 |       "compositePrimaryKeys": {},
361 |       "uniqueConstraints": {
362 |         "user_email_unique": {
363 |           "name": "user_email_unique",
364 |           "nullsNotDistinct": false,
365 |           "columns": [
366 |             "email"
367 |           ]
368 |         }
369 |       },
370 |       "policies": {},
371 |       "checkConstraints": {},
372 |       "isRLSEnabled": false
373 |     },
374 |     "public.verification": {
375 |       "name": "verification",
376 |       "schema": "",
377 |       "columns": {
378 |         "id": {
379 |           "name": "id",
380 |           "type": "text",
381 |           "primaryKey": true,
382 |           "notNull": true
383 |         },
384 |         "identifier": {
385 |           "name": "identifier",
386 |           "type": "text",
387 |           "primaryKey": false,
388 |           "notNull": true
389 |         },
390 |         "value": {
391 |           "name": "value",
392 |           "type": "text",
393 |           "primaryKey": false,
394 |           "notNull": true
395 |         },
396 |         "expiresAt": {
397 |           "name": "expiresAt",
398 |           "type": "timestamp",
399 |           "primaryKey": false,
400 |           "notNull": true
401 |         },
402 |         "createdAt": {
403 |           "name": "createdAt",
404 |           "type": "timestamp",
405 |           "primaryKey": false,
406 |           "notNull": true,
407 |           "default": "now()"
408 |         },
409 |         "updatedAt": {
410 |           "name": "updatedAt",
411 |           "type": "timestamp",
412 |           "primaryKey": false,
413 |           "notNull": true,
414 |           "default": "now()"
415 |         }
416 |       },
417 |       "indexes": {},
418 |       "foreignKeys": {},
419 |       "compositePrimaryKeys": {},
420 |       "uniqueConstraints": {},
421 |       "policies": {},
422 |       "checkConstraints": {},
423 |       "isRLSEnabled": false
424 |     }
425 |   },
426 |   "enums": {},
427 |   "schemas": {},
428 |   "sequences": {},
429 |   "roles": {},
430 |   "policies": {},
431 |   "views": {},
432 |   "_meta": {
433 |     "columns": {},
434 |     "schemas": {},
435 |     "tables": {}
436 |   }
437 | }
```

drizzle/meta/0014_snapshot.json
```
1 | {
2 |   "id": "d2513b02-d436-451c-bb84-36298852a621",
3 |   "prevId": "4ef24ae6-b05a-4092-b1cb-82965b233c4e",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "created_at": {
195 |           "name": "created_at",
196 |           "type": "timestamp",
197 |           "primaryKey": false,
198 |           "notNull": true,
199 |           "default": "now()"
200 |         }
201 |       },
202 |       "indexes": {},
203 |       "foreignKeys": {
204 |         "messages_chat_id_chats_id_fk": {
205 |           "name": "messages_chat_id_chats_id_fk",
206 |           "tableFrom": "messages",
207 |           "tableTo": "chats",
208 |           "columnsFrom": [
209 |             "chat_id"
210 |           ],
211 |           "columnsTo": [
212 |             "id"
213 |           ],
214 |           "onDelete": "cascade",
215 |           "onUpdate": "no action"
216 |         }
217 |       },
218 |       "compositePrimaryKeys": {},
219 |       "uniqueConstraints": {},
220 |       "policies": {},
221 |       "checkConstraints": {},
222 |       "isRLSEnabled": false
223 |     },
224 |     "public.session": {
225 |       "name": "session",
226 |       "schema": "",
227 |       "columns": {
228 |         "id": {
229 |           "name": "id",
230 |           "type": "text",
231 |           "primaryKey": true,
232 |           "notNull": true
233 |         },
234 |         "sessionToken": {
235 |           "name": "sessionToken",
236 |           "type": "text",
237 |           "primaryKey": false,
238 |           "notNull": true
239 |         },
240 |         "userId": {
241 |           "name": "userId",
242 |           "type": "text",
243 |           "primaryKey": false,
244 |           "notNull": true
245 |         },
246 |         "expiresAt": {
247 |           "name": "expiresAt",
248 |           "type": "timestamp",
249 |           "primaryKey": false,
250 |           "notNull": true
251 |         },
252 |         "ipAddress": {
253 |           "name": "ipAddress",
254 |           "type": "text",
255 |           "primaryKey": false,
256 |           "notNull": false
257 |         },
258 |         "userAgent": {
259 |           "name": "userAgent",
260 |           "type": "text",
261 |           "primaryKey": false,
262 |           "notNull": false
263 |         },
264 |         "createdAt": {
265 |           "name": "createdAt",
266 |           "type": "timestamp",
267 |           "primaryKey": false,
268 |           "notNull": true,
269 |           "default": "now()"
270 |         },
271 |         "updatedAt": {
272 |           "name": "updatedAt",
273 |           "type": "timestamp",
274 |           "primaryKey": false,
275 |           "notNull": true,
276 |           "default": "now()"
277 |         }
278 |       },
279 |       "indexes": {},
280 |       "foreignKeys": {
281 |         "session_userId_user_id_fk": {
282 |           "name": "session_userId_user_id_fk",
283 |           "tableFrom": "session",
284 |           "tableTo": "user",
285 |           "columnsFrom": [
286 |             "userId"
287 |           ],
288 |           "columnsTo": [
289 |             "id"
290 |           ],
291 |           "onDelete": "cascade",
292 |           "onUpdate": "no action"
293 |         }
294 |       },
295 |       "compositePrimaryKeys": {},
296 |       "uniqueConstraints": {
297 |         "session_sessionToken_unique": {
298 |           "name": "session_sessionToken_unique",
299 |           "nullsNotDistinct": false,
300 |           "columns": [
301 |             "sessionToken"
302 |           ]
303 |         }
304 |       },
305 |       "policies": {},
306 |       "checkConstraints": {},
307 |       "isRLSEnabled": false
308 |     },
309 |     "public.user": {
310 |       "name": "user",
311 |       "schema": "",
312 |       "columns": {
313 |         "id": {
314 |           "name": "id",
315 |           "type": "text",
316 |           "primaryKey": true,
317 |           "notNull": true
318 |         },
319 |         "name": {
320 |           "name": "name",
321 |           "type": "text",
322 |           "primaryKey": false,
323 |           "notNull": false
324 |         },
325 |         "email": {
326 |           "name": "email",
327 |           "type": "text",
328 |           "primaryKey": false,
329 |           "notNull": true
330 |         },
331 |         "emailVerified": {
332 |           "name": "emailVerified",
333 |           "type": "boolean",
334 |           "primaryKey": false,
335 |           "notNull": false
336 |         },
337 |         "image": {
338 |           "name": "image",
339 |           "type": "text",
340 |           "primaryKey": false,
341 |           "notNull": false
342 |         },
343 |         "createdAt": {
344 |           "name": "createdAt",
345 |           "type": "timestamp",
346 |           "primaryKey": false,
347 |           "notNull": true,
348 |           "default": "now()"
349 |         },
350 |         "updatedAt": {
351 |           "name": "updatedAt",
352 |           "type": "timestamp",
353 |           "primaryKey": false,
354 |           "notNull": true,
355 |           "default": "now()"
356 |         }
357 |       },
358 |       "indexes": {},
359 |       "foreignKeys": {},
360 |       "compositePrimaryKeys": {},
361 |       "uniqueConstraints": {
362 |         "user_email_unique": {
363 |           "name": "user_email_unique",
364 |           "nullsNotDistinct": false,
365 |           "columns": [
366 |             "email"
367 |           ]
368 |         }
369 |       },
370 |       "policies": {},
371 |       "checkConstraints": {},
372 |       "isRLSEnabled": false
373 |     },
374 |     "public.verification": {
375 |       "name": "verification",
376 |       "schema": "",
377 |       "columns": {
378 |         "id": {
379 |           "name": "id",
380 |           "type": "text",
381 |           "primaryKey": true,
382 |           "notNull": true
383 |         },
384 |         "identifier": {
385 |           "name": "identifier",
386 |           "type": "text",
387 |           "primaryKey": false,
388 |           "notNull": true
389 |         },
390 |         "value": {
391 |           "name": "value",
392 |           "type": "text",
393 |           "primaryKey": false,
394 |           "notNull": true
395 |         },
396 |         "expiresAt": {
397 |           "name": "expiresAt",
398 |           "type": "timestamp",
399 |           "primaryKey": false,
400 |           "notNull": true
401 |         },
402 |         "createdAt": {
403 |           "name": "createdAt",
404 |           "type": "timestamp",
405 |           "primaryKey": false,
406 |           "notNull": true,
407 |           "default": "now()"
408 |         },
409 |         "updatedAt": {
410 |           "name": "updatedAt",
411 |           "type": "timestamp",
412 |           "primaryKey": false,
413 |           "notNull": true,
414 |           "default": "now()"
415 |         }
416 |       },
417 |       "indexes": {},
418 |       "foreignKeys": {},
419 |       "compositePrimaryKeys": {},
420 |       "uniqueConstraints": {},
421 |       "policies": {},
422 |       "checkConstraints": {},
423 |       "isRLSEnabled": false
424 |     }
425 |   },
426 |   "enums": {},
427 |   "schemas": {},
428 |   "sequences": {},
429 |   "roles": {},
430 |   "policies": {},
431 |   "views": {},
432 |   "_meta": {
433 |     "columns": {},
434 |     "schemas": {},
435 |     "tables": {}
436 |   }
437 | }
```

drizzle/meta/0015_snapshot.json
```
1 | {
2 |   "id": "2cd75274-edb9-4ed2-ae8e-ad0a5a73b276",
3 |   "prevId": "d2513b02-d436-451c-bb84-36298852a621",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "created_at": {
195 |           "name": "created_at",
196 |           "type": "timestamp",
197 |           "primaryKey": false,
198 |           "notNull": true,
199 |           "default": "now()"
200 |         }
201 |       },
202 |       "indexes": {},
203 |       "foreignKeys": {
204 |         "messages_chat_id_chats_id_fk": {
205 |           "name": "messages_chat_id_chats_id_fk",
206 |           "tableFrom": "messages",
207 |           "tableTo": "chats",
208 |           "columnsFrom": [
209 |             "chat_id"
210 |           ],
211 |           "columnsTo": [
212 |             "id"
213 |           ],
214 |           "onDelete": "cascade",
215 |           "onUpdate": "no action"
216 |         }
217 |       },
218 |       "compositePrimaryKeys": {},
219 |       "uniqueConstraints": {},
220 |       "policies": {},
221 |       "checkConstraints": {},
222 |       "isRLSEnabled": false
223 |     },
224 |     "public.session": {
225 |       "name": "session",
226 |       "schema": "",
227 |       "columns": {
228 |         "id": {
229 |           "name": "id",
230 |           "type": "text",
231 |           "primaryKey": true,
232 |           "notNull": true
233 |         },
234 |         "sessionToken": {
235 |           "name": "sessionToken",
236 |           "type": "text",
237 |           "primaryKey": false,
238 |           "notNull": true
239 |         },
240 |         "token": {
241 |           "name": "token",
242 |           "type": "text",
243 |           "primaryKey": false,
244 |           "notNull": true
245 |         },
246 |         "userId": {
247 |           "name": "userId",
248 |           "type": "text",
249 |           "primaryKey": false,
250 |           "notNull": true
251 |         },
252 |         "expiresAt": {
253 |           "name": "expiresAt",
254 |           "type": "timestamp",
255 |           "primaryKey": false,
256 |           "notNull": true
257 |         },
258 |         "ipAddress": {
259 |           "name": "ipAddress",
260 |           "type": "text",
261 |           "primaryKey": false,
262 |           "notNull": false
263 |         },
264 |         "userAgent": {
265 |           "name": "userAgent",
266 |           "type": "text",
267 |           "primaryKey": false,
268 |           "notNull": false
269 |         },
270 |         "createdAt": {
271 |           "name": "createdAt",
272 |           "type": "timestamp",
273 |           "primaryKey": false,
274 |           "notNull": true,
275 |           "default": "now()"
276 |         },
277 |         "updatedAt": {
278 |           "name": "updatedAt",
279 |           "type": "timestamp",
280 |           "primaryKey": false,
281 |           "notNull": true,
282 |           "default": "now()"
283 |         }
284 |       },
285 |       "indexes": {},
286 |       "foreignKeys": {
287 |         "session_userId_user_id_fk": {
288 |           "name": "session_userId_user_id_fk",
289 |           "tableFrom": "session",
290 |           "tableTo": "user",
291 |           "columnsFrom": [
292 |             "userId"
293 |           ],
294 |           "columnsTo": [
295 |             "id"
296 |           ],
297 |           "onDelete": "cascade",
298 |           "onUpdate": "no action"
299 |         }
300 |       },
301 |       "compositePrimaryKeys": {},
302 |       "uniqueConstraints": {
303 |         "session_sessionToken_unique": {
304 |           "name": "session_sessionToken_unique",
305 |           "nullsNotDistinct": false,
306 |           "columns": [
307 |             "sessionToken"
308 |           ]
309 |         }
310 |       },
311 |       "policies": {},
312 |       "checkConstraints": {},
313 |       "isRLSEnabled": false
314 |     },
315 |     "public.user": {
316 |       "name": "user",
317 |       "schema": "",
318 |       "columns": {
319 |         "id": {
320 |           "name": "id",
321 |           "type": "text",
322 |           "primaryKey": true,
323 |           "notNull": true
324 |         },
325 |         "name": {
326 |           "name": "name",
327 |           "type": "text",
328 |           "primaryKey": false,
329 |           "notNull": false
330 |         },
331 |         "email": {
332 |           "name": "email",
333 |           "type": "text",
334 |           "primaryKey": false,
335 |           "notNull": true
336 |         },
337 |         "emailVerified": {
338 |           "name": "emailVerified",
339 |           "type": "boolean",
340 |           "primaryKey": false,
341 |           "notNull": false
342 |         },
343 |         "image": {
344 |           "name": "image",
345 |           "type": "text",
346 |           "primaryKey": false,
347 |           "notNull": false
348 |         },
349 |         "createdAt": {
350 |           "name": "createdAt",
351 |           "type": "timestamp",
352 |           "primaryKey": false,
353 |           "notNull": true,
354 |           "default": "now()"
355 |         },
356 |         "updatedAt": {
357 |           "name": "updatedAt",
358 |           "type": "timestamp",
359 |           "primaryKey": false,
360 |           "notNull": true,
361 |           "default": "now()"
362 |         }
363 |       },
364 |       "indexes": {},
365 |       "foreignKeys": {},
366 |       "compositePrimaryKeys": {},
367 |       "uniqueConstraints": {
368 |         "user_email_unique": {
369 |           "name": "user_email_unique",
370 |           "nullsNotDistinct": false,
371 |           "columns": [
372 |             "email"
373 |           ]
374 |         }
375 |       },
376 |       "policies": {},
377 |       "checkConstraints": {},
378 |       "isRLSEnabled": false
379 |     },
380 |     "public.verification": {
381 |       "name": "verification",
382 |       "schema": "",
383 |       "columns": {
384 |         "id": {
385 |           "name": "id",
386 |           "type": "text",
387 |           "primaryKey": true,
388 |           "notNull": true
389 |         },
390 |         "identifier": {
391 |           "name": "identifier",
392 |           "type": "text",
393 |           "primaryKey": false,
394 |           "notNull": true
395 |         },
396 |         "value": {
397 |           "name": "value",
398 |           "type": "text",
399 |           "primaryKey": false,
400 |           "notNull": true
401 |         },
402 |         "expiresAt": {
403 |           "name": "expiresAt",
404 |           "type": "timestamp",
405 |           "primaryKey": false,
406 |           "notNull": true
407 |         },
408 |         "createdAt": {
409 |           "name": "createdAt",
410 |           "type": "timestamp",
411 |           "primaryKey": false,
412 |           "notNull": true,
413 |           "default": "now()"
414 |         },
415 |         "updatedAt": {
416 |           "name": "updatedAt",
417 |           "type": "timestamp",
418 |           "primaryKey": false,
419 |           "notNull": true,
420 |           "default": "now()"
421 |         }
422 |       },
423 |       "indexes": {},
424 |       "foreignKeys": {},
425 |       "compositePrimaryKeys": {},
426 |       "uniqueConstraints": {},
427 |       "policies": {},
428 |       "checkConstraints": {},
429 |       "isRLSEnabled": false
430 |     }
431 |   },
432 |   "enums": {},
433 |   "schemas": {},
434 |   "sequences": {},
435 |   "roles": {},
436 |   "policies": {},
437 |   "views": {},
438 |   "_meta": {
439 |     "columns": {},
440 |     "schemas": {},
441 |     "tables": {}
442 |   }
443 | }
```

drizzle/meta/0016_snapshot.json
```
1 | {
2 |   "id": "da03ebe3-30b6-465a-bb23-18f70f0e8cb2",
3 |   "prevId": "2cd75274-edb9-4ed2-ae8e-ad0a5a73b276",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "created_at": {
195 |           "name": "created_at",
196 |           "type": "timestamp",
197 |           "primaryKey": false,
198 |           "notNull": true,
199 |           "default": "now()"
200 |         }
201 |       },
202 |       "indexes": {},
203 |       "foreignKeys": {
204 |         "messages_chat_id_chats_id_fk": {
205 |           "name": "messages_chat_id_chats_id_fk",
206 |           "tableFrom": "messages",
207 |           "tableTo": "chats",
208 |           "columnsFrom": [
209 |             "chat_id"
210 |           ],
211 |           "columnsTo": [
212 |             "id"
213 |           ],
214 |           "onDelete": "cascade",
215 |           "onUpdate": "no action"
216 |         }
217 |       },
218 |       "compositePrimaryKeys": {},
219 |       "uniqueConstraints": {},
220 |       "policies": {},
221 |       "checkConstraints": {},
222 |       "isRLSEnabled": false
223 |     },
224 |     "public.session": {
225 |       "name": "session",
226 |       "schema": "",
227 |       "columns": {
228 |         "id": {
229 |           "name": "id",
230 |           "type": "text",
231 |           "primaryKey": true,
232 |           "notNull": true
233 |         },
234 |         "sessionToken": {
235 |           "name": "sessionToken",
236 |           "type": "text",
237 |           "primaryKey": false,
238 |           "notNull": true
239 |         },
240 |         "userId": {
241 |           "name": "userId",
242 |           "type": "text",
243 |           "primaryKey": false,
244 |           "notNull": true
245 |         },
246 |         "expiresAt": {
247 |           "name": "expiresAt",
248 |           "type": "timestamp",
249 |           "primaryKey": false,
250 |           "notNull": true
251 |         },
252 |         "ipAddress": {
253 |           "name": "ipAddress",
254 |           "type": "text",
255 |           "primaryKey": false,
256 |           "notNull": false
257 |         },
258 |         "userAgent": {
259 |           "name": "userAgent",
260 |           "type": "text",
261 |           "primaryKey": false,
262 |           "notNull": false
263 |         },
264 |         "createdAt": {
265 |           "name": "createdAt",
266 |           "type": "timestamp",
267 |           "primaryKey": false,
268 |           "notNull": true,
269 |           "default": "now()"
270 |         },
271 |         "updatedAt": {
272 |           "name": "updatedAt",
273 |           "type": "timestamp",
274 |           "primaryKey": false,
275 |           "notNull": true,
276 |           "default": "now()"
277 |         }
278 |       },
279 |       "indexes": {},
280 |       "foreignKeys": {
281 |         "session_userId_user_id_fk": {
282 |           "name": "session_userId_user_id_fk",
283 |           "tableFrom": "session",
284 |           "tableTo": "user",
285 |           "columnsFrom": [
286 |             "userId"
287 |           ],
288 |           "columnsTo": [
289 |             "id"
290 |           ],
291 |           "onDelete": "cascade",
292 |           "onUpdate": "no action"
293 |         }
294 |       },
295 |       "compositePrimaryKeys": {},
296 |       "uniqueConstraints": {
297 |         "session_sessionToken_unique": {
298 |           "name": "session_sessionToken_unique",
299 |           "nullsNotDistinct": false,
300 |           "columns": [
301 |             "sessionToken"
302 |           ]
303 |         }
304 |       },
305 |       "policies": {},
306 |       "checkConstraints": {},
307 |       "isRLSEnabled": false
308 |     },
309 |     "public.user": {
310 |       "name": "user",
311 |       "schema": "",
312 |       "columns": {
313 |         "id": {
314 |           "name": "id",
315 |           "type": "text",
316 |           "primaryKey": true,
317 |           "notNull": true
318 |         },
319 |         "name": {
320 |           "name": "name",
321 |           "type": "text",
322 |           "primaryKey": false,
323 |           "notNull": false
324 |         },
325 |         "email": {
326 |           "name": "email",
327 |           "type": "text",
328 |           "primaryKey": false,
329 |           "notNull": true
330 |         },
331 |         "emailVerified": {
332 |           "name": "emailVerified",
333 |           "type": "boolean",
334 |           "primaryKey": false,
335 |           "notNull": false
336 |         },
337 |         "image": {
338 |           "name": "image",
339 |           "type": "text",
340 |           "primaryKey": false,
341 |           "notNull": false
342 |         },
343 |         "createdAt": {
344 |           "name": "createdAt",
345 |           "type": "timestamp",
346 |           "primaryKey": false,
347 |           "notNull": true,
348 |           "default": "now()"
349 |         },
350 |         "updatedAt": {
351 |           "name": "updatedAt",
352 |           "type": "timestamp",
353 |           "primaryKey": false,
354 |           "notNull": true,
355 |           "default": "now()"
356 |         }
357 |       },
358 |       "indexes": {},
359 |       "foreignKeys": {},
360 |       "compositePrimaryKeys": {},
361 |       "uniqueConstraints": {
362 |         "user_email_unique": {
363 |           "name": "user_email_unique",
364 |           "nullsNotDistinct": false,
365 |           "columns": [
366 |             "email"
367 |           ]
368 |         }
369 |       },
370 |       "policies": {},
371 |       "checkConstraints": {},
372 |       "isRLSEnabled": false
373 |     },
374 |     "public.verification": {
375 |       "name": "verification",
376 |       "schema": "",
377 |       "columns": {
378 |         "id": {
379 |           "name": "id",
380 |           "type": "text",
381 |           "primaryKey": true,
382 |           "notNull": true
383 |         },
384 |         "identifier": {
385 |           "name": "identifier",
386 |           "type": "text",
387 |           "primaryKey": false,
388 |           "notNull": true
389 |         },
390 |         "value": {
391 |           "name": "value",
392 |           "type": "text",
393 |           "primaryKey": false,
394 |           "notNull": true
395 |         },
396 |         "expiresAt": {
397 |           "name": "expiresAt",
398 |           "type": "timestamp",
399 |           "primaryKey": false,
400 |           "notNull": true
401 |         },
402 |         "createdAt": {
403 |           "name": "createdAt",
404 |           "type": "timestamp",
405 |           "primaryKey": false,
406 |           "notNull": true,
407 |           "default": "now()"
408 |         },
409 |         "updatedAt": {
410 |           "name": "updatedAt",
411 |           "type": "timestamp",
412 |           "primaryKey": false,
413 |           "notNull": true,
414 |           "default": "now()"
415 |         }
416 |       },
417 |       "indexes": {},
418 |       "foreignKeys": {},
419 |       "compositePrimaryKeys": {},
420 |       "uniqueConstraints": {},
421 |       "policies": {},
422 |       "checkConstraints": {},
423 |       "isRLSEnabled": false
424 |     }
425 |   },
426 |   "enums": {},
427 |   "schemas": {},
428 |   "sequences": {},
429 |   "roles": {},
430 |   "policies": {},
431 |   "views": {},
432 |   "_meta": {
433 |     "columns": {},
434 |     "schemas": {},
435 |     "tables": {}
436 |   }
437 | }
```

drizzle/meta/0017_snapshot.json
```
1 | {
2 |   "id": "61e759b3-9bac-47fe-9476-3811e7d3cb98",
3 |   "prevId": "da03ebe3-30b6-465a-bb23-18f70f0e8cb2",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "has_web_search": {
195 |           "name": "has_web_search",
196 |           "type": "boolean",
197 |           "primaryKey": false,
198 |           "notNull": false,
199 |           "default": false
200 |         },
201 |         "web_search_context_size": {
202 |           "name": "web_search_context_size",
203 |           "type": "text",
204 |           "primaryKey": false,
205 |           "notNull": false,
206 |           "default": "'medium'"
207 |         },
208 |         "created_at": {
209 |           "name": "created_at",
210 |           "type": "timestamp",
211 |           "primaryKey": false,
212 |           "notNull": true,
213 |           "default": "now()"
214 |         }
215 |       },
216 |       "indexes": {},
217 |       "foreignKeys": {
218 |         "messages_chat_id_chats_id_fk": {
219 |           "name": "messages_chat_id_chats_id_fk",
220 |           "tableFrom": "messages",
221 |           "tableTo": "chats",
222 |           "columnsFrom": [
223 |             "chat_id"
224 |           ],
225 |           "columnsTo": [
226 |             "id"
227 |           ],
228 |           "onDelete": "cascade",
229 |           "onUpdate": "no action"
230 |         }
231 |       },
232 |       "compositePrimaryKeys": {},
233 |       "uniqueConstraints": {},
234 |       "policies": {},
235 |       "checkConstraints": {},
236 |       "isRLSEnabled": false
237 |     },
238 |     "public.session": {
239 |       "name": "session",
240 |       "schema": "",
241 |       "columns": {
242 |         "id": {
243 |           "name": "id",
244 |           "type": "text",
245 |           "primaryKey": true,
246 |           "notNull": true
247 |         },
248 |         "sessionToken": {
249 |           "name": "sessionToken",
250 |           "type": "text",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "userId": {
255 |           "name": "userId",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": true
259 |         },
260 |         "expiresAt": {
261 |           "name": "expiresAt",
262 |           "type": "timestamp",
263 |           "primaryKey": false,
264 |           "notNull": true
265 |         },
266 |         "ipAddress": {
267 |           "name": "ipAddress",
268 |           "type": "text",
269 |           "primaryKey": false,
270 |           "notNull": false
271 |         },
272 |         "userAgent": {
273 |           "name": "userAgent",
274 |           "type": "text",
275 |           "primaryKey": false,
276 |           "notNull": false
277 |         },
278 |         "createdAt": {
279 |           "name": "createdAt",
280 |           "type": "timestamp",
281 |           "primaryKey": false,
282 |           "notNull": true,
283 |           "default": "now()"
284 |         },
285 |         "updatedAt": {
286 |           "name": "updatedAt",
287 |           "type": "timestamp",
288 |           "primaryKey": false,
289 |           "notNull": true,
290 |           "default": "now()"
291 |         }
292 |       },
293 |       "indexes": {},
294 |       "foreignKeys": {
295 |         "session_userId_user_id_fk": {
296 |           "name": "session_userId_user_id_fk",
297 |           "tableFrom": "session",
298 |           "tableTo": "user",
299 |           "columnsFrom": [
300 |             "userId"
301 |           ],
302 |           "columnsTo": [
303 |             "id"
304 |           ],
305 |           "onDelete": "cascade",
306 |           "onUpdate": "no action"
307 |         }
308 |       },
309 |       "compositePrimaryKeys": {},
310 |       "uniqueConstraints": {
311 |         "session_sessionToken_unique": {
312 |           "name": "session_sessionToken_unique",
313 |           "nullsNotDistinct": false,
314 |           "columns": [
315 |             "sessionToken"
316 |           ]
317 |         }
318 |       },
319 |       "policies": {},
320 |       "checkConstraints": {},
321 |       "isRLSEnabled": false
322 |     },
323 |     "public.user": {
324 |       "name": "user",
325 |       "schema": "",
326 |       "columns": {
327 |         "id": {
328 |           "name": "id",
329 |           "type": "text",
330 |           "primaryKey": true,
331 |           "notNull": true
332 |         },
333 |         "name": {
334 |           "name": "name",
335 |           "type": "text",
336 |           "primaryKey": false,
337 |           "notNull": false
338 |         },
339 |         "email": {
340 |           "name": "email",
341 |           "type": "text",
342 |           "primaryKey": false,
343 |           "notNull": true
344 |         },
345 |         "emailVerified": {
346 |           "name": "emailVerified",
347 |           "type": "boolean",
348 |           "primaryKey": false,
349 |           "notNull": false
350 |         },
351 |         "image": {
352 |           "name": "image",
353 |           "type": "text",
354 |           "primaryKey": false,
355 |           "notNull": false
356 |         },
357 |         "createdAt": {
358 |           "name": "createdAt",
359 |           "type": "timestamp",
360 |           "primaryKey": false,
361 |           "notNull": true,
362 |           "default": "now()"
363 |         },
364 |         "updatedAt": {
365 |           "name": "updatedAt",
366 |           "type": "timestamp",
367 |           "primaryKey": false,
368 |           "notNull": true,
369 |           "default": "now()"
370 |         }
371 |       },
372 |       "indexes": {},
373 |       "foreignKeys": {},
374 |       "compositePrimaryKeys": {},
375 |       "uniqueConstraints": {
376 |         "user_email_unique": {
377 |           "name": "user_email_unique",
378 |           "nullsNotDistinct": false,
379 |           "columns": [
380 |             "email"
381 |           ]
382 |         }
383 |       },
384 |       "policies": {},
385 |       "checkConstraints": {},
386 |       "isRLSEnabled": false
387 |     },
388 |     "public.verification": {
389 |       "name": "verification",
390 |       "schema": "",
391 |       "columns": {
392 |         "id": {
393 |           "name": "id",
394 |           "type": "text",
395 |           "primaryKey": true,
396 |           "notNull": true
397 |         },
398 |         "identifier": {
399 |           "name": "identifier",
400 |           "type": "text",
401 |           "primaryKey": false,
402 |           "notNull": true
403 |         },
404 |         "value": {
405 |           "name": "value",
406 |           "type": "text",
407 |           "primaryKey": false,
408 |           "notNull": true
409 |         },
410 |         "expiresAt": {
411 |           "name": "expiresAt",
412 |           "type": "timestamp",
413 |           "primaryKey": false,
414 |           "notNull": true
415 |         },
416 |         "createdAt": {
417 |           "name": "createdAt",
418 |           "type": "timestamp",
419 |           "primaryKey": false,
420 |           "notNull": true,
421 |           "default": "now()"
422 |         },
423 |         "updatedAt": {
424 |           "name": "updatedAt",
425 |           "type": "timestamp",
426 |           "primaryKey": false,
427 |           "notNull": true,
428 |           "default": "now()"
429 |         }
430 |       },
431 |       "indexes": {},
432 |       "foreignKeys": {},
433 |       "compositePrimaryKeys": {},
434 |       "uniqueConstraints": {},
435 |       "policies": {},
436 |       "checkConstraints": {},
437 |       "isRLSEnabled": false
438 |     }
439 |   },
440 |   "enums": {},
441 |   "schemas": {},
442 |   "sequences": {},
443 |   "roles": {},
444 |   "policies": {},
445 |   "views": {},
446 |   "_meta": {
447 |     "columns": {},
448 |     "schemas": {},
449 |     "tables": {}
450 |   }
451 | }
```

drizzle/meta/0018_snapshot.json
```
1 | {
2 |   "id": "c741bfd3-0d05-404f-9322-fc979c372bbd",
3 |   "prevId": "61e759b3-9bac-47fe-9476-3811e7d3cb98",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "has_web_search": {
195 |           "name": "has_web_search",
196 |           "type": "boolean",
197 |           "primaryKey": false,
198 |           "notNull": false,
199 |           "default": false
200 |         },
201 |         "web_search_context_size": {
202 |           "name": "web_search_context_size",
203 |           "type": "text",
204 |           "primaryKey": false,
205 |           "notNull": false,
206 |           "default": "'medium'"
207 |         },
208 |         "created_at": {
209 |           "name": "created_at",
210 |           "type": "timestamp",
211 |           "primaryKey": false,
212 |           "notNull": true,
213 |           "default": "now()"
214 |         }
215 |       },
216 |       "indexes": {},
217 |       "foreignKeys": {
218 |         "messages_chat_id_chats_id_fk": {
219 |           "name": "messages_chat_id_chats_id_fk",
220 |           "tableFrom": "messages",
221 |           "tableTo": "chats",
222 |           "columnsFrom": [
223 |             "chat_id"
224 |           ],
225 |           "columnsTo": [
226 |             "id"
227 |           ],
228 |           "onDelete": "cascade",
229 |           "onUpdate": "no action"
230 |         }
231 |       },
232 |       "compositePrimaryKeys": {},
233 |       "uniqueConstraints": {},
234 |       "policies": {},
235 |       "checkConstraints": {},
236 |       "isRLSEnabled": false
237 |     },
238 |     "public.polar_usage_events": {
239 |       "name": "polar_usage_events",
240 |       "schema": "",
241 |       "columns": {
242 |         "id": {
243 |           "name": "id",
244 |           "type": "text",
245 |           "primaryKey": true,
246 |           "notNull": true
247 |         },
248 |         "user_id": {
249 |           "name": "user_id",
250 |           "type": "text",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "polar_customer_id": {
255 |           "name": "polar_customer_id",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "event_name": {
261 |           "name": "event_name",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": true
265 |         },
266 |         "event_payload": {
267 |           "name": "event_payload",
268 |           "type": "json",
269 |           "primaryKey": false,
270 |           "notNull": true
271 |         },
272 |         "created_at": {
273 |           "name": "created_at",
274 |           "type": "timestamp",
275 |           "primaryKey": false,
276 |           "notNull": true,
277 |           "default": "now()"
278 |         }
279 |       },
280 |       "indexes": {},
281 |       "foreignKeys": {
282 |         "polar_usage_events_user_id_user_id_fk": {
283 |           "name": "polar_usage_events_user_id_user_id_fk",
284 |           "tableFrom": "polar_usage_events",
285 |           "tableTo": "user",
286 |           "columnsFrom": [
287 |             "user_id"
288 |           ],
289 |           "columnsTo": [
290 |             "id"
291 |           ],
292 |           "onDelete": "cascade",
293 |           "onUpdate": "no action"
294 |         }
295 |       },
296 |       "compositePrimaryKeys": {},
297 |       "uniqueConstraints": {},
298 |       "policies": {},
299 |       "checkConstraints": {},
300 |       "isRLSEnabled": false
301 |     },
302 |     "public.session": {
303 |       "name": "session",
304 |       "schema": "",
305 |       "columns": {
306 |         "id": {
307 |           "name": "id",
308 |           "type": "text",
309 |           "primaryKey": true,
310 |           "notNull": true
311 |         },
312 |         "sessionToken": {
313 |           "name": "sessionToken",
314 |           "type": "text",
315 |           "primaryKey": false,
316 |           "notNull": true
317 |         },
318 |         "userId": {
319 |           "name": "userId",
320 |           "type": "text",
321 |           "primaryKey": false,
322 |           "notNull": true
323 |         },
324 |         "expiresAt": {
325 |           "name": "expiresAt",
326 |           "type": "timestamp",
327 |           "primaryKey": false,
328 |           "notNull": true
329 |         },
330 |         "ipAddress": {
331 |           "name": "ipAddress",
332 |           "type": "text",
333 |           "primaryKey": false,
334 |           "notNull": false
335 |         },
336 |         "userAgent": {
337 |           "name": "userAgent",
338 |           "type": "text",
339 |           "primaryKey": false,
340 |           "notNull": false
341 |         },
342 |         "createdAt": {
343 |           "name": "createdAt",
344 |           "type": "timestamp",
345 |           "primaryKey": false,
346 |           "notNull": true,
347 |           "default": "now()"
348 |         },
349 |         "updatedAt": {
350 |           "name": "updatedAt",
351 |           "type": "timestamp",
352 |           "primaryKey": false,
353 |           "notNull": true,
354 |           "default": "now()"
355 |         }
356 |       },
357 |       "indexes": {},
358 |       "foreignKeys": {
359 |         "session_userId_user_id_fk": {
360 |           "name": "session_userId_user_id_fk",
361 |           "tableFrom": "session",
362 |           "tableTo": "user",
363 |           "columnsFrom": [
364 |             "userId"
365 |           ],
366 |           "columnsTo": [
367 |             "id"
368 |           ],
369 |           "onDelete": "cascade",
370 |           "onUpdate": "no action"
371 |         }
372 |       },
373 |       "compositePrimaryKeys": {},
374 |       "uniqueConstraints": {
375 |         "session_sessionToken_unique": {
376 |           "name": "session_sessionToken_unique",
377 |           "nullsNotDistinct": false,
378 |           "columns": [
379 |             "sessionToken"
380 |           ]
381 |         }
382 |       },
383 |       "policies": {},
384 |       "checkConstraints": {},
385 |       "isRLSEnabled": false
386 |     },
387 |     "public.user": {
388 |       "name": "user",
389 |       "schema": "",
390 |       "columns": {
391 |         "id": {
392 |           "name": "id",
393 |           "type": "text",
394 |           "primaryKey": true,
395 |           "notNull": true
396 |         },
397 |         "name": {
398 |           "name": "name",
399 |           "type": "text",
400 |           "primaryKey": false,
401 |           "notNull": false
402 |         },
403 |         "email": {
404 |           "name": "email",
405 |           "type": "text",
406 |           "primaryKey": false,
407 |           "notNull": true
408 |         },
409 |         "emailVerified": {
410 |           "name": "emailVerified",
411 |           "type": "boolean",
412 |           "primaryKey": false,
413 |           "notNull": false
414 |         },
415 |         "image": {
416 |           "name": "image",
417 |           "type": "text",
418 |           "primaryKey": false,
419 |           "notNull": false
420 |         },
421 |         "createdAt": {
422 |           "name": "createdAt",
423 |           "type": "timestamp",
424 |           "primaryKey": false,
425 |           "notNull": true,
426 |           "default": "now()"
427 |         },
428 |         "updatedAt": {
429 |           "name": "updatedAt",
430 |           "type": "timestamp",
431 |           "primaryKey": false,
432 |           "notNull": true,
433 |           "default": "now()"
434 |         }
435 |       },
436 |       "indexes": {},
437 |       "foreignKeys": {},
438 |       "compositePrimaryKeys": {},
439 |       "uniqueConstraints": {
440 |         "user_email_unique": {
441 |           "name": "user_email_unique",
442 |           "nullsNotDistinct": false,
443 |           "columns": [
444 |             "email"
445 |           ]
446 |         }
447 |       },
448 |       "policies": {},
449 |       "checkConstraints": {},
450 |       "isRLSEnabled": false
451 |     },
452 |     "public.verification": {
453 |       "name": "verification",
454 |       "schema": "",
455 |       "columns": {
456 |         "id": {
457 |           "name": "id",
458 |           "type": "text",
459 |           "primaryKey": true,
460 |           "notNull": true
461 |         },
462 |         "identifier": {
463 |           "name": "identifier",
464 |           "type": "text",
465 |           "primaryKey": false,
466 |           "notNull": true
467 |         },
468 |         "value": {
469 |           "name": "value",
470 |           "type": "text",
471 |           "primaryKey": false,
472 |           "notNull": true
473 |         },
474 |         "expiresAt": {
475 |           "name": "expiresAt",
476 |           "type": "timestamp",
477 |           "primaryKey": false,
478 |           "notNull": true
479 |         },
480 |         "createdAt": {
481 |           "name": "createdAt",
482 |           "type": "timestamp",
483 |           "primaryKey": false,
484 |           "notNull": true,
485 |           "default": "now()"
486 |         },
487 |         "updatedAt": {
488 |           "name": "updatedAt",
489 |           "type": "timestamp",
490 |           "primaryKey": false,
491 |           "notNull": true,
492 |           "default": "now()"
493 |         }
494 |       },
495 |       "indexes": {},
496 |       "foreignKeys": {},
497 |       "compositePrimaryKeys": {},
498 |       "uniqueConstraints": {},
499 |       "policies": {},
500 |       "checkConstraints": {},
501 |       "isRLSEnabled": false
502 |     }
503 |   },
504 |   "enums": {},
505 |   "schemas": {},
506 |   "sequences": {},
507 |   "roles": {},
508 |   "policies": {},
509 |   "views": {},
510 |   "_meta": {
511 |     "columns": {},
512 |     "schemas": {},
513 |     "tables": {}
514 |   }
515 | }
```

drizzle/meta/0020_snapshot.json
```
1 | {
2 |   "id": "28459e0c-5ff3-4a49-b3f8-7c8e1c3c1ccd",
3 |   "prevId": "c741bfd3-0d05-404f-9322-fc979c372bbd",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "has_web_search": {
195 |           "name": "has_web_search",
196 |           "type": "boolean",
197 |           "primaryKey": false,
198 |           "notNull": false,
199 |           "default": false
200 |         },
201 |         "web_search_context_size": {
202 |           "name": "web_search_context_size",
203 |           "type": "text",
204 |           "primaryKey": false,
205 |           "notNull": false,
206 |           "default": "'medium'"
207 |         },
208 |         "created_at": {
209 |           "name": "created_at",
210 |           "type": "timestamp",
211 |           "primaryKey": false,
212 |           "notNull": true,
213 |           "default": "now()"
214 |         }
215 |       },
216 |       "indexes": {},
217 |       "foreignKeys": {
218 |         "messages_chat_id_chats_id_fk": {
219 |           "name": "messages_chat_id_chats_id_fk",
220 |           "tableFrom": "messages",
221 |           "tableTo": "chats",
222 |           "columnsFrom": [
223 |             "chat_id"
224 |           ],
225 |           "columnsTo": [
226 |             "id"
227 |           ],
228 |           "onDelete": "cascade",
229 |           "onUpdate": "no action"
230 |         }
231 |       },
232 |       "compositePrimaryKeys": {},
233 |       "uniqueConstraints": {},
234 |       "policies": {},
235 |       "checkConstraints": {},
236 |       "isRLSEnabled": false
237 |     },
238 |     "public.polar_usage_events": {
239 |       "name": "polar_usage_events",
240 |       "schema": "",
241 |       "columns": {
242 |         "id": {
243 |           "name": "id",
244 |           "type": "text",
245 |           "primaryKey": true,
246 |           "notNull": true
247 |         },
248 |         "user_id": {
249 |           "name": "user_id",
250 |           "type": "text",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "polar_customer_id": {
255 |           "name": "polar_customer_id",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "event_name": {
261 |           "name": "event_name",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": true
265 |         },
266 |         "event_payload": {
267 |           "name": "event_payload",
268 |           "type": "json",
269 |           "primaryKey": false,
270 |           "notNull": true
271 |         },
272 |         "created_at": {
273 |           "name": "created_at",
274 |           "type": "timestamp",
275 |           "primaryKey": false,
276 |           "notNull": true,
277 |           "default": "now()"
278 |         }
279 |       },
280 |       "indexes": {},
281 |       "foreignKeys": {
282 |         "polar_usage_events_user_id_user_id_fk": {
283 |           "name": "polar_usage_events_user_id_user_id_fk",
284 |           "tableFrom": "polar_usage_events",
285 |           "tableTo": "user",
286 |           "columnsFrom": [
287 |             "user_id"
288 |           ],
289 |           "columnsTo": [
290 |             "id"
291 |           ],
292 |           "onDelete": "cascade",
293 |           "onUpdate": "no action"
294 |         }
295 |       },
296 |       "compositePrimaryKeys": {},
297 |       "uniqueConstraints": {},
298 |       "policies": {},
299 |       "checkConstraints": {},
300 |       "isRLSEnabled": false
301 |     },
302 |     "public.session": {
303 |       "name": "session",
304 |       "schema": "",
305 |       "columns": {
306 |         "id": {
307 |           "name": "id",
308 |           "type": "text",
309 |           "primaryKey": true,
310 |           "notNull": true
311 |         },
312 |         "sessionToken": {
313 |           "name": "sessionToken",
314 |           "type": "text",
315 |           "primaryKey": false,
316 |           "notNull": true
317 |         },
318 |         "userId": {
319 |           "name": "userId",
320 |           "type": "text",
321 |           "primaryKey": false,
322 |           "notNull": true
323 |         },
324 |         "expiresAt": {
325 |           "name": "expiresAt",
326 |           "type": "timestamp",
327 |           "primaryKey": false,
328 |           "notNull": true
329 |         },
330 |         "ipAddress": {
331 |           "name": "ipAddress",
332 |           "type": "text",
333 |           "primaryKey": false,
334 |           "notNull": false
335 |         },
336 |         "userAgent": {
337 |           "name": "userAgent",
338 |           "type": "text",
339 |           "primaryKey": false,
340 |           "notNull": false
341 |         },
342 |         "createdAt": {
343 |           "name": "createdAt",
344 |           "type": "timestamp",
345 |           "primaryKey": false,
346 |           "notNull": true,
347 |           "default": "now()"
348 |         },
349 |         "updatedAt": {
350 |           "name": "updatedAt",
351 |           "type": "timestamp",
352 |           "primaryKey": false,
353 |           "notNull": true,
354 |           "default": "now()"
355 |         }
356 |       },
357 |       "indexes": {},
358 |       "foreignKeys": {
359 |         "session_userId_user_id_fk": {
360 |           "name": "session_userId_user_id_fk",
361 |           "tableFrom": "session",
362 |           "tableTo": "user",
363 |           "columnsFrom": [
364 |             "userId"
365 |           ],
366 |           "columnsTo": [
367 |             "id"
368 |           ],
369 |           "onDelete": "cascade",
370 |           "onUpdate": "no action"
371 |         }
372 |       },
373 |       "compositePrimaryKeys": {},
374 |       "uniqueConstraints": {
375 |         "session_sessionToken_unique": {
376 |           "name": "session_sessionToken_unique",
377 |           "nullsNotDistinct": false,
378 |           "columns": [
379 |             "sessionToken"
380 |           ]
381 |         }
382 |       },
383 |       "policies": {},
384 |       "checkConstraints": {},
385 |       "isRLSEnabled": false
386 |     },
387 |     "public.user": {
388 |       "name": "user",
389 |       "schema": "",
390 |       "columns": {
391 |         "id": {
392 |           "name": "id",
393 |           "type": "text",
394 |           "primaryKey": true,
395 |           "notNull": true
396 |         },
397 |         "name": {
398 |           "name": "name",
399 |           "type": "text",
400 |           "primaryKey": false,
401 |           "notNull": false
402 |         },
403 |         "email": {
404 |           "name": "email",
405 |           "type": "text",
406 |           "primaryKey": false,
407 |           "notNull": true
408 |         },
409 |         "emailVerified": {
410 |           "name": "emailVerified",
411 |           "type": "boolean",
412 |           "primaryKey": false,
413 |           "notNull": false
414 |         },
415 |         "image": {
416 |           "name": "image",
417 |           "type": "text",
418 |           "primaryKey": false,
419 |           "notNull": false
420 |         },
421 |         "isAnonymous": {
422 |           "name": "isAnonymous",
423 |           "type": "boolean",
424 |           "primaryKey": false,
425 |           "notNull": false,
426 |           "default": false
427 |         },
428 |         "createdAt": {
429 |           "name": "createdAt",
430 |           "type": "timestamp",
431 |           "primaryKey": false,
432 |           "notNull": true,
433 |           "default": "now()"
434 |         },
435 |         "updatedAt": {
436 |           "name": "updatedAt",
437 |           "type": "timestamp",
438 |           "primaryKey": false,
439 |           "notNull": true,
440 |           "default": "now()"
441 |         }
442 |       },
443 |       "indexes": {},
444 |       "foreignKeys": {},
445 |       "compositePrimaryKeys": {},
446 |       "uniqueConstraints": {
447 |         "user_email_unique": {
448 |           "name": "user_email_unique",
449 |           "nullsNotDistinct": false,
450 |           "columns": [
451 |             "email"
452 |           ]
453 |         }
454 |       },
455 |       "policies": {},
456 |       "checkConstraints": {},
457 |       "isRLSEnabled": false
458 |     },
459 |     "public.verification": {
460 |       "name": "verification",
461 |       "schema": "",
462 |       "columns": {
463 |         "id": {
464 |           "name": "id",
465 |           "type": "text",
466 |           "primaryKey": true,
467 |           "notNull": true
468 |         },
469 |         "identifier": {
470 |           "name": "identifier",
471 |           "type": "text",
472 |           "primaryKey": false,
473 |           "notNull": true
474 |         },
475 |         "value": {
476 |           "name": "value",
477 |           "type": "text",
478 |           "primaryKey": false,
479 |           "notNull": true
480 |         },
481 |         "expiresAt": {
482 |           "name": "expiresAt",
483 |           "type": "timestamp",
484 |           "primaryKey": false,
485 |           "notNull": true
486 |         },
487 |         "createdAt": {
488 |           "name": "createdAt",
489 |           "type": "timestamp",
490 |           "primaryKey": false,
491 |           "notNull": true,
492 |           "default": "now()"
493 |         },
494 |         "updatedAt": {
495 |           "name": "updatedAt",
496 |           "type": "timestamp",
497 |           "primaryKey": false,
498 |           "notNull": true,
499 |           "default": "now()"
500 |         }
501 |       },
502 |       "indexes": {},
503 |       "foreignKeys": {},
504 |       "compositePrimaryKeys": {},
505 |       "uniqueConstraints": {},
506 |       "policies": {},
507 |       "checkConstraints": {},
508 |       "isRLSEnabled": false
509 |     }
510 |   },
511 |   "enums": {},
512 |   "schemas": {},
513 |   "sequences": {},
514 |   "roles": {},
515 |   "policies": {},
516 |   "views": {},
517 |   "_meta": {
518 |     "columns": {},
519 |     "schemas": {},
520 |     "tables": {}
521 |   }
522 | }
```

drizzle/meta/0021_snapshot.json
```
1 | {
2 |   "id": "e6db90c3-f2be-4342-83c7-1208ae49b9d3",
3 |   "prevId": "28459e0c-5ff3-4a49-b3f8-7c8e1c3c1ccd",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "has_web_search": {
195 |           "name": "has_web_search",
196 |           "type": "boolean",
197 |           "primaryKey": false,
198 |           "notNull": false,
199 |           "default": false
200 |         },
201 |         "web_search_context_size": {
202 |           "name": "web_search_context_size",
203 |           "type": "text",
204 |           "primaryKey": false,
205 |           "notNull": false,
206 |           "default": "'medium'"
207 |         },
208 |         "created_at": {
209 |           "name": "created_at",
210 |           "type": "timestamp",
211 |           "primaryKey": false,
212 |           "notNull": true,
213 |           "default": "now()"
214 |         }
215 |       },
216 |       "indexes": {},
217 |       "foreignKeys": {
218 |         "messages_chat_id_chats_id_fk": {
219 |           "name": "messages_chat_id_chats_id_fk",
220 |           "tableFrom": "messages",
221 |           "tableTo": "chats",
222 |           "columnsFrom": [
223 |             "chat_id"
224 |           ],
225 |           "columnsTo": [
226 |             "id"
227 |           ],
228 |           "onDelete": "cascade",
229 |           "onUpdate": "no action"
230 |         }
231 |       },
232 |       "compositePrimaryKeys": {},
233 |       "uniqueConstraints": {},
234 |       "policies": {},
235 |       "checkConstraints": {},
236 |       "isRLSEnabled": false
237 |     },
238 |     "public.polar_usage_events": {
239 |       "name": "polar_usage_events",
240 |       "schema": "",
241 |       "columns": {
242 |         "id": {
243 |           "name": "id",
244 |           "type": "text",
245 |           "primaryKey": true,
246 |           "notNull": true
247 |         },
248 |         "user_id": {
249 |           "name": "user_id",
250 |           "type": "text",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "polar_customer_id": {
255 |           "name": "polar_customer_id",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "event_name": {
261 |           "name": "event_name",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": true
265 |         },
266 |         "event_payload": {
267 |           "name": "event_payload",
268 |           "type": "json",
269 |           "primaryKey": false,
270 |           "notNull": true
271 |         },
272 |         "created_at": {
273 |           "name": "created_at",
274 |           "type": "timestamp",
275 |           "primaryKey": false,
276 |           "notNull": true,
277 |           "default": "now()"
278 |         }
279 |       },
280 |       "indexes": {},
281 |       "foreignKeys": {
282 |         "polar_usage_events_user_id_user_id_fk": {
283 |           "name": "polar_usage_events_user_id_user_id_fk",
284 |           "tableFrom": "polar_usage_events",
285 |           "tableTo": "user",
286 |           "columnsFrom": [
287 |             "user_id"
288 |           ],
289 |           "columnsTo": [
290 |             "id"
291 |           ],
292 |           "onDelete": "cascade",
293 |           "onUpdate": "no action"
294 |         }
295 |       },
296 |       "compositePrimaryKeys": {},
297 |       "uniqueConstraints": {},
298 |       "policies": {},
299 |       "checkConstraints": {},
300 |       "isRLSEnabled": false
301 |     },
302 |     "public.session": {
303 |       "name": "session",
304 |       "schema": "",
305 |       "columns": {
306 |         "id": {
307 |           "name": "id",
308 |           "type": "text",
309 |           "primaryKey": true,
310 |           "notNull": true
311 |         },
312 |         "sessionToken": {
313 |           "name": "sessionToken",
314 |           "type": "text",
315 |           "primaryKey": false,
316 |           "notNull": true
317 |         },
318 |         "userId": {
319 |           "name": "userId",
320 |           "type": "text",
321 |           "primaryKey": false,
322 |           "notNull": true
323 |         },
324 |         "expiresAt": {
325 |           "name": "expiresAt",
326 |           "type": "timestamp",
327 |           "primaryKey": false,
328 |           "notNull": true
329 |         },
330 |         "ipAddress": {
331 |           "name": "ipAddress",
332 |           "type": "text",
333 |           "primaryKey": false,
334 |           "notNull": false
335 |         },
336 |         "userAgent": {
337 |           "name": "userAgent",
338 |           "type": "text",
339 |           "primaryKey": false,
340 |           "notNull": false
341 |         },
342 |         "createdAt": {
343 |           "name": "createdAt",
344 |           "type": "timestamp",
345 |           "primaryKey": false,
346 |           "notNull": true,
347 |           "default": "now()"
348 |         },
349 |         "updatedAt": {
350 |           "name": "updatedAt",
351 |           "type": "timestamp",
352 |           "primaryKey": false,
353 |           "notNull": true,
354 |           "default": "now()"
355 |         }
356 |       },
357 |       "indexes": {},
358 |       "foreignKeys": {
359 |         "session_userId_user_id_fk": {
360 |           "name": "session_userId_user_id_fk",
361 |           "tableFrom": "session",
362 |           "tableTo": "user",
363 |           "columnsFrom": [
364 |             "userId"
365 |           ],
366 |           "columnsTo": [
367 |             "id"
368 |           ],
369 |           "onDelete": "cascade",
370 |           "onUpdate": "no action"
371 |         }
372 |       },
373 |       "compositePrimaryKeys": {},
374 |       "uniqueConstraints": {
375 |         "session_sessionToken_unique": {
376 |           "name": "session_sessionToken_unique",
377 |           "nullsNotDistinct": false,
378 |           "columns": [
379 |             "sessionToken"
380 |           ]
381 |         }
382 |       },
383 |       "policies": {},
384 |       "checkConstraints": {},
385 |       "isRLSEnabled": false
386 |     },
387 |     "public.user": {
388 |       "name": "user",
389 |       "schema": "",
390 |       "columns": {
391 |         "id": {
392 |           "name": "id",
393 |           "type": "text",
394 |           "primaryKey": true,
395 |           "notNull": true
396 |         },
397 |         "name": {
398 |           "name": "name",
399 |           "type": "text",
400 |           "primaryKey": false,
401 |           "notNull": false
402 |         },
403 |         "email": {
404 |           "name": "email",
405 |           "type": "text",
406 |           "primaryKey": false,
407 |           "notNull": true
408 |         },
409 |         "emailVerified": {
410 |           "name": "emailVerified",
411 |           "type": "boolean",
412 |           "primaryKey": false,
413 |           "notNull": false
414 |         },
415 |         "image": {
416 |           "name": "image",
417 |           "type": "text",
418 |           "primaryKey": false,
419 |           "notNull": false
420 |         },
421 |         "isAnonymous": {
422 |           "name": "isAnonymous",
423 |           "type": "boolean",
424 |           "primaryKey": false,
425 |           "notNull": false,
426 |           "default": false
427 |         },
428 |         "metadata": {
429 |           "name": "metadata",
430 |           "type": "json",
431 |           "primaryKey": false,
432 |           "notNull": false
433 |         },
434 |         "createdAt": {
435 |           "name": "createdAt",
436 |           "type": "timestamp",
437 |           "primaryKey": false,
438 |           "notNull": true,
439 |           "default": "now()"
440 |         },
441 |         "updatedAt": {
442 |           "name": "updatedAt",
443 |           "type": "timestamp",
444 |           "primaryKey": false,
445 |           "notNull": true,
446 |           "default": "now()"
447 |         }
448 |       },
449 |       "indexes": {},
450 |       "foreignKeys": {},
451 |       "compositePrimaryKeys": {},
452 |       "uniqueConstraints": {
453 |         "user_email_unique": {
454 |           "name": "user_email_unique",
455 |           "nullsNotDistinct": false,
456 |           "columns": [
457 |             "email"
458 |           ]
459 |         }
460 |       },
461 |       "policies": {},
462 |       "checkConstraints": {},
463 |       "isRLSEnabled": false
464 |     },
465 |     "public.verification": {
466 |       "name": "verification",
467 |       "schema": "",
468 |       "columns": {
469 |         "id": {
470 |           "name": "id",
471 |           "type": "text",
472 |           "primaryKey": true,
473 |           "notNull": true
474 |         },
475 |         "identifier": {
476 |           "name": "identifier",
477 |           "type": "text",
478 |           "primaryKey": false,
479 |           "notNull": true
480 |         },
481 |         "value": {
482 |           "name": "value",
483 |           "type": "text",
484 |           "primaryKey": false,
485 |           "notNull": true
486 |         },
487 |         "expiresAt": {
488 |           "name": "expiresAt",
489 |           "type": "timestamp",
490 |           "primaryKey": false,
491 |           "notNull": true
492 |         },
493 |         "createdAt": {
494 |           "name": "createdAt",
495 |           "type": "timestamp",
496 |           "primaryKey": false,
497 |           "notNull": true,
498 |           "default": "now()"
499 |         },
500 |         "updatedAt": {
501 |           "name": "updatedAt",
502 |           "type": "timestamp",
503 |           "primaryKey": false,
504 |           "notNull": true,
505 |           "default": "now()"
506 |         }
507 |       },
508 |       "indexes": {},
509 |       "foreignKeys": {},
510 |       "compositePrimaryKeys": {},
511 |       "uniqueConstraints": {},
512 |       "policies": {},
513 |       "checkConstraints": {},
514 |       "isRLSEnabled": false
515 |     }
516 |   },
517 |   "enums": {},
518 |   "schemas": {},
519 |   "sequences": {},
520 |   "roles": {},
521 |   "policies": {},
522 |   "views": {},
523 |   "_meta": {
524 |     "columns": {},
525 |     "schemas": {},
526 |     "tables": {}
527 |   }
528 | }
```

drizzle/meta/0022_snapshot.json
```
1 | {
2 |   "id": "9f5d655a-b03c-4009-ba62-7a9492c5aa5f",
3 |   "prevId": "e6db90c3-f2be-4342-83c7-1208ae49b9d3",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.messages": {
167 |       "name": "messages",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "chat_id": {
177 |           "name": "chat_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "role": {
183 |           "name": "role",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "parts": {
189 |           "name": "parts",
190 |           "type": "json",
191 |           "primaryKey": false,
192 |           "notNull": true
193 |         },
194 |         "has_web_search": {
195 |           "name": "has_web_search",
196 |           "type": "boolean",
197 |           "primaryKey": false,
198 |           "notNull": false,
199 |           "default": false
200 |         },
201 |         "web_search_context_size": {
202 |           "name": "web_search_context_size",
203 |           "type": "text",
204 |           "primaryKey": false,
205 |           "notNull": false,
206 |           "default": "'medium'"
207 |         },
208 |         "created_at": {
209 |           "name": "created_at",
210 |           "type": "timestamp",
211 |           "primaryKey": false,
212 |           "notNull": true,
213 |           "default": "now()"
214 |         }
215 |       },
216 |       "indexes": {},
217 |       "foreignKeys": {
218 |         "messages_chat_id_chats_id_fk": {
219 |           "name": "messages_chat_id_chats_id_fk",
220 |           "tableFrom": "messages",
221 |           "tableTo": "chats",
222 |           "columnsFrom": [
223 |             "chat_id"
224 |           ],
225 |           "columnsTo": [
226 |             "id"
227 |           ],
228 |           "onDelete": "cascade",
229 |           "onUpdate": "no action"
230 |         }
231 |       },
232 |       "compositePrimaryKeys": {},
233 |       "uniqueConstraints": {},
234 |       "policies": {},
235 |       "checkConstraints": {},
236 |       "isRLSEnabled": false
237 |     },
238 |     "public.polar_usage_events": {
239 |       "name": "polar_usage_events",
240 |       "schema": "",
241 |       "columns": {
242 |         "id": {
243 |           "name": "id",
244 |           "type": "text",
245 |           "primaryKey": true,
246 |           "notNull": true
247 |         },
248 |         "user_id": {
249 |           "name": "user_id",
250 |           "type": "text",
251 |           "primaryKey": false,
252 |           "notNull": true
253 |         },
254 |         "polar_customer_id": {
255 |           "name": "polar_customer_id",
256 |           "type": "text",
257 |           "primaryKey": false,
258 |           "notNull": false
259 |         },
260 |         "event_name": {
261 |           "name": "event_name",
262 |           "type": "text",
263 |           "primaryKey": false,
264 |           "notNull": true
265 |         },
266 |         "event_payload": {
267 |           "name": "event_payload",
268 |           "type": "json",
269 |           "primaryKey": false,
270 |           "notNull": true
271 |         },
272 |         "created_at": {
273 |           "name": "created_at",
274 |           "type": "timestamp",
275 |           "primaryKey": false,
276 |           "notNull": true,
277 |           "default": "now()"
278 |         }
279 |       },
280 |       "indexes": {},
281 |       "foreignKeys": {
282 |         "polar_usage_events_user_id_user_id_fk": {
283 |           "name": "polar_usage_events_user_id_user_id_fk",
284 |           "tableFrom": "polar_usage_events",
285 |           "tableTo": "user",
286 |           "columnsFrom": [
287 |             "user_id"
288 |           ],
289 |           "columnsTo": [
290 |             "id"
291 |           ],
292 |           "onDelete": "cascade",
293 |           "onUpdate": "no action"
294 |         }
295 |       },
296 |       "compositePrimaryKeys": {},
297 |       "uniqueConstraints": {},
298 |       "policies": {},
299 |       "checkConstraints": {},
300 |       "isRLSEnabled": false
301 |     },
302 |     "public.preset_usage": {
303 |       "name": "preset_usage",
304 |       "schema": "",
305 |       "columns": {
306 |         "id": {
307 |           "name": "id",
308 |           "type": "text",
309 |           "primaryKey": true,
310 |           "notNull": true
311 |         },
312 |         "preset_id": {
313 |           "name": "preset_id",
314 |           "type": "text",
315 |           "primaryKey": false,
316 |           "notNull": true
317 |         },
318 |         "user_id": {
319 |           "name": "user_id",
320 |           "type": "text",
321 |           "primaryKey": false,
322 |           "notNull": true
323 |         },
324 |         "chat_id": {
325 |           "name": "chat_id",
326 |           "type": "text",
327 |           "primaryKey": false,
328 |           "notNull": false
329 |         },
330 |         "used_at": {
331 |           "name": "used_at",
332 |           "type": "timestamp",
333 |           "primaryKey": false,
334 |           "notNull": true,
335 |           "default": "now()"
336 |         }
337 |       },
338 |       "indexes": {},
339 |       "foreignKeys": {
340 |         "preset_usage_preset_id_presets_id_fk": {
341 |           "name": "preset_usage_preset_id_presets_id_fk",
342 |           "tableFrom": "preset_usage",
343 |           "tableTo": "presets",
344 |           "columnsFrom": [
345 |             "preset_id"
346 |           ],
347 |           "columnsTo": [
348 |             "id"
349 |           ],
350 |           "onDelete": "cascade",
351 |           "onUpdate": "no action"
352 |         },
353 |         "preset_usage_user_id_user_id_fk": {
354 |           "name": "preset_usage_user_id_user_id_fk",
355 |           "tableFrom": "preset_usage",
356 |           "tableTo": "user",
357 |           "columnsFrom": [
358 |             "user_id"
359 |           ],
360 |           "columnsTo": [
361 |             "id"
362 |           ],
363 |           "onDelete": "cascade",
364 |           "onUpdate": "no action"
365 |         }
366 |       },
367 |       "compositePrimaryKeys": {},
368 |       "uniqueConstraints": {},
369 |       "policies": {},
370 |       "checkConstraints": {},
371 |       "isRLSEnabled": false
372 |     },
373 |     "public.presets": {
374 |       "name": "presets",
375 |       "schema": "",
376 |       "columns": {
377 |         "id": {
378 |           "name": "id",
379 |           "type": "text",
380 |           "primaryKey": true,
381 |           "notNull": true
382 |         },
383 |         "user_id": {
384 |           "name": "user_id",
385 |           "type": "text",
386 |           "primaryKey": false,
387 |           "notNull": true
388 |         },
389 |         "name": {
390 |           "name": "name",
391 |           "type": "text",
392 |           "primaryKey": false,
393 |           "notNull": true
394 |         },
395 |         "model_id": {
396 |           "name": "model_id",
397 |           "type": "text",
398 |           "primaryKey": false,
399 |           "notNull": true
400 |         },
401 |         "system_instruction": {
402 |           "name": "system_instruction",
403 |           "type": "text",
404 |           "primaryKey": false,
405 |           "notNull": true
406 |         },
407 |         "temperature": {
408 |           "name": "temperature",
409 |           "type": "integer",
410 |           "primaryKey": false,
411 |           "notNull": true
412 |         },
413 |         "max_tokens": {
414 |           "name": "max_tokens",
415 |           "type": "integer",
416 |           "primaryKey": false,
417 |           "notNull": true
418 |         },
419 |         "web_search_enabled": {
420 |           "name": "web_search_enabled",
421 |           "type": "boolean",
422 |           "primaryKey": false,
423 |           "notNull": false,
424 |           "default": false
425 |         },
426 |         "web_search_context_size": {
427 |           "name": "web_search_context_size",
428 |           "type": "text",
429 |           "primaryKey": false,
430 |           "notNull": false,
431 |           "default": "'medium'"
432 |         },
433 |         "api_key_preferences": {
434 |           "name": "api_key_preferences",
435 |           "type": "json",
436 |           "primaryKey": false,
437 |           "notNull": false,
438 |           "default": "'{}'::json"
439 |         },
440 |         "is_default": {
441 |           "name": "is_default",
442 |           "type": "boolean",
443 |           "primaryKey": false,
444 |           "notNull": false,
445 |           "default": false
446 |         },
447 |         "share_id": {
448 |           "name": "share_id",
449 |           "type": "text",
450 |           "primaryKey": false,
451 |           "notNull": false
452 |         },
453 |         "visibility": {
454 |           "name": "visibility",
455 |           "type": "text",
456 |           "primaryKey": false,
457 |           "notNull": false,
458 |           "default": "'private'"
459 |         },
460 |         "version": {
461 |           "name": "version",
462 |           "type": "integer",
463 |           "primaryKey": false,
464 |           "notNull": false,
465 |           "default": 1
466 |         },
467 |         "created_at": {
468 |           "name": "created_at",
469 |           "type": "timestamp",
470 |           "primaryKey": false,
471 |           "notNull": true,
472 |           "default": "now()"
473 |         },
474 |         "updated_at": {
475 |           "name": "updated_at",
476 |           "type": "timestamp",
477 |           "primaryKey": false,
478 |           "notNull": true,
479 |           "default": "now()"
480 |         },
481 |         "deleted_at": {
482 |           "name": "deleted_at",
483 |           "type": "timestamp",
484 |           "primaryKey": false,
485 |           "notNull": false
486 |         }
487 |       },
488 |       "indexes": {},
489 |       "foreignKeys": {
490 |         "presets_user_id_user_id_fk": {
491 |           "name": "presets_user_id_user_id_fk",
492 |           "tableFrom": "presets",
493 |           "tableTo": "user",
494 |           "columnsFrom": [
495 |             "user_id"
496 |           ],
497 |           "columnsTo": [
498 |             "id"
499 |           ],
500 |           "onDelete": "cascade",
501 |           "onUpdate": "no action"
502 |         }
503 |       },
504 |       "compositePrimaryKeys": {},
505 |       "uniqueConstraints": {
506 |         "presets_share_id_unique": {
507 |           "name": "presets_share_id_unique",
508 |           "nullsNotDistinct": false,
509 |           "columns": [
510 |             "share_id"
511 |           ]
512 |         },
513 |         "unique_name_per_user": {
514 |           "name": "unique_name_per_user",
515 |           "nullsNotDistinct": false,
516 |           "columns": [
517 |             "user_id",
518 |             "name"
519 |           ]
520 |         }
521 |       },
522 |       "policies": {},
523 |       "checkConstraints": {
524 |         "check_name_length": {
525 |           "name": "check_name_length",
526 |           "value": "char_length(\"presets\".\"name\") >= 1 AND char_length(\"presets\".\"name\") <= 100"
527 |         },
528 |         "check_system_instruction_length": {
529 |           "name": "check_system_instruction_length",
530 |           "value": "char_length(\"presets\".\"system_instruction\") >= 10 AND char_length(\"presets\".\"system_instruction\") <= 4000"
531 |         },
532 |         "check_temperature_range": {
533 |           "name": "check_temperature_range",
534 |           "value": "\"presets\".\"temperature\" >= 0 AND \"presets\".\"temperature\" <= 2000"
535 |         },
536 |         "check_max_tokens_range": {
537 |           "name": "check_max_tokens_range",
538 |           "value": "\"presets\".\"max_tokens\" > 0 AND \"presets\".\"max_tokens\" <= 100000"
539 |         },
540 |         "check_visibility": {
541 |           "name": "check_visibility",
542 |           "value": "\"presets\".\"visibility\" IN ('private', 'shared')"
543 |         },
544 |         "check_web_search_context_size": {
545 |           "name": "check_web_search_context_size",
546 |           "value": "\"presets\".\"web_search_context_size\" IN ('low', 'medium', 'high')"
547 |         },
548 |         "check_share_id_format": {
549 |           "name": "check_share_id_format",
550 |           "value": "\"presets\".\"share_id\" IS NULL OR (char_length(\"presets\".\"share_id\") >= 20 AND char_length(\"presets\".\"share_id\") <= 50)"
551 |         }
552 |       },
553 |       "isRLSEnabled": false
554 |     },
555 |     "public.session": {
556 |       "name": "session",
557 |       "schema": "",
558 |       "columns": {
559 |         "id": {
560 |           "name": "id",
561 |           "type": "text",
562 |           "primaryKey": true,
563 |           "notNull": true
564 |         },
565 |         "sessionToken": {
566 |           "name": "sessionToken",
567 |           "type": "text",
568 |           "primaryKey": false,
569 |           "notNull": true
570 |         },
571 |         "userId": {
572 |           "name": "userId",
573 |           "type": "text",
574 |           "primaryKey": false,
575 |           "notNull": true
576 |         },
577 |         "expiresAt": {
578 |           "name": "expiresAt",
579 |           "type": "timestamp",
580 |           "primaryKey": false,
581 |           "notNull": true
582 |         },
583 |         "ipAddress": {
584 |           "name": "ipAddress",
585 |           "type": "text",
586 |           "primaryKey": false,
587 |           "notNull": false
588 |         },
589 |         "userAgent": {
590 |           "name": "userAgent",
591 |           "type": "text",
592 |           "primaryKey": false,
593 |           "notNull": false
594 |         },
595 |         "createdAt": {
596 |           "name": "createdAt",
597 |           "type": "timestamp",
598 |           "primaryKey": false,
599 |           "notNull": true,
600 |           "default": "now()"
601 |         },
602 |         "updatedAt": {
603 |           "name": "updatedAt",
604 |           "type": "timestamp",
605 |           "primaryKey": false,
606 |           "notNull": true,
607 |           "default": "now()"
608 |         }
609 |       },
610 |       "indexes": {},
611 |       "foreignKeys": {
612 |         "session_userId_user_id_fk": {
613 |           "name": "session_userId_user_id_fk",
614 |           "tableFrom": "session",
615 |           "tableTo": "user",
616 |           "columnsFrom": [
617 |             "userId"
618 |           ],
619 |           "columnsTo": [
620 |             "id"
621 |           ],
622 |           "onDelete": "cascade",
623 |           "onUpdate": "no action"
624 |         }
625 |       },
626 |       "compositePrimaryKeys": {},
627 |       "uniqueConstraints": {
628 |         "session_sessionToken_unique": {
629 |           "name": "session_sessionToken_unique",
630 |           "nullsNotDistinct": false,
631 |           "columns": [
632 |             "sessionToken"
633 |           ]
634 |         }
635 |       },
636 |       "policies": {},
637 |       "checkConstraints": {},
638 |       "isRLSEnabled": false
639 |     },
640 |     "public.user": {
641 |       "name": "user",
642 |       "schema": "",
643 |       "columns": {
644 |         "id": {
645 |           "name": "id",
646 |           "type": "text",
647 |           "primaryKey": true,
648 |           "notNull": true
649 |         },
650 |         "name": {
651 |           "name": "name",
652 |           "type": "text",
653 |           "primaryKey": false,
654 |           "notNull": false
655 |         },
656 |         "email": {
657 |           "name": "email",
658 |           "type": "text",
659 |           "primaryKey": false,
660 |           "notNull": true
661 |         },
662 |         "emailVerified": {
663 |           "name": "emailVerified",
664 |           "type": "boolean",
665 |           "primaryKey": false,
666 |           "notNull": false
667 |         },
668 |         "image": {
669 |           "name": "image",
670 |           "type": "text",
671 |           "primaryKey": false,
672 |           "notNull": false
673 |         },
674 |         "isAnonymous": {
675 |           "name": "isAnonymous",
676 |           "type": "boolean",
677 |           "primaryKey": false,
678 |           "notNull": false,
679 |           "default": false
680 |         },
681 |         "metadata": {
682 |           "name": "metadata",
683 |           "type": "json",
684 |           "primaryKey": false,
685 |           "notNull": false
686 |         },
687 |         "default_preset_id": {
688 |           "name": "default_preset_id",
689 |           "type": "text",
690 |           "primaryKey": false,
691 |           "notNull": false
692 |         },
693 |         "createdAt": {
694 |           "name": "createdAt",
695 |           "type": "timestamp",
696 |           "primaryKey": false,
697 |           "notNull": true,
698 |           "default": "now()"
699 |         },
700 |         "updatedAt": {
701 |           "name": "updatedAt",
702 |           "type": "timestamp",
703 |           "primaryKey": false,
704 |           "notNull": true,
705 |           "default": "now()"
706 |         }
707 |       },
708 |       "indexes": {},
709 |       "foreignKeys": {},
710 |       "compositePrimaryKeys": {},
711 |       "uniqueConstraints": {
712 |         "user_email_unique": {
713 |           "name": "user_email_unique",
714 |           "nullsNotDistinct": false,
715 |           "columns": [
716 |             "email"
717 |           ]
718 |         }
719 |       },
720 |       "policies": {},
721 |       "checkConstraints": {},
722 |       "isRLSEnabled": false
723 |     },
724 |     "public.verification": {
725 |       "name": "verification",
726 |       "schema": "",
727 |       "columns": {
728 |         "id": {
729 |           "name": "id",
730 |           "type": "text",
731 |           "primaryKey": true,
732 |           "notNull": true
733 |         },
734 |         "identifier": {
735 |           "name": "identifier",
736 |           "type": "text",
737 |           "primaryKey": false,
738 |           "notNull": true
739 |         },
740 |         "value": {
741 |           "name": "value",
742 |           "type": "text",
743 |           "primaryKey": false,
744 |           "notNull": true
745 |         },
746 |         "expiresAt": {
747 |           "name": "expiresAt",
748 |           "type": "timestamp",
749 |           "primaryKey": false,
750 |           "notNull": true
751 |         },
752 |         "createdAt": {
753 |           "name": "createdAt",
754 |           "type": "timestamp",
755 |           "primaryKey": false,
756 |           "notNull": true,
757 |           "default": "now()"
758 |         },
759 |         "updatedAt": {
760 |           "name": "updatedAt",
761 |           "type": "timestamp",
762 |           "primaryKey": false,
763 |           "notNull": true,
764 |           "default": "now()"
765 |         }
766 |       },
767 |       "indexes": {},
768 |       "foreignKeys": {},
769 |       "compositePrimaryKeys": {},
770 |       "uniqueConstraints": {},
771 |       "policies": {},
772 |       "checkConstraints": {},
773 |       "isRLSEnabled": false
774 |     }
775 |   },
776 |   "enums": {},
777 |   "schemas": {},
778 |   "sequences": {},
779 |   "roles": {},
780 |   "policies": {},
781 |   "views": {},
782 |   "_meta": {
783 |     "columns": {},
784 |     "schemas": {},
785 |     "tables": {}
786 |   }
787 | }
```

drizzle/meta/0024_snapshot.json
```
1 | {
2 |   "id": "d89d5d62-2101-4acc-a6aa-724d95cf621a",
3 |   "prevId": "9f5d655a-b03c-4009-ba62-7a9492c5aa5f",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.favorite_models": {
167 |       "name": "favorite_models",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "user_id": {
177 |           "name": "user_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "model_id": {
183 |           "name": "model_id",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "created_at": {
189 |           "name": "created_at",
190 |           "type": "timestamp",
191 |           "primaryKey": false,
192 |           "notNull": true,
193 |           "default": "now()"
194 |         }
195 |       },
196 |       "indexes": {},
197 |       "foreignKeys": {
198 |         "favorite_models_user_id_user_id_fk": {
199 |           "name": "favorite_models_user_id_user_id_fk",
200 |           "tableFrom": "favorite_models",
201 |           "tableTo": "user",
202 |           "columnsFrom": [
203 |             "user_id"
204 |           ],
205 |           "columnsTo": [
206 |             "id"
207 |           ],
208 |           "onDelete": "cascade",
209 |           "onUpdate": "no action"
210 |         }
211 |       },
212 |       "compositePrimaryKeys": {},
213 |       "uniqueConstraints": {
214 |         "unique_user_model": {
215 |           "name": "unique_user_model",
216 |           "nullsNotDistinct": false,
217 |           "columns": [
218 |             "user_id",
219 |             "model_id"
220 |           ]
221 |         }
222 |       },
223 |       "policies": {},
224 |       "checkConstraints": {},
225 |       "isRLSEnabled": false
226 |     },
227 |     "public.messages": {
228 |       "name": "messages",
229 |       "schema": "",
230 |       "columns": {
231 |         "id": {
232 |           "name": "id",
233 |           "type": "text",
234 |           "primaryKey": true,
235 |           "notNull": true
236 |         },
237 |         "chat_id": {
238 |           "name": "chat_id",
239 |           "type": "text",
240 |           "primaryKey": false,
241 |           "notNull": true
242 |         },
243 |         "role": {
244 |           "name": "role",
245 |           "type": "text",
246 |           "primaryKey": false,
247 |           "notNull": true
248 |         },
249 |         "parts": {
250 |           "name": "parts",
251 |           "type": "json",
252 |           "primaryKey": false,
253 |           "notNull": true
254 |         },
255 |         "has_web_search": {
256 |           "name": "has_web_search",
257 |           "type": "boolean",
258 |           "primaryKey": false,
259 |           "notNull": false,
260 |           "default": false
261 |         },
262 |         "web_search_context_size": {
263 |           "name": "web_search_context_size",
264 |           "type": "text",
265 |           "primaryKey": false,
266 |           "notNull": false,
267 |           "default": "'medium'"
268 |         },
269 |         "created_at": {
270 |           "name": "created_at",
271 |           "type": "timestamp",
272 |           "primaryKey": false,
273 |           "notNull": true,
274 |           "default": "now()"
275 |         }
276 |       },
277 |       "indexes": {},
278 |       "foreignKeys": {
279 |         "messages_chat_id_chats_id_fk": {
280 |           "name": "messages_chat_id_chats_id_fk",
281 |           "tableFrom": "messages",
282 |           "tableTo": "chats",
283 |           "columnsFrom": [
284 |             "chat_id"
285 |           ],
286 |           "columnsTo": [
287 |             "id"
288 |           ],
289 |           "onDelete": "cascade",
290 |           "onUpdate": "no action"
291 |         }
292 |       },
293 |       "compositePrimaryKeys": {},
294 |       "uniqueConstraints": {},
295 |       "policies": {},
296 |       "checkConstraints": {},
297 |       "isRLSEnabled": false
298 |     },
299 |     "public.polar_usage_events": {
300 |       "name": "polar_usage_events",
301 |       "schema": "",
302 |       "columns": {
303 |         "id": {
304 |           "name": "id",
305 |           "type": "text",
306 |           "primaryKey": true,
307 |           "notNull": true
308 |         },
309 |         "user_id": {
310 |           "name": "user_id",
311 |           "type": "text",
312 |           "primaryKey": false,
313 |           "notNull": true
314 |         },
315 |         "polar_customer_id": {
316 |           "name": "polar_customer_id",
317 |           "type": "text",
318 |           "primaryKey": false,
319 |           "notNull": false
320 |         },
321 |         "event_name": {
322 |           "name": "event_name",
323 |           "type": "text",
324 |           "primaryKey": false,
325 |           "notNull": true
326 |         },
327 |         "event_payload": {
328 |           "name": "event_payload",
329 |           "type": "json",
330 |           "primaryKey": false,
331 |           "notNull": true
332 |         },
333 |         "created_at": {
334 |           "name": "created_at",
335 |           "type": "timestamp",
336 |           "primaryKey": false,
337 |           "notNull": true,
338 |           "default": "now()"
339 |         }
340 |       },
341 |       "indexes": {},
342 |       "foreignKeys": {
343 |         "polar_usage_events_user_id_user_id_fk": {
344 |           "name": "polar_usage_events_user_id_user_id_fk",
345 |           "tableFrom": "polar_usage_events",
346 |           "tableTo": "user",
347 |           "columnsFrom": [
348 |             "user_id"
349 |           ],
350 |           "columnsTo": [
351 |             "id"
352 |           ],
353 |           "onDelete": "cascade",
354 |           "onUpdate": "no action"
355 |         }
356 |       },
357 |       "compositePrimaryKeys": {},
358 |       "uniqueConstraints": {},
359 |       "policies": {},
360 |       "checkConstraints": {},
361 |       "isRLSEnabled": false
362 |     },
363 |     "public.preset_usage": {
364 |       "name": "preset_usage",
365 |       "schema": "",
366 |       "columns": {
367 |         "id": {
368 |           "name": "id",
369 |           "type": "text",
370 |           "primaryKey": true,
371 |           "notNull": true
372 |         },
373 |         "preset_id": {
374 |           "name": "preset_id",
375 |           "type": "text",
376 |           "primaryKey": false,
377 |           "notNull": true
378 |         },
379 |         "user_id": {
380 |           "name": "user_id",
381 |           "type": "text",
382 |           "primaryKey": false,
383 |           "notNull": true
384 |         },
385 |         "chat_id": {
386 |           "name": "chat_id",
387 |           "type": "text",
388 |           "primaryKey": false,
389 |           "notNull": false
390 |         },
391 |         "used_at": {
392 |           "name": "used_at",
393 |           "type": "timestamp",
394 |           "primaryKey": false,
395 |           "notNull": true,
396 |           "default": "now()"
397 |         }
398 |       },
399 |       "indexes": {},
400 |       "foreignKeys": {
401 |         "preset_usage_preset_id_presets_id_fk": {
402 |           "name": "preset_usage_preset_id_presets_id_fk",
403 |           "tableFrom": "preset_usage",
404 |           "tableTo": "presets",
405 |           "columnsFrom": [
406 |             "preset_id"
407 |           ],
408 |           "columnsTo": [
409 |             "id"
410 |           ],
411 |           "onDelete": "cascade",
412 |           "onUpdate": "no action"
413 |         },
414 |         "preset_usage_user_id_user_id_fk": {
415 |           "name": "preset_usage_user_id_user_id_fk",
416 |           "tableFrom": "preset_usage",
417 |           "tableTo": "user",
418 |           "columnsFrom": [
419 |             "user_id"
420 |           ],
421 |           "columnsTo": [
422 |             "id"
423 |           ],
424 |           "onDelete": "cascade",
425 |           "onUpdate": "no action"
426 |         }
427 |       },
428 |       "compositePrimaryKeys": {},
429 |       "uniqueConstraints": {},
430 |       "policies": {},
431 |       "checkConstraints": {},
432 |       "isRLSEnabled": false
433 |     },
434 |     "public.presets": {
435 |       "name": "presets",
436 |       "schema": "",
437 |       "columns": {
438 |         "id": {
439 |           "name": "id",
440 |           "type": "text",
441 |           "primaryKey": true,
442 |           "notNull": true
443 |         },
444 |         "user_id": {
445 |           "name": "user_id",
446 |           "type": "text",
447 |           "primaryKey": false,
448 |           "notNull": true
449 |         },
450 |         "name": {
451 |           "name": "name",
452 |           "type": "text",
453 |           "primaryKey": false,
454 |           "notNull": true
455 |         },
456 |         "model_id": {
457 |           "name": "model_id",
458 |           "type": "text",
459 |           "primaryKey": false,
460 |           "notNull": true
461 |         },
462 |         "system_instruction": {
463 |           "name": "system_instruction",
464 |           "type": "text",
465 |           "primaryKey": false,
466 |           "notNull": true
467 |         },
468 |         "temperature": {
469 |           "name": "temperature",
470 |           "type": "integer",
471 |           "primaryKey": false,
472 |           "notNull": true
473 |         },
474 |         "max_tokens": {
475 |           "name": "max_tokens",
476 |           "type": "integer",
477 |           "primaryKey": false,
478 |           "notNull": true
479 |         },
480 |         "web_search_enabled": {
481 |           "name": "web_search_enabled",
482 |           "type": "boolean",
483 |           "primaryKey": false,
484 |           "notNull": false,
485 |           "default": false
486 |         },
487 |         "web_search_context_size": {
488 |           "name": "web_search_context_size",
489 |           "type": "text",
490 |           "primaryKey": false,
491 |           "notNull": false,
492 |           "default": "'medium'"
493 |         },
494 |         "api_key_preferences": {
495 |           "name": "api_key_preferences",
496 |           "type": "json",
497 |           "primaryKey": false,
498 |           "notNull": false,
499 |           "default": "'{}'::json"
500 |         },
501 |         "is_default": {
502 |           "name": "is_default",
503 |           "type": "boolean",
504 |           "primaryKey": false,
505 |           "notNull": false,
506 |           "default": false
507 |         },
508 |         "share_id": {
509 |           "name": "share_id",
510 |           "type": "text",
511 |           "primaryKey": false,
512 |           "notNull": false
513 |         },
514 |         "visibility": {
515 |           "name": "visibility",
516 |           "type": "text",
517 |           "primaryKey": false,
518 |           "notNull": false,
519 |           "default": "'private'"
520 |         },
521 |         "version": {
522 |           "name": "version",
523 |           "type": "integer",
524 |           "primaryKey": false,
525 |           "notNull": false,
526 |           "default": 1
527 |         },
528 |         "created_at": {
529 |           "name": "created_at",
530 |           "type": "timestamp",
531 |           "primaryKey": false,
532 |           "notNull": true,
533 |           "default": "now()"
534 |         },
535 |         "updated_at": {
536 |           "name": "updated_at",
537 |           "type": "timestamp",
538 |           "primaryKey": false,
539 |           "notNull": true,
540 |           "default": "now()"
541 |         },
542 |         "deleted_at": {
543 |           "name": "deleted_at",
544 |           "type": "timestamp",
545 |           "primaryKey": false,
546 |           "notNull": false
547 |         }
548 |       },
549 |       "indexes": {},
550 |       "foreignKeys": {
551 |         "presets_user_id_user_id_fk": {
552 |           "name": "presets_user_id_user_id_fk",
553 |           "tableFrom": "presets",
554 |           "tableTo": "user",
555 |           "columnsFrom": [
556 |             "user_id"
557 |           ],
558 |           "columnsTo": [
559 |             "id"
560 |           ],
561 |           "onDelete": "cascade",
562 |           "onUpdate": "no action"
563 |         }
564 |       },
565 |       "compositePrimaryKeys": {},
566 |       "uniqueConstraints": {
567 |         "presets_share_id_unique": {
568 |           "name": "presets_share_id_unique",
569 |           "nullsNotDistinct": false,
570 |           "columns": [
571 |             "share_id"
572 |           ]
573 |         },
574 |         "unique_name_per_user": {
575 |           "name": "unique_name_per_user",
576 |           "nullsNotDistinct": false,
577 |           "columns": [
578 |             "user_id",
579 |             "name"
580 |           ]
581 |         }
582 |       },
583 |       "policies": {},
584 |       "checkConstraints": {
585 |         "check_name_length": {
586 |           "name": "check_name_length",
587 |           "value": "char_length(\"presets\".\"name\") >= 1 AND char_length(\"presets\".\"name\") <= 100"
588 |         },
589 |         "check_system_instruction_length": {
590 |           "name": "check_system_instruction_length",
591 |           "value": "char_length(\"presets\".\"system_instruction\") >= 10 AND char_length(\"presets\".\"system_instruction\") <= 4000"
592 |         },
593 |         "check_temperature_range": {
594 |           "name": "check_temperature_range",
595 |           "value": "\"presets\".\"temperature\" >= 0 AND \"presets\".\"temperature\" <= 2000"
596 |         },
597 |         "check_max_tokens_range": {
598 |           "name": "check_max_tokens_range",
599 |           "value": "\"presets\".\"max_tokens\" > 0 AND \"presets\".\"max_tokens\" <= 100000"
600 |         },
601 |         "check_visibility": {
602 |           "name": "check_visibility",
603 |           "value": "\"presets\".\"visibility\" IN ('private', 'shared')"
604 |         },
605 |         "check_web_search_context_size": {
606 |           "name": "check_web_search_context_size",
607 |           "value": "\"presets\".\"web_search_context_size\" IN ('low', 'medium', 'high')"
608 |         },
609 |         "check_share_id_format": {
610 |           "name": "check_share_id_format",
611 |           "value": "\"presets\".\"share_id\" IS NULL OR (char_length(\"presets\".\"share_id\") >= 20 AND char_length(\"presets\".\"share_id\") <= 50)"
612 |         }
613 |       },
614 |       "isRLSEnabled": false
615 |     },
616 |     "public.session": {
617 |       "name": "session",
618 |       "schema": "",
619 |       "columns": {
620 |         "id": {
621 |           "name": "id",
622 |           "type": "text",
623 |           "primaryKey": true,
624 |           "notNull": true
625 |         },
626 |         "sessionToken": {
627 |           "name": "sessionToken",
628 |           "type": "text",
629 |           "primaryKey": false,
630 |           "notNull": true
631 |         },
632 |         "userId": {
633 |           "name": "userId",
634 |           "type": "text",
635 |           "primaryKey": false,
636 |           "notNull": true
637 |         },
638 |         "expiresAt": {
639 |           "name": "expiresAt",
640 |           "type": "timestamp",
641 |           "primaryKey": false,
642 |           "notNull": true
643 |         },
644 |         "ipAddress": {
645 |           "name": "ipAddress",
646 |           "type": "text",
647 |           "primaryKey": false,
648 |           "notNull": false
649 |         },
650 |         "userAgent": {
651 |           "name": "userAgent",
652 |           "type": "text",
653 |           "primaryKey": false,
654 |           "notNull": false
655 |         },
656 |         "createdAt": {
657 |           "name": "createdAt",
658 |           "type": "timestamp",
659 |           "primaryKey": false,
660 |           "notNull": true,
661 |           "default": "now()"
662 |         },
663 |         "updatedAt": {
664 |           "name": "updatedAt",
665 |           "type": "timestamp",
666 |           "primaryKey": false,
667 |           "notNull": true,
668 |           "default": "now()"
669 |         }
670 |       },
671 |       "indexes": {},
672 |       "foreignKeys": {
673 |         "session_userId_user_id_fk": {
674 |           "name": "session_userId_user_id_fk",
675 |           "tableFrom": "session",
676 |           "tableTo": "user",
677 |           "columnsFrom": [
678 |             "userId"
679 |           ],
680 |           "columnsTo": [
681 |             "id"
682 |           ],
683 |           "onDelete": "cascade",
684 |           "onUpdate": "no action"
685 |         }
686 |       },
687 |       "compositePrimaryKeys": {},
688 |       "uniqueConstraints": {
689 |         "session_sessionToken_unique": {
690 |           "name": "session_sessionToken_unique",
691 |           "nullsNotDistinct": false,
692 |           "columns": [
693 |             "sessionToken"
694 |           ]
695 |         }
696 |       },
697 |       "policies": {},
698 |       "checkConstraints": {},
699 |       "isRLSEnabled": false
700 |     },
701 |     "public.user": {
702 |       "name": "user",
703 |       "schema": "",
704 |       "columns": {
705 |         "id": {
706 |           "name": "id",
707 |           "type": "text",
708 |           "primaryKey": true,
709 |           "notNull": true
710 |         },
711 |         "name": {
712 |           "name": "name",
713 |           "type": "text",
714 |           "primaryKey": false,
715 |           "notNull": false
716 |         },
717 |         "email": {
718 |           "name": "email",
719 |           "type": "text",
720 |           "primaryKey": false,
721 |           "notNull": true
722 |         },
723 |         "emailVerified": {
724 |           "name": "emailVerified",
725 |           "type": "boolean",
726 |           "primaryKey": false,
727 |           "notNull": false
728 |         },
729 |         "image": {
730 |           "name": "image",
731 |           "type": "text",
732 |           "primaryKey": false,
733 |           "notNull": false
734 |         },
735 |         "isAnonymous": {
736 |           "name": "isAnonymous",
737 |           "type": "boolean",
738 |           "primaryKey": false,
739 |           "notNull": false,
740 |           "default": false
741 |         },
742 |         "metadata": {
743 |           "name": "metadata",
744 |           "type": "json",
745 |           "primaryKey": false,
746 |           "notNull": false
747 |         },
748 |         "default_preset_id": {
749 |           "name": "default_preset_id",
750 |           "type": "text",
751 |           "primaryKey": false,
752 |           "notNull": false
753 |         },
754 |         "createdAt": {
755 |           "name": "createdAt",
756 |           "type": "timestamp",
757 |           "primaryKey": false,
758 |           "notNull": true,
759 |           "default": "now()"
760 |         },
761 |         "updatedAt": {
762 |           "name": "updatedAt",
763 |           "type": "timestamp",
764 |           "primaryKey": false,
765 |           "notNull": true,
766 |           "default": "now()"
767 |         }
768 |       },
769 |       "indexes": {},
770 |       "foreignKeys": {},
771 |       "compositePrimaryKeys": {},
772 |       "uniqueConstraints": {
773 |         "user_email_unique": {
774 |           "name": "user_email_unique",
775 |           "nullsNotDistinct": false,
776 |           "columns": [
777 |             "email"
778 |           ]
779 |         }
780 |       },
781 |       "policies": {},
782 |       "checkConstraints": {},
783 |       "isRLSEnabled": false
784 |     },
785 |     "public.verification": {
786 |       "name": "verification",
787 |       "schema": "",
788 |       "columns": {
789 |         "id": {
790 |           "name": "id",
791 |           "type": "text",
792 |           "primaryKey": true,
793 |           "notNull": true
794 |         },
795 |         "identifier": {
796 |           "name": "identifier",
797 |           "type": "text",
798 |           "primaryKey": false,
799 |           "notNull": true
800 |         },
801 |         "value": {
802 |           "name": "value",
803 |           "type": "text",
804 |           "primaryKey": false,
805 |           "notNull": true
806 |         },
807 |         "expiresAt": {
808 |           "name": "expiresAt",
809 |           "type": "timestamp",
810 |           "primaryKey": false,
811 |           "notNull": true
812 |         },
813 |         "createdAt": {
814 |           "name": "createdAt",
815 |           "type": "timestamp",
816 |           "primaryKey": false,
817 |           "notNull": true,
818 |           "default": "now()"
819 |         },
820 |         "updatedAt": {
821 |           "name": "updatedAt",
822 |           "type": "timestamp",
[TRUNCATED]
```

drizzle/meta/0025_snapshot.json
```
1 | {
2 |   "id": "2e2cba51-fbe5-49b9-898a-edac1c2adc14",
3 |   "prevId": "d89d5d62-2101-4acc-a6aa-724d95cf621a",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chats": {
121 |       "name": "chats",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "user_id": {
131 |           "name": "user_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "title": {
137 |           "name": "title",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true,
141 |           "default": "'New Chat'"
142 |         },
143 |         "created_at": {
144 |           "name": "created_at",
145 |           "type": "timestamp",
146 |           "primaryKey": false,
147 |           "notNull": true,
148 |           "default": "now()"
149 |         },
150 |         "updated_at": {
151 |           "name": "updated_at",
152 |           "type": "timestamp",
153 |           "primaryKey": false,
154 |           "notNull": true,
155 |           "default": "now()"
156 |         }
157 |       },
158 |       "indexes": {},
159 |       "foreignKeys": {},
160 |       "compositePrimaryKeys": {},
161 |       "uniqueConstraints": {},
162 |       "policies": {},
163 |       "checkConstraints": {},
164 |       "isRLSEnabled": false
165 |     },
166 |     "public.favorite_models": {
167 |       "name": "favorite_models",
168 |       "schema": "",
169 |       "columns": {
170 |         "id": {
171 |           "name": "id",
172 |           "type": "text",
173 |           "primaryKey": true,
174 |           "notNull": true
175 |         },
176 |         "user_id": {
177 |           "name": "user_id",
178 |           "type": "text",
179 |           "primaryKey": false,
180 |           "notNull": true
181 |         },
182 |         "model_id": {
183 |           "name": "model_id",
184 |           "type": "text",
185 |           "primaryKey": false,
186 |           "notNull": true
187 |         },
188 |         "created_at": {
189 |           "name": "created_at",
190 |           "type": "timestamp",
191 |           "primaryKey": false,
192 |           "notNull": true,
193 |           "default": "now()"
194 |         }
195 |       },
196 |       "indexes": {
197 |         "idx_favorite_models_user_id": {
198 |           "name": "idx_favorite_models_user_id",
199 |           "columns": [
200 |             {
201 |               "expression": "user_id",
202 |               "isExpression": false,
203 |               "asc": true,
204 |               "nulls": "last"
205 |             }
206 |           ],
207 |           "isUnique": false,
208 |           "concurrently": false,
209 |           "method": "btree",
210 |           "with": {}
211 |         },
212 |         "idx_favorite_models_model_id": {
213 |           "name": "idx_favorite_models_model_id",
214 |           "columns": [
215 |             {
216 |               "expression": "model_id",
217 |               "isExpression": false,
218 |               "asc": true,
219 |               "nulls": "last"
220 |             }
221 |           ],
222 |           "isUnique": false,
223 |           "concurrently": false,
224 |           "method": "btree",
225 |           "with": {}
226 |         }
227 |       },
228 |       "foreignKeys": {
229 |         "favorite_models_user_id_user_id_fk": {
230 |           "name": "favorite_models_user_id_user_id_fk",
231 |           "tableFrom": "favorite_models",
232 |           "tableTo": "user",
233 |           "columnsFrom": [
234 |             "user_id"
235 |           ],
236 |           "columnsTo": [
237 |             "id"
238 |           ],
239 |           "onDelete": "cascade",
240 |           "onUpdate": "no action"
241 |         }
242 |       },
243 |       "compositePrimaryKeys": {},
244 |       "uniqueConstraints": {
245 |         "unique_user_model": {
246 |           "name": "unique_user_model",
247 |           "nullsNotDistinct": false,
248 |           "columns": [
249 |             "user_id",
250 |             "model_id"
251 |           ]
252 |         }
253 |       },
254 |       "policies": {},
255 |       "checkConstraints": {},
256 |       "isRLSEnabled": false
257 |     },
258 |     "public.messages": {
259 |       "name": "messages",
260 |       "schema": "",
261 |       "columns": {
262 |         "id": {
263 |           "name": "id",
264 |           "type": "text",
265 |           "primaryKey": true,
266 |           "notNull": true
267 |         },
268 |         "chat_id": {
269 |           "name": "chat_id",
270 |           "type": "text",
271 |           "primaryKey": false,
272 |           "notNull": true
273 |         },
274 |         "role": {
275 |           "name": "role",
276 |           "type": "text",
277 |           "primaryKey": false,
278 |           "notNull": true
279 |         },
280 |         "parts": {
281 |           "name": "parts",
282 |           "type": "json",
283 |           "primaryKey": false,
284 |           "notNull": true
285 |         },
286 |         "has_web_search": {
287 |           "name": "has_web_search",
288 |           "type": "boolean",
289 |           "primaryKey": false,
290 |           "notNull": false,
291 |           "default": false
292 |         },
293 |         "web_search_context_size": {
294 |           "name": "web_search_context_size",
295 |           "type": "text",
296 |           "primaryKey": false,
297 |           "notNull": false,
298 |           "default": "'medium'"
299 |         },
300 |         "created_at": {
301 |           "name": "created_at",
302 |           "type": "timestamp",
303 |           "primaryKey": false,
304 |           "notNull": true,
305 |           "default": "now()"
306 |         }
307 |       },
308 |       "indexes": {},
309 |       "foreignKeys": {
310 |         "messages_chat_id_chats_id_fk": {
311 |           "name": "messages_chat_id_chats_id_fk",
312 |           "tableFrom": "messages",
313 |           "tableTo": "chats",
314 |           "columnsFrom": [
315 |             "chat_id"
316 |           ],
317 |           "columnsTo": [
318 |             "id"
319 |           ],
320 |           "onDelete": "cascade",
321 |           "onUpdate": "no action"
322 |         }
323 |       },
324 |       "compositePrimaryKeys": {},
325 |       "uniqueConstraints": {},
326 |       "policies": {},
327 |       "checkConstraints": {},
328 |       "isRLSEnabled": false
329 |     },
330 |     "public.polar_usage_events": {
331 |       "name": "polar_usage_events",
332 |       "schema": "",
333 |       "columns": {
334 |         "id": {
335 |           "name": "id",
336 |           "type": "text",
337 |           "primaryKey": true,
338 |           "notNull": true
339 |         },
340 |         "user_id": {
341 |           "name": "user_id",
342 |           "type": "text",
343 |           "primaryKey": false,
344 |           "notNull": true
345 |         },
346 |         "polar_customer_id": {
347 |           "name": "polar_customer_id",
348 |           "type": "text",
349 |           "primaryKey": false,
350 |           "notNull": false
351 |         },
352 |         "event_name": {
353 |           "name": "event_name",
354 |           "type": "text",
355 |           "primaryKey": false,
356 |           "notNull": true
357 |         },
358 |         "event_payload": {
359 |           "name": "event_payload",
360 |           "type": "json",
361 |           "primaryKey": false,
362 |           "notNull": true
363 |         },
364 |         "created_at": {
365 |           "name": "created_at",
366 |           "type": "timestamp",
367 |           "primaryKey": false,
368 |           "notNull": true,
369 |           "default": "now()"
370 |         }
371 |       },
372 |       "indexes": {},
373 |       "foreignKeys": {
374 |         "polar_usage_events_user_id_user_id_fk": {
375 |           "name": "polar_usage_events_user_id_user_id_fk",
376 |           "tableFrom": "polar_usage_events",
377 |           "tableTo": "user",
378 |           "columnsFrom": [
379 |             "user_id"
380 |           ],
381 |           "columnsTo": [
382 |             "id"
383 |           ],
384 |           "onDelete": "cascade",
385 |           "onUpdate": "no action"
386 |         }
387 |       },
388 |       "compositePrimaryKeys": {},
389 |       "uniqueConstraints": {},
390 |       "policies": {},
391 |       "checkConstraints": {},
392 |       "isRLSEnabled": false
393 |     },
394 |     "public.preset_usage": {
395 |       "name": "preset_usage",
396 |       "schema": "",
397 |       "columns": {
398 |         "id": {
399 |           "name": "id",
400 |           "type": "text",
401 |           "primaryKey": true,
402 |           "notNull": true
403 |         },
404 |         "preset_id": {
405 |           "name": "preset_id",
406 |           "type": "text",
407 |           "primaryKey": false,
408 |           "notNull": true
409 |         },
410 |         "user_id": {
411 |           "name": "user_id",
412 |           "type": "text",
413 |           "primaryKey": false,
414 |           "notNull": true
415 |         },
416 |         "chat_id": {
417 |           "name": "chat_id",
418 |           "type": "text",
419 |           "primaryKey": false,
420 |           "notNull": false
421 |         },
422 |         "used_at": {
423 |           "name": "used_at",
424 |           "type": "timestamp",
425 |           "primaryKey": false,
426 |           "notNull": true,
427 |           "default": "now()"
428 |         }
429 |       },
430 |       "indexes": {},
431 |       "foreignKeys": {
432 |         "preset_usage_preset_id_presets_id_fk": {
433 |           "name": "preset_usage_preset_id_presets_id_fk",
434 |           "tableFrom": "preset_usage",
435 |           "tableTo": "presets",
436 |           "columnsFrom": [
437 |             "preset_id"
438 |           ],
439 |           "columnsTo": [
440 |             "id"
441 |           ],
442 |           "onDelete": "cascade",
443 |           "onUpdate": "no action"
444 |         },
445 |         "preset_usage_user_id_user_id_fk": {
446 |           "name": "preset_usage_user_id_user_id_fk",
447 |           "tableFrom": "preset_usage",
448 |           "tableTo": "user",
449 |           "columnsFrom": [
450 |             "user_id"
451 |           ],
452 |           "columnsTo": [
453 |             "id"
454 |           ],
455 |           "onDelete": "cascade",
456 |           "onUpdate": "no action"
457 |         }
458 |       },
459 |       "compositePrimaryKeys": {},
460 |       "uniqueConstraints": {},
461 |       "policies": {},
462 |       "checkConstraints": {},
463 |       "isRLSEnabled": false
464 |     },
465 |     "public.presets": {
466 |       "name": "presets",
467 |       "schema": "",
468 |       "columns": {
469 |         "id": {
470 |           "name": "id",
471 |           "type": "text",
472 |           "primaryKey": true,
473 |           "notNull": true
474 |         },
475 |         "user_id": {
476 |           "name": "user_id",
477 |           "type": "text",
478 |           "primaryKey": false,
479 |           "notNull": true
480 |         },
481 |         "name": {
482 |           "name": "name",
483 |           "type": "text",
484 |           "primaryKey": false,
485 |           "notNull": true
486 |         },
487 |         "model_id": {
488 |           "name": "model_id",
489 |           "type": "text",
490 |           "primaryKey": false,
491 |           "notNull": true
492 |         },
493 |         "system_instruction": {
494 |           "name": "system_instruction",
495 |           "type": "text",
496 |           "primaryKey": false,
497 |           "notNull": true
498 |         },
499 |         "temperature": {
500 |           "name": "temperature",
501 |           "type": "integer",
502 |           "primaryKey": false,
503 |           "notNull": true
504 |         },
505 |         "max_tokens": {
506 |           "name": "max_tokens",
507 |           "type": "integer",
508 |           "primaryKey": false,
509 |           "notNull": true
510 |         },
511 |         "web_search_enabled": {
512 |           "name": "web_search_enabled",
513 |           "type": "boolean",
514 |           "primaryKey": false,
515 |           "notNull": false,
516 |           "default": false
517 |         },
518 |         "web_search_context_size": {
519 |           "name": "web_search_context_size",
520 |           "type": "text",
521 |           "primaryKey": false,
522 |           "notNull": false,
523 |           "default": "'medium'"
524 |         },
525 |         "api_key_preferences": {
526 |           "name": "api_key_preferences",
527 |           "type": "json",
528 |           "primaryKey": false,
529 |           "notNull": false,
530 |           "default": "'{}'::json"
531 |         },
532 |         "is_default": {
533 |           "name": "is_default",
534 |           "type": "boolean",
535 |           "primaryKey": false,
536 |           "notNull": false,
537 |           "default": false
538 |         },
539 |         "share_id": {
540 |           "name": "share_id",
541 |           "type": "text",
542 |           "primaryKey": false,
543 |           "notNull": false
544 |         },
545 |         "visibility": {
546 |           "name": "visibility",
547 |           "type": "text",
548 |           "primaryKey": false,
549 |           "notNull": false,
550 |           "default": "'private'"
551 |         },
552 |         "version": {
553 |           "name": "version",
554 |           "type": "integer",
555 |           "primaryKey": false,
556 |           "notNull": false,
557 |           "default": 1
558 |         },
559 |         "created_at": {
560 |           "name": "created_at",
561 |           "type": "timestamp",
562 |           "primaryKey": false,
563 |           "notNull": true,
564 |           "default": "now()"
565 |         },
566 |         "updated_at": {
567 |           "name": "updated_at",
568 |           "type": "timestamp",
569 |           "primaryKey": false,
570 |           "notNull": true,
571 |           "default": "now()"
572 |         },
573 |         "deleted_at": {
574 |           "name": "deleted_at",
575 |           "type": "timestamp",
576 |           "primaryKey": false,
577 |           "notNull": false
578 |         }
579 |       },
580 |       "indexes": {},
581 |       "foreignKeys": {
582 |         "presets_user_id_user_id_fk": {
583 |           "name": "presets_user_id_user_id_fk",
584 |           "tableFrom": "presets",
585 |           "tableTo": "user",
586 |           "columnsFrom": [
587 |             "user_id"
588 |           ],
589 |           "columnsTo": [
590 |             "id"
591 |           ],
592 |           "onDelete": "cascade",
593 |           "onUpdate": "no action"
594 |         }
595 |       },
596 |       "compositePrimaryKeys": {},
597 |       "uniqueConstraints": {
598 |         "presets_share_id_unique": {
599 |           "name": "presets_share_id_unique",
600 |           "nullsNotDistinct": false,
601 |           "columns": [
602 |             "share_id"
603 |           ]
604 |         },
605 |         "unique_name_per_user": {
606 |           "name": "unique_name_per_user",
607 |           "nullsNotDistinct": false,
608 |           "columns": [
609 |             "user_id",
610 |             "name"
611 |           ]
612 |         }
613 |       },
614 |       "policies": {},
615 |       "checkConstraints": {
616 |         "check_name_length": {
617 |           "name": "check_name_length",
618 |           "value": "char_length(\"presets\".\"name\") >= 1 AND char_length(\"presets\".\"name\") <= 100"
619 |         },
620 |         "check_system_instruction_length": {
621 |           "name": "check_system_instruction_length",
622 |           "value": "char_length(\"presets\".\"system_instruction\") >= 10 AND char_length(\"presets\".\"system_instruction\") <= 4000"
623 |         },
624 |         "check_temperature_range": {
625 |           "name": "check_temperature_range",
626 |           "value": "\"presets\".\"temperature\" >= 0 AND \"presets\".\"temperature\" <= 2000"
627 |         },
628 |         "check_max_tokens_range": {
629 |           "name": "check_max_tokens_range",
630 |           "value": "\"presets\".\"max_tokens\" > 0 AND \"presets\".\"max_tokens\" <= 100000"
631 |         },
632 |         "check_visibility": {
633 |           "name": "check_visibility",
634 |           "value": "\"presets\".\"visibility\" IN ('private', 'shared')"
635 |         },
636 |         "check_web_search_context_size": {
637 |           "name": "check_web_search_context_size",
638 |           "value": "\"presets\".\"web_search_context_size\" IN ('low', 'medium', 'high')"
639 |         },
640 |         "check_share_id_format": {
641 |           "name": "check_share_id_format",
642 |           "value": "\"presets\".\"share_id\" IS NULL OR (char_length(\"presets\".\"share_id\") >= 20 AND char_length(\"presets\".\"share_id\") <= 50)"
643 |         }
644 |       },
645 |       "isRLSEnabled": false
646 |     },
647 |     "public.session": {
648 |       "name": "session",
649 |       "schema": "",
650 |       "columns": {
651 |         "id": {
652 |           "name": "id",
653 |           "type": "text",
654 |           "primaryKey": true,
655 |           "notNull": true
656 |         },
657 |         "sessionToken": {
658 |           "name": "sessionToken",
659 |           "type": "text",
660 |           "primaryKey": false,
661 |           "notNull": true
662 |         },
663 |         "userId": {
664 |           "name": "userId",
665 |           "type": "text",
666 |           "primaryKey": false,
667 |           "notNull": true
668 |         },
669 |         "expiresAt": {
670 |           "name": "expiresAt",
671 |           "type": "timestamp",
672 |           "primaryKey": false,
673 |           "notNull": true
674 |         },
675 |         "ipAddress": {
676 |           "name": "ipAddress",
677 |           "type": "text",
678 |           "primaryKey": false,
679 |           "notNull": false
680 |         },
681 |         "userAgent": {
682 |           "name": "userAgent",
683 |           "type": "text",
684 |           "primaryKey": false,
685 |           "notNull": false
686 |         },
687 |         "createdAt": {
688 |           "name": "createdAt",
689 |           "type": "timestamp",
690 |           "primaryKey": false,
691 |           "notNull": true,
692 |           "default": "now()"
693 |         },
694 |         "updatedAt": {
695 |           "name": "updatedAt",
696 |           "type": "timestamp",
697 |           "primaryKey": false,
698 |           "notNull": true,
699 |           "default": "now()"
700 |         }
701 |       },
702 |       "indexes": {},
703 |       "foreignKeys": {
704 |         "session_userId_user_id_fk": {
705 |           "name": "session_userId_user_id_fk",
706 |           "tableFrom": "session",
707 |           "tableTo": "user",
708 |           "columnsFrom": [
709 |             "userId"
710 |           ],
711 |           "columnsTo": [
712 |             "id"
713 |           ],
714 |           "onDelete": "cascade",
715 |           "onUpdate": "no action"
716 |         }
717 |       },
718 |       "compositePrimaryKeys": {},
719 |       "uniqueConstraints": {
720 |         "session_sessionToken_unique": {
721 |           "name": "session_sessionToken_unique",
722 |           "nullsNotDistinct": false,
723 |           "columns": [
724 |             "sessionToken"
725 |           ]
726 |         }
727 |       },
728 |       "policies": {},
729 |       "checkConstraints": {},
730 |       "isRLSEnabled": false
731 |     },
732 |     "public.user": {
733 |       "name": "user",
734 |       "schema": "",
735 |       "columns": {
736 |         "id": {
737 |           "name": "id",
738 |           "type": "text",
739 |           "primaryKey": true,
740 |           "notNull": true
741 |         },
742 |         "name": {
743 |           "name": "name",
744 |           "type": "text",
745 |           "primaryKey": false,
746 |           "notNull": false
747 |         },
748 |         "email": {
749 |           "name": "email",
750 |           "type": "text",
751 |           "primaryKey": false,
752 |           "notNull": true
753 |         },
754 |         "emailVerified": {
755 |           "name": "emailVerified",
756 |           "type": "boolean",
757 |           "primaryKey": false,
758 |           "notNull": false
759 |         },
760 |         "image": {
761 |           "name": "image",
762 |           "type": "text",
763 |           "primaryKey": false,
764 |           "notNull": false
765 |         },
766 |         "isAnonymous": {
767 |           "name": "isAnonymous",
768 |           "type": "boolean",
769 |           "primaryKey": false,
770 |           "notNull": false,
771 |           "default": false
772 |         },
773 |         "metadata": {
774 |           "name": "metadata",
775 |           "type": "json",
776 |           "primaryKey": false,
777 |           "notNull": false
778 |         },
779 |         "default_preset_id": {
780 |           "name": "default_preset_id",
781 |           "type": "text",
782 |           "primaryKey": false,
783 |           "notNull": false
784 |         },
785 |         "createdAt": {
786 |           "name": "createdAt",
787 |           "type": "timestamp",
788 |           "primaryKey": false,
789 |           "notNull": true,
790 |           "default": "now()"
791 |         },
792 |         "updatedAt": {
793 |           "name": "updatedAt",
794 |           "type": "timestamp",
795 |           "primaryKey": false,
796 |           "notNull": true,
797 |           "default": "now()"
798 |         }
799 |       },
800 |       "indexes": {},
801 |       "foreignKeys": {},
802 |       "compositePrimaryKeys": {},
803 |       "uniqueConstraints": {
804 |         "user_email_unique": {
805 |           "name": "user_email_unique",
806 |           "nullsNotDistinct": false,
807 |           "columns": [
808 |             "email"
809 |           ]
810 |         }
811 |       },
812 |       "policies": {},
813 |       "checkConstraints": {},
814 |       "isRLSEnabled": false
815 |     },
816 |     "public.verification": {
817 |       "name": "verification",
818 |       "schema": "",
819 |       "columns": {
820 |         "id": {
[TRUNCATED]
```

drizzle/meta/0026_snapshot.json
```
1 | {
2 |   "id": "eda77d87-227e-4459-93a7-ce33d258812d",
3 |   "prevId": "2e2cba51-fbe5-49b9-898a-edac1c2adc14",
4 |   "version": "7",
5 |   "dialect": "postgresql",
6 |   "tables": {
7 |     "public.account": {
8 |       "name": "account",
9 |       "schema": "",
10 |       "columns": {
11 |         "id": {
12 |           "name": "id",
13 |           "type": "text",
14 |           "primaryKey": true,
15 |           "notNull": true
16 |         },
17 |         "userId": {
18 |           "name": "userId",
19 |           "type": "text",
20 |           "primaryKey": false,
21 |           "notNull": true
22 |         },
23 |         "providerId": {
24 |           "name": "providerId",
25 |           "type": "text",
26 |           "primaryKey": false,
27 |           "notNull": true
28 |         },
29 |         "accountId": {
30 |           "name": "accountId",
31 |           "type": "text",
32 |           "primaryKey": false,
33 |           "notNull": true
34 |         },
35 |         "providerType": {
36 |           "name": "providerType",
37 |           "type": "text",
38 |           "primaryKey": false,
39 |           "notNull": false
40 |         },
41 |         "access_token": {
42 |           "name": "access_token",
43 |           "type": "text",
44 |           "primaryKey": false,
45 |           "notNull": false
46 |         },
47 |         "refresh_token": {
48 |           "name": "refresh_token",
49 |           "type": "text",
50 |           "primaryKey": false,
51 |           "notNull": false
52 |         },
53 |         "access_token_expires_at": {
54 |           "name": "access_token_expires_at",
55 |           "type": "timestamp",
56 |           "primaryKey": false,
57 |           "notNull": false
58 |         },
59 |         "token_type": {
60 |           "name": "token_type",
61 |           "type": "text",
62 |           "primaryKey": false,
63 |           "notNull": false
64 |         },
65 |         "scope": {
66 |           "name": "scope",
67 |           "type": "text",
68 |           "primaryKey": false,
69 |           "notNull": false
70 |         },
71 |         "id_token": {
72 |           "name": "id_token",
73 |           "type": "text",
74 |           "primaryKey": false,
75 |           "notNull": false
76 |         },
77 |         "session_state": {
78 |           "name": "session_state",
79 |           "type": "text",
80 |           "primaryKey": false,
81 |           "notNull": false
82 |         },
83 |         "createdAt": {
84 |           "name": "createdAt",
85 |           "type": "timestamp",
86 |           "primaryKey": false,
87 |           "notNull": true,
88 |           "default": "now()"
89 |         },
90 |         "updatedAt": {
91 |           "name": "updatedAt",
92 |           "type": "timestamp",
93 |           "primaryKey": false,
94 |           "notNull": true,
95 |           "default": "now()"
96 |         }
97 |       },
98 |       "indexes": {},
99 |       "foreignKeys": {
100 |         "account_userId_user_id_fk": {
101 |           "name": "account_userId_user_id_fk",
102 |           "tableFrom": "account",
103 |           "tableTo": "user",
104 |           "columnsFrom": [
105 |             "userId"
106 |           ],
107 |           "columnsTo": [
108 |             "id"
109 |           ],
110 |           "onDelete": "cascade",
111 |           "onUpdate": "no action"
112 |         }
113 |       },
114 |       "compositePrimaryKeys": {},
115 |       "uniqueConstraints": {},
116 |       "policies": {},
117 |       "checkConstraints": {},
118 |       "isRLSEnabled": false
119 |     },
120 |     "public.chat_shares": {
121 |       "name": "chat_shares",
122 |       "schema": "",
123 |       "columns": {
124 |         "id": {
125 |           "name": "id",
126 |           "type": "text",
127 |           "primaryKey": true,
128 |           "notNull": true
129 |         },
130 |         "chat_id": {
131 |           "name": "chat_id",
132 |           "type": "text",
133 |           "primaryKey": false,
134 |           "notNull": true
135 |         },
136 |         "owner_user_id": {
137 |           "name": "owner_user_id",
138 |           "type": "text",
139 |           "primaryKey": false,
140 |           "notNull": true
141 |         },
142 |         "share_id": {
143 |           "name": "share_id",
144 |           "type": "text",
145 |           "primaryKey": false,
146 |           "notNull": true
147 |         },
148 |         "status": {
149 |           "name": "status",
150 |           "type": "text",
151 |           "primaryKey": false,
152 |           "notNull": true,
153 |           "default": "'active'"
154 |         },
155 |         "visibility": {
156 |           "name": "visibility",
157 |           "type": "text",
158 |           "primaryKey": false,
159 |           "notNull": true,
160 |           "default": "'unlisted'"
161 |         },
162 |         "snapshot_json": {
163 |           "name": "snapshot_json",
164 |           "type": "json",
165 |           "primaryKey": false,
166 |           "notNull": true
167 |         },
168 |         "view_count": {
169 |           "name": "view_count",
170 |           "type": "integer",
171 |           "primaryKey": false,
172 |           "notNull": true,
173 |           "default": 0
174 |         },
175 |         "created_at": {
176 |           "name": "created_at",
177 |           "type": "timestamp",
178 |           "primaryKey": false,
179 |           "notNull": true,
180 |           "default": "now()"
181 |         },
182 |         "revoked_at": {
183 |           "name": "revoked_at",
184 |           "type": "timestamp",
185 |           "primaryKey": false,
186 |           "notNull": false
187 |         }
188 |       },
189 |       "indexes": {
190 |         "idx_chat_shares_chat_id_status": {
191 |           "name": "idx_chat_shares_chat_id_status",
192 |           "columns": [
193 |             {
194 |               "expression": "chat_id",
195 |               "isExpression": false,
196 |               "asc": true,
197 |               "nulls": "last"
198 |             },
199 |             {
200 |               "expression": "status",
201 |               "isExpression": false,
202 |               "asc": true,
203 |               "nulls": "last"
204 |             }
205 |           ],
206 |           "isUnique": false,
207 |           "concurrently": false,
208 |           "method": "btree",
209 |           "with": {}
210 |         },
211 |         "idx_chat_shares_owner_user_id_status": {
212 |           "name": "idx_chat_shares_owner_user_id_status",
213 |           "columns": [
214 |             {
215 |               "expression": "owner_user_id",
216 |               "isExpression": false,
217 |               "asc": true,
218 |               "nulls": "last"
219 |             },
220 |             {
221 |               "expression": "status",
222 |               "isExpression": false,
223 |               "asc": true,
224 |               "nulls": "last"
225 |             }
226 |           ],
227 |           "isUnique": false,
228 |           "concurrently": false,
229 |           "method": "btree",
230 |           "with": {}
231 |         }
232 |       },
233 |       "foreignKeys": {
234 |         "chat_shares_chat_id_chats_id_fk": {
235 |           "name": "chat_shares_chat_id_chats_id_fk",
236 |           "tableFrom": "chat_shares",
237 |           "tableTo": "chats",
238 |           "columnsFrom": [
239 |             "chat_id"
240 |           ],
241 |           "columnsTo": [
242 |             "id"
243 |           ],
244 |           "onDelete": "cascade",
245 |           "onUpdate": "no action"
246 |         },
247 |         "chat_shares_owner_user_id_user_id_fk": {
248 |           "name": "chat_shares_owner_user_id_user_id_fk",
249 |           "tableFrom": "chat_shares",
250 |           "tableTo": "user",
251 |           "columnsFrom": [
252 |             "owner_user_id"
253 |           ],
254 |           "columnsTo": [
255 |             "id"
256 |           ],
257 |           "onDelete": "cascade",
258 |           "onUpdate": "no action"
259 |         }
260 |       },
261 |       "compositePrimaryKeys": {},
262 |       "uniqueConstraints": {
263 |         "chat_shares_share_id_unique": {
264 |           "name": "chat_shares_share_id_unique",
265 |           "nullsNotDistinct": false,
266 |           "columns": [
267 |             "share_id"
268 |           ]
269 |         }
270 |       },
271 |       "policies": {},
272 |       "checkConstraints": {
273 |         "check_chat_shares_status": {
274 |           "name": "check_chat_shares_status",
275 |           "value": "\"chat_shares\".\"status\" IN ('active','revoked')"
276 |         },
277 |         "check_chat_shares_visibility": {
278 |           "name": "check_chat_shares_visibility",
279 |           "value": "\"chat_shares\".\"visibility\" IN ('unlisted')"
280 |         },
281 |         "check_chat_shares_share_id_format": {
282 |           "name": "check_chat_shares_share_id_format",
283 |           "value": "char_length(\"chat_shares\".\"share_id\") >= 20 AND char_length(\"chat_shares\".\"share_id\") <= 64"
284 |         }
285 |       },
286 |       "isRLSEnabled": false
287 |     },
288 |     "public.chats": {
289 |       "name": "chats",
290 |       "schema": "",
291 |       "columns": {
292 |         "id": {
293 |           "name": "id",
294 |           "type": "text",
295 |           "primaryKey": true,
296 |           "notNull": true
297 |         },
298 |         "user_id": {
299 |           "name": "user_id",
300 |           "type": "text",
301 |           "primaryKey": false,
302 |           "notNull": true
303 |         },
304 |         "title": {
305 |           "name": "title",
306 |           "type": "text",
307 |           "primaryKey": false,
308 |           "notNull": true,
309 |           "default": "'New Chat'"
310 |         },
311 |         "created_at": {
312 |           "name": "created_at",
313 |           "type": "timestamp",
314 |           "primaryKey": false,
315 |           "notNull": true,
316 |           "default": "now()"
317 |         },
318 |         "updated_at": {
319 |           "name": "updated_at",
320 |           "type": "timestamp",
321 |           "primaryKey": false,
322 |           "notNull": true,
323 |           "default": "now()"
324 |         }
325 |       },
326 |       "indexes": {},
327 |       "foreignKeys": {},
328 |       "compositePrimaryKeys": {},
329 |       "uniqueConstraints": {},
330 |       "policies": {},
331 |       "checkConstraints": {},
332 |       "isRLSEnabled": false
333 |     },
334 |     "public.favorite_models": {
335 |       "name": "favorite_models",
336 |       "schema": "",
337 |       "columns": {
338 |         "id": {
339 |           "name": "id",
340 |           "type": "text",
341 |           "primaryKey": true,
342 |           "notNull": true
343 |         },
344 |         "user_id": {
345 |           "name": "user_id",
346 |           "type": "text",
347 |           "primaryKey": false,
348 |           "notNull": true
349 |         },
350 |         "model_id": {
351 |           "name": "model_id",
352 |           "type": "text",
353 |           "primaryKey": false,
354 |           "notNull": true
355 |         },
356 |         "created_at": {
357 |           "name": "created_at",
358 |           "type": "timestamp",
359 |           "primaryKey": false,
360 |           "notNull": true,
361 |           "default": "now()"
362 |         }
363 |       },
364 |       "indexes": {
365 |         "idx_favorite_models_user_id": {
366 |           "name": "idx_favorite_models_user_id",
367 |           "columns": [
368 |             {
369 |               "expression": "user_id",
370 |               "isExpression": false,
371 |               "asc": true,
372 |               "nulls": "last"
373 |             }
374 |           ],
375 |           "isUnique": false,
376 |           "concurrently": false,
377 |           "method": "btree",
378 |           "with": {}
379 |         },
380 |         "idx_favorite_models_model_id": {
381 |           "name": "idx_favorite_models_model_id",
382 |           "columns": [
383 |             {
384 |               "expression": "model_id",
385 |               "isExpression": false,
386 |               "asc": true,
387 |               "nulls": "last"
388 |             }
389 |           ],
390 |           "isUnique": false,
391 |           "concurrently": false,
392 |           "method": "btree",
393 |           "with": {}
394 |         }
395 |       },
396 |       "foreignKeys": {
397 |         "favorite_models_user_id_user_id_fk": {
398 |           "name": "favorite_models_user_id_user_id_fk",
399 |           "tableFrom": "favorite_models",
400 |           "tableTo": "user",
401 |           "columnsFrom": [
402 |             "user_id"
403 |           ],
404 |           "columnsTo": [
405 |             "id"
406 |           ],
407 |           "onDelete": "cascade",
408 |           "onUpdate": "no action"
409 |         }
410 |       },
411 |       "compositePrimaryKeys": {},
412 |       "uniqueConstraints": {
413 |         "unique_user_model": {
414 |           "name": "unique_user_model",
415 |           "nullsNotDistinct": false,
416 |           "columns": [
417 |             "user_id",
418 |             "model_id"
419 |           ]
420 |         }
421 |       },
422 |       "policies": {},
423 |       "checkConstraints": {},
424 |       "isRLSEnabled": false
425 |     },
426 |     "public.messages": {
427 |       "name": "messages",
428 |       "schema": "",
429 |       "columns": {
430 |         "id": {
431 |           "name": "id",
432 |           "type": "text",
433 |           "primaryKey": true,
434 |           "notNull": true
435 |         },
436 |         "chat_id": {
437 |           "name": "chat_id",
438 |           "type": "text",
439 |           "primaryKey": false,
440 |           "notNull": true
441 |         },
442 |         "role": {
443 |           "name": "role",
444 |           "type": "text",
445 |           "primaryKey": false,
446 |           "notNull": true
447 |         },
448 |         "parts": {
449 |           "name": "parts",
450 |           "type": "json",
451 |           "primaryKey": false,
452 |           "notNull": true
453 |         },
454 |         "has_web_search": {
455 |           "name": "has_web_search",
456 |           "type": "boolean",
457 |           "primaryKey": false,
458 |           "notNull": false,
459 |           "default": false
460 |         },
461 |         "web_search_context_size": {
462 |           "name": "web_search_context_size",
463 |           "type": "text",
464 |           "primaryKey": false,
465 |           "notNull": false,
466 |           "default": "'medium'"
467 |         },
468 |         "created_at": {
469 |           "name": "created_at",
470 |           "type": "timestamp",
471 |           "primaryKey": false,
472 |           "notNull": true,
473 |           "default": "now()"
474 |         }
475 |       },
476 |       "indexes": {},
477 |       "foreignKeys": {
478 |         "messages_chat_id_chats_id_fk": {
479 |           "name": "messages_chat_id_chats_id_fk",
480 |           "tableFrom": "messages",
481 |           "tableTo": "chats",
482 |           "columnsFrom": [
483 |             "chat_id"
484 |           ],
485 |           "columnsTo": [
486 |             "id"
487 |           ],
488 |           "onDelete": "cascade",
489 |           "onUpdate": "no action"
490 |         }
491 |       },
492 |       "compositePrimaryKeys": {},
493 |       "uniqueConstraints": {},
494 |       "policies": {},
495 |       "checkConstraints": {},
496 |       "isRLSEnabled": false
497 |     },
498 |     "public.polar_usage_events": {
499 |       "name": "polar_usage_events",
500 |       "schema": "",
501 |       "columns": {
502 |         "id": {
503 |           "name": "id",
504 |           "type": "text",
505 |           "primaryKey": true,
506 |           "notNull": true
507 |         },
508 |         "user_id": {
509 |           "name": "user_id",
510 |           "type": "text",
511 |           "primaryKey": false,
512 |           "notNull": true
513 |         },
514 |         "polar_customer_id": {
515 |           "name": "polar_customer_id",
516 |           "type": "text",
517 |           "primaryKey": false,
518 |           "notNull": false
519 |         },
520 |         "event_name": {
521 |           "name": "event_name",
522 |           "type": "text",
523 |           "primaryKey": false,
524 |           "notNull": true
525 |         },
526 |         "event_payload": {
527 |           "name": "event_payload",
528 |           "type": "json",
529 |           "primaryKey": false,
530 |           "notNull": true
531 |         },
532 |         "created_at": {
533 |           "name": "created_at",
534 |           "type": "timestamp",
535 |           "primaryKey": false,
536 |           "notNull": true,
537 |           "default": "now()"
538 |         }
539 |       },
540 |       "indexes": {},
541 |       "foreignKeys": {
542 |         "polar_usage_events_user_id_user_id_fk": {
543 |           "name": "polar_usage_events_user_id_user_id_fk",
544 |           "tableFrom": "polar_usage_events",
545 |           "tableTo": "user",
546 |           "columnsFrom": [
547 |             "user_id"
548 |           ],
549 |           "columnsTo": [
550 |             "id"
551 |           ],
552 |           "onDelete": "cascade",
553 |           "onUpdate": "no action"
554 |         }
555 |       },
556 |       "compositePrimaryKeys": {},
557 |       "uniqueConstraints": {},
558 |       "policies": {},
559 |       "checkConstraints": {},
560 |       "isRLSEnabled": false
561 |     },
562 |     "public.preset_usage": {
563 |       "name": "preset_usage",
564 |       "schema": "",
565 |       "columns": {
566 |         "id": {
567 |           "name": "id",
568 |           "type": "text",
569 |           "primaryKey": true,
570 |           "notNull": true
571 |         },
572 |         "preset_id": {
573 |           "name": "preset_id",
574 |           "type": "text",
575 |           "primaryKey": false,
576 |           "notNull": true
577 |         },
578 |         "user_id": {
579 |           "name": "user_id",
580 |           "type": "text",
581 |           "primaryKey": false,
582 |           "notNull": true
583 |         },
584 |         "chat_id": {
585 |           "name": "chat_id",
586 |           "type": "text",
587 |           "primaryKey": false,
588 |           "notNull": false
589 |         },
590 |         "used_at": {
591 |           "name": "used_at",
592 |           "type": "timestamp",
593 |           "primaryKey": false,
594 |           "notNull": true,
595 |           "default": "now()"
596 |         }
597 |       },
598 |       "indexes": {},
599 |       "foreignKeys": {
600 |         "preset_usage_preset_id_presets_id_fk": {
601 |           "name": "preset_usage_preset_id_presets_id_fk",
602 |           "tableFrom": "preset_usage",
603 |           "tableTo": "presets",
604 |           "columnsFrom": [
605 |             "preset_id"
606 |           ],
607 |           "columnsTo": [
608 |             "id"
609 |           ],
610 |           "onDelete": "cascade",
611 |           "onUpdate": "no action"
612 |         },
613 |         "preset_usage_user_id_user_id_fk": {
614 |           "name": "preset_usage_user_id_user_id_fk",
615 |           "tableFrom": "preset_usage",
616 |           "tableTo": "user",
617 |           "columnsFrom": [
618 |             "user_id"
619 |           ],
620 |           "columnsTo": [
621 |             "id"
622 |           ],
623 |           "onDelete": "cascade",
624 |           "onUpdate": "no action"
625 |         }
626 |       },
627 |       "compositePrimaryKeys": {},
628 |       "uniqueConstraints": {},
629 |       "policies": {},
630 |       "checkConstraints": {},
631 |       "isRLSEnabled": false
632 |     },
633 |     "public.presets": {
634 |       "name": "presets",
635 |       "schema": "",
636 |       "columns": {
637 |         "id": {
638 |           "name": "id",
639 |           "type": "text",
640 |           "primaryKey": true,
641 |           "notNull": true
642 |         },
643 |         "user_id": {
644 |           "name": "user_id",
645 |           "type": "text",
646 |           "primaryKey": false,
647 |           "notNull": true
648 |         },
649 |         "name": {
650 |           "name": "name",
651 |           "type": "text",
652 |           "primaryKey": false,
653 |           "notNull": true
654 |         },
655 |         "model_id": {
656 |           "name": "model_id",
657 |           "type": "text",
658 |           "primaryKey": false,
659 |           "notNull": true
660 |         },
661 |         "system_instruction": {
662 |           "name": "system_instruction",
663 |           "type": "text",
664 |           "primaryKey": false,
665 |           "notNull": true
666 |         },
667 |         "temperature": {
668 |           "name": "temperature",
669 |           "type": "integer",
670 |           "primaryKey": false,
671 |           "notNull": true
672 |         },
673 |         "max_tokens": {
674 |           "name": "max_tokens",
675 |           "type": "integer",
676 |           "primaryKey": false,
677 |           "notNull": true
678 |         },
679 |         "web_search_enabled": {
680 |           "name": "web_search_enabled",
681 |           "type": "boolean",
682 |           "primaryKey": false,
683 |           "notNull": false,
684 |           "default": false
685 |         },
686 |         "web_search_context_size": {
687 |           "name": "web_search_context_size",
688 |           "type": "text",
689 |           "primaryKey": false,
690 |           "notNull": false,
691 |           "default": "'medium'"
692 |         },
693 |         "api_key_preferences": {
694 |           "name": "api_key_preferences",
695 |           "type": "json",
696 |           "primaryKey": false,
697 |           "notNull": false,
698 |           "default": "'{}'::json"
699 |         },
700 |         "is_default": {
701 |           "name": "is_default",
702 |           "type": "boolean",
703 |           "primaryKey": false,
704 |           "notNull": false,
705 |           "default": false
706 |         },
707 |         "share_id": {
708 |           "name": "share_id",
709 |           "type": "text",
710 |           "primaryKey": false,
711 |           "notNull": false
712 |         },
713 |         "visibility": {
714 |           "name": "visibility",
715 |           "type": "text",
716 |           "primaryKey": false,
717 |           "notNull": false,
718 |           "default": "'private'"
719 |         },
720 |         "version": {
721 |           "name": "version",
722 |           "type": "integer",
723 |           "primaryKey": false,
724 |           "notNull": false,
725 |           "default": 1
726 |         },
727 |         "created_at": {
728 |           "name": "created_at",
729 |           "type": "timestamp",
730 |           "primaryKey": false,
731 |           "notNull": true,
732 |           "default": "now()"
733 |         },
734 |         "updated_at": {
735 |           "name": "updated_at",
736 |           "type": "timestamp",
737 |           "primaryKey": false,
738 |           "notNull": true,
739 |           "default": "now()"
740 |         },
741 |         "deleted_at": {
742 |           "name": "deleted_at",
743 |           "type": "timestamp",
744 |           "primaryKey": false,
745 |           "notNull": false
746 |         }
747 |       },
748 |       "indexes": {},
749 |       "foreignKeys": {
750 |         "presets_user_id_user_id_fk": {
751 |           "name": "presets_user_id_user_id_fk",
752 |           "tableFrom": "presets",
753 |           "tableTo": "user",
754 |           "columnsFrom": [
755 |             "user_id"
756 |           ],
757 |           "columnsTo": [
758 |             "id"
759 |           ],
760 |           "onDelete": "cascade",
761 |           "onUpdate": "no action"
762 |         }
763 |       },
764 |       "compositePrimaryKeys": {},
765 |       "uniqueConstraints": {
766 |         "presets_share_id_unique": {
767 |           "name": "presets_share_id_unique",
768 |           "nullsNotDistinct": false,
769 |           "columns": [
770 |             "share_id"
771 |           ]
772 |         },
773 |         "unique_name_per_user": {
774 |           "name": "unique_name_per_user",
775 |           "nullsNotDistinct": false,
776 |           "columns": [
777 |             "user_id",
778 |             "name"
779 |           ]
780 |         }
781 |       },
782 |       "policies": {},
783 |       "checkConstraints": {
784 |         "check_name_length": {
785 |           "name": "check_name_length",
786 |           "value": "char_length(\"presets\".\"name\") >= 1 AND char_length(\"presets\".\"name\") <= 100"
787 |         },
788 |         "check_system_instruction_length": {
789 |           "name": "check_system_instruction_length",
790 |           "value": "char_length(\"presets\".\"system_instruction\") >= 10 AND char_length(\"presets\".\"system_instruction\") <= 4000"
791 |         },
792 |         "check_temperature_range": {
793 |           "name": "check_temperature_range",
794 |           "value": "\"presets\".\"temperature\" >= 0 AND \"presets\".\"temperature\" <= 2000"
795 |         },
796 |         "check_max_tokens_range": {
797 |           "name": "check_max_tokens_range",
798 |           "value": "\"presets\".\"max_tokens\" > 0 AND \"presets\".\"max_tokens\" <= 100000"
799 |         },
800 |         "check_visibility": {
801 |           "name": "check_visibility",
[TRUNCATED]
```

drizzle/meta/_journal.json
```
1 | {
2 |   "version": "7",
3 |   "dialect": "postgresql",
4 |   "entries": [
5 |     {
6 |       "idx": 0,
7 |       "version": "7",
8 |       "when": 1714107718166,
9 |       "tag": "0000_supreme_rocket_raccoon",
10 |       "breakpoints": true
11 |     },
12 |     {
13 |       "idx": 1,
14 |       "version": "7",
15 |       "when": 1714107757731,
16 |       "tag": "0001_curious_paper_doll",
17 |       "breakpoints": true
18 |     },
19 |     {
20 |       "idx": 2,
21 |       "version": "7",
22 |       "when": 1714118290945,
23 |       "tag": "0002_free_cobalt_man",
24 |       "breakpoints": true
25 |     },
26 |     {
27 |       "idx": 3,
28 |       "version": "7",
29 |       "when": 1714118653673,
30 |       "tag": "0003_oval_energizer",
31 |       "breakpoints": true
32 |     },
33 |     {
34 |       "idx": 4,
35 |       "version": "7",
36 |       "when": 1714119167990,
37 |       "tag": "0004_tense_ricochet",
38 |       "breakpoints": true
39 |     },
40 |     {
41 |       "idx": 5,
42 |       "version": "7",
43 |       "when": 1714119273465,
44 |       "tag": "0005_early_payback",
45 |       "breakpoints": true
46 |     },
47 |     {
48 |       "idx": 7,
49 |       "version": "7",
50 |       "when": 1714298017000,
51 |       "tag": "0007_update_verification_table",
52 |       "breakpoints": true
53 |     },
54 |     {
55 |       "idx": 8,
56 |       "version": "7",
57 |       "when": 1745834185624,
58 |       "tag": "0008_alter_accounts_expiresat_type",
59 |       "breakpoints": true
60 |     },
61 |     {
62 |       "idx": 9,
63 |       "version": "7",
64 |       "when": 1745834300128,
65 |       "tag": "0009_alter_users_emailverified_type",
66 |       "breakpoints": true
67 |     },
68 |     {
69 |       "idx": 10,
70 |       "version": "7",
71 |       "when": 1745834584741,
72 |       "tag": "0010_optimal_jane_foster",
73 |       "breakpoints": true
74 |     },
75 |     {
76 |       "idx": 11,
77 |       "version": "7",
78 |       "when": 1745834720342,
79 |       "tag": "0011_fixed_cerebro",
80 |       "breakpoints": true
81 |     },
82 |     {
83 |       "idx": 12,
84 |       "version": "7",
85 |       "when": 1745834874412,
86 |       "tag": "0012_tearful_misty_knight",
87 |       "breakpoints": true
88 |     },
89 |     {
90 |       "idx": 13,
91 |       "version": "7",
92 |       "when": 1745834973270,
93 |       "tag": "0013_special_whirlwind",
94 |       "breakpoints": true
95 |     },
96 |     {
97 |       "idx": 14,
98 |       "version": "7",
99 |       "when": 1745835071348,
100 |       "tag": "0014_fair_praxagora",
101 |       "breakpoints": true
102 |     },
103 |     {
104 |       "idx": 15,
105 |       "version": "7",
106 |       "when": 1745835182901,
107 |       "tag": "0015_remarkable_owl",
108 |       "breakpoints": true
109 |     },
110 |     {
111 |       "idx": 16,
112 |       "version": "7",
113 |       "when": 1745835444568,
114 |       "tag": "0016_cooing_lester",
115 |       "breakpoints": true
116 |     },
117 |     {
118 |       "idx": 17,
119 |       "version": "7",
120 |       "when": 1746085513975,
121 |       "tag": "0017_past_bromley",
122 |       "breakpoints": true
123 |     },
124 |     {
125 |       "idx": 18,
126 |       "version": "7",
127 |       "when": 1746951564021,
128 |       "tag": "0018_conscious_dragon_man",
129 |       "breakpoints": true
130 |     },
131 |     {
132 |       "idx": 19,
133 |       "version": "7",
134 |       "when": 1746951600000,
135 |       "tag": "0019_fix_session_token",
136 |       "breakpoints": true
137 |     },
138 |     {
139 |       "idx": 20,
140 |       "version": "7",
141 |       "when": 1747039395770,
142 |       "tag": "0020_rainy_rockslide",
143 |       "breakpoints": true
144 |     },
145 |     {
146 |       "idx": 21,
147 |       "version": "7",
148 |       "when": 1747045302354,
149 |       "tag": "0021_aberrant_baron_zemo",
150 |       "breakpoints": true
151 |     },
152 |     {
153 |       "idx": 22,
154 |       "version": "7",
155 |       "when": 1753164905287,
156 |       "tag": "0022_add_presets_tables",
157 |       "breakpoints": true
158 |     },
159 |     {
160 |       "idx": 23,
161 |       "version": "7",
162 |       "when": 1753164905288,
163 |       "tag": "0023_remove_one_default_per_user_constraint",
164 |       "breakpoints": true
165 |     },
166 |     {
167 |       "idx": 24,
168 |       "version": "7",
169 |       "when": 1753697235988,
170 |       "tag": "0024_light_terror",
171 |       "breakpoints": true
172 |     },
173 |     {
174 |       "idx": 25,
175 |       "version": "7",
176 |       "when": 1753697266625,
177 |       "tag": "0025_flaky_thing",
178 |       "breakpoints": true
179 |     },
180 |     {
181 |       "idx": 26,
182 |       "version": "7",
183 |       "when": 1754039935489,
184 |       "tag": "0026_previous_patch",
185 |       "breakpoints": true
186 |     }
187 |   ]
188 | }
```

drizzle/migrations/0003_add_web_search.sql
```
1 | -- Add web search columns to messages table
2 | ALTER TABLE messages
3 | ADD COLUMN has_web_search boolean DEFAULT false,
4 | ADD COLUMN web_search_context_size text DEFAULT 'medium';
5 | 
6 | -- Update existing messages to have default values
7 | UPDATE messages 
8 | SET has_web_search = false,
9 |     web_search_context_size = 'medium'
10 | WHERE has_web_search IS NULL; 
```

lib/context/auth-context.tsx
```
1 | "use client";
2 | 
3 | import { createContext, useContext, useEffect, useState, useCallback, ReactNode } from 'react';
4 | import { useSession as useSessionOriginal, signIn as signInOriginal, signOut as signOutOriginal } from '@/lib/auth-client';
5 | 
6 | interface AuthUser {
7 |   id: string;
8 |   name: string | null;
9 |   email: string | null;
10 |   image: string | null;
11 |   isAnonymous: boolean;
12 |   hasSubscription: boolean;
13 |   messageLimit: number;
14 |   messageRemaining: number;
15 |   credits?: number;
16 |   hasCredits?: boolean;
17 |   usedCredits?: boolean;
18 | }
19 | 
20 | interface UsageData {
21 |   limit: number;
22 |   used: number;
23 |   remaining: number;
24 |   credits: number;
25 |   hasCredits: boolean;
26 |   usedCredits: boolean;
27 |   lastFetched: number;
28 | }
29 | 
30 | interface AuthContextType {
31 |   user: AuthUser | null;
32 |   session: any;
33 |   isPending: boolean;
34 |   status: 'loading' | 'authenticated' | 'anonymous' | 'unauthenticated';
35 |   usageData: UsageData | null;
36 |   refetchUsage: () => Promise<void>;
37 |   error: Error | null;
38 |   signIn: () => Promise<void>;
39 |   signOut: () => Promise<void>;
40 |   refreshMessageUsage: () => Promise<void>;
41 |   isLoading: boolean;
42 |   isAuthenticated: boolean;
43 |   isAnonymous: boolean;
44 | }
45 | 
46 | const AuthContext = createContext<AuthContextType | null>(null);
47 | 
48 | export function AuthProvider({ children }: { children: ReactNode }) {
49 |   const { data: session, isPending } = useSessionOriginal(); // Single useSession call
50 |   const [user, setUser] = useState<AuthUser | null>(null);
51 |   const [usageData, setUsageData] = useState<UsageData | null>(null);
52 |   const [status, setStatus] = useState<AuthContextType['status']>('loading');
53 |   const [error, setError] = useState<Error | null>(null);
54 | 
55 |   // Centralized usage data fetching with proper caching
56 |   const fetchUsageData = useCallback(async () => {
57 |     // Skip if no user or data is fresh (< 5 minutes old)
58 |     if (!session?.user?.id || (usageData?.lastFetched && usageData.lastFetched > Date.now() - 300000)) {
59 |       return;
60 |     }
61 | 
62 |     try {
63 |       const response = await fetch('/api/usage/messages');
64 |       if (response.ok) {
65 |         const data = await response.json();
66 |         setUsageData({
67 |           limit: data.limit,
68 |           used: data.limit - data.remaining,
69 |           remaining: data.remaining,
70 |           credits: data.credits || 0,
71 |           hasCredits: data.hasCredits || false,
72 |           usedCredits: data.usedCredits || false,
73 |           lastFetched: Date.now(),
74 |         });
75 |       }
76 |     } catch (error) {
77 |       console.error('Failed to fetch usage data:', error);
78 |     }
79 |   }, [session?.user?.id, usageData?.lastFetched]);
80 | 
81 |   // Single effect to manage auth state
82 |   useEffect(() => {
83 |     if (isPending) {
84 |       setStatus('loading');
85 |       return;
86 |     }
87 | 
88 |     if (session?.user?.id) {
89 |       const isAnonymous = (session.user as any).isAnonymous === true;
90 |       
91 |       setUser({
92 |         id: session.user.id,
93 |         name: session.user.name || null,
94 |         email: session.user.email || null,
95 |         image: session.user.image || null,
96 |         isAnonymous,
97 |         hasSubscription: !!(session.user as any)?.metadata?.hasSubscription,
98 |         messageLimit: isAnonymous ? 10 : 20,
99 |         messageRemaining: usageData?.remaining || 0,
100 |         credits: usageData?.credits,
101 |         hasCredits: usageData?.hasCredits,
102 |         usedCredits: usageData?.usedCredits,
103 |       });
104 |       
105 |       setStatus(isAnonymous ? 'anonymous' : 'authenticated');
106 |       setError(null);
107 |       
108 |       // Fetch usage data when user is available
109 |       fetchUsageData();
110 |     } else {
111 |       setUser(null);
112 |       setUsageData(null);
113 |       setStatus('unauthenticated');
114 |     }
115 |   }, [session, isPending, fetchUsageData, usageData]);
116 | 
117 |   // Sign in with Google
118 |   const handleSignIn = useCallback(async () => {
119 |     try {
120 |       await signInOriginal.social({
121 |         provider: 'google',
122 |         callbackURL: window.location.origin
123 |       });
124 |     } catch (err) {
125 |       setError(err instanceof Error ? err : new Error(String(err)));
126 |     }
127 |   }, []);
128 | 
129 |   // Sign out
130 |   const handleSignOut = useCallback(async () => {
131 |     try {
132 |       await signOutOriginal();
133 |       // Refresh the page to get new anonymous session
134 |       window.location.reload();
135 |     } catch (err) {
136 |       setError(err instanceof Error ? err : new Error(String(err)));
137 |     }
138 |   }, []);
139 | 
140 |   const value: AuthContextType = {
141 |     user,
142 |     session,
143 |     isPending,
144 |     status,
145 |     usageData,
146 |     refetchUsage: fetchUsageData,
147 |     refreshMessageUsage: fetchUsageData, // Alias for backward compatibility
148 |     error,
149 |     signIn: handleSignIn,
150 |     signOut: handleSignOut,
151 |     isLoading: status === 'loading',
152 |     isAuthenticated: status === 'authenticated',
153 |     isAnonymous: status === 'anonymous',
154 |   };
155 | 
156 |   return (
157 |     <AuthContext.Provider value={value}>
158 |       {children}
159 |     </AuthContext.Provider>
160 |   );
161 | }
162 | 
163 | // Custom hook to use auth context
164 | export function useAuth() {
165 |   const context = useContext(AuthContext);
166 |   if (!context) {
167 |     throw new Error('useAuth must be used within AuthProvider');
168 |   }
169 |   return context;
170 | }
171 | 
172 | // Export original useSession for migration purposes
173 | export { useSessionOriginal };
```

lib/context/mcp-context.tsx
```
1 | "use client";
2 | 
3 | import React, { createContext, useContext, useEffect, useState } from "react";
4 | import { useLocalStorage } from "@/lib/hooks/use-local-storage";
5 | import { STORAGE_KEYS } from "@/lib/constants";
6 | 
7 | // Define types for MCP server
8 | export interface KeyValuePair {
9 |   key: string;
10 |   value: string;
11 | }
12 | 
13 | export interface MCPServer {
14 |   id: string;
15 |   name: string;
16 |   title?: string;
17 |   url: string;
18 |   type: 'sse' | 'stdio' | 'streamable-http';
19 |   command?: string;
20 |   args?: string[];
21 |   env?: KeyValuePair[];
22 |   headers?: KeyValuePair[];
23 |   description?: string;
24 |   _meta?: Record<string, any>;
25 | }
26 | 
27 | // Type for processed MCP server config for API
28 | export interface MCPServerApi {
29 |   type: 'sse' | 'stdio' | 'streamable-http';
30 |   url: string;
31 |   command?: string;
32 |   args?: string[];
33 |   env?: KeyValuePair[];
34 |   headers?: KeyValuePair[];
35 |   title?: string;
36 |   _meta?: Record<string, any>;
37 | }
38 | 
39 | interface MCPContextType {
40 |   mcpServers: MCPServer[];
41 |   setMcpServers: (servers: MCPServer[]) => void;
42 |   selectedMcpServers: string[];
43 |   setSelectedMcpServers: (serverIds: string[]) => void;
44 |   mcpServersForApi: MCPServerApi[];
45 | }
46 | 
47 | const MCPContext = createContext<MCPContextType | undefined>(undefined);
48 | 
49 | export function MCPProvider(props: { children: React.ReactNode }) {
50 |   const { children } = props;
51 |   const [mcpServers, setMcpServers] = useLocalStorage<MCPServer[]>(
52 |     STORAGE_KEYS.MCP_SERVERS, 
53 |     []
54 |   );
55 |   const [selectedMcpServers, setSelectedMcpServers] = useLocalStorage<string[]>(
56 |     STORAGE_KEYS.SELECTED_MCP_SERVERS, 
57 |     []
58 |   );
59 |   const [mcpServersForApi, setMcpServersForApi] = useState<MCPServerApi[]>([]);
60 | 
61 |   // Process MCP servers for API consumption whenever server data changes
62 |   useEffect(() => {
63 |     if (!selectedMcpServers.length) {
64 |       setMcpServersForApi([]);
65 |       return;
66 |     }
67 |     
68 |     const processedServers: MCPServerApi[] = selectedMcpServers
69 |       .map(id => mcpServers.find(server => server.id === id))
70 |       .filter((server): server is MCPServer => Boolean(server))
71 |       .map(server => ({
72 |         type: server.type,
73 |         url: server.url,
74 |         command: server.command,
75 |         args: server.args,
76 |         env: server.env,
77 |         headers: server.headers,
78 |         title: server.title,
79 |         _meta: server._meta
80 |       }));
81 |     
82 |     setMcpServersForApi(processedServers);
83 |   }, [mcpServers, selectedMcpServers]);
84 | 
85 |   return (
86 |     <MCPContext.Provider 
87 |       value={{ 
88 |         mcpServers, 
89 |         setMcpServers, 
90 |         selectedMcpServers, 
91 |         setSelectedMcpServers,
92 |         mcpServersForApi 
93 |       }}
94 |     >
95 |       {children}
96 |     </MCPContext.Provider>
97 |   );
98 | }
99 | 
100 | export function useMCP() {
101 |   const context = useContext(MCPContext);
102 |   if (context === undefined) {
103 |     throw new Error("useMCP must be used within an MCPProvider");
104 |   }
105 |   return context;
106 | } 
```

lib/context/model-context.tsx
```
1 | "use client";
2 | 
3 | import React, { createContext, useContext, useState, useEffect, ReactNode } from "react";
4 | import { useModels } from "@/hooks/use-models";
5 | import { ModelInfo } from "@/lib/types/models";
6 | import { MODEL_MIGRATIONS } from "@/lib/models/client-constants";
7 | import { useFavorites } from "@/hooks/useFavorites";
8 | 
9 | // Legacy compatibility - keep the same interface
10 | interface ModelContextType {
11 |   selectedModel: string;
12 |   setSelectedModel: (model: string) => void;
13 |   // Extended interface for new features
14 |   isLoading?: boolean;
15 |   isRefreshing?: boolean;
16 |   error?: Error | null;
17 |   availableModels?: ModelInfo[];
18 |   refresh?: () => Promise<void>;
19 |   // Favorites functionality
20 |   favorites?: string[];
21 |   toggleFavorite?: (modelId: string) => Promise<boolean>;
22 |   isFavorite?: (modelId: string) => boolean;
23 |   favoriteCount?: number;
24 | }
25 | 
26 | const ModelContext = createContext<ModelContextType | undefined>(undefined);
27 | 
28 | // Migration utilities
29 | function findMigration(oldModelId: string) {
30 |   return MODEL_MIGRATIONS.find(m => m.oldId === oldModelId);
31 | }
32 | 
33 | function notifyUserOfMigration(migration: any) {
34 |   console.info(`Model migrated: ${migration.oldId} → ${migration.newId} (${migration.reason})`);
35 |   // Could show a toast notification here in the future
36 | }
37 | 
38 | function notifyUserOfInvalidModel(modelId: string) {
39 |   console.warn(`Invalid model "${modelId}" replaced with default model`);
40 |   // Could show a toast notification here in the future
41 | }
42 | 
43 | // Fallback models when dynamic loading fails
44 | const FALLBACK_MODELS = [
45 |   "openrouter/google/gemini-2.5-flash",
46 |   "openrouter/anthropic/claude-3.5-sonnet", 
47 |   "openrouter/openai/gpt-4.1-mini",
48 | ];
49 | 
50 | export function ModelProvider({ children }: { children: ReactNode }) {
51 |   // Dynamic models from the API
52 |   const { models, isLoading, isValidating, error, refresh, forceRefresh } = useModels();
53 |   
54 |   // Favorites functionality
55 |   const { 
56 |     favorites, 
57 |     toggleFavorite, 
58 |     isFavorite, 
59 |     favoriteCount,
60 |     isLoading: favoritesLoading 
61 |   } = useFavorites();
62 |   
63 |   // Selected model state
64 |   const [selectedModel, setSelectedModelState] = useState<string>(
65 |     FALLBACK_MODELS[0] // Start with a safe default
66 |   );
67 |   
68 |   // Initialization state
69 |   const [isInitialized, setIsInitialized] = useState(false);
70 |   
71 |   // Manual refresh state for better UX
72 |   const [isManuallyRefreshing, setIsManuallyRefreshing] = useState(false);
73 |   
74 |   // Effect to handle model initialization and migration
75 |   useEffect(() => {
76 |     if (isLoading || isInitialized) return;
77 |     
78 |     // Wait until we have models loaded or failed to load
79 |     if (models.length === 0 && !error) return;
80 |     
81 |     const availableModelIds = models.map(m => m.id);
82 |     
83 |     // Get stored model from localStorage
84 |     let storedModel: string | null = null;
85 |     try {
86 |       if (typeof window !== 'undefined') {
87 |         storedModel = localStorage.getItem('selected_ai_model');
88 |       }
89 |     } catch (error) {
90 |       console.error("Error reading selected model from localStorage:", error);
91 |     }
92 |     
93 |     let finalModel = FALLBACK_MODELS[0]; // Safe default
94 |     
95 |     if (storedModel && availableModelIds.includes(storedModel)) {
96 |       // Stored model is valid and available
97 |       finalModel = storedModel;
98 |     } else if (storedModel) {
99 |       // Try migration
100 |       const migration = findMigration(storedModel);
101 |       if (migration?.automaticMigration && availableModelIds.includes(migration.newId)) {
102 |         finalModel = migration.newId;
103 |         notifyUserOfMigration(migration);
104 |       } else {
105 |         // Find best fallback from available models
106 |         const availableFallback = FALLBACK_MODELS.find(id => availableModelIds.includes(id));
107 |         if (availableFallback) {
108 |           finalModel = availableFallback;
109 |         } else if (availableModelIds.length > 0) {
110 |           // Use first available model as last resort
111 |           finalModel = availableModelIds[0];
112 |         }
113 |         
114 |         if (storedModel !== finalModel) {
115 |           notifyUserOfInvalidModel(storedModel);
116 |         }
117 |       }
118 |     } else {
119 |       // No stored model - pick best available fallback
120 |       const availableFallback = FALLBACK_MODELS.find(id => availableModelIds.includes(id));
121 |       if (availableFallback) {
122 |         finalModel = availableFallback;
123 |       } else if (availableModelIds.length > 0) {
124 |         // Use first available model as last resort
125 |         finalModel = availableModelIds[0];
126 |       }
127 |     }
128 |     
129 |     setSelectedModelState(finalModel);
130 |     setIsInitialized(true);
131 |   }, [models, isLoading, error, isInitialized]);
132 |   
133 |   // Effect to persist selected model to localStorage
134 |   useEffect(() => {
135 |     if (!isInitialized) return;
136 |     
137 |     try {
138 |       if (typeof window !== 'undefined') {
139 |         localStorage.setItem('selected_ai_model', selectedModel);
140 |       }
141 |     } catch (error) {
142 |       console.error("Error saving selected model to localStorage:", error);
143 |     }
144 |   }, [selectedModel, isInitialized]);
145 |   
146 |   // Enhanced setSelectedModel with validation
147 |   const setSelectedModel = (model: string) => {
148 |     const availableModelIds = models.map(m => m.id);
149 |     
150 |     if (availableModelIds.includes(model)) {
151 |       setSelectedModelState(model);
152 |     } else {
153 |       console.warn(`Attempted to set invalid model: ${model}`);
154 |       
155 |       // Try to find a migration
156 |       const migration = findMigration(model);
157 |       if (migration?.automaticMigration && availableModelIds.includes(migration.newId)) {
158 |         setSelectedModelState(migration.newId);
159 |         notifyUserOfMigration(migration);
160 |       } else {
161 |         // Don't change the model if invalid - just warn
162 |         console.warn(`Model "${model}" is not available. Keeping current model: ${selectedModel}`);
163 |       }
164 |     }
165 |   };
166 |   
167 |   // Refresh function for the context - use forceRefresh to bypass cache
168 |   const contextRefresh = async () => {
169 |     if (forceRefresh) {
170 |       try {
171 |         setIsManuallyRefreshing(true);
172 |         await forceRefresh();
173 |       } catch (error) {
174 |         console.error('Error during model refresh:', error);
175 |       } finally {
176 |         setIsManuallyRefreshing(false);
177 |       }
178 |     }
179 |   };
180 |   
181 |   // Enhance models with favorite status
182 |   const modelsWithFavorites = models.map(model => ({
183 |     ...model,
184 |     isFavorite: favorites.includes(model.id),
185 |   }));
186 | 
187 |   const contextValue = {
188 |     selectedModel,
189 |     setSelectedModel,
190 |     isLoading: isLoading || favoritesLoading,
191 |     isRefreshing: isValidating || isManuallyRefreshing,
192 |     error,
193 |     availableModels: modelsWithFavorites,
194 |     refresh: contextRefresh,
195 |     favorites,
196 |     toggleFavorite,
197 |     isFavorite,
198 |     favoriteCount,
199 |   };
200 |   
201 | 
202 | 
203 |   return (
204 |     <ModelContext.Provider value={contextValue}>
205 |       {children}
206 |     </ModelContext.Provider>
207 |   );
208 | }
209 | 
210 | export function useModel() {
211 |   const context = useContext(ModelContext);
212 |   if (context === undefined) {
213 |     throw new Error("useModel must be used within a ModelProvider");
214 |   }
215 |   return context;
216 | } 
```

lib/context/preset-context.tsx
```
1 | 'use client';
2 | 
3 | import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
4 | import { type modelID } from '@/ai/providers';
5 | import { PresetTemplate } from '@/lib/preset-templates';
6 | 
7 | // Types
8 | export interface Preset {
9 |   id: string;
10 |   userId: string;
11 |   name: string;
12 |   modelId: modelID;
13 |   systemInstruction: string;
14 |   temperature: number;
15 |   maxTokens: number;
16 |   webSearchEnabled: boolean;
17 |   webSearchContextSize: 'low' | 'medium' | 'high';
18 |   apiKeyPreferences: Record<string, { useCustomKey: boolean; keyName?: string }>;
19 |   isDefault: boolean;
20 |   shareId?: string | null;
21 |   visibility: 'private' | 'shared';
22 |   version: number;
23 |   createdAt: string;
24 |   updatedAt: string;
25 | }
26 | 
27 | export interface CreatePresetData {
28 |   name: string;
29 |   modelId: modelID;
30 |   systemInstruction: string;
31 |   temperature: number;
32 |   maxTokens: number;
33 |   webSearchEnabled?: boolean;
34 |   webSearchContextSize?: 'low' | 'medium' | 'high';
35 |   apiKeyPreferences?: Record<string, { useCustomKey: boolean; keyName?: string }>;
36 |   isDefault?: boolean;
37 | }
38 | 
39 | export type UpdatePresetData = Partial<CreatePresetData>;
40 | 
41 | interface PresetContextType {
42 |   // State
43 |   presets: Preset[];
44 |   activePreset: Preset | null;
45 |   defaultPreset: Preset | null;
46 |   loading: boolean;
47 |   error: string | null;
48 | 
49 |   // Actions
50 |   loadPresets: () => Promise<void>;
51 |   setActivePreset: (preset: Preset | null) => void;
52 |   createPreset: (data: CreatePresetData) => Promise<Preset>;
53 |   createPresetFromTemplate: (template: PresetTemplate) => Promise<Preset>;
54 |   updatePreset: (id: string, data: UpdatePresetData) => Promise<Preset>;
55 |   deletePreset: (id: string) => Promise<void>;
56 |   sharePreset: (id: string) => Promise<string>;
57 |   unsharePreset: (id: string) => Promise<void>;
58 |   setDefaultPreset: (id: string) => Promise<void>;
59 |   unsetDefaultPreset: (id: string) => Promise<void>;
60 |   importSharedPreset: (shareId: string) => Promise<Preset>;
61 |   refreshPresets: () => Promise<void>;
62 | }
63 | 
64 | const PresetContext = createContext<PresetContextType | undefined>(undefined);
65 | 
66 | export function usePresets() {
67 |   const context = useContext(PresetContext);
68 |   if (!context) {
69 |     throw new Error('usePresets must be used within a PresetProvider');
70 |   }
71 |   return context;
72 | }
73 | 
74 | interface PresetProviderProps {
75 |   children: React.ReactNode;
76 | }
77 | 
78 | export function PresetProvider({ children }: PresetProviderProps) {
79 |   // State
80 |   const [presets, setPresets] = useState<Preset[]>([]);
81 |   const [activePreset, setActivePresetState] = useState<Preset | null>(null);
82 |   const [loading, setLoading] = useState(false);
83 |   const [error, setError] = useState<string | null>(null);
84 | 
85 |   // Computed values
86 |   const defaultPreset = presets.find(preset => preset.isDefault) || null;
87 | 
88 |   // API helpers
89 |   const apiCall = async (url: string, options?: RequestInit) => {
90 |     const response = await fetch(url, {
91 |       headers: {
92 |         'Content-Type': 'application/json',
93 |         ...options?.headers,
94 |       },
95 |       ...options,
96 |     });
97 | 
98 |     if (!response.ok) {
99 |       const errorData = await response.json().catch(() => ({ error: 'Network error' }));
100 |       throw new Error(errorData.error || `HTTP ${response.status}`);
101 |     }
102 | 
103 |     return response.json();
104 |   };
105 | 
106 |   // Load presets from API
107 |   const loadPresets = useCallback(async () => {
108 |     try {
109 |       setLoading(true);
110 |       setError(null);
111 |       
112 |       const data = await apiCall('/api/presets');
113 |       setPresets(data);
114 |       
115 |       // Set active preset to default if no active preset is set
116 |       if (!activePreset && data.length > 0) {
117 |         const defaultPresetFromAPI = data.find((preset: Preset) => preset.isDefault);
118 |         if (defaultPresetFromAPI) {
119 |           setActivePresetState(defaultPresetFromAPI);
120 |         }
121 |       }
122 |     } catch (error) {
123 |       console.error('Failed to load presets:', error);
124 |       setError(error instanceof Error ? error.message : 'Failed to load presets');
125 |     } finally {
126 |       setLoading(false);
127 |     }
128 |   }, [activePreset]);
129 | 
130 |   // Set active preset
131 |   const setActivePreset = useCallback((preset: Preset | null) => {
132 |     setActivePresetState(preset);
133 |     // Store in localStorage for persistence across sessions
134 |     if (preset) {
135 |       localStorage.setItem('activePresetId', preset.id);
136 |     } else {
137 |       localStorage.removeItem('activePresetId');
138 |     }
139 |   }, []);
140 | 
141 |   // Create new preset
142 |   const createPreset = useCallback(async (data: CreatePresetData): Promise<Preset> => {
143 |     try {
144 |       setError(null);
145 |       
146 |       const newPreset = await apiCall('/api/presets', {
147 |         method: 'POST',
148 |         body: JSON.stringify(data),
149 |       });
150 | 
151 |       // Update local state
152 |       setPresets(prev => [newPreset, ...prev]);
153 |       
154 |       // If this is set as default, update other presets
155 |       if (newPreset.isDefault) {
156 |         setPresets(prev => prev.map(preset => 
157 |           preset.id === newPreset.id ? preset : { ...preset, isDefault: false }
158 |         ));
159 |       }
160 | 
161 |       return newPreset;
162 |     } catch (error) {
163 |       const errorMessage = error instanceof Error ? error.message : 'Failed to create preset';
164 |       setError(errorMessage);
165 |       throw error;
166 |     }
167 |   }, []);
168 | 
169 |   // Create preset from template
170 |   const createPresetFromTemplate = useCallback(async (template: PresetTemplate): Promise<Preset> => {
171 |     return createPreset(template.preset);
172 |   }, [createPreset]);
173 | 
174 |   // Update preset
175 |   const updatePreset = useCallback(async (id: string, data: UpdatePresetData): Promise<Preset> => {
176 |     try {
177 |       setError(null);
178 |       
179 |       const updatedPreset = await apiCall(`/api/presets/${id}`, {
180 |         method: 'PUT',
181 |         body: JSON.stringify(data),
182 |       });
183 | 
184 |       // Update local state
185 |       setPresets(prev => prev.map(preset => 
186 |         preset.id === id ? updatedPreset : preset
187 |       ));
188 | 
189 |       // Update active preset if it's the one being updated
190 |       if (activePreset?.id === id) {
191 |         setActivePresetState(updatedPreset);
192 |       }
193 | 
194 |       // If this is set as default, update other presets
195 |       if (updatedPreset.isDefault) {
196 |         setPresets(prev => prev.map(preset => 
197 |           preset.id === updatedPreset.id ? preset : { ...preset, isDefault: false }
198 |         ));
199 |       }
200 | 
201 |       return updatedPreset;
202 |     } catch (error) {
203 |       const errorMessage = error instanceof Error ? error.message : 'Failed to update preset';
204 |       setError(errorMessage);
205 |       throw error;
206 |     }
207 |   }, [activePreset]);
208 | 
209 |   // Delete preset
210 |   const deletePreset = useCallback(async (id: string): Promise<void> => {
211 |     try {
212 |       setError(null);
213 |       
214 |       await apiCall(`/api/presets/${id}`, {
215 |         method: 'DELETE',
216 |       });
217 | 
218 |       // Update local state
219 |       setPresets(prev => prev.filter(preset => preset.id !== id));
220 |       
221 |       // Clear active preset if it's the one being deleted
222 |       if (activePreset?.id === id) {
223 |         setActivePresetState(null);
224 |         localStorage.removeItem('activePresetId');
225 |       }
226 |     } catch (error) {
227 |       const errorMessage = error instanceof Error ? error.message : 'Failed to delete preset';
228 |       setError(errorMessage);
229 |       throw error;
230 |     }
231 |   }, [activePreset]);
232 | 
233 |   // Share preset
234 |   const sharePreset = useCallback(async (id: string): Promise<string> => {
235 |     try {
236 |       setError(null);
237 |       
238 |       const response = await apiCall(`/api/presets/${id}/share`, {
239 |         method: 'POST',
240 |       });
241 | 
242 |       // Update local state with share info
243 |       setPresets(prev => prev.map(preset => 
244 |         preset.id === id 
245 |           ? { ...preset, shareId: response.shareId, visibility: 'shared' }
246 |           : preset
247 |       ));
248 | 
249 |       return response.shareUrl;
250 |     } catch (error) {
251 |       const errorMessage = error instanceof Error ? error.message : 'Failed to share preset';
252 |       setError(errorMessage);
253 |       throw error;
254 |     }
255 |   }, []);
256 | 
257 |   // Unshare preset
258 |   const unsharePreset = useCallback(async (id: string): Promise<void> => {
259 |     try {
260 |       setError(null);
261 |       
262 |       await apiCall(`/api/presets/${id}/share`, {
263 |         method: 'DELETE',
264 |       });
265 | 
266 |       // Update local state
267 |       setPresets(prev => prev.map(preset => 
268 |         preset.id === id 
269 |           ? { ...preset, shareId: null, visibility: 'private' }
270 |           : preset
271 |       ));
272 |     } catch (error) {
273 |       const errorMessage = error instanceof Error ? error.message : 'Failed to unshare preset';
274 |       setError(errorMessage);
275 |       throw error;
276 |     }
277 |   }, []);
278 | 
279 |   // Set default preset
280 |   const setDefaultPreset = useCallback(async (id: string): Promise<void> => {
281 |     try {
282 |       setError(null);
283 |       
284 |       await apiCall(`/api/presets/${id}/set-default`, {
285 |         method: 'POST',
286 |       });
287 | 
288 |       // Update local state - unset all defaults and set this one
289 |       setPresets(prev => prev.map(preset => ({
290 |         ...preset,
291 |         isDefault: preset.id === id
292 |       })));
293 |     } catch (error) {
294 |       const errorMessage = error instanceof Error ? error.message : 'Failed to set default preset';
295 |       setError(errorMessage);
296 |       throw error;
297 |     }
298 |   }, []);
299 | 
300 |   // Unset default preset
301 |   const unsetDefaultPreset = useCallback(async (id: string): Promise<void> => {
302 |     try {
303 |       setError(null);
304 |       
305 |       await apiCall(`/api/presets/${id}/set-default`, {
306 |         method: 'DELETE',
307 |       });
308 | 
309 |       // Update local state
310 |       setPresets(prev => prev.map(preset => 
311 |         preset.id === id ? { ...preset, isDefault: false } : preset
312 |       ));
313 |     } catch (error) {
314 |       const errorMessage = error instanceof Error ? error.message : 'Failed to unset default preset';
315 |       setError(errorMessage);
316 |       throw error;
317 |     }
318 |   }, []);
319 | 
320 |   // Import shared preset
321 |   const importSharedPreset = useCallback(async (shareId: string): Promise<Preset> => {
322 |     try {
323 |       setError(null);
324 |       
325 |       // First, get the shared preset data
326 |       const sharedPreset = await apiCall(`/api/presets/shared/${shareId}`);
327 |       
328 |       // Create a new preset based on the shared one
329 |       const importData: CreatePresetData = {
330 |         name: `${sharedPreset.name} (Imported)`,
331 |         modelId: sharedPreset.modelId,
332 |         systemInstruction: sharedPreset.systemInstruction,
333 |         temperature: sharedPreset.temperature,
334 |         maxTokens: sharedPreset.maxTokens,
335 |         webSearchEnabled: sharedPreset.webSearchEnabled,
336 |         webSearchContextSize: sharedPreset.webSearchContextSize,
337 |         apiKeyPreferences: {},
338 |         isDefault: false,
339 |       };
340 | 
341 |       return createPreset(importData);
342 |     } catch (error) {
343 |       const errorMessage = error instanceof Error ? error.message : 'Failed to import shared preset';
344 |       setError(errorMessage);
345 |       throw error;
346 |     }
347 |   }, [createPreset]);
348 | 
349 |   // Refresh presets (alias for loadPresets)
350 |   const refreshPresets = useCallback(async () => {
351 |     await loadPresets();
352 |   }, [loadPresets]);
353 | 
354 |   // Load presets on mount
355 |   useEffect(() => {
356 |     loadPresets();
357 |   }, [loadPresets]);
358 | 
359 |   // Restore active preset from localStorage on mount
360 |   useEffect(() => {
361 |     const storedActivePresetId = localStorage.getItem('activePresetId');
362 |     if (storedActivePresetId && presets.length > 0 && !activePreset) {
363 |       const storedPreset = presets.find(preset => preset.id === storedActivePresetId);
364 |       if (storedPreset) {
365 |         setActivePresetState(storedPreset);
366 |       }
367 |     }
368 |   }, [presets, activePreset]);
369 | 
370 |   const value: PresetContextType = {
371 |     // State
372 |     presets,
373 |     activePreset,
374 |     defaultPreset,
375 |     loading,
376 |     error,
377 | 
378 |     // Actions
379 |     loadPresets,
380 |     setActivePreset,
381 |     createPreset,
382 |     createPresetFromTemplate,
383 |     updatePreset,
384 |     deletePreset,
385 |     sharePreset,
386 |     unsharePreset,
387 |     setDefaultPreset,
388 |     unsetDefaultPreset,
389 |     importSharedPreset,
390 |     refreshPresets,
391 |   };
392 | 
393 |   return (
394 |     <PresetContext.Provider value={value}>
395 |       {children}
396 |     </PresetContext.Provider>
397 |   );
398 | }
```

lib/context/web-search-context.tsx
```
1 | "use client";
2 | 
3 | import React, { createContext, useState, useContext, ReactNode, Dispatch, SetStateAction } from 'react';
4 | import { useLocalStorage } from '@/lib/hooks/use-local-storage';
5 | import { STORAGE_KEYS } from '@/lib/constants';
6 | 
7 | type WebSearchContextType = {
8 |   webSearchEnabled: boolean;
9 |   setWebSearchEnabled: Dispatch<SetStateAction<boolean>>;
10 |   webSearchContextSize: 'low' | 'medium' | 'high';
11 |   setWebSearchContextSize: Dispatch<SetStateAction<'low' | 'medium' | 'high'>>;
12 | };
13 | 
14 | const WebSearchContext = createContext<WebSearchContextType | undefined>(undefined);
15 | 
16 | interface WebSearchProviderProps {
17 |   children: ReactNode;
18 | }
19 | 
20 | export const WebSearchProvider: React.FC<WebSearchProviderProps> = ({ children }) => {
21 |   const [webSearchSettings, setWebSearchSettings] = useLocalStorage<{
22 |     enabled: boolean;
23 |     contextSize: 'low' | 'medium' | 'high';
24 |   }>(STORAGE_KEYS.WEB_SEARCH, {
25 |     enabled: false,
26 |     contextSize: 'medium'
27 |   });
28 | 
29 |   const setWebSearchEnabled = (enabled: boolean | ((prevState: boolean) => boolean)) => {
30 |     setWebSearchSettings(prev => ({ ...prev, enabled: typeof enabled === 'function' ? enabled(prev.enabled) : enabled }));
31 |   };
32 | 
33 |   const setWebSearchContextSize = (size: 'low' | 'medium' | 'high' | ((prevState: 'low' | 'medium' | 'high') => 'low' | 'medium' | 'high')) => {
34 |     setWebSearchSettings(prev => ({ ...prev, contextSize: typeof size === 'function' ? size(prev.contextSize) : size }));
35 |   };
36 | 
37 |   return (
38 |     <WebSearchContext.Provider value={{ 
39 |       webSearchEnabled: webSearchSettings.enabled, 
40 |       setWebSearchEnabled, 
41 |       webSearchContextSize: webSearchSettings.contextSize, 
42 |       setWebSearchContextSize 
43 |     }}>
44 |       {children}
45 |     </WebSearchContext.Provider>
46 |   );
47 | };
48 | 
49 | export const useWebSearch = (): WebSearchContextType => {
50 |   const context = useContext(WebSearchContext);
51 |   if (context === undefined) {
52 |     throw new Error('useWebSearch must be used within a WebSearchProvider');
53 |   }
54 |   return context;
55 | }; 
```

lib/db/index.ts
```
1 | import { drizzle } from "drizzle-orm/neon-serverless";
2 | import { Pool } from "@neondatabase/serverless";
3 | import * as schema from "./schema";
4 | 
5 | // Initialize the connection pool
6 | const pool = new Pool({
7 |   connectionString: process.env.DATABASE_URL,
8 | });
9 | 
10 | // Initialize Drizzle with the connection pool and schema
11 | export const db = drizzle(pool, { schema }); 
```

lib/db/schema.ts
```
1 | import { timestamp, pgTable, text, primaryKey, json, boolean, integer, unique, check, index } from "drizzle-orm/pg-core";
2 | import { sql } from "drizzle-orm";
3 | import { nanoid } from "nanoid";
4 | 
5 | // Message role enum type
6 | export enum MessageRole {
7 |   USER = "user",
8 |   ASSISTANT = "assistant",
9 |   TOOL = "tool"
10 | }
11 | 
12 | export const chats = pgTable('chats', {
13 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()),
14 |   userId: text('user_id').notNull(),
15 |   title: text('title').notNull().default('New Chat'),
16 |   createdAt: timestamp('created_at').defaultNow().notNull(),
17 |   updatedAt: timestamp('updated_at').defaultNow().notNull(),
18 | });
19 | 
20 | export const messages = pgTable('messages', {
21 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()),
22 |   chatId: text('chat_id').notNull().references(() => chats.id, { onDelete: 'cascade' }),
23 |   role: text('role').notNull(), // user, assistant, or tool
24 |   parts: json('parts').notNull(), // Store parts as JSON in the database
25 |   hasWebSearch: boolean('has_web_search').default(false),
26 |   webSearchContextSize: text('web_search_context_size').default('medium'), // 'low', 'medium', 'high'
27 |   createdAt: timestamp('created_at').defaultNow().notNull(),
28 | });
29 | 
30 | // Types for structured message content
31 | export type MessagePart = {
32 |   type: string;
33 |   text?: string;
34 |   toolCallId?: string;
35 |   toolName?: string;
36 |   args?: any;
37 |   result?: any;
38 |   citations?: WebSearchCitation[];
39 |   [key: string]: any;
40 | };
41 | 
42 | export type Attachment = {
43 |   type: string;
44 |   [key: string]: any;
45 | };
46 | 
47 | export type Chat = typeof chats.$inferSelect;
48 | export type ChatWithShareInfo = Chat & {
49 |   shareId?: string | null;
50 |   sharePath?: string | null;
51 | };
52 | export type Message = typeof messages.$inferSelect;
53 | export type DBMessage = {
54 |   id: string;
55 |   chatId: string;
56 |   role: string;
57 |   parts: MessagePart[];
58 |   createdAt: Date;
59 | };
60 | 
61 | // --- Better Auth Core Schema ---
62 | 
63 | export const users = pgTable("user", {
64 |   id: text("id").primaryKey().$defaultFn(() => nanoid()),
65 |   name: text("name"),
66 |   email: text("email").unique().notNull(),
67 |   emailVerified: boolean("emailVerified"),
68 |   image: text("image"),
69 |   isAnonymous: boolean("isAnonymous").default(false),
70 |   metadata: json("metadata"),
71 |   defaultPresetId: text("default_preset_id"), // Will add foreign key constraint in migration
72 |   createdAt: timestamp("createdAt", { mode: "date" }).defaultNow().notNull(),
73 |   updatedAt: timestamp("updatedAt", { mode: "date" }).defaultNow().notNull(),
74 | });
75 | 
76 | export const accounts = pgTable(
77 |   "account",
78 |   {
79 |     id: text("id").primaryKey().$defaultFn(() => nanoid()),
80 |     userId: text("userId")
81 |       .notNull()
82 |       .references(() => users.id, { onDelete: "cascade" }),
83 |     providerId: text("providerId").notNull(), // e.g., "google", "github", "email"
84 |     accountId: text("accountId").notNull(), // The user's ID with the provider or email/password hash
85 |     providerType: text("providerType"), // "oauth", "email", etc. REMOVED .notNull()
86 |     accessToken: text("access_token"),
87 |     refreshToken: text("refresh_token"),
88 |     accessTokenExpiresAt: timestamp("access_token_expires_at", { mode: "date" }),
89 |     tokenType: text("token_type"), // e.g., "bearer"
90 |     scope: text("scope"),
91 |     idToken: text("id_token"), // For OIDC providers like Google
92 |     sessionState: text("session_state"), // For OIDC providers
93 | 
94 |     // Fields specific to email/password - not needed for Google-only
95 |     // password: text("password"),
96 | 
97 |     createdAt: timestamp("createdAt", { mode: "date" }).defaultNow().notNull(),
98 |     updatedAt: timestamp("updatedAt", { mode: "date" }).defaultNow().notNull(),
99 |   }
100 | );
101 | 
102 | export const sessions = pgTable("session", {
103 |   id: text("id").primaryKey().$defaultFn(() => nanoid()),
104 |   sessionToken: text("sessionToken").unique().notNull(),
105 |   userId: text("userId")
106 |     .notNull()
107 |     .references(() => users.id, { onDelete: "cascade" }),
108 |   expiresAt: timestamp("expiresAt", { mode: "date" }).notNull(),
109 |   ipAddress: text("ipAddress"),
110 |   userAgent: text("userAgent"),
111 |   createdAt: timestamp("createdAt", { mode: "date" }).defaultNow().notNull(),
112 |   updatedAt: timestamp("updatedAt", { mode: "date" }).defaultNow().notNull(),
113 | });
114 | 
115 | // Corrected Verification Token Schema -> Renamed Verification Schema
116 | export const verification = pgTable( // Renamed from verificationTokens
117 |   "verification", // Renamed from verificationToken
118 |   {
119 |     id: text("id").primaryKey().$defaultFn(() => nanoid()),
120 |     identifier: text("identifier").notNull(),
121 |     // token: text("token").unique().notNull(), // Removed this line
122 |     value: text("value").notNull(), // Ensure this exists as per docs (though error wasn't about this)
123 |     expiresAt: timestamp("expiresAt", { mode: "date" }).notNull(),
124 |     createdAt: timestamp("createdAt", { mode: "date" }).defaultNow().notNull(),
125 |     updatedAt: timestamp("updatedAt", { mode: "date" }).defaultNow().notNull(),
126 |   }
127 | );
128 | 
129 | // --- End Better Auth Core Schema ---
130 | 
131 | // Infer types for Better Auth tables
132 | export type AuthUser = typeof users.$inferSelect;
133 | export type AuthAccount = typeof accounts.$inferSelect;
134 | export type AuthSession = typeof sessions.$inferSelect;
135 | // export type AuthVerificationToken = typeof verificationTokens.$inferSelect; // Removed old type export
136 | export type AuthVerification = typeof verification.$inferSelect; // Added new type export
137 | 
138 | export type WebSearchCitation = {
139 |   url: string;
140 |   title: string;
141 |   content?: string;
142 |   startIndex: number;
143 |   endIndex: number;
144 | };
145 | 
146 | // --- Polar Usage Events Schema ---
147 | 
148 | export const polarUsageEvents = pgTable('polar_usage_events', {
149 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()), // Unique ID for the log entry
150 |   userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }), // Links to your existing users table
151 |   polarCustomerId: text('polar_customer_id'), // The customer ID from Polar
152 |   eventName: text('event_name').notNull(), // The name of the event (e.g., "ai-usage")
153 |   eventPayload: json('event_payload').notNull(), // The full payload sent to Polar's ingest API (e.g., { "completionTokens": 100 })
154 |   createdAt: timestamp('created_at').defaultNow().notNull(), // When this log entry was created
155 | });
156 | 
157 | export type PolarUsageEvent = typeof polarUsageEvents.$inferSelect;
158 | 
159 | // --- Presets Schema ---
160 | 
161 | export const presets = pgTable('presets', {
162 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()),
163 |   userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
164 |   name: text('name').notNull(),
165 |   modelId: text('model_id').notNull(),
166 |   systemInstruction: text('system_instruction').notNull(),
167 |   temperature: integer('temperature').notNull(), // Store as integer (temperature * 1000) for precision
168 |   maxTokens: integer('max_tokens').notNull(),
169 |   webSearchEnabled: boolean('web_search_enabled').default(false),
170 |   webSearchContextSize: text('web_search_context_size').default('medium'), // 'low', 'medium', 'high'
171 |   apiKeyPreferences: json('api_key_preferences').$type<Record<string, { useCustomKey: boolean; keyName?: string }>>().default({}),
172 |   isDefault: boolean('is_default').default(false),
173 |   shareId: text('share_id').unique(),
174 |   visibility: text('visibility').default('private'), // 'private', 'shared'
175 |   version: integer('version').default(1),
176 |   createdAt: timestamp('created_at').defaultNow().notNull(),
177 |   updatedAt: timestamp('updated_at').defaultNow().notNull(),
178 |   deletedAt: timestamp('deleted_at'),
179 | }, (table) => ({
180 |   // Constraints
181 |   uniqueNamePerUser: unique('unique_name_per_user').on(table.userId, table.name),
182 |   // oneDefaultPerUser constraint removed - handled in application logic
183 |   checkNameLength: check('check_name_length', sql`char_length(${table.name}) >= 1 AND char_length(${table.name}) <= 100`),
184 |   checkSystemInstructionLength: check('check_system_instruction_length', sql`char_length(${table.systemInstruction}) >= 10 AND char_length(${table.systemInstruction}) <= 4000`),
185 |   checkTemperatureRange: check('check_temperature_range', sql`${table.temperature} >= 0 AND ${table.temperature} <= 2000`), // 0.0 to 2.0 * 1000
186 |   checkMaxTokensRange: check('check_max_tokens_range', sql`${table.maxTokens} > 0 AND ${table.maxTokens} <= 100000`),
187 |   checkVisibility: check('check_visibility', sql`${table.visibility} IN ('private', 'shared')`),
188 |   checkWebSearchContextSize: check('check_web_search_context_size', sql`${table.webSearchContextSize} IN ('low', 'medium', 'high')`),
189 |   checkShareIdFormat: check('check_share_id_format', sql`${table.shareId} IS NULL OR (char_length(${table.shareId}) >= 20 AND char_length(${table.shareId}) <= 50)`),
190 | }));
191 | 
192 | // Preset usage tracking
193 | export const presetUsage = pgTable('preset_usage', {
194 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()),
195 |   presetId: text('preset_id').notNull().references(() => presets.id, { onDelete: 'cascade' }),
196 |   userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
197 |   chatId: text('chat_id'),
198 |   usedAt: timestamp('used_at').defaultNow().notNull(),
199 | });
200 | 
201 | export type Preset = typeof presets.$inferSelect;
202 | export type PresetInsert = typeof presets.$inferInsert;
203 | export type PresetUsage = typeof presetUsage.$inferSelect;
204 | 
205 | // --- Favorite Models Schema ---
206 | 
207 | export const favoriteModels = pgTable('favorite_models', {
208 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()),
209 |   userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
210 |   modelId: text('model_id').notNull(),
211 |   createdAt: timestamp('created_at').defaultNow().notNull(),
212 | }, (table) => ({
213 |   // Ensure one favorite per user per model
214 |   uniqueUserModel: unique('unique_user_model').on(table.userId, table.modelId),
215 |   // Indexes for performance
216 |   userIdIdx: index('idx_favorite_models_user_id').on(table.userId),
217 |   modelIdIdx: index('idx_favorite_models_model_id').on(table.modelId),
218 | }));
219 | 
220 | export type FavoriteModel = typeof favoriteModels.$inferSelect;
221 | export type FavoriteModelInsert = typeof favoriteModels.$inferInsert;
222 | 
223 | // --- Chat Shares Schema ---
224 | 
225 | export const chatShares = pgTable('chat_shares', {
226 |   id: text('id').primaryKey().notNull().$defaultFn(() => nanoid()),
227 |   chatId: text('chat_id').notNull().references(() => chats.id, { onDelete: 'cascade' }),
228 |   ownerUserId: text('owner_user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
229 |   shareId: text('share_id').notNull().unique(),
230 |   status: text('status').notNull().default('active'),
231 |   visibility: text('visibility').notNull().default('unlisted'),
232 |   snapshotJson: json('snapshot_json').notNull(),
233 |   viewCount: integer('view_count').notNull().default(0),
234 |   createdAt: timestamp('created_at').defaultNow().notNull(),
235 |   revokedAt: timestamp('revoked_at'),
236 | }, (table) => ({
237 |   // Constraints and indexes
238 |   checkStatus: check('check_chat_shares_status', sql`${table.status} IN ('active','revoked')`),
239 |   checkVisibility: check('check_chat_shares_visibility', sql`${table.visibility} IN ('unlisted')`),
240 |   checkShareIdFormat: check('check_chat_shares_share_id_format', sql`char_length(${table.shareId}) >= 20 AND char_length(${table.shareId}) <= 64`),
241 |   chatStatusIdx: index('idx_chat_shares_chat_id_status').on(table.chatId, table.status),
242 |   ownerStatusIdx: index('idx_chat_shares_owner_user_id_status').on(table.ownerUserId, table.status),
243 | }));
244 | 
245 | export type ChatShare = typeof chatShares.$inferSelect;
246 | export type ChatShareInsert = typeof chatShares.$inferInsert;
247 | 
```

lib/hooks/use-chats.ts
```
1 | import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
2 | import { type Chat, type ChatWithShareInfo } from '@/lib/db/schema';
3 | import { toast } from 'sonner';
4 | import { useAuth } from '@/hooks/useAuth';
5 | import { useState, useCallback } from 'react';
6 | 
7 | export function useChats() {
8 |   const queryClient = useQueryClient();
9 |   const { session, isPending: isSessionLoading } = useAuth();
10 |   const [currentLimit, setCurrentLimit] = useState(50);
11 | 
12 |   // Main query to fetch chats
13 |   const {
14 |     data: chats = [],
15 |     isLoading,
16 |     error,
17 |     refetch,
18 |     isFetching
19 |   } = useQuery<ChatWithShareInfo[]>({
20 |     queryKey: ['chats', currentLimit],
21 |     queryFn: async () => {
22 |       const response = await fetch(`/api/chats?limit=${currentLimit}`);
23 | 
24 |       if (!response.ok) {
25 |         throw new Error('Failed to fetch chats');
26 |       }
27 | 
28 |       return response.json();
29 |     },
30 |     enabled: !isSessionLoading && !!session?.user?.id, // Only fetch when session is loaded and user exists
31 |     staleTime: 1000 * 60 * 10, // Consider data fresh for 10 minutes (increased from 5)
32 |     refetchOnWindowFocus: false, // Disable aggressive refetching on focus
33 |     refetchOnMount: false, // Don't refetch on mount if data is available
34 |     refetchOnReconnect: false, // Don't refetch on reconnect
35 |   });
36 | 
37 |   // Load more chats function
38 |   const loadMoreChats = useCallback(() => {
39 |     const newLimit = currentLimit + 50;
40 |     setCurrentLimit(newLimit);
41 |   }, [currentLimit]);
42 | 
43 |   // Check if there might be more chats to load
44 |   const hasMoreChats = chats.length === currentLimit;
45 | 
46 |   // Mutation to delete a chat
47 |   const deleteChat = useMutation({
48 |     mutationFn: async (chatId: string) => {
49 |       const response = await fetch(`/api/chats/${chatId}`, {
50 |         method: 'DELETE'
51 |       });
52 | 
53 |       if (!response.ok) {
54 |         throw new Error('Failed to delete chat');
55 |       }
56 | 
57 |       return chatId;
58 |     },
59 |     onSuccess: (deletedChatId) => {
60 |       // Update cache by removing the deleted chat
61 |       queryClient.setQueryData<ChatWithShareInfo[]>(['chats'], (oldChats = []) =>
62 |         oldChats.filter(chat => chat.id !== deletedChatId)
63 |       );
64 | 
65 |       toast.success('Chat deleted');
66 |     },
67 |     onError: (error) => {
68 |       console.error('Error deleting chat:', error);
69 |       toast.error('Failed to delete chat');
70 |     }
71 |   });
72 | 
73 |   // Mutation to update a chat's title
74 |   const updateChatTitle = useMutation({
75 |     mutationFn: async ({ chatId, title }: { chatId: string; title: string }) => {
76 |       const response = await fetch(`/api/chats/${chatId}`, {
77 |         method: 'PATCH',
78 |         headers: {
79 |           'Content-Type': 'application/json'
80 |         },
81 |         body: JSON.stringify({ title })
82 |       });
83 | 
84 |       if (!response.ok) {
85 |         const errorData = await response.json().catch(() => ({ message: 'Failed to update chat title' }));
86 |         throw new Error(errorData.message || 'Failed to update chat title');
87 |       }
88 | 
89 |       return response.json();
90 |     },
91 |     onMutate: async ({ chatId, title }: { chatId: string; title: string }) => {
92 |       // Cancel any outgoing refetches (so they don't overwrite our optimistic update)
93 |       await queryClient.cancelQueries({ queryKey: ['chats'] });
94 | 
95 |       // Snapshot the previous value
96 |       const previousChats = queryClient.getQueryData<ChatWithShareInfo[]>(['chats']);
97 | 
98 |       // Optimistically update to the new value
99 |       queryClient.setQueryData<ChatWithShareInfo[]>(['chats'], (oldChats = []) =>
100 |         oldChats.map(chat =>
101 |           chat.id === chatId ? { ...chat, title, updatedAt: new Date() } : chat
102 |         )
103 |       );
104 | 
105 |       // Return a context object with the snapshotted value
106 |       return { previousChats };
107 |     },
108 |     onError: (err, variables, context) => {
109 |       console.error('Error updating chat title:', err);
110 |       // Rollback to the previous value if optimistic update occurred
111 |       if (context?.previousChats) {
112 |         queryClient.setQueryData<ChatWithShareInfo[]>(['chats'], context.previousChats);
113 |       }
114 |       toast.error(err.message || 'Failed to update chat title. Please try again.');
115 |     },
116 |     onSuccess: (data: ChatWithShareInfo, variables) => {
117 |       // Update the specific chat in the cache with the server's response
118 |       queryClient.setQueryData<ChatWithShareInfo[]>(['chats'], (oldChats = []) =>
119 |         oldChats.map(chat => (chat.id === variables.chatId ? data : chat))
120 |       );
121 |       toast.success('Chat title updated successfully!');
122 |     }
123 |   });
124 | 
125 | 
126 | 
127 |   // Function to invalidate chats cache for refresh
128 |   const refreshChats = () => {
129 |     queryClient.invalidateQueries({ queryKey: ['chats'] });
130 |   };
131 | 
132 |   return {
133 |     chats,
134 |     isLoading,
135 |     error,
136 |     deleteChat: deleteChat.mutate,
137 |     isDeleting: deleteChat.isPending,
138 |     updateChatTitle: updateChatTitle.mutate,
139 |     isUpdatingChatTitle: updateChatTitle.isPending,
140 |     refreshChats,
141 |     refetch,
142 |     loadMoreChats,
143 |     hasMoreChats,
144 |     isLoadingMore: isFetching && !isLoading,
145 |     currentLimit,
146 |   };
147 | }
```

lib/hooks/use-client-mount.ts
```
1 | import { useState, useEffect } from 'react';
2 | 
3 | /**
4 |  * Hook to track when a component has mounted on the client side
5 |  * This prevents hydration mismatches for components that depend on browser APIs
6 |  * @returns boolean indicating if the component has mounted on the client
7 |  */
8 | export function useClientMount() {
9 |     const [isMounted, setIsMounted] = useState(false);
10 | 
11 |     useEffect(() => {
12 |         setIsMounted(true);
13 |     }, []);
14 | 
15 |     return isMounted;
16 | } 
```

lib/hooks/use-copy.ts
```
1 | import { useState, useCallback } from 'react';
2 | 
3 | export function useCopy(timeout = 2000) {
4 |   const [copied, setCopied] = useState(false);
5 | 
6 |   const copy = useCallback(
7 |     async (text: string) => {
8 |       if (!navigator.clipboard) {
9 |         console.error('Clipboard API not available');
10 |         return false;
11 |       }
12 |       
13 |       try {
14 |         await navigator.clipboard.writeText(text);
15 |         setCopied(true);
16 |         
17 |         setTimeout(() => {
18 |           setCopied(false);
19 |         }, timeout);
20 |         
21 |         return true;
22 |       } catch (error) {
23 |         console.error('Failed to copy text:', error);
24 |         return false;
25 |       }
26 |     },
27 |     [timeout]
28 |   );
29 | 
30 |   return { copied, copy };
31 | } 
```

lib/hooks/use-local-storage.ts
```
1 | import { useState, useEffect, useCallback } from 'react';
2 | 
3 | type SetValue<T> = T | ((val: T) => T);
4 | 
5 | /**
6 |  * Custom hook for persistent localStorage state with SSR support
7 |  * @param key The localStorage key
8 |  * @param initialValue The initial value if no value exists in localStorage
9 |  * @returns A stateful value and a function to update it
10 |  */
11 | export function useLocalStorage<T>(key: string, initialValue: T) {
12 |   // State to store our value
13 |   // Pass initial state function to useState so logic is only executed once
14 |   const [storedValue, setStoredValue] = useState<T>(initialValue);
15 | 
16 |   // Check if we're in the browser environment
17 |   const isBrowser = typeof window !== 'undefined';
18 | 
19 |   // Initialize state from localStorage or use initialValue
20 |   useEffect(() => {
21 |     if (!isBrowser) return;
22 |     
23 |     try {
24 |       const item = window.localStorage.getItem(key);
25 |       if (item) {
26 |         setStoredValue(parseJSON(item));
27 |       }
28 |     } catch (error) {
29 |       console.error(`Error reading localStorage key "${key}":`, error);
30 |     }
31 |   }, [key, isBrowser]);
32 | 
33 |   // Return a wrapped version of useState's setter function that
34 |   // persists the new value to localStorage.
35 |   const setValue = useCallback((value: SetValue<T>) => {
36 |     if (!isBrowser) return;
37 |     
38 |     try {
39 |       // Allow value to be a function so we have same API as useState
40 |       const valueToStore =
41 |         value instanceof Function ? value(storedValue) : value;
42 |       
43 |       // Save state
44 |       setStoredValue(valueToStore);
45 |       
46 |       // Save to localStorage
47 |       if (valueToStore === undefined) {
48 |         window.localStorage.removeItem(key);
49 |       } else {
50 |         window.localStorage.setItem(key, JSON.stringify(valueToStore));
51 |       }
52 |     } catch (error) {
53 |       console.error(`Error setting localStorage key "${key}":`, error);
54 |     }
55 |   }, [key, storedValue, isBrowser]);
56 | 
57 |   return [storedValue, setValue] as const;
58 | }
59 | 
60 | // Helper function to parse JSON with error handling
61 | function parseJSON<T>(value: string): T {
62 |   try {
63 |     return JSON.parse(value);
64 |   } catch {
65 |     console.error('Error parsing JSON from localStorage');
66 |     return {} as T;
67 |   }
68 | }
69 | 
70 | /**
71 |  * A hook to get a value from localStorage (read-only) with SSR support
72 |  * @param key The localStorage key
73 |  * @param defaultValue The default value if the key doesn't exist
74 |  * @returns The value from localStorage or the default value
75 |  */
76 | export function useLocalStorageValue<T>(key: string, defaultValue: T): T {
77 |   const [value] = useLocalStorage<T>(key, defaultValue);
78 |   return value;
79 | } 
```

lib/hooks/use-scroll-to-bottom.tsx
```
1 | import { useEffect, useRef, type RefObject } from 'react';
2 | 
3 | export function useScrollToBottom(): [
4 |   RefObject<HTMLDivElement>,
5 |   RefObject<HTMLDivElement>,
6 | ] {
7 |   const containerRef = useRef<HTMLDivElement>(null);
8 |   const endRef = useRef<HTMLDivElement>(null);
9 |   const isUserScrollingRef = useRef(false);
10 | 
11 |   useEffect(() => {
12 |     const container = containerRef.current;
13 |     const end = endRef.current;
14 | 
15 |     if (!container || !end) return;
16 | 
17 |     // Initial scroll to bottom
18 |     setTimeout(() => {
19 |       end.scrollIntoView({ behavior: 'instant', block: 'end' });
20 |     }, 100);
21 | 
22 |     // Track if user has manually scrolled up
23 |     const handleScroll = () => {
24 |       if (!container) return;
25 |       
26 |       const { scrollTop, scrollHeight, clientHeight } = container;
27 |       const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
28 |       
29 |       // If user is scrolled up, mark as manually scrolling
30 |       isUserScrollingRef.current = distanceFromBottom > 100;
31 |     };
32 | 
33 |     // Handle mutations
34 |     const observer = new MutationObserver((mutations) => {
35 |       if (!container || !end) return;
36 | 
37 |       // Check if mutation is related to expand/collapse
38 |       const isToggleSection = mutations.some(mutation => {
39 |         // Check if the target or parent is a motion-div (expanded content)
40 |         let target = mutation.target as HTMLElement;
41 |         let isExpand = false;
42 |         
43 |         while (target && target !== container) {
44 |           if (target.classList?.contains('motion-div')) {
45 |             isExpand = true;
46 |             break;
47 |           }
48 |           target = target.parentElement as HTMLElement;
49 |         }
50 |         return isExpand;
51 |       });
52 | 
53 |       // Don't scroll for expand/collapse actions
54 |       if (isToggleSection) return;
55 | 
56 |       // Only auto-scroll if user hasn't manually scrolled up
57 |       if (!isUserScrollingRef.current) {
58 |         // For new messages, use smooth scrolling
59 |         end.scrollIntoView({ behavior: 'smooth', block: 'end' });
60 |       }
61 |     });
62 | 
63 |     observer.observe(container, {
64 |       childList: true,
65 |       subtree: true,
66 |     });
67 | 
68 |     // Add scroll event listener
69 |     container.addEventListener('scroll', handleScroll);
70 | 
71 |     return () => {
72 |       observer.disconnect();
73 |       container.removeEventListener('scroll', handleScroll);
74 |     };
75 |   }, []);
76 | 
77 |   return [containerRef, endRef] as [RefObject<HTMLDivElement>, RefObject<HTMLDivElement>];
78 | }
```

lib/models/blocked-models.json
```
1 | {
2 |   "$schema": "https://json-schema.org/draft/2019-09/schema",
3 |   "description": "List of AI models that have been tested and found to have non-working endpoints",
4 |   "lastUpdated": "2025-07-27T07:58:31.407Z",
5 |   "models": {
6 |     "google/gemini-2.5-pro-exp-03-25": {
7 |       "provider": "openrouter",
8 |       "reason": "No endpoints found",
9 |       "lastTested": "2024-01-01T00:00:00.000Z",
10 |       "testError": "404 - Model not found",
11 |       "retryCount": 0,
12 |       "manuallyBlocked": true
13 |     },
14 |     "coding/gemini-2.5-flash-preview-05-20": {
15 |       "provider": "openrouter",
16 |       "reason": "Added to blocklist - endpoint issues",
17 |       "lastTested": "2024-01-01T00:00:00.000Z",
18 |       "testError": "Connection timeout",
19 |       "retryCount": 0,
20 |       "manuallyBlocked": true
21 |     },
22 |     "google/gemini-2.5-flash-preview-05-20": {
23 |       "provider": "requesty",
24 |       "reason": "Requesty version - no valid endpoint",
25 |       "lastTested": "2024-01-01T00:00:00.000Z",
26 |       "testError": "Invalid model configuration",
27 |       "retryCount": 0,
28 |       "manuallyBlocked": true
29 |     },
30 |     "moonshotai/kimi-k2:free": {
31 |       "provider": "openrouter",
32 |       "reason": "Endpoint test failed: HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"moonshotai/kimi-k2:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Parasail\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
33 |       "lastTested": "2025-07-27T07:32:20.097Z",
34 |       "testError": "HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"moonshotai/kimi-k2:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Parasail\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
35 |       "retryCount": 1,
36 |       "manuallyBlocked": false
37 |     },
38 |     "cognitivecomputations/dolphin-mistral-24b-venice-edition:free": {
39 |       "provider": "openrouter",
40 |       "reason": "Endpoint test failed: HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"cognitivecomputations/dolphin-mistral-24b-venice-edition:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Venice\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
41 |       "lastTested": "2025-07-27T07:32:28.781Z",
42 |       "testError": "HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"cognitivecomputations/dolphin-mistral-24b-venice-edition:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Venice\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
43 |       "retryCount": 1,
44 |       "manuallyBlocked": false
45 |     },
46 |     "baidu/ernie-4.5-300b-a47b": {
47 |       "provider": "openrouter",
48 |       "reason": "Endpoint test failed: HTTP 502: {\"error\":{\"message\":\"Provider returned error\",\"code\":502,\"metadata\":{\"raw\":\"{\\\"message\\\":\\\"unknown error in the model inference server trace_id: 55961200a01655fab684da7f9ae27989\\\",\\\"type\\\":\\\"server_error\\\"}\\n\",\"provider_name\":\"Novita\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
49 |       "lastTested": "2025-07-27T07:33:39.869Z",
50 |       "testError": "HTTP 502: {\"error\":{\"message\":\"Provider returned error\",\"code\":502,\"metadata\":{\"raw\":\"{\\\"message\\\":\\\"unknown error in the model inference server trace_id: 55961200a01655fab684da7f9ae27989\\\",\\\"type\\\":\\\"server_error\\\"}\\n\",\"provider_name\":\"Novita\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
51 |       "retryCount": 1,
52 |       "manuallyBlocked": false
53 |     },
54 |     "openai/o3-pro": {
55 |       "provider": "openrouter",
56 |       "reason": "Endpoint test failed: HTTP 403: {\"error\":{\"message\":\"OpenAI is requiring a key to access this model, which you can add in https://openrouter.ai/settings/integrations - you can also switch to o3-mini.\",\"code\":403}}",
57 |       "lastTested": "2025-07-27T07:34:05.656Z",
58 |       "testError": "HTTP 403: {\"error\":{\"message\":\"OpenAI is requiring a key to access this model, which you can add in https://openrouter.ai/settings/integrations - you can also switch to o3-mini.\",\"code\":403}}",
59 |       "retryCount": 1,
60 |       "manuallyBlocked": false
61 |     },
62 |     "openai/codex-mini": {
63 |       "provider": "openrouter",
64 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
65 |       "lastTested": "2025-07-27T07:34:52.632Z",
66 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
67 |       "retryCount": 1,
68 |       "manuallyBlocked": false
69 |     },
70 |     "qwen/qwen3-4b:free": {
71 |       "provider": "openrouter",
72 |       "reason": "Endpoint test failed: HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"qwen/qwen3-4b:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Venice\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
73 |       "lastTested": "2025-07-27T07:35:14.792Z",
74 |       "testError": "HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"qwen/qwen3-4b:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Venice\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
75 |       "retryCount": 1,
76 |       "manuallyBlocked": false
77 |     },
78 |     "openai/o4-mini-high": {
79 |       "provider": "openrouter",
80 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
81 |       "lastTested": "2025-07-27T07:36:05.662Z",
82 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
83 |       "retryCount": 1,
84 |       "manuallyBlocked": false
85 |     },
86 |     "openai/o3": {
87 |       "provider": "openrouter",
88 |       "reason": "Endpoint test failed: HTTP 403: {\"error\":{\"message\":\"OpenAI is requiring a key to access this model, which you can add in https://openrouter.ai/settings/integrations - you can also switch to o3-mini.\",\"code\":403}}",
89 |       "lastTested": "2025-07-27T07:36:06.745Z",
90 |       "testError": "HTTP 403: {\"error\":{\"message\":\"OpenAI is requiring a key to access this model, which you can add in https://openrouter.ai/settings/integrations - you can also switch to o3-mini.\",\"code\":403}}",
91 |       "retryCount": 1,
92 |       "manuallyBlocked": false
93 |     },
94 |     "openai/o4-mini": {
95 |       "provider": "openrouter",
96 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
97 |       "lastTested": "2025-07-27T07:36:08.141Z",
98 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
99 |       "retryCount": 1,
100 |       "manuallyBlocked": false
101 |     },
102 |     "nvidia/llama-3.1-nemotron-ultra-253b-v1:free": {
103 |       "provider": "openrouter",
104 |       "reason": "Endpoint test failed: HTTP 404: {\"error\":{\"message\":\"Provider returned error\",\"code\":404,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"model not found: nvidia/Llama-3_1-Nemotron-Ultra-253B-v1\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
105 |       "lastTested": "2025-07-27T07:36:45.235Z",
106 |       "testError": "HTTP 404: {\"error\":{\"message\":\"Provider returned error\",\"code\":404,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"model not found: nvidia/Llama-3_1-Nemotron-Ultra-253B-v1\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
107 |       "retryCount": 1,
108 |       "manuallyBlocked": false
109 |     },
110 |     "openai/o1-pro": {
111 |       "provider": "openrouter",
112 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
113 |       "lastTested": "2025-07-27T07:37:18.498Z",
114 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
115 |       "retryCount": 1,
116 |       "manuallyBlocked": false
117 |     },
118 |     "rekaai/reka-flash-3:free": {
119 |       "provider": "openrouter",
120 |       "reason": "Endpoint test failed: HTTP 503: {\"error\":{\"message\":\"Provider returned error\",\"code\":503,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"No instances available (yet) for chute_id='893971c6-0f01-54fc-8cbe-420d24a20b54'\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
121 |       "lastTested": "2025-07-27T07:37:48.832Z",
122 |       "testError": "HTTP 503: {\"error\":{\"message\":\"Provider returned error\",\"code\":503,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"No instances available (yet) for chute_id='893971c6-0f01-54fc-8cbe-420d24a20b54'\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
123 |       "retryCount": 1,
124 |       "manuallyBlocked": false
125 |     },
126 |     "rekaai/reka-flash-3": {
127 |       "provider": "openrouter",
128 |       "reason": "Endpoint test failed: HTTP 503: {\"error\":{\"message\":\"Provider returned error\",\"code\":503,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"No instances available (yet) for chute_id='893971c6-0f01-54fc-8cbe-420d24a20b54'\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
129 |       "lastTested": "2025-07-27T07:37:50.339Z",
130 |       "testError": "HTTP 503: {\"error\":{\"message\":\"Provider returned error\",\"code\":503,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"No instances available (yet) for chute_id='893971c6-0f01-54fc-8cbe-420d24a20b54'\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
131 |       "retryCount": 1,
132 |       "manuallyBlocked": false
133 |     },
134 |     "qwen/qwq-32b:free": {
135 |       "provider": "openrouter",
136 |       "reason": "Endpoint test failed: HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"qwen/qwq-32b:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Venice\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
137 |       "lastTested": "2025-07-27T07:38:18.437Z",
138 |       "testError": "HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"qwen/qwq-32b:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Venice\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
139 |       "retryCount": 1,
140 |       "manuallyBlocked": false
141 |     },
142 |     "openai/o3-mini-high": {
143 |       "provider": "openrouter",
144 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
145 |       "lastTested": "2025-07-27T07:38:50.141Z",
146 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
147 |       "retryCount": 1,
148 |       "manuallyBlocked": false
149 |     },
150 |     "openai/o3-mini": {
151 |       "provider": "openrouter",
152 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
153 |       "lastTested": "2025-07-27T07:39:18.654Z",
154 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
155 |       "retryCount": 1,
156 |       "manuallyBlocked": false
157 |     },
158 |     "deepseek/deepseek-r1-distill-qwen-14b:free": {
159 |       "provider": "openrouter",
160 |       "reason": "Endpoint test failed: HTTP 404: {\"error\":{\"message\":\"Provider returned error\",\"code\":404,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"model not found: deepseek-ai/DeepSeek-R1-Distill-Qwen-14B\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
161 |       "lastTested": "2025-07-27T07:39:29.771Z",
162 |       "testError": "HTTP 404: {\"error\":{\"message\":\"Provider returned error\",\"code\":404,\"metadata\":{\"raw\":\"{\\\"detail\\\":\\\"model not found: deepseek-ai/DeepSeek-R1-Distill-Qwen-14B\\\"}\",\"provider_name\":\"Chutes\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
163 |       "retryCount": 1,
164 |       "manuallyBlocked": false
165 |     },
166 |     "openai/o1": {
167 |       "provider": "openrouter",
168 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
169 |       "lastTested": "2025-07-27T07:40:02.437Z",
170 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\n  \\\"error\\\": {\\n    \\\"message\\\": \\\"Invalid 'max_output_tokens': integer below minimum value. Expected a value >= 16, but got 1 instead.\\\",\\n    \\\"type\\\": \\\"invalid_request_error\\\",\\n    \\\"param\\\": \\\"max_output_tokens\\\",\\n    \\\"code\\\": \\\"integer_below_min_value\\\"\\n  }\\n}\",\"provider_name\":\"OpenAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
171 |       "retryCount": 1,
172 |       "manuallyBlocked": false
173 |     },
174 |     "google/gemini-2.0-flash-exp:free": {
175 |       "provider": "openrouter",
176 |       "reason": "Endpoint test failed: HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"google/gemini-2.0-flash-exp:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Google\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
177 |       "lastTested": "2025-07-27T07:40:10.934Z",
178 |       "testError": "HTTP 429: {\"error\":{\"message\":\"Provider returned error\",\"code\":429,\"metadata\":{\"raw\":\"google/gemini-2.0-flash-exp:free is temporarily rate-limited upstream. Please retry shortly, or add your own key to accumulate your rate limits: https://openrouter.ai/settings/integrations\",\"provider_name\":\"Google\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
179 |       "retryCount": 1,
180 |       "manuallyBlocked": false
181 |     },
182 |     "qwen/qwq-32b-preview": {
183 |       "provider": "openrouter",
184 |       "reason": "Endpoint test failed: HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\\"object\\\":\\\"error\\\",\\\"message\\\":\\\"Only Qwen/Qwen2.5-72B-Instruct && Qwen/Qwen2.5-VL-72B-Instruct && deepseek-ai/DeepSeek-V3-0324 && meta-llama/Meta-Llama-3.1-70B-Instruct && meta-llama/Llama-3.3-70B-Instruct && meta-llama/Llama-3.2-3B-Instruct && FLUX.1-dev && StableDiffusion && meta-llama/Meta-Llama-3.1-8B-Instruct && tt && deepseek-ai/DeepSeek-R1 && moonshotai/Kimi-K2-Instruct && meta-llama/Meta-Llama-3-70B-Instruct && Qwen/Qwen2.5-VL-7B-Instruct && Qwen/Qwen3-235B-A22B && meta-llama/Meta-Llama-3.1-405B-Instruct && Qwen/QwQ-32B && deepseek-ai/DeepSeek-V3 && Qwen/Qwen3-235B-A22B-Instruct-2507 && NousResearch/Hermes-3-Llama-3.1-70B && meta-llama/Meta-Llama-3.1-405B && Qwen/Qwen3-Coder-480B-A35B-Instruct && mistralai/Pixtral-12B-2409 && Qwen/Qwen2.5-Coder-32B-Instruct && TTS && deepseek-ai/DeepSeek-R1-0528 allowed now, your model Qwen/QwQ-32B-Preview\\\",\\\"type\\\":\\\"\\\",\\\"param\\\":null,\\\"code\\\":40301}\",\"provider_name\":\"Hyperbolic\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
185 |       "lastTested": "2025-07-27T07:40:23.426Z",
186 |       "testError": "HTTP 400: {\"error\":{\"message\":\"Provider returned error\",\"code\":400,\"metadata\":{\"raw\":\"{\\\"object\\\":\\\"error\\\",\\\"message\\\":\\\"Only Qwen/Qwen2.5-72B-Instruct && Qwen/Qwen2.5-VL-72B-Instruct && deepseek-ai/DeepSeek-V3-0324 && meta-llama/Meta-Llama-3.1-70B-Instruct && meta-llama/Llama-3.3-70B-Instruct && meta-llama/Llama-3.2-3B-Instruct && FLUX.1-dev && StableDiffusion && meta-llama/Meta-Llama-3.1-8B-Instruct && tt && deepseek-ai/DeepSeek-R1 && moonshotai/Kimi-K2-Instruct && meta-llama/Meta-Llama-3-70B-Instruct && Qwen/Qwen2.5-VL-7B-Instruct && Qwen/Qwen3-235B-A22B && meta-llama/Meta-Llama-3.1-405B-Instruct && Qwen/QwQ-32B && deepseek-ai/DeepSeek-V3 && Qwen/Qwen3-235B-A22B-Instruct-2507 && NousResearch/Hermes-3-Llama-3.1-70B && meta-llama/Meta-Llama-3.1-405B && Qwen/Qwen3-Coder-480B-A35B-Instruct && mistralai/Pixtral-12B-2409 && Qwen/Qwen2.5-Coder-32B-Instruct && TTS && deepseek-ai/DeepSeek-R1-0528 allowed now, your model Qwen/QwQ-32B-Preview\\\",\\\"type\\\":\\\"\\\",\\\"param\\\":null,\\\"code\\\":40301}\",\"provider_name\":\"Hyperbolic\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
187 |       "retryCount": 1,
188 |       "manuallyBlocked": false
189 |     },
190 |     "x-ai/grok-vision-beta": {
191 |       "provider": "openrouter",
192 |       "reason": "Endpoint test failed: HTTP 404: {\"error\":{\"message\":\"Provider returned error\",\"code\":404,\"metadata\":{\"raw\":\"{\\\"code\\\":\\\"Some requested entity was not found\\\",\\\"error\\\":\\\"The model grok-vision-beta does not exist or your team bb642ce4-5161-45c9-8f34-408850883602 does not have access to it. Please ensure you're using the correct API key. If you believe this is a mistake, please contact support and quote your team ID and the model name.\\\"}\",\"provider_name\":\"xAI\"}},\"user_id\":\"user_2ly1KOnY3h2wVmQvG7eELOtIaz1\"}",
193 |       "lastTested": "2025-07-27T07:40:40.221Z",
[TRUNCATED]
```

lib/models/client-constants.ts
```
1 | // Client-safe constants that can be imported by client components
2 | 
3 | // Model migrations for backwards compatibility
4 | export const MODEL_MIGRATIONS = [
5 |     {
6 |         oldId: 'openrouter/anthropic/claude-3.5-sonnet-old',
7 |         newId: 'openrouter/anthropic/claude-3.5-sonnet',
8 |         reason: 'renamed' as const,
9 |         automaticMigration: true,
10 |     },
11 |     // Add more migrations as needed
12 | ];
13 | 
14 | // Cache configuration constants
15 | export const CACHE_CONFIG = {
16 |     modelListTTL: 10 * 60 * 1000,      // 10 minutes
17 |     modelDetailsTTL: 60 * 60 * 1000,   // 1 hour  
18 |     providerHealthTTL: 30 * 1000,      // 30 seconds
19 |     forceRefreshKey: 'force-refresh',   // Admin override
20 | }; 
```

lib/models/fetch-models.ts
```
1 | import {
2 |     ModelInfo,
3 |     ProviderInfo,
4 |     ModelsResponse,
5 |     CachedProviderData,
6 |     ProviderFetchResult,
7 |     ApiKeyContext
8 | } from '@/lib/types/models';
9 | import { PROVIDERS } from './provider-configs';
10 | import { CACHE_CONFIG } from './client-constants';
11 | 
12 | // In-memory cache for provider data
13 | const providerCache = new Map<string, CachedProviderData>();
14 | 
15 | // Rate limiting tracker
16 | const rateLimitTracker = new Map<string, { count: number; resetTime: number }>();
17 | 
18 | // Helper to check if cache is valid
19 | function isCacheValid(cached: CachedProviderData): boolean {
20 |     return new Date() < cached.expiresAt;
21 | }
22 | 
23 | // Helper to get API key for provider
24 | function getProviderApiKey(providerKey: string, apiKeyContext: ApiKeyContext): string | null {
25 |     // Check user-provided keys first
26 |     if (apiKeyContext.user?.[providerKey]) {
27 |         return apiKeyContext.user[providerKey];
28 |     }
29 | 
30 |     // Fall back to environment variables
31 |     if (apiKeyContext.environment[providerKey]) {
32 |         return apiKeyContext.environment[providerKey];
33 |     }
34 | 
35 |     return null;
36 | }
37 | 
38 | // Helper to check rate limits
39 | function checkRateLimit(providerKey: string): boolean {
40 |     const config = PROVIDERS[providerKey];
41 |     if (!config.rateLimit) return true;
42 | 
43 |     const now = Date.now();
44 |     const tracker = rateLimitTracker.get(providerKey);
45 | 
46 |     if (!tracker || now > tracker.resetTime) {
47 |         // Reset rate limit tracker
48 |         rateLimitTracker.set(providerKey, {
49 |             count: 1,
50 |             resetTime: now + (60 * 1000) // 1 minute
51 |         });
52 |         return true;
53 |     }
54 | 
55 |     if (tracker.count >= config.rateLimit.requestsPerMinute) {
56 |         return false;
57 |     }
58 | 
59 |     tracker.count++;
60 |     return true;
61 | }
62 | 
63 | // Health check for a provider
64 | async function checkProviderHealth(
65 |     providerKey: string,
66 |     apiKey: string,
67 |     signal?: AbortSignal
68 | ): Promise<boolean> {
69 |     const config = PROVIDERS[providerKey];
70 |     if (!config.healthCheck) return true;
71 | 
72 |     try {
73 |         const response = await fetch(config.healthCheck, {
74 |             method: 'GET',
75 |             headers: {
76 |                 'Authorization': `Bearer ${apiKey}`,
77 |                 'Content-Type': 'application/json',
78 |             },
79 |             signal,
80 |         });
81 | 
82 |         return response.ok;
83 |     } catch (error) {
84 |         console.warn(`Health check failed for ${providerKey}:`, error);
85 |         return false;
86 |     }
87 | }
88 | 
89 | // Fetch models from a single provider with retry logic
90 | async function fetchProviderModels(
91 |     providerKey: string,
92 |     apiKeyContext: ApiKeyContext,
93 |     signal?: AbortSignal
94 | ): Promise<ProviderFetchResult> {
95 |     const config = PROVIDERS[providerKey];
96 |     const apiKey = getProviderApiKey(config.envKey, apiKeyContext);
97 | 
98 |     const providerInfo: ProviderInfo = {
99 |         name: config.name,
100 |         status: 'down',
101 |         lastChecked: new Date(),
102 |         modelCount: 0,
103 |         hasEnvironmentKey: !!apiKeyContext.environment[config.envKey],
104 |         supportsUserKeys: true,
105 |     };
106 | 
107 |     // Return early if no API key
108 |     if (!apiKey) {
109 |         return {
110 |             success: false,
111 |             models: [],
112 |             provider: {
113 |                 ...providerInfo,
114 |                 error: 'No API key available',
115 |             },
116 |             error: new Error(`No API key found for ${providerKey}`),
117 |         };
118 |     }
119 | 
120 |     // Check rate limits
121 |     if (!checkRateLimit(providerKey)) {
122 |         return {
123 |             success: false,
124 |             models: [],
125 |             provider: {
126 |                 ...providerInfo,
127 |                 status: 'degraded',
128 |                 error: 'Rate limit exceeded',
129 |             },
130 |             error: new Error(`Rate limit exceeded for ${providerKey}`),
131 |         };
132 |     }
133 | 
134 |     // Check provider health first (skip if no health check endpoint)
135 |     if (config.healthCheck) {
136 |         const isHealthy = await checkProviderHealth(providerKey, apiKey, signal);
137 |         if (!isHealthy) {
138 |             return {
139 |                 success: false,
140 |                 models: [],
141 |                 provider: {
142 |                     ...providerInfo,
143 |                     error: 'Health check failed',
144 |                 },
145 |                 error: new Error(`Health check failed for ${providerKey}`),
146 |             };
147 |         }
148 |     }
149 | 
150 |     // Fetch models with retry logic
151 |     let lastError: Error | null = null;
152 |     const retryConfig = config.retryConfig || { maxRetries: 3, backoffMs: 1000 };
153 | 
154 |     for (let attempt = 0; attempt <= retryConfig.maxRetries; attempt++) {
155 |         try {
156 |             const response = await fetch(config.endpoint, {
157 |                 method: 'GET',
158 |                 headers: {
159 |                     'Authorization': `Bearer ${apiKey}`,
160 |                     'Content-Type': 'application/json',
161 |                     'HTTP-Referer': process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com/',
162 |                     'X-Title': process.env.NEXT_PUBLIC_APP_TITLE || 'ChatLima',
163 |                 },
164 |                 signal,
165 |             });
166 | 
167 |             if (!response.ok) {
168 |                 throw new Error(`HTTP ${response.status}: ${response.statusText}`);
169 |             }
170 | 
171 |             const data = await response.json();
172 |             const models = config.parse(data);
173 | 
174 |             return {
175 |                 success: true,
176 |                 models,
177 |                 provider: {
178 |                     ...providerInfo,
179 |                     status: 'healthy',
180 |                     modelCount: models.length,
181 |                 },
182 |             };
183 | 
184 |         } catch (error) {
185 |             lastError = error as Error;
186 | 
187 |             // Don't retry on the last attempt
188 |             if (attempt < retryConfig.maxRetries) {
189 |                 await new Promise(resolve =>
190 |                     setTimeout(resolve, retryConfig.backoffMs * Math.pow(2, attempt))
191 |                 );
192 |             }
193 |         }
194 |     }
195 | 
196 |     return {
197 |         success: false,
198 |         models: [],
199 |         provider: {
200 |             ...providerInfo,
201 |             error: lastError?.message || 'Unknown error',
202 |         },
203 |         error: lastError || new Error('Unknown error'),
204 |     };
205 | }
206 | 
207 | // Get cached data for a provider
208 | function getCachedProviderData(providerKey: string): CachedProviderData | null {
209 |     const cached = providerCache.get(providerKey);
210 |     if (cached && isCacheValid(cached)) {
211 |         return cached;
212 |     }
213 |     return null;
214 | }
215 | 
216 | // Cache provider data
217 | function setCachedProviderData(providerKey: string, data: CachedProviderData): void {
218 |     providerCache.set(providerKey, data);
219 | }
220 | 
221 | // Main function to fetch all models
222 | export async function fetchAllModels(
223 |     apiKeyContext: ApiKeyContext,
224 |     forceRefresh = false,
225 |     signal?: AbortSignal
226 | ): Promise<ModelsResponse> {
227 |     const allModels: ModelInfo[] = [];
228 |     const providers: Record<string, ProviderInfo> = {};
229 |     const userProvidedKeys: string[] = [];
230 |     let cacheHit = false;
231 | 
232 |     // Fetch from each provider
233 |     for (const [providerKey, config] of Object.entries(PROVIDERS)) {
234 |         // Check if user provided API key for this provider
235 |         if (apiKeyContext.user?.[config.envKey]) {
236 |             userProvidedKeys.push(providerKey);
237 |         }
238 | 
239 |         // Try to use cached data first (unless forced refresh)
240 |         if (!forceRefresh) {
241 |             const cached = getCachedProviderData(providerKey);
242 |             if (cached) {
243 |                 allModels.push(...cached.models);
244 |                 providers[providerKey] = cached.provider;
245 |                 cacheHit = true;
246 |                 continue;
247 |             }
248 |         }
249 | 
250 |         // Fetch fresh data
251 |         const result = await fetchProviderModels(providerKey, apiKeyContext, signal);
252 | 
253 |         if (result.success) {
254 |             allModels.push(...result.models);
255 | 
256 |             // Cache the successful result
257 |             const cachedData: CachedProviderData = {
258 |                 models: result.models,
259 |                 provider: result.provider,
260 |                 timestamp: new Date(),
261 |                 expiresAt: new Date(Date.now() + CACHE_CONFIG.modelListTTL),
262 |             };
263 |             setCachedProviderData(providerKey, cachedData);
264 |         }
265 | 
266 |         providers[providerKey] = result.provider;
267 |     }
268 | 
269 |     // Remove duplicates based on model ID (user models take precedence)
270 |     const uniqueModels = allModels.reduce((acc, model) => {
271 |         if (!acc.has(model.id)) {
272 |             acc.set(model.id, model);
273 |         }
274 |         return acc;
275 |     }, new Map<string, ModelInfo>());
276 | 
277 |     return {
278 |         models: Array.from(uniqueModels.values()),
279 |         metadata: {
280 |             lastUpdated: new Date(),
281 |             providers,
282 |             totalModels: uniqueModels.size,
283 |             cacheHit,
284 |             userProvidedKeys: userProvidedKeys.length > 0 ? userProvidedKeys : undefined,
285 |         },
286 |     };
287 | }
288 | 
289 | // Helper to get environment API keys (server-side only)
290 | export function getEnvironmentApiKeys(): Record<string, string> {
291 |     const envKeys: Record<string, string> = {};
292 | 
293 |     for (const config of Object.values(PROVIDERS)) {
294 |         const value = process.env[config.envKey];
295 |         if (value) {
296 |             envKeys[config.envKey] = value;
297 |         }
298 |     }
299 | 
300 |     return envKeys;
301 | }
302 | 
303 | // Clear cache for a specific provider or all providers
304 | export function clearProviderCache(providerKey?: string): void {
305 |     if (providerKey) {
306 |         providerCache.delete(providerKey);
307 |     } else {
308 |         providerCache.clear();
309 |     }
310 | }
311 | 
312 | // Get cache statistics
313 | export function getCacheStats() {
314 |     const stats = {
315 |         totalEntries: providerCache.size,
316 |         validEntries: 0,
317 |         expiredEntries: 0,
318 |     };
319 | 
320 |     for (const cached of providerCache.values()) {
321 |         if (isCacheValid(cached)) {
322 |             stats.validEntries++;
323 |         } else {
324 |             stats.expiredEntries++;
325 |         }
326 |     }
327 | 
328 |     return stats;
329 | }
330 | 
331 | // Server-side utility to get model details by ID
332 | export async function getModelDetails(modelId: string, apiKeyContext?: ApiKeyContext): Promise<ModelInfo | null> {
333 |     try {
334 |         const response = await fetchAllModels(apiKeyContext || { environment: getEnvironmentApiKeys() });
335 |         return response.models.find(model => model.id === modelId) || null;
336 |     } catch (error) {
337 |         console.error(`Failed to fetch model details for ${modelId}:`, error);
338 |         return null;
339 |     }
340 | }
341 | 
342 | // Server-side utility to check if a model has a capability
343 | export async function checkModelCapability(
344 |     modelId: string,
345 |     capability: 'vision' | 'webSearch' | 'premium',
346 |     apiKeyContext?: ApiKeyContext
347 | ): Promise<boolean> {
348 |     const modelInfo = await getModelDetails(modelId, apiKeyContext);
349 |     if (!modelInfo) return false;
350 | 
351 |     switch (capability) {
352 |         case 'vision':
353 |             return modelInfo.vision === true;
354 |         case 'webSearch':
355 |             return modelInfo.supportsWebSearch === true;
356 |         case 'premium':
357 |             return modelInfo.premium === true;
358 |         default:
359 |             return false;
360 |     }
361 | } 
```

lib/models/migration-utils.ts
```
1 | import { ModelMigration } from '@/lib/types/models';
2 | import { MODEL_MIGRATIONS } from './client-constants';
3 | 
4 | // Extended migration data with more real-world scenarios
5 | export const EXTENDED_MODEL_MIGRATIONS: ModelMigration[] = [
6 |     ...MODEL_MIGRATIONS,
7 | 
8 |     // OpenRouter model migrations
9 |     {
10 |         oldId: 'openrouter/anthropic/claude-3.5-sonnet-old',
11 |         newId: 'openrouter/anthropic/claude-3.5-sonnet',
12 |         reason: 'renamed',
13 |         automaticMigration: true,
14 |     },
15 |     {
16 |         oldId: 'openrouter/openai/gpt-4-turbo',
17 |         newId: 'openrouter/openai/gpt-4.1',
18 |         reason: 'renamed',
19 |         automaticMigration: true,
20 |     },
21 |     {
22 |         oldId: 'openrouter/google/gemini-pro',
23 |         newId: 'openrouter/google/gemini-2.5-pro',
24 |         reason: 'moved',
25 |         automaticMigration: true,
26 |     },
27 | 
28 |     // Requesty model migrations
29 |     {
30 |         oldId: 'requesty/anthropic/claude-3-sonnet',
31 |         newId: 'requesty/anthropic/claude-3.5-sonnet',
32 |         reason: 'moved',
33 |         automaticMigration: true,
34 |     },
35 |     {
36 |         oldId: 'requesty/openai/gpt-4-turbo',
37 |         newId: 'requesty/openai/gpt-4.1',
38 |         reason: 'renamed',
39 |         automaticMigration: true,
40 |     },
41 | 
42 |     // Deprecated models (no automatic migration)
43 |     {
44 |         oldId: 'openrouter/anthropic/claude-2',
45 |         newId: 'openrouter/anthropic/claude-3.5-sonnet',
46 |         reason: 'deprecated',
47 |         automaticMigration: false,
48 |     },
49 |     {
50 |         oldId: 'openrouter/openai/gpt-3.5-turbo',
51 |         newId: 'openrouter/openai/gpt-4.1-mini',
52 |         reason: 'deprecated',
53 |         automaticMigration: false,
54 |     },
55 | ];
56 | 
57 | // Migration utilities
58 | export class ModelMigrationManager {
59 |     private migrations: ModelMigration[];
60 |     private notificationCallbacks: Array<(migration: ModelMigration, type: 'auto' | 'manual') => void> = [];
61 | 
62 |     constructor(migrations: ModelMigration[] = EXTENDED_MODEL_MIGRATIONS) {
63 |         this.migrations = migrations;
64 |     }
65 | 
66 |     /**
67 |      * Find migration for a given model ID
68 |      */
69 |     findMigration(oldModelId: string): ModelMigration | null {
70 |         return this.migrations.find(m => m.oldId === oldModelId) || null;
71 |     }
72 | 
73 |     /**
74 |      * Get all migrations from a specific model ID
75 |      */
76 |     getMigrationChain(oldModelId: string): ModelMigration[] {
77 |         const chain: ModelMigration[] = [];
78 |         let currentId = oldModelId;
79 |         let depth = 0;
80 |         const maxDepth = 10; // Prevent infinite loops
81 | 
82 |         while (depth < maxDepth) {
83 |             const migration = this.findMigration(currentId);
84 |             if (!migration) break;
85 | 
86 |             chain.push(migration);
87 |             currentId = migration.newId;
88 |             depth++;
89 |         }
90 | 
91 |         return chain;
92 |     }
93 | 
94 |     /**
95 |      * Get the final migration target for a model ID
96 |      */
97 |     getFinalMigrationTarget(oldModelId: string): { modelId: string; migrations: ModelMigration[] } {
98 |         const chain = this.getMigrationChain(oldModelId);
99 |         const finalId = chain.length > 0 ? chain[chain.length - 1].newId : oldModelId;
100 | 
101 |         return {
102 |             modelId: finalId,
103 |             migrations: chain,
104 |         };
105 |     }
106 | 
107 |     /**
108 |      * Check if a model can be automatically migrated
109 |      */
110 |     canAutoMigrate(oldModelId: string): boolean {
111 |         const chain = this.getMigrationChain(oldModelId);
112 |         return chain.length > 0 && chain.every(m => m.automaticMigration);
113 |     }
114 | 
115 |     /**
116 |      * Perform migration with available models validation
117 |      */
118 |     migrateModel(
119 |         oldModelId: string,
120 |         availableModelIds: string[],
121 |         forceAutoMigration = false
122 |     ): {
123 |         success: boolean;
124 |         newModelId: string;
125 |         migrations: ModelMigration[];
126 |         message?: string;
127 |         requiresUserAction?: boolean;
128 |     } {
129 |         const { modelId: finalId, migrations } = this.getFinalMigrationTarget(oldModelId);
130 | 
131 |         // If no migration exists, check if the model is still available
132 |         if (migrations.length === 0) {
133 |             if (availableModelIds.includes(oldModelId)) {
134 |                 return {
135 |                     success: true,
136 |                     newModelId: oldModelId,
137 |                     migrations: [],
138 |                     message: 'Model is still available',
139 |                 };
140 |             } else {
141 |                 return {
142 |                     success: false,
143 |                     newModelId: oldModelId,
144 |                     migrations: [],
145 |                     message: 'Model is no longer available and no migration path exists',
146 |                     requiresUserAction: true,
147 |                 };
148 |             }
149 |         }
150 | 
151 |         // Check if final target is available
152 |         if (!availableModelIds.includes(finalId)) {
153 |             return {
154 |                 success: false,
155 |                 newModelId: oldModelId,
156 |                 migrations,
157 |                 message: `Migration target "${finalId}" is not available`,
158 |                 requiresUserAction: true,
159 |             };
160 |         }
161 | 
162 |         // Check if auto migration is allowed
163 |         const canAuto = this.canAutoMigrate(oldModelId);
164 |         if (!canAuto && !forceAutoMigration) {
165 |             return {
166 |                 success: false,
167 |                 newModelId: finalId,
168 |                 migrations,
169 |                 message: 'Migration requires user confirmation due to breaking changes',
170 |                 requiresUserAction: true,
171 |             };
172 |         }
173 | 
174 |         // Perform the migration
175 |         const migrationType = canAuto ? 'auto' : 'manual';
176 |         this.notifyMigration(migrations[migrations.length - 1], migrationType);
177 | 
178 |         return {
179 |             success: true,
180 |             newModelId: finalId,
181 |             migrations,
182 |             message: `Successfully migrated from "${oldModelId}" to "${finalId}"`,
183 |         };
184 |     }
185 | 
186 |     /**
187 |      * Find suggested alternative models when migration fails
188 |      */
189 |     findAlternatives(
190 |         unavailableModelId: string,
191 |         availableModelIds: string[],
192 |         preferredProviders?: string[]
193 |     ): string[] {
194 |         // Extract provider and model type from the unavailable model
195 |         const parts = unavailableModelId.split('/');
196 |         const provider = parts[0];
197 |         const modelName = parts.slice(1).join('/').toLowerCase();
198 | 
199 |         const alternatives: Array<{ id: string; score: number }> = [];
200 | 
201 |         for (const availableId of availableModelIds) {
202 |             let score = 0;
203 |             const availableParts = availableId.split('/');
204 |             const availableProvider = availableParts[0];
205 |             const availableModel = availableParts.slice(1).join('/').toLowerCase();
206 | 
207 |             // Prefer same provider
208 |             if (availableProvider === provider) {
209 |                 score += 3;
210 |             }
211 | 
212 |             // Prefer preferred providers
213 |             if (preferredProviders?.includes(availableProvider)) {
214 |                 score += 2;
215 |             }
216 | 
217 |             // Similar model names
218 |             if (availableModel.includes(modelName.split('-')[0]) || modelName.includes(availableModel.split('-')[0])) {
219 |                 score += 2;
220 |             }
221 | 
222 |             // Common model patterns
223 |             if (modelName.includes('claude') && availableModel.includes('claude')) score += 2;
224 |             if (modelName.includes('gpt') && availableModel.includes('gpt')) score += 2;
225 |             if (modelName.includes('gemini') && availableModel.includes('gemini')) score += 2;
226 |             if (modelName.includes('llama') && availableModel.includes('llama')) score += 2;
227 | 
228 |             // Capability patterns
229 |             if (modelName.includes('sonnet') && availableModel.includes('sonnet')) score += 1;
230 |             if (modelName.includes('haiku') && availableModel.includes('haiku')) score += 1;
231 |             if (modelName.includes('opus') && availableModel.includes('opus')) score += 1;
232 |             if (modelName.includes('mini') && availableModel.includes('mini')) score += 1;
233 |             if (modelName.includes('turbo') && availableModel.includes('turbo')) score += 1;
234 | 
235 |             if (score > 0) {
236 |                 alternatives.push({ id: availableId, score });
237 |             }
238 |         }
239 | 
240 |         return alternatives
241 |             .sort((a, b) => b.score - a.score)
242 |             .slice(0, 3)
243 |             .map(alt => alt.id);
244 |     }
245 | 
246 |     /**
247 |      * Register notification callback
248 |      */
249 |     onMigration(callback: (migration: ModelMigration, type: 'auto' | 'manual') => void): void {
250 |         this.notificationCallbacks.push(callback);
251 |     }
252 | 
253 |     /**
254 |      * Notify about migration
255 |      */
256 |     private notifyMigration(migration: ModelMigration, type: 'auto' | 'manual'): void {
257 |         this.notificationCallbacks.forEach(callback => {
258 |             try {
259 |                 callback(migration, type);
260 |             } catch (error) {
261 |                 console.error('Migration notification callback failed:', error);
262 |             }
263 |         });
264 |     }
265 | 
266 |     /**
267 |      * Get migration statistics
268 |      */
269 |     getStatistics(): {
270 |         totalMigrations: number;
271 |         autoMigrations: number;
272 |         manualMigrations: number;
273 |         deprecatedMigrations: number;
274 |         providers: Record<string, number>;
275 |     } {
276 |         const stats = {
277 |             totalMigrations: this.migrations.length,
278 |             autoMigrations: 0,
279 |             manualMigrations: 0,
280 |             deprecatedMigrations: 0,
281 |             providers: {} as Record<string, number>,
282 |         };
283 | 
284 |         for (const migration of this.migrations) {
285 |             if (migration.automaticMigration) {
286 |                 stats.autoMigrations++;
287 |             } else {
288 |                 stats.manualMigrations++;
289 |             }
290 | 
291 |             if (migration.reason === 'deprecated') {
292 |                 stats.deprecatedMigrations++;
293 |             }
294 | 
295 |             // Count by provider
296 |             const provider = migration.oldId.split('/')[0];
297 |             stats.providers[provider] = (stats.providers[provider] || 0) + 1;
298 |         }
299 | 
300 |         return stats;
301 |     }
302 | }
303 | 
304 | // Singleton instance
305 | export const migrationManager = new ModelMigrationManager();
306 | 
307 | // Convenience functions
308 | export const findMigration = (oldModelId: string) => migrationManager.findMigration(oldModelId);
309 | export const canAutoMigrate = (oldModelId: string) => migrationManager.canAutoMigrate(oldModelId);
310 | export const migrateModel = (oldModelId: string, availableModelIds: string[], forceAutoMigration = false) =>
311 |     migrationManager.migrateModel(oldModelId, availableModelIds, forceAutoMigration);
312 | export const findAlternatives = (unavailableModelId: string, availableModelIds: string[], preferredProviders?: string[]) =>
313 |     migrationManager.findAlternatives(unavailableModelId, availableModelIds, preferredProviders);
314 | 
315 | // Notification helpers
316 | export function notifyUserOfMigration(migration: ModelMigration, type: 'auto' | 'manual' = 'auto') {
317 |     const message = type === 'auto'
318 |         ? `Model automatically migrated: ${migration.oldId} → ${migration.newId} (${migration.reason})`
319 |         : `Model migration completed: ${migration.oldId} → ${migration.newId} (${migration.reason})`;
320 | 
321 |     console.info(message);
322 | 
323 |     // Could show a toast notification here in the future
324 |     if (typeof window !== 'undefined' && 'Notification' in window) {
325 |         // Future: Show browser notification for important migrations
326 |     }
327 | }
328 | 
329 | export function notifyUserOfInvalidModel(modelId: string, alternatives?: string[]) {
330 |     let message = `Invalid model "${modelId}" replaced with default model`;
331 | 
332 |     if (alternatives && alternatives.length > 0) {
333 |         message += `. Suggested alternatives: ${alternatives.slice(0, 2).join(', ')}`;
334 |     }
335 | 
336 |     console.warn(message);
337 | 
338 |     // Could show a toast notification here in the future
339 | }
340 | 
341 | // Migration testing utilities (for development)
342 | export function testMigrations() {
343 |     console.group('🔄 Model Migration Tests');
344 | 
345 |     const testCases = [
346 |         'openrouter/anthropic/claude-3.5-sonnet-old',
347 |         'openrouter/openai/gpt-4-turbo',
348 |         'requesty/anthropic/claude-3-sonnet',
349 |         'invalid-model-id',
350 |     ];
351 | 
352 |     const mockAvailableModels = [
353 |         'openrouter/anthropic/claude-3.5-sonnet',
354 |         'openrouter/openai/gpt-4.1',
355 |         'requesty/anthropic/claude-3.5-sonnet',
356 |         'openrouter/google/gemini-2.5-flash',
357 |     ];
358 | 
359 |     for (const testCase of testCases) {
360 |         console.group(`Testing: ${testCase}`);
361 | 
362 |         const migration = findMigration(testCase);
363 |         console.log('Migration found:', migration);
364 | 
365 |         const result = migrateModel(testCase, mockAvailableModels);
366 |         console.log('Migration result:', result);
367 | 
368 |         if (!result.success) {
369 |             const alternatives = findAlternatives(testCase, mockAvailableModels);
370 |             console.log('Suggested alternatives:', alternatives);
371 |         }
372 | 
373 |         console.groupEnd();
374 |     }
375 | 
376 |     console.log('Migration statistics:', migrationManager.getStatistics());
377 |     console.groupEnd();
378 | } 
```

lib/models/provider-configs.ts
```
1 | import { ProviderConfig, ModelInfo, RawProviderModel } from '@/lib/types/models';
2 | import { CACHE_CONFIG } from './client-constants';
3 | import fs from 'fs';
4 | import path from 'path';
5 | 
6 | // Interface for blocked models data
7 | interface BlockedModelsList {
8 |     models: Record<string, {
9 |         provider: string;
10 |         reason: string;
11 |         lastTested: string;
12 |         testError: string;
13 |         retryCount: number;
14 |         manuallyBlocked: boolean;
15 |     }>;
16 | }
17 | 
18 | // Load blocked models from JSON file
19 | function loadBlockedModels(): Set<string> {
20 |     try {
21 |         const blockedModelsPath = path.join(process.cwd(), 'lib/models/blocked-models.json');
22 |         if (!fs.existsSync(blockedModelsPath)) {
23 |             console.warn('Blocked models file not found, using empty blocked list');
24 |             return new Set();
25 |         }
26 | 
27 |         const data = fs.readFileSync(blockedModelsPath, 'utf-8');
28 |         const blockedData: BlockedModelsList = JSON.parse(data);
29 |         return new Set(Object.keys(blockedData.models));
30 |     } catch (error) {
31 |         console.warn('Failed to load blocked models, using empty blocked list:', error);
32 |         return new Set();
33 |     }
34 | }
35 | 
36 | // Cached blocked models (loaded once per process)
37 | let BLOCKED_MODELS: Set<string> | null = null;
38 | 
39 | function getBlockedModels(): Set<string> {
40 |     if (BLOCKED_MODELS === null) {
41 |         BLOCKED_MODELS = loadBlockedModels();
42 |     }
43 |     return BLOCKED_MODELS;
44 | }
45 | 
46 | // OpenRouter model parser
47 | export function parseOpenRouterModels(data: any): ModelInfo[] {
48 |     if (!data || !Array.isArray(data.data)) {
49 |         throw new Error('Invalid OpenRouter API response format');
50 |     }
51 | 
52 |     return data.data
53 |         .filter((model: any) => {
54 |             // Filter out blocked models
55 |             const blockedModels = getBlockedModels();
56 |             if (blockedModels.has(model.id)) {
57 |                 console.warn(`Filtering out blocked model: ${model.id}`);
58 |                 return false;
59 |             }
60 |             return true;
61 |         })
62 |         .map((model: any): ModelInfo => {
63 |             const id = `openrouter/${model.id}`;
64 | 
65 |             // Parse capabilities from model properties
66 |             const capabilities: string[] = [];
67 |             if (model.architecture?.modality?.includes('text')) capabilities.push('Text');
68 |             if (model.architecture?.modality?.includes('image')) capabilities.push('Vision');
69 |             if (model.top_provider?.name?.toLowerCase().includes('anthropic')) capabilities.push('Reasoning');
70 |             if (model.id.includes('code') || model.name?.toLowerCase().includes('code')) capabilities.push('Coding');
71 |             if (model.id.includes('fast') || model.name?.toLowerCase().includes('flash')) capabilities.push('Fast');
72 |             if (model.id.includes('reasoning') || model.id.includes('thinking')) capabilities.push('Reasoning');
73 | 
74 |             // Default capabilities if none detected
75 |             if (capabilities.length === 0) capabilities.push('General Purpose');
76 | 
77 |             // Determine maxTokensRange based on model capabilities
78 |             let maxTokensRange: { min: number; max: number; default: number };
79 | 
80 |             const maxCompletionTokens = model.top_provider?.max_completion_tokens;
81 | 
82 |             // Override max tokens for specific models that have incorrect API limits
83 |             if (model.id.includes('deepseek')) {
84 |                 // DeepSeek models support up to 8000 output tokens (override API reported value)
85 |                 maxTokensRange = {
86 |                     min: 1,
87 |                     max: 8000,
88 |                     default: 4096
89 |                 };
90 |             } else if (maxCompletionTokens && maxCompletionTokens > 0) {
91 |                 // Use the actual max completion tokens from the provider
92 |                 maxTokensRange = {
93 |                     min: 1,
94 |                     max: maxCompletionTokens,
95 |                     default: Math.min(4096, Math.floor(maxCompletionTokens * 0.25))
96 |                 };
97 |             } else {
98 |                 // Handle specific models with known high token limits
99 |                 if (model.id.includes('gemini')) {
100 |                     // Gemini models support high output token limits
101 |                     maxTokensRange = {
102 |                         min: 1,
103 |                         max: 65536,
104 |                         default: 4096
105 |                     };
106 |                 } else if (model.id.includes('claude') && model.id.includes('opus-4')) {
107 |                     // Claude Opus 4 supports high output
108 |                     maxTokensRange = {
109 |                         min: 1,
110 |                         max: 32000,
111 |                         default: 4096
112 |                     };
113 |                 } else if (model.id.includes('claude') && model.id.includes('sonnet-4')) {
114 |                     // Claude Sonnet 4 supports very high output
115 |                     maxTokensRange = {
116 |                         min: 1,
117 |                         max: 64000,
118 |                         default: 4096
119 |                     };
120 |                 } else if (model.id.includes('gpt-4') || model.id.includes('o1') || model.id.includes('o3') || model.id.includes('o4')) {
121 |                     // OpenAI GPT-4 and reasoning models
122 |                     maxTokensRange = {
123 |                         min: 1,
124 |                         max: 32768,
125 |                         default: 4096
126 |                     };
127 |                 } else if (model.id.includes('llama') && model.context_length && model.context_length > 100000) {
128 |                     // Large context Llama models
129 |                     maxTokensRange = {
130 |                         min: 1,
131 |                         max: 16384,
132 |                         default: 4096
133 |                     };
134 |                 } else {
135 |                     // Default fallback based on context length
136 |                     const contextLength = model.context_length || 8192;
137 |                     const estimatedMaxTokens = Math.min(8192, Math.floor(contextLength * 0.5));
138 |                     maxTokensRange = {
139 |                         min: 1,
140 |                         max: estimatedMaxTokens,
141 |                         default: Math.min(4096, Math.floor(estimatedMaxTokens * 0.5))
142 |                     };
143 |                 }
144 |             }
145 | 
146 |             return {
147 |                 id,
148 |                 provider: 'OpenRouter',
149 |                 name: model.name || model.id,
150 |                 description: model.description || `${model.name} via OpenRouter`,
151 |                 capabilities,
152 |                 premium: (() => {
153 |                     if (!model.pricing) return false;
154 |                     const inputPrice = model.pricing.prompt ? parseFloat(model.pricing.prompt) : 0;
155 |                     const outputPrice = model.pricing.completion ? parseFloat(model.pricing.completion) : 0;
156 |                     // Convert per-token pricing to per-million for consistency (multiply by 1M)
157 |                     return (inputPrice * 1000000) >= 3.0 || (outputPrice * 1000000) >= 5.0;
158 |                 })(),
159 |                 vision: model.architecture?.modality?.includes('image') || false,
160 |                 contextMax: model.context_length || undefined,
161 |                 apiVersion: model.id,
162 |                 status: 'available',
163 |                 lastChecked: new Date(),
164 |                 pricing: model.pricing ? {
165 |                     input: model.pricing.prompt !== undefined && model.pricing.prompt !== null && model.pricing.prompt !== ''
166 |                         ? (() => {
167 |                             const parsed = parseFloat(model.pricing.prompt);
168 |                             return !isNaN(parsed) ? parsed : undefined;
169 |                         })()
170 |                         : undefined,
171 |                     output: model.pricing.completion !== undefined && model.pricing.completion !== null && model.pricing.completion !== ''
172 |                         ? (() => {
173 |                             const parsed = parseFloat(model.pricing.completion);
174 |                             return !isNaN(parsed) ? parsed : undefined;
175 |                         })()
176 |                         : undefined,
177 |                     currency: 'USD'
178 |                 } : undefined,
179 |                 // Legacy compatibility
180 |                 enabled: true,
181 |                 supportsWebSearch: true,
182 |                 supportsTemperature: true,
183 |                 supportsMaxTokens: true,
184 |                 supportsSystemInstruction: true,
185 |                 maxTokensRange,
186 |             };
187 |         });
188 | }
189 | 
190 | // Requesty model parser - Dynamic parser for Requesty API
191 | export function parseRequestyModels(data: any): ModelInfo[] {
192 |     if (!data || !Array.isArray(data)) {
193 |         throw new Error('Invalid Requesty API response format');
194 |     }
195 | 
196 |     return data
197 |         .filter((model: any) => {
198 |             // Filter out blocked models
199 |             const modelId = `${model.provider}/${model.model}`;
200 |             const blockedModels = getBlockedModels();
201 |             if (blockedModels.has(modelId)) {
202 |                 console.warn(`Filtering out blocked model: ${modelId}`);
203 |                 return false;
204 |             }
205 |             return true;
206 |         })
207 |         .map((model: any): ModelInfo => {
208 |             const providerId = `${model.provider}/${model.model}`;
209 |             const id = `requesty/${providerId}`;
210 | 
211 |             // Parse capabilities from model properties
212 |             const capabilities: string[] = [];
213 | 
214 |             if (model.supports_vision) capabilities.push('Vision');
215 |             if (model.supports_reasoning) capabilities.push('Reasoning');
216 |             if (model.supports_caching) capabilities.push('Caching');
217 |             if (model.supports_computer_use) capabilities.push('Tools');
218 | 
219 |             // Determine if it's coding-related based on model name
220 |             if (model.model?.toLowerCase().includes('code') ||
221 |                 model.model?.toLowerCase().includes('coder') ||
222 |                 model.description?.toLowerCase().includes('coding')) {
223 |                 capabilities.push('Coding');
224 |             }
225 | 
226 |             // Determine if it's fast based on model name
227 |             if (model.model?.toLowerCase().includes('fast') ||
228 |                 model.model?.toLowerCase().includes('turbo') ||
229 |                 model.model?.toLowerCase().includes('flash')) {
230 |                 capabilities.push('Fast');
231 |             }
232 | 
233 |             // Default to general purpose if no specific capabilities
234 |             if (capabilities.length === 0) capabilities.push('General Purpose');
235 | 
236 |             // Determine if premium based on pricing (threshold of $3+ per million input tokens OR $5+ per million output tokens)
237 |             const inputPrice = parseFloat(model.input_tokens_price_per_million || '0');
238 |             const outputPrice = parseFloat(model.output_tokens_price_per_million || '0');
239 |             const isPremium = inputPrice >= 3.0 || outputPrice >= 5.0;
240 | 
241 |             // Generate a user-friendly name
242 |             const providerName = model.provider.charAt(0).toUpperCase() + model.provider.slice(1);
243 |             const modelName = model.model.split('/').pop() || model.model; // Get last part after slash
244 |             const displayName = `${providerName} ${modelName}`;
245 | 
246 |             return {
247 |                 id,
248 |                 provider: 'Requesty',
249 |                 name: displayName,
250 |                 description: model.description || `${displayName} via Requesty`,
251 |                 capabilities,
252 |                 premium: isPremium,
253 |                 vision: model.supports_vision || false,
254 |                 contextMax: model.context_window || undefined,
255 |                 apiVersion: model.model,
256 |                 status: 'available',
257 |                 lastChecked: new Date(),
258 |                 pricing: {
259 |                     // Requesty provides pricing per million tokens, convert to per token for consistency
260 |                     input: model.input_tokens_price_per_million !== undefined && model.input_tokens_price_per_million !== null && model.input_tokens_price_per_million !== ''
261 |                         ? (() => {
262 |                             const parsed = parseFloat(model.input_tokens_price_per_million);
263 |                             return !isNaN(parsed) ? parsed / 1000000 : undefined; // Convert from per-million to per-token
264 |                         })()
265 |                         : undefined,
266 |                     output: model.output_tokens_price_per_million !== undefined && model.output_tokens_price_per_million !== null && model.output_tokens_price_per_million !== ''
267 |                         ? (() => {
268 |                             const parsed = parseFloat(model.output_tokens_price_per_million);
269 |                             return !isNaN(parsed) ? parsed / 1000000 : undefined; // Convert from per-million to per-token
270 |                         })()
271 |                         : undefined,
272 |                     currency: 'USD'
273 |                 },
274 |                 // Legacy compatibility
275 |                 enabled: true,
276 |                 supportsWebSearch: false, // Requesty doesn't specifically support web search
277 |                 supportsTemperature: true,
278 |                 supportsMaxTokens: true,
279 |                 supportsSystemInstruction: true,
280 |             };
281 |         }).sort((a, b) => {
282 |             // Sort by provider first, then by model name
283 |             const providerCompare = a.name.localeCompare(b.name);
284 |             return providerCompare;
285 |         });
286 | }
287 | 
288 | // Provider configuration registry
289 | export const PROVIDERS: Record<string, ProviderConfig> = {
290 |     openrouter: {
291 |         name: 'OpenRouter',
292 |         envKey: 'OPENROUTER_API_KEY',
293 |         endpoint: 'https://openrouter.ai/api/v1/models',
294 |         healthCheck: 'https://openrouter.ai/api/v1/auth/key',
295 |         parse: parseOpenRouterModels,
296 |         rateLimit: { requestsPerMinute: 60, burstLimit: 10 },
297 |         retryConfig: { maxRetries: 3, backoffMs: 1000 },
298 |     },
299 |     requesty: {
300 |         name: 'Requesty',
301 |         envKey: 'REQUESTY_API_KEY',
302 |         endpoint: 'https://api.requesty.ai/router/models', // Updated to use the actual models API
303 |         healthCheck: undefined, // Requesty doesn't have a specific health check endpoint
304 |         parse: parseRequestyModels,
305 |         rateLimit: { requestsPerMinute: 120, burstLimit: 20 },
306 |         retryConfig: { maxRetries: 3, backoffMs: 500 },
307 |     },
308 |     // Future providers can be added here
309 | } satisfies Record<string, ProviderConfig>;
```

lib/services/chat-sharing.ts
```
1 | import { nanoid } from 'nanoid';
2 | import { db } from '@/lib/db';
3 | import { chats, messages, chatShares } from '@/lib/db/schema';
4 | import { eq, and } from 'drizzle-orm';
5 | import type { MessageRole } from '@/lib/db/schema';
6 | 
7 | // Types for chat sharing
8 | export interface ChatSnapshot {
9 |     version: number;
10 |     chat: {
11 |         title: string;
12 |         createdAt: string;
13 |     };
14 |     messages: SnapshotMessage[];
15 |     metadata: {
16 |         models: string[];
17 |         redaction: {
18 |             hideSystemPrompts: boolean;
19 |             hideToolArgs: boolean;
20 |             excludeMedia: boolean;
21 |             piiRemoved: boolean;
22 |         };
23 |     };
24 | }
25 | 
26 | export interface SnapshotMessage {
27 |     id: string;
28 |     role: MessageRole;
29 |     content: string;
30 |     createdAt: string;
31 |     hasWebSearch?: boolean;
32 | }
33 | 
34 | // Generate secure share ID
35 | export function generateShareId(): string {
36 |     return nanoid(32);
37 | }
38 | 
39 | // Pre-compiled RegExp patterns for better compilation performance
40 | const PII_PATTERNS = [
41 |     // Email addresses
42 |     /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
43 |     // API keys (common patterns)
44 |     /\b[A-Za-z0-9]{20,}\b/g,
45 |     // Phone numbers (various formats)
46 |     /(\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g,
47 |     // Credit card numbers
48 |     /\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/g,
49 |     // SSN patterns
50 |     /\b\d{3}-\d{2}-\d{4}\b/g,
51 | ];
52 | 
53 | // Redaction utilities
54 | class RedactionService {
55 | 
56 |     static redactPII(text: string): string {
57 |         let redacted = text;
58 | 
59 |         for (const pattern of PII_PATTERNS) {
60 |             redacted = redacted.replace(pattern, '[REDACTED]');
61 |         }
62 | 
63 |         return redacted;
64 |     }
65 | 
66 |     static sanitizeMessage(message: any): SnapshotMessage | null {
67 |         // Skip system messages and tool calls
68 |         if (message.role === 'tool') {
69 |             return null;
70 |         }
71 | 
72 |         // Extract text content from parts
73 |         let content = '';
74 |         if (message.parts && Array.isArray(message.parts)) {
75 |             for (const part of message.parts) {
76 |                 if (part.type === 'text' && part.text) {
77 |                     content += part.text;
78 |                 }
79 |                 // Skip media/attachments (images, files, etc.)
80 |             }
81 |         }
82 | 
83 |         // Redact PII from content
84 |         content = this.redactPII(content);
85 | 
86 |         return {
87 |             id: message.id,
88 |             role: message.role as MessageRole,
89 |             content,
90 |             createdAt: message.createdAt.toISOString(),
91 |             hasWebSearch: message.hasWebSearch || false,
92 |         };
93 |     }
94 | }
95 | 
96 | // Chat sharing service
97 | export class ChatSharingService {
98 |     // Verify chat ownership and get chat data
99 |     private static async getChatWithOwnership(chatId: string, userId: string) {
100 |         const chat = await db
101 |             .select()
102 |             .from(chats)
103 |             .where(and(eq(chats.id, chatId), eq(chats.userId, userId)))
104 |             .limit(1);
105 | 
106 |         if (chat.length === 0) {
107 |             throw new Error('Chat not found or access denied');
108 |         }
109 |         return chat[0];
110 |     }
111 | 
112 |     // Get and sanitize messages for a chat
113 |     private static async getSanitizedMessages(chatId: string): Promise<SnapshotMessage[]> {
114 |         const chatMessages = await db
115 |             .select()
116 |             .from(messages)
117 |             .where(eq(messages.chatId, chatId))
118 |             .orderBy(messages.createdAt);
119 | 
120 |         const sanitizedMessages: SnapshotMessage[] = [];
121 |         for (const message of chatMessages) {
122 |             const sanitized = RedactionService.sanitizeMessage(message);
123 |             if (sanitized) {
124 |                 sanitizedMessages.push(sanitized);
125 |             }
126 |         }
127 |         return sanitizedMessages;
128 |     }
129 | 
130 |     // Create a sanitized snapshot of a chat
131 |     static async createSnapshot(chatId: string, userId: string): Promise<ChatSnapshot> {
132 |         const chat = await this.getChatWithOwnership(chatId, userId);
133 |         const sanitizedMessages = await this.getSanitizedMessages(chatId);
134 | 
135 |         return {
136 |             version: 1,
137 |             chat: {
138 |                 title: chat.title,
139 |                 createdAt: chat.createdAt.toISOString(),
140 |             },
141 |             messages: sanitizedMessages,
142 |             metadata: {
143 |                 models: [],
144 |                 redaction: {
145 |                     hideSystemPrompts: true,
146 |                     hideToolArgs: true,
147 |                     excludeMedia: true,
148 |                     piiRemoved: true,
149 |                 },
150 |             },
151 |         };
152 |     }
153 | 
154 |     // Get existing share for a chat (without creating a new one)
155 |     static async getExistingShare(chatId: string, userId: string, baseUrl: string): Promise<{ shareId: string; shareUrl: string } | null> {
156 |         // Check if an active share already exists
157 |         const existingShare = await db
158 |             .select()
159 |             .from(chatShares)
160 |             .where(and(
161 |                 eq(chatShares.chatId, chatId),
162 |                 eq(chatShares.ownerUserId, userId),
163 |                 eq(chatShares.status, 'active')
164 |             ))
165 |             .limit(1);
166 | 
167 |         if (existingShare.length > 0) {
168 |             const share = existingShare[0];
169 |             return {
170 |                 shareId: share.shareId,
171 |                 shareUrl: `${baseUrl}/chats/shared/${share.shareId}`,
172 |             };
173 |         }
174 | 
175 |         return null;
176 |     }
177 | 
178 |     // Create or get existing share for a chat
179 |     static async createShare(chatId: string, userId: string, baseUrl: string): Promise<{ shareId: string; shareUrl: string }> {
180 |         // Check if an active share already exists
181 |         const existingShare = await db
182 |             .select()
183 |             .from(chatShares)
184 |             .where(and(
185 |                 eq(chatShares.chatId, chatId),
186 |                 eq(chatShares.ownerUserId, userId),
187 |                 eq(chatShares.status, 'active')
188 |             ))
189 |             .limit(1);
190 | 
191 |         if (existingShare.length > 0) {
192 |             const share = existingShare[0];
193 |             return {
194 |                 shareId: share.shareId,
195 |                 shareUrl: `${baseUrl}/chats/shared/${share.shareId}`,
196 |             };
197 |         }
198 | 
199 |         // Create new snapshot
200 |         const snapshot = await this.createSnapshot(chatId, userId);
201 |         const shareId = generateShareId();
202 | 
203 |         // Insert new share
204 |         await db.insert(chatShares).values({
205 |             chatId,
206 |             ownerUserId: userId,
207 |             shareId,
208 |             status: 'active',
209 |             visibility: 'unlisted',
210 |             snapshotJson: snapshot,
211 |             viewCount: 0,
212 |         });
213 | 
214 |         return {
215 |             shareId,
216 |             shareUrl: `${baseUrl}/chats/shared/${shareId}`,
217 |         };
218 |     }
219 | 
220 |     // Revoke a chat share
221 |     static async revokeShare(chatId: string, userId: string): Promise<void> {
222 |         await db
223 |             .update(chatShares)
224 |             .set({
225 |                 status: 'revoked',
226 |                 revokedAt: new Date(),
227 |             })
228 |             .where(and(
229 |                 eq(chatShares.chatId, chatId),
230 |                 eq(chatShares.ownerUserId, userId),
231 |                 eq(chatShares.status, 'active')
232 |             ));
233 |     }
234 | 
235 |     // Get shared chat by shareId
236 |     static async getSharedChat(shareId: string): Promise<ChatSnapshot | null> {
237 |         const share = await db
238 |             .select()
239 |             .from(chatShares)
240 |             .where(and(
241 |                 eq(chatShares.shareId, shareId),
242 |                 eq(chatShares.status, 'active')
243 |             ))
244 |             .limit(1);
245 | 
246 |         if (share.length === 0) {
247 |             return null;
248 |         }
249 | 
250 |         // Increment view count (best effort, ignore errors)
251 |         try {
252 |             await db
253 |                 .update(chatShares)
254 |                 .set({
255 |                     viewCount: share[0].viewCount + 1,
256 |                 })
257 |                 .where(eq(chatShares.shareId, shareId));
258 |         } catch (error) {
259 |             console.warn('Failed to increment view count:', error);
260 |         }
261 | 
262 |         return share[0].snapshotJson as ChatSnapshot;
263 |     }
264 | }
```

lib/services/favorites.ts
```
1 | import { db } from '@/lib/db';
2 | import { favoriteModels } from '@/lib/db/schema';
3 | import { eq, and, sql } from 'drizzle-orm';
4 | 
5 | export class FavoritesService {
6 |     /**
7 |      * Get all favorite model IDs for a user
8 |      */
9 |     static async getUserFavorites(userId: string): Promise<string[]> {
10 |         try {
11 |             const userFavorites = await db
12 |                 .select({ modelId: favoriteModels.modelId })
13 |                 .from(favoriteModels)
14 |                 .where(eq(favoriteModels.userId, userId))
15 |                 .orderBy(favoriteModels.createdAt);
16 | 
17 |             return userFavorites.map(f => f.modelId);
18 |         } catch (error) {
19 |             console.error('Error fetching user favorites:', error);
20 |             throw new Error('Failed to fetch user favorites');
21 |         }
22 |     }
23 | 
24 |     /**
25 |      * Add a model to user's favorites
26 |      */
27 |     static async addFavorite(userId: string, modelId: string): Promise<void> {
28 |         try {
29 |             // Check if already favorited
30 |             const existing = await this.isFavorite(userId, modelId);
31 |             if (existing) {
32 |                 return; // Already favorited, no-op
33 |             }
34 | 
35 |             await db.insert(favoriteModels).values({
36 |                 userId,
37 |                 modelId,
38 |             });
39 |         } catch (error) {
40 |             console.error('Error adding favorite:', error);
41 |             throw new Error('Failed to add model to favorites');
42 |         }
43 |     }
44 | 
45 |     /**
46 |      * Remove a model from user's favorites
47 |      */
48 |     static async removeFavorite(userId: string, modelId: string): Promise<void> {
49 |         try {
50 |             await db
51 |                 .delete(favoriteModels)
52 |                 .where(and(
53 |                     eq(favoriteModels.userId, userId),
54 |                     eq(favoriteModels.modelId, modelId)
55 |                 ));
56 |         } catch (error) {
57 |             console.error('Error removing favorite:', error);
58 |             throw new Error('Failed to remove model from favorites');
59 |         }
60 |     }
61 | 
62 |     /**
63 |      * Check if a model is favorited by a user
64 |      */
65 |     static async isFavorite(userId: string, modelId: string): Promise<boolean> {
66 |         try {
67 |             const result = await db
68 |                 .select()
69 |                 .from(favoriteModels)
70 |                 .where(and(
71 |                     eq(favoriteModels.userId, userId),
72 |                     eq(favoriteModels.modelId, modelId)
73 |                 ))
74 |                 .limit(1);
75 | 
76 |             return result.length > 0;
77 |         } catch (error) {
78 |             console.error('Error checking favorite status:', error);
79 |             return false; // Fail silently for favorite status checks
80 |         }
81 |     }
82 | 
83 |     /**
84 |  * Get favorite count for a user
85 |  */
86 |     static async getFavoriteCount(userId: string): Promise<number> {
87 |         try {
88 |             const result = await db
89 |                 .select({ count: sql<number>`count(*)` })
90 |                 .from(favoriteModels)
91 |                 .where(eq(favoriteModels.userId, userId));
92 | 
93 |             return result[0]?.count || 0;
94 |         } catch (error) {
95 |             console.error('Error getting favorite count:', error);
96 |             return 0;
97 |         }
98 |     }
99 | 
100 |     /**
101 |      * Batch check if multiple models are favorited by a user
102 |      */
103 |     static async areFavorites(userId: string, modelIds: string[]): Promise<Record<string, boolean>> {
104 |         try {
105 |             if (modelIds.length === 0) {
106 |                 return {};
107 |             }
108 | 
109 |             const favorites = await db
110 |                 .select({ modelId: favoriteModels.modelId })
111 |                 .from(favoriteModels)
112 |                 .where(eq(favoriteModels.userId, userId));
113 | 
114 |             const favoriteSet = new Set(favorites.map(f => f.modelId));
115 | 
116 |             return modelIds.reduce((acc, modelId) => {
117 |                 acc[modelId] = favoriteSet.has(modelId);
118 |                 return acc;
119 |             }, {} as Record<string, boolean>);
120 |         } catch (error) {
121 |             console.error('Error batch checking favorites:', error);
122 |             // Return all false on error
123 |             return modelIds.reduce((acc, modelId) => {
124 |                 acc[modelId] = false;
125 |                 return acc;
126 |             }, {} as Record<string, boolean>);
127 |         }
128 |     }
129 | } 
```

lib/types/models.ts
```
1 | // Enhanced model system types
2 | 
3 | export interface ModelInfo {
4 |     id: string;            // unique (provider/model-id)
5 |     provider: string;      // "OpenRouter" | "Requesty" | …
6 |     name: string;          // human label
7 |     description?: string;
8 |     capabilities: string[];// normalised tags (code, reasoning…)
9 |     premium: boolean;
10 |     vision: boolean;
11 |     contextMax?: number;
12 |     apiVersion?: string;   // if available
13 | 
14 |     // Status and health tracking
15 |     status: 'available' | 'limited' | 'deprecated' | 'unavailable';
16 |     lastChecked: Date;
17 |     errorMessage?: string;
18 |     providerHealth?: 'healthy' | 'degraded' | 'down';
19 | 
20 |     // Enhanced metadata
21 |     pricing?: {
22 |         input?: number;      // per token
23 |         output?: number;     // per token
24 |         currency?: string;
25 |     };
26 |     rateLimit?: {
27 |         requestsPerMinute?: number;
28 |         tokensPerMinute?: number;
29 |     };
30 | 
31 |     // Favorites support
32 |     isFavorite?: boolean;    // Whether this model is favorited by the current user
33 | 
34 |     // Legacy compatibility fields for existing features
35 |     enabled?: boolean;
36 |     supportsWebSearch?: boolean;
37 |     temperatureRange?: { min: number; max: number; default: number };
38 |     maxTokensRange?: { min: number; max: number; default: number };
39 |     supportsTemperature?: boolean;
40 |     supportsMaxTokens?: boolean;
41 |     supportsSystemInstruction?: boolean;
42 |     maxSystemInstructionLength?: number;
43 | }
44 | 
45 | export interface ProviderInfo {
46 |     name: string;
47 |     status: 'healthy' | 'degraded' | 'down';
48 |     lastChecked: Date;
49 |     modelCount: number;
50 |     error?: string;
51 |     hasEnvironmentKey: boolean;
52 |     supportsUserKeys: boolean;
53 | }
54 | 
55 | export interface RawProviderModel {
56 |     // Generic structure - each provider will have different fields
57 |     id: string;
58 |     name?: string;
59 |     description?: string;
60 |     [key: string]: any; // Allow additional provider-specific fields
61 | }
62 | 
63 | export interface ModelsResponse {
64 |     models: ModelInfo[];
65 |     metadata: {
66 |         lastUpdated: Date;
67 |         providers: Record<string, ProviderInfo>;
68 |         totalModels: number;
69 |         cacheHit: boolean;
70 |         userProvidedKeys?: string[]; // Which providers used user keys
71 |     };
72 | }
73 | 
74 | export interface ProviderConfig {
75 |     name: string;
76 |     envKey: string;
77 |     endpoint: string;
78 |     parse: (data: any) => ModelInfo[];
79 |     healthCheck?: string;           // Endpoint for provider health
80 |     rateLimit?: {                  // Rate limiting config
81 |         requestsPerMinute: number;
82 |         burstLimit: number;
83 |     };
84 |     retryConfig?: {                // Retry strategy
85 |         maxRetries: number;
86 |         backoffMs: number;
87 |     };
88 | }
89 | 
90 | export interface CacheConfig {
91 |     modelListTTL: number;      // 10 minutes
92 |     modelDetailsTTL: number;   // 1 hour  
93 |     providerHealthTTL: number; // 30 seconds
94 |     forceRefreshKey: string;   // Admin override
95 | }
96 | 
97 | export interface ModelMigration {
98 |     oldId: string;
99 |     newId: string;
100 |     reason: 'renamed' | 'moved' | 'deprecated';
101 |     automaticMigration: boolean;
102 | }
103 | 
104 | export interface CachedProviderData {
105 |     models: ModelInfo[];
106 |     provider: ProviderInfo;
107 |     timestamp: Date;
108 |     expiresAt: Date;
109 | }
110 | 
111 | export interface ProviderFetchResult {
112 |     success: boolean;
113 |     models: ModelInfo[];
114 |     provider: ProviderInfo;
115 |     error?: Error;
116 | }
117 | 
118 | export interface ApiKeyContext {
119 |     environment: Record<string, string>; // Environment variables
120 |     user?: Record<string, string>;       // User-provided keys
121 | } 
```

lib/utils/auth-performance-monitor.ts
```
1 | "use client";
2 | 
3 | /**
4 |  * Auth Performance Monitor
5 |  * 
6 |  * This utility helps track and monitor auth-related API calls to identify performance issues.
7 |  * It should be imported and initialized in development mode to track excessive auth calls.
8 |  */
9 | 
10 | interface AuthCallMetrics {
11 |     totalCalls: number;
12 |     callsByEndpoint: Map<string, number>;
13 |     lastCallTime: number;
14 |     callTimestamps: number[];
15 | }
16 | 
17 | class AuthPerformanceMonitor {
18 |     private metrics: AuthCallMetrics = {
19 |         totalCalls: 0,
20 |         callsByEndpoint: new Map(),
21 |         lastCallTime: 0,
22 |         callTimestamps: [],
23 |     };
24 | 
25 |     private observer: PerformanceObserver | null = null;
26 |     private isMonitoring = false;
27 | 
28 |     constructor() {
29 |         if (typeof window === 'undefined') return;
30 |     }
31 | 
32 |     start() {
33 |         if (typeof window === 'undefined' || this.isMonitoring) return;
34 | 
35 |         console.log('🔍 Auth Performance Monitor: Started monitoring auth calls');
36 | 
37 |         // Intercept fetch to monitor auth-related API calls
38 |         const originalFetch = window.fetch;
39 |         window.fetch = async (...args) => {
40 |             const [resource, config] = args;
41 |             const url = typeof resource === 'string'
42 |                 ? resource
43 |                 : resource instanceof URL
44 |                     ? resource.toString()
45 |                     : resource.url;
46 | 
47 |             // Track auth-related endpoints
48 |             if (this.isAuthEndpoint(url)) {
49 |                 this.recordCall(url);
50 |             }
51 | 
52 |             return originalFetch.apply(window, args);
53 |         };
54 | 
55 |         // Set up performance observer for additional monitoring
56 |         this.observer = new PerformanceObserver((list) => {
57 |             const entries = list.getEntries();
58 |             entries.forEach(entry => {
59 |                 if (entry.entryType === 'resource' && this.isAuthEndpoint(entry.name)) {
60 |                     // Additional tracking via Performance API
61 |                 }
62 |             });
63 |         });
64 | 
65 |         try {
66 |             this.observer.observe({ entryTypes: ['resource'] });
67 |         } catch (e) {
68 |             // Some browsers might not support all entry types
69 |         }
70 | 
71 |         this.isMonitoring = true;
72 | 
73 |         // Report metrics every 5 seconds in development
74 |         if (process.env.NODE_ENV === 'development') {
75 |             setInterval(() => this.report(), 5000);
76 |         }
77 |     }
78 | 
79 |     stop() {
80 |         if (this.observer) {
81 |             this.observer.disconnect();
82 |             this.observer = null;
83 |         }
84 |         this.isMonitoring = false;
85 |         console.log('🔍 Auth Performance Monitor: Stopped monitoring');
86 |     }
87 | 
88 |     private isAuthEndpoint(url: string): boolean {
89 |         const authPatterns = [
90 |             '/api/auth',
91 |             '/api/usage',
92 |             '/api/credits',
93 |             '/_better-auth',
94 |             '/api/debug-credits',
95 |         ];
96 | 
97 |         return authPatterns.some(pattern => url.includes(pattern));
98 |     }
99 | 
100 |     private recordCall(endpoint: string) {
101 |         const now = Date.now();
102 |         this.metrics.totalCalls++;
103 |         this.metrics.lastCallTime = now;
104 |         this.metrics.callTimestamps.push(now);
105 | 
106 |         // Keep only last 100 timestamps
107 |         if (this.metrics.callTimestamps.length > 100) {
108 |             this.metrics.callTimestamps.shift();
109 |         }
110 | 
111 |         // Extract clean endpoint name
112 |         const cleanEndpoint = this.extractEndpoint(endpoint);
113 |         const currentCount = this.metrics.callsByEndpoint.get(cleanEndpoint) || 0;
114 |         this.metrics.callsByEndpoint.set(cleanEndpoint, currentCount + 1);
115 | 
116 |         // Warn if too many calls in short period
117 |         const recentCalls = this.metrics.callTimestamps.filter(
118 |             timestamp => timestamp > now - 1000 // Last second
119 |         ).length;
120 | 
121 |         if (recentCalls > 5) {
122 |             console.warn(
123 |                 `⚠️ Auth Performance Warning: ${recentCalls} auth calls in the last second!`,
124 |                 { endpoint: cleanEndpoint, totalCalls: this.metrics.totalCalls }
125 |             );
126 |         }
127 |     }
128 | 
129 |     private extractEndpoint(url: string): string {
130 |         try {
131 |             const urlObj = new URL(url, window.location.origin);
132 |             return urlObj.pathname;
133 |         } catch {
134 |             return url;
135 |         }
136 |     }
137 | 
138 |     report() {
139 |         if (this.metrics.totalCalls === 0) return;
140 | 
141 |         console.group('📊 Auth Performance Report');
142 |         console.log(`Total Auth Calls: ${this.metrics.totalCalls}`);
143 |         console.log('Calls by Endpoint:');
144 | 
145 |         const sortedEndpoints = Array.from(this.metrics.callsByEndpoint.entries())
146 |             .sort((a, b) => b[1] - a[1]);
147 | 
148 |         sortedEndpoints.forEach(([endpoint, count]) => {
149 |             console.log(`  ${endpoint}: ${count} calls`);
150 |         });
151 | 
152 |         // Calculate calls per minute
153 |         const now = Date.now();
154 |         const callsLastMinute = this.metrics.callTimestamps.filter(
155 |             timestamp => timestamp > now - 60000
156 |         ).length;
157 | 
158 |         console.log(`Calls in last minute: ${callsLastMinute}`);
159 | 
160 |         if (this.metrics.totalCalls > 50) {
161 |             console.warn('⚠️ High number of auth calls detected! Consider investigating.');
162 |         }
163 | 
164 |         console.groupEnd();
165 |     }
166 | 
167 |     reset() {
168 |         this.metrics = {
169 |             totalCalls: 0,
170 |             callsByEndpoint: new Map(),
171 |             lastCallTime: 0,
172 |             callTimestamps: [],
173 |         };
174 |         console.log('🔍 Auth Performance Monitor: Metrics reset');
175 |     }
176 | 
177 |     getMetrics() {
178 |         return {
179 |             ...this.metrics,
180 |             callsByEndpoint: Object.fromEntries(this.metrics.callsByEndpoint),
181 |         };
182 |     }
183 | }
184 | 
185 | // Create singleton instance
186 | const authMonitor = new AuthPerformanceMonitor();
187 | 
188 | // Auto-start in development
189 | if (process.env.NODE_ENV === 'development' && typeof window !== 'undefined') {
190 |     // Start monitoring after a short delay to ensure app is initialized
191 |     setTimeout(() => {
192 |         authMonitor.start();
193 |     }, 1000);
194 | }
195 | 
196 | export { authMonitor };
```

agentsmith/prompts/default/prompt.json
```
1 | {
2 |   "uuid": "cf77312a-270e-4961-8b32-9baf7cab104c",
3 |   "name": "default",
4 |   "slug": "default",
5 |   "latestVersion": null,
6 |   "created_at": "2025-07-31T06:22:36.321205+00:00",
7 |   "updated_at": "2025-08-01T07:04:20.624335+00:00"
8 | }
```

app/api/chat/route.ts
```
1 | import { model, type modelID, getLanguageModelWithKeys, createOpenRouterClientWithKey } from "@/ai/providers";
2 | import { getModelDetails } from "@/lib/models/fetch-models";
3 | import { type ModelInfo } from "@/lib/types/models";
4 | import { createOpenRouter } from "@openrouter/ai-sdk-provider";
5 | import { getApiKey } from "@/ai/providers";
6 | import { streamText, type UIMessage, type LanguageModelResponseMetadata, type Message } from "ai";
7 | import { validatePresetParameters, getModelDefaults, sanitizeSystemInstruction } from "@/lib/parameter-validation";
8 | import { appendResponseMessages } from 'ai';
9 | import { saveChat, saveMessages, convertToDBMessages } from '@/lib/chat-store';
10 | import { nanoid } from 'nanoid';
11 | import { db } from '@/lib/db';
12 | import { chats } from '@/lib/db/schema';
13 | import { eq, and } from 'drizzle-orm';
14 | import { trackTokenUsage, hasEnoughCredits, WEB_SEARCH_COST } from '@/lib/tokenCounter';
15 | import { getRemainingCredits, getRemainingCreditsByExternalId } from '@/lib/polar';
16 | import { auth, checkMessageLimit } from '@/lib/auth';
17 | import type { ImageUIPart } from '@/lib/types';
18 | import { convertToOpenRouterFormat } from '@/lib/openrouter-utils';
19 | 
20 | import { experimental_createMCPClient as createMCPClient, MCPTransport } from 'ai';
21 | import { Experimental_StdioMCPTransport as StdioMCPTransport } from 'ai/mcp-stdio';
22 | import { StreamableHTTPClientTransport } from '@modelcontextprotocol/sdk/client/streamableHttp.js';
23 | import { spawn } from "child_process";
24 | 
25 | // Allow streaming responses up to 300 seconds on Hobby plan
26 | export const maxDuration = 300;
27 | 
28 | // Helper function to check if user is using their own API keys for the selected model
29 | function checkIfUsingOwnApiKeys(selectedModel: modelID, apiKeys: Record<string, string> = {}): boolean {
30 |   // Map model providers to their API key names
31 |   const providerKeyMap: Record<string, string> = {
32 |     'openai': 'OPENAI_API_KEY',
33 |     'anthropic': 'ANTHROPIC_API_KEY',
34 |     'groq': 'GROQ_API_KEY',
35 |     'xai': 'XAI_API_KEY',
36 |     'openrouter': 'OPENROUTER_API_KEY',
37 |     'requesty': 'REQUESTY_API_KEY'
38 |   };
39 | 
40 |   // Extract provider from model ID
41 |   const provider = selectedModel.split('/')[0];
42 |   const requiredApiKey = providerKeyMap[provider];
43 | 
44 |   if (!requiredApiKey) {
45 |     return false; // Unknown provider
46 |   }
47 | 
48 |   // Check if user has provided their own API key for this provider
49 |   const hasApiKey = Boolean(apiKeys[requiredApiKey] && apiKeys[requiredApiKey].trim().length > 0);
50 | 
51 |   return hasApiKey;
52 | }
53 | 
54 | interface KeyValuePair {
55 |   key: string;
56 |   value: string;
57 | }
58 | 
59 | interface MCPServerConfig {
60 |   url: string;
61 |   type: 'sse' | 'stdio' | 'streamable-http';
62 |   command?: string;
63 |   args?: string[];
64 |   env?: KeyValuePair[];
65 |   headers?: KeyValuePair[];
66 | }
67 | 
68 | interface WebSearchOptions {
69 |   enabled: boolean;
70 |   contextSize: 'low' | 'medium' | 'high';
71 | }
72 | 
73 | interface UrlCitation {
74 |   url: string;
75 |   title: string;
76 |   content?: string;
77 |   start_index: number;
78 |   end_index: number;
79 | }
80 | 
81 | interface Annotation {
82 |   type: string;
83 |   url_citation: UrlCitation;
84 | }
85 | 
86 | interface OpenRouterResponse extends LanguageModelResponseMetadata {
87 |   readonly messages: Message[];
88 |   annotations?: Annotation[];
89 |   body?: unknown;
90 | }
91 | 
92 | // Helper to create standardized error responses
93 | const createErrorResponse = (
94 |   code: string,
95 |   message: string,
96 |   status: number,
97 |   details?: string
98 | ) => {
99 |   return new Response(
100 |     JSON.stringify({ error: { code, message, details } }),
101 |     { status, headers: { "Content-Type": "application/json" } }
102 |   );
103 | };
104 | 
105 | export async function POST(req: Request) {
106 |   console.log('[DEBUG] Chat API called');
107 | 
108 |   const {
109 |     messages,
110 |     chatId,
111 |     selectedModel,
112 |     mcpServers: initialMcpServers = [],
113 |     webSearch = { enabled: false, contextSize: 'medium' },
114 |     apiKeys = {},
115 |     attachments = [],
116 |     // NEW: Add preset parameter support
117 |     temperature,
118 |     maxTokens,
119 |     systemInstruction
120 |   }: {
121 |     messages: UIMessage[];
122 |     chatId?: string;
123 |     selectedModel: modelID;
124 |     mcpServers?: MCPServerConfig[];
125 |     webSearch?: WebSearchOptions;
126 |     apiKeys?: Record<string, string>;
127 |     attachments?: Array<{
128 |       name: string;
129 |       contentType: string;
130 |       url: string;
131 |     }>;
132 |     // NEW: Add preset parameter types
133 |     temperature?: number;
134 |     maxTokens?: number;
135 |     systemInstruction?: string;
136 |   } = await req.json();
137 | 
138 |   console.log('[DEBUG] Request body parsed:', {
139 |     messagesCount: messages.length,
140 |     chatId,
141 |     selectedModel,
142 |     attachmentsCount: attachments.length,
143 |     webSearchEnabled: webSearch.enabled,
144 |     hasTemperature: temperature !== undefined,
145 |     hasMaxTokens: maxTokens !== undefined,
146 |     hasSystemInstruction: systemInstruction !== undefined
147 |   });
148 | 
149 |   // Get model info for validation and defaults
150 |   const selectedModelInfo = await getModelDetails(selectedModel);
151 | 
152 |   // NEW: Validate preset parameters
153 |   if (temperature !== undefined || maxTokens !== undefined || systemInstruction !== undefined) {
154 |     const validation = validatePresetParameters(selectedModelInfo, temperature, maxTokens, systemInstruction);
155 |     if (!validation.valid) {
156 |       console.error('[Parameter Validation] Invalid preset parameters:', validation.errors);
157 |       return createErrorResponse(
158 |         "INVALID_PARAMETERS",
159 |         `Invalid preset parameters: ${validation.errors.join(', ')}`,
160 |         400,
161 |         validation.errors.join('; ')
162 |       );
163 |     }
164 |     console.log('[Parameter Validation] Preset parameters validated successfully');
165 |   }
166 | 
167 |   if (attachments.length > 0) {
168 |     console.log('[DEBUG] Attachments received:', attachments.map(att => ({
169 |       name: att.name,
170 |       contentType: att.contentType,
171 |       urlPrefix: att.url.substring(0, 50) + '...'
172 |     })));
173 |   }
174 | 
175 |   let mcpServers = initialMcpServers;
176 | 
177 |   // Disable MCP servers for DeepSeek R1 models
178 |   if (
179 |     selectedModel === "openrouter/deepseek/deepseek-r1" ||
180 |     selectedModel === "openrouter/deepseek/deepseek-r1-0528" ||
181 |     selectedModel === "openrouter/deepseek/deepseek-r1-0528-qwen3-8b"
182 |     //selectedModel === "openrouter/x-ai/grok-3-beta" ||
183 |     //selectedModel === "openrouter/x-ai/grok-3-mini-beta" ||
184 |     //selectedModel === "openrouter/x-ai/grok-3-mini-beta-reasoning-high"
185 |   ) {
186 |     mcpServers = [];
187 |   }
188 | 
189 |   // Process attachments into message parts
190 |   async function processMessagesWithAttachments(
191 |     messages: UIMessage[],
192 |     attachments: Array<{ name: string; contentType: string; url: string }>,
193 |     modelInfo: ModelInfo | null
194 |   ): Promise<UIMessage[]> {
195 |     console.log('[DEBUG] processMessagesWithAttachments called with:', {
196 |       messagesCount: messages.length,
197 |       attachmentsCount: attachments.length
198 |     });
199 | 
200 |     if (attachments.length === 0) {
201 |       console.log('[DEBUG] No attachments, returning original messages');
202 |       return messages;
203 |     }
204 | 
205 |     // Check if model supports vision
206 |     const supportsVision = modelInfo?.vision === true;
207 |     console.log('[DEBUG] Model vision support check:', {
208 |       selectedModel,
209 |       supportsVision
210 |     });
211 | 
212 |     if (!supportsVision) {
213 |       console.error('[ERROR] Model does not support vision:', selectedModel);
214 |       throw new Error(`Selected model ${selectedModel} does not support image inputs. Please choose a vision-capable model.`);
215 |     }
216 | 
217 |     // Add attachments to the last user message
218 |     const processedMessages = [...messages];
219 |     const lastMessageIndex = processedMessages.length - 1;
220 | 
221 |     console.log('[DEBUG] Processing attachments for message at index:', lastMessageIndex);
222 | 
223 |     if (lastMessageIndex >= 0 && processedMessages[lastMessageIndex].role === 'user') {
224 |       const lastMessage = processedMessages[lastMessageIndex];
225 |       console.log('[DEBUG] Last message:', {
226 |         role: lastMessage.role,
227 |         content: lastMessage.content?.substring(0, 100),
228 |         hasExistingParts: !!lastMessage.parts,
229 |         existingPartsCount: lastMessage.parts?.length || 0
230 |       });
231 | 
232 |       // Convert attachments to image parts
233 |       const imageParts: ImageUIPart[] = attachments.map((attachment, index) => {
234 |         console.log('[DEBUG] Converting attachment', index, ':', {
235 |           name: attachment.name,
236 |           contentType: attachment.contentType,
237 |           urlLength: attachment.url.length,
238 |           isValidDataUrl: attachment.url.startsWith('data:image/')
239 |         });
240 | 
241 |         return {
242 |           type: 'image_url' as const,
243 |           image_url: {
244 |             url: attachment.url,
245 |             detail: 'auto' as const
246 |           },
247 |           metadata: {
248 |             filename: attachment.name,
249 |             mimeType: attachment.contentType,
250 |             size: 0, // We don't have size info from the attachment
251 |             width: 0,
252 |             height: 0
253 |           }
254 |         };
255 |       });
256 | 
257 |       console.log('[DEBUG] Created image parts:', imageParts.length);
258 | 
259 |       // Create new parts array with type assertion
260 |       const existingParts = lastMessage.parts || [{ type: 'text', text: lastMessage.content }];
261 |       const newParts = [...existingParts, ...imageParts] as any;
262 | 
263 |       console.log('[DEBUG] Combined parts:', {
264 |         existingPartsCount: existingParts.length,
265 |         newImagePartsCount: imageParts.length,
266 |         totalPartsCount: newParts.length
267 |       });
268 | 
269 |       processedMessages[lastMessageIndex] = {
270 |         ...lastMessage,
271 |         parts: newParts
272 |       };
273 | 
274 |       console.log('[DEBUG] Updated last message with image parts');
275 |     } else {
276 |       console.warn('[WARN] No user message found to attach images to, or last message is not from user');
277 |     }
278 | 
279 |     console.log('[DEBUG] Returning processed messages with attachments');
280 |     return processedMessages;
281 |   }
282 | 
283 |   // Process messages with attachments
284 |   const processedMessages = await processMessagesWithAttachments(messages, attachments, selectedModelInfo);
285 | 
286 |   // Get the authenticated session (including anonymous users)
287 |   const session = await auth.api.getSession({ headers: req.headers });
288 | 
289 |   // If no session exists, return error
290 |   if (!session || !session.user || !session.user.id) {
291 |     return createErrorResponse(
292 |       "AUTHENTICATION_REQUIRED",
293 |       "Authentication required. Please log in.",
294 |       401
295 |     );
296 |   }
297 | 
298 |   const userId = session.user.id;
299 |   const isAnonymous = (session.user as any).isAnonymous === true;
300 | 
301 |   // Try to get the Polar customer ID from session
302 |   const polarCustomerId: string | undefined = (session.user as any)?.polarCustomerId ||
303 |     (session.user as any)?.metadata?.polarCustomerId;
304 | 
305 |   // Estimate ~30 tokens per message as a basic check
306 |   const estimatedTokens = 30;
307 | 
308 |   // Check if user is using their own API keys
309 |   const isUsingOwnApiKeys = checkIfUsingOwnApiKeys(selectedModel, apiKeys);
310 |   console.log(`[Debug] User ${userId} - isUsingOwnApiKeys: ${isUsingOwnApiKeys}`);
311 | 
312 |   // Check if the model is free (ends with :free)
313 |   const isFreeModel = selectedModel.endsWith(':free');
314 |   console.log(`[Debug] User ${userId} - isFreeModel: ${isFreeModel}`);
315 | 
316 |   // 1. Check if user has sufficient credits (if they have a Polar account and not using own keys)
317 |   let hasCredits = false;
318 |   let actualCredits: number | null = null;
319 |   console.log(`[Debug] User ${userId} - isAnonymous: ${isAnonymous}, polarCustomerId: ${polarCustomerId}`);
320 | 
321 |   // Skip credit checks entirely if user is using their own API keys or using a free model
322 |   if (isUsingOwnApiKeys) {
323 |     console.log(`[Debug] User ${userId} is using own API keys, skipping credit checks`);
324 |     hasCredits = true; // Allow request to proceed
325 |   } else if (isFreeModel) {
326 |     console.log(`[Debug] User ${userId} is using a free model (${selectedModel}), skipping credit checks`);
327 |     hasCredits = true; // Allow request to proceed
328 |   } else {
329 |     try {
330 |       // Get model info for premium model checks
331 |       const modelInfo = await getModelDetails(selectedModel);
332 | 
333 |       // Check credits using both the external ID (userId) and legacy polarCustomerId
334 |       // Pass isAnonymous flag to skip Polar checks for anonymous users
335 |       // Pass model info to check for premium model access
336 |       hasCredits = await hasEnoughCredits(polarCustomerId, userId, estimatedTokens, isAnonymous, modelInfo || undefined);
337 |       console.log(`[Debug] hasEnoughCredits result: ${hasCredits}`);
338 | 
339 |       // Also get the actual credit balance to check for negative balances
340 |       if (!isAnonymous) {
341 |         if (userId) {
342 |           try {
343 |             actualCredits = await getRemainingCreditsByExternalId(userId);
344 |             console.log(`[Debug] Actual credits for user ${userId}: ${actualCredits}`);
345 |           } catch (error) {
346 |             console.warn('Error getting actual credits by external ID:', error);
347 |             // Fall back to legacy method
348 |             if (polarCustomerId) {
349 |               try {
350 |                 actualCredits = await getRemainingCredits(polarCustomerId);
351 |                 console.log(`[Debug] Actual credits via legacy method: ${actualCredits}`);
352 |               } catch (legacyError) {
353 |                 console.warn('Error getting actual credits by legacy method:', legacyError);
354 |               }
355 |             }
356 |           }
357 |         }
358 |       }
359 |     } catch (error: any) {
360 |       // Log but continue - don't block users if credit check fails
361 |       console.error('[CreditCheckError] Error checking credits:', error);
362 |       // Potentially return a specific error if this failure is critical
363 |       // For now, matches existing behavior of allowing request if check fails.
364 |     }
365 |   }
366 | 
367 |   // 2. Check for negative credit balance - block if user has negative credits (skip if using own API keys or free model)
368 |   if (!isUsingOwnApiKeys && !isFreeModel && !isAnonymous && actualCredits !== null && actualCredits < 0) {
369 |     console.log(`[Debug] User ${userId} has negative credits (${actualCredits}), blocking request`);
370 |     return createErrorResponse(
371 |       "INSUFFICIENT_CREDITS",
372 |       `Your account has a negative credit balance (${actualCredits}). Please purchase more credits to continue.`,
373 |       402,
374 |       `User has ${actualCredits} credits`
375 |     );
376 |   }
377 | 
378 |   // SECURITY FIX: Block premium model access for users without credits
379 |   // This prevents anonymous users and users without credits from accessing expensive models
380 |   if (!isUsingOwnApiKeys && !isFreeModel && !hasCredits && selectedModelInfo?.premium) {
381 |     const userType = isAnonymous ? "Anonymous users" : "Users without credits";
382 |     const actionRequired = isAnonymous ? "Please sign in and purchase credits" : "Please purchase credits";
383 | 
384 |     console.log(`[SECURITY] ${userType} attempted to access premium model: ${selectedModel}`);
385 |     return createErrorResponse(
386 |       "PREMIUM_MODEL_RESTRICTED",
387 |       `${userType} cannot access premium models. ${actionRequired} to use ${selectedModelInfo.name || selectedModel}.`,
388 |       403,
389 |       `Premium model access denied for ${isAnonymous ? 'anonymous' : 'non-credit'} user`
390 |     );
391 |   }
392 | 
393 |   // 2.5. Check Web Search credit requirement - ensure user has enough credits for web search (skip if using own API keys)
394 | 
395 |   // SECURITY FIX: Don't trust client's webSearch.enabled, determine server-side
396 |   let serverSideWebSearchEnabled = false;
397 | 
398 |   // Only enable web search if user actually has credits AND not anonymous AND not using own keys
399 |   if (!isUsingOwnApiKeys && !isAnonymous && actualCredits !== null && actualCredits >= WEB_SEARCH_COST) {
400 |     // User has sufficient credits, allow them to use web search if requested
401 |     serverSideWebSearchEnabled = webSearch.enabled;
402 |   } else if (isUsingOwnApiKeys && webSearch.enabled) {
403 |     // Users with own API keys can use web search if they requested it
404 |     serverSideWebSearchEnabled = true;
405 |   }
406 | 
407 |   // Block unpaid attempts
408 |   if (webSearch.enabled && !serverSideWebSearchEnabled) {
409 |     if (isAnonymous) {
410 |       console.log(`[Security] Anonymous user ${userId} tried to use Web Search, blocking request`);
411 |       return createErrorResponse(
412 |         "FEATURE_RESTRICTED",
413 |         "Web Search is only available to signed-in users with credits. Please sign in and purchase credits to use this feature.",
414 |         403,
415 |         "Anonymous users cannot use Web Search"
416 |       );
417 |     }
418 | 
419 |     if (actualCredits !== null && actualCredits < WEB_SEARCH_COST) {
420 |       console.log(`[Security] User ${userId} tried to bypass Web Search payment (${actualCredits} < ${WEB_SEARCH_COST})`);
421 |       return createErrorResponse(
422 |         "INSUFFICIENT_CREDITS",
423 |         `You need at least ${WEB_SEARCH_COST} credits to use Web Search. Your balance is ${actualCredits}.`,
424 |         402,
425 |         `User attempted to bypass Web Search payment with ${actualCredits} credits`
426 |       );
427 |     }
428 |   }
429 | 
430 |   // Use server-determined web search status instead of client's request
431 |   const secureWebSearch = {
432 |     enabled: serverSideWebSearchEnabled,
433 |     contextSize: webSearch.contextSize
434 |   };
435 | 
436 |   // 3. If user has credits or is using own API keys or using free model, allow request (skip daily message limit)
437 |   console.log(`[Debug] Credit check: !isAnonymous=${!isAnonymous}, hasCredits=${hasCredits}, actualCredits=${actualCredits}, isUsingOwnApiKeys=${isUsingOwnApiKeys}, isFreeModel=${isFreeModel}, will skip limit check: ${(!isAnonymous && hasCredits) || isUsingOwnApiKeys || isFreeModel}`);
438 | 
439 |   if ((!isAnonymous && hasCredits) || isUsingOwnApiKeys || isFreeModel) {
440 |     console.log(`[Debug] User ${userId} ${isUsingOwnApiKeys ? 'using own API keys' : isFreeModel ? 'using free model' : 'has credits'}, skipping message limit check`);
441 |     // proceed
442 |   } else {
443 |     console.log(`[Debug] User ${userId} entering message limit check - isAnonymous: ${isAnonymous}`);
444 |     // 4. Otherwise, check message limit based on authentication status
445 |     const limitStatus = await checkMessageLimit(userId, isAnonymous);
446 |     console.log(`[Debug] limitStatus:`, limitStatus);
447 | 
448 |     // Log message usage for anonymous users
449 |     if (isAnonymous) {
450 |       const used = limitStatus.limit - limitStatus.remaining;
451 |       console.log(`[Anonymous User ${userId}] Messages used: ${used}/${limitStatus.limit}, Remaining: ${limitStatus.remaining}`);
452 |     }
453 | 
454 |     if (limitStatus.hasReachedLimit) {
455 |       return new Response(
456 |         JSON.stringify({
457 |           error: "Message limit reached",
458 |           message: `You've reached your daily limit of ${limitStatus.limit} messages. ${isAnonymous ? "Sign in with Google to get more messages." : "Purchase credits to continue."}`,
459 |           limit: limitStatus.limit,
460 |           remaining: limitStatus.remaining
461 |         }),
462 |         { status: 429, headers: { "Content-Type": "application/json" } }
463 |       );
464 |     }
465 |   }
466 | 
467 |   const id = chatId || nanoid();
468 | 
469 |   // Check if chat already exists for the given ID
470 |   // If not, we'll create it in onFinish
471 |   let isNewChat = false;
472 |   if (chatId) {
473 |     try {
474 |       const existingChat = await db.query.chats.findFirst({
475 |         where: and(
476 |           eq(chats.id, chatId),
477 |           eq(chats.userId, userId)
478 |         )
479 |       });
480 |       isNewChat = !existingChat;
481 |     } catch (error) {
482 |       console.error("Error checking for existing chat:", error);
483 |       // Continue anyway, we'll create the chat in onFinish
484 |       isNewChat = true;
485 |     }
486 |   } else {
487 |     // No ID provided, definitely new
488 |     isNewChat = true;
489 |   }
490 | 
491 |   // Prepare messages for the model
[TRUNCATED]
```

app/api/chats/route.ts
```
1 | import { NextResponse } from "next/server";
2 | import { getChats } from "@/lib/chat-store";
3 | import { auth } from "@/lib/auth";
4 | 
5 | // Helper to get user ID from authenticated session only
6 | async function getRequestUserId(request: Request): Promise<string | null> {
7 |   // Only use authenticated session for user ID
8 |   const session = await auth.api.getSession({ headers: request.headers });
9 |   return session?.user?.id || null;
10 | }
11 | 
12 | export async function GET(request: Request) {
13 |   try {
14 |     const userId = await getRequestUserId(request);
15 | 
16 |     if (!userId) {
17 |       return NextResponse.json({ error: "Authentication required" }, { status: 401 });
18 |     }
19 | 
20 |     // Get URL parameters for pagination
21 |     const { searchParams } = new URL(request.url);
22 |     const limit = Math.min(parseInt(searchParams.get('limit') || '50'), 500); // Cap at 500 for reasonable performance
23 | 
24 |     const chats = await getChats(userId, limit);
25 |     return NextResponse.json(chats);
26 |   } catch (error) {
27 |     console.error("Error fetching chats:", error);
28 |     return NextResponse.json(
29 |       { error: "Failed to fetch chats" },
30 |       { status: 500 }
31 |     );
32 |   }
33 | } 
```

app/api/create-polar-customer/route.ts
```
1 | import { NextResponse } from 'next/server';
2 | import { auth } from '@/lib/auth';
3 | import { createOrUpdateCustomerWithExternalId, getCustomerByExternalId, getCustomerByEmail, updateCustomerExternalId } from '@/lib/polar';
4 | 
5 | /**
6 |  * Endpoint to manually create or update a Polar customer for testing
7 |  */
8 | export async function POST(req: Request) {
9 |     try {
10 |         // Get the authenticated session
11 |         const session = await auth.api.getSession({ headers: req.headers });
12 | 
13 |         // If no session exists, return error
14 |         if (!session || !session.user || !session.user.id) {
15 |             return NextResponse.json(
16 |                 { error: 'Unauthorized' },
17 |                 { status: 401 }
18 |             );
19 |         }
20 | 
21 |         const userId = session.user.id;
22 |         const isAnonymous = (session.user as any).isAnonymous === true;
23 |         const userEmail = session.user.email;
24 |         const userName = session.user.name;
25 | 
26 |         if (isAnonymous) {
27 |             return NextResponse.json(
28 |                 { error: 'Cannot create Polar customer for anonymous user' },
29 |                 { status: 400 }
30 |             );
31 |         }
32 | 
33 |         if (!userEmail) {
34 |             return NextResponse.json(
35 |                 { error: 'User email required to create Polar customer' },
36 |                 { status: 400 }
37 |             );
38 |         }
39 | 
40 |         console.log(`[CREATE POLAR CUSTOMER] Processing customer for user ${userId} (${userEmail})`);
41 | 
42 |         // Step 1: Check if customer already exists by external ID
43 |         let existingCustomer;
44 |         try {
45 |             existingCustomer = await getCustomerByExternalId(userId);
46 |         } catch (error) {
47 |             console.log(`[CREATE POLAR CUSTOMER] No existing customer found for external ID ${userId}`);
48 |         }
49 | 
50 |         if (existingCustomer) {
51 |             return NextResponse.json({
52 |                 success: true,
53 |                 message: 'Customer already exists with external ID',
54 |                 customer: existingCustomer,
55 |                 action: 'found_existing_by_external_id'
56 |             });
57 |         }
58 | 
59 |         // Step 2: Check if customer exists by email (but without external ID)
60 |         let customerByEmail: any;
61 |         try {
62 |             customerByEmail = await getCustomerByEmail(userEmail);
63 |             console.log(`[CREATE POLAR CUSTOMER] Customer lookup by email result:`, JSON.stringify(customerByEmail, null, 2));
64 |             console.log(`[CREATE POLAR CUSTOMER] Customer ID:`, customerByEmail?.id);
65 |             console.log(`[CREATE POLAR CUSTOMER] Customer type:`, typeof customerByEmail);
66 |         } catch (error) {
67 |             console.error(`[CREATE POLAR CUSTOMER] Error looking up customer by email:`, error);
68 |         }
69 | 
70 |         if (customerByEmail) {
71 |             // Validate that we have a customer with an ID
72 |             if (!customerByEmail.id) {
73 |                 console.error(`[CREATE POLAR CUSTOMER] Customer found but missing ID field:`, customerByEmail);
74 |                 return NextResponse.json(
75 |                     {
76 |                         error: 'Customer found but missing ID field',
77 |                         customerData: customerByEmail,
78 |                         userId,
79 |                         userEmail
80 |                     },
81 |                     { status: 500 }
82 |                 );
83 |             }
84 | 
85 |             // Customer exists by email but doesn't have the external ID set
86 |             console.log(`[CREATE POLAR CUSTOMER] Found existing customer by email: ${customerByEmail.id}. Setting external ID to ${userId}`);
87 | 
88 |             try {
89 |                 const updatedCustomer = await updateCustomerExternalId(customerByEmail.id, userId);
90 |                 console.log(`[CREATE POLAR CUSTOMER] Successfully updated customer external ID:`, updatedCustomer);
91 | 
92 |                 return NextResponse.json({
93 |                     success: true,
94 |                     message: 'Customer found by email and external ID updated successfully',
95 |                     customer: updatedCustomer,
96 |                     action: 'updated_external_id'
97 |                 });
98 |             } catch (updateError) {
99 |                 console.error(`[CREATE POLAR CUSTOMER] Error updating customer external ID:`, updateError);
100 |                 return NextResponse.json(
101 |                     {
102 |                         error: 'Failed to update customer external ID',
103 |                         details: updateError,
104 |                         customerId: customerByEmail.id,
105 |                         userId,
106 |                         userEmail
107 |                     },
108 |                     { status: 500 }
109 |                 );
110 |             }
111 |         }
112 | 
113 |         // Step 3: Create new customer (no existing customer found)
114 |         try {
115 |             const newCustomer = await createOrUpdateCustomerWithExternalId(
116 |                 userId,
117 |                 userEmail,
118 |                 userName || undefined,
119 |                 {
120 |                     source: 'manual_creation',
121 |                     created_via: 'debug_endpoint'
122 |                 }
123 |             );
124 | 
125 |             console.log(`[CREATE POLAR CUSTOMER] Successfully created customer:`, newCustomer);
126 | 
127 |             return NextResponse.json({
128 |                 success: true,
129 |                 message: 'Customer created successfully',
130 |                 customer: newCustomer,
131 |                 action: 'created_new'
132 |             });
133 | 
134 |         } catch (createError) {
135 |             console.error(`[CREATE POLAR CUSTOMER] Error creating customer:`, createError);
136 |             return NextResponse.json(
137 |                 {
138 |                     error: 'Failed to create customer',
139 |                     details: createError,
140 |                     userId,
141 |                     userEmail
142 |                 },
143 |                 { status: 500 }
144 |             );
145 |         }
146 | 
147 |     } catch (error) {
148 |         console.error('Error in create Polar customer API:', error);
149 |         return NextResponse.json(
150 |             { error: 'Internal server error', details: error },
151 |             { status: 500 }
152 |         );
153 |     }
154 | } 
```

app/api/debug-credits/route.ts
```
1 | import { NextResponse } from 'next/server';
2 | import { auth } from '@/lib/auth';
3 | import { getRemainingCredits, getRemainingCreditsByExternalId, getCustomerByExternalId } from '@/lib/polar';
4 | 
5 | /**
6 |  * Debug endpoint to help diagnose Polar credits issues
7 |  */
8 | export async function GET(req: Request) {
9 |     try {
10 |         // Get the authenticated session
11 |         const session = await auth.api.getSession({ headers: req.headers });
12 | 
13 |         // If no session exists, return error
14 |         if (!session || !session.user || !session.user.id) {
15 |             return NextResponse.json(
16 |                 { error: 'Unauthorized', debug: 'No valid session found' },
17 |                 { status: 401 }
18 |             );
19 |         }
20 | 
21 |         const userId = session.user.id;
22 |         const isAnonymous = (session.user as any).isAnonymous === true;
23 |         const polarCustomerId: string | undefined = (session.user as any)?.polarCustomerId ||
24 |             (session.user as any)?.metadata?.polarCustomerId;
25 | 
26 |         console.log(`[DEBUG CREDITS] Session info:`, {
27 |             userId,
28 |             isAnonymous,
29 |             polarCustomerId,
30 |             userEmail: session.user.email,
31 |             userName: session.user.name
32 |         });
33 | 
34 |         const debugInfo: any = {
35 |             userId,
36 |             isAnonymous,
37 |             polarCustomerId,
38 |             userEmail: session.user.email,
39 |             userName: session.user.name,
40 |             steps: []
41 |         };
42 | 
43 |         // For anonymous users, return debug info
44 |         if (isAnonymous) {
45 |             debugInfo.result = 'User is anonymous - no credits check needed';
46 |             return NextResponse.json(debugInfo);
47 |         }
48 | 
49 |         // Step 1: Try to find customer by external ID
50 |         try {
51 |             debugInfo.steps.push('Attempting to find customer by external ID...');
52 |             const customer = await getCustomerByExternalId(userId);
53 |             debugInfo.polarCustomer = customer;
54 | 
55 |             if (customer) {
56 |                 debugInfo.steps.push(`✅ Found customer: ${customer.id} (${customer.email})`);
57 |                 debugInfo.polarCustomerIdFromExternal = customer.id;
58 |             } else {
59 |                 debugInfo.steps.push('❌ No customer found by external ID');
60 |             }
61 |         } catch (error) {
62 |             debugInfo.steps.push(`❌ Error finding customer: ${error}`);
63 |             debugInfo.customerLookupError = error;
64 |         }
65 | 
66 |         // Step 2: Try to get credits via external ID
67 |         try {
68 |             debugInfo.steps.push('Attempting to get credits via external ID...');
69 |             const creditsByExternal = await getRemainingCreditsByExternalId(userId);
70 |             debugInfo.creditsByExternalId = creditsByExternal;
71 | 
72 |             if (creditsByExternal !== null) {
73 |                 debugInfo.steps.push(`✅ Credits via external ID: ${creditsByExternal}`);
74 |             } else {
75 |                 debugInfo.steps.push('❌ No credits found via external ID');
76 |             }
77 |         } catch (error) {
78 |             debugInfo.steps.push(`❌ Error getting credits via external ID: ${error}`);
79 |             debugInfo.creditsExternalError = error;
80 |         }
81 | 
82 |         // Step 3: Try legacy method if we have polarCustomerId
83 |         if (polarCustomerId) {
84 |             try {
85 |                 debugInfo.steps.push('Attempting to get credits via legacy customer ID...');
86 |                 const creditsLegacy = await getRemainingCredits(polarCustomerId);
87 |                 debugInfo.creditsByLegacyId = creditsLegacy;
88 | 
89 |                 if (creditsLegacy !== null) {
90 |                     debugInfo.steps.push(`✅ Credits via legacy ID: ${creditsLegacy}`);
91 |                 } else {
92 |                     debugInfo.steps.push('❌ No credits found via legacy ID');
93 |                 }
94 |             } catch (error) {
95 |                 debugInfo.steps.push(`❌ Error getting credits via legacy ID: ${error}`);
96 |                 debugInfo.creditsLegacyError = error;
97 |             }
98 |         } else {
99 |             debugInfo.steps.push('⚠️ No legacy polar customer ID available');
100 |         }
101 | 
102 |         // Final assessment
103 |         const finalCredits = debugInfo.creditsByExternalId ?? debugInfo.creditsByLegacyId ?? null;
104 |         debugInfo.finalCreditsResult = finalCredits;
105 |         debugInfo.canAccessPremium = finalCredits !== null && finalCredits > 0;
106 | 
107 |         return NextResponse.json(debugInfo);
108 | 
109 |     } catch (error) {
110 |         console.error('Error in debug credits API:', error);
111 |         return NextResponse.json(
112 |             { error: 'Internal server error', details: error },
113 |             { status: 500 }
114 |         );
115 |     }
116 | } 
```

app/api/models/route.ts
```
1 | import { NextRequest, NextResponse } from 'next/server';
2 | import { fetchAllModels, getEnvironmentApiKeys, clearProviderCache, getCacheStats } from '@/lib/models/fetch-models';
3 | import { ApiKeyContext } from '@/lib/types/models';
4 | import { headers } from 'next/headers';
5 | 
6 | // Helper to extract user API keys from request
7 | function extractUserApiKeys(request: NextRequest): Record<string, string> {
8 |     const userKeys: Record<string, string> = {};
9 | 
10 |     try {
11 |         // Try to get API keys from headers (for authenticated requests)
12 |         const authHeader = request.headers.get('x-api-keys');
13 |         if (authHeader) {
14 |             const parsed = JSON.parse(authHeader);
15 |             if (typeof parsed === 'object' && parsed !== null) {
16 |                 Object.assign(userKeys, parsed);
17 |             }
18 |         }
19 | 
20 |         // Alternative: get from URL params (less secure, for testing)
21 |         const url = new URL(request.url);
22 |         const providedKeys = url.searchParams.get('api_keys');
23 |         if (providedKeys) {
24 |             const parsed = JSON.parse(providedKeys);
25 |             if (typeof parsed === 'object' && parsed !== null) {
26 |                 Object.assign(userKeys, parsed);
27 |             }
28 |         }
29 |     } catch (error) {
30 |         console.warn('Failed to parse user API keys:', error);
31 |     }
32 | 
33 |     return userKeys;
34 | }
35 | 
36 | // Helper to validate request and return error response
37 | function createErrorResponse(message: string, status = 500): NextResponse {
38 |     return NextResponse.json(
39 |         {
40 |             error: message,
41 |             models: [],
42 |             metadata: {
43 |                 lastUpdated: new Date(),
44 |                 providers: {},
45 |                 totalModels: 0,
46 |                 cacheHit: false,
47 |             }
48 |         },
49 |         { status }
50 |     );
51 | }
52 | 
53 | // GET /api/models - Fetch dynamic models
54 | export async function GET(request: NextRequest) {
55 |     try {
56 |         const url = new URL(request.url);
57 |         const forceRefresh = url.searchParams.get('force') === 'true';
58 |         const stats = url.searchParams.get('stats') === 'true';
59 | 
60 |         // If stats requested, return cache statistics
61 |         if (stats) {
62 |             return NextResponse.json({
63 |                 cache: getCacheStats(),
64 |                 timestamp: new Date(),
65 |             });
66 |         }
67 | 
68 |         // Create abort controller for timeout
69 |         const controller = new AbortController();
70 |         const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
71 | 
72 |         try {
73 |             // Get environment API keys (server-side only)
74 |             const environmentKeys = getEnvironmentApiKeys();
75 | 
76 |             // Extract user-provided API keys
77 |             const userKeys = extractUserApiKeys(request);
78 | 
79 |             // Create API key context
80 |             const apiKeyContext: ApiKeyContext = {
81 |                 environment: environmentKeys,
82 |                 user: Object.keys(userKeys).length > 0 ? userKeys : undefined,
83 |             };
84 | 
85 |             // Fetch models from all providers
86 |             const response = await fetchAllModels(
87 |                 apiKeyContext,
88 |                 forceRefresh,
89 |                 controller.signal
90 |             );
91 | 
92 |             clearTimeout(timeoutId);
93 | 
94 |             // Set cache headers
95 |             const headers = new Headers();
96 |             headers.set('Cache-Control', 'public, max-age=60, stale-while-revalidate=300');
97 |             headers.set('Content-Type', 'application/json');
98 | 
99 |             // Add CORS headers for development
100 |             if (process.env.NODE_ENV === 'development') {
101 |                 headers.set('Access-Control-Allow-Origin', '*');
102 |                 headers.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
103 |                 headers.set('Access-Control-Allow-Headers', 'Content-Type, x-api-keys');
104 |             }
105 | 
106 |             return NextResponse.json(response, { headers });
107 | 
108 |         } catch (error) {
109 |             clearTimeout(timeoutId);
110 | 
111 |             if (error instanceof Error && error.name === 'AbortError') {
112 |                 return createErrorResponse('Request timeout', 408);
113 |             }
114 | 
115 |             throw error; // Re-throw for general error handling below
116 |         }
117 | 
118 |     } catch (error) {
119 |         console.error('Error fetching models:', error);
120 | 
121 |         const errorMessage = error instanceof Error
122 |             ? error.message
123 |             : 'Unknown error occurred while fetching models';
124 | 
125 |         return createErrorResponse(errorMessage);
126 |     }
127 | }
128 | 
129 | // POST /api/models/refresh - Force refresh all provider caches
130 | export async function POST(request: NextRequest) {
131 |     try {
132 |         const body = await request.json().catch(() => ({}));
133 |         const { provider } = body;
134 | 
135 |         // Clear cache for specific provider or all providers
136 |         clearProviderCache(provider);
137 | 
138 |         return NextResponse.json({
139 |             success: true,
140 |             message: provider
141 |                 ? `Cache cleared for provider: ${provider}`
142 |                 : 'All provider caches cleared',
143 |             timestamp: new Date(),
144 |         });
145 | 
146 |     } catch (error) {
147 |         console.error('Error clearing cache:', error);
148 |         return createErrorResponse('Failed to clear cache');
149 |     }
150 | }
151 | 
152 | // OPTIONS handler for CORS
153 | export async function OPTIONS(request: NextRequest) {
154 |     const headers = new Headers();
155 |     headers.set('Access-Control-Allow-Origin', '*');
156 |     headers.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
157 |     headers.set('Access-Control-Allow-Headers', 'Content-Type, x-api-keys');
158 | 
159 |     return new NextResponse(null, { status: 200, headers });
160 | } 
```

app/api/credits/route.ts
```
1 | import { NextResponse } from 'next/server';
2 | import { auth } from '@/lib/auth';
3 | import { getRemainingCredits, getRemainingCreditsByExternalId } from '@/lib/polar';
4 | 
5 | /**
6 |  * API endpoint to get credit information for the current user
7 |  */
8 | export async function GET(req: Request) {
9 |     try {
10 |         // Get the authenticated session
11 |         const session = await auth.api.getSession({ headers: req.headers });
12 | 
13 |         // If no session exists, return error
14 |         if (!session || !session.user || !session.user.id) {
15 |             //console.log('[DEBUG] Credits API: No valid session found');
16 |             return NextResponse.json(
17 |                 { error: 'Unauthorized' },
18 |                 { status: 401 }
19 |             );
20 |         }
21 | 
22 |         const userId = session.user.id;
23 |         const isAnonymous = (session.user as any).isAnonymous === true;
24 |         const polarCustomerId: string | undefined = (session.user as any)?.polarCustomerId ||
25 |             (session.user as any)?.metadata?.polarCustomerId;
26 | 
27 |         //console.log(`[DEBUG] Credits API: userId=${userId}, isAnonymous=${isAnonymous}, polarCustomerId=${polarCustomerId}`);
28 | 
29 |         // For anonymous users, return null credits
30 |         if (isAnonymous) {
31 |             //console.log('[DEBUG] Credits API: User is anonymous, returning null credits');
32 |             return NextResponse.json({
33 |                 credits: null,
34 |                 isAnonymous: true
35 |             });
36 |         }
37 | 
38 |         let credits: number | null = null;
39 | 
40 |         try {
41 |             // Try the external ID approach first if a userId is provided
42 |             if (userId) {
43 |                 try {
44 |                     //console.log(`[DEBUG] Credits API: Attempting to get credits via external ID for user ${userId}`);
45 |                     const remainingCreditsByExternal = await getRemainingCreditsByExternalId(userId);
46 |                     //console.log(`[DEBUG] Credits API: External ID result: ${remainingCreditsByExternal}`);
47 |                     if (remainingCreditsByExternal !== null) {
48 |                         credits = remainingCreditsByExternal;
49 |                     }
50 |                 } catch (externalError) {
51 |                     console.warn('Failed to get credits via external ID, falling back to legacy method:', externalError);
52 |                     // Continue to legacy method
53 |                 }
54 |             }
55 | 
56 |             // Legacy method using polarCustomerId if external ID didn't work
57 |             if (credits === null && polarCustomerId) {
58 |                 //console.log(`[DEBUG] Credits API: Attempting to get credits via legacy polarCustomerId ${polarCustomerId}`);
59 |                 const remainingCredits = await getRemainingCredits(polarCustomerId);
60 |                 //console.log(`[DEBUG] Credits API: Legacy method result: ${remainingCredits}`);
61 |                 credits = remainingCredits;
62 |             }
63 | 
64 |             //console.log(`[DEBUG] Credits API: Final credits result: ${credits}`);
65 |             return NextResponse.json({
66 |                 credits,
67 |                 isAnonymous: false
68 |             });
69 |         } catch (error) {
70 |             console.error('Error fetching credits:', error);
71 |             return NextResponse.json(
72 |                 { error: 'Failed to fetch credits' },
73 |                 { status: 500 }
74 |             );
75 |         }
76 |     } catch (error) {
77 |         console.error('Error in credits API:', error);
78 |         return NextResponse.json(
79 |             { error: 'Internal server error' },
80 |             { status: 500 }
81 |         );
82 |     }
83 | } 
```

app/api/presets/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { db } from '@/lib/db';
3 | import { presets, users, presetUsage } from '@/lib/db/schema';
4 | import { auth } from '@/lib/auth';
5 | import { eq, and, desc, isNull } from 'drizzle-orm';
6 | import { validatePresetParameters, validateModelAccess } from '@/lib/parameter-validation';
7 | import { getModelDetails } from '@/lib/models/fetch-models';
8 | import { nanoid } from 'nanoid';
9 | 
10 | // Helper to create error responses
11 | const createErrorResponse = (message: string, status: number) => {
12 |   return new Response(JSON.stringify({ error: message }), {
13 |     status,
14 |     headers: { 'Content-Type': 'application/json' }
15 |   });
16 | };
17 | 
18 | // Helper to check if user has access to premium models
19 | async function userCanAccessPremium(userId: string): Promise<boolean> {
20 |   // Check if user has credits or subscription
21 |   // For now, assume all authenticated users can access premium models
22 |   // This can be enhanced with actual credit/subscription checks
23 |   return true;
24 | }
25 | 
26 | // GET /api/presets - List user's presets
27 | export async function GET(req: NextRequest) {
28 |   try {
29 |     const session = await auth.api.getSession({ headers: req.headers });
30 |     if (!session?.user?.id) {
31 |       return createErrorResponse('Authentication required', 401);
32 |     }
33 | 
34 |     const userId = session.user.id;
35 | 
36 |     // Get user's presets (excluding soft deleted)
37 |     const userPresets = await db
38 |       .select()
39 |       .from(presets)
40 |       .where(and(
41 |         eq(presets.userId, userId),
42 |         isNull(presets.deletedAt)
43 |       ))
44 |       .orderBy(desc(presets.createdAt));
45 | 
46 |     // Convert temperature back from integer to float
47 |     const formattedPresets = userPresets.map(preset => ({
48 |       ...preset,
49 |       temperature: preset.temperature / 1000
50 |     }));
51 | 
52 |     return new Response(JSON.stringify(formattedPresets), {
53 |       headers: { 'Content-Type': 'application/json' }
54 |     });
55 |   } catch (error) {
56 |     console.error('Error fetching presets:', error);
57 |     return createErrorResponse('Internal server error', 500);
58 |   }
59 | }
60 | 
61 | // POST /api/presets - Create new preset
62 | export async function POST(req: NextRequest) {
63 |   try {
64 |     const session = await auth.api.getSession({ headers: req.headers });
65 |     if (!session?.user?.id) {
66 |       return createErrorResponse('Authentication required', 401);
67 |     }
68 | 
69 |     const userId = session.user.id;
70 |     const data = await req.json();
71 | 
72 |     const {
73 |       name,
74 |       modelId,
75 |       systemInstruction,
76 |       temperature,
77 |       maxTokens,
78 |       webSearchEnabled = false,
79 |       webSearchContextSize = 'medium',
80 |       apiKeyPreferences = {},
81 |       isDefault = false
82 |     } = data;
83 | 
84 |     // Validate required fields
85 |     if (!name || !modelId || !systemInstruction) {
86 |       return createErrorResponse('Missing required fields: name, modelId, systemInstruction', 400);
87 |     }
88 | 
89 |     if (temperature === undefined || maxTokens === undefined) {
90 |       return createErrorResponse('Missing required fields: temperature, maxTokens', 400);
91 |     }
92 | 
93 |     // Get model info first for validation
94 |     const modelInfo = await getModelDetails(modelId);
95 | 
96 |     // Validate preset parameters
97 |     const validation = validatePresetParameters(modelInfo, temperature, maxTokens, systemInstruction);
98 |     if (!validation.valid) {
99 |       return createErrorResponse(`Invalid parameters: ${validation.errors.join(', ')}`, 400);
100 |     }
101 | 
102 |     // Validate model access
103 |     const canAccessPremium = await userCanAccessPremium(userId);
104 |     const modelAccessValidation = validateModelAccess(modelInfo, canAccessPremium);
105 |     if (!modelAccessValidation.valid) {
106 |       return createErrorResponse(`Model access denied: ${modelAccessValidation.errors.join(', ')}`, 403);
107 |     }
108 | 
109 |     // Check for name conflicts
110 |     const existingPreset = await db
111 |       .select()
112 |       .from(presets)
113 |       .where(and(
114 |         eq(presets.userId, userId),
115 |         eq(presets.name, name),
116 |         isNull(presets.deletedAt)
117 |       ))
118 |       .limit(1);
119 | 
120 |     if (existingPreset.length > 0) {
121 |       return createErrorResponse('A preset with this name already exists', 409);
122 |     }
123 | 
124 |     // Handle default preset logic - now without database constraints
125 |     // If setting as default, unset other defaults first
126 |     if (isDefault) {
127 |       await db
128 |         .update(presets)
129 |         .set({ isDefault: false, updatedAt: new Date() })
130 |         .where(and(
131 |           eq(presets.userId, userId),
132 |           eq(presets.isDefault, true),
133 |           isNull(presets.deletedAt)
134 |         ));
135 |     }
136 | 
137 |     try {
138 |       // Create new preset
139 |       const newPreset = await db
140 |         .insert(presets)
141 |         .values({
142 |           id: nanoid(),
143 |           userId,
144 |           name,
145 |           modelId,
146 |           systemInstruction,
147 |           temperature: Math.round(temperature * 1000), // Convert to integer
148 |           maxTokens,
149 |           webSearchEnabled,
150 |           webSearchContextSize,
151 |           apiKeyPreferences,
152 |           isDefault,
153 |           visibility: 'private'
154 |         })
155 |         .returning();
156 | 
157 |       // Format response
158 |       const formattedPreset = {
159 |         ...newPreset[0],
160 |         temperature: newPreset[0].temperature / 1000
161 |       };
162 | 
163 |       return new Response(JSON.stringify(formattedPreset), {
164 |         status: 201,
165 |         headers: { 'Content-Type': 'application/json' }
166 |       });
167 |     } catch (error: any) {
168 |       // Handle constraint violations
169 |       if (error?.code === '23505') { // Unique constraint violation
170 |         if (error?.constraint === 'unique_name_per_user') {
171 |           return createErrorResponse('A preset with this name already exists', 409);
172 |         }
173 |       }
174 |       throw error; // Re-throw if not a handled constraint violation
175 |     }
176 |   } catch (error) {
177 |     console.error('Error creating preset:', error);
178 |     return createErrorResponse('Internal server error', 500);
179 |   }
180 | }
```

app/api/portal/route.ts
```
1 | import { NextRequest, NextResponse } from "next/server";
2 | import { auth } from "@/lib/auth";
3 | import { Polar } from "@polar-sh/sdk";
4 | 
5 | // Polar server environment configuration
6 | // Use POLAR_SERVER_ENV if explicitly set, otherwise default to sandbox for safety
7 | const polarServerEnv = process.env.POLAR_SERVER_ENV === "production" ? "production" : "sandbox";
8 | 
9 | const polar = new Polar({
10 |     accessToken: process.env.POLAR_ACCESS_TOKEN!,
11 |     server: polarServerEnv,
12 | });
13 | 
14 | export async function GET(request: NextRequest) {
15 |     try {
16 |         // Get the current session
17 |         const session = await auth.api.getSession({
18 |             headers: request.headers,
19 |         });
20 | 
21 |         if (!session?.user) {
22 |             return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
23 |         }
24 | 
25 |         const userId = session.user.id;
26 | 
27 |         // Get the Polar customer using external ID (the user's app ID)
28 |         try {
29 |             const customer = await polar.customers.getExternal({
30 |                 externalId: userId,
31 |             });
32 | 
33 |             // Create an authenticated customer portal session
34 |             const customerSession = await polar.customerSessions.create({
35 |                 customerId: customer.id,
36 |             });
37 | 
38 |             // Redirect to the customer portal
39 |             return NextResponse.redirect(customerSession.customerPortalUrl);
40 |         } catch (error) {
41 |             console.error("Error getting Polar customer or creating portal session:", error);
42 | 
43 |             // If customer not found, return error with helpful message
44 |             if (error instanceof Error && error.message.includes("not found")) {
45 |                 return NextResponse.json(
46 |                     { error: "Customer not found. Please contact support." },
47 |                     { status: 404 }
48 |                 );
49 |             }
50 | 
51 |             return NextResponse.json(
52 |                 { error: "Failed to access customer portal" },
53 |                 { status: 500 }
54 |             );
55 |         }
56 |     } catch (error) {
57 |         console.error("Portal API error:", error);
58 |         return NextResponse.json(
59 |             { error: "Internal server error" },
60 |             { status: 500 }
61 |         );
62 |     }
63 | } 
```

app/api/version/route.ts
```
1 | import { NextResponse } from 'next/server';
2 | 
3 | export async function GET() {
4 |     return NextResponse.json({
5 |         commit: process.env.NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA || process.env.VERCEL_GIT_COMMIT_SHA || 'unknown',
6 |         url: process.env.NEXT_PUBLIC_VERCEL_URL || process.env.VERCEL_URL || 'unknown',
7 |     });
8 | } 
```

app/checkout/error/page.tsx
```
1 | import { Button } from "@/components/ui/button";
2 | import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
3 | import { XCircle, RefreshCw, ArrowLeft } from "lucide-react";
4 | import Link from "next/link";
5 | 
6 | interface CheckoutErrorPageProps {
7 |   searchParams: {
8 |     reason?: string;
9 |     checkout_id?: string;
10 |   };
11 | }
12 | 
13 | export default function CheckoutErrorPage({ searchParams }: CheckoutErrorPageProps) {
14 |   const { reason, checkout_id } = searchParams;
15 |   
16 |   const getErrorMessage = (reason?: string) => {
17 |     switch (reason) {
18 |       case 'canceled':
19 |         return {
20 |           title: 'Checkout Canceled',
21 |           description: 'You canceled the payment process.',
22 |           suggestion: 'No worries! You can try again whenever you\'re ready.'
23 |         };
24 |       case 'failed':
25 |         return {
26 |           title: 'Payment Failed',
27 |           description: 'There was an issue processing your payment.',
28 |           suggestion: 'Please check your payment method and try again.'
29 |         };
30 |       default:
31 |         return {
32 |           title: 'Checkout Error',
33 |           description: 'Something went wrong during the checkout process.',
34 |           suggestion: 'Please try again or contact support if the issue persists.'
35 |         };
36 |     }
37 |   };
38 | 
39 |   const errorInfo = getErrorMessage(reason);
40 | 
41 |   return (
42 |     <div className="container flex items-center justify-center min-h-[calc(100vh-80px)]">
43 |       <Card className="w-full max-w-md shadow-lg">
44 |         <CardHeader className="text-center">
45 |           <div className="flex justify-center mb-4">
46 |             <XCircle size={48} className="text-red-500" />
47 |           </div>
48 |           <CardTitle className="text-2xl">{errorInfo.title}</CardTitle>
49 |           <CardDescription>
50 |             {errorInfo.description}
51 |           </CardDescription>
52 |         </CardHeader>
53 |         <CardContent className="text-center">
54 |           <p className="mb-4 text-muted-foreground">
55 |             {errorInfo.suggestion}
56 |           </p>
57 |           {checkout_id && (
58 |             <p className="text-xs text-muted-foreground border-t pt-4">
59 |               Reference ID: {checkout_id}
60 |             </p>
61 |           )}
62 |         </CardContent>
63 |         <CardFooter className="flex flex-col gap-2">
64 |           <Link href="/" className="w-full">
65 |             <Button variant="default" size="lg" className="w-full">
66 |               <ArrowLeft className="mr-2 h-4 w-4" />
67 |               Return to Chat
68 |             </Button>
69 |           </Link>
70 |           <Button 
71 |             variant="outline" 
72 |             size="lg" 
73 |             className="w-full"
74 |             onClick={() => window.location.href = '/api/auth/checkout/ai-usage'}
75 |           >
76 |             <RefreshCw className="mr-2 h-4 w-4" />
77 |             Try Again
78 |           </Button>
79 |         </CardFooter>
80 |       </Card>
81 |     </div>
82 |   );
83 | } 
```

app/chat/[id]/page.tsx
```
1 | "use client";
2 | 
3 | import Chat from "@/components/chat";
4 | import { ErrorBoundary } from "@/components/error-boundary";
5 | import { useQueryClient } from "@tanstack/react-query";
6 | import { useParams } from "next/navigation";
7 | import { useEffect } from "react";
8 | 
9 | export default function ChatPage() {
10 |   const params = useParams();
11 |   const chatId = params?.id as string;
12 |   const queryClient = useQueryClient();
13 | 
14 |   // Prefetch chat data
15 |   // useEffect(() => {
16 |   //   async function prefetchChat() {
17 |   //     if (!chatId || !userId) return;
18 |   //     
19 |   //     // Check if data already exists in cache
20 |   //     const existingData = queryClient.getQueryData(['chat', chatId, userId]);
21 |   //     if (existingData) return;
22 |   //
23 |   //     // Prefetch the data
24 |   //     await queryClient.prefetchQuery({
25 |   //       queryKey: ['chat', chatId, userId] as const,
26 |   //       queryFn: async () => {
27 |   //         try {
28 |   //           const response = await fetch(`/api/chats/${chatId}`, {
29 |   //             headers: {
30 |   //               'x-user-id': userId
31 |   //             }
32 |   //           });
33 |   //           
34 |   //           if (response.status === 404) {
35 |   //             // Chat doesn't exist yet, expected for new chats. Return null silently.
36 |   //             return null;
37 |   //           }
38 |   //
39 |   //           if (!response.ok) {
40 |   //             console.error(`Prefetch failed for chat ${chatId}: Status ${response.status}`);
41 |   //             return null;
42 |   //           }
43 |   //           
44 |   //           return response.json();
45 |   //         } catch (error) {
46 |   //           console.error('Error prefetching chat:', error);
47 |   //           return null;
48 |   //         }
49 |   //       },
50 |   //       staleTime: 1000 * 60 * 5, // 5 minutes
51 |   //     });
52 |   //   }
53 |   //
54 |   //   prefetchChat();
55 |   // }, [chatId, userId, queryClient]);
56 | 
57 |   return (
58 |     <ErrorBoundary
59 |       onError={(error, errorInfo) => {
60 |         console.error('Chat page error:', error, errorInfo);
61 |       }}
62 |     >
63 |       <Chat />
64 |     </ErrorBoundary>
65 |   );
66 | } 
```

app/checkout/success/page.tsx
```
1 | import { Button } from "@/components/ui/button";
2 | import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from "@/components/ui/card";
3 | import { CheckCircle } from "lucide-react";
4 | import Link from "next/link";
5 | 
6 | export default function CheckoutSuccessPage() {
7 |   return (
8 |     <div className="container flex items-center justify-center min-h-[calc(100vh-80px)]">
9 |       <Card className="w-full max-w-md shadow-lg">
10 |         <CardHeader className="text-center">
11 |           <div className="flex justify-center mb-4">
12 |             <CheckCircle size={48} className="text-green-500" />
13 |           </div>
14 |           <CardTitle className="text-2xl">Payment Successful!</CardTitle>
15 |           <CardDescription>
16 |             Thank you for your purchase
17 |           </CardDescription>
18 |         </CardHeader>
19 |         <CardContent className="text-center">
20 |           <p className="mb-4">
21 |             Your AI credits have been added to your account and are ready to use.
22 |           </p>
23 |           <p className="text-sm text-muted-foreground">
24 |             It may take a moment for your credits to appear in your account.
25 |           </p>
26 |         </CardContent>
27 |         <CardFooter className="flex justify-center">
28 |           <Link href="/">
29 |             <Button size="lg">
30 |               Return to Chat
31 |             </Button>
32 |           </Link>
33 |         </CardFooter>
34 |       </Card>
35 |     </div>
36 |   );
37 | } 
```

agentsmith/prompts/default/0.0.1/content.j2
```
1 | 
2 | Create a list of 5 unique character names for a fantasy novel, each derived from a randomly selected combination of syllables and cultural inspirations. Avoid repetitive patterns or predictable naming conventions.
```

agentsmith/prompts/default/0.0.1/version.json
```
1 | {
2 |   "uuid": "80314698-bdaf-468f-864d-0225411b1809",
3 |   "config": {
4 |     "models": [
5 |       "openrouter/auto"
6 |     ],
7 |     "system": "You are a helpful AI assistant. Today's date is {{ today }}.\n\nYou have access to external tools provided by connected servers. These tools can perform specific actions like running code, searching databases, or accessing external services.\n\n{% if effectiveWebSearchEnabled %}\n\nWeb Search Enabled: You have web search capabilities enabled. When you use web search: Cite your sources using markdown links;\nUse the format [domain.com](http: //domain.com/) for citations;\nOnly cite reliable and relevant sources;\nIntegrate the information naturally into your responses; {% endif %}\n\nHow to Respond: Analyze the Request: Understand what the user is asking.\nUse Tools When Necessary: If an external tool provides the best way to answer (e.g., fetching specific data, performing calculations, interacting with services), select the most relevant tool(s) and use them. You can use multiple tools in sequence. Clearly indicate when you are using a tool and what it's doing.\n\nUse Your Own Abilities: For requests involving brainstorming, explanation, writing, summarization, analysis, or general knowledge, rely on your own reasoning and knowledge base. You don't need to force the use of an external tool if it's not suitable or required for these tasks.\nRespond Clearly: Provide your answer directly when using your own abilities. If using tools, explain the steps taken and present the results clearly.\nHandle Limitations: If you cannot answer fully (due to lack of information, missing tools, or capability limits), explain the limitation clearly. Don't just say \"I don't know\" if you can provide partial information or explain why you can't answer. If relevant tools seem to be missing, you can mention that the user could potentially add them via the server configuration.\n\nResponse Format: Use Markdown for formatting.\nBase your response on the results from any tools used, or on your own reasoning and knowledge.",
8 |     "temperature": 1
9 |   },
10 |   "status": "DRAFT",
11 |   "version": "0.0.1",
12 |   "created_at": "2025-07-31T06:22:36.57+00:00",
13 |   "updated_at": "2025-08-01T07:04:22.688662+00:00"
14 | }
```

app/api/auth/[...betterauth]/route.ts
```
1 | import { auth } from '@/lib/auth';
2 | import { toNextJsHandler } from 'better-auth/next-js';
3 | 
4 | // Export the handlers wrapped for Next.js App Router
5 | export const { GET, POST } = toNextJsHandler(auth.handler);
6 | 
7 | // Log that Better-Auth routes are registered
8 | console.log('Better-Auth routes registered successfully'); 
```

app/api/auth/polar/route.ts
```
1 | import { NextRequest, NextResponse } from 'next/server';
2 | 
3 | export async function GET(req: NextRequest) {
4 |     console.log('Polar route GET hit at:', req.url);
5 |     return NextResponse.json({ status: 'Polar route is active' });
6 | }
7 | 
8 | export async function POST(req: NextRequest) {
9 |     console.log('Polar route POST hit at:', req.url);
10 | 
11 |     try {
12 |         const body = await req.text();
13 |         console.log('Received body:', body.substring(0, 100) + '...');
14 | 
15 |         // Log all headers
16 |         console.log('Headers:');
17 |         req.headers.forEach((value, key) => {
18 |             console.log(`${key}: ${value}`);
19 |         });
20 | 
21 |         return NextResponse.json({ status: 'success', message: 'Webhook received' });
22 |     } catch (error) {
23 |         console.error('Error in Polar route:', error);
24 |         return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
25 |     }
26 | } 
```

app/api/chats/[id]/route.ts
```
1 | import { NextResponse, NextRequest } from "next/server";
2 | import { getChatById, deleteChat } from "@/lib/chat-store"; // Assuming getChatById also checks userId
3 | import { auth } from "@/lib/auth";
4 | import { db } from "@/lib/db";
5 | import { chats } from "@/lib/db/schema";
6 | import { eq, and } from "drizzle-orm";
7 | 
8 | interface Params {
9 |   params: Promise<{
10 |     id: string;
11 |   }>;
12 | }
13 | 
14 | // Helper to get user ID from authenticated session only
15 | async function getRequestUserId(request: NextRequest | Request): Promise<string | null> {
16 |   // Only use authenticated session for user ID
17 |   const session = await auth.api.getSession({ headers: request.headers });
18 |   return session?.user?.id || null;
19 | }
20 | 
21 | export async function GET(request: NextRequest, { params }: Params) {
22 |   try {
23 |     const userId = await getRequestUserId(request);
24 | 
25 |     if (!userId) {
26 |       return NextResponse.json({ error: "Authentication required" }, { status: 401 });
27 |     }
28 | 
29 |     const { id } = await params;
30 |     const chat = await getChatById(id, userId);
31 | 
32 |     if (!chat) {
33 |       console.log(`Chat not found for id: ${id} and userId: ${userId}`);
34 |       return NextResponse.json(
35 |         { error: "Chat not found" },
36 |         { status: 404 }
37 |       );
38 |     }
39 | 
40 |     return NextResponse.json(chat);
41 |   } catch (error) {
42 |     console.error("Error fetching chat:", error);
43 |     return NextResponse.json(
44 |       { error: "Failed to fetch chat" },
45 |       { status: 500 }
46 |     );
47 |   }
48 | }
49 | 
50 | export async function DELETE(request: NextRequest, { params }: Params) {
51 |   try {
52 |     const userId = await getRequestUserId(request);
53 | 
54 |     if (!userId) {
55 |       return NextResponse.json({ error: "Authentication required" }, { status: 401 });
56 |     }
57 | 
58 |     const { id } = await params;
59 |     await deleteChat(id, userId);
60 |     return NextResponse.json({ success: true });
61 |   } catch (error) {
62 |     console.error("Error deleting chat:", error);
63 |     return NextResponse.json(
64 |       { error: "Failed to delete chat" },
65 |       { status: 500 }
66 |     );
67 |   }
68 | }
69 | 
70 | export async function PATCH(
71 |   request: NextRequest,
72 |   { params }: Params
73 | ) {
74 |   try {
75 |     const userId = await getRequestUserId(request);
76 |     if (!userId) {
77 |       return new Response('Unauthorized', { status: 401 });
78 |     }
79 | 
80 |     const { id: chatId } = await params;
81 |     let requestBody;
82 |     try {
83 |       requestBody = await request.json();
84 |     } catch (error) {
85 |       return NextResponse.json({ error: "Invalid request body: Must be valid JSON" }, { status: 400 });
86 |     }
87 | 
88 |     const { title } = requestBody;
89 | 
90 |     if (typeof title !== 'string' || title.trim() === '') {
91 |       return NextResponse.json({ error: "Invalid title: Title must be a non-empty string" }, { status: 400 });
92 |     }
93 | 
94 |     if (title.length > 255) {
95 |       return NextResponse.json({ error: `Invalid title: Title must be 255 characters or less. Received ${title.length} characters.` }, { status: 400 });
96 |     }
97 | 
98 |     // First, verify the chat exists and belongs to the user.
99 |     // We can use a direct DB query for this to ensure we get the latest state before update.
100 |     const existingChatArray = await db
101 |       .select()
102 |       .from(chats)
103 |       .where(and(eq(chats.id, chatId), eq(chats.userId, userId)))
104 |       .limit(1);
105 | 
106 |     if (existingChatArray.length === 0) {
107 |       // Check if chat exists at all to differentiate between Not Found and Forbidden
108 |       const chatExistsArray = await db.select({ id: chats.id }).from(chats).where(eq(chats.id, chatId)).limit(1);
109 |       if (chatExistsArray.length === 0) {
110 |         return NextResponse.json({ error: "Chat not found" }, { status: 404 });
111 |       }
112 |       return NextResponse.json({ error: "Forbidden: You do not own this chat" }, { status: 403 });
113 |     }
114 | 
115 |     const existingChat = existingChatArray[0];
116 | 
117 |     // Update the chat title
118 |     const updatedChatArray = await db
119 |       .update(chats)
120 |       .set({ title: title.trim(), updatedAt: new Date() })
121 |       .where(and(eq(chats.id, chatId), eq(chats.userId, userId)))
122 |       .returning();
123 | 
124 |     if (updatedChatArray.length === 0) {
125 |       // This case should ideally not be reached if the prior check passed,
126 |       // but as a safeguard:
127 |       console.error(`Failed to update chat title for chat ID: ${chatId} and user ID: ${userId}. Chat might have been deleted or ownership changed concurrently.`);
128 |       return NextResponse.json({ error: "Failed to update chat title. Chat not found or access denied." }, { status: 404 });
129 |     }
130 | 
131 |     return NextResponse.json(updatedChatArray[0], { status: 200 });
132 | 
133 |   } catch (error) {
134 |     console.error("Error updating chat title:", error);
135 |     // Generic error for unexpected issues
136 |     if (error instanceof Error && error.message.includes("Invalid request body")) {
137 |       return NextResponse.json({ error: "Invalid request body: Must be valid JSON" }, { status: 400 });
138 |     }
139 |     return NextResponse.json(
140 |       { error: "Failed to update chat title due to an internal server error" },
141 |       { status: 500 }
142 |     );
143 |   }
144 | }
```

app/api/chats/migrate/route.ts
```
1 | import { NextRequest, NextResponse } from "next/server";
2 | import { auth } from "@/lib/auth";
3 | import { db } from "@/lib/db";
4 | import { chats } from "@/lib/db/schema";
5 | import { eq } from "drizzle-orm";
6 | import { z } from "zod";
7 | 
8 | const migrateSchema = z.object({
9 |     localUserId: z.string().min(1, "Local user ID is required"),
10 | });
11 | 
12 | export async function POST(req: NextRequest) {
13 |     // 1. Check Authentication using headers
14 |     const session = await auth.api.getSession({ headers: req.headers });
15 |     if (!session?.user?.id) {
16 |         return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
17 |     }
18 |     const authenticatedUserId = session.user.id;
19 | 
20 |     // 2. Validate Request Body
21 |     let parsedBody;
22 |     try {
23 |         const body = await req.json();
24 |         parsedBody = migrateSchema.parse(body);
25 |     } catch (error) {
26 |         if (error instanceof z.ZodError) {
27 |             return NextResponse.json({ error: error.errors }, { status: 400 });
28 |         }
29 |         return NextResponse.json(
30 |             { error: "Invalid request body" },
31 |             { status: 400 },
32 |         );
33 |     }
34 | 
35 |     const { localUserId } = parsedBody;
36 | 
37 |     // 3. Perform Database Update
38 |     try {
39 |         console.log(
40 |             `Migrating chats from local user ${localUserId} to authenticated user ${authenticatedUserId}`,
41 |         );
42 |         const result = await db
43 |             .update(chats)
44 |             .set({ userId: authenticatedUserId })
45 |             .where(eq(chats.userId, localUserId))
46 |             .returning({ updatedId: chats.id }); // Optional: return updated chat IDs
47 | 
48 |         console.log(`Migrated ${result.length} chats.`);
49 | 
50 |         return NextResponse.json(
51 |             { success: true, migratedCount: result.length },
52 |             { status: 200 },
53 |         );
54 |     } catch (dbError) {
55 |         console.error("Database error during chat migration:", dbError);
56 |         return NextResponse.json(
57 |             { error: "Failed to migrate chats" },
58 |             { status: 500 },
59 |         );
60 |     }
61 | } 
```

app/api/favorites/models/route.ts
```
1 | import { NextRequest, NextResponse } from 'next/server';
2 | import { auth } from '@/lib/auth';
3 | import { db } from '@/lib/db';
4 | import { favoriteModels } from '@/lib/db/schema';
5 | import { eq, and } from 'drizzle-orm';
6 | import { z } from 'zod';
7 | 
8 | // Schema for validating favorite model requests
9 | const favoriteModelSchema = z.object({
10 |     modelId: z.string().min(1, 'Model ID is required'),
11 | });
12 | 
13 | // Helper to create error responses
14 | function createErrorResponse(message: string, status = 500): NextResponse {
15 |     return NextResponse.json({ error: message }, { status });
16 | }
17 | 
18 | // GET /api/favorites/models - Get user's favorite models
19 | export async function GET(request: NextRequest) {
20 |     try {
21 |         const session = await auth.api.getSession({ headers: request.headers });
22 | 
23 |         if (!session?.user?.id) {
24 |             return createErrorResponse('Unauthorized', 401);
25 |         }
26 | 
27 |         const userFavorites = await db
28 |             .select({ modelId: favoriteModels.modelId, createdAt: favoriteModels.createdAt })
29 |             .from(favoriteModels)
30 |             .where(eq(favoriteModels.userId, session.user.id))
31 |             .orderBy(favoriteModels.createdAt);
32 | 
33 |         return NextResponse.json({
34 |             favorites: userFavorites.map(f => f.modelId),
35 |             count: userFavorites.length,
36 |             lastUpdated: new Date(),
37 |         });
38 | 
39 |     } catch (error) {
40 |         console.error('Error fetching favorite models:', error);
41 |         return createErrorResponse('Failed to fetch favorite models');
42 |     }
43 | }
44 | 
45 | // POST /api/favorites/models - Add a model to favorites
46 | export async function POST(request: NextRequest) {
47 |     try {
48 |         const session = await auth.api.getSession({ headers: request.headers });
49 | 
50 |         if (!session?.user?.id) {
51 |             return createErrorResponse('Unauthorized', 401);
52 |         }
53 | 
54 |         const body = await request.json();
55 |         const validatedData = favoriteModelSchema.parse(body);
56 | 
57 |         // Check if model is already favorited
58 |         const existingFavorite = await db
59 |             .select()
60 |             .from(favoriteModels)
61 |             .where(and(
62 |                 eq(favoriteModels.userId, session.user.id),
63 |                 eq(favoriteModels.modelId, validatedData.modelId)
64 |             ))
65 |             .limit(1);
66 | 
67 |         if (existingFavorite.length > 0) {
68 |             return createErrorResponse('Model is already in favorites', 409);
69 |         }
70 | 
71 |         // Add to favorites
72 |         await db.insert(favoriteModels).values({
73 |             userId: session.user.id,
74 |             modelId: validatedData.modelId,
75 |         });
76 | 
77 |         return NextResponse.json({
78 |             success: true,
79 |             message: 'Model added to favorites',
80 |             modelId: validatedData.modelId,
81 |         });
82 | 
83 |     } catch (error) {
84 |         if (error instanceof z.ZodError) {
85 |             return createErrorResponse(`Invalid request: ${error.errors[0]?.message}`, 400);
86 |         }
87 | 
88 |         console.error('Error adding favorite model:', error);
89 |         return createErrorResponse('Failed to add model to favorites');
90 |     }
91 | } 
```

app/api/presets/[id]/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { db } from '@/lib/db';
3 | import { presets } from '@/lib/db/schema';
4 | import { auth } from '@/lib/auth';
5 | import { eq, and, isNull } from 'drizzle-orm';
6 | import { validatePresetParameters, validateModelAccess } from '@/lib/parameter-validation';
7 | import { getModelDetails } from '@/lib/models/fetch-models';
8 | 
9 | // Helper to create error responses
10 | const createErrorResponse = (message: string, status: number) => {
11 |   return new Response(JSON.stringify({ error: message }), {
12 |     status,
13 |     headers: { 'Content-Type': 'application/json' }
14 |   });
15 | };
16 | 
17 | // Helper to check if user has access to premium models
18 | async function userCanAccessPremium(userId: string): Promise<boolean> {
19 |   return true; // For now, assume all authenticated users can access premium models
20 | }
21 | 
22 | // GET /api/presets/[id] - Get preset details
23 | export async function GET(
24 |   req: NextRequest,
25 |   { params }: { params: Promise<{ id: string }> }
26 | ) {
27 |   try {
28 |     const { id: presetId } = await params;
29 | 
30 |     // Get preset (accessible by owner or if shared)
31 |     const preset = await db
32 |       .select()
33 |       .from(presets)
34 |       .where(and(
35 |         eq(presets.id, presetId),
36 |         isNull(presets.deletedAt)
37 |       ))
38 |       .limit(1);
39 | 
40 |     if (preset.length === 0) {
41 |       return createErrorResponse('Preset not found', 404);
42 |     }
43 | 
44 |     const presetData = preset[0];
45 | 
46 |     // Check access permissions
47 |     const session = await auth.api.getSession({ headers: req.headers });
48 |     const isOwner = session?.user?.id === presetData.userId;
49 |     const isShared = presetData.visibility === 'shared';
50 | 
51 |     if (!isOwner && !isShared) {
52 |       return createErrorResponse('Access denied', 403);
53 |     }
54 | 
55 |     // Format response (convert temperature back to float)
56 |     const formattedPreset = {
57 |       ...presetData,
58 |       temperature: presetData.temperature / 1000,
59 |       // Hide sensitive fields for non-owners
60 |       ...(isOwner ? {} : {
61 |         apiKeyPreferences: {},
62 |         userId: undefined
63 |       })
64 |     };
65 | 
66 |     return new Response(JSON.stringify(formattedPreset), {
67 |       headers: { 'Content-Type': 'application/json' }
68 |     });
69 |   } catch (error) {
70 |     console.error('Error fetching preset:', error);
71 |     return createErrorResponse('Internal server error', 500);
72 |   }
73 | }
74 | 
75 | // PUT /api/presets/[id] - Update preset
76 | export async function PUT(
77 |   req: NextRequest,
78 |   { params }: { params: Promise<{ id: string }> }
79 | ) {
80 |   try {
81 |     const session = await auth.api.getSession({ headers: req.headers });
82 |     if (!session?.user?.id) {
83 |       return createErrorResponse('Authentication required', 401);
84 |     }
85 | 
86 |     const userId = session.user.id;
87 |     const { id: presetId } = await params;
88 |     const data = await req.json();
89 | 
90 |     // Check if preset exists and user owns it
91 |     const existingPreset = await db
92 |       .select()
93 |       .from(presets)
94 |       .where(and(
95 |         eq(presets.id, presetId),
96 |         eq(presets.userId, userId),
97 |         isNull(presets.deletedAt)
98 |       ))
99 |       .limit(1);
100 | 
101 |     if (existingPreset.length === 0) {
102 |       return createErrorResponse('Preset not found or access denied', 404);
103 |     }
104 | 
105 |     const {
106 |       name,
107 |       modelId,
108 |       systemInstruction,
109 |       temperature,
110 |       maxTokens,
111 |       webSearchEnabled,
112 |       webSearchContextSize,
113 |       apiKeyPreferences,
114 |       isDefault
115 |     } = data;
116 | 
117 |     // Validate parameters if provided
118 |     if (modelId && (temperature !== undefined || maxTokens !== undefined || systemInstruction)) {
119 |       const validation = validatePresetParameters(modelId, temperature, maxTokens, systemInstruction);
120 |       if (!validation.valid) {
121 |         return createErrorResponse(`Invalid parameters: ${validation.errors.join(', ')}`, 400);
122 |       }
123 | 
124 |       // Validate model access
125 |       const canAccessPremium = await userCanAccessPremium(userId);
126 |       const modelInfo = await getModelDetails(modelId);
127 |       const modelAccessValidation = validateModelAccess(modelInfo, canAccessPremium);
128 |       if (!modelAccessValidation.valid) {
129 |         return createErrorResponse(`Model access denied: ${modelAccessValidation.errors.join(', ')}`, 403);
130 |       }
131 |     }
132 | 
133 |     // Check for name conflicts (if name is being changed)
134 |     if (name && name !== existingPreset[0].name) {
135 |       const nameConflict = await db
136 |         .select()
137 |         .from(presets)
138 |         .where(and(
139 |           eq(presets.userId, userId),
140 |           eq(presets.name, name),
141 |           isNull(presets.deletedAt)
142 |         ))
143 |         .limit(1);
144 | 
145 |       if (nameConflict.length > 0) {
146 |         return createErrorResponse('A preset with this name already exists', 409);
147 |       }
148 |     }
149 | 
150 |     // If setting as default, unset other defaults
151 |     if (isDefault && !existingPreset[0].isDefault) {
152 |       await db
153 |         .update(presets)
154 |         .set({ isDefault: false, updatedAt: new Date() })
155 |         .where(and(
156 |           eq(presets.userId, userId),
157 |           eq(presets.isDefault, true),
158 |           isNull(presets.deletedAt)
159 |         ));
160 |     }
161 | 
162 |     // Build update object (only include provided fields)
163 |     const updateData: any = {
164 |       updatedAt: new Date()
165 |     };
166 | 
167 |     if (name !== undefined) updateData.name = name;
168 |     if (modelId !== undefined) updateData.modelId = modelId;
169 |     if (systemInstruction !== undefined) updateData.systemInstruction = systemInstruction;
170 |     if (temperature !== undefined) updateData.temperature = Math.round(temperature * 1000);
171 |     if (maxTokens !== undefined) updateData.maxTokens = maxTokens;
172 |     if (webSearchEnabled !== undefined) updateData.webSearchEnabled = webSearchEnabled;
173 |     if (webSearchContextSize !== undefined) updateData.webSearchContextSize = webSearchContextSize;
174 |     if (apiKeyPreferences !== undefined) updateData.apiKeyPreferences = apiKeyPreferences;
175 |     if (isDefault !== undefined) updateData.isDefault = isDefault;
176 | 
177 |     // Update preset
178 |     const updatedPreset = await db
179 |       .update(presets)
180 |       .set(updateData)
181 |       .where(eq(presets.id, presetId))
182 |       .returning();
183 | 
184 |     // Format response
185 |     const formattedPreset = {
186 |       ...updatedPreset[0],
187 |       temperature: updatedPreset[0].temperature / 1000
188 |     };
189 | 
190 |     return new Response(JSON.stringify(formattedPreset), {
191 |       headers: { 'Content-Type': 'application/json' }
192 |     });
193 |   } catch (error) {
194 |     console.error('Error updating preset:', error);
195 |     return createErrorResponse('Internal server error', 500);
196 |   }
197 | }
198 | 
199 | // DELETE /api/presets/[id] - Delete preset (soft delete)
200 | export async function DELETE(
201 |   req: NextRequest,
202 |   { params }: { params: Promise<{ id: string }> }
203 | ) {
204 |   try {
205 |     const session = await auth.api.getSession({ headers: req.headers });
206 |     if (!session?.user?.id) {
207 |       return createErrorResponse('Authentication required', 401);
208 |     }
209 | 
210 |     const userId = session.user.id;
211 |     const { id: presetId } = await params;
212 | 
213 |     // Check if preset exists and user owns it
214 |     const existingPreset = await db
215 |       .select()
216 |       .from(presets)
217 |       .where(and(
218 |         eq(presets.id, presetId),
219 |         eq(presets.userId, userId),
220 |         isNull(presets.deletedAt)
221 |       ))
222 |       .limit(1);
223 | 
224 |     if (existingPreset.length === 0) {
225 |       return createErrorResponse('Preset not found or access denied', 404);
226 |     }
227 | 
228 |     // Soft delete preset
229 |     await db
230 |       .update(presets)
231 |       .set({
232 |         deletedAt: new Date(),
233 |         updatedAt: new Date(),
234 |         isDefault: false // Unset default if this was the default preset
235 |       })
236 |       .where(eq(presets.id, presetId));
237 | 
238 |     return new Response(JSON.stringify({ success: true }), {
239 |       headers: { 'Content-Type': 'application/json' }
240 |     });
241 |   } catch (error) {
242 |     console.error('Error deleting preset:', error);
243 |     return createErrorResponse('Internal server error', 500);
244 |   }
245 | }
```

app/api/presets/validate/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { validatePresetParameters, validateModelAccess, getModelParameterConstraints } from '@/lib/parameter-validation';
3 | import { getModelDetails } from '@/lib/models/fetch-models';
4 | import { auth } from '@/lib/auth';
5 | 
6 | // Helper to create error responses
7 | const createErrorResponse = (message: string, status: number) => {
8 |   return new Response(JSON.stringify({ error: message }), {
9 |     status,
10 |     headers: { 'Content-Type': 'application/json' }
11 |   });
12 | };
13 | 
14 | // Helper to check if user has access to premium models
15 | async function userCanAccessPremium(userId: string): Promise<boolean> {
16 |   return true; // For now, assume all authenticated users can access premium models
17 | }
18 | 
19 | // POST /api/presets/validate - Validate preset parameters for model
20 | export async function POST(req: NextRequest) {
21 |   try {
22 |     const session = await auth.api.getSession({ headers: req.headers });
23 |     if (!session?.user?.id) {
24 |       return createErrorResponse('Authentication required', 401);
25 |     }
26 | 
27 |     const userId = session.user.id;
28 |     const data = await req.json();
29 | 
30 |     const {
31 |       modelId,
32 |       temperature,
33 |       maxTokens,
34 |       systemInstruction
35 |     } = data;
36 | 
37 |     // Validate required field
38 |     if (!modelId) {
39 |       return createErrorResponse('Missing required field: modelId', 400);
40 |     }
41 | 
42 |     // Get model info first for validation
43 |     const modelInfo = await getModelDetails(modelId);
44 | 
45 |     // Get model constraints
46 |     const constraints = getModelParameterConstraints(modelInfo);
47 | 
48 |     // Validate model access
49 |     const canAccessPremium = await userCanAccessPremium(userId);
50 |     const modelAccessValidation = validateModelAccess(modelInfo, canAccessPremium);
51 |     if (!modelAccessValidation.valid) {
52 |       return new Response(JSON.stringify({
53 |         valid: false,
54 |         errors: modelAccessValidation.errors,
55 |         constraints
56 |       }), {
57 |         headers: { 'Content-Type': 'application/json' }
58 |       });
59 |     }
60 | 
61 |     // Validate parameters
62 |     const validation = validatePresetParameters(modelInfo, temperature, maxTokens, systemInstruction);
63 | 
64 |     return new Response(JSON.stringify({
65 |       valid: validation.valid,
66 |       errors: validation.errors,
67 |       constraints
68 |     }), {
69 |       headers: { 'Content-Type': 'application/json' }
70 |     });
71 |   } catch (error) {
72 |     console.error('Error validating preset parameters:', error);
73 |     return createErrorResponse('Internal server error', 500);
74 |   }
75 | }
```

app/api/usage/messages/route.ts
```
1 | import { NextResponse } from 'next/server';
2 | import { auth, checkMessageLimit } from '@/lib/auth';
3 | 
4 | /**
5 |  * API endpoint to get message usage information for the current user
6 |  */
7 | export async function GET(req: Request) {
8 |     try {
9 |         // Get the authenticated session
10 |         const session = await auth.api.getSession({ headers: req.headers });
11 | 
12 |         // If no session exists, return error
13 |         if (!session || !session.user || !session.user.id) {
14 |             return NextResponse.json(
15 |                 { error: 'Unauthorized' },
16 |                 { status: 401 }
17 |             );
18 |         }
19 | 
20 |         const userId = session.user.id;
21 |         const isAnonymous = (session.user as any).isAnonymous === true;
22 | 
23 |         // Check message limit for this user
24 |         const limitStatus = await checkMessageLimit(userId, isAnonymous);
25 | 
26 |         return NextResponse.json({
27 |             limit: limitStatus.limit,
28 |             used: limitStatus.limit - limitStatus.remaining,
29 |             remaining: limitStatus.remaining,
30 |             isAnonymous,
31 |             // Check if user has a Polar subscription
32 |             hasSubscription: (session.user as any)?.metadata?.hasSubscription || false,
33 |             // Include credit information
34 |             credits: limitStatus.credits || 0,
35 |             hasCredits: (limitStatus.credits || 0) > 0,
36 |             usedCredits: limitStatus.usedCredits || false
37 |         });
38 |     } catch (error) {
39 |         console.error('Error getting message usage:', error);
40 |         return NextResponse.json(
41 |             { error: 'Failed to get message usage' },
42 |             { status: 500 }
43 |         );
44 |     }
45 | } 
```

app/chats/shared/[shareId]/page.tsx
```
1 | import { notFound } from 'next/navigation';
2 | import { SharedChatMessages } from '@/components/shared-chat-messages';
3 | import { ChatSharingService } from '@/lib/services/chat-sharing';
4 | import type { ChatSnapshot } from '@/lib/services/chat-sharing';
5 | 
6 | interface PageProps {
7 |   params: Promise<{ shareId: string }>;
8 | }
9 | 
10 | async function getSharedChat(shareId: string): Promise<ChatSnapshot | null> {
11 |   try {
12 |     // Call the service directly instead of making an HTTP request
13 |     // This avoids issues with server-side fetch and environment variables
14 |     return await ChatSharingService.getSharedChat(shareId);
15 |   } catch (error) {
16 |     console.error('Error fetching shared chat:', error);
17 |     return null;
18 |   }
19 | }
20 | 
21 | export default async function SharedChatPage({ params }: PageProps) {
22 |   const { shareId } = await params;
23 |   const snapshot = await getSharedChat(shareId);
24 | 
25 |   if (!snapshot) {
26 |     notFound();
27 |   }
28 | 
29 |   return (
30 |     <div className="min-h-screen bg-background flex flex-col">
31 |       {/* Header */}
32 |       <header className="border-b bg-background/80 backdrop-blur supports-[backdrop-filter]:bg-background/80">
33 |         <div className="max-w-lg sm:max-w-3xl mx-auto px-4 py-4">
34 |           <div className="flex items-center justify-between">
35 |             <div>
36 |               <h1 className="font-semibold text-lg">{snapshot.chat.title}</h1>
37 |               <p className="text-sm text-muted-foreground">
38 |                 Shared chat • {new Date(snapshot.chat.createdAt).toLocaleDateString()}
39 |               </p>
40 |             </div>
41 |             <div className="flex items-center gap-2">
42 |               <div className="px-2 py-1 bg-orange-100 dark:bg-orange-900/20 text-orange-800 dark:text-orange-200 text-xs rounded-full">
43 |                 Read-only
44 |               </div>
45 |             </div>
46 |           </div>
47 |         </div>
48 |       </header>
49 | 
50 |       {/* Messages */}
51 |       <main className="flex-1 overflow-hidden">
52 |         <SharedChatMessages 
53 |           messages={snapshot.messages}
54 |           metadata={snapshot.metadata}
55 |         />
56 |       </main>
57 | 
58 |       {/* Footer with redaction notice */}
59 |       {snapshot.metadata.redaction.piiRemoved && (
60 |         <footer className="border-t bg-muted/30">
61 |           <div className="max-w-lg sm:max-w-3xl mx-auto px-4 py-3">
62 |             <p className="text-xs text-muted-foreground text-center">
63 |               This shared chat has been sanitized for privacy. Personal information, 
64 |               system prompts, tool arguments, and media attachments have been removed.
65 |             </p>
66 |           </div>
67 |         </footer>
68 |       )}
69 |     </div>
70 |   );
71 | }
72 | 
73 | // Generate metadata for SEO
74 | export async function generateMetadata({ params }: PageProps) {
75 |   const { shareId } = await params;
76 |   const snapshot = await getSharedChat(shareId);
77 | 
78 |   if (!snapshot) {
79 |     return {
80 |       title: 'Shared Chat Not Found',
81 |       description: 'The requested shared chat could not be found.',
82 |     };
83 |   }
84 | 
85 |   return {
86 |     title: `${snapshot.chat.title} - Shared Chat`,
87 |     description: `A shared conversation about ${snapshot.chat.title}`,
88 |     robots: 'noindex, nofollow', // Don't index shared chats for privacy
89 |   };
90 | }
```

app/presets/shared/[shareId]/page.tsx
```
1 | 'use client';
2 | 
3 | import { useEffect, useState } from 'react';
4 | import { useParams, useRouter } from 'next/navigation';
5 | import { Button } from '@/components/ui/button';
6 | import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
7 | import { Badge } from '@/components/ui/badge';
8 | import { Loader2, Download, ArrowLeft, Copy, Check } from 'lucide-react';
9 | import { usePresets } from '@/lib/context/preset-context';
10 | import { useModels } from '@/hooks/use-models';
11 | import { toast } from 'sonner';
12 | 
13 | interface SharedPreset {
14 |   id: string;
15 |   name: string;
16 |   modelId: string;
17 |   systemInstruction: string;
18 |   temperature: number;
19 |   maxTokens: number;
20 |   webSearchEnabled: boolean;
21 |   webSearchContextSize: 'low' | 'medium' | 'high';
22 |   shareId: string;
23 |   visibility: 'shared';
24 |   createdAt: string;
25 | }
26 | 
27 | export default function SharedPresetPage() {
28 |   const params = useParams();
29 |   const router = useRouter();
30 |   const { importSharedPreset } = usePresets();
31 |   const { models } = useModels();
32 |   
33 |   const [preset, setPreset] = useState<SharedPreset | null>(null);
34 |   const [loading, setLoading] = useState(true);
35 |   const [error, setError] = useState<string | null>(null);
36 |   const [importing, setImporting] = useState(false);
37 |   const [copied, setCopied] = useState(false);
38 | 
39 |   const shareId = params.shareId as string;
40 | 
41 |   // Helper function to get model info
42 |   const getModelInfo = (modelId: string) => {
43 |     return models.find(model => model.id === modelId);
44 |   };
45 | 
46 |   // Helper function to get model name
47 |   const getModelName = (modelId: string) => {
48 |     const modelInfo = getModelInfo(modelId);
49 |     return modelInfo?.name || modelId;
50 |   };
51 | 
52 |   // Helper function to get provider name
53 |   const getModelProvider = (modelId: string): string => {
54 |     const modelInfo = getModelInfo(modelId);
55 |     return modelInfo?.provider || 'Unknown';
56 |   };
57 | 
58 |   // Load shared preset
59 |   useEffect(() => {
60 |     const loadSharedPreset = async () => {
61 |       try {
62 |         setLoading(true);
63 |         setError(null);
64 | 
65 |         const response = await fetch(`/api/presets/shared/${shareId}`);
66 |         
67 |         if (!response.ok) {
68 |           if (response.status === 404) {
69 |             setError('This shared preset is no longer available or has been removed.');
70 |           } else {
71 |             setError('Failed to load shared preset. Please try again.');
72 |           }
73 |           return;
74 |         }
75 | 
76 |         const data = await response.json();
77 |         setPreset(data);
78 |       } catch (error) {
79 |         console.error('Error loading shared preset:', error);
80 |         setError('Failed to load shared preset. Please try again.');
81 |       } finally {
82 |         setLoading(false);
83 |       }
84 |     };
85 | 
86 |     if (shareId) {
87 |       loadSharedPreset();
88 |     }
89 |   }, [shareId]);
90 | 
91 |   // Handle import
92 |   const handleImport = async () => {
93 |     if (!preset) return;
94 | 
95 |     try {
96 |       setImporting(true);
97 |       await importSharedPreset(shareId);
98 |       toast.success('Preset imported successfully!');
99 |       router.push('/'); // Redirect to home page
100 |     } catch (error) {
101 |       console.error('Error importing preset:', error);
102 |       toast.error('Failed to import preset. Please try again.');
103 |     } finally {
104 |       setImporting(false);
105 |     }
106 |   };
107 | 
108 |   // Handle copy link
109 |   const handleCopyLink = async () => {
110 |     try {
111 |       await navigator.clipboard.writeText(window.location.href);
112 |       setCopied(true);
113 |       toast.success('Link copied to clipboard!');
114 |       setTimeout(() => setCopied(false), 2000);
115 |     } catch (error) {
116 |       toast.error('Failed to copy link');
117 |     }
118 |   };
119 | 
120 |   if (loading) {
121 |     return (
122 |       <div className="min-h-screen flex items-center justify-center">
123 |         <div className="flex items-center gap-2">
124 |           <Loader2 className="h-6 w-6 animate-spin" />
125 |           <span>Loading shared preset...</span>
126 |         </div>
127 |       </div>
128 |     );
129 |   }
130 | 
131 |   if (error) {
132 |     return (
133 |       <div className="min-h-screen flex items-center justify-center">
134 |         <Card className="w-full max-w-md">
135 |           <CardHeader>
136 |             <CardTitle className="text-red-600">Preset Not Found</CardTitle>
137 |             <CardDescription>{error}</CardDescription>
138 |           </CardHeader>
139 |           <CardContent>
140 |             <Button onClick={() => router.push('/')} className="w-full">
141 |               <ArrowLeft className="w-4 h-4 mr-2" />
142 |               Go Home
143 |             </Button>
144 |           </CardContent>
145 |         </Card>
146 |       </div>
147 |     );
148 |   }
149 | 
150 |   if (!preset) {
151 |     return null;
152 |   }
153 | 
154 |   return (
155 |     <div className="min-h-screen bg-background">
156 |       <div className="container mx-auto px-4 py-8 max-w-4xl">
157 |         {/* Header */}
158 |         <div className="flex items-center gap-4 mb-8">
159 |           <Button
160 |             variant="ghost"
161 |             onClick={() => router.push('/')}
162 |             className="shrink-0"
163 |           >
164 |             <ArrowLeft className="w-4 h-4 mr-2" />
165 |             Back
166 |           </Button>
167 |           <div className="flex-1">
168 |             <h1 className="text-2xl font-bold">Shared Preset</h1>
169 |             <p className="text-muted-foreground">Import this preset to your collection</p>
170 |           </div>
171 |         </div>
172 | 
173 |         {/* Preset Card */}
174 |         <Card className="mb-6">
175 |           <CardHeader>
176 |             <div className="flex items-start justify-between">
177 |               <div className="flex-1">
178 |                 <CardTitle className="text-xl">{preset.name}</CardTitle>
179 |                 <CardDescription className="mt-2">
180 |                   A shared preset from ChatLima
181 |                 </CardDescription>
182 |               </div>
183 |               <Button
184 |                 variant="outline"
185 |                 size="sm"
186 |                 onClick={handleCopyLink}
187 |                 className="shrink-0"
188 |               >
189 |                 {copied ? (
190 |                   <>
191 |                     <Check className="w-4 h-4 mr-2" />
192 |                     Copied!
193 |                   </>
194 |                 ) : (
195 |                   <>
196 |                     <Copy className="w-4 h-4 mr-2" />
197 |                     Copy Link
198 |                   </>
199 |                 )}
200 |               </Button>
201 |             </div>
202 |           </CardHeader>
203 |           <CardContent className="space-y-6">
204 |             {/* Model Info */}
205 |             <div className="flex items-center gap-2">
206 |               <Badge variant="secondary">{getModelProvider(preset.modelId)}</Badge>
207 |               <span className="text-sm text-muted-foreground">{getModelName(preset.modelId)}</span>
208 |             </div>
209 | 
210 |             {/* Settings */}
211 |             <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
212 |               <div>
213 |                 <label className="text-sm font-medium text-muted-foreground">Temperature</label>
214 |                 <p className="text-sm">{preset.temperature}</p>
215 |               </div>
216 |               <div>
217 |                 <label className="text-sm font-medium text-muted-foreground">Max Tokens</label>
218 |                 <p className="text-sm">{preset.maxTokens.toLocaleString()}</p>
219 |               </div>
220 |               <div>
221 |                 <label className="text-sm font-medium text-muted-foreground">Web Search</label>
222 |                 <p className="text-sm">{preset.webSearchEnabled ? 'Enabled' : 'Disabled'}</p>
223 |               </div>
224 |             </div>
225 | 
226 |             {/* System Instruction */}
227 |             <div>
228 |               <label className="text-sm font-medium text-muted-foreground">System Instruction</label>
229 |               <div className="mt-2 p-3 bg-muted rounded-md">
230 |                 <p className="text-sm whitespace-pre-wrap">{preset.systemInstruction}</p>
231 |               </div>
232 |             </div>
233 | 
234 |             {/* Import Button */}
235 |             <div className="pt-4">
236 |               <Button
237 |                 onClick={handleImport}
238 |                 disabled={importing}
239 |                 className="w-full"
240 |                 size="lg"
241 |               >
242 |                 {importing ? (
243 |                   <>
244 |                     <Loader2 className="w-4 h-4 mr-2 animate-spin" />
245 |                     Importing...
246 |                   </>
247 |                 ) : (
248 |                   <>
249 |                     <Download className="w-4 h-4 mr-2" />
250 |                     Import Preset
251 |                   </>
252 |                 )}
253 |               </Button>
254 |             </div>
255 |           </CardContent>
256 |         </Card>
257 |       </div>
258 |     </div>
259 |   );
260 | } 
```

app/api/auth/polar/webhooks/route.ts
```
1 | import { auth } from '@/lib/auth';
2 | import { NextRequest, NextResponse } from 'next/server';
3 | 
4 | // GET handler for testing the endpoint
5 | export async function GET() {
6 |     console.log('Polar webhooks GET endpoint hit for testing');
7 |     return NextResponse.json({ status: 'Polar webhooks endpoint is active' });
8 | }
9 | 
10 | // This is the correct path for Polar webhooks according to the documentation
11 | // The BetterAuth Polar plugin expects webhooks at /polar/webhooks relative to auth mount point
12 | export async function POST(req: NextRequest) {
13 |     console.log('Polar webhook received at correct path: /api/auth/polar/webhooks');
14 | 
15 |     // Simply forward the request to the auth handler which will process it
16 |     return auth.handler(req);
17 | } 
```

app/api/auth/sign-in/anonymous/route.ts
```
1 | "use server";
2 | 
3 | import { auth } from '@/lib/auth';
4 | import { redirect } from 'next/navigation';
5 | 
6 | export async function POST(request: Request) {
7 |     console.log('Anonymous sign-in endpoint called');
8 | 
9 |     try {
10 |         // Forward to the auth handler
11 |         const response = await auth.handler(
12 |             new Request(`${request.url.split('/api/auth')[0]}/api/auth/sign-in/anonymous`, {
13 |                 method: 'POST',
14 |                 headers: request.headers,
15 |                 body: request.body,
16 |                 // @ts-expect-error - duplex is required for Node.js but not included in the TypeScript types
17 |                 duplex: 'half'
18 |             })
19 |         );
20 | 
21 |         console.log('Anonymous sign-in response status:', response.status);
22 | 
23 |         // Check if the response is successful
24 |         if (!response.ok) {
25 |             // Clone the response to read the body
26 |             const clonedResponse = response.clone();
27 |             try {
28 |                 const responseBody = await clonedResponse.text();
29 |                 console.error('Auth handler error response:', responseBody);
30 |             } catch (bodyError) {
31 |                 console.error('Could not read error response body:', bodyError);
32 |             }
33 | 
34 |             // Still return the original response to maintain behavior
35 |             return response;
36 |         }
37 | 
38 |         console.log('Anonymous sign-in successful');
39 |         return response;
40 |     } catch (error) {
41 |         console.error('Error in anonymous sign-in:', error);
42 |         // Log more details about the error
43 |         if (error instanceof Error) {
44 |             console.error('Error name:', error.name);
45 |             console.error('Error message:', error.message);
46 |             console.error('Error stack:', error.stack);
47 |         }
48 | 
49 |         return new Response(
50 |             JSON.stringify({ error: 'Failed to sign in anonymously' }),
51 |             { status: 500, headers: { 'Content-Type': 'application/json' } }
52 |         );
53 |     }
54 | } 
```

app/api/chats/[id]/share/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { auth } from '@/lib/auth';
3 | import { ChatSharingService } from '@/lib/services/chat-sharing';
4 | 
5 | // Helper to create error responses
6 | const createErrorResponse = (message: string, status: number) => {
7 |     return new Response(JSON.stringify({ error: message }), {
8 |         status,
9 |         headers: { 'Content-Type': 'application/json' }
10 |     });
11 | };
12 | 
13 | // Helper function to get the correct base URL
14 | const getBaseUrl = (req: NextRequest) => {
15 |     if (process.env.NODE_ENV === 'development') {
16 |         return 'http://localhost:3000';
17 |     }
18 |     return process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com';
19 | };
20 | 
21 | // GET /api/chats/[id]/share - Check for existing share without creating one
22 | export async function GET(
23 |     req: NextRequest,
24 |     { params }: { params: Promise<{ id: string }> }
25 | ) {
26 |     try {
27 |         const session = await auth.api.getSession({ headers: req.headers });
28 |         if (!session?.user?.id) {
29 |             return createErrorResponse('Authentication required', 401);
30 |         }
31 | 
32 |         const userId = session.user.id;
33 |         const { id: chatId } = await params;
34 |         const baseUrl = getBaseUrl(req);
35 | 
36 |         // Check for existing share
37 |         const existingShare = await ChatSharingService.getExistingShare(chatId, userId, baseUrl);
38 | 
39 |         if (existingShare) {
40 |             return new Response(JSON.stringify(existingShare), {
41 |                 headers: { 'Content-Type': 'application/json' }
42 |             });
43 |         } else {
44 |             return new Response(JSON.stringify({ exists: false }), {
45 |                 headers: { 'Content-Type': 'application/json' }
46 |             });
47 |         }
48 |     } catch (error) {
49 |         console.error('Error checking existing share:', error);
50 | 
51 |         if (error instanceof Error && error.message === 'Chat not found or access denied') {
52 |             return createErrorResponse('Chat not found or access denied', 404);
53 |         }
54 | 
55 |         return createErrorResponse('Internal server error', 500);
56 |     }
57 | }
58 | 
59 | // POST /api/chats/[id]/share - Create or retrieve shareable link
60 | export async function POST(
61 |     req: NextRequest,
62 |     { params }: { params: Promise<{ id: string }> }
63 | ) {
64 |     try {
65 |         const session = await auth.api.getSession({ headers: req.headers });
66 |         if (!session?.user?.id) {
67 |             return createErrorResponse('Authentication required', 401);
68 |         }
69 | 
70 |         const userId = session.user.id;
71 |         const { id: chatId } = await params;
72 |         const baseUrl = getBaseUrl(req);
73 | 
74 |         // Create or get existing share
75 |         const result = await ChatSharingService.createShare(chatId, userId, baseUrl);
76 | 
77 |         return new Response(JSON.stringify(result), {
78 |             status: 201,
79 |             headers: { 'Content-Type': 'application/json' }
80 |         });
81 |     } catch (error) {
82 |         console.error('Error creating chat share:', error);
83 | 
84 |         if (error instanceof Error && error.message === 'Chat not found or access denied') {
85 |             return createErrorResponse('Chat not found or access denied', 404);
86 |         }
87 | 
88 |         return createErrorResponse('Internal server error', 500);
89 |     }
90 | }
91 | 
92 | // DELETE /api/chats/[id]/share - Revoke share link
93 | export async function DELETE(
94 |     req: NextRequest,
95 |     { params }: { params: Promise<{ id: string }> }
96 | ) {
97 |     try {
98 |         const session = await auth.api.getSession({ headers: req.headers });
99 |         if (!session?.user?.id) {
100 |             return createErrorResponse('Authentication required', 401);
101 |         }
102 | 
103 |         const userId = session.user.id;
104 |         const { id: chatId } = await params;
105 | 
106 |         // Revoke the share
107 |         await ChatSharingService.revokeShare(chatId, userId);
108 | 
109 |         return new Response(JSON.stringify({ revoked: true }), {
110 |             headers: { 'Content-Type': 'application/json' }
111 |         });
112 |     } catch (error) {
113 |         console.error('Error revoking chat share:', error);
114 |         return createErrorResponse('Internal server error', 500);
115 |     }
116 | }
```

app/api/chats/shared/[shareId]/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { ChatSharingService } from '@/lib/services/chat-sharing';
3 | 
4 | // Helper to create error responses
5 | const createErrorResponse = (message: string, status: number) => {
6 |     return new Response(JSON.stringify({ error: message }), {
7 |         status,
8 |         headers: { 'Content-Type': 'application/json' }
9 |     });
10 | };
11 | 
12 | // GET /api/chats/shared/[shareId] - Retrieve shared chat by shareId
13 | export async function GET(
14 |     req: NextRequest,
15 |     { params }: { params: Promise<{ shareId: string }> }
16 | ) {
17 |     try {
18 |         const { shareId } = await params;
19 | 
20 |         // Validate share ID format
21 |         if (!shareId || shareId.length < 20) {
22 |             return createErrorResponse('Invalid share ID', 400);
23 |         }
24 | 
25 |         // Get shared chat snapshot
26 |         const snapshot = await ChatSharingService.getSharedChat(shareId);
27 | 
28 |         if (!snapshot) {
29 |             return createErrorResponse('Shared chat not found or no longer available', 404);
30 |         }
31 | 
32 |         return new Response(JSON.stringify(snapshot), {
33 |             headers: {
34 |                 'Content-Type': 'application/json',
35 |                 // Add cache headers for public content
36 |                 'Cache-Control': 'public, max-age=300, stale-while-revalidate=60'
37 |             }
38 |         });
39 |     } catch (error) {
40 |         console.error('Error fetching shared chat:', error);
41 |         return createErrorResponse('Internal server error', 500);
42 |     }
43 | }
```

app/api/favorites/models/[modelId]/route.ts
```
1 | import { NextRequest, NextResponse } from 'next/server';
2 | import { auth } from '@/lib/auth';
3 | import { db } from '@/lib/db';
4 | import { favoriteModels } from '@/lib/db/schema';
5 | import { eq, and } from 'drizzle-orm';
6 | 
7 | // Helper to create error responses
8 | function createErrorResponse(message: string, status = 500): NextResponse {
9 |     return NextResponse.json({ error: message }, { status });
10 | }
11 | 
12 | // DELETE /api/favorites/models/[modelId] - Remove a model from favorites
13 | export async function DELETE(
14 |     request: NextRequest,
15 |     { params }: { params: Promise<{ modelId: string }> }
16 | ) {
17 |     try {
18 |         const session = await auth.api.getSession({ headers: request.headers });
19 | 
20 |         if (!session?.user?.id) {
21 |             return createErrorResponse('Unauthorized', 401);
22 |         }
23 | 
24 |         const { modelId } = await params;
25 | 
26 |         if (!modelId) {
27 |             return createErrorResponse('Model ID is required', 400);
28 |         }
29 | 
30 |         // Remove from favorites
31 |         const result = await db
32 |             .delete(favoriteModels)
33 |             .where(and(
34 |                 eq(favoriteModels.userId, session.user.id),
35 |                 eq(favoriteModels.modelId, modelId)
36 |             ));
37 | 
38 |         return NextResponse.json({
39 |             success: true,
40 |             message: 'Model removed from favorites',
41 |             modelId,
42 |         });
43 | 
44 |     } catch (error) {
45 |         console.error('Error removing favorite model:', error);
46 |         return createErrorResponse('Failed to remove model from favorites');
47 |     }
48 | } 
```

app/api/presets/[id]/share/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { db } from '@/lib/db';
3 | import { presets } from '@/lib/db/schema';
4 | import { auth } from '@/lib/auth';
5 | import { eq, and, isNull } from 'drizzle-orm';
6 | import { nanoid } from 'nanoid';
7 | 
8 | // Helper to create error responses
9 | const createErrorResponse = (message: string, status: number) => {
10 |   return new Response(JSON.stringify({ error: message }), {
11 |     status,
12 |     headers: { 'Content-Type': 'application/json' }
13 |   });
14 | };
15 | 
16 | // Helper to generate secure share ID
17 | function generateShareId(): string {
18 |   return nanoid(32); // Generate a 32-character random string
19 | }
20 | 
21 | // POST /api/presets/[id]/share - Generate or retrieve shareable link
22 | export async function POST(
23 |   req: NextRequest,
24 |   { params }: { params: Promise<{ id: string }> }
25 | ) {
26 |   try {
27 |     const session = await auth.api.getSession({ headers: req.headers });
28 |     if (!session?.user?.id) {
29 |       return createErrorResponse('Authentication required', 401);
30 |     }
31 | 
32 |     const userId = session.user.id;
33 |     const { id: presetId } = await params;
34 | 
35 |     // Check if preset exists and user owns it
36 |     const existingPreset = await db
37 |       .select()
38 |       .from(presets)
39 |       .where(and(
40 |         eq(presets.id, presetId),
41 |         eq(presets.userId, userId),
42 |         isNull(presets.deletedAt)
43 |       ))
44 |       .limit(1);
45 | 
46 |     if (existingPreset.length === 0) {
47 |       return createErrorResponse('Preset not found or access denied', 404);
48 |     }
49 | 
50 |     const preset = existingPreset[0];
51 | 
52 |     // Helper function to get the correct base URL
53 |     const getBaseUrl = (req: NextRequest) => {
54 |       // Check if we're in development
55 |       if (process.env.NODE_ENV === 'development') {
56 |         return 'http://localhost:3000';
57 |       }
58 |       // Use environment variable or fallback to production
59 |       return process.env.NEXT_PUBLIC_APP_URL || 'https://www.chatlima.com';
60 |     };
61 | 
62 |     const baseUrl = getBaseUrl(req);
63 | 
64 |     // If already has a share ID, return it
65 |     if (preset.shareId) {
66 |       return new Response(JSON.stringify({
67 |         shareId: preset.shareId,
68 |         shareUrl: `${baseUrl}/presets/shared/${preset.shareId}`
69 |       }), {
70 |         headers: { 'Content-Type': 'application/json' }
71 |       });
72 |     }
73 | 
74 |     // Generate new share ID and update preset
75 |     const shareId = generateShareId();
76 |     await db
77 |       .update(presets)
78 |       .set({
79 |         shareId,
80 |         visibility: 'shared',
81 |         updatedAt: new Date()
82 |       })
83 |       .where(eq(presets.id, presetId));
84 | 
85 |     return new Response(JSON.stringify({
86 |       shareId,
87 |       shareUrl: `${baseUrl}/presets/shared/${shareId}`
88 |     }), {
89 |       headers: { 'Content-Type': 'application/json' }
90 |     });
91 |   } catch (error) {
92 |     console.error('Error sharing preset:', error);
93 |     return createErrorResponse('Internal server error', 500);
94 |   }
95 | }
96 | 
97 | // DELETE /api/presets/[id]/share - Remove share link (make private)
98 | export async function DELETE(
99 |   req: NextRequest,
100 |   { params }: { params: Promise<{ id: string }> }
101 | ) {
102 |   try {
103 |     const session = await auth.api.getSession({ headers: req.headers });
104 |     if (!session?.user?.id) {
105 |       return createErrorResponse('Authentication required', 401);
106 |     }
107 | 
108 |     const userId = session.user.id;
109 |     const { id: presetId } = await params;
110 | 
111 |     // Check if preset exists and user owns it
112 |     const existingPreset = await db
113 |       .select()
114 |       .from(presets)
115 |       .where(and(
116 |         eq(presets.id, presetId),
117 |         eq(presets.userId, userId),
118 |         isNull(presets.deletedAt)
119 |       ))
120 |       .limit(1);
121 | 
122 |     if (existingPreset.length === 0) {
123 |       return createErrorResponse('Preset not found or access denied', 404);
124 |     }
125 | 
126 |     // Remove share ID and make private
127 |     await db
128 |       .update(presets)
129 |       .set({
130 |         shareId: null,
131 |         visibility: 'private',
132 |         updatedAt: new Date()
133 |       })
134 |       .where(eq(presets.id, presetId));
135 | 
136 |     return new Response(JSON.stringify({ success: true }), {
137 |       headers: { 'Content-Type': 'application/json' }
138 |     });
139 |   } catch (error) {
140 |     console.error('Error unsharing preset:', error);
141 |     return createErrorResponse('Internal server error', 500);
142 |   }
143 | }
```

app/api/presets/shared/[shareId]/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { db } from '@/lib/db';
3 | import { presets } from '@/lib/db/schema';
4 | import { eq, and, isNull } from 'drizzle-orm';
5 | 
6 | // Helper to create error responses
7 | const createErrorResponse = (message: string, status: number) => {
8 |   return new Response(JSON.stringify({ error: message }), {
9 |     status,
10 |     headers: { 'Content-Type': 'application/json' }
11 |   });
12 | };
13 | 
14 | // GET /api/presets/shared/[shareId] - Retrieve shared preset by link
15 | export async function GET(
16 |   req: NextRequest,
17 |   { params }: { params: Promise<{ shareId: string }> }
18 | ) {
19 |   try {
20 |     const { shareId } = await params;
21 | 
22 |     // Validate share ID format
23 |     if (!shareId || shareId.length < 20) {
24 |       return createErrorResponse('Invalid share ID', 400);
25 |     }
26 | 
27 |     // Get shared preset
28 |     const sharedPreset = await db
29 |       .select()
30 |       .from(presets)
31 |       .where(and(
32 |         eq(presets.shareId, shareId),
33 |         eq(presets.visibility, 'shared'),
34 |         isNull(presets.deletedAt)
35 |       ))
36 |       .limit(1);
37 | 
38 |     if (sharedPreset.length === 0) {
39 |       return createErrorResponse('Shared preset not found or no longer available', 404);
40 |     }
41 | 
42 |     const preset = sharedPreset[0];
43 | 
44 |     // Format response (remove sensitive data)
45 |     const publicPreset = {
46 |       id: preset.id,
47 |       name: preset.name,
48 |       modelId: preset.modelId,
49 |       systemInstruction: preset.systemInstruction,
50 |       temperature: preset.temperature / 1000, // Convert back to float
51 |       maxTokens: preset.maxTokens,
52 |       webSearchEnabled: preset.webSearchEnabled,
53 |       webSearchContextSize: preset.webSearchContextSize,
54 |       shareId: preset.shareId,
55 |       visibility: preset.visibility,
56 |       createdAt: preset.createdAt,
57 |       // Hide sensitive fields
58 |       userId: undefined,
59 |       apiKeyPreferences: {},
60 |       isDefault: false,
61 |       updatedAt: undefined,
62 |       deletedAt: undefined,
63 |       version: undefined
64 |     };
65 | 
66 |     return new Response(JSON.stringify(publicPreset), {
67 |       headers: { 'Content-Type': 'application/json' }
68 |     });
69 |   } catch (error) {
70 |     console.error('Error fetching shared preset:', error);
71 |     return createErrorResponse('Internal server error', 500);
72 |   }
73 | }
```

app/api/presets/[id]/set-default/route.ts
```
1 | import { NextRequest } from 'next/server';
2 | import { db } from '@/lib/db';
3 | import { presets, users } from '@/lib/db/schema';
4 | import { auth } from '@/lib/auth';
5 | import { eq, and, isNull } from 'drizzle-orm';
6 | 
7 | // Helper to create error responses
8 | const createErrorResponse = (message: string, status: number) => {
9 |   return new Response(JSON.stringify({ error: message }), {
10 |     status,
11 |     headers: { 'Content-Type': 'application/json' }
12 |   });
13 | };
14 | 
15 | // POST /api/presets/[id]/set-default - Set preset as default
16 | export async function POST(
17 |   req: NextRequest,
18 |   { params }: { params: Promise<{ id: string }> }
19 | ) {
20 |   try {
21 |     const session = await auth.api.getSession({ headers: req.headers });
22 |     if (!session?.user?.id) {
23 |       return createErrorResponse('Authentication required', 401);
24 |     }
25 | 
26 |     const userId = session.user.id;
27 |     const { id: presetId } = await params;
28 | 
29 |     // Check if preset exists and user owns it
30 |     const existingPreset = await db
31 |       .select()
32 |       .from(presets)
33 |       .where(and(
34 |         eq(presets.id, presetId),
35 |         eq(presets.userId, userId),
36 |         isNull(presets.deletedAt)
37 |       ))
38 |       .limit(1);
39 | 
40 |     if (existingPreset.length === 0) {
41 |       return createErrorResponse('Preset not found or access denied', 404);
42 |     }
43 | 
44 |     // If already default, return success
45 |     if (existingPreset[0].isDefault) {
46 |       return new Response(JSON.stringify({
47 |         success: true,
48 |         message: 'Preset is already the default'
49 |       }), {
50 |         headers: { 'Content-Type': 'application/json' }
51 |       });
52 |     }
53 | 
54 |     // Start transaction: unset other defaults and set this one as default
55 |     try {
56 |       // First, unset all other defaults for this user
57 |       await db
58 |         .update(presets)
59 |         .set({ isDefault: false, updatedAt: new Date() })
60 |         .where(and(
61 |           eq(presets.userId, userId),
62 |           eq(presets.isDefault, true),
63 |           isNull(presets.deletedAt)
64 |         ));
65 | 
66 |       // Set this preset as default
67 |       await db
68 |         .update(presets)
69 |         .set({ isDefault: true, updatedAt: new Date() })
70 |         .where(eq(presets.id, presetId));
71 | 
72 |       // Update user's default_preset_id (for quick lookup)
73 |       await db
74 |         .update(users)
75 |         .set({
76 |           defaultPresetId: presetId,
77 |           updatedAt: new Date()
78 |         })
79 |         .where(eq(users.id, userId));
80 | 
81 |       return new Response(JSON.stringify({
82 |         success: true,
83 |         message: 'Preset set as default successfully'
84 |       }), {
85 |         headers: { 'Content-Type': 'application/json' }
86 |       });
87 |     } catch (error) {
88 |       console.error('Error in default preset transaction:', error);
89 |       return createErrorResponse('Failed to set default preset', 500);
90 |     }
91 |   } catch (error) {
92 |     console.error('Error setting default preset:', error);
93 |     return createErrorResponse('Internal server error', 500);
94 |   }
95 | }
96 | 
97 | // DELETE /api/presets/[id]/set-default - Unset as default
98 | export async function DELETE(
99 |   req: NextRequest,
100 |   { params }: { params: Promise<{ id: string }> }
101 | ) {
102 |   try {
103 |     const session = await auth.api.getSession({ headers: req.headers });
104 |     if (!session?.user?.id) {
105 |       return createErrorResponse('Authentication required', 401);
106 |     }
107 | 
108 |     const userId = session.user.id;
109 |     const { id: presetId } = await params;
110 | 
111 |     // Check if preset exists and user owns it
112 |     const existingPreset = await db
113 |       .select()
114 |       .from(presets)
115 |       .where(and(
116 |         eq(presets.id, presetId),
117 |         eq(presets.userId, userId),
118 |         isNull(presets.deletedAt)
119 |       ))
120 |       .limit(1);
121 | 
122 |     if (existingPreset.length === 0) {
123 |       return createErrorResponse('Preset not found or access denied', 404);
124 |     }
125 | 
126 |     // If not default, return success
127 |     if (!existingPreset[0].isDefault) {
128 |       return new Response(JSON.stringify({
129 |         success: true,
130 |         message: 'Preset is not the default'
131 |       }), {
132 |         headers: { 'Content-Type': 'application/json' }
133 |       });
134 |     }
135 | 
136 |     // Unset as default
137 |     await db
138 |       .update(presets)
139 |       .set({ isDefault: false, updatedAt: new Date() })
140 |       .where(eq(presets.id, presetId));
141 | 
142 |     // Clear user's default_preset_id
143 |     await db
144 |       .update(users)
145 |       .set({
146 |         defaultPresetId: null,
147 |         updatedAt: new Date()
148 |       })
149 |       .where(eq(users.id, userId));
150 | 
151 |     return new Response(JSON.stringify({
152 |       success: true,
153 |       message: 'Default preset unset successfully'
154 |     }), {
155 |       headers: { 'Content-Type': 'application/json' }
156 |     });
157 |   } catch (error) {
158 |     console.error('Error unsetting default preset:', error);
159 |     return createErrorResponse('Internal server error', 500);
160 |   }
161 | }
```

</current_codebase>
